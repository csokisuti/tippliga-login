<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, Timestamp,
      doc, updateDoc, deleteDoc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      const docRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(docRef);
      const data = userSnap.data();

      if (!userSnap.exists() || data.role !== "admin") {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      initUI();
      await loadMatches();
      await loadUsers();
    });

    function initUI() {
      const formSection = document.createElement("section");
      formSection.innerHTML = `
        <h2>√öj meccs hozz√°ad√°sa</h2>
        <form id="matchForm">
          <input placeholder="Hazai csapat" id="homeTeam" required><br>
          <input placeholder="Vend√©g csapat" id="awayTeam" required><br>
          <input type="datetime-local" id="startTime" required><br>
          <input placeholder="Fordul√≥ ID (pl. 1)" id="roundId" required><br>
          <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required><br>
          <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required><br>
          <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required><br>
          <button type="submit">Ment√©s</button>
        </form>
      `;

      const toggleButton = document.createElement("button");
      toggleButton.textContent = "üìÇ Felt√∂lt√∂tt meccsek megjelen√≠t√©se/elrejt√©se";
      toggleButton.onclick = () => {
        const list = document.getElementById("matchesList");
        list.style.display = list.style.display === "none" ? "block" : "none";
      };

      const matchesList = document.createElement("div");
      matchesList.id = "matchesList";

      const userSection = document.createElement("section");
      userSection.innerHTML = `
        <h2>√öj felhaszn√°l√≥ hozz√°ad√°sa</h2>
        <form id="userForm">
          <input type="text" placeholder="Becen√©v" id="nickname" required><br>
          <input type="email" placeholder="Email" id="email" required><br>
          <input type="password" placeholder="Jelsz√≥" id="password" required><br>
          <select id="role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select><br>
          <button type="submit">Felhaszn√°l√≥ l√©trehoz√°sa</button>
        </form>
        <h3>Jelenlegi felhaszn√°l√≥k:</h3>
        <ul id="userList"></ul>
      `;

      document.body.append(formSection, toggleButton, matchesList, userSection);

      document.getElementById("matchForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const startTime = Timestamp.fromDate(new Date(document.getElementById("startTime").value));
        await addDoc(collection(db, "matches"), {
          homeTeam: homeTeam.value,
          awayTeam: awayTeam.value,
          startTime,
          roundId: roundId.value,
          odds: {
            "1": parseFloat(odds1.value),
            "X": parseFloat(oddsX.value),
            "2": parseFloat(odds2.value)
          }
        });
        alert("Meccs mentve");
        e.target.reset();
        await loadMatches();
      });

      document.getElementById("userForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const nickname = document.getElementById("nickname").value;
        const role = document.getElementById("role").value;

        try {
          const secondaryApp = initializeApp(firebaseConfig, "Secondary");
          const secondaryAuth = getAuth(secondaryApp);

          const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
          await setDoc(doc(db, "users", cred.user.uid), {
            email,
            nickname,
            role
          });

          alert("Felhaszn√°l√≥ l√©trehozva!");

          await signOut(secondaryAuth);
          await secondaryApp.delete();

          e.target.reset();
          await loadUsers();
        } catch (err) {
          alert("Hiba: " + err.message);
        }
      });
    }

    async function loadMatches() {
      const container = document.getElementById("matchesList");
      container.innerHTML = "<h2>Felt√∂lt√∂tt meccsek</h2>";
      const snapshot = await getDocs(collection(db, "matches"));

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "match-card";
        div.innerHTML = `
          <input value="${data.homeTeam}" id="home-${docSnap.id}">
          <input value="${data.awayTeam}" id="away-${docSnap.id}">
          <input type="datetime-local" value="${new Date(data.startTime.toDate()).toISOString().slice(0,16)}" id="start-${docSnap.id}">
          <input value="${data.roundId}" id="round-${docSnap.id}">
          <input value="${data.odds["1"]}" id="odds1-${docSnap.id}">
          <input value="${data.odds["X"]}" id="oddsX-${docSnap.id}">
          <input value="${data.odds["2"]}" id="odds2-${docSnap.id}">
          <button onclick="updateMatch('${docSnap.id}')">Ment√©s</button>
          <button onclick="deleteMatch('${docSnap.id}')">T√∂rl√©s</button>
        `;
        container.appendChild(div);
      });
    }

    async function updateMatch(id) {
      const ref = doc(db, "matches", id);
      await updateDoc(ref, {
        homeTeam: document.getElementById(`home-${id}`).value,
        awayTeam: document.getElementById(`away-${id}`).value,
        startTime: Timestamp.fromDate(new Date(document.getElementById(`start-${id}`).value)),
        roundId: document.getElementById(`round-${id}`).value,
        odds: {
          "1": parseFloat(document.getElementById(`odds1-${id}`).value),
          "X": parseFloat(document.getElementById(`oddsX-${id}`).value),
          "2": parseFloat(document.getElementById(`odds2-${id}`).value)
        }
      });
      alert("Mentve");
    }

    async function deleteMatch(id) {
      if (confirm("Biztos t√∂r√∂lni akarod?")) {
        await deleteDoc(doc(db, "matches", id));
        await loadMatches();
      }
    }

    async function loadUsers() {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      const usersSnap = await getDocs(collection(db, "users"));
      usersSnap.forEach((docSnap) => {
        const user = docSnap.data();
        const li = document.createElement("li");
        li.textContent = `${user.nickname || user.email} (${user.role})`;
        const btn = document.createElement("button");
        btn.textContent = "T√∂rl√©s";
        btn.onclick = async () => {
          if (confirm(`T√∂rl√∂d: ${user.email}? Ez nem t√∂rli a bel√©p√©si fi√≥kot, csak a Firestore-b√≥l.`)) {
            await deleteDoc(docSnap.ref);
            await loadUsers();
          }
        };
        li.appendChild(btn);
        list.appendChild(li);
      });
    }

    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;
  </script>
</head>
<body>
</body>
</html>
