<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, Timestamp,
      doc, updateDoc, deleteDoc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const teams = [
      "Debreceni VSC", "Di√≥sgy≈ëri VTK", "Ferencv√°ros", "ETO FC Gy≈ër", "Kazincbarcikai SC",
      "Kisv√°rda FC", "MTK Budapest", "Ny√≠regyh√°za Spartacus", "Paksi FC",
      "Pusk√°s Akad√©mia", "√öjpest FC", "Zalaegerszegi TE FC"
    ];

    function parseOutcome(result) {
      const [home, away] = result.split("-").map(x => parseInt(x.trim()));
      if (isNaN(home) || isNaN(away)) return "";
      if (home > away) return "1";
      if (home < away) return "2";
      return "X";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      const docRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(docRef);
      const data = userSnap.data();

      if (!userSnap.exists() || data.role !== "admin") {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
      await loadFinalStandings();
    });
    function initUI() {
      const formSection = document.createElement("section");

      const homeOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');
      const awayOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');

      formSection.innerHTML = `
        <h2>√öj meccs hozz√°ad√°sa</h2>
        <form id="matchForm">
          <select id="homeTeam" required><option value="">Hazai csapat</option>${homeOptions}</select><br>
          <select id="awayTeam" required><option value="">Vend√©g csapat</option>${awayOptions}</select><br>
          <input type="datetime-local" id="startTime" required><br>
          <input placeholder="Fordul√≥ ID (pl. 1)" id="roundId" required><br>
          <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required><br>
          <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required><br>
          <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required><br>
          <button type="submit">Ment√©s</button>
        </form>
      `;

      const toggleButton = document.createElement("button");
      toggleButton.textContent = "üìÇ Felt√∂lt√∂tt meccsek megjelen√≠t√©se/elrejt√©se";
      toggleButton.onclick = () => {
        const list = document.getElementById("matchesList");
        list.style.display = list.style.display === "none" ? "block" : "none";
      };

      const matchesList = document.createElement("div");
      matchesList.id = "matchesList";

      const resultSection = document.createElement("section");
      resultSection.innerHTML = `
        <h2>Meccseredm√©nyek kezel√©se</h2>
        <div id="matchesNoResult"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
        <div id="matchesWithResult"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>
      `;

      const userSection = document.createElement("section");
      userSection.innerHTML = `
        <h2>√öj felhaszn√°l√≥ hozz√°ad√°sa</h2>
        <form id="userForm">
          <input type="text" placeholder="Becen√©v" id="nickname" required><br>
          <input type="email" placeholder="Email" id="email" required><br>
          <input type="password" placeholder="Jelsz√≥" id="password" required><br>
          <select id="role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select><br>
          <button type="submit">Felhaszn√°l√≥ l√©trehoz√°sa</button>
        </form>
        <h3>Jelenlegi felhaszn√°l√≥k:</h3>
        <ul id="userList"></ul>
      `;

      const finalStandingsSection = document.createElement("section");
      finalStandingsSection.innerHTML = `
        <h2>Szezon v√©gi hivatalos sorrend</h2>
        <button id="toggleStandings">üìã Sorrend megjelen√≠t√©se/elrejt√©se</button>
        <div id="standingsContainer" style="display:none;"></div>
        <button id="saveStandings">üíæ Ment√©s</button>
      `;

      const tableImageSection = document.createElement("section");
      tableImageSection.innerHTML = `
        <h2>NB1 tabella k√©p felt√∂lt√©se</h2>
        <input type="file" id="tableImageInput" accept="image/*">
        <button id="uploadTableImage">Felt√∂lt√©s</button><br><br>
        <button onclick="window.location.href='dashboard.html'">‚¨ÖÔ∏è Vissza a dashboardra</button>
      `;

      document.body.append(formSection, toggleButton, matchesList, resultSection, userSection, finalStandingsSection, tableImageSection);
      document.getElementById("matchForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const startTime = Timestamp.fromDate(new Date(document.getElementById("startTime").value));
        await addDoc(collection(db, "matches"), {
          homeTeam: homeTeam.value,
          awayTeam: awayTeam.value,
          startTime,
          roundId: roundId.value,
          odds: {
            "1": parseFloat(odds1.value),
            "X": parseFloat(oddsX.value),
            "2": parseFloat(odds2.value)
          }
        });
        alert("Meccs mentve");
        e.target.reset();
        await loadMatches();
        await loadResults();
      });

      document.getElementById("userForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const nickname = document.getElementById("nickname").value;
        const role = document.getElementById("role").value;

        try {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          await setDoc(doc(db, "users", cred.user.uid), {
            email,
            nickname,
            role
          });
          alert("Felhaszn√°l√≥ l√©trehozva!");
          e.target.reset();
          await loadUsers();
        } catch (err) {
          alert("Hiba: " + err.message);
        }
      });

      document.getElementById("uploadTableImage").addEventListener("click", async () => {
        const fileInput = document.getElementById("tableImageInput");
        const file = fileInput.files[0];
        if (!file) return alert("V√°lassz ki egy k√©pet!");

        const reader = new FileReader();
        reader.onload = async () => {
          const base64String = reader.result.split(',')[1];
          await setDoc(doc(db, "settings", "nbi_table_image"), { base64: base64String });
          alert("K√©p elmentve Firestore-ba!");
        };
        reader.readAsDataURL(file);
      });

      document.getElementById("toggleStandings").addEventListener("click", () => {
        const container = document.getElementById("standingsContainer");
        container.style.display = container.style.display === "none" ? "block" : "none";
      });

      document.getElementById("saveStandings").addEventListener("click", async () => {
        const inputs = document.querySelectorAll(".standings-input");
        const order = Array.from(inputs).map(input => input.value).filter(v => v);
        await setDoc(doc(db, "finalStandings", "official"), { order });
        alert("Sorrend elmentve!");
      });
    }
    async function loadFinalStandings() {
      const container = document.getElementById("standingsContainer");
      container.innerHTML = "";
      const docSnap = await getDoc(doc(db, "finalStandings", "official"));
      const savedOrder = docSnap.exists() ? docSnap.data().order : [];

      const list = document.createElement("ul");
      list.className = "sortable-list";
      teams.forEach(team => {
        const li = document.createElement("li");
        li.className = "sortable-item";
        const input = document.createElement("input");
        input.value = savedOrder.includes(team) ? team : "";
        input.className = "standings-input";
        list.appendChild(li).appendChild(input);
      });
      container.appendChild(list);
    }

    async function loadResults() {
      const snapshot = await getDocs(collection(db, "matches"));
      const matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      const noResult = matches.filter(m => !m.result);
      const withResult = matches.filter(m => m.result);

      renderMatchGroup("matchesNoResult", noResult, false);
      renderMatchGroup("matchesWithResult", withResult, true);
    }

    function renderMatchGroup(containerId, matches, showResult) {
      const container = document.getElementById(containerId);
      container.innerHTML = matches.map(match => `
        <div class="match-entry">
          <strong>${match.homeTeam} - ${match.awayTeam}</strong>
          <input value="${match.result || ""}" id="res-${match.id}" placeholder="Pl. 2-1">
          <button onclick="window.saveResult('${match.id}')">Ment√©s</button>
        </div>
      `).join("");
    }

    window.saveResult = async (matchId) => {
      const input = document.getElementById("res-" + matchId);
      const result = input.value;
      const outcome = parseOutcome(result);
      if (!outcome) return alert("√ârv√©nytelen eredm√©ny form√°tum");

      await updateDoc(doc(db, "matches", matchId), { result, outcome });
      await loadResults();
    };

    async function loadMatches() {
      const snapshot = await getDocs(collection(db, "matches"));
      const list = document.getElementById("matchesList");
      list.innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.innerHTML = `
          ${data.homeTeam} - ${data.awayTeam} | ${data.roundId} | ${data.startTime.toDate().toLocaleString()} |
          Odds: 1(${data.odds["1"]}) X(${data.odds["X"]}) 2(${data.odds["2"]})
          <button onclick="window.deleteMatch('${docSnap.id}')">üóëÔ∏è</button>
        `;
        list.appendChild(div);
      });
    }

    window.deleteMatch = async (id) => {
      if (confirm("Biztosan t√∂rl√∂d?")) {
        await deleteDoc(doc(db, "matches", id));
        await loadMatches();
        await loadResults();
      }
    };

    async function loadUsers() {
      const snapshot = await getDocs(collection(db, "users"));
      const list = document.getElementById("userList");
      list.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const li = document.createElement("li");
        li.textContent = `${data.nickname} (${data.role})`;
        list.appendChild(li);
      });
    }
  </script>
</head>
<body>
  <h1>‚öôÔ∏è Admin fel√ºlet</h1>
</body>
</html>
