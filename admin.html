<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .sortable { list-style:none; padding:0; }
    .sortable li { padding:10px; margin:5px 0; background:#f2f2f2; border:1px solid #ccc; cursor:grab; }
    .sortable li.dragging { opacity:.5; }
    .card { border:1px solid #e6eaf1; background:#fff; border-radius:12px; padding:12px; margin:12px 0; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:#64748b; font-size:14px; }
    input[type="datetime-local"]{ padding:6px 8px; }
    button{ padding:8px 12px; border-radius:8px; border:1px solid #e6eaf1; cursor:pointer; }
    .btn-primary{ background:#3b82f6; color:#fff; border-color:#3b82f6; }
    .btn-danger{ background:#ef4444; color:#fff; border-color:#ef4444; }
    .ok{ color:#16a34a; font-weight:700; }
    .warn{ color:#b45309; font-weight:700; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, Timestamp,
      doc, updateDoc, deleteDoc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const teams = [
      "Debreceni VSC","Di√≥sgy≈ëri VTK","Ferencv√°ros","ETO FC Gy≈ër","Kazincbarcikai SC",
      "Kisv√°rda FC","MTK Budapest","Ny√≠regyh√°za Spartacus","Paksi FC",
      "Pusk√°s Akad√©mia","√öjpest FC","Zalaegerszegi TE FC"
    ];

    function parseOutcome(result) {
      const [home, away] = result.split("-").map(x => parseInt(x.trim()));
      if (isNaN(home) || isNaN(away)) return "";
      if (home > away) return "1";
      if (home < away) return "2";
      return "X";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return; }

      const docRef = doc(db, "users", user.email);
      const userSnap = await getDoc(docRef);
      const data = userSnap.data();

      if (!userSnap.exists() || data.role !== "admin") {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
      await loadPositionsLock();  // <<< √∫j
    });

    function initUI() {
      const formSection = document.createElement("section");

      const homeOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');
      const awayOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');

      formSection.innerHTML = `
        <h2>√öj meccs hozz√°ad√°sa</h2>
        <form id="matchForm" class="card">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${homeOptions}</select>
            <select id="awayTeam" required><option value="">Vend√©g csapat</option>${awayOptions}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Fordul√≥ ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn-primary">Ment√©s</button>
          </div>
        </form>
      `;

      const toggleButton = document.createElement("button");
      toggleButton.textContent = "üìÇ Felt√∂lt√∂tt meccsek megjelen√≠t√©se/elrejt√©se";
      toggleButton.onclick = () => {
        const list = document.getElementById("matchesList");
        list.style.display = list.style.display === "none" ? "block" : "none";
      };

      const matchesList = document.createElement("div");
      matchesList.id = "matchesList";

      const resultSection = document.createElement("section");
      resultSection.innerHTML = `
        <h2>Meccseredm√©nyek kezel√©se</h2>
        <div id="matchesNoResult" class="card"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
        <div id="matchesWithResult" class="card"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>
      `;

      const userSection = document.createElement("section");
      userSection.innerHTML = `
        <h2>Felhaszn√°l√≥k kezel√©se</h2>
        <ul id="userList" class="card" style="margin-top:8px;"></ul>
      `;

      const tableImageSection = document.createElement("section");
      tableImageSection.innerHTML = `
        <h2>NB1 tabella k√©p felt√∂lt√©se</h2>
        <div class="card">
          <input type="file" id="tableImageInput" accept="image/*">
          <button id="uploadTableImage" class="btn-primary">Felt√∂lt√©s</button>
          <div style="margin-top:10px"><button onclick="window.location.href='dashboard.html'">‚¨ÖÔ∏è Vissza a dashboardra</button></div>
        </div>

        <h2 style="margin-top:18px;">üìä Hivatalos szezon v√©gi sorrend</h2>
        <div class="card">
          <button id="toggleOrder">üìÇ Sorrend szerkeszt√©se/elrejt√©se</button>
          <ul id="sortableList" class="sortable" style="display:none; margin-top:10px;"></ul>
          <button id="saveOrderBtn" style="display:none;" class="btn-primary">üíæ Ment√©s</button>
        </div>

        <h2 style="margin-top:18px;">üîí Poz√≠ci√≥s tipp lez√°r√°s</h2>
        <div class="card" id="lockCard">
          <div class="muted">Itt szab√°lyozhatod, mikort√≥l ne lehessen m√≥dos√≠tani a <strong>Szezon v√©gi poz√≠ci√≥s sorrend</strong> tippet (positions.html).</div>
          <div class="row" style="margin-top:8px">
            <label><input type="checkbox" id="lockNow"> Azonnali lez√°r√°s</label>
            <span class="muted">vagy</span>
            <label>Automatikus z√°r√°s id≈ëpontja: <input type="datetime-local" id="lockUntil"></label>
          </div>
          <div class="row">
            <input type="text" id="lockMessage" placeholder="Opcion√°lis √ºzenet a j√°t√©kosoknak" style="flex:1; padding:6px 8px;">
          </div>
          <div class="row">
            <button id="saveLock" class="btn-primary">Lez√°r√°s be√°ll√≠t√°sa</button>
            <button id="clearLock" class="btn-danger">Lez√°r√°s felold√°sa</button>
            <span id="lockStatus" class="muted"></span>
          </div>
        </div>
      `;

      document.body.append(formSection, toggleButton, matchesList, resultSection, userSection, tableImageSection);

      document.getElementById("matchForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const startTime = Timestamp.fromDate(new Date(document.getElementById("startTime").value));
        await addDoc(collection(db, "matches"), {
          homeTeam: homeTeam.value,
          awayTeam: awayTeam.value,
          startTime,
          roundId: roundId.value,
          odds: {
            "1": parseFloat(odds1.value),
            "X": parseFloat(oddsX.value),
            "2": parseFloat(odds2.value)
          }
        });
        alert("Meccs mentve");
        e.target.reset();
        await loadMatches();
        await loadResults();
      });

      document.getElementById("uploadTableImage").addEventListener("click", async () => {
        const fileInput = document.getElementById("tableImageInput");
        const file = fileInput.files[0];
        if (!file) return alert("V√°lassz ki egy k√©pet!");

        const reader = new FileReader();
        reader.onload = async () => {
          const base64String = reader.result.split(',')[1];
          await setDoc(doc(db, "settings", "nbi_table_image"), { base64: base64String });
          alert("K√©p elmentve Firestore-ba!");
        };
        reader.readAsDataURL(file);
      });

      // --- Hivatalos sorrend (drag & drop) ---
      const finalStandingsRef = doc(db, "finalStandings", "official");
      const sortableList = document.getElementById("sortableList");
      const toggleOrderBtn = document.getElementById("toggleOrder");
      const saveOrderBtn = document.getElementById("saveOrderBtn");
      let draggedItem = null;

      function renderOfficialOrder(list) {
        sortableList.innerHTML = "";
        list.forEach((team) => {
          const li = document.createElement("li");
          li.textContent = team;
          li.draggable = true;

          li.addEventListener("dragstart", () => { draggedItem = li; li.classList.add("dragging"); });
          li.addEventListener("dragend", () => { draggedItem = null; li.classList.remove("dragging"); });
          li.addEventListener("dragover", (e) => {
            e.preventDefault();
            const bounding = li.getBoundingClientRect();
            const offset = bounding.y + (bounding.height / 2);
            const after = (e.clientY - offset) > 0;
            const parent = li.parentNode;
            if (after) parent.insertBefore(draggedItem, li.nextSibling);
            else parent.insertBefore(draggedItem, li);
          });

          sortableList.appendChild(li);
        });
      }

      getDoc(finalStandingsRef).then((docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (Array.isArray(data.teams)) renderOfficialOrder(data.teams);
          else renderOfficialOrder(teams);
        } else {
          renderOfficialOrder(teams);
        }
      });

      saveOrderBtn.addEventListener("click", async () => {
        const updatedOrder = Array.from(sortableList.children).map((li) => li.textContent.replace(/^\d+\.\s*/, ""));
        await setDoc(finalStandingsRef, {
          teams: updatedOrder,
          positions: updatedOrder.map((team, i) => ({ team, position: i + 1 }))
        });
        alert("Sorrend elmentve.");
      });

      toggleOrderBtn.addEventListener("click", () => {
        const visible = sortableList.style.display === "block";
        sortableList.style.display = visible ? "none" : "block";
        saveOrderBtn.style.display = visible ? "none" : "inline-block";
      });

      // --- Poz√≠ci√≥s tipp lez√°r√°s UI esem√©nyek ---
      document.getElementById("saveLock").addEventListener("click", saveLock);
      document.getElementById("clearLock").addEventListener("click", clearLock);
    }

    async function loadMatches() {
      const container = document.getElementById("matchesList");
      container.innerHTML = "<h2>Felt√∂lt√∂tt meccsek</h2>";
      const snapshot = await getDocs(collection(db, "matches"));

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div class="row">
            <input value="${data.homeTeam}" id="home-${docSnap.id}">
            <input value="${data.awayTeam}" id="away-${docSnap.id}">
            <input type="datetime-local" value="${new Date(data.startTime.toDate()).toISOString().slice(0,16)}" id="start-${docSnap.id}">
            <input value="${data.roundId}" id="round-${docSnap.id}">
            <input value="${data.odds["1"]}" id="odds1-${docSnap.id}">
            <input value="${data.odds["X"]}" id="oddsX-${docSnap.id}">
            <input value="${data.odds["2"]}" id="odds2-${docSnap.id}">
            <button class="btn-primary" onclick="updateMatch('${docSnap.id}')">Ment√©s</button>
            <button class="btn-danger" onclick="deleteMatch('${docSnap.id}')">T√∂rl√©s</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function updateMatch(id) {
      const ref = doc(db, "matches", id);
      await updateDoc(ref, {
        homeTeam: document.getElementById(`home-${id}`).value,
        awayTeam: document.getElementById(`away-${id}`).value,
        startTime: Timestamp.fromDate(new Date(document.getElementById(`start-${id}`).value)),
        roundId: document.getElementById(`round-${id}`).value,
        odds: {
          "1": parseFloat(document.getElementById(`odds1-${id}`).value),
          "X": parseFloat(document.getElementById(`oddsX-${id}`).value),
          "2": parseFloat(document.getElementById(`odds2-${id}`).value)
        }
      });
      alert("Mentve");
      await loadMatches();
      await loadResults();
    }

    async function deleteMatch(id) {
      if (confirm("Biztos t√∂r√∂lni akarod?")) {
        await deleteDoc(doc(db, "matches", id));
        await loadMatches();
        await loadResults();
      }
    }

    async function loadResults() {
      const noResultContainer = document.getElementById("matchesNoResult");
      const withResultContainer = document.getElementById("matchesWithResult");
      noResultContainer.innerHTML = "<h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3>";
      withResultContainer.innerHTML = "<h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3>";

      const snapshot = await getDocs(collection(db, "matches"));
      const noResult = [];
      const withResult = [];

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const match = { id: docSnap.id, ...data };
        if (data.result) withResult.push(match);
        else noResult.push(match);
      });

      renderMatchGroup(noResult, noResultContainer, false);
      renderMatchGroup(withResult, withResultContainer, true);
    }

    function renderMatchGroup(matches, container, hasResult) {
      const grouped = {};
      matches.forEach(m => {
        const round = m.roundId || "Egy√©b";
        if (!grouped[round]) grouped[round] = [];
        grouped[round].push(m);
      });

      Object.keys(grouped).sort().forEach(roundId => {
        const title = document.createElement("h4");
        title.textContent = `${roundId}. fordul√≥`;
        container.appendChild(title);

        grouped[roundId].forEach(match => {
          const div = document.createElement("div");
          div.className = "card";
          const formatted = match.startTime?.toDate?.().toLocaleString("hu-HU") || "";
          div.innerHTML = `<strong>${match.homeTeam} - ${match.awayTeam}</strong><br>Kezd√©s: ${formatted}<br>`;

          const input = document.createElement("input");
          input.placeholder = "pl. 2-1";
          input.value = match.result || "";
          input.style.width = "60px";

          const saveBtn = document.createElement("button");
          saveBtn.className = "btn-primary";
          saveBtn.textContent = hasResult ? "M√≥dos√≠t√°s" : "Ment√©s";

          saveBtn.onclick = async () => {
            const value = input.value.trim();
            const outcome = parseOutcome(value);
            if (!outcome) return alert("Hib√°s form√°tum. Haszn√°lj pl. 3-1 vagy 1-1.");
            await updateDoc(doc(db, "matches", match.id), { result: value, outcome });
            await loadResults();
          };

          div.appendChild(input);
          div.appendChild(saveBtn);
          container.appendChild(div);
        });
      });
    }

    async function loadUsers() {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      const usersSnap = await getDocs(collection(db, "users"));
      usersSnap.forEach((docSnap) => {
        const user = docSnap.data();
        const li = document.createElement("li");
        const nickname = user.nickname || user.email;
        li.innerHTML = `
          ${nickname} (${user.email})<br>
          <select>
            <option value="user" ${user.role === "user" ? "selected" : ""}>User</option>
            <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
          </select>
          <button class="btn-primary save-role">Ment√©s</button>
          <button class="btn-danger delete-user">T√∂rl√©s</button>
        `;

        const select = li.querySelector("select");
        const saveBtn = li.querySelector(".save-role");
        const deleteBtn = li.querySelector(".delete-user");

        saveBtn.onclick = async () => {
          await updateDoc(doc(db, "users", user.email), { role: select.value });
          alert("Szerepk√∂r friss√≠tve.");
        };

        deleteBtn.onclick = async () => {
          if (confirm(`T√∂rl√∂d: ${user.email}? Ez nem t√∂rli a bel√©p√©si fi√≥kot, csak a Firestore-b√≥l.`)) {
            await deleteDoc(doc(db, "users", user.email));
            await loadUsers();
          }
        };

        list.appendChild(li);
      });
    }

    // === Poz√≠ci√≥s tipp LEZ√ÅR√ÅS (settings/positionsLock) ===
    async function loadPositionsLock(){
      const status = document.getElementById('lockStatus');
      const snap = await getDoc(doc(db, "settings", "positionsLock"));
      if (!snap.exists()){
        status.textContent = "Jelenleg nyitva.";
        status.className = "muted";
        return;
      }
      const data = snap.data()||{};
      const isLocked = !!data.isLocked;
      const until = data.lockUntil?.toDate?.() || null;
      const msg = data.message || "";
      const now = new Date();
      const timeLocked = until && now >= until;

      if (isLocked || timeLocked){
        status.textContent = `Z√ÅRVA ${timeLocked && until ? `(hat√°rid≈ë: ${until.toLocaleString("hu-HU")})` : "(azonnali z√°r√°s)"}` + (msg?` ‚Äì ${msg}`:"");
        status.className = "warn";
      }else{
        status.textContent = "Jelenleg nyitva.";
        status.className = "ok";
      }
    }

    async function saveLock(){
      const lockNow = document.getElementById('lockNow').checked;
      const untilStr = document.getElementById('lockUntil').value;
      const message = document.getElementById('lockMessage').value.trim();

      let lockDoc = { isLocked: !!lockNow, message: message || "" };
      if (untilStr){
        const dt = new Date(untilStr);
        if (isNaN(+dt)) return alert("Hib√°s d√°tum/id≈ë.");
        lockDoc.lockUntil = Timestamp.fromDate(dt);
      } else {
        lockDoc.lockUntil = null;
      }

      await setDoc(doc(db, "settings", "positionsLock"), lockDoc);
      alert("Lez√°r√°s be√°ll√≠tva.");
      await loadPositionsLock();
    }

    async function clearLock(){
      await setDoc(doc(db, "settings", "positionsLock"), {
        isLocked:false,
        lockUntil:null,
        message:""
      });
      alert("Lez√°r√°s feloldva.");
      await loadPositionsLock();
    }

    // export a b√∂ng√©sz≈ënek
    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;
  </script>
</head>
<body></body>
</html>
