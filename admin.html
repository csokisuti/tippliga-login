<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, Timestamp,
      doc, updateDoc, deleteDoc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const teams = [
      "Debreceni VSC", "Di√≥sgy≈ëri VTK", "Ferencv√°ros", "ETO FC Gy≈ër", "Kazincbarcikai SC",
      "Kisv√°rda FC", "MTK Budapest", "Ny√≠regyh√°za Spartacus", "Paksi FC",
      "Pusk√°s Akad√©mia", "√öjpest FC", "Zalaegerszegi TE FC"
    ];

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      const docRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(docRef);
      const data = userSnap.data();

      if (!userSnap.exists() || data.role !== "admin") {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
      await loadFinalStandings();
    });

    function initUI() {
      const html = `
        <section>
          <h2>√öj meccs hozz√°ad√°sa</h2>
          <form id="matchForm">
            <select id="homeTeam"><option value="">Hazai csapat</option>${teams.map(t => `<option value="${t}">${t}</option>`).join("")}</select><br>
            <select id="awayTeam"><option value="">Vend√©g csapat</option>${teams.map(t => `<option value="${t}">${t}</option>`).join("")}</select><br>
            <input type="datetime-local" id="startTime"><br>
            <input id="roundId" placeholder="Fordul√≥ ID"><br>
            <input id="odds1" placeholder="Odds 1" type="number" step="0.01"><br>
            <input id="oddsX" placeholder="Odds X" type="number" step="0.01"><br>
            <input id="odds2" placeholder="Odds 2" type="number" step="0.01"><br>
            <button type="submit">Ment√©s</button>
          </form>
        </section>

        <button onclick="toggleSection('matchesList')">üìÇ Felt√∂lt√∂tt meccsek megjelen√≠t√©se/elrejt√©se</button>
        <div id="matchesList" style="display:none;"></div>

        <section>
          <h2>Meccseredm√©nyek kezel√©se</h2>
          <div id="matchesNoResult"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
          <div id="matchesWithResult"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>
        </section>

        <section>
          <h2>√öj felhaszn√°l√≥ hozz√°ad√°sa</h2>
          <form id="userForm">
            <input id="nickname" placeholder="Becen√©v"><br>
            <input id="email" placeholder="Email" type="email"><br>
            <input id="password" placeholder="Jelsz√≥" type="password"><br>
            <select id="role">
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select><br>
            <button type="submit">Felhaszn√°l√≥ l√©trehoz√°sa</button>
          </form>
          <ul id="userList"></ul>
        </section>

        <section>
          <h2>NB1 tabella k√©p felt√∂lt√©se</h2>
          <input type="file" id="tableImageInput" accept="image/*">
          <button id="uploadTableImage">Felt√∂lt√©s</button><br><br>
          <button onclick="window.location.href='dashboard.html'">‚¨ÖÔ∏è Vissza a dashboardra</button>
        </section>

        <section>
          <button onclick="toggleSection('finalStandingsSection')">üìâ Szezon v√©gi hivatalos sorrend megjelen√≠t√©se/elrejt√©se</button>
          <div id="finalStandingsSection" style="display:none;">
            <h2>Hivatalos szezon v√©gi sorrend</h2>
            <ul id="officialList" class="draggable-list"></ul>
            <button id="saveOfficial">Ment√©s</button>
          </div>
        </section>
      `;
      document.body.innerHTML = html;

      document.getElementById("matchForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const startTime = Timestamp.fromDate(new Date(document.getElementById("startTime").value));
        await addDoc(collection(db, "matches"), {
          homeTeam: homeTeam.value,
          awayTeam: awayTeam.value,
          startTime,
          roundId: roundId.value,
          odds: {
            "1": parseFloat(odds1.value),
            "X": parseFloat(oddsX.value),
            "2": parseFloat(odds2.value)
          }
        });
        alert("Meccs mentve");
        e.target.reset();
        await loadMatches();
        await loadResults();
      });

      document.getElementById("userForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const cred = await createUserWithEmailAndPassword(auth, email.value, password.value);
        await setDoc(doc(db, "users", cred.user.uid), {
          email: email.value,
          nickname: nickname.value,
          role: role.value
        });
        alert("Felhaszn√°l√≥ l√©trehozva!");
        e.target.reset();
        await loadUsers();
      });

      document.getElementById("uploadTableImage").addEventListener("click", async () => {
        const file = document.getElementById("tableImageInput").files[0];
        if (!file) return alert("V√°lassz ki egy k√©pet!");
        const reader = new FileReader();
        reader.onload = async () => {
          const base64String = reader.result.split(',')[1];
          await setDoc(doc(db, "settings", "nbi_table_image"), { base64: base64String });
          alert("K√©p elmentve!");
        };
        reader.readAsDataURL(file);
      });

      document.getElementById("saveOfficial").addEventListener("click", async () => {
        const items = document.querySelectorAll("#officialList li");
        const ordered = [...items].map(item => item.textContent);
        await setDoc(doc(db, "finalStandings", "official"), {
          positions: ordered
        });
        alert("Sorrend mentve!");
      });
    }

    function toggleSection(id) {
      const el = document.getElementById(id);
      el.style.display = el.style.display === "none" ? "block" : "none";
    }

    async function loadMatches() {
      const container = document.getElementById("matchesList");
      container.innerHTML = "<h2>Felt√∂lt√∂tt meccsek</h2>";
      const snapshot = await getDocs(collection(db, "matches"));
      snapshot.forEach((docSnap) => {
        const d = docSnap.data();
        const div = document.createElement("div");
        div.innerHTML = `
          <input value="${d.homeTeam}" id="home-${docSnap.id}">
          <input value="${d.awayTeam}" id="away-${docSnap.id}">
          <input type="datetime-local" value="${new Date(d.startTime.toDate()).toISOString().slice(0,16)}" id="start-${docSnap.id}">
          <input value="${d.roundId}" id="round-${docSnap.id}">
          <input value="${d.odds["1"]}" id="odds1-${docSnap.id}">
          <input value="${d.odds["X"]}" id="oddsX-${docSnap.id}">
          <input value="${d.odds["2"]}" id="odds2-${docSnap.id}">
          <button onclick="updateMatch('${docSnap.id}')">Ment√©s</button>
          <button onclick="deleteMatch('${docSnap.id}')">T√∂rl√©s</button>
        `;
        container.appendChild(div);
      });
    }

    async function loadUsers() {
      const ul = document.getElementById("userList");
      ul.innerHTML = "";
      const snap = await getDocs(collection(db, "users"));
      snap.forEach(docSnap => {
        const u = docSnap.data();
        const li = document.createElement("li");
        li.textContent = `${u.nickname || u.email} (${u.role})`;
        const btn = document.createElement("button");
        btn.textContent = "T√∂rl√©s";
        btn.onclick = async () => {
          if (confirm(`T√∂rl√∂d: ${u.email}?`)) {
            await deleteDoc(docSnap.ref);
            await loadUsers();
          }
        };
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    function parseOutcome(r) {
      const [h, a] = r.split("-").map(x => parseInt(x.trim()));
      if (isNaN(h) || isNaN(a)) return "";
      return h > a ? "1" : h < a ? "2" : "X";
    }

    async function loadResults() {
      const noResult = document.getElementById("matchesNoResult");
      const withResult = document.getElementById("matchesWithResult");
      noResult.innerHTML = "<h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3>";
      withResult.innerHTML = "<h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3>";
      const snap = await getDocs(collection(db, "matches"));
      const group = (arr, cond) => arr.filter(cond).reduce((acc, m) => {
        const r = m.roundId || "Egy√©b";
        if (!acc[r]) acc[r] = [];
        acc[r].push(m);
        return acc;
      }, {});
      const data = [];
      snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
      const withRes = group(data, d => d.result);
      const noRes = group(data, d => !d.result);
      for (const [r, list] of Object.entries(noRes)) renderResults(noResult, r, list, false);
      for (const [r, list] of Object.entries(withRes)) renderResults(withResult, r, list, true);
    }

    function renderResults(container, round, matches, hasResult) {
      const title = document.createElement("h4");
      title.textContent = `${round}. fordul√≥`;
      container.appendChild(title);
      matches.forEach(m => {
        const div = document.createElement("div");
        div.innerHTML = `<b>${m.homeTeam} - ${m.awayTeam}</b><br><small>${m.startTime.toDate().toLocaleString("hu-HU")}</small><br>`;
        const input = document.createElement("input");
        input.placeholder = "pl. 2-1";
        input.value = m.result || "";
        const btn = document.createElement("button");
        btn.textContent = hasResult ? "M√≥dos√≠t√°s" : "Ment√©s";
        btn.onclick = async () => {
          const value = input.value.trim();
          const out = parseOutcome(value);
          if (!out) return alert("Hib√°s form√°tum!");
          await updateDoc(doc(db, "matches", m.id), {
            result: value,
            outcome: out
          });
          await loadResults();
        };
        div.appendChild(input);
        div.appendChild(btn);
        container.appendChild(div);
      });
    }

    async function loadFinalStandings() {
      const ul = document.getElementById("officialList");
      ul.innerHTML = "";
      const snap = await getDoc(doc(db, "finalStandings", "official"));
      const order = snap.exists() ? snap.data().positions : [...teams];
      order.forEach(team => {
        const li = document.createElement("li");
        li.textContent = team;
        li.draggable = true;
        li.ondragstart = e => e.dataTransfer.setData("text/plain", team);
        li.ondragover = e => e.preventDefault();
        li.ondrop = e => {
          e.preventDefault();
          const from = e.dataTransfer.getData("text/plain");
          const to = li.textContent;
          const items = [...ul.children].map(li => li.textContent);
          const fromIdx = items.indexOf(from);
          const toIdx = items.indexOf(to);
          items.splice(fromIdx, 1);
          items.splice(toIdx, 0, from);
          ul.innerHTML = "";
          items.forEach(t => {
            const newLi = document.createElement("li");
            newLi.textContent = t;
            newLi.draggable = true;
            newLi.ondragstart = li.ondragstart;
            newLi.ondragover = li.ondragover;
            newLi.ondrop = li.ondrop;
            ul.appendChild(newLi);
          });
        };
        ul.appendChild(li);
      });
    }

    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;
  </script>
</head>
<body></body>
</html>
