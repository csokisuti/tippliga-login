<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css">

<style>
  .sortable {
    list-style: none;
    padding: 0;
  }

  .sortable li {
    padding: 10px;
    margin: 5px 0;
    background-color: #f2f2f2;
    border: 1px solid #ccc;
    cursor: grab;
  }

  .sortable li.dragging {
    opacity: 0.5;
  }
</style>
  
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, Timestamp,
      doc, updateDoc, deleteDoc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const teams = [
      "Debreceni VSC", "Di√≥sgy≈ëri VTK", "Ferencv√°ros", "ETO FC Gy≈ër", "Kazincbarcikai SC",
      "Kisv√°rda FC", "MTK Budapest", "Ny√≠regyh√°za Spartacus", "Paksi FC",
      "Pusk√°s Akad√©mia", "√öjpest FC", "Zalaegerszegi TE FC"
    ];

    function parseOutcome(result) {
      const [home, away] = result.split("-").map(x => parseInt(x.trim()));
      if (isNaN(home) || isNaN(away)) return "";
      if (home > away) return "1";
      if (home < away) return "2";
      return "X";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      const docRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(docRef);
      const data = userSnap.data();

      if (!userSnap.exists() || data.role !== "admin") {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
    });
    function initUI() {
      const formSection = document.createElement("section");

      const homeOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');
      const awayOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');

      formSection.innerHTML = `
        <h2>√öj meccs hozz√°ad√°sa</h2>
        <form id="matchForm">
          <select id="homeTeam" required><option value="">Hazai csapat</option>${homeOptions}</select><br>
          <select id="awayTeam" required><option value="">Vend√©g csapat</option>${awayOptions}</select><br>
          <input type="datetime-local" id="startTime" required><br>
          <input placeholder="Fordul√≥ ID (pl. 1)" id="roundId" required><br>
          <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required><br>
          <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required><br>
          <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required><br>
          <button type="submit">Ment√©s</button>
        </form>
      `;

      const toggleButton = document.createElement("button");
      toggleButton.textContent = "üìÇ Felt√∂lt√∂tt meccsek megjelen√≠t√©se/elrejt√©se";
      toggleButton.onclick = () => {
        const list = document.getElementById("matchesList");
        list.style.display = list.style.display === "none" ? "block" : "none";
      };

      const matchesList = document.createElement("div");
      matchesList.id = "matchesList";

      const resultSection = document.createElement("section");
      resultSection.innerHTML = `
        <h2>Meccseredm√©nyek kezel√©se</h2>
        <div id="matchesNoResult"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
        <div id="matchesWithResult"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>
      `;

      const userSection = document.createElement("section");
      userSection.innerHTML = `
        <h2>√öj felhaszn√°l√≥ hozz√°ad√°sa</h2>
        <form id="userForm">
          <input type="text" placeholder="Becen√©v" id="nickname" required><br>
          <input type="email" placeholder="Email" id="email" required><br>
          <input type="password" placeholder="Jelsz√≥" id="password" required><br>
          <select id="role">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select><br>
          <button type="submit">Felhaszn√°l√≥ l√©trehoz√°sa</button>
        </form>
        <h3>Jelenlegi felhaszn√°l√≥k:</h3>
        <ul id="userList"></ul>
      `;

      const tableImageSection = document.createElement("section");
      tableImageSection.innerHTML = `
        <h2>NB1 tabella k√©p felt√∂lt√©se</h2>
        <input type="file" id="tableImageInput" accept="image/*">
        <button id="uploadTableImage">Felt√∂lt√©s</button><br><br>
        <button onclick="window.location.href='dashboard.html'">‚¨ÖÔ∏è Vissza a dashboardra</button>
      `;
<hr>

  <h2>üìä Hivatalos szezon v√©gi sorrend</h2>
  <button id="toggleOrder">üìÇ Sorrend szerkeszt√©se/elrejt√©se</button>
  <ul id="sortableList" class="sortable" style="display:none;"></ul>
  <button id="saveOrderBtn" style="display:none;">üíæ Ment√©s</button>
`;

      document.body.append(formSection, toggleButton, matchesList, resultSection, userSection, tableImageSection);
      document.getElementById("matchForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const startTime = Timestamp.fromDate(new Date(document.getElementById("startTime").value));
        await addDoc(collection(db, "matches"), {
          homeTeam: homeTeam.value,
          awayTeam: awayTeam.value,
          startTime,
          roundId: roundId.value,
          odds: {
            "1": parseFloat(odds1.value),
            "X": parseFloat(oddsX.value),
            "2": parseFloat(odds2.value)
          }
        });
        alert("Meccs mentve");
        e.target.reset();
        await loadMatches();
        await loadResults();
      });

      document.getElementById("userForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const nickname = document.getElementById("nickname").value;
        const role = document.getElementById("role").value;

        try {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          await setDoc(doc(db, "users", cred.user.uid), {
            email,
            nickname,
            role
          });
          alert("Felhaszn√°l√≥ l√©trehozva!");
          e.target.reset();
          await loadUsers();
        } catch (err) {
          alert("Hiba: " + err.message);
        }
      });

      document.getElementById("uploadTableImage").addEventListener("click", async () => {
        const fileInput = document.getElementById("tableImageInput");
        const file = fileInput.files[0];
        if (!file) return alert("V√°lassz ki egy k√©pet!");

        const reader = new FileReader();
        reader.onload = async () => {
          const base64String = reader.result.split(',')[1];
          await setDoc(doc(db, "settings", "nbi_table_image"), { base64: base64String });
          alert("K√©p elmentve Firestore-ba!");
        };
        reader.readAsDataURL(file);
      });
    }

    async function loadResults() {
      const noResultContainer = document.getElementById("matchesNoResult");
      const withResultContainer = document.getElementById("matchesWithResult");
      noResultContainer.innerHTML = "<h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3>";
      withResultContainer.innerHTML = "<h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3>";

      const snapshot = await getDocs(collection(db, "matches"));
      const noResult = [];
      const withResult = [];

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const match = { id: docSnap.id, ...data };
        if (data.result) withResult.push(match);
        else noResult.push(match);
      });

      renderMatchGroup(noResult, noResultContainer, false);
      renderMatchGroup(withResult, withResultContainer, true);
    }

    function renderMatchGroup(matches, container, hasResult) {
      const grouped = {};
      matches.forEach(m => {
        const round = m.roundId || "Egy√©b";
        if (!grouped[round]) grouped[round] = [];
        grouped[round].push(m);
      });

      Object.keys(grouped).sort().forEach(roundId => {
        const title = document.createElement("h4");
        title.textContent = `${roundId}. fordul√≥`;
        container.appendChild(title);

        grouped[roundId].forEach(match => {
          const div = document.createElement("div");
          div.style.border = "1px solid #ccc";
          div.style.padding = "8px";
          div.style.marginBottom = "5px";
          const formatted = match.startTime?.toDate?.().toLocaleString("hu-HU") || "";
          div.innerHTML = `<strong>${match.homeTeam} - ${match.awayTeam}</strong><br>Kezd√©s: ${formatted}<br>`;
          
          const input = document.createElement("input");
          input.placeholder = "pl. 2-1";
          input.value = match.result || "";
          input.style.width = "60px";

          const saveBtn = document.createElement("button");
          saveBtn.textContent = hasResult ? "M√≥dos√≠t√°s" : "Ment√©s";

          saveBtn.onclick = async () => {
            const value = input.value.trim();
            const outcome = parseOutcome(value);
            if (!outcome) return alert("Hib√°s form√°tum. Haszn√°lj pl. 3-1 vagy 1-1.");
            await updateDoc(doc(db, "matches", match.id), {
              result: value,
              outcome: outcome
            });
            await loadResults();
          };

          div.appendChild(input);
          div.appendChild(saveBtn);
          container.appendChild(div);
        });
      });
    }
    async function loadMatches() {
      const container = document.getElementById("matchesList");
      container.innerHTML = "<h2>Felt√∂lt√∂tt meccsek</h2>";
      const snapshot = await getDocs(collection(db, "matches"));

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "match-card";
        div.innerHTML = `
          <input value="${data.homeTeam}" id="home-${docSnap.id}">
          <input value="${data.awayTeam}" id="away-${docSnap.id}">
          <input type="datetime-local" value="${new Date(data.startTime.toDate()).toISOString().slice(0,16)}" id="start-${docSnap.id}">
          <input value="${data.roundId}" id="round-${docSnap.id}">
          <input value="${data.odds["1"]}" id="odds1-${docSnap.id}">
          <input value="${data.odds["X"]}" id="oddsX-${docSnap.id}">
          <input value="${data.odds["2"]}" id="odds2-${docSnap.id}">
          <button onclick="updateMatch('${docSnap.id}')">Ment√©s</button>
          <button onclick="deleteMatch('${docSnap.id}')">T√∂rl√©s</button>
        `;
        container.appendChild(div);
      });
    }

    async function updateMatch(id) {
      const ref = doc(db, "matches", id);
      await updateDoc(ref, {
        homeTeam: document.getElementById(`home-${id}`).value,
        awayTeam: document.getElementById(`away-${id}`).value,
        startTime: Timestamp.fromDate(new Date(document.getElementById(`start-${id}`).value)),
        roundId: document.getElementById(`round-${id}`).value,
        odds: {
          "1": parseFloat(document.getElementById(`odds1-${id}`).value),
          "X": parseFloat(document.getElementById(`oddsX-${id}`).value),
          "2": parseFloat(document.getElementById(`odds2-${id}`).value)
        }
      });
      alert("Mentve");
      await loadMatches();
      await loadResults();
    }

    async function deleteMatch(id) {
      if (confirm("Biztos t√∂r√∂lni akarod?")) {
        await deleteDoc(doc(db, "matches", id));
        await loadMatches();
        await loadResults();
      }
    }

    async function loadUsers() {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      const usersSnap = await getDocs(collection(db, "users"));
      usersSnap.forEach((docSnap) => {
        const user = docSnap.data();
        const li = document.createElement("li");
        li.textContent = `${user.nickname || user.email} (${user.role})`;
        const btn = document.createElement("button");
        btn.textContent = "T√∂rl√©s";
        btn.onclick = async () => {
          if (confirm(`T√∂rl√∂d: ${user.email}? Ez nem t√∂rli a bel√©p√©si fi√≥kot, csak a Firestore-b√≥l.`)) {
            await deleteDoc(docSnap.ref);
            await loadUsers();
          }
        };
        li.appendChild(btn);
        list.appendChild(li);
      });
    }

    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;
// üü¶ HIVATALOS SZEZON V√âGI SORREND ‚Äì finalStandings/official

const finalStandingsRef = doc(db, "finalStandings", "official");
const sortableList = document.getElementById("sortableList");
const toggleOrderBtn = document.getElementById("toggleOrder");
const saveOrderBtn = document.getElementById("saveOrderBtn");

let draggedItem = null;

function renderOfficialOrder(list) {
  sortableList.innerHTML = "";
  list.forEach((team, index) => {
    const li = document.createElement("li");
    li.textContent = `${index + 1}. ${team}`;
    li.draggable = true;

    li.addEventListener("dragstart", () => {
      draggedItem = li;
      li.classList.add("dragging");
    });

    li.addEventListener("dragend", () => {
      draggedItem = null;
      li.classList.remove("dragging");
    });

    li.addEventListener("dragover", (e) => {
      e.preventDefault();
      const bounding = li.getBoundingClientRect();
      const offset = bounding.y + (bounding.height / 2);
      const after = (e.clientY - offset) > 0;
      const parent = li.parentNode;
      if (after) {
        parent.insertBefore(draggedItem, li.nextSibling);
      } else {
        parent.insertBefore(draggedItem, li);
      }
    });

    sortableList.appendChild(li);
  });
}

// üîÅ Bet√∂lt√©s Firestore-b√≥l
getDoc(finalStandingsRef).then((docSnap) => {
  if (docSnap.exists()) {
    const data = docSnap.data();
    if (Array.isArray(data.teams)) {
      renderOfficialOrder(data.teams);
    } else {
      renderOfficialOrder(teams); // fallback
    }
  } else {
    renderOfficialOrder(teams); // els≈ë alkalom
  }
});

// üíæ Ment√©s gomb
saveOrderBtn.addEventListener("click", async () => {
  const updatedOrder = Array.from(sortableList.children).map((li) =>
    li.textContent.replace(/^\d+\.\s*/, "")
  );
  await setDoc(finalStandingsRef, { teams: updatedOrder });
  alert("Sorrend elmentve.");
});

// üìÇ Megjelen√≠t√©s/elrejt√©s gomb
toggleOrderBtn.addEventListener("click", () => {
  const visible = sortableList.style.display === "block";
  sortableList.style.display = visible ? "none" : "block";
  saveOrderBtn.style.display = visible ? "none" : "inline-block";
});

  </script>
</head>
<body></body>
</html>
