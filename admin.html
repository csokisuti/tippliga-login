<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin – Meccs és Felhasználók kezelése</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, Timestamp,
      getDocs, deleteDoc, doc, updateDoc, onSnapshot, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.firebasestorage.app",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminEmail = "krisz@krisz.com";

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.email !== adminEmail) {
        document.body.innerHTML = "<h2>⛔ Nincs jogosultságod az admin felülethez.</h2>";
        return;
      }

      const container = document.createElement("div");
      container.innerHTML = `
        <h1>Meccs hozzáadása</h1>
        <form id="matchForm">
          <label>Hazai csapat: <input type="text" id="homeTeam" required></label><br><br>
          <label>Vendég csapat: <input type="text" id="awayTeam" required></label><br><br>
          <label>Kezdés: <input type="datetime-local" id="startTime" required></label><br><br>
          <label>Forduló ID: <input type="text" id="roundId" required></label><br><br>
          <label>Odds 1: <input type="number" step="0.01" id="odds1" required></label><br>
          <label>Odds X: <input type="number" step="0.01" id="oddsX" required></label><br>
          <label>Odds 2: <input type="number" step="0.01" id="odds2" required></label><br><br>
          <button type="submit">Meccs mentése</button>
        </form>
        <hr>
        <h2>Feltöltött meccsek</h2>
        <div id="matchList"></div>
        <hr>
        <h2>Új felhasználó hozzáadása</h2>
        <form id="userForm">
          <label>Email: <input type="email" id="newUserEmail" required></label><br>
          <label>Jelszó: <input type="password" id="newUserPassword" required></label><br>
          <label>Szerepkör: 
            <select id="newUserRole">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </label><br><br>
          <button type="submit">Felhasználó létrehozása</button>
        </form>
        <hr>
        <h2>Felhasználók listája</h2>
        <div id="userList"></div>
      `;

      document.body.appendChild(container);

      const matchForm = document.getElementById("matchForm");
      matchForm.onsubmit = async (e) => {
        e.preventDefault();
        const startTime = Timestamp.fromDate(new Date(document.getElementById("startTime").value));
        await addDoc(collection(db, "matches"), {
          homeTeam: document.getElementById("homeTeam").value,
          awayTeam: document.getElementById("awayTeam").value,
          startTime,
          roundId: document.getElementById("roundId").value,
          odds: {
            "1": parseFloat(document.getElementById("odds1").value),
            "X": parseFloat(document.getElementById("oddsX").value),
            "2": parseFloat(document.getElementById("odds2").value),
          }
        });
        alert("✅ Meccs hozzáadva");
        matchForm.reset();
      };

      const renderMatches = async () => {
        const matchList = document.getElementById("matchList");
        matchList.innerHTML = "";
        const snapshot = await getDocs(collection(db, "matches"));
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const div = document.createElement("div");
          const start = data.startTime.toDate().toLocaleString("hu-HU");
          div.innerHTML = `
            <strong>${data.homeTeam} - ${data.awayTeam}</strong><br>
            Kezdés: ${start} | Forduló: ${data.roundId}<br>
            Odds: 1 - ${data.odds["1"]}, X - ${data.odds["X"]}, 2 - ${data.odds["2"]}<br>
            <button onclick="deleteMatch('${docSnap.id}')">Törlés</button>
            <hr>
          `;
          matchList.appendChild(div);
        });
      };

      window.deleteMatch = async (id) => {
        if (confirm("Biztosan törlöd ezt a meccset?")) {
          await deleteDoc(doc(db, "matches", id));
          renderMatches();
        }
      };

      renderMatches();

      const userForm = document.getElementById("userForm");
      userForm.onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById("newUserEmail").value;
        const password = document.getElementById("newUserPassword").value;
        const role = document.getElementById("newUserRole").value;

        const newUser = await createUserWithEmailAndPassword(auth, email, password);
        await setDoc(doc(db, "users", newUser.user.uid), {
          email,
          role
        });

        alert("✅ Felhasználó létrehozva");
        userForm.reset();
      };

      onSnapshot(collection(db, "users"), (snapshot) => {
        const list = document.getElementById("userList");
        list.innerHTML = "";
        snapshot.forEach(doc => {
          const u = doc.data();
          const li = document.createElement("div");
          li.textContent = `${u.email} (${u.role})`;
          list.appendChild(li);
        });
      });
    });
  </script>
</head>
<body></body>
</html>
