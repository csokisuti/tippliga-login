<!DOCTYPE html>
<html>
<head>
  <title>Admin – TippLiga</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, query, orderBy, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const adminEmail = "krisz@krisz.com";

    onAuthStateChanged(auth, async (user) => {
      if (!user || user.email !== adminEmail) {
        document.body.innerHTML = "<h2>⛔ Nincs jogosultságod az admin felülethez.</h2>";
        return;
      }

      const container = document.createElement("div");

      const matchForm = document.createElement("form");
      matchForm.innerHTML = `
        <h2>Meccs hozzáadása</h2>
        <input id="home" placeholder="Hazai csapat"><br>
        <input id="away" placeholder="Vendég csapat"><br>
        <input id="start" type="datetime-local"><br>
        <input id="round" placeholder="Forduló ID"><br>
        <input id="odds1" placeholder="Odds 1"><br>
        <input id="oddsX" placeholder="Odds X"><br>
        <input id="odds2" placeholder="Odds 2"><br>
        <button type="submit">Meccs mentése</button><br><br>
      `;
      matchForm.onsubmit = async (e) => {
        e.preventDefault();
        await addDoc(collection(db, "matches"), {
          homeTeam: home.value,
          awayTeam: away.value,
          startTime: new Date(start.value),
          roundId: round.value,
          odds: {
            "1": parseFloat(odds1.value),
            "X": parseFloat(oddsX.value),
            "2": parseFloat(odds2.value),
          },
        });
        location.reload();
      };
      container.appendChild(matchForm);

      const toggleBtn = document.createElement("button");
      toggleBtn.textContent = "Meccsek megjelenítése";
      toggleBtn.style.marginTop = "20px";
      container.appendChild(toggleBtn);

      const matchesDiv = document.createElement("div");
      matchesDiv.style.display = "none";
      toggleBtn.onclick = () => {
        matchesDiv.style.display = matchesDiv.style.display === "none" ? "block" : "none";
        toggleBtn.textContent = matchesDiv.style.display === "none" ? "Meccsek megjelenítése" : "Meccsek elrejtése";
      };

      matchesDiv.innerHTML = "<h2>Feltöltött meccsek</h2>";
      const q = query(collection(db, "matches"), orderBy("startTime"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        const m = docSnap.data();
        const box = document.createElement("form");
        box.innerHTML = `
          <input value="${m.homeTeam}" id="homeTeam"><br>
          <input value="${m.awayTeam}" id="awayTeam"><br>
          <input type="datetime-local" value="${new Date(m.startTime.toDate()).toISOString().slice(0,16)}" id="start"><br>
          <input value="${m.roundId}" id="roundId"><br>
          <input value="${m.odds["1"]}" id="odds1"><br>
          <input value="${m.odds["X"]}" id="oddsX"><br>
          <input value="${m.odds["2"]}" id="odds2"><br>
          <button type="submit">Mentés</button>
          <button type="button" id="del">Törlés</button><br><br>
        `;
        box.onsubmit = async (e) => {
          e.preventDefault();
          await updateDoc(doc(db, "matches", docSnap.id), {
            homeTeam: box.querySelector("#homeTeam").value,
            awayTeam: box.querySelector("#awayTeam").value,
            startTime: new Date(box.querySelector("#start").value),
            roundId: box.querySelector("#roundId").value,
            odds: {
              "1": parseFloat(box.querySelector("#odds1").value),
              "X": parseFloat(box.querySelector("#oddsX").value),
              "2": parseFloat(box.querySelector("#odds2").value)
            }
          });
          alert("Mentve");
        };
        box.querySelector("#del").onclick = async () => {
          await deleteDoc(doc(db, "matches", docSnap.id));
          location.reload();
        };
        matchesDiv.appendChild(box);
      });
      container.appendChild(matchesDiv);

      const userForm = document.createElement("form");
      userForm.innerHTML = `
        <h2>Új felhasználó hozzáadása</h2>
        <input id="newEmail" placeholder="Email"><br>
        <input id="newPass" placeholder="Jelszó" type="password"><br>
        <input id="nickname" placeholder="Becenév"><br>
        <select id="newRole">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select><br>
        <button type="submit">Felhasználó létrehozása</button><br><br>
      `;
      userForm.onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById("newEmail").value;
        const pass = document.getElementById("newPass").value;
        const role = document.getElementById("newRole").value;
        const nickname = document.getElementById("nickname").value;
        const tempUser = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "users", tempUser.user.uid), {
          email,
          role,
          nickname
        });
        alert("Sikeres regisztráció");
        location.reload();
      };
      container.appendChild(userForm);

      const usersDiv = document.createElement("div");
      usersDiv.innerHTML = "<h2>Felhasználók listája</h2>";
      const userSnap = await getDocs(collection(db, "users"));
      userSnap.forEach(userDoc => {
        const u = userDoc.data();
        const item = document.createElement("div");
        item.innerHTML = `${u.email} (${u.role}) - ${u.nickname || ""} <button id="remove">Törlés</button>`;
        item.querySelector("#remove").onclick = async () => {
          await deleteDoc(doc(db, "users", userDoc.id));
          location.reload();
        };
        usersDiv.appendChild(item);
      });
      container.appendChild(usersDiv);

      document.body.appendChild(container);
    });
  </script>
</head>
<body></body>
</html>
