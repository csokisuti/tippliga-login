<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin felület</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      onSnapshot,
      doc,
      updateDoc,
      deleteDoc,
      Timestamp,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.firebasestorage.app",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.innerHTML = "<h2>Bejelentkezés szükséges.</h2>";
        return;
      }

      document.body.innerHTML = `
        <h1>Meccs hozzáadása</h1>
        <form id="matchForm">
          <label>Hazai csapat: <input type="text" id="homeTeam" required></label><br><br>
          <label>Vendég csapat: <input type="text" id="awayTeam" required></label><br><br>
          <label>Kezdés időpontja: <input type="datetime-local" id="startTime" required></label><br><br>
          <label>Forduló ID (pl. round1): <input type="text" id="roundId" required></label><br><br>
          <label>Odds 1: <input type="number" step="0.01" id="odds1" required></label><br>
          <label>Odds X: <input type="number" step="0.01" id="oddsX" required></label><br>
          <label>Odds 2: <input type="number" step="0.01" id="odds2" required></label><br><br>
          <button type="submit">Meccs mentése</button>
        </form>

        <h1>Meccsek szerkesztése</h1>
        <div id="matchList"></div>

        <h1>Felhasználó hozzáadása</h1>
        <form id="userForm">
          <label>Email: <input type="email" id="userEmail" required></label><br><br>
          <label>Szerep: 
            <select id="userRole">
              <option value="user">user</option>
              <option value="admin">admin</option>
            </select>
          </label><br><br>
          <button type="submit">Felhasználó mentése</button>
        </form>

        <h1>Felhasználók listája</h1>
        <div id="userList"></div>
      `;

      document.getElementById("matchForm").onsubmit = async (e) => {
        e.preventDefault();
        const homeTeam = document.getElementById("homeTeam").value;
        const awayTeam = document.getElementById("awayTeam").value;
        const startTimeInput = document.getElementById("startTime").value;
        const roundId = document.getElementById("roundId").value;
        const odds1 = parseFloat(document.getElementById("odds1").value);
        const oddsX = parseFloat(document.getElementById("oddsX").value);
        const odds2 = parseFloat(document.getElementById("odds2").value);
        const startTime = Timestamp.fromDate(new Date(startTimeInput));

        await addDoc(collection(db, "matches"), {
          homeTeam,
          awayTeam,
          startTime,
          roundId,
          odds: {
            "1": odds1,
            "X": oddsX,
            "2": odds2
          }
        });

        alert("Meccs elmentve");
        document.getElementById("matchForm").reset();
      };

      onSnapshot(collection(db, "matches"), (snapshot) => {
        const listDiv = document.getElementById("matchList");
        listDiv.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const match = docSnap.data();
          const container = document.createElement("div");
          container.style.border = "1px solid #ccc";
          container.style.margin = "10px";
          container.style.padding = "10px";

          const html = `
            <input type="text" value="${match.homeTeam}" id="home-${docSnap.id}"/>
            vs
            <input type="text" value="${match.awayTeam}" id="away-${docSnap.id}"/><br>
            <input type="datetime-local" value="${new Date(match.startTime.toDate()).toISOString().slice(0,16)}" id="time-${docSnap.id}"/><br>
            Forduló: <input type="text" value="${match.roundId}" id="round-${docSnap.id}"/><br>
            Odds 1: <input type="number" value="${match.odds["1"]}" id="odds1-${docSnap.id}"/>
            X: <input type="number" value="${match.odds["X"]}" id="oddsX-${docSnap.id}"/>
            2: <input type="number" value="${match.odds["2"]}" id="odds2-${docSnap.id}"/><br>
            <button onclick="updateMatch('${docSnap.id}')">Mentés</button>
            <button onclick="deleteMatch('${docSnap.id}')">Törlés</button>
          `;
          container.innerHTML = html;
          listDiv.appendChild(container);
        });
      });

      window.updateMatch = async (id) => {
        const homeTeam = document.getElementById(`home-${id}`).value;
        const awayTeam = document.getElementById(`away-${id}`).value;
        const startTime = Timestamp.fromDate(new Date(document.getElementById(`time-${id}`).value));
        const roundId = document.getElementById(`round-${id}`).value;
        const odds1 = parseFloat(document.getElementById(`odds1-${id}`).value);
        const oddsX = parseFloat(document.getElementById(`oddsX-${id}`).value);
        const odds2 = parseFloat(document.getElementById(`odds2-${id}`).value);

        await updateDoc(doc(db, "matches", id), {
          homeTeam,
          awayTeam,
          startTime,
          roundId,
          odds: {
            "1": odds1,
            "X": oddsX,
            "2": odds2
          }
        });

        alert("Meccs módosítva");
      };

      window.deleteMatch = async (id) => {
        if (confirm("Biztos törlöd ezt a meccset?")) {
          await deleteDoc(doc(db, "matches", id));
        }
      };

      document.getElementById("userForm").onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById("userEmail").value;
        const role = document.getElementById("userRole").value;
        const newUserRef = doc(collection(db, "users"));
        await setDoc(newUserRef, {
          email,
          role
        });
        alert("Felhasználó elmentve");
        document.getElementById("userForm").reset();
      };

      onSnapshot(collection(db, "users"), (snapshot) => {
        const userList = document.getElementById("userList");
        userList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const user = docSnap.data();
          const div = document.createElement("div");
          div.textContent = `${user.email} – ${user.role}`;
          userList.appendChild(div);
        });
      });
    });
  </script>
</head>
<body></body>
</html>
