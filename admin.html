<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .collapsible { cursor: pointer; background-color: #eee; padding: 10px; border: none; text-align: left; font-size: 16px; width: 100%; }
    .content { display: none; padding: 10px; border: 1px solid #ccc; margin-bottom: 20px; }
    .match-card input { margin: 2px; }
    .position-select { margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>Admin fel√ºlet</h1>
  <button onclick="window.location.href='dashboard.html'">‚¨ÖÔ∏è Vissza a dashboardra</button>

  <h2>√öj meccs hozz√°ad√°sa</h2>
  <form id="matchForm">
    <select id="homeTeam" required></select>
    <select id="awayTeam" required></select>
    <input type="datetime-local" id="startTime" required>
    <input type="text" id="roundId" placeholder="Fordul√≥ ID" required>
    <input type="number" id="odds1" step="0.01" placeholder="Odds 1" required>
    <input type="number" id="oddsX" step="0.01" placeholder="Odds X" required>
    <input type="number" id="odds2" step="0.01" placeholder="Odds 2" required>
    <button type="submit">Ment√©s</button>
  </form>

  <button class="collapsible">üìÇ Felt√∂lt√∂tt meccsek megjelen√≠t√©se/elrejt√©se</button>
  <div class="content" id="matchesList"></div>

  <h2>Meccseredm√©nyek kezel√©se</h2>
  <div id="matchesNoResult"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
  <div id="matchesWithResult"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>

  <h2>√öj felhaszn√°l√≥ hozz√°ad√°sa</h2>
  <form id="userForm">
    <input type="text" id="nickname" placeholder="Becen√©v" required>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Jelsz√≥" required>
    <select id="role">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>
    <button type="submit">Felhaszn√°l√≥ l√©trehoz√°sa</button>
  </form>
  <ul id="userList"></ul>

  <h2>NB1 tabella k√©p felt√∂lt√©se</h2>
  <input type="file" id="tableImageInput" accept="image/*">
  <button id="uploadTableImage">Felt√∂lt√©s</button>

  <button class="collapsible">üìä Szezon v√©gi hivatalos sorrend</button>
  <div class="content">
    <div id="officialPositionsContainer"></div>
    <button id="saveOfficialPositions">Ment√©s</button>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, Timestamp,
      doc, updateDoc, deleteDoc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const teams = [
      "Debreceni VSC", "Di√≥sgy≈ëri VTK", "Ferencv√°ros", "ETO FC Gy≈ër", "Kazincbarcikai SC",
      "Kisv√°rda FC", "MTK Budapest", "Ny√≠regyh√°za Spartacus", "Paksi FC",
      "Pusk√°s Akad√©mia", "√öjpest FC", "Zalaegerszegi TE FC"
    ];

    function populateTeamDropdowns() {
      const homeSelect = document.getElementById("homeTeam");
      const awaySelect = document.getElementById("awayTeam");
      teams.forEach(team => {
        const option1 = document.createElement("option");
        option1.value = team;
        option1.textContent = team;
        homeSelect.appendChild(option1);

        const option2 = document.createElement("option");
        option2.value = team;
        option2.textContent = team;
        awaySelect.appendChild(option2);
      });
    }

    function parseOutcome(result) {
      const [home, away] = result.split("-").map(x => parseInt(x.trim()));
      if (isNaN(home) || isNaN(away)) return "";
      if (home > away) return "1";
      if (home < away) return "2";
      return "X";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";

      const docRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(docRef);
      const data = userSnap.data();

      if (!userSnap.exists() || data.role !== "admin") {
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>";
        return;
      }

      populateTeamDropdowns();
      await loadMatches();
      await loadResults();
      await loadUsers();
      await loadOfficialPositions();
    });

    document.getElementById("matchForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const match = {
        homeTeam: homeTeam.value,
        awayTeam: awayTeam.value,
        startTime: Timestamp.fromDate(new Date(startTime.value)),
        roundId: roundId.value,
        odds: {
          "1": parseFloat(odds1.value),
          "X": parseFloat(oddsX.value),
          "2": parseFloat(odds2.value)
        }
      };
      await addDoc(collection(db, "matches"), match);
      alert("Meccs mentve");
      e.target.reset();
      await loadMatches();
      await loadResults();
    });

    async function loadMatches() {
      const container = document.getElementById("matchesList");
      container.innerHTML = "";
      const snapshot = await getDocs(collection(db, "matches"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const div = document.createElement("div");
        div.className = "match-card";
        div.innerHTML = `
          <input value="${data.homeTeam}" id="home-${id}">
          <input value="${data.awayTeam}" id="away-${id}">
          <input type="datetime-local" value="${new Date(data.startTime.toDate()).toISOString().slice(0,16)}" id="start-${id}">
          <input value="${data.roundId}" id="round-${id}">
          <input value="${data.odds["1"]}" id="odds1-${id}">
          <input value="${data.odds["X"]}" id="oddsX-${id}">
          <input value="${data.odds["2"]}" id="odds2-${id}">
          <button onclick="updateMatch('${id}')">Ment√©s</button>
          <button onclick="deleteMatch('${id}')">T√∂rl√©s</button>
        `;
        container.appendChild(div);
      });
    }

    async function updateMatch(id) {
      await updateDoc(doc(db, "matches", id), {
        homeTeam: document.getElementById(`home-${id}`).value,
        awayTeam: document.getElementById(`away-${id}`).value,
        startTime: Timestamp.fromDate(new Date(document.getElementById(`start-${id}`).value)),
        roundId: document.getElementById(`round-${id}`).value,
        odds: {
          "1": parseFloat(document.getElementById(`odds1-${id}`).value),
          "X": parseFloat(document.getElementById(`oddsX-${id}`).value),
          "2": parseFloat(document.getElementById(`odds2-${id}`).value)
        }
      });
      alert("Meccs friss√≠tve");
      await loadMatches();
      await loadResults();
    }

    async function deleteMatch(id) {
      if (confirm("Biztosan t√∂rl√∂d ezt a meccset?")) {
        await deleteDoc(doc(db, "matches", id));
        await loadMatches();
        await loadResults();
      }
    }

    async function loadResults() {
      const noResult = document.getElementById("matchesNoResult");
      const withResult = document.getElementById("matchesWithResult");
      noResult.innerHTML = "<h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3>";
      withResult.innerHTML = "<h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3>";

      const snapshot = await getDocs(collection(db, "matches"));
      const no = [], yes = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const match = { id: docSnap.id, ...data };
        if (data.result) yes.push(match);
        else no.push(match);
      });

      renderMatchResults(no, noResult, false);
      renderMatchResults(yes, withResult, true);
    }

    function renderMatchResults(matches, container, hasResult) {
      const grouped = {};
      matches.forEach(m => {
        const round = m.roundId || "Egy√©b";
        if (!grouped[round]) grouped[round] = [];
        grouped[round].push(m);
      });

      Object.keys(grouped).sort().forEach(roundId => {
        const title = document.createElement("h4");
        title.textContent = `${roundId}. fordul√≥`;
        container.appendChild(title);

        grouped[roundId].forEach(match => {
          const div = document.createElement("div");
          const formatted = match.startTime?.toDate?.().toLocaleString("hu-HU") || "";
          div.innerHTML = `<strong>${match.homeTeam} - ${match.awayTeam}</strong><br>Kezd√©s: ${formatted}<br>`;

          const input = document.createElement("input");
          input.value = match.result || "";
          input.placeholder = "pl. 2-1";

          const btn = document.createElement("button");
          btn.textContent = hasResult ? "M√≥dos√≠t√°s" : "Ment√©s";
          btn.onclick = async () => {
            const val = input.value.trim();
            const outcome = parseOutcome(val);
            if (!outcome) return alert("Hib√°s form√°tum. Haszn√°lj pl. 3-1 vagy 1-1.");
            await updateDoc(doc(db, "matches", match.id), { result: val, outcome });
            await loadResults();
          };

          div.appendChild(input);
          div.appendChild(btn);
          container.appendChild(div);
        });
      });
    }
    async function loadUsers() {
      const usersList = document.getElementById("usersList");
      usersList.innerHTML = "";
      const snapshot = await getDocs(collection(db, "users"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const div = document.createElement("div");
        div.className = "user-card";
        div.innerHTML = `
          <span><strong>${data.nickname || "(N√©vtelen)"}</strong> ‚Äì ${data.email}</span>
          <button onclick="deleteUser('${id}')">T√∂rl√©s</button>
        `;
        usersList.appendChild(div);
      });
    }

    async function deleteUser(uid) {
      if (confirm("Biztosan t√∂rl√∂d ezt a felhaszn√°l√≥t?")) {
        await deleteDoc(doc(db, "users", uid));
        await loadUsers();
      }
    }

    document.getElementById("imageUpload").addEventListener("change", function (e) {
      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result;
        await setDoc(doc(db, "settings", "nb1Table"), { image: base64 });
        alert("Tabella k√©p felt√∂ltve.");
      };
      reader.readAsDataURL(e.target.files[0]);
    });

    async function loadOfficialPositions() {
      const snapshot = await getDoc(doc(db, "settings", "officialPositions"));
      const list = document.getElementById("officialList");
      list.innerHTML = "";
      teams.forEach(team => {
        const li = document.createElement("li");
        li.textContent = team;
        list.appendChild(li);
      });

      if (snapshot.exists()) {
        const current = snapshot.data().positions || [];
        current.forEach((team, index) => {
          const item = document.querySelector(`#officialList li:nth-child(${index + 1})`);
          if (item) item.textContent = team;
        });
      }
    }

    window.saveOfficialPositions = async function () {
      const items = document.querySelectorAll("#officialList li");
      const positions = Array.from(items).map(li => li.textContent);
      await setDoc(doc(db, "settings", "officialPositions"), { positions });
      alert("Szezon v√©gi hivatalos sorrend mentve.");
    };

    let dragged;

    document.addEventListener("dragstart", function (event) {
      dragged = event.target;
      event.target.style.opacity = .5;
    }, false);

    document.addEventListener("dragend", function (event) {
      event.target.style.opacity = "";
    }, false);

    document.addEventListener("dragover", function (event) {
      event.preventDefault();
    }, false);

    document.addEventListener("drop", function (event) {
      event.preventDefault();
      if (event.target.tagName === "LI" && dragged !== event.target) {
        const list = event.target.parentNode;
        const draggedIndex = Array.from(list.children).indexOf(dragged);
        const targetIndex = Array.from(list.children).indexOf(event.target);
        if (draggedIndex < targetIndex) {
          list.insertBefore(dragged, event.target.nextSibling);
        } else {
          list.insertBefore(dragged, event.target);
        }
      }
    }, false);

    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;

    document.querySelectorAll(".toggle-section").forEach(toggle => {
      toggle.addEventListener("click", () => {
        const content = toggle.nextElementSibling;
        content.classList.toggle("hidden");
      });
    });
  </script>
</body>
</html>
