<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Admin felület</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select { margin: 5px; }
    .match-block { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>Admin felület</h1>

  <h2>Új meccs hozzáadása</h2>
  <form id="addMatchForm">
    <input type="text" id="homeTeam" placeholder="Hazai csapat" required>
    <input type="text" id="awayTeam" placeholder="Vendég csapat" required>
    <input type="number" step="0.01" id="odds1" placeholder="Odds 1" required>
    <input type="number" step="0.01" id="oddsX" placeholder="Odds X" required>
    <input type="number" step="0.01" id="odds2" placeholder="Odds 2" required>
    <input type="datetime-local" id="startTime" required>
    <input type="number" id="round" placeholder="Forduló száma" required>
    <button type="submit">Meccs hozzáadása</button>
  </form>

  <h2>Elkezdődött meccsek eredményének rögzítése</h2>
  <div id="resultSection">Betöltés...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      updateDoc,
      doc,
      Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      loadResultSection();
    });

    document.getElementById("addMatchForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      await addDoc(collection(db, "matches"), {
        homeTeam: document.getElementById("homeTeam").value,
        awayTeam: document.getElementById("awayTeam").value,
        odds1: parseFloat(document.getElementById("odds1").value),
        oddsX: parseFloat(document.getElementById("oddsX").value),
        odds2: parseFloat(document.getElementById("odds2").value),
        startTime: Timestamp.fromDate(new Date(document.getElementById("startTime").value)),
        round: parseInt(document.getElementById("round").value)
      });

      alert("Meccs hozzáadva!");
      e.target.reset();
      loadResultSection();
    });

    async function loadResultSection() {
      const container = document.getElementById("resultSection");
      container.innerHTML = "";
      const now = new Date();

      const matchesSnap = await getDocs(collection(db, "matches"));
      matchesSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (!data.result && data.startTime?.toDate() < now) {
          const div = document.createElement("div");
          div.className = "match-block";
          div.innerHTML = `
            <strong>${data.homeTeam} - ${data.awayTeam}</strong> (${data.round}. forduló)<br>
            <label>Eredmény: <input type="text" id="res-${docSnap.id}" placeholder="pl. 2-1"></label>
            <button onclick="saveResult('${docSnap.id}')">Mentés</button>
          `;
          container.appendChild(div);
        }
      });
    }

    window.saveResult = async function (matchId) {
      const input = document.getElementById(`res-${matchId}`);
      const result = input.value.trim();
      if (!/^\d+-\d+$/.test(result)) {
        alert("Hibás formátum (pl. 2-1)");
        return;
      }

      const [g1, g2] = result.split("-").map(Number);
      let outcome = "X";
      if (g1 > g2) outcome = "1";
      if (g2 > g1) outcome = "2";

      await updateDoc(doc(db, "matches", matchId), {
        result,
        outcome
      });

      alert("Eredmény mentve.");
      loadResultSection();
    };
  </script>
</body>
</html>
