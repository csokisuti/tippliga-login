<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-600:#1d4ed8;--danger:#ef4444;--border:#e5e7eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left,.topbar .right{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .cards{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;background:linear-gradient(180deg,#fff,#fafafa)}
    .card-head h3{margin:0;font-size:16px}
    .card-head .hint{color:var(--muted);font-size:12px}
    .card-body{display:none;padding:16px;border-top:1px solid var(--border)}
    .card.open .card-body{display:block}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input[type="datetime-local"]{min-width:230px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f9fafb;color:#334155;font-weight:600}
    .muted{color:var(--muted)}
    .ok{color:#16a34a;font-weight:700}
    .warn{color:#b45309;font-weight:700}
    .sortable{list-style:none;padding:0;counter-reset:pos}
    .sortable li{position:relative;padding:10px 10px 10px 36px;margin:5px 0;background:#f2f2f2;border:1px solid #ccc;border-radius:8px;cursor:grab}
    .sortable li.dragging{opacity:.5}
    .sortable li::before{counter-increment:pos;content:counter(pos) ". ";position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted)}
    .filterbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .small{font-size:12px}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .xscroll{overflow:auto}
    details summary{cursor:pointer;color:#334155}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, Timestamp, doc, updateDoc, deleteDoc, getDoc, setDoc,
      query, orderBy, limit, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain:"tippliga-4b3af.firebaseapp.com", projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com", messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const GS_BULKMAIL_URL = "https://script.google.com/macros/s/AKfycbwaWtKa9jidmdxIVO1qkX443kvW0I87_YCC7_S_uNTbWnHCMit1F4suP-58eJUwP_iF/exec";

    const teams = ["Debreceni VSC","Di√≥sgy≈ëri VTK","Ferencv√°ros","ETO FC Gy≈ër","Kazincbarcikai SC","Kisv√°rda FC","MTK Budapest","Ny√≠regyh√°za Spartacus","Paksi FC","Pusk√°s Akad√©mia","√öjpest FC","Zalaegerszegi TE FC"];

    function parseOutcome(r){ const p=r.split("-").map(x=>parseInt(x.trim())); if(p.length!==2||isNaN(p[0])||isNaN(p[1])) return ""; if(p[0]>p[1]) return "1"; if(p[0]<p[1]) return "2"; return "X" }
    const stripNumPrefix = s => (s||"").replace(/^\s*\d+[\.\)]?\s*/,"");

    let _currentTplId = null;

    function esc(s){ return (s ?? '').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    onAuthStateChanged(auth, async (user) => {
      if(!user){ document.body.innerHTML = "<h2 style='padding:20px'>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return }
      const userSnap = await getDoc(doc(db, "users", user.email));
      if(!userSnap.exists() || (userSnap.data().role !== "admin")){
        document.body.innerHTML = "<h2 style='padding:20px'>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return
      }
      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
      await loadPositionsLock();
      await loadOfficialOrder();
      await loadTemplates();
      await loadMailLog();

      // Real-time figyel√©s a lez√°r√°s √°llapot√°ra (st√°tusz azonnal friss√ºl)
      onSnapshot(doc(db,"settings","positionsLock"), ()=> loadPositionsLock());

      // ‚¨áÔ∏è az UI elk√©sz√ºlte ut√°n pr√≥b√°ljuk alkalmazni az esetleges #import adatot
      tryImportFromHash();
    });

    function makeCard({title, hint, id, open=false, bodyHTML=""}){
      const s=document.createElement("section"); s.className="card"; if(id) s.id=id; if(open) s.classList.add("open");
      const h=document.createElement("div"); h.className="card-head"; h.innerHTML = `<h3>${title}</h3><div class="hint">${hint||""}</div>`; h.onclick=()=>s.classList.toggle("open");
      const b=document.createElement("div"); b.className="card-body"; b.innerHTML=bodyHTML;
      s.append(h,b); return {section:s, body:b}
    }

    function initUI(){
      const top=document.createElement("div"); top.className="topbar";
      const left=document.createElement("div"); left.className="left";
      const right=document.createElement("div"); right.className="right";
      const back=document.createElement("button"); back.className="btn"; back.textContent="‚¨ÖÔ∏è Vissza a dashboardra"; back.onclick=()=>location.href="dashboard.html";
      const expand=document.createElement("button"); expand.className="btn"; expand.textContent="Mindet nyisd le"; expand.onclick=()=>document.querySelectorAll(".card").forEach(c=>c.classList.add("open"));
      const collapse=document.createElement("button"); collapse.className="btn"; collapse.textContent="Mindet csukd √∂ssze"; collapse.onclick=()=>document.querySelectorAll(".card").forEach(c=>c.classList.remove("open"));
      const refresh=document.createElement("button"); refresh.className="btn"; refresh.textContent="Friss√≠t√©s"; refresh.onclick=()=>{ loadMatches(); loadUsers(); loadResults(); loadPositionsLock(); loadOfficialOrder(); loadTemplates(); loadMailLog(); };
      left.appendChild(back); right.append(expand, collapse, refresh); top.append(left,right); document.body.appendChild(top);

      const wrap=document.createElement("div"); wrap.className="cards";

      const teamOpts = teams.map(t=>`<option value="${t}">${t}</option>`).join("");
      const cAdd = makeCard({title:"√öj meccs hozz√°ad√°sa", hint:"Gyors ≈±rlap", id:"card-add", open:true, bodyHTML:`
        <form id="matchForm">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${teamOpts}</select>
            <select id="awayTeam" required><option value="">Vend√©g csapat</option>${teamOpts}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Fordul√≥ ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn primary">Ment√©s</button>
          </div>
        </form>`});

      const cManage = makeCard({title:"Felt√∂lt√∂tt meccsek", hint:"Sz≈±r√©s, gyors szerkeszt√©s", id:"card-manage", bodyHTML:`
        <div class="filterbar">
          <select id="filterRound"><option value="">√ñsszes fordul√≥</option></select>
          <input id="filterTeam" placeholder="Csapat sz≈±r√©s" />
          <button class="btn" id="applyFilters">Sz≈±r√©s</button>
          <button class="btn" id="resetFilters">T√∂rl√©s</button>
        </div>
        <div id="matchesList"></div>`});

      const cRes = makeCard({title:"Meccseredm√©nyek kezel√©se", hint:"Gyors be√≠r√°s", id:"card-results", bodyHTML:`
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
          <div class="card-body" id="noResultContent"></div>
        </div>
        <div class="card" style="margin:0">
          <div class="card-head" id="withResultHeader"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>
          <div class="card-body" id="withResultContent" style="display:block"></div>
        </div>`});

      const cUsers = makeCard({title:"Felhaszn√°l√≥k kezel√©se", hint:"Szerepk√∂r v√°lt√°s, t√∂rl√©s", id:"card-users", bodyHTML:`<ul id="userList" class="list" style="margin:0"></ul>`});

      const cBulk = makeCard({title:"K√∂remail k√ºld√©se + sablonok", hint:"C√≠mzettek kijel√∂l√©se, t√°rgy, √ºzenet, sablonkezel√©s", id:"card-bulkmail", bodyHTML:`
        <div class="row">
          <button class="btn" id="bulkLoadUsers">Felhaszn√°l√≥k bet√∂lt√©se</button>
          <label class="inline"><input type="checkbox" id="bulkSelectAll"> Mind kijel√∂l</label>
        </div>
        <div id="bulkUsersBox" style="max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:8px; margin:8px 0;"></div>

        <div class="row">
          <input id="bulkSubject" placeholder="T√°rgy" style="flex:1;">
        </div>
        <div class="row">
          <textarea id="bulkMessage" placeholder="HTML √ºzenet" rows="8" style="width:100%"></textarea>
        </div>

        <div class="row" style="gap:12px; align-items:center; border-top:1px dashed var(--border); padding-top:10px; margin-top:6px">
          <strong class="muted">Sablonok</strong>
          <select id="tplSelect" style="min-width:240px"><option value="">‚Äî V√°lassz sablont ‚Äî</option></select>
          <button class="btn" id="tplRefresh" title="Sablonok friss√≠t√©se">Friss√≠t</button>
          <button class="btn" id="tplLoad" title="Bet√∂lt√©s a szerkeszt≈ëbe">Bet√∂lt</button>
          <button class="btn" id="tplSaveAs" title="Jelenlegi tartalom ment√©se √∫j sablonk√©nt">Ment√©s √∫jk√©nt</button>
          <button class="btn" id="tplSave" title="Kijel√∂lt sablon fel√ºl√≠r√°sa a jelenlegi tartalommal">Fel√ºl√≠r√°s</button>
          <button class="btn danger" id="tplDelete" title="Kijel√∂lt sablon t√∂rl√©se">T√∂rl√©s</button>
          <span class="muted small" id="tplStatus"></span>
        </div>

        <div class="row">
          <button class="btn primary" id="bulkSendBtn">K√ºld√©s</button>
          <button class="btn" id="bulkPing" title="GAS webapp ellen≈ërz√©s (verzi√≥)">Ping</button>
          <span id="bulkInfo" class="muted small"></span>
        </div>`});

      const cLog = makeCard({title:"K√∂remail napl√≥", hint:"Utols√≥ 50 k√ºld√©s", id:"card-maillog", bodyHTML:`
        <div class="row">
          <button class="btn" id="logRefresh">Friss√≠t</button>
          <span class="muted small">Katt a sorra a r√©szletekhez ‚Ä¢ <span class="kbd">‚Ü© Bet√∂lt</span> gombbal visszat√∂ltheted a t√°rgy/√ºzenet mez≈ëkbe</span>
        </div>
        <div id="mailLogBox" class="xscroll"></div>`});

      const cTable = makeCard({title:"NB1 tabella k√©p felt√∂lt√©se", hint:"PNG/JPG, base64 t√°rol√°s", id:"card-table", bodyHTML:`
        <div class="row">
          <input type="file" id="tableImageInput" accept="image/*">
          <button id="uploadTableImage" class="btn primary">Felt√∂lt√©s</button>
        </div>`});

      const cOrder = makeCard({title:"Hivatalos szezon v√©gi sorrend", hint:"H√∫zd‚Äì√©s‚Äìvidd, ment√©s", id:"card-order", bodyHTML:`
        <button id="toggleOrder" class="btn">Sorrend szerkeszt√©se/elrejt√©se</button>
        <ul id="sortableList" class="sortable" style="display:none; margin-top:10px;"></ul>
        <button id="saveOrderBtn" style="display:none;" class="btn primary">Ment√©s</button>`});

      const cLock = makeCard({title:"Poz√≠ci√≥s tipp lez√°r√°s", hint:"Azonnal vagy id≈ëpontra", id:"card-lock", bodyHTML:`
        <div class="muted">Itt szab√°lyozhat√≥ a Szezon v√©gi poz√≠ci√≥s sorrend m√≥dos√≠that√≥s√°ga.</div>
        <div class="row" style="margin-top:8px">
          <label><input type="checkbox" id="lockNow"> Azonnali lez√°r√°s</label>
          <span class="muted">vagy</span>
          <label>Automatikus z√°r√°s id≈ëpontja: <input type="datetime-local" id="lockUntil"></label>
        </div>
        <div class="row"><input type="text" id="lockMessage" placeholder="Opcion√°lis √ºzenet" style="flex:1;"></div>
        <div class="row">
          <button id="saveLock" class="btn primary">Lez√°r√°s be√°ll√≠t√°sa</button>
          <button id="clearLock" class="btn danger">Lez√°r√°s felold√°sa</button>
          <span id="lockStatus" class="muted"></span>
        </div>`});

      document.body.appendChild(wrap);
      wrap.append(cAdd.section, cManage.section, cRes.section, cUsers.section, cBulk.section, cLog.section, cTable.section, cOrder.section, cLock.section);

      document.getElementById("matchForm").addEventListener("submit", onAddMatch);
      document.getElementById("uploadTableImage").addEventListener("click", onUploadTable);
      document.getElementById("withResultHeader").onclick=()=>{ const c=document.getElementById("withResultContent"); c.style.display = c.style.display==="none" ? "block":"none" };
      const sortableList = document.getElementById("sortableList");
      document.getElementById("toggleOrder").onclick=()=>{ const vis = sortableList.style.display==="block"; sortableList.style.display = vis? "none":"block"; document.getElementById("saveOrderBtn").style.display = vis? "none":"inline-block" };
      document.getElementById("saveOrderBtn").onclick = saveOfficialOrder;
      document.getElementById("applyFilters").onclick = renderMatchesFiltered;
      document.getElementById("resetFilters").onclick = ()=>{ document.getElementById("filterRound").value=""; document.getElementById("filterTeam").value=""; renderMatchesFiltered() };
      document.getElementById("bulkLoadUsers").onclick = bulkLoadUsers;
      document.getElementById("bulkSelectAll").onchange = (e)=>{ document.querySelectorAll("#bulkUsersBox input[type=checkbox]").forEach(cb=> cb.checked = e.target.checked) };
      document.getElementById("bulkSendBtn").onclick = bulkSend;
      document.getElementById("bulkPing").onclick = pingServer;

      document.getElementById("tplRefresh").onclick = loadTemplates;
      document.getElementById("tplLoad").onclick = loadTemplateIntoForm;
      document.getElementById("tplSaveAs").onclick = saveTemplateAs;
      document.getElementById("tplSave").onclick = saveTemplateUpdate;
      document.getElementById("tplDelete").onclick = deleteTemplate;

      document.getElementById("logRefresh").onclick = loadMailLog;

      /* √öJ: gombok bek√∂t√©se a lez√°r√°s k√°rty√°n */
      document.getElementById("saveLock").onclick = saveLock;
      document.getElementById("clearLock").onclick = clearLock;
    }

    let _matchesCache = [];
    async function loadMatches(){
      const container = document.getElementById("matchesList");
      container.innerHTML = "";
      const snap = await getDocs(collection(db,"matches"));
      _matchesCache = [];
      const rounds = new Set();
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        _matchesCache.push({ id:docSnap.id, homeTeam:d.homeTeam, awayTeam:d.awayTeam, startTime:d.startTime, roundId:d.roundId, odds:d.odds||{}, result:d.result||"", outcome:d.outcome||"" });
        if(d.roundId!=null) rounds.add(String(d.roundId));
      });
      const fr=document.getElementById("filterRound");
      fr.innerHTML = '<option value="">√ñsszes fordul√≥</option>' + Array.from(rounds).sort((a,b)=>parseInt(a)-parseInt(b)).map(r=>`<option value="${r}">${r}</option>`).join("");
      renderMatchesFiltered();
    }

    function renderMatchesFiltered(){
      const r = document.getElementById("filterRound").value.trim();
      const q = (document.getElementById("filterTeam").value||"").toLowerCase();
      const list = _matchesCache.filter(m=> (!r || String(m.roundId)===r) && (!q || (m.homeTeam||"").toLowerCase().includes(q) || (m.awayTeam||"").toLowerCase().includes(q)) );
      renderMatches(list);
    }

    function renderMatches(list){
      const container = document.getElementById("matchesList");
      container.innerHTML = "";
      if(list.length===0){ container.innerHTML = '<div class="muted">Nincs tal√°lat.</div>'; return }
      list.sort((a,b)=>{ const ra=(parseInt(a.roundId||0)-parseInt(b.roundId||0)); if(ra) return ra; const ta=(a.startTime?.toDate?.()||new Date(0))-(b.startTime?.toDate?.()||new Date(0)); return ta });
      const dataList = document.createElement("datalist"); dataList.id = "teamsList"; dataList.innerHTML = teams.map(t=>`<option value="${t}">`).join(""); container.appendChild(dataList);
      list.forEach(d=>{
        const div=document.createElement("div"); div.className="card";
        div.innerHTML = `
          <div class="card-head"><h3>${d.roundId||""}. fordul√≥ ‚Äì ${d.homeTeam||""} vs ${d.awayTeam||""}</h3><div class="hint">${d.startTime?.toDate?.()?.toLocaleString("hu-HU")||""}</div></div>
          <div class="card-body">
            <div class="row">
              <input list="teamsList" value="${d.homeTeam||""}" id="home-${d.id}">
              <input list="teamsList" value="${d.awayTeam||""}" id="away-${d.id}">
              <input type="datetime-local" value="${new Date(d.startTime.toDate()).toISOString().slice(0,16)}" id="start-${d.id}">
              <input value="${d.roundId||""}" id="round-${d.id}">
              <input value="${d.odds["1"]??""}" id="odds1-${d.id}" placeholder="Odds 1" style="width:90px">
              <input value="${d.odds["X"]??""}" id="oddsX-${d.id}" placeholder="Odds 2" style="width:90px">
              <input value="${d.odds["2"]??""}" id="odds2-${d.id}" placeholder="Odds X" style="width:90px">
              <button class="btn primary" onclick="updateMatch('${d.id}')">Ment√©s</button>
              <button class="btn danger" onclick="deleteMatch('${d.id}')">T√∂rl√©s</button>
            </div>
          </div>`;
        div.querySelector(".card-head").onclick = ()=> div.classList.toggle("open");
        container.appendChild(div);
      });
    }

    async function updateMatch(id){
      const ref = doc(db,"matches",id);
      await updateDoc(ref,{
        homeTeam: document.getElementById(`home-${id}`).value,
        awayTeam: document.getElementById(`away-${id}`).value,
        startTime: Timestamp.fromDate(new Date(document.getElementById(`start-${id}`).value)),
        roundId: document.getElementById(`round-${id}`).value,
        odds: {
          "1": parseFloat(document.getElementById(`odds1-${id}`).value),
          "X": parseFloat(document.getElementById(`oddsX-${id}`).value),
          "2": parseFloat(document.getElementById(`odds2-${id}`).value)
        }
      });
      alert("Mentve");
      await loadMatches();
      await loadResults();
    }

    async function deleteMatch(id){
      if(!confirm("Biztos t√∂r√∂lni akarod?")) return;
      await deleteDoc(doc(db,"matches",id));
      await loadMatches();
      await loadResults();
    }

    async function onAddMatch(e){
      e.preventDefault();
      const startTime = Timestamp.fromDate(new Date(document.getElementById("startTime").value));
      const homeTeam=document.getElementById("homeTeam"), awayTeam=document.getElementById("awayTeam"), roundId=document.getElementById("roundId"), odds1=document.getElementById("odds1"), oddsX=document.getElementById("oddsX"), odds2=document.getElementById("odds2");
      await addDoc(collection(db,"matches"),{ homeTeam:homeTeam.value, awayTeam:awayTeam.value, startTime, roundId:roundId.value, odds:{"1":parseFloat(odds1.value),"X":parseFloat(oddsX.value),"2":parseFloat(odds2.value)} });
      alert("Meccs mentve"); e.target.reset(); await loadMatches(); await loadResults();
    }

    async function onUploadTable(){
      const f=document.getElementById("tableImageInput").files[0]; if(!f) return alert("V√°lassz ki egy k√©pet!");
      const rd=new FileReader(); rd.onload=async()=>{ const b64=rd.result.split(",")[1]; await setDoc(doc(db,"settings","nbi_table_image"),{ base64:b64 }); alert("K√©p elmentve Firestore-ba!"); }; rd.readAsDataURL(f);
    }

    async function loadResults(){
      const noC=document.getElementById("noResultContent");
      const withC=document.getElementById("withResultContent");
      noC.innerHTML=""; withC.innerHTML="";
      const snap = await getDocs(collection(db,"matches"));
      const no=[], yes=[];
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const m={ id:docSnap.id, homeTeam:d.homeTeam, awayTeam:d.awayTeam, startTime:d.startTime, roundId:d.roundId, result:d.result||"" };
        if(d.result) yes.push(m); else no.push(m);
      });
      renderMatchGroup(no, noC, false);
      renderMatchGroup(yes, withC, true);
    }

    function renderMatchGroup(matches, container, hasResult){
      const grouped={};
      matches.forEach(m=>{ const r=m.roundId||"Egy√©b"; (grouped[r]||(grouped[r]=[])).push(m) });
      Object.keys(grouped).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(r=>{
        const title=document.createElement("h4"); title.textContent = `${r}. fordul√≥`; container.appendChild(title);
        grouped[r].forEach(match=>{
          const div=document.createElement("div"); div.className="card";
          div.innerHTML = `
            <div class="card-head"><h3>${match.homeTeam} - ${match.awayTeam}</h3><div class="hint">${match.startTime?.toDate?.()?.toLocaleString("hu-HU")||""}</div></div>
            <div class="card-body">
              <div class="row">
                <input placeholder="pl. 2-1" value="${match.result||""}" id="res-${match.id}" style="width:80px">
                <button class="btn primary" id="btn-${match.id}">${hasResult? "M√≥dos√≠t√°s":"Ment√©s"}</button>
              </div>
            </div>`;
          div.querySelector(".card-head").onclick = ()=> div.classList.toggle("open");
          div.querySelector(`#btn-${match.id}`).onclick = async ()=>{
            const v=document.getElementById(`res-${match.id}`).value.trim();
            const oc=parseOutcome(v); if(!oc){ alert("Hib√°s form√°tum. pl. 3-1 vagy 1-1"); return }
            await updateDoc(doc(db,"matches",match.id),{ result:v, outcome:oc });
            await loadResults();
          };
          container.appendChild(div);
        });
      });
    }

    async function loadUsers(){
      const list=document.getElementById("userList"); list.innerHTML="";
      const snap=await getDocs(collection(db,"users"));
      snap.forEach(docSnap=>{
        const user=docSnap.data();
        const li=document.createElement("li"); li.className="card";
        li.innerHTML = `
          <div class="card-head"><h3>${user.nickname||user.email}</h3><div class="hint">${user.email}</div></div>
          <div class="card-body">
            <div class="row">
              <select class="roleSel">
                <option value="user" ${user.role==="user"?"selected":""}>User</option>
                <option value="admin" ${user.role==="admin"?"selected":""}>Admin</option>
              </select>
              <button class="btn primary save-role">Ment√©s</button>
              <button class="btn danger delete-user">T√∂rl√©s</button>
            </div>
          </div>`;
        li.querySelector(".card-head").onclick=()=>li.classList.toggle("open");
        const sel=li.querySelector(".roleSel");
        li.querySelector(".save-role").onclick=async ()=>{ await updateDoc(doc(db,"users",user.email),{ role: sel.value }); alert("Szerepk√∂r friss√≠tve.") };
        li.querySelector(".delete-user").onclick=async ()=>{ if(!confirm(`T√∂rl√∂d: ${user.email}? Ez nem t√∂rli a bel√©p√©si fi√≥kot, csak a Firestore-b√≥l.`)) return; await deleteDoc(doc(db,"users",user.email)); await loadUsers() };
        list.appendChild(li);
      });
    }

    async function bulkLoadUsers(){
      const box=document.getElementById("bulkUsersBox");
      box.innerHTML = "<div class='muted'>Bet√∂lt√©s‚Ä¶</div>";
      const snap = await getDocs(collection(db,"users"));
      const arr=[];
      snap.forEach(d=>{ const u=d.data(); if(u&&u.email) arr.push({email:u.email,nickname:u.nickname||u.email,role:u.role||"user"}) });
      arr.sort((a,b)=>(a.nickname||"").localeCompare(b.nickname||"","hu"));
      box.innerHTML = arr.map(u=>`
        <label style="display:flex;align-items:center;gap:8px;padding:6px 4px;">
          <input type="checkbox" value="${u.email}">
          <span style="flex:1">${u.nickname}</span>
          <span class="muted">${u.email}</span>
          ${u.role==="admin" ? '<span class="muted">(admin)</span>' : ''}
        </label>`).join("");
    }

    async function bulkSend(){
      const subject=(document.getElementById("bulkSubject").value||"").trim();
      const htmlBody=(document.getElementById("bulkMessage").value||"").trim();
      const emails=Array.from(document.querySelectorAll("#bulkUsersBox input[type=checkbox]:checked")).map(cb=>cb.value).filter(Boolean);
      if(emails.length===0){ alert("V√°lassz legal√°bb egy c√≠mzettet."); return }
      if(!subject){ alert("Adj meg t√°rgyat."); return }
      if(!htmlBody){ alert("Adj meg √ºzenetet."); return }
      const user=auth.currentUser; if(!user){ alert("Nincs bejelentkezve."); return }
      const idToken=await user.getIdToken();
      document.getElementById("bulkInfo").textContent = "K√ºld√©s folyamatban‚Ä¶";
      const res = await fetch(GS_BULKMAIL_URL, {
        method: "POST",
        body: JSON.stringify({ action:"sendBulkEmail", idToken, emails, subject, htmlBody, templateId: _currentTplId || "" })
      });
      const data=await res.json().catch(()=>({ok:false,error:"JSON hiba"}));
      document.getElementById("bulkInfo").textContent = "";
      if(!data.ok){ alert("Hiba a k√ºld√©sn√©l: " + (data.error||"")); return }
      const v  = data.version || 'n/a';
      const hl = (data.echo && typeof data.echo.htmlLen==='number') ? data.echo.htmlLen : (htmlBody||'').length;
      const ec = (data.echo && typeof data.echo.emailsCount==='number') ? data.echo.emailsCount : emails.length;
      alert(`K√©sz. Kik√ºldve: ${data.sent} c√≠mre.
verzi√≥: ${v}
htmlLen: ${hl} | c√≠mzettek: ${ec}`);
      await loadMailLog();
    }

    async function pingServer(){
      try{
        const res = await fetch(GS_BULKMAIL_URL, {
          method: "POST",
          body: JSON.stringify({ action:"ping" })
        });
        const data = await res.json().catch(()=>({ok:false}));
        alert(`Ping: ${data.ok ? 'OK' : 'HIBA'}
verzi√≥: ${data.version || 'n/a'}`);
      }catch(e){
        alert('Ping hiba: ' + e);
      }
    }

    async function loadTemplates(){
      const sel = document.getElementById("tplSelect");
      sel.innerHTML = `<option value="">‚Äî V√°lassz sablont ‚Äî</option>`;
      const qy = query(collection(db,"mailTemplates"), orderBy("updatedAt","desc"), limit(100));
      const snap = await getDocs(qy);
      const opts = [];
      snap.forEach(d=>{
        const t = d.data();
        opts.push(`<option value="${d.id}">${t.title||"(n√©vtelen)"} ‚Äî ${t.subject||""}</option>`);
      });
      sel.insertAdjacentHTML("beforeend", opts.join(""));
      document.getElementById("tplStatus").textContent = `Sablonok: ${opts.length} db`;
    }

    async function loadTemplateIntoForm(){
      const id = document.getElementById("tplSelect").value;
      if(!id) return alert("V√°lassz sablont.");
      const d = await getDoc(doc(db,"mailTemplates", id));
      if(!d.exists()) return alert("A sablon nem tal√°lhat√≥.");
      const t = d.data();
      document.getElementById("bulkSubject").value = t.subject || "";
      document.getElementById("bulkMessage").value = t.htmlBody || "";
      _currentTplId = id;
      document.getElementById("tplStatus").textContent = `Bet√∂ltve: ${t.title||id}`;
    }

    async function saveTemplateAs(){
      const title = prompt("Sablon neve:");
      if(!title) return;
      const subject=(document.getElementById("bulkSubject").value||"").trim();
      const htmlBody=(document.getElementById("bulkMessage").value||"").trim();
      const user = auth.currentUser;
      await addDoc(collection(db,"mailTemplates"),{
        title, subject, htmlBody,
        createdBy: user?.email || "",
        updatedAt: Timestamp.fromDate(new Date())
      });
      _currentTplId = null;
      await loadTemplates();
      document.getElementById("tplStatus").textContent = `Mentve: ${title}`;
    }

    async function saveTemplateUpdate(){
      const id = document.getElementById("tplSelect").value;
      if(!id) return alert("V√°lassz sablont, amit fel√ºl√≠runk.");
      const subject=(document.getElementById("bulkSubject").value||"").trim();
      const htmlBody=(document.getElementById("bulkMessage").value||"").trim();
      await updateDoc(doc(db,"mailTemplates", id),{
        subject, htmlBody, updatedAt: Timestamp.fromDate(new Date())
      });
      _currentTplId = id;
      await loadTemplates();
      document.getElementById("tplStatus").textContent = "Sablon friss√≠tve.";
    }

    async function deleteTemplate(){
      const id = document.getElementById("tplSelect").value;
      if(!id) return alert("V√°lassz sablont a t√∂rl√©shez.");
      if(!confirm("Biztos t√∂rl√∂d a sablont?")) return;
      await deleteDoc(doc(db,"mailTemplates", id));
      _currentTplId = null;
      await loadTemplates();
      document.getElementById("tplStatus").textContent = "Sablon t√∂r√∂lve.";
    }

    function fmtDate(ts){ try{ return ts?.toDate?.()?.toLocaleString("hu-HU") || "" }catch{ return "" } }

    async function loadMailLog(){
      const box = document.getElementById("mailLogBox");
      box.innerHTML = "<div class='muted'>Bet√∂lt√©s‚Ä¶</div>";
      const qy = query(collection(db,"adminMailLog"), orderBy("sentAt","desc"), limit(50));
      const snap = await getDocs(qy);
      if(snap.empty){ box.innerHTML = "<div class='muted'>Nincs m√©g bejegyz√©s.</div>"; return; }

      let html = "<table><thead><tr><th>Id≈ëpont</th><th>T√°rgy</th><th>C√≠mzettek</th><th>Felad√≥</th><th></th></tr></thead><tbody>";
      const rows = [];
      snap.forEach(d=>{
        const x=d.data();
        const id=d.id;
        const count = x.sentCount ?? (x.recipients?.length||0);
        rows.push(`
          <tr data-id="${id}">
            <td>${fmtDate(x.sentAt)}</td>
            <td>${(x.subject||"").replace(/</g,"&lt;")}</td>
            <td>${count} c√≠mzett</td>
            <td>${x.sender||""}</td>
            <td><button class="btn small" data-load="${id}">‚Ü© Bet√∂lt</button></td>
          </tr>
          <tr><td colspan="5">
            <details>
              <summary>R√©szletek</summary>
              <div class="small" style="margin:8px 0"><strong>C√≠mzettek:</strong> ${(x.recipients||[]).join(", ")||"‚Äî"}</div>
              <div class="small"><strong>Forr√°s sablon:</strong> ${x.templateId||"‚Äî"}</div>
              <div class="small"><strong>S√©ma:</strong> ${x.schema||"‚Äî"} ‚Ä¢ <strong>T√∂rzs hossza:</strong> ${x.bodyLen ?? ((x.bodyHtml||x.htmlBody||x.html||'')+'').length}</div>
              <div style="border:1px solid var(--border); border-radius:10px; padding:8px; background:#fff; margin-top:8px">
                ${x.bodyHtml || x.htmlBody || x.html || "<em class='muted'>Nincs bodyHtml/htmlBody/html mez≈ë a dokumentumban.</em>"}
              </div>
              <details style="margin-top:8px">
                <summary class="small">Nyers dokumentum (debug)</summary>
                <pre class="small" style="white-space:pre-wrap; background:#f8fafc; padding:8px; border:1px solid var(--border); border-radius:8px;">${esc(JSON.stringify(x,null,2))}</pre>
              </details>
            </details>
          </td></tr>
        `);
      });
      html += rows.join("") + "</tbody></table>";
      box.innerHTML = html;

      box.querySelectorAll("button[data-load]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute("data-load");
          const d = await getDoc(doc(db,"adminMailLog", id));
          if(!d.exists()) return;
          const x = d.data();
          document.getElementById("bulkSubject").value = x.subject || "";
          document.getElementById("bulkMessage").value = (x.bodyHtml || x.htmlBody || x.html || "");
          _currentTplId = x.templateId || null;
          alert("Bet√∂ltve a szerkeszt≈ëbe.");
        };
      });
    }

    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;

    async function loadPositionsLock(){
      const status=document.getElementById("lockStatus");
      const snap=await getDoc(doc(db,"settings","positionsLock"));
      if(!snap.exists()){
        status.textContent="Jelenleg nyitva.";
        status.className="muted";
        document.getElementById("lockNow").checked = false;
        document.getElementById("lockUntil").value = "";
        document.getElementById("lockMessage").value = "";
        return;
      }
      const d=snap.data()||{};
      const isLocked=!!d.isLocked;
      const until=d.lockUntil?.toDate?.()||null;
      const msg=d.message||"";
      const now=new Date();
      const timeLocked=until && now>=until;

      if(isLocked||timeLocked){
        status.textContent = `Z√ÅRVA ${timeLocked&&until?`(hat√°rid≈ë: ${until.toLocaleString("hu-HU")})`:"(azonnali z√°r√°s)"}${msg?` ‚Äì ${msg}`:""}`;
        status.className="warn";
      } else {
        status.textContent="Jelenleg nyitva.";
        status.className="ok";
      }

      document.getElementById("lockNow").checked = !!isLocked;
      document.getElementById("lockUntil").value = until ? new Date(until).toISOString().slice(0,16) : "";
      document.getElementById("lockMessage").value = msg;
    }

    async function saveLock(){
      const lockNow=document.getElementById("lockNow").checked;
      const untilStr=document.getElementById("lockUntil").value;
      const message=document.getElementById("lockMessage").value.trim();
      let docObj={ isLocked:!!lockNow, message: message||"" };
      if(untilStr){
        const dt=new Date(untilStr);
        if(isNaN(+dt)) return alert("Hib√°s d√°tum/id≈ë.");
        docObj.lockUntil = Timestamp.fromDate(dt);
      } else {
        docObj.lockUntil = null;
      }
      await setDoc(doc(db,"settings","positionsLock"), docObj);
      alert("Lez√°r√°s be√°ll√≠tva.");
      await loadPositionsLock();
    }

    async function clearLock(){
      await setDoc(doc(db,"settings","positionsLock"),{ isLocked:false, lockUntil:null, message:"" });
      alert("Lez√°r√°s feloldva.");
      await loadPositionsLock();
    }

    async function loadOfficialOrder(){
      const ref=doc(db,"finalStandings","official");
      const listEl=document.getElementById("sortableList");
      listEl.innerHTML="";
      const snap=await getDoc(ref);
      const source = snap.exists() && Array.isArray(snap.data().teams) ? snap.data().teams : teams;
      const arr = source.map(stripNumPrefix);
      let dragged=null;
      arr.forEach(team=>{
        const li=document.createElement("li"); li.textContent=team; li.draggable=true;
        li.addEventListener("dragstart",()=>{ dragged=li; li.classList.add("dragging") });
        li.addEventListener("dragend",()=>{ dragged=null; li.classList.remove("dragging") });
        li.addEventListener("dragover",(e)=>{ e.preventDefault(); const r=li.getBoundingClientRect(); const after=(e.clientY - (r.top + r.height/2))>0; const p=li.parentNode; p.insertBefore(dragged, after? li.nextSibling: li) });
        listEl.appendChild(li);
      });
    }

    async function saveOfficialOrder(){
      const list=[...document.querySelectorAll("#sortableList li")].map(li=> stripNumPrefix(li.textContent.trim()));
      await setDoc(doc(db,"finalStandings","official"),{ teams:list, positions:list.map((t,i)=>({ team:t, position:i+1 })) });
      alert("Sorrend elmentve.");
    }

    /* ===========================
       √öJ: Bookmarklet import fogad√°sa (#import=...)
       =========================== */

    // Alias-map + √©kezet- √©s toldal√©k-robosztus egyez√©s
    const _teamNameMap = {
      "Debrecen":"Debreceni VSC","Debreceni VSC":"Debreceni VSC",
      "Diosgyor":"Di√≥sgy≈ëri VTK","Di√≥sgy≈ër":"Di√≥sgy≈ëri VTK","Di√≥sgy≈ëri VTK":"Di√≥sgy≈ëri VTK",
      "Ferencvaros":"Ferencv√°ros","Ferencv√°ros":"Ferencv√°ros",
      "ETO":"ETO FC Gy≈ër","Gyor":"ETO FC Gy≈ër","Gy≈ër":"ETO FC Gy≈ër","ETO FC Gy≈ër":"ETO FC Gy≈ër",
      "Kazincbarcika":"Kazincbarcikai SC","Kazincbarcika":"Kazincbarcikai SC",
      "Kisvarda":"Kisv√°rda FC","Kisv√°rda":"Kisv√°rda FC","Kisv√°rda FC":"Kisv√°rda FC",
      "MTK":"MTK Budapest","MTK Budapest":"MTK Budapest",
      "Nyiregyhaza":"Ny√≠regyh√°za Spartacus","Ny√≠regyh√°za":"Ny√≠regyh√°za Spartacus","Ny√≠regyh√°za Spartacus":"Ny√≠regyh√°za Spartacus",
      "Paks":"Paksi FC","Paksi FC":"Paksi FC",
      "Puskas Akademia":"Pusk√°s Akad√©mia","Pusk√°s Akad√©mia":"Pusk√°s Akad√©mia",
      "Ujpest":"√öjpest FC","√öjpest":"√öjpest FC","√öjpest FC":"√öjpest FC",
      "Zalaegerszeg":"Zalaegerszegi TE FC","Zalaegerszegi TE FC":"Zalaegerszegi TE FC"
    };

    function _deaccent(s){
      return (s||"")
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')
        .replace(/\s+/g,' ')
        .trim()
        .toLowerCase();
    }
    function _normTeamName(s){
      if(!s) return s;
      const key1 = _deaccent(s);
      const byMap = _teamNameMap[s] || _teamNameMap[key1?.replace(/\./g,'')];
      return byMap || s.trim();
    }
    function _setSelectByText(sel, value){
      if(!sel || !value) return;
      const wanted = _deaccent(value)
        .replace(/\./g,'')
        .replace(/\b(fc|te|sc|vtk)\b/g,'')
        .replace(/\s+/g,' ')
        .trim();

      // 1) pontos egyez√©s (√©kezetlen√≠tve)
      let idx = [...sel.options].findIndex(o => _deaccent(o.text) === wanted);
      // 2) tartalmazza / r√©sz-egyez√©s
      if(idx < 0) idx = [...sel.options].findIndex(o => {
        const t = _deaccent(o.text);
        return t.includes(wanted) || wanted.includes(t);
      });
      // 3) kezdettel egyez√©s
      if(idx < 0) idx = [...sel.options].findIndex(o => _deaccent(o.text).startsWith(wanted));

      if(idx >= 0) sel.selectedIndex = idx;
    }

    function _applyImportData(data){
      const homeSel = document.getElementById("homeTeam");
      const awaySel = document.getElementById("awayTeam");
      const startInp = document.getElementById("startTime");
      const odd1 = document.getElementById("odds1");
      const oddX = document.getElementById("oddsX");
      const odd2 = document.getElementById("odds2");
      const roundInp = document.getElementById("roundId");

      if(!homeSel || !awaySel || !startInp || !odd1 || !oddX || !odd2 || !roundInp){
        setTimeout(()=>_applyImportData(data), 200);
        return;
      }

      if(data.home) _setSelectByText(homeSel, _normTeamName(data.home));
      if(data.away) _setSelectByText(awaySel, _normTeamName(data.away));

      if(data.startISO){ startInp.value = data.startISO; }

      if(data.odds){
        if(typeof data.odds.o1==="number" && !Number.isNaN(data.odds.o1)) odd1.value = String(data.odds.o1);
        if(typeof data.odds.oX==="number" && !Number.isNaN(data.odds.oX)) oddX.value = String(data.odds.oX);
        if(typeof data.odds.o2==="number" && !Number.isNaN(data.odds.o2)) odd2.value = String(data.odds.o2);
      }

      if(data.roundId != null){
        roundInp.value = String(data.roundId).trim();
      }

      // Hash t√∂rl√©se (egyszeri import)
      history.replaceState(null, "", location.pathname + location.search);
      console.log("Import sikeres:", data);
    }

    function tryImportFromHash(){
      const m = (location.hash||"").match(/^#import=(.+)$/);
      if(!m) return;
      try{
        const json = decodeURIComponent(escape(atob(m[1])));
        const data = JSON.parse(json);
        _applyImportData(data);
      }catch(e){
        console.error("Import hiba:", e);
      }
    }

    // Ha valaki k√©zzel illeszti be k√©s≈ëbb a hash-t:
    window.addEventListener("hashchange", tryImportFromHash);
  </script>
</head>
<body></body>
</html>

