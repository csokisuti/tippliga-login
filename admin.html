<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body{font-family:Arial, sans-serif; padding:20px; background:#f6f7fb; color:#0f172a}
    .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left{display:flex;gap:8px;align-items:center}
    .topbar .right{display:flex;gap:8px;align-items:center}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #e6eaf1;background:#ffffff;cursor:pointer}
    .btn-primary{background:#3b82f6;color:#fff;border-color:#3b82f6}
    .btn-danger{background:#ef4444;color:#fff;border-color:#ef4444}
    .card{border:1px solid #e6eaf1;background:#fff;border-radius:12px;margin:12px 0;box-shadow:0 6px 24px rgba(15,23,42,.06)}
    .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer}
    .head h2{margin:0;font-size:18px}
    .hint{color:#64748b;font-size:13px}
    .body{display:none;border-top:1px solid #e6eaf1;padding:14px}
    .card.open .body{display:block}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:#64748b;font-size:14px}
    .ok{color:#16a34a;font-weight:700}
    .warn{color:#b45309;font-weight:700}
    input[type="datetime-local"],input[type="text"],input[type="number"],select{padding:8px 10px;border:1px solid #e6eaf1;border-radius:8px;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid #e6eaf1;text-align:left}
    th{background:#f9fafb;color:#334155;font-weight:600}
    .filterbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .list{list-style:none;padding:0;margin:0}
    .list li{padding:10px;margin:6px 0;background:#fff;border:1px solid #e6eaf1;border-radius:10px}

    /* Sorrend szerkeszt√©s ‚Äì sorsz√°m vizu√°lisan, ne legyen a sz√∂veg r√©sze */
    .sortable{list-style:none;padding:0;counter-reset:pos}
    .sortable li{position:relative;padding:10px 10px 10px 36px;margin:5px 0;background:#f2f2f2;border:1px solid #ccc;border-radius:8px;cursor:grab}
    .sortable li.dragging{opacity:.5}
    .sortable li::before{counter-increment:pos;content: counter(pos) ". ";position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#64748b}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, Timestamp, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain: "tippliga-4b3af.firebaseapp.com", projectId: "tippliga-4b3af", storageBucket: "tippliga-4b3af.appspot.com", messagingSenderId: "720359845241", appId: "1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const teams = ["Debreceni VSC","Di√≥sgy≈ëri VTK","Ferencv√°ros","ETO FC Gy≈ër","Kazincbarcikai SC","Kisv√°rda FC","MTK Budapest","Ny√≠regyh√°za Spartacus","Paksi FC","Pusk√°s Akad√©mia","√öjpest FC","Zalaegerszegi TE FC"];

    function parseOutcome(result){ const p=result.split("-").map(x=>parseInt(x.trim())); if(p.length!==2||isNaN(p[0])||isNaN(p[1])) return ""; if(p[0]>p[1]) return "1"; if(p[0]<p[1]) return "2"; return "X" }
    // " 12. Ferencv√°ros" -> "Ferencv√°ros"
    const stripNumPrefix = s => (s||'').replace(/^\s*\d+[\.\)]?\s*/, '');
    const norm = s => stripNumPrefix(s).replace(/\s+/g,' ').trim().toLowerCase();

    let allMatchesCache = [];
    let usersCache = [];

    onAuthStateChanged(auth, async (user) => {
      if (!user){ document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return }
      const uref = doc(db, "users", user.email);
      const usnap = await getDoc(uref);
      const data = usnap.data();
      if (!usnap.exists() || data.role !== "admin"){ document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return }
      initUI();
      await loadMatches();
      await loadResults();
      await loadUsers();
      await loadPositionsLock();
      await loadOfficialOrder();
    });

    function card(title, hint){
      const s=document.createElement('section'); s.className='card';
      const h=document.createElement('div'); h.className='head';
      const t=document.createElement('h2'); t.textContent=title; h.appendChild(t);
      const hi=document.createElement('div'); hi.className='hint'; hi.textContent=hint||''; h.appendChild(hi);
      const b=document.createElement('div'); b.className='body';
      h.addEventListener('click',()=>s.classList.toggle('open'));
      s.appendChild(h); s.appendChild(b); return {section:s, body:b}
    }

    function initUI(){
      const top=document.createElement('div'); top.className='topbar';
      const left=document.createElement('div'); left.className='left';
      const right=document.createElement('div'); right.className='right';
      const back=document.createElement('button'); back.className='btn'; back.textContent='‚¨ÖÔ∏è Vissza a dashboardra'; back.onclick=()=>location.href='dashboard.html';
      const expand=document.createElement('button'); expand.className='btn'; expand.textContent='Mindet nyisd le'; expand.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.add('open'));
      const collapse=document.createElement('button'); collapse.className='btn'; collapse.textContent='Mindet csukd √∂ssze'; collapse.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.remove('open'));
      const refresh=document.createElement('button'); refresh.className='btn'; refresh.textContent='Friss√≠t√©s'; refresh.onclick=()=>{ loadMatches(); loadResults(); loadUsers(); loadPositionsLock(); loadOfficialOrder(); pairWithUsers(); };
      left.appendChild(back); right.append(expand, collapse, refresh); top.append(left, right); document.body.appendChild(top);

      const c1=card('√öj meccs hozz√°ad√°sa','Gyors ≈±rlap');
      const homeOptions = teams.map(team => `<option value="${team}">${team}</option>`).join('');
      const awayOptions = homeOptions;
      c1.body.innerHTML = `
        <form id="matchForm">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${homeOptions}</select>
            <select id="awayTeam" required><option value="">Vend√©g csapat</option>${awayOptions}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Fordul√≥ ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn btn-primary">Ment√©s</button>
          </div>
        </form>`;
      document.body.appendChild(c1.section);

      const c2=card('Felt√∂lt√∂tt meccsek kezel√©se','Sz≈±r√©s, gyors szerkeszt√©s');
      c2.body.innerHTML = `
        <div class="filterbar">
          <select id="filterRound"><option value="">√ñsszes fordul√≥</option></select>
          <input id="filterTeam" placeholder="Csapat sz≈±r√©s" />
          <button class="btn" id="applyFilters">Sz≈±r√©s</button>
          <button class="btn" id="resetFilters">T√∂rl√©s</button>
        </div>
        <div id="matchesList"></div>`;
      document.body.appendChild(c2.section);

      const c3=card('Meccseredm√©nyek kezel√©se','Gyors be√≠r√°s');
      c3.body.innerHTML = `
        <div id="matchesNoResult" class="card"><div class="head"><h2>üü° Eredm√©ny n√©lk√ºli meccsek</h2></div><div class="body" id="noResultContent"></div></div>
        <div id="matchesWithResult" class="card"><div class="head" id="withResultHeader"><h2>üü¢ R√∂gz√≠tett eredm√©nyek</h2></div><div class="body" id="withResultContent"></div></div>`;
      c3.section.classList.add('open');
      document.body.appendChild(c3.section);

      const c4=card('Felhaszn√°l√≥k kezel√©se','Szerepk√∂r v√°lt√°s, t√∂rl√©s');
      c4.body.innerHTML = `
        <div class="filterbar"><input id="userSearch" placeholder="Keres√©s e-mail vagy becen√©v"></div>
        <ul id="userList" class="list"></ul>`;
      document.body.appendChild(c4.section);

      const c5=card('NB1 tabella k√©p felt√∂lt√©se','Base64 ment√©s');
      c5.body.innerHTML = `
        <div class="row">
          <input type="file" id="tableImageInput" accept="image/*">
          <button id="uploadTableImage" class="btn btn-primary">Felt√∂lt√©s</button>
        </div>`;
      document.body.appendChild(c5.section);

      const c6=card('Hivatalos szezon v√©gi sorrend','H√∫zd‚Äì√©s‚Äìvidd, ment√©s √©s p√°ros√≠t√°s a tippekkel');
      c6.body.innerHTML = `
        <button id="toggleOrder" class="btn">Sorrend szerkeszt√©se/elrejt√©se</button>
        <ul id="sortableList" class="sortable" style="display:none; margin-top:10px;"></ul>
        <div class="row" style="margin-top:10px">
          <button id="saveOrderBtn" style="display:none;" class="btn btn-primary">Ment√©s</button>
          <button id="calcPairing" class="btn">J√°t√©kos tippek p√°ros√≠t√°sa</button>
        </div>
        <div id="pairingResults" style="margin-top:12px"></div>`;
      document.body.appendChild(c6.section);

      const c7=card('Poz√≠ci√≥s tipp lez√°r√°s','Azonnal vagy id≈ëpontra');
      c7.body.innerHTML = `
        <div class="muted">Itt szab√°lyozhat√≥ a Szezon v√©gi poz√≠ci√≥s sorrend m√≥dos√≠that√≥s√°ga.</div>
        <div class="row" style="margin-top:8px">
          <label><input type="checkbox" id="lockNow"> Azonnali lez√°r√°s</label>
          <span class="muted">vagy</span>
          <label>Automatikus z√°r√°s id≈ëpontja: <input type="datetime-local" id="lockUntil"></label>
        </div>
        <div class="row"><input type="text" id="lockMessage" placeholder="Opcion√°lis √ºzenet" style="flex:1;"></div>
        <div class="row">
          <button id="saveLock" class="btn btn-primary">Lez√°r√°s be√°ll√≠t√°sa</button>
          <button id="clearLock" class="btn btn-danger">Lez√°r√°s felold√°sa</button>
          <span id="lockStatus" class="muted"></span>
        </div>`;
      document.body.appendChild(c7.section);

      document.getElementById('matchForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const startTime = Timestamp.fromDate(new Date(document.getElementById('startTime').value));
        await addDoc(collection(db, 'matches'), {
          homeTeam: homeTeam.value,
          awayTeam: awayTeam.value,
          startTime,
          roundId: roundId.value,
          odds: { "1": parseFloat(odds1.value), "X": parseFloat(oddsX.value), "2": parseFloat(odds2.value) }
        });
        alert('Meccs mentve');
        e.target.reset();
        await loadMatches();
        await loadResults();
      });

      document.getElementById('uploadTableImage').addEventListener('click', async ()=>{
        const file = document.getElementById('tableImageInput').files[0];
        if(!file){ alert('V√°lassz k√©pet'); return }
        const reader = new FileReader();
        reader.onload = async ()=>{
          const base64String = reader.result.split(',')[1];
          await setDoc(doc(db,'settings','nbi_table_image'), { base64: base64String });
          alert('K√©p elmentve Firestore-ba');
        };
        reader.readAsDataURL(file);
      });

      document.getElementById('applyFilters').onclick=renderMatchesFiltered;
      document.getElementById('resetFilters').onclick=()=>{ document.getElementById('filterRound').value=''; document.getElementById('filterTeam').value=''; renderMatchesFiltered() };
      document.getElementById('userSearch').addEventListener('input', filterUsers);
      document.getElementById('withResultHeader').addEventListener('click',()=>{
        const c=document.getElementById('withResultContent'); c.parentElement.classList.toggle('open')
      });
      document.getElementById('toggleOrder').addEventListener('click',()=>{
        const v=document.getElementById('sortableList').style.display==='block';
        document.getElementById('sortableList').style.display=v?'none':'block';
        document.getElementById('saveOrderBtn').style.display=v?'none':'inline-block';
      });
      document.getElementById('saveOrderBtn').addEventListener('click', saveOfficialOrder);
      document.getElementById('calcPairing').addEventListener('click', pairWithUsers);
    }

    async function loadMatches(){
      const snap = await getDocs(collection(db,'matches'));
      allMatchesCache = [];
      snap.forEach(docSnap=>{ allMatchesCache.push({ id: docSnap.id, ...docSnap.data() }) });
      const rounds = Array.from(new Set(allMatchesCache.map(m=>m.roundId).filter(Boolean))).sort((a,b)=>parseInt(a)-parseInt(b));
      const fr = document.getElementById('filterRound');
      fr.innerHTML = '<option value="">√ñsszes fordul√≥</option>' + rounds.map(r=>`<option value="${r}">${r}</option>`).join('');
      renderMatchesFiltered();
    }

    function renderMatchesFiltered(){
      const r = document.getElementById('filterRound').value.trim();
      const q = document.getElementById('filterTeam').value.trim().toLowerCase();
      let list = allMatchesCache.slice();
      if(r) list = list.filter(m=>String(m.roundId)===r);
      if(q) list = list.filter(m=> (m.homeTeam||'').toLowerCase().includes(q) || (m.awayTeam||'').toLowerCase().includes(q) );
      renderMatches(list);
    }

    function renderMatches(list){
      const container = document.getElementById('matchesList');
      container.innerHTML = '';
      if(list.length===0){ container.innerHTML='<div class="muted">Nincs tal√°lat.</div>'; return }
      list.sort((a,b)=>{
        const ra=parseInt(a.roundId||0)-parseInt(b.roundId||0); if(ra!==0) return ra;
        const ta=(a.startTime?.toDate?.()||new Date(0))-(b.startTime?.toDate?.()||new Date(0)); return ta
      });
      const tbl=document.createElement('table');
      tbl.innerHTML='<thead><tr><th>Fordul√≥</th><th>Id≈ëpont</th><th>Meccs</th><th>Odds 1/X/2</th><th>M≈±velet</th></tr></thead>';
      const tb=document.createElement('tbody');
      list.forEach(m=>{
        const tr=document.createElement('tr');
        const dt=m.startTime?.toDate?.()? new Date(m.startTime.toDate()).toISOString().slice(0,16):'';
        const homeSel = selectTeams(`home-${m.id}`, m.homeTeam);
        const awaySel = selectTeams(`away-${m.id}`, m.awayTeam);
        const odds1 = document.createElement('input'); odds1.style.width='90px'; odds1.value = m.odds?.["1"] ?? '';
        const oddsX = document.createElement('input'); oddsX.style.width='90px'; oddsX.value = m.odds?.["X"] ?? '';
        const odds2 = document.createElement('input'); odds2.style.width='90px'; odds2.value = m.odds?.["2"] ?? '';
        const time = document.createElement('input'); time.type='datetime-local'; time.id=`start-${m.id}`; time.value=dt;
        const round = document.createElement('input'); round.id=`round-${m.id}`; round.value=m.roundId||'';
        const save=document.createElement('button'); save.className='btn btn-primary'; save.textContent='Ment√©s'; save.onclick=()=>updateMatch(m.id, homeSel.value, awaySel.value, time.value, round.value, odds1.value, oddsX.value, odds2.value);
        const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='T√∂rl√©s'; del.onclick=()=>deleteMatch(m.id);
        const td1=document.createElement('td'); td1.textContent=m.roundId||'';
        const td2=document.createElement('td'); td2.appendChild(time);
        const td3=document.createElement('td'); const row=document.createElement('div'); row.className='row'; row.append(homeSel, document.createTextNode(' ‚Äì '), awaySel); td3.appendChild(row);
        const td4=document.createElement('td'); const row2=document.createElement('div'); row2.className='row'; row2.append(odds1,oddsX,odds2); td4.appendChild(row2);
        const td5=document.createElement('td'); const row3=document.createElement('div'); row3.className='row'; row3.append(save, del); td5.appendChild(row3);
        tr.append(td1,td2,td3,td4,td5); tb.appendChild(tr);
      });
      tbl.appendChild(tb); container.appendChild(tbl);
    }

    function selectTeams(id, selected){
      const s=document.createElement('select'); s.id=id;
      const opts = [''].concat(teams);
      opts.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t||'V√°lassz csapatot'; if(t===selected) o.selected=true; s.appendChild(o) });
      return s
    }

    async function updateMatch(id, homeV, awayV, startV, roundV, o1, oX, o2){
      const ref = doc(db,'matches',id);
      await updateDoc(ref, {
        homeTeam: homeV,
        awayTeam: awayV,
        startTime: Timestamp.fromDate(new Date(startV)),
        roundId: roundV,
        odds: { "1": parseFloat(o1), "X": parseFloat(oX), "2": parseFloat(o2) }
      });
      alert('Mentve');
      await loadMatches();
      await loadResults();
    }

    async function deleteMatch(id){
      if(!confirm('Biztos t√∂r√∂lni akarod?')) return;
      await deleteDoc(doc(db,'matches',id));
      await loadMatches();
      await loadResults();
    }

    async function loadResults(){
      const noResultContent=document.getElementById('noResultContent');
      const withResultContent=document.getElementById('withResultContent');
      noResultContent.innerHTML=''; withResultContent.innerHTML='';
      const snap = await getDocs(collection(db,'matches'));
      const noResult=[]; const withResult=[];
      snap.forEach(docSnap=>{ const data=docSnap.data(); const m={ id:docSnap.id, ...data }; if(data.result) withResult.push(m); else noResult.push(m) });
      renderMatchGroup(noResult,noResultContent,false);
      renderMatchGroup(withResult,withResultContent,true);
    }

    function renderMatchGroup(matches, container, hasResult){
      const grouped={};
      matches.forEach(m=>{ const r=m.roundId||'Egy√©b'; if(!grouped[r]) grouped[r]=[]; grouped[r].push(m) });
      Object.keys(grouped).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(r=>{
        const title=document.createElement('h4'); title.textContent = r+'. fordul√≥'; container.appendChild(title);
        grouped[r].forEach(match=>{
          const card=document.createElement('div'); card.className='card';
          const head=document.createElement('div'); head.className='head'; const h=document.createElement('h2'); h.textContent=`${match.homeTeam} - ${match.awayTeam}`; head.appendChild(h); card.appendChild(head);
          const body=document.createElement('div'); body.className='body'; const formatted=match.startTime?.toDate?.()?.toLocaleString('hu-HU')||''; body.innerHTML=`Kezd√©s: ${formatted}`;
          const input=document.createElement('input'); input.placeholder='pl. 2-1'; input.value=match.result||''; input.style.width='80px'; input.style.marginLeft='10px';
          const btn=document.createElement('button'); btn.className='btn btn-primary'; btn.textContent= hasResult? 'M√≥dos√≠t√°s':'Ment√©s'; btn.style.marginLeft='10px';
          btn.onclick=async ()=>{ const v=input.value.trim(); const oc=parseOutcome(v); if(!oc){ alert('Hib√°s form√°tum. pl. 3-1 vagy 1-1'); return } await updateDoc(doc(db,'matches',match.id),{ result:v, outcome:oc }); await loadResults() };
          body.appendChild(input); body.appendChild(btn); card.appendChild(body); container.appendChild(card);
          head.addEventListener('click',()=>card.classList.toggle('open'))
        })
      })
    }

    async function loadUsers(){
      const list=document.getElementById('userList'); list.innerHTML='';
      const snap = await getDocs(collection(db,'users'));
      usersCache = [];
      snap.forEach(docSnap=>{ usersCache.push(docSnap.data()) });
      renderUsers(usersCache);
    }

    function renderUsers(arr){
      const list=document.getElementById('userList'); list.innerHTML='';
      arr.forEach(user=>{
        const li=document.createElement('li');
        const nickname=user.nickname||user.email;
        li.innerHTML = `
          <div class="row" style="justify-content:space-between; gap:12px">
            <div>
              <div><strong>${nickname}</strong></div>
              <div class="muted">${user.email}</div>
            </div>
            <div class="row">
              <select class="roleSel">
                <option value="user" ${user.role==='user'?'selected':''}>User</option>
                <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
              </select>
              <button class="btn btn-primary save-role">Ment√©s</button>
              <button class="btn btn-danger delete-user">T√∂rl√©s</button>
            </div>
          </div>`;
        const sel=li.querySelector('.roleSel');
        li.querySelector('.save-role').onclick=async ()=>{ await updateDoc(doc(db,'users',user.email),{ role: sel.value }); alert('Szerepk√∂r friss√≠tve.') };
        li.querySelector('.delete-user').onclick=async ()=>{ if(!confirm(`T√∂rl√∂d: ${user.email}? Ez nem t√∂rli a bel√©p√©si fi√≥kot, csak a Firestore-b√≥l.`)) return; await deleteDoc(doc(db,'users',user.email)); await loadUsers() };
        list.appendChild(li);
      })
    }

    function filterUsers(){
      const q=document.getElementById('userSearch').value.trim().toLowerCase();
      const arr = q? usersCache.filter(u=> (u.email||'').toLowerCase().includes(q) || (u.nickname||'').toLowerCase().includes(q) ): usersCache;
      renderUsers(arr);
    }

    async function loadPositionsLock(){
      const status=document.getElementById('lockStatus');
      const snap=await getDoc(doc(db,'settings','positionsLock'));
      if(!snap.exists()){ status.textContent='Jelenleg nyitva.'; status.className='muted'; return }
      const data=snap.data()||{};
      const isLocked=!!data.isLocked;
      const until=data.lockUntil?.toDate?.()||null;
      const msg=data.message||'';
      const now=new Date();
      const timeLocked=until && now>=until;
      if(isLocked || timeLocked){ status.textContent = `Z√ÅRVA ${timeLocked&&until?`(hat√°rid≈ë: ${until.toLocaleString('hu-HU')})`:'(azonnali z√°r√°s)'}${msg?` ‚Äì ${msg}`:''}`; status.className='warn' } else { status.textContent='Jelenleg nyitva.'; status.className='ok' }
    }

    async function saveLock(){
      const lockNow=document.getElementById('lockNow').checked;
      const untilStr=document.getElementById('lockUntil').value;
      const message=document.getElementById('lockMessage').value.trim();
      let lockDoc={ isLocked: !!lockNow, message: message || '' };
      if(untilStr){ const dt=new Date(untilStr); if(isNaN(+dt)){ alert('Hib√°s d√°tum/id≈ë.'); return } lockDoc.lockUntil = Timestamp.fromDate(dt) } else { lockDoc.lockUntil = null }
      await setDoc(doc(db,'settings','positionsLock'), lockDoc);
      alert('Lez√°r√°s be√°ll√≠tva.');
      await loadPositionsLock();
    }

    async function clearLock(){
      await setDoc(doc(db,'settings','positionsLock'),{ isLocked:false, lockUntil:null, message:'' });
      alert('Lez√°r√°s feloldva.');
      await loadPositionsLock();
    }

    // ===== Hivatalos sorrend bet√∂lt√©se / ment√©se =====
    async function loadOfficialOrder(){
      const ref=doc(db,'finalStandings','official');
      const snap=await getDoc(ref);
      const list=document.getElementById('sortableList'); list.innerHTML='';
      const arr = snap.exists() && Array.isArray(snap.data().teams) ? snap.data().teams : teams.slice();
      // sorsz√°mok lev√°g√°sa m√°r itt
      arr.forEach((t)=>{ const clean = stripNumPrefix(t); const li=document.createElement('li'); li.draggable=true; li.dataset.team=clean; li.textContent=clean; list.appendChild(li) });
      let drag=null;
      document.querySelectorAll('#sortableList li').forEach(li=>{
        li.addEventListener('dragstart',()=>{ drag=li; li.classList.add('dragging') });
        li.addEventListener('dragend',()=>{ if(drag) drag.classList.remove('dragging'); drag=null });
        li.addEventListener('dragover',(e)=>{ e.preventDefault(); const r=li.getBoundingClientRect(); const after=(e.clientY - r.top) > (r.height/2); li.parentNode.insertBefore(drag, after?li.nextSibling:li) });
      });
    }

    async function saveOfficialOrder(){
      // ment√©skor is lev√°gjuk a sorsz√°mot
      const list=[...document.querySelectorAll('#sortableList li')].map(li=> stripNumPrefix(li.dataset.team || li.textContent.trim()));
      await setDoc(doc(db,'finalStandings','official'),{ teams:list, positions:list.map((t,i)=>({ team:t, position:i+1 })) });
      alert('Sorrend elmentve.');
      await pairWithUsers();
    }

    // ===== J√°t√©kos tippek p√°ros√≠t√°sa =====
    function normalizeTipOrder(data){
      if(!data) return [];
      if(Array.isArray(data.teams)) return data.teams;
      if(Array.isArray(data.order)) return data.order;
      if(Array.isArray(data.positions)) return data.positions.sort((a,b)=> (a.position||0)-(b.position||0)).map(x=>x.team);
      const entries = Object.entries(data).filter(([k,v])=> typeof v === 'number');
      if(entries.length) return entries.sort((a,b)=>a[1]-b[1]).map(([k])=>k);
      return [];
    }

    async function pairWithUsers(){
      // p√°ros√≠t√°sn√°l is tiszt√≠tjuk a sorsz√°mot
      const official = [...document.querySelectorAll('#sortableList li')].map(li=> stripNumPrefix(li.dataset.team || li.textContent.trim()));
      if(official.length===0){ document.getElementById('pairingResults').innerHTML = '<div class="muted">El≈ëbb t√∂ltsd be a hivatalos sorrendet.</div>'; return }
      const posMap = new Map(official.map((t,i)=>[norm(t), i+1]));

      const snap = await getDocs(collection(db,'standingsTips'));
      const rows=[];
      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const tip = normalizeTipOrder(d);
        if(!tip || tip.length===0) return;
        const pMap = new Map(tip.map((t,i)=>[norm(t), i+1]));
        let exact=0, disp=0;
        official.forEach((t,i)=>{
          const o=i+1; const p = pMap.get(norm(t));
          if(p!=null){ if(p===o) exact++; disp += Math.abs(p-o) } else { disp += official.length }
        });
        const u = usersCache.find(u=> (u.email||'').toLowerCase() === (docSnap.id||'').toLowerCase());
        rows.push({ email: docSnap.id, nickname: (u&&u.nickname)||docSnap.id, exact, disp });
      });
      rows.sort((a,b)=> b.exact - a.exact || a.disp - b.disp || a.nickname.localeCompare(b.nickname));

      const out = document.createElement('div');
      const tbl = document.createElement('table');
      tbl.innerHTML = '<thead><tr><th>J√°t√©kos</th><th>Pontos helyek</th><th>Elt√©r√©s √∂sszesen</th></tr></thead>';
      const tb = document.createElement('tbody');
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.nickname} <span class="muted">(${r.email})</span></td><td><strong>${r.exact}</strong></td><td>${r.disp}</td>`;
        tb.appendChild(tr);
      });
      tbl.appendChild(tb); out.appendChild(tbl);
      const host=document.getElementById('pairingResults'); host.innerHTML=''; host.appendChild(out);
    }

    window.saveLock=saveLock; window.clearLock=clearLock; window.pairWithUsers=pairWithUsers;
  </script>
</head>
<body>
  <div class="topbar">
    <div class="left"></div>
    <div class="right"></div>
  </div>
</body>
</html>
