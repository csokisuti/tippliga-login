<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* --- Finom√≠tott st√≠lusok (m≈±k√∂d√©s v√°ltoztat√°sa n√©lk√ºl) --- */
    :root{--border:#e6eaf1;--muted:#64748b;--bg:#f6f7fb;--card:#fff;--primary:#3b82f6;--danger:#ef4444}
    body{background:var(--bg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;padding:20px;color:#0f172a}
    h2{margin:16px 0 8px}
    .card{border:1px solid var(--border);background:var(--card);border-radius:12px;padding:12px;margin:12px 0;box-shadow:0 6px 24px rgba(15,23,42,.06)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:13px}
    input[type="datetime-local"],input[type="text"],input[type="number"],select{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{padding:8px 12px;border-radius:8px;border:1px solid var(--border);cursor:pointer;background:#fff}
    .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
    .ok{color:#16a34a;font-weight:700}
    .warn{color:#b45309;font-weight:700}

    /* Sorrend ‚Äì a sorsz√°m vizu√°lis, nem a n√©v r√©sze */
    .sortable{list-style:none;padding:0;counter-reset:pos}
    .sortable li{position:relative;padding:10px 10px 10px 38px;margin:5px 0;background:#f2f2f2;border:1px solid #ccc;border-radius:8px;cursor:grab}
    .sortable li.dragging{opacity:.5}
    .sortable li::before{counter-increment:pos;content: counter(pos) ". ";position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted)}

    /* Sz≈±r≈ës√°v a meccslist√°hoz */
    .filterbar{display:flex;gap:8px;align-items:center;margin:8px 0}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, Timestamp, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain:"tippliga-4b3af.firebaseapp.com", projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com", messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const teams = ["Debreceni VSC","Di√≥sgy≈ëri VTK","Ferencv√°ros","ETO FC Gy≈ër","Kazincbarcikai SC","Kisv√°rda FC","MTK Budapest","Ny√≠regyh√°za Spartacus","Paksi FC","Pusk√°s Akad√©mia","√öjpest FC","Zalaegerszegi TE FC"];

    function parseOutcome(result){
      const [home, away] = result.split("-").map(x=>parseInt(x.trim()));
      if(isNaN(home)||isNaN(away)) return "";
      if(home>away) return "1"; if(home<away) return "2"; return "X";
    }
    // " 12. Ferencv√°ros" -> "Ferencv√°ros"
    const stripNumPrefix = s => (s||'').replace(/^\s*\d+[\.\)]?\s*/, '');

    onAuthStateChanged(auth, async (user) => {
      if(!user){ document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return; }
      const userSnap = await getDoc(doc(db, "users", user.email));
      if(!userSnap.exists() || (userSnap.data().role !== "admin")){
        document.body.innerHTML = "<h2>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return;
      }
      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
      await loadPositionsLock();
      await loadOfficialOrder();
    });

    function initUI(){
      const formSection = document.createElement('section');
      const options = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
      formSection.innerHTML = `
        <h2>√öj meccs hozz√°ad√°sa</h2>
        <form id="matchForm" class="card">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${options}</select>
            <select id="awayTeam" required><option value="">Vend√©g csapat</option>${options}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Fordul√≥ ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn-primary">Ment√©s</button>
          </div>
        </form>`;

      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = "üìÇ Felt√∂lt√∂tt meccsek megjelen√≠t√©se/elrejt√©se";
      toggleBtn.onclick = ()=>{ const l=document.getElementById('matchesWrap'); l.style.display = l.style.display==='none' ? 'block' : 'none' };

      const matchesWrap = document.createElement('div');
      matchesWrap.id = 'matchesWrap';
      matchesWrap.style.display = 'none';
      matchesWrap.innerHTML = `
        <h2>Felt√∂lt√∂tt meccsek</h2>
        <div class="card">
          <div class="filterbar">
            <select id="filterRound"><option value="">√ñsszes fordul√≥</option></select>
            <input id="filterTeam" placeholder="Csapat sz≈±r√©s (pl. Fradi)" />
            <button id="applyFilters">Sz≈±r√©s</button>
            <button id="resetFilters">T√∂rl√©s</button>
          </div>
          <div id="matchesList"></div>
        </div>`;

      const resultSection = document.createElement('section');
      resultSection.innerHTML = `
        <h2>Meccseredm√©nyek kezel√©se</h2>
        <div id="matchesNoResult" class="card">
          <h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3>
          <div id="noResultContent"></div>
        </div>
        <div id="matchesWithResult" class="card">
          <h3 id="withResultHeader" style="cursor:pointer">üü¢ R√∂gz√≠tett eredm√©nyek</h3>
          <div id="withResultContent" style="display:none;"></div>
        </div>`;

      const userSection = document.createElement('section');
      userSection.innerHTML = `
        <h2>Felhaszn√°l√≥k kezel√©se</h2>
        <ul id="userList" class="card" style="margin-top:8px;"></ul>`;

      const tableImageSection = document.createElement('section');
      tableImageSection.innerHTML = `
        <h2>NB1 tabella k√©p felt√∂lt√©se</h2>
        <div class="card">
          <input type="file" id="tableImageInput" accept="image/*">
          <button id="uploadTableImage" class="btn-primary">Felt√∂lt√©s</button>
          <div style="margin-top:10px"><button onclick="window.location.href='dashboard.html'">‚¨ÖÔ∏è Vissza a dashboardra</button></div>
        </div>

        <h2 style="margin-top:18px;">üìä Hivatalos szezon v√©gi sorrend</h2>
        <div class="card">
          <button id="toggleOrder">üìÇ Sorrend szerkeszt√©se/elrejt√©se</button>
          <ul id="sortableList" class="sortable" style="display:none; margin-top:10px;"></ul>
          <button id="saveOrderBtn" style="display:none;" class="btn-primary">üíæ Ment√©s</button>
        </div>

        <h2 style="margin-top:18px;">üîí Poz√≠ci√≥s tipp lez√°r√°s</h2>
        <div class="card" id="lockCard">
          <div class="muted">Itt szab√°lyozhatod, mikort√≥l ne lehessen m√≥dos√≠tani a <strong>Szezon v√©gi poz√≠ci√≥s sorrend</strong> tippet.</div>
          <div class="row" style="margin-top:8px">
            <label><input type="checkbox" id="lockNow"> Azonnali lez√°r√°s</label>
            <span class="muted">vagy</span>
            <label>Automatikus z√°r√°s id≈ëpontja: <input type="datetime-local" id="lockUntil"></label>
          </div>
          <div class="row"><input type="text" id="lockMessage" placeholder="Opcion√°lis √ºzenet a j√°t√©kosoknak" style="flex:1;"></div>
          <div class="row">
            <button id="saveLock" class="btn-primary">Lez√°r√°s be√°ll√≠t√°sa</button>
            <button id="clearLock" class="btn-danger">Lez√°r√°s felold√°sa</button>
            <span id="lockStatus" class="muted"></span>
          </div>
        </div>`;

      document.body.append(formSection, toggleBtn, matchesWrap, resultSection, userSection, tableImageSection);

      document.getElementById('matchForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const startTime = Timestamp.fromDate(new Date(document.getElementById('startTime').value));
        await addDoc(collection(db,'matches'),{
          homeTeam: homeTeam.value,
          awayTeam: awayTeam.value,
          startTime,
          roundId: roundId.value,
          odds: {"1":parseFloat(odds1.value),"X":parseFloat(oddsX.value),"2":parseFloat(odds2.value)}
        });
        alert('Meccs mentve');
        e.target.reset();
        await loadMatches();
        await loadResults();
      });

      document.getElementById('uploadTableImage').addEventListener('click', async ()=>{
        const f=document.getElementById('tableImageInput').files[0];
        if(!f) return alert('V√°lassz ki egy k√©pet!');
        const rd=new FileReader();
        rd.onload=async()=>{
          const b64=rd.result.split(',')[1];
          await setDoc(doc(db,'settings','nbi_table_image'),{ base64:b64 });
          alert('K√©p elmentve Firestore-ba!');
        };
        rd.readAsDataURL(f);
      });

      // R√∂gz√≠tett eredm√©nyek list√°ja lenyithat√≥
      document.getElementById('withResultHeader').onclick = ()=>{
        const c=document.getElementById('withResultContent');
        c.style.display = c.style.display==='none' ? 'block':'none';
      };

      // Sorrend toggle + ment√©s
      const sortableList = document.getElementById('sortableList');
      document.getElementById('toggleOrder').onclick = ()=>{
        const vis = sortableList.style.display==='block';
        sortableList.style.display = vis? 'none':'block';
        document.getElementById('saveOrderBtn').style.display = vis? 'none':'inline-block';
      };
      document.getElementById('saveOrderBtn').onclick = saveOfficialOrder;

      // Meccs sz≈±r√©s gombok
      document.getElementById('applyFilters').onclick = renderMatchesFiltered;
      document.getElementById('resetFilters').onclick = ()=>{ document.getElementById('filterRound').value=''; document.getElementById('filterTeam').value=''; renderMatchesFiltered(); };
    }

    // ===== Meccsek (sz≈±r√©s a kliensen; logika v√°ltozatlan) =====
    let _matchesCache = [];
    async function loadMatches(){
      const container = document.getElementById('matchesList');
      container.innerHTML = '';

      const snap = await getDocs(collection(db,'matches'));
      _matchesCache = [];
      const rounds = new Set();

      snap.forEach(docSnap=>{
        const d=docSnap.data();
        _matchesCache.push({ id:docSnap.id, ...d });
        if(d.roundId!=null) rounds.add(String(d.roundId));
      });

      // kit√∂ltj√ºk a fordul√≥ sz≈±r≈ët
      const fr=document.getElementById('filterRound');
      fr.innerHTML = '<option value="">√ñsszes fordul√≥</option>' + Array.from(rounds).sort((a,b)=>parseInt(a)-parseInt(b)).map(r=>`<option value="${r}">${r}</option>`).join('');

      renderMatchesFiltered();
    }

    function renderMatchesFiltered(){
      const r = document.getElementById('filterRound').value.trim();
      const q = (document.getElementById('filterTeam').value||'').toLowerCase();
      const list = _matchesCache.filter(m=> (!r || String(m.roundId)===r) && (!q || (m.homeTeam||'').toLowerCase().includes(q) || (m.awayTeam||'').toLowerCase().includes(q)) );
      renderMatches(list);
    }

    function renderMatches(list){
      const container = document.getElementById('matchesList');
      container.innerHTML = '';
      if(list.length===0){ container.innerHTML = '<div class="muted">Nincs tal√°lat.</div>'; return }

      list.sort((a,b)=>{
        const ra = (parseInt(a.roundId||0) - parseInt(b.roundId||0)); if(ra) return ra;
        const ta = (a.startTime?.toDate?.()||new Date(0)) - (b.startTime?.toDate?.()||new Date(0)); return ta;
      });

      // k√∂z√∂s datalist a csapatokhoz ‚Äì gyors beg√©pel√©s mellett javaslat
      const dataList = document.createElement('datalist');
      dataList.id = 'teamsList';
      dataList.innerHTML = teams.map(t=>`<option value="${t}">`).join('');
      container.appendChild(dataList);

      list.forEach(d=>{
        const div=document.createElement('div');
        div.className='card';
        div.setAttribute('data-round', d.roundId||'');
        div.setAttribute('data-teams', `${(d.homeTeam||'')} ${(d.awayTeam||'')}`.toLowerCase());
        div.innerHTML = `
          <div class="row">
            <input list="teamsList" value="${d.homeTeam||''}" id="home-${d.id}">
            <input list="teamsList" value="${d.awayTeam||''}" id="away-${d.id}">
            <input type="datetime-local" value="${new Date(d.startTime.toDate()).toISOString().slice(0,16)}" id="start-${d.id}">
            <input value="${d.roundId||''}" id="round-${d.id}">
            <input value="${d.odds?.["1"]??''}" id="odds1-${d.id}">
            <input value="${d.odds?.["X"]??''}" id="oddsX-${d.id}">
            <input value="${d.odds?.["2"]??''}" id="odds2-${d.id}">
            <button class="btn-primary" onclick="updateMatch('${d.id}')">Ment√©s</button>
            <button class="btn-danger" onclick="deleteMatch('${d.id}')">T√∂rl√©s</button>
          </div>`;
        container.appendChild(div);
      });
    }

    async function updateMatch(id){
      const ref = doc(db,'matches',id);
      await updateDoc(ref,{
        homeTeam: document.getElementById(`home-${id}`).value,
        awayTeam: document.getElementById(`away-${id}`).value,
        startTime: Timestamp.fromDate(new Date(document.getElementById(`start-${id}`).value)),
        roundId: document.getElementById(`round-${id}`).value,
        odds: {
          "1": parseFloat(document.getElementById(`odds1-${id}`).value),
          "X": parseFloat(document.getElementById(`oddsX-${id}`).value),
          "2": parseFloat(document.getElementById(`odds2-${id}`).value)
        }
      });
      alert('Mentve');
      await loadMatches();
      await loadResults();
    }

    async function deleteMatch(id){
      if(!confirm('Biztos t√∂r√∂lni akarod?')) return;
      await deleteDoc(doc(db,'matches',id));
      await loadMatches();
      await loadResults();
    }

    // ===== Eredm√©nyek (v√°ltozatlan m≈±k√∂d√©s) =====
    async function loadResults(){
      const noC=document.getElementById('noResultContent');
      const withC=document.getElementById('withResultContent');
      noC.innerHTML=''; withC.innerHTML='';

      const snap = await getDocs(collection(db,'matches'));
      const no=[], yes=[];
      snap.forEach(docSnap=>{ const d=docSnap.data(); const m={ id:docSnap.id, ...d }; if(d.result) yes.push(m); else no.push(m) });
      renderMatchGroup(no, noC, false);
      renderMatchGroup(yes, withC, true);
    }

    function renderMatchGroup(matches, container, hasResult){
      const grouped={};
      matches.forEach(m=>{ const r=m.roundId||'Egy√©b'; (grouped[r]||(grouped[r]=[])).push(m) });
      Object.keys(grouped).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(r=>{
        const title=document.createElement('h4'); title.textContent = `${r}. fordul√≥`; container.appendChild(title);
        grouped[r].forEach(match=>{
          const div=document.createElement('div'); div.className='card';
          const formatted = match.startTime?.toDate?.().toLocaleString('hu-HU')||'';
          div.innerHTML = `<strong>${match.homeTeam} - ${match.awayTeam}</strong><br>Kezd√©s: ${formatted}<br>`;
          const input=document.createElement('input'); input.placeholder='pl. 2-1'; input.value=match.result||''; input.style.width='70px';
          const btn=document.createElement('button'); btn.className='btn-primary'; btn.textContent = hasResult? 'M√≥dos√≠t√°s':'Ment√©s';
          btn.onclick = async ()=>{ const v=input.value.trim(); const oc=parseOutcome(v); if(!oc) return alert('Hib√°s form√°tum. pl. 3-1 vagy 1-1.'); await updateDoc(doc(db,'matches',match.id),{ result:v, outcome:oc }); await loadResults(); };
          div.appendChild(input); div.appendChild(btn); container.appendChild(div);
        });
      });
    }

    // ===== Felhaszn√°l√≥k (v√°ltozatlan m≈±k√∂d√©s) =====
    async function loadUsers(){
      const list=document.getElementById('userList'); list.innerHTML='';
      const snap=await getDocs(collection(db,'users'));
      snap.forEach(docSnap=>{
        const user=docSnap.data();
        const li=document.createElement('li');
        const nick=user.nickname||user.email;
        li.innerHTML = `
          ${nick} (${user.email})<br>
          <select>
            <option value="user" ${user.role==='user'?'selected':''}>User</option>
            <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
          </select>
          <button class="btn-primary save-role">Ment√©s</button>
          <button class="btn-danger delete-user">T√∂rl√©s</button>`;
        const sel=li.querySelector('select');
        li.querySelector('.save-role').onclick = async ()=>{ await updateDoc(doc(db,'users',user.email),{ role: sel.value }); alert('Szerepk√∂r friss√≠tve.'); };
        li.querySelector('.delete-user').onclick = async ()=>{ if(!confirm(`T√∂rl√∂d: ${user.email}? Ez nem t√∂rli a bel√©p√©si fi√≥kot, csak a Firestore-b√≥l.`)) return; await deleteDoc(doc(db,'users',user.email)); await loadUsers(); };
        list.appendChild(li);
      });
    }

    // ===== Poz√≠ci√≥s tipp lez√°r√°s (v√°ltozatlan) =====
    async function loadPositionsLock(){
      const status=document.getElementById('lockStatus');
      const snap=await getDoc(doc(db,'settings','positionsLock'));
      if(!snap.exists()){ status.textContent='Jelenleg nyitva.'; status.className='muted'; return }
      const d=snap.data()||{}; const isLocked=!!d.isLocked; const until=d.lockUntil?.toDate?.()||null; const msg=d.message||''; const now=new Date(); const timeLocked=until && now>=until;
      if(isLocked || timeLocked){ status.textContent = `Z√ÅRVA ${timeLocked&&until?`(hat√°rid≈ë: ${until.toLocaleString('hu-HU')})`:'(azonnali z√°r√°s)'}${msg?` ‚Äì ${msg}`:''}`; status.className='warn' } else { status.textContent='Jelenleg nyitva.'; status.className='ok' }
    }
    async function saveLock(){
      const lockNow=document.getElementById('lockNow').checked; const untilStr=document.getElementById('lockUntil').value; const message=document.getElementById('lockMessage').value.trim();
      let docObj={ isLocked:!!lockNow, message: message||'' };
      if(untilStr){ const dt=new Date(untilStr); if(isNaN(+dt)) return alert('Hib√°s d√°tum/id≈ë.'); docObj.lockUntil = Timestamp.fromDate(dt) } else { docObj.lockUntil = null }
      await setDoc(doc(db,'settings','positionsLock'), docObj);
      alert('Lez√°r√°s be√°ll√≠tva.');
      await loadPositionsLock();
    }
    async function clearLock(){ await setDoc(doc(db,'settings','positionsLock'),{ isLocked:false, lockUntil:null, message:'' }); alert('Lez√°r√°s feloldva.'); await loadPositionsLock(); }

    // ===== Hivatalos sorrend (alapelv v√°ltoztat√°sa n√©lk√ºl) =====
    async function loadOfficialOrder(){
      const ref=doc(db,'finalStandings','official');
      const listEl=document.getElementById('sortableList');
      listEl.innerHTML='';
      const snap=await getDoc(ref);
      const source = snap.exists() && Array.isArray(snap.data().teams) ? snap.data().teams : teams;
      const arr = source.map(stripNumPrefix); // csak megjelen√≠t√©shez is lecsupasz√≠tjuk
      let dragged=null;
      arr.forEach(team=>{
        const li=document.createElement('li'); li.textContent=team; li.draggable=true;
        li.addEventListener('dragstart',()=>{ dragged=li; li.classList.add('dragging') });
        li.addEventListener('dragend',()=>{ dragged=null; li.classList.remove('dragging') });
        li.addEventListener('dragover',(e)=>{ e.preventDefault(); const r=li.getBoundingClientRect(); const after=(e.clientY - (r.top + r.height/2))>0; const p=li.parentNode; p.insertBefore(dragged, after? li.nextSibling: li); });
        listEl.appendChild(li);
      });
    }

    async function saveOfficialOrder(){
      const list=[...document.querySelectorAll('#sortableList li')].map(li=> stripNumPrefix(li.textContent.trim()));
      await setDoc(doc(db,'finalStandings','official'),{ teams:list, positions:list.map((t,i)=>({ team:t, position:i+1 })) });
      alert('Sorrend elmentve.');
    }

    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;
    window.saveLock = saveLock;
    window.clearLock = clearLock;
  </script>
</head>
<body></body>
</html>
