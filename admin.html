<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Admin felület</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc,
      doc, Timestamp, query, orderBy, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const teams = [
      "Debreceni VSC", "Diósgyőri VTK", "Ferencváros", "ETO FC Győr",
      "Kazincbarcikai SC", "Kisvárda FC", "MTK Budapest", "Nyíregyháza Spartacus",
      "Paksi FC", "Puskás Akadémia", "Újpest FC", "Zalaegerszegi TE FC"
    ];

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      const userDoc = await getDoc(doc(db, "users", user.uid));
      const role = userDoc.exists() ? userDoc.data().role : "user";
      if (role !== "admin") {
        alert("Nincs jogosultságod az admin felülethez.");
        window.location.href = "dashboard.html";
      }
      document.getElementById("welcome").textContent = `Bejelentkezve: ${user.email}`;

      renderMatches();
      renderUsers();
      renderResults();
      loadNB1Image();
    });

    async function renderMatches() {
      const container = document.getElementById("matchList");
      container.innerHTML = "";
      const q = query(collection(db, "matches"), orderBy("startTime"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.innerHTML = `
          <strong>${data.homeTeam} - ${data.awayTeam}</strong> (${data.round})<br>
          ${new Date(data.startTime.seconds * 1000).toLocaleString()}<br>
          Odds: ${data.odds1}/${data.oddsX}/${data.odds2}<br>
          <button onclick="editMatch('${docSnap.id}')">Szerkesztés</button>
          <button onclick="deleteMatch('${docSnap.id}')">Törlés</button>
          <hr>
        `;
        container.appendChild(div);
      });
    }

    async function renderUsers() {
      const container = document.getElementById("userList");
      container.innerHTML = "";
      const snapshot = await getDocs(collection(db, "users"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.textContent = `${data.nickname || docSnap.id} (${data.role})`;
        container.appendChild(div);
      });
    }

    async function renderResults() {
      const container = document.getElementById("resultList");
      container.innerHTML = "";
      const q = query(collection(db, "matches"), orderBy("round"));
      const snapshot = await getDocs(q);
      const grouped = {};
      snapshot.forEach(docSnap => {
        const match = docSnap.data();
        const now = Timestamp.now();
        if (match.startTime && match.startTime.seconds <= now.seconds) {
          if (!grouped[match.round]) grouped[match.round] = [];
          grouped[match.round].push({ id: docSnap.id, ...match });
        }
      });
      Object.keys(grouped).forEach(round => {
        const section = document.createElement("div");
        section.innerHTML = `<h3>${round}. forduló</h3>`;
        grouped[round].forEach(match => {
          const div = document.createElement("div");
          div.innerHTML = `
            <strong>${match.homeTeam} - ${match.awayTeam}</strong><br>
            Eredmény: <input type="text" id="result-${match.id}" value="${match.result || ''}" placeholder="pl. 2-1">
            <button onclick="saveResult('${match.id}')">Mentés</button>
            <hr>
          `;
          section.appendChild(div);
        });
        container.appendChild(section);
      });
    }

    window.saveResult = async function(id) {
      const result = document.getElementById(`result-${id}`).value.trim();
      if (result) {
        await updateDoc(doc(db, "matches", id), { result });
        alert("Eredmény elmentve");
      }
    };

    window.editMatch = async function(id) {
      // implementálható külön, ha kell
    }

    window.deleteMatch = async function(id) {
      if (confirm("Biztosan törlöd?")) {
        await deleteDoc(doc(db, "matches", id));
        renderMatches();
        renderResults();
      }
    }

    async function loadNB1Image() {
      const docSnap = await getDoc(doc(db, "settings", "nbi_table_image"));
      if (docSnap.exists()) {
        const base64 = docSnap.data().base64;
        document.getElementById("nb1Table").innerHTML = `<img src="data:image/png;base64,${base64}" style="max-width:100%">`;
      }
    }
  </script>
</head>
<body>
  <h1>Admin felület</h1>
  <p id="welcome"></p>

  <h2>Meccsek hozzáadása</h2>
  <form id="matchForm">
    <!-- Ide jön a meccsfeltöltő rész -->
  </form>
  <div id="matchList"></div>

  <h2>Eredmények rögzítése</h2>
  <div id="resultList"></div>

  <h2>Felhasználók</h2>
  <div id="userList"></div>

  <h2>NB1 tabella képként</h2>
  <div id="nb1Table"></div>
</body>
</html>
