<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Admin felület</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.firebasestorage.app",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.innerHTML = "<h2>Be kell jelentkezned.</h2>";
        return;
      }

      const userDoc = await getDocs(collection(db, "users"));
      let isAdmin = false;
      userDoc.forEach(docu => {
        const data = docu.data();
        if (docu.id === user.uid && data.role === "admin") {
          isAdmin = true;
        }
      });

      if (!isAdmin) {
        document.body.innerHTML = "<h2>⛔ Nincs jogosultságod az admin felülethez.</h2>";
        return;
      }

      renderAdminPage();
    });

    async function renderAdminPage() {
      const form = document.createElement("form");
      form.innerHTML = `
        <h1>Meccs hozzáadása</h1>
        <label>Hazai csapat: <input type="text" id="homeTeam" required></label>
        <label>Vendég csapat: <input type="text" id="awayTeam" required></label>
        <label>Kezdés időpontja: <input type="datetime-local" id="startTime" required></label>
        <label>Forduló ID (pl. round1): <input type="text" id="roundId" required></label>
        <label>Odds 1: <input type="number" step="0.01" id="odds1" required></label>
        <label>Odds X: <input type="number" step="0.01" id="oddsX" required></label>
        <label>Odds 2: <input type="number" step="0.01" id="odds2" required></label>
        <button type="submit">Meccs mentése</button>
      `;
      document.body.appendChild(form);

      form.onsubmit = async (e) => {
        e.preventDefault();
        const homeTeam = document.getElementById("homeTeam").value;
        const awayTeam = document.getElementById("awayTeam").value;
        const startTime = Timestamp.fromDate(new Date(document.getElementById("startTime").value));
        const roundId = document.getElementById("roundId").value;
        const odds1 = parseFloat(document.getElementById("odds1").value);
        const oddsX = parseFloat(document.getElementById("oddsX").value);
        const odds2 = parseFloat(document.getElementById("odds2").value);

        await addDoc(collection(db, "matches"), {
          homeTeam, awayTeam, startTime, roundId,
          odds: { "1": odds1, "X": oddsX, "2": odds2 }
        });

        alert("✅ Meccs elmentve!");
        form.reset();
        loadMatches();
      };

      const toggleBtn = document.createElement("button");
      toggleBtn.textContent = "Feltöltött meccsek megjelenítése/elrejtése";
      toggleBtn.className = "toggle-btn";
      document.body.appendChild(toggleBtn);

      const matchesDiv = document.createElement("div");
      matchesDiv.id = "matchesDiv";
      matchesDiv.classList.add("hidden");
      document.body.appendChild(matchesDiv);

      toggleBtn.onclick = () => {
        matchesDiv.classList.toggle("hidden");
      };

      async function loadMatches() {
        matchesDiv.innerHTML = `<h2 class="section-header">Feltöltött meccsek</h2>`;
        const snapshot = await getDocs(collection(db, "matches"));
        snapshot.forEach((docSnap) => {
          const m = docSnap.data();
          const div = document.createElement("div");
          div.className = "match-card";
          div.innerHTML = `
            <strong>${m.homeTeam} vs ${m.awayTeam}</strong><br>
            Kezdés: ${m.startTime.toDate().toLocaleString("hu-HU")}<br>
            Forduló: ${m.roundId}<br>
            Oddsok: 1 - ${m.odds["1"]}, X - ${m.odds["X"]}, 2 - ${m.odds["2"]}<br><br>
            <button onclick="editMatch('${docSnap.id}')">Szerkesztés</button>
            <button onclick="deleteMatch('${docSnap.id}')">Törlés</button>
          `;
          matchesDiv.appendChild(div);
        });
      }

      window.deleteMatch = async (id) => {
        await deleteDoc(doc(db, "matches", id));
        alert("❌ Meccs törölve!");
        loadMatches();
      };

      window.editMatch = async (id) => {
        alert("A szerkesztés funkciót hamarosan kibővítjük egy külön ablakos megoldással.");
      };

      loadMatches();
    }
  </script>
</head>
<body>
</body>
</html>
