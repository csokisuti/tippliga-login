<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Admin felület</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Admin felület</h2>
  <div class="admin-section">
    <h3>Meccsek hozzáadása</h3>
    <div id="match-form-container"></div>
  </div>
  <div class="admin-section">
    <h3>Eredmények rögzítése</h3>
    <div id="results-container"></div>
  </div>
  <div class="admin-section">
    <h3>Felhasználók</h3>
    <div id="users-container"></div>
  </div>
  <div class="admin-section">
    <h3>NB1 tabella képként</h3>
    <input type="file" id="imageUpload" accept="image/*">
    <div id="imagePreviewContainer"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      doc,
      updateDoc,
      deleteDoc,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const matchFormContainer = document.getElementById("match-form-container");
    const resultsContainer = document.getElementById("results-container");
    const usersContainer = document.getElementById("users-container");
    const imageUpload = document.getElementById("imageUpload");
    const imagePreviewContainer = document.getElementById("imagePreviewContainer");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const userDoc = await getDoc(doc(db, "users", user.uid));
      const userData = userDoc.data();
      if (!userData || userData.role !== "admin") {
        alert("Nincs jogosultságod az admin felülethez.");
        window.location.href = "dashboard.html";
        return;
      }

      // MECCS FELTÖLTÉS
      matchFormContainer.innerHTML = `
        <form id="matchForm">
          <input type="text" id="homeTeam" placeholder="Hazai csapat" required>
          <input type="text" id="awayTeam" placeholder="Vendég csapat" required>
          <input type="number" step="0.1" id="odds1" placeholder="Odds 1" required>
          <input type="number" step="0.1" id="oddsX" placeholder="Odds X" required>
          <input type="number" step="0.1" id="odds2" placeholder="Odds 2" required>
          <input type="datetime-local" id="startTime" required>
          <input type="text" id="roundId" placeholder="Forduló ID" required>
          <button type="submit">Meccs hozzáadása</button>
        </form>
      `;

      document.getElementById("matchForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        await addDoc(collection(db, "matches"), {
          homeTeam: document.getElementById("homeTeam").value,
          awayTeam: document.getElementById("awayTeam").value,
          odds: {
            "1": parseFloat(document.getElementById("odds1").value),
            X: parseFloat(document.getElementById("oddsX").value),
            "2": parseFloat(document.getElementById("odds2").value)
          },
          startTime: new Date(document.getElementById("startTime").value),
          roundId: document.getElementById("roundId").value
        });
        alert("Meccs hozzáadva!");
        window.location.reload();
      });

      // EREDMÉNY RÖGZÍTÉS
      const matchesSnapshot = await getDocs(collection(db, "matches"));
      const matches = matchesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      resultsContainer.innerHTML = "";
      matches.forEach(match => {
        const div = document.createElement("div");
        div.innerHTML = `
          <strong>${match.homeTeam} - ${match.awayTeam}</strong><br>
          <input type="text" placeholder="Eredmény pl: 2-1" id="result-${match.id}" value="${match.result || ''}">
          <button data-id="${match.id}">Mentés</button>
        `;
        resultsContainer.appendChild(div);
      });

      resultsContainer.addEventListener("click", async (e) => {
        if (e.target.tagName === "BUTTON") {
          const matchId = e.target.dataset.id;
          const result = document.getElementById(`result-${matchId}`).value;
          const [homeGoals, awayGoals] = result.split("-").map(x => parseInt(x.trim()));
          let outcome = "X";
          if (homeGoals > awayGoals) outcome = "1";
          else if (homeGoals < awayGoals) outcome = "2";
          await updateDoc(doc(db, "matches", matchId), {
            result,
            outcome
          });
          alert("Eredmény mentve.");
        }
      });

      // FELHASZNÁLÓKEZELÉS
      usersContainer.innerHTML = `
        <form id="userForm">
          <input type="email" id="userEmail" placeholder="Email" required>
          <input type="text" id="nickname" placeholder="Becenév" required>
          <input type="password" id="userPassword" placeholder="Jelszó" required>
          <button type="submit">Felhasználó létrehozása</button>
        </form>
      `;

      document.getElementById("userForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("userEmail").value;
        const password = document.getElementById("userPassword").value;
        const nickname = document.getElementById("nickname").value;
        const currentUser = auth.currentUser;

        try {
          const newUser = await createUserWithEmailAndPassword(auth, email, password);
          await setDoc(doc(db, "users", newUser.user.uid), {
            email,
            role: "user",
            nickname
          });
          await signInWithEmailAndPassword(auth, currentUser.email, prompt("Admin jelszó újra:"));
          alert("Felhasználó létrehozva!");
        } catch (err) {
          alert("Hiba: " + err.message);
        }
      });

      // TABELLAFOTÓ FELTÖLTÉS
      imageUpload.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onloadend = async () => {
          const base64 = reader.result;
          await setDoc(doc(db, "settings", "nb1_table_image"), { base64 });
          alert("Kép feltöltve!");
        };
        reader.readAsDataURL(file);
      });
    });
  </script>
</body>
</html>
