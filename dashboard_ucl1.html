<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL TippLiga</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="fav2.png" sizes="16x16">
  <link rel="icon" type="image/png" href="fav2.png" sizes="32x32">
  <link rel="icon" type="image/png" href="fav2.png">
  <script src="loader.js" defer></script>

  <style>
    .layout{display:flex;flex-direction:column;gap:16px;max-width:1200px;margin:0 auto;padding:20px}
    .content-grid{display:grid;grid-template-columns:1.2fr 1fr;gap:16px}
    .card{background:#fff;border-radius:16px;border:1px solid var(--line,#e6eaf1);box-shadow:0 10px 30px rgba(15,23,42,.08);padding:16px;position:relative;overflow:hidden}
    .card h3{margin:0 0 10px;font-size:16px;display:flex;align-items:center;gap:8px}
    .card h3 svg{width:18px;height:18px;color:#0f172a}
    .hero{display:flex;flex-direction:column;gap:12px;padding:18px 16px;border-radius:16px;background:radial-gradient(circle at 0 0,#22d3ee33 0,#0f172a 45%,#020617 100%);color:#e5e7eb;position:relative;overflow:hidden}
    .hero-main{display:flex;justify-content:space-between;gap:16px}
    .hero-left h1{margin:0;font-size:20px;letter-spacing:0.02em}
    .hero-left p{margin:4px 0 0;font-size:13px;color:#e5e7ebcc}
    .hero-badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .hero-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.6);font-size:11px}
    .hero-badge svg{width:14px;height:14px}
    .hero-right{display:flex;flex-direction:column;align-items:flex-end;justify-content:space-between;gap:10px;min-width:160px}
    .hero-team{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.5)}
    .hero-team-logo{width:28px;height:28px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .hero-team-logo img{width:100%;height:100%;object-fit:contain}
    .hero-team-text{display:flex;flex-direction:column}
    .hero-team-name{font-size:13px;font-weight:600}
    .hero-team-sub{font-size:11px;color:#cbd5f5}
    .hero-pill{font-size:11px;border-radius:999px;padding:3px 8px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.85);display:inline-flex;align-items:center;gap:4px}
    .hero-pill svg{width:12px;height:12px}
    .hero-bg-ball{position:absolute;right:-40px;bottom:-40px;width:160px;height:160px;opacity:.12;filter:drop-shadow(0 0 40px rgba(56,189,248,.8))}
    .hero-bg-ball svg{width:100%;height:100%}
    .nav-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .nav-card{display:flex;align-items:flex-start;gap:10px;padding:10px 10px;border-radius:12px;border:1px solid var(--line,#e6eaf1);background:#fff;cursor:pointer;text-decoration:none;color:inherit;transition:.16s ease box-shadow,.16s ease transform,.16s ease border-color}
    .nav-card:hover{box-shadow:0 10px 26px rgba(15,23,42,.12);transform:translateY(-1px);border-color:#0ea5e9}
    .nav-icon{width:26px;height:26px;border-radius:999px;display:flex;align-items:center;justify-content:center;background:#eff6ff;color:#1d4ed8;flex-shrink:0}
    .nav-card.matches .nav-icon{background:#ecfeff;color:#0891b2}
    .nav-card.old .nav-icon{background:#fefce8;color:#ca8a04}
    .nav-card.points .nav-icon{background:#f5f3ff;color:#7c3aed}
    .nav-card.admin .nav-icon{background:#fef2f2;color:#b91c1c}
    .nav-icon svg{width:16px;height:16px}
    .nav-card .text{display:flex;flex-direction:column;gap:2px}
    .nav-card .title{font-size:13px;font-weight:600}
    .nav-card .desc{font-size:11px;color:#64748b}
    .table-wrap{overflow:auto}
    .pill-badge{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 5px;border-radius:999px;background:#e11d48;color:#fff;font-size:12px;font-weight:700;line-height:1;vertical-align:middle}
    .pill-badge[hidden]{display:none!important}
    .pill-badge.countdown{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-variant-numeric:tabular-nums;letter-spacing:.2px}
    .pill-badge.countdown.urgent{animation:pulse 1s ease-in-out infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
    .blink{animation:blink 1s steps(2,start) infinite}
    @keyframes blink{to{opacity:.2}}
    .fb-wrap iframe{width:100%;height:540px;border:0;overflow:hidden}
    .chat-fab{position:fixed;right:22px;bottom:22px;z-index:999;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 8px 26px rgba(0,0,0,.15)}
    .chat-fab .fab-badge{position:absolute;top:-4px;right:-4px;margin:0;width:20px;height:20px;border-radius:999px;background:#ef4444;color:#fff;font-size:12px;font-weight:800;line-height:20px;display:none}
    .chat-fab.has-unread .fab-badge{display:inline-block}
    .chat-panel{position:fixed;right:22px;bottom:86px;z-index:999;display:none;flex-direction:column;width:320px;max-height:440px;background:#0b1120;color:#e5e7eb;border-radius:14px;box-shadow:0 10px 32px rgba(0,0,0,.14)}
    .chat-panel.open{display:flex}
    .chat-panel-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f2937;background:linear-gradient(120deg,#0f172a,#020617)}
    .chat-panel-head span{font-size:13px;font-weight:600}
    .chat-panel-body{flex:1;overflow:auto;padding:10px 12px;display:flex;flex-direction:column;gap:6px;font-size:12px}
    .chat-msg{padding:6px 8px;border-radius:10px;max-width:88%}
    .chat-msg.me{align-self:flex-end;background:#0369a1}
    .chat-msg.other{align-self:flex-start;background:#111827}
    .chat-meta{font-size:10px;color:#9ca3af;margin-top:2px}
    .chat-input{display:flex;gap:6px;padding:8px 10px;border-top:1px solid #1f2937;background:#020617}
    .chat-input textarea{flex:1;resize:none;border-radius:10px;border:1px solid #1f2937;background:#020617;color:#e5e7eb;padding:6px 8px;font-size:12px;min-height:34px;max-height:80px}
    .chat-input button{border-radius:10px;border:none;background:#22c55e;color:#022c22;font-size:13px;font-weight:600;padding:6px 10px;display:inline-flex;align-items:center;gap:4px;cursor:pointer}
    .chat-input button svg{width:14px;height:14px}
    .chat-tagline{font-size:10px;color:#6b7280;margin-top:4px;text-align:right;padding:0 10px 6px}
    .nav-top8{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:#64748b}
    .nav-top8 .pill-badge{background:#0ea5e9}
    .nav-top8 .pill-badge.urgent{background:#b91c1c}
    .nav-top8 .pill-badge.disabled{background:#9ca3af}
    .nav-top8 .label{display:inline-flex;align-items:center;gap:4px}
    .nav-top8 svg{width:13px;height:13px}

    /* BL kieséses ágrajz */
    .bracket-card{margin-top:12px}
    .bracket-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;overflow-x:auto}
    .bracket-round{display:flex;flex-direction:column;gap:8px}
    .bracket-round-title{font-size:13px;font-weight:600;margin-bottom:4px;color:var(--muted,#64748b)}
    .bracket-tie{border-radius:10px;border:1px solid var(--line,#e6eaf1);background:#ffffff;padding:6px 8px;box-shadow:0 1px 2px rgba(15,23,42,.08)}
    .bracket-team{display:flex;align-items:center;justify-content:space-between;gap:6px;font-size:13px}
    .bracket-team-name{display:flex;align-items:center;gap:6px;max-width:150px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bracket-team img{width:18px;height:18px;border-radius:999px;border:1px solid var(--line,#e6eaf1);background:#fff}
    .bracket-score{font-variant-numeric:tabular-nums;font-size:13px}
    .bracket-meta{margin-top:4px;font-size:11px;color:var(--muted,#64748b);display:flex;justify-content:space-between;align-items:center;gap:6px}
    .bracket-pill{border-radius:999px;padding:2px 6px;border:1px solid var(--line,#e6eaf1);background:#f9fafb;font-size:10px;white-space:nowrap}
    .bracket-pen{font-size:10px;font-weight:600;color:#b91c1c}

    @media (max-width:960px){
      .content-grid{grid-template-columns:1fr}
      .hero-main{flex-direction:column;align-items:flex-start}
      .hero-right{align-items:flex-start}
      .nav-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width:640px){
      .layout{padding:12px}
      .nav-grid{grid-template-columns:1fr}
      .hero{padding:14px 12px}
    }
  </style>
</head>
<body>
  <div class="layout">
    <section class="hero">
      <div class="hero-main">
        <div class="hero-left">
          <h1>BL TippLiga – dashboard</h1>
          <p>Állás, kedvenc csapatod hírei és közös chat egy helyen.</p>
          <div class="hero-badges">
            <span class="hero-badge">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16v4H4zM4 10h16v10H4z"/>
                <path d="M10 14h4M10 17h4"/>
              </svg>
              <span>Élő BL tabella</span>
            </span>
            <span class="hero-badge" id="top8Badge">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 20v-6M8 20V10M16 20V4"/>
              </svg>
              <span>Top8 / győztes / gólkirály tippek</span>
            </span>
            <span class="hero-badge">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <path d="M5 5v14l7-4 7 4V5z"/>
              </svg>
              <span>Közös BL chat</span>
            </span>
          </div>
        </div>
        <div class="hero-right">
          <div class="hero-team">
            <div class="hero-team-logo" id="favTeamLogo">
              <img id="favTeamLogoImg" src="" alt="" style="display:none">
              <span id="favTeamLogoPlaceholder">?</span>
            </div>
            <div class="hero-team-text">
              <span class="hero-team-name" id="favTeamName">Nincs kedvenc beállítva</span>
              <span class="hero-team-sub">Profil / BL fül alatt tudod módosítani</span>
            </div>
          </div>
          <div class="hero-pill" id="leagueSwitchMount">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 12h16M4 6h16M4 18h16"/>
            </svg>
            <span>NB I. / BL váltás</span>
          </div>
        </div>
      </div>
      <div class="hero-bg-ball" aria-hidden="true">
        <svg viewBox="0 0 64 64">
          <defs>
            <radialGradient id="g1" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(16 10) rotate(45) scale(40)">
              <stop stop-color="#22d3ee"/>
              <stop offset="1" stop-color="#0ea5e9" stop-opacity="0"/>
            </radialGradient>
          </defs>
          <circle cx="32" cy="32" r="26" fill="url(#g1)" stroke="#22d3ee" stroke-width="1.4"/>
          <path d="M32 8 24 20l8 6 8-6-8-12Zm0 48 8-12-8-6-8 6 8 12Zm-21-26 12-2 4 8-6 8-10-4 0-10Zm42 0-12-2-4 8 6 8 10-4 0-10Z" fill="none" stroke="#e5e7eb" stroke-width="1.1"/>
        </svg>
      </div>
    </section>

    <nav class="nav-grid">
      <a href="matches_ucl.html" class="nav-card matches" id="matchesCard">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="16" rx="2"/>
            <path d="M3 10h18M8 2v4M16 2v4M9 16h6"/>
          </svg>
        </div>
        <div class="text">
          <span class="title">Meccstippek</span>
          <span class="desc">Hátralévő BL forduló(k) – 1X2 + duplázás</span>
        </div>
        <span class="pill-badge" id="tipsBadgeUcl" hidden>!</span>
      </a>

      <a href="old_matches_ucl.html" class="nav-card old">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 8v5l3 2"/>
            <circle cx="12" cy="12" r="9"/>
          </svg>
        </div>
        <div class="text">
          <span class="title">Lezárt meccsek</span>
          <span class="desc">Eredmények, szerzett pontok, statisztikák</span>
        </div>
      </a>

      <a href="leaderboard_ucl.html" class="nav-card points">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <path d="M8 21V10M12 21V3M16 21v-6"/>
            <path d="M4 21h16"/>
          </svg>
        </div>
        <div class="text">
          <span class="title">Ponttábla</span>
          <span class="desc">Összesített TippLiga állás</span>
        </div>
      </a>

      <a href="admin_ucl.html" class="nav-card admin">
        <div class="nav-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/>
            <path d="M19.4 15a1.78 1.78 0 0 0 .35 1.94l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.78 1.78 0 0 0-1.94-.35 1.78 1.78 0 0 0-1.06 1.64V22a2 2 0 0 1-4 0v-.09A1.78 1.78 0 0 0 8 20.27a1.78 1.78 0 0 0-1.94.35l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.78 1.78 0 0 0 3.73 15a1.78 1.78 0 0 0-1.64-1.06H2a2 2 0 0 1 0-4h.09A1.78 1.78 0 0 0 3.73 8a1.78 1.78 0 0 0-.35-1.94l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.78 1.78 0 0 0 8 3.73 1.78 1.78 0 0 0 9.06 2.09V2a2 2 0 0 1 4 0v.09A1.78 1.78 0 0 0 15 3.73a1.78 1.78 0 0 0 1.94-.35l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.78 1.78 0 0 0 20.27 8a1.78 1.78 0 0 0 1.64 1.06H22a2 2 0 0 1 0 4h-.09A1.78 1.78 0 0 0 19.4 15Z"/>
          </svg>
        </div>
        <div class="text">
          <span class="title">Admin</span>
          <span class="desc">Szezon-zár & beállítások</span>
        </div>
      </a>
    </nav>

    <section class="card bracket-card">
      <h3>BL kieséses ágrajz</h3>
      <div id="bracketContainer" class="bracket-grid"></div>
    </section>

    <div class="content-grid">
      <section class="card table-wrap">
        <h3>BL tabella</h3>
        <div id="tableContainer"></div>
      </section>
      <section class="card">
        <h3>Csapatod hírei</h3>
        <div id="facebookFeedContainer"></div>
      </section>
  
    </div>
  </div>

  <button class="chat-fab" id="chatFab" aria-label="BL chat megnyitása">
    <span class="fab-badge" id="chatUnreadBadge">!</span>
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5A8.48 8.48 0 0 1 21 11v.5z"/>
    </svg>
  </button>

  <div class="chat-panel" id="chatPanel" aria-hidden="true">
    <div class="chat-panel-head">
      <span>BL TippLiga chat</span>
      <button id="chatCloseBtn" class="btn" style="padding:4px 8px;font-size:11px;border-radius:999px;border:1px solid #374151;background:#020617;color:#e5e7eb">
        Bezár
      </button>
    </div>
    <div class="chat-panel-body" id="chatMessages"></div>
    <div class="chat-input">
      <textarea id="chatInput" rows="1" placeholder="Írj üzenetet a többieknek…"></textarea>
      <button id="chatSendBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 2 11 13"/>
          <path d="M22 2 15 22 11 13 2 9 22 2z"/>
        </svg>
        Küldés
      </button>
    </div>
    <div class="chat-tagline">A BL TippLiga résztvevőinek közös beszélgetése</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, onSnapshot, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { computeLiveOrderFromMatches } from "./standings.js";
    import { initLeagueSwitcher } from "./league-switcher.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const CHAT_COLLECTION = 'chatMessages_ucl';
    const CHAT_LAST_SEEN_FIELD = 'chatLastSeenUcl';

    const crestMap = {
      "Ajax":"ucl_crest/ajax.png","Arsenal":"ucl_crest/arsenal.png","Atalanta":"ucl_crest/atalanta.png","Athletic Bilbao":"ucl_crest/athletic.png","Atlético Madrid":"ucl_crest/atletico.png","Barcelona":"ucl_crest/barca.png","Bayern München":"ucl_crest/bayern.png","Benfica":"ucl_crest/benfica.png","Borussia Dortmund":"ucl_crest/dortmund.png","Bologna":"ucl_crest/bologna.png","Braga":"ucl_crest/braga.png","Brest":"ucl_crest/brest.png","Celtic":"ucl_crest/celtic.png","Crvena zvezda":"ucl_crest/crvena.png","Dinamo Zagreb":"ucl_crest/dinamo.png","Feyenoord":"ucl_crest/feyenoord.png","Galatasaray":"ucl_crest/gala.png","Girona":"ucl_crest/girona.png","Inter":"ucl_crest/inter.png","Juventus":"ucl_crest/juve.png","Lazio":"ucl_crest/lazio.png","Leverkusen":"ucl_crest/leverkusen.png","Liverpool":"ucl_crest/liverpool.png","Lille":"ucl_crest/lille.png","Milan":"ucl_crest/milan.png","Monaco":"ucl_crest/monaco.png","Newcastle":"ucl_crest/newcastle.png","PSG":"ucl_crest/psg.png","Porto":"ucl_crest/porto.png","PSV":"ucl_crest/psv.png","Real Madrid":"ucl_crest/real.png","Real Sociedad":"ucl_crest/sociedad.png","RB Leipzig":"ucl_crest/rbleipzig.png","Roma":"ucl_crest/roma.png","Salzburg":"ucl_crest/salzburg.png","Shakhtar Donetsk":"ucl_crest/shakhtar.png","Sparta Praha":"ucl_crest/sparta.png","Sporting CP":"ucl_crest/sporting.png","Stuttgart":"ucl_crest/stuttgart.png","Tottenham Hotspur":"ucl_crest/spurs.png","Union Berlin":"ucl_crest/union.png","Villarreal":"ucl_crest/villarreal.png","Young Boys":"ucl_crest/yb.png","Dinamo Tbilisi":"ucl_crest/tbilisi.png","Bodo/Glimt":"ucl_crest/bodo.png","Ludogorec":"ucl_crest/ludogorec.png","Slovan Bratislava":"ucl_crest/slovan.png"
    };

    const facebookLinks = {
      "Barcelona":"https://www.facebook.com/fcbarcelona",
      "Real Madrid":"https://www.facebook.com/RealMadrid",
      "Bayern München":"https://www.facebook.com/fcbayern",
      "Liverpool":"https://www.facebook.com/lfc",
      "PSG":"https://www.facebook.com/PSG",
      "Manchester City":"https://www.facebook.com/mancity",
      "Arsenal":"https://www.facebook.com/Arsenal",
      "Juventus":"https://www.facebook.com/Juventus",
      "Inter":"https://www.facebook.com/Inter",
      "Milan":"https://www.facebook.com/ACMilan"
    };

    let currentUserEmail = null;
    let currentUserNick = null;
    let currentUserRole = null;
    let favouriteTeamucl = null;
    let chatLastSeen = null;
    let chatUnsub = null;

    function parseRes(str){
      const m=String(str||"").match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
      return m?[parseInt(m[1]),parseInt(m[2])]:null;
    }

    async function buildComputedTable(){
      const teams=Object.keys(crestMap);
      const S={}; teams.forEach(t=>S[t]={team:t,MP:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,Pts:0});
      const H2H={};
      const snap=await getDocs(collection(db,"ucl_matches"));
      const matchesForModule=[];

      snap.forEach(d=>{
        const m=d.data()||{};
        const A=m.homeTeam||m.home||"";
        const B=m.awayTeam||m.away||"";
        const roundRaw = m.roundId ?? m.round ?? "";
        const roundNum = parseInt(roundRaw,10);
        const isLeaguePhase = !Number.isFinite(roundNum) || roundNum < 9;
        const r=parseRes(m.result);
        if(isLeaguePhase && A&&B&&m.result) matchesForModule.push({homeTeam:A,awayTeam:B,result:m.result});
        const a=S[A], b=S[B];
        if(!a||!b||!r || !isLeaguePhase) return;
        const [hg,ag]=r;
        a.MP++; b.MP++;
        a.GF+=hg; a.GA+=ag; a.GD=a.GF-a.GA;
        b.GF+=ag; b.GA+=hg; b.GD=b.GF-b.GA;
        if(hg>ag){a.W++;b.L++;a.Pts+=3}
        else if(hg<ag){b.W++;a.L++;b.Pts+=3}
        else{a.D++;b.D++;a.Pts+=1;b.Pts+=1}
        const k=[A,B].slice().sort((x,y)=>x.localeCompare(y,'hu')).join('|');
        H2H[k] ||= {[A]:{Pts:0,GF:0,GA:0},[B]:{Pts:0,GF:0,GA:0}};
        if(hg>ag){H2H[k][A].Pts+=3}
        else if(hg<ag){H2H[k][B].Pts+=3}
        else{H2H[k][A].Pts+=1;H2H[k][B].Pts+=1}
        H2H[k][A].GF+=hg; H2H[k][A].GA+=ag;
        H2H[k][B].GF+=ag; H2H[k][B].GA+=hg;
      });

      function cmp(a,b){
        if(b.Pts!==a.Pts) return b.Pts-a.Pts;
        if(b.W!==a.W) return b.W-a.W;
        if(b.GD!==a.GD) return b.GD-a.GD;
        if(b.GF!==a.GF) return b.GF-a.GF;
        const la=a.team.toLowerCase(), lb=b.team.toLowerCase();
        const key=[a.team,b.team].slice().sort((x,y)=>x.localeCompare(y,'hu')).join('|');
        const h=H2H[key];
        if(h){
          const ha=h[a.team], hb=h[b.team];
          if(ha && hb){
            if(ha.Pts!==hb.Pts) return hb.Pts-ha.Pts;
            const gdA=ha.GF-ha.GA, gdB=hb.GF-hb.GA;
            if(gdA!==gdB) return gdB-gdA;
            if(ha.GF!==hb.GF) return hb.GF-ha.GF;
          }
        }
        return a.team.localeCompare(b.team,'hu');
      }

      const rows=Object.values(S).sort(cmp);
      try{
        const liveOrder=computeLiveOrderFromMatches(matchesForModule,teams);
        window.liveStandingsOrder=liveOrder;
        localStorage.setItem("liveStandingsOrder_ucl",JSON.stringify(liveOrder));
      }catch(e){ console.warn("Live standings (UCL) compute failed:",e); }

      renderComputedTable(rows);
    }

    function renderComputedTable(rows){
      const tableContainer=document.getElementById("tableContainer");
      if(!tableContainer) return;
      const table=document.createElement("table");
      table.style.width="100%";
      table.style.borderCollapse="collapse";
      table.innerHTML=`
        <thead>
          <tr style="font-size:12px;color:#6b7280;border-bottom:1px solid var(--line,#e6eaf1);">
            <th style="text-align:right;padding:8px 10px;width:32px">#</th>
            <th style="text-align:left;padding:8px 10px;">Csapat</th>
            <th style="text-align:right;padding:8px 10px;">M</th>
            <th style="text-align:right;padding:8px 10px;">GY</th>
            <th style="text-align:right;padding:8px 10px;">D</th>
            <th style="text-align:right;padding:8px 10px;">V</th>
            <th style="text-align:right;padding:8px 10px;">LG</th>
            <th style="text-align:right;padding:8px 10px;">KG</th>
            <th style="text-align:right;padding:8px 10px;">GK</th>
            <th style="text-align:right;padding:8px 10px;">P</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i)=>{
            const trClass=i<8?'qual-green':(i>=24&&i<=35?'elim-red':'');
            return `
              <tr class="${trClass}">
                <td style="text-align:right;padding:8px 10px;color:#64748b;">${i+1}.</td>
                <td style="padding:8px 10px;display:flex;align-items:center;gap:8px;">
                  ${crestMap[r.team]?`<img src="${crestMap[r.team]}" alt="" style="width:20px;height:20px;border-radius:999px;border:1px solid var(--line,#e6eaf1);background:#fff;object-fit:contain">`:""}
                  <strong>${r.team}</strong>
                </td>
                <td style="text-align:right;padding:8px 10px;">${r.MP}</td>
                <td style="text-align:right;padding:8px 10px;">${r.W}</td>
                <td style="text-align:right;padding:8px 10px;">${r.D}</td>
                <td style="text-align:right;padding:8px 10px;">${r.L}</td>
                <td style="text-align:right;padding:8px 10px;">${r.GF}</td>
                <td style="text-align:right;padding:8px 10px;">${r.GA}</td>
                <td style="text-align:right;padding:8px 10px;">${r.GD}</td>
                <td style="text-align:right;padding:8px 10px;font-weight:600;">${r.Pts}</td>
              </tr>
            `;
          }).join('')}
        </tbody>
      `;
      tableContainer.innerHTML = '';
      tableContainer.appendChild(table);
    }

    const BRACKET_ROUNDS = [
      {id:"PO",label:"Rájátszás a 16 közé",ties:8},
      {id:"R16",label:"Nyolcaddöntő",ties:8},
      {id:"QF",label:"Negyeddöntő",ties:4},
      {id:"SF",label:"Elődöntő",ties:2},
      {id:"F",label:"Döntő",ties:1}
    ];

    function computeTieScore(tie,matchesById){
      const arr=Array.isArray(tie.matchIds)?tie.matchIds:(tie.matchId?[tie.matchId]:[]);
      if(!arr.length) return null;
      let homeGoals=0, awayGoals=0;
      arr.forEach(id=>{
        const m=matchesById[id];
        if(!m||!m.result) return;
        const res=parseRes(m.result);
        if(!res) return;
        const [gh,ga]=res;
        const mh=m.homeTeam||m.home||"";
        const ma=m.awayTeam||m.away||"";
        const bh=tie.homeTeam||"";
        const ba=tie.awayTeam||"";
        let homeIsBracketHome=true;
        if(bh&&ba){
          if(mh===bh&&ma===ba) homeIsBracketHome=true;
          else if(mh===ba&&ma===bh) homeIsBracketHome=false;
        }
        if(homeIsBracketHome){homeGoals+=gh;awayGoals+=ga}
        else{homeGoals+=ga;awayGoals+=gh}
      });
      if(homeGoals===0&&awayGoals===0) return null;
      let winner="draw";
      if(homeGoals>awayGoals) winner="home";
      else if(awayGoals>homeGoals) winner="away";
      if(tie.penaltyWinner==="home"||tie.penaltyWinner==="away") winner=tie.penaltyWinner;
      return {home:String(homeGoals),away:String(awayGoals),winner};
    }

    function renderBracketTie(tie,matchesById){
      const div=document.createElement("div");
      div.className="bracket-tie";
      const homeName=tie.homeTeam||tie.homeSeedLabel||"–";
      const awayName=tie.awayTeam||tie.awaySeedLabel||"–";
      const homeCrest=crestMap[homeName];
      const awayCrest=crestMap[awayName];

      const top=document.createElement("div");
      top.className="bracket-team";
      top.innerHTML=`
        <div class="bracket-team-name">
          ${homeCrest?`<img src="${homeCrest}" alt="">`:""}
          <span>${homeName}</span>
        </div>
        <div class="bracket-score" data-side="home"></div>
      `;

      const bottom=document.createElement("div");
      bottom.className="bracket-team";
      bottom.innerHTML=`
        <div class="bracket-team-name">
          ${awayCrest?`<img src="${awayCrest}" alt="">`:""}
          <span>${awayName}</span>
        </div>
        <div class="bracket-score" data-side="away"></div>
      `;

      const meta=document.createElement("div");
      meta.className="bracket-meta";

      const left=document.createElement("span");
      if(tie.decidedByPenalties){
        left.className="bracket-pen";
        left.textContent="11-esekkel";
      }else{
        left.textContent="";
      }

      const pill=document.createElement("span");
      pill.className="bracket-pill";
      pill.textContent=tie.label||(tie.index?`${tie.index}. pár`:"");

      const winnerSpan=document.createElement("span");
      winnerSpan.className="bracket-winner";

      meta.appendChild(left);
      meta.appendChild(pill);
      meta.appendChild(winnerSpan);

      div.appendChild(top);
      div.appendChild(bottom);
      div.appendChild(meta);

      const scores=computeTieScore(tie,matchesById);
      if(scores){
        top.querySelector(".bracket-score").textContent=scores.home;
        bottom.querySelector(".bracket-score").textContent=scores.away;
        if(scores.winner==="home") winnerSpan.textContent=homeName;
        else if(scores.winner==="away") winnerSpan.textContent=awayName;
        else winnerSpan.textContent="";
      }

      return div;
    }

    async function loadBracket(){
      const container=document.getElementById("bracketContainer");
      if(!container) return;
      container.innerHTML="";
      const [matchesSnap,bracketSnap]=await Promise.all([
        getDocs(collection(db,"ucl_matches")),
        getDocs(collection(db,"ucl_bracket"))
      ]);

      const matchesById={};
      matchesSnap.forEach(d=>{matchesById[d.id]=d.data()||{};});

      const byRound={};
      bracketSnap.forEach(d=>{
        const data=d.data()||{};
        const r=data.round;
        if(!r) return;
        if(!byRound[r]) byRound[r]=[];
        byRound[r].push(Object.assign({id:d.id},data));
      });

      BRACKET_ROUNDS.forEach(cfg=>{
        const col=document.createElement("div");
        col.className="bracket-round";
        const title=document.createElement("div");
        title.className="bracket-round-title";
        title.textContent=cfg.label;
        col.appendChild(title);
        const arr=(byRound[cfg.id]||[]).slice().sort((a,b)=>(a.index||0)-(b.index||0));
        if(arr.length===0){
          for(let i=1;i<=cfg.ties;i++){
            const placeholder=renderBracketTie({index:i},matchesById);
            col.appendChild(placeholder);
          }
        }else{
          arr.forEach(tie=>{col.appendChild(renderBracketTie(tie,matchesById));});
        }
        container.appendChild(col);
      });
    }

    function startNavTop8Countdown(until){
      const badge=document.getElementById('top8Badge');
      if(!badge) return;
      if(!until){
        badge.innerHTML='<span class="label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l3 3"/></svg><span>Top8 / győztes / gólkirály szerkesztés lezárva</span></span>';
        badge.classList.remove('countdown','urgent');
        return;
      }
      function update(){
        const now=new Date();
        const diff=until-now;
        if(diff<=0){
          badge.innerHTML='<span class="label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l3 3"/></svg><span>Top8 / győztes / gólkirály lezárva</span></span>';
          badge.classList.remove('countdown','urgent');
          return;
        }
        const totalSeconds=Math.floor(diff/1000);
        const h=Math.floor(totalSeconds/3600);
        const m=Math.floor((totalSeconds%3600)/60);
        const s=totalSeconds%60;
        const mm=String(m).padStart(2,'0');
        const ss=String(s).padStart(2,'0');
        badge.innerHTML='<span class="label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l3 3"/></svg><span>Top8 / győztes / gólkirály zárásig: '+h+':'+mm+':'+ss+'</span></span>';
        badge.classList.add('countdown');
        if(diff<3600_000) badge.classList.add('urgent'); else badge.classList.remove('urgent');
        requestAnimationFrame(update);
      }
      update();
    }

    function renderChatMessage(docData, isOwn){
      const div=document.createElement('div');
      div.className='chat-msg '+(isOwn?'me':'other');
      const text=document.createElement('div');
      text.textContent=docData.text||'';
      const meta=document.createElement('div');
      meta.className='chat-meta';
      const nick=docData.nick||docData.user||'';
      let t='';
      try{
        const ts=docData.createdAt?.toDate?.()||null;
        if(ts){
          const hh=String(ts.getHours()).padStart(2,'0');
          const mm=String(ts.getMinutes()).padStart(2,'0');
          t=`${hh}:${mm}`;
        }
      }catch(e){}
      meta.textContent = nick + (t?' • '+t:'');
      div.appendChild(text);
      div.appendChild(meta);
      return div;
    }

    function subscribeChat(){
      const listEl=document.getElementById('chatMessages');
      const badge=document.getElementById('chatUnreadBadge');
      if(!listEl) return;
      if(chatUnsub) chatUnsub();
      const qRef=query(collection(db,CHAT_COLLECTION),orderBy('createdAt','asc'),limit(200));
      chatUnsub=onSnapshot(qRef,snap=>{
        listEl.innerHTML='';
        let lastTs=null;
        snap.forEach(docSnap=>{
          const d=docSnap.data();
          const node=renderChatMessage(d, d.user===currentUserEmail);
          listEl.appendChild(node);
          lastTs=d.createdAt?.toMillis?.()||lastTs;
        });
        listEl.scrollTop=listEl.scrollHeight;
        if(chatLastSeen && lastTs && lastTs>chatLastSeen){
          const panelOpen=document.getElementById('chatPanel')?.classList.contains('open');
          if(!panelOpen){
            const fab=document.getElementById('chatFab');
            if(fab) fab.classList.add('has-unread');
            if(badge) badge.style.display='';
          }
        }
      });
    }

    async function sendChatMessage(){
      const input=document.getElementById('chatInput');
      if(!input) return;
      const text=input.value.trim();
      if(!text) return;
      input.value='';
      try{
        await addDoc(collection(db,CHAT_COLLECTION),{
          text,
          user:currentUserEmail,
          nick:currentUserNick||currentUserEmail,
          createdAt:serverTimestamp()
        });
      }catch(e){
        console.error("chat send failed",e);
      }
    }

    async function markChatSeen(){
      if(!currentUserEmail) return;
      const now=Date.now();
      try{
        await setDoc(doc(db,"users",currentUserEmail),{ [CHAT_LAST_SEEN_FIELD]: now },{ merge:true });
        chatLastSeen=now;
      }catch(e){
        console.warn("chat lastSeen update failed",e);
      }
      const fab=document.getElementById('chatFab');
      const badge=document.getElementById('chatUnreadBadge');
      if(fab) fab.classList.remove('has-unread');
      if(badge) badge.style.display='none';
    }

    function setupChatUI(){
      const fab=document.getElementById('chatFab');
      const panel=document.getElementById('chatPanel');
      const closeBtn=document.getElementById('chatCloseBtn');
      const sendBtn=document.getElementById('chatSendBtn');
      const input=document.getElementById('chatInput');
      if(!fab||!panel||!closeBtn||!sendBtn||!input) return;
      fab.onclick=()=>{
        const open=panel.classList.toggle('open');
        if(open){
          markChatSeen();
        }
      };
      closeBtn.onclick=()=>{ panel.classList.remove('open'); };
      sendBtn.onclick=()=>sendChatMessage();
      input.addEventListener('keydown',e=>{
        if(e.key==="Enter"&&!e.shiftKey){
          e.preventDefault();
          sendChatMessage();
        }
      });
    }

    async function loadFavouriteTeamProfile(userDoc){
      const fav=userDoc?.favouriteTeamucl||'';
      favouriteTeamucl=fav;
      const nameEl=document.getElementById('favTeamName');
      const logoWrap=document.getElementById('favTeamLogo');
      const img=document.getElementById('favTeamLogoImg');
      const ph=document.getElementById('favTeamLogoPlaceholder');
      if(!nameEl||!logoWrap||!img||!ph) return;
      if(!fav){
        nameEl.textContent='Nincs kedvenc beállítva';
        ph.style.display='';
        img.style.display='none';
        return;
      }
      nameEl.textContent=fav;
      const crest=crestMap[fav];
      if(crest){
        img.src=crest;
        img.alt=fav;
        img.style.display='';
        ph.style.display='none';
      }else{
        img.style.display='none';
        ph.style.display='';
      }
    }

    document.addEventListener("DOMContentLoaded",()=>{
      initLeagueSwitcher({ mountTarget: document.getElementById('leagueSwitchMount') });

      onAuthStateChanged(auth,async(user)=>{
        if(!user){window.location.href="login.html";return}
        currentUserEmail=user.email;

        const userRef=doc(db,"users",currentUserEmail);
        const userSnap=await getDoc(userRef);
        if(userSnap.exists()){
          const data=userSnap.data();
          currentUserNick=data.nickname||currentUserEmail;
          currentUserRole=data.role||"user";
          favouriteTeamucl=data.favouriteTeamucl||"";
          chatLastSeen=data[CHAT_LAST_SEEN_FIELD]||null;
          loadFavouriteTeamProfile(data);
        }

        subscribeChat();
        setupChatUI();

        try{
          const lockDoc=await getDoc(doc(db,"settings","positionsLock_ucl"));
          if(lockDoc.exists()){
            const d=lockDoc.data();
            const isLocked=!!d.isLocked;
            const until=d.lockUntil?.toDate?.()||null;
            const now=new Date();
            const locked = isLocked || (until && now>=until);
            if(locked){
              startNavTop8Countdown(null);
            }else{
              startNavTop8Countdown(until);
            }
          }else{
            startNavTop8Countdown(null);
          }
        }catch(e){ startNavTop8Countdown(null); }

        await buildComputedTable();
        onSnapshot(collection(db,"ucl_matches"),()=>buildComputedTable());

        await loadBracket();
        onSnapshot(collection(db,"ucl_matches"),()=>loadBracket());
        onSnapshot(collection(db,"ucl_bracket"),()=>loadBracket());

        try{
          const fbLink=facebookLinks[favouriteTeamucl];
          if(fbLink){
            const fbDiv=document.createElement("div");
            fbDiv.className="fb-wrap";
            fbDiv.innerHTML=`
              <iframe 
                src="https://www.facebook.com/plugins/page.php?href=${encodeURIComponent(fbLink)}&tabs=timeline&width=560&height=540&small_header=false&adapt_container_width=true&hide_cover=false&show_facepile=true&appId"
                scrolling="no" frameborder="0" allowfullscreen="true"
                allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>`;
            document.getElementById("facebookFeedContainer").appendChild(fbDiv);
          }
        }catch(e){console.warn(e)}

        function updatePendingBadgeUcl(){
          const badge = document.getElementById('tipsBadgeUcl');
          const matchesCard = document.getElementById('matchesCard');
          if (!badge) return;
          getDocs(query(collection(db,"ucl_matches"), where("startTime", ">=", new Date()))).then(upcomingSnap=>{
            const upcoming = upcomingSnap.docs.map(d => ({ id:d.id, ...d.data() }));
            getDocs(query(collection(db,"ucl_tips"), where("user","==", currentUserEmail))).then(tipsSnap=>{
              const tippedIds = new Set();
              tipsSnap.forEach(t => tippedIds.add(t.data().matchId));
              const pending = upcoming.filter(m => !tippedIds.has(m.id));
              const hasPending = pending.length > 0;
              badge.hidden = !hasPending;
              if(matchesCard){
                if(hasPending) matchesCard.classList.add('attention');
                else matchesCard.classList.remove('attention');
              }
            });
          });
        }
        updatePendingBadgeUcl();
        onSnapshot(collection(db,"ucl_matches"), updatePendingBadgeUcl);
        onSnapshot(query(collection(db,"ucl_tips"), where("user","==", currentUserEmail)), updatePendingBadgeUcl);

      });
    });
  </script>
</body>
</html>
