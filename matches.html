<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Meccsek √©s Tippel√©s</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>

  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e6eaf1; --text:#0f172a; --muted:#64748b;
      --accent:#3b82f6; --ok:#16a34a;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; padding:24px;
      background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }

    .back-btn{
      display:inline-block; text-decoration:none;
      background:#e5e7eb; color:#111;
      padding:8px 12px; border-radius:10px;
      border:1px solid var(--line);
    }

    h1{ margin:16px 0 12px; font-size:22px; }
    .page-muted{ color:var(--muted); margin-bottom:16px; }

    .round-card{
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      box-shadow:0 6px 18px rgba(15,23,42,.05);
      margin:18px auto; max-width:1100px; overflow:hidden;
    }
    .round-head{
      padding:10px 14px; border-bottom:1px solid var(--line);
      background:#f7f9fd; font-weight:700; display:flex; align-items:center; gap:10px;
    }
    .round-head small{ font-weight:400; color:var(--muted); }

    .match-row{
      display:grid;
      grid-template-columns: 1.8fr 1fr 1fr 1.2fr;
      gap:10px; align-items:center;
      padding:12px 14px; border-bottom:1px solid var(--line);
      background:#fff;
    }
    .match-row:last-child{ border-bottom:0; }
    .match-row:nth-child(even){ background:#fcfdff; }

    .teams{ display:flex; align-items:center; gap:10px; min-width:0; }
    .crest{ width:26px; height:26px; object-fit:contain }
    .kickoff{ color:var(--muted); font-size:12px; }

    select, button, label{ font:inherit; }
    select{
      width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff;
    }

    .double-wrap{ display:flex; align-items:center; gap:8px; }
    .dupla-lezart{ color:#888; font-size:12px; }

    .btn{
      border:0; background:var(--accent); color:#fff;
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .round-footer{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; border-top:1px solid var(--line); background:#fafcff;
    }
    .status{ font-size:13px; }
    .status.ok{ color:var(--ok); }
    .status.muted{ color:var(--muted); }

    @media (max-width: 900px){
      .match-row{ grid-template-columns: 1.6fr 1fr 1fr; }
      .status-col{ grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
  <a href="dashboard.html" class="back-btn">‚Üê Vissza a f≈ëoldalra</a>
  <h1>Meccsek √©s tippel√©s</h1>
  <div class="page-muted">
    Itt adhatod le a tippjeidet. A ‚ÄúDupla pont‚Äù az adott fordul√≥ els≈ë meccs√©nek kezdet√©ig √°ll√≠that√≥, √©s fordul√≥nk√©nt pontosan egy meccsre √©rv√©nyes.
  </div>

  <div id="matchesContainer"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const matchesContainer = document.getElementById("matchesContainer");
    let userTips = {};

    const crestMap = {
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Di√≥sgy≈ëri VTK": "crest/crest-dvtk.png",
      "Ferencv√°ros": "crest/crest-fradi.png",
      "ETO FC Gy≈ër": "crest/crest-gyor.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Kisv√°rda FC": "crest/crest-kisvarda.png",
      "MTK Budapest": "crest/crest-mtk.png",
      "Ny√≠regyh√°za Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Pusk√°s Akad√©mia": "crest/crest-puskas.png",
      "√öjpest FC": "crest/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png"
    };

    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = "login.html"; return; }
      await fetchUserTips();
      loadMatches();
    });

    async function fetchUserTips() {
      const tipsSnapshot = await db.collection("tips")
        .where("user", "==", auth.currentUser.email)
        .get();
      userTips = {};
      tipsSnapshot.forEach(doc => {
        const d = doc.data();
        userTips[d.matchId] = { id: doc.id, tip: d.tip, isDouble: d.isDouble, roundId: d.roundId };
      });
    }

    function loadMatches() {
      db.collection("matches").orderBy("startTime").onSnapshot(async (qs) => {
        await fetchUserTips();
        const byRound = {};
        qs.forEach(doc => {
          const d = doc.data();
          const r = d.roundId || "Egy√©b";
          (byRound[r] ||= []).push({ id: doc.id, ...d });
        });

        matchesContainer.innerHTML = "";
        const now = new Date();

        const sortedRounds = Object.keys(byRound).sort((a,b)=>{
          const na = parseInt(a)||0, nb = parseInt(b)||0;
          return na-nb;
        });

        for (const roundId of sortedRounds) {
          const list = byRound[roundId];

          // ha a fordul√≥ √ñSSZES meccse elkezd≈ëd√∂tt, ne mutassuk
          const allStarted = list.every(m => m.startTime?.toDate?.() <= now);
          if (allStarted) continue;

          const card = document.createElement("div");
          card.className = "round-card";

          // fej
          const head = document.createElement("div");
          head.className = "round-head";
          const roundStart = list.reduce((earliest,m)=>{
            const t = m.startTime?.toDate?.(); return (!earliest||t<earliest)?t:earliest;
          }, null);
          const roundStarted = roundStart && roundStart <= now;
          head.innerHTML = `üèÅ ${roundId}. fordul√≥ <small>${roundStart? roundStart.toLocaleString("hu-HU"):""}</small>`;
          card.appendChild(head);

          // a k√°rty√°n bel√ºli referenci√°k a ment√©shez
          const rowRefs = []; // {match, select, checkbox, started, existing}
          const groupName = `double-${roundId}`; // r√°di√≥-szer≈± viselked√©shez

          // sorok
          list.forEach(match => {
            const row = document.createElement("div");
            row.className = "match-row";

            const start = match.startTime?.toDate?.();
            const hasStarted = start && start <= now;

            const homeCrest = crestMap[match.homeTeam] || "";
            const awayCrest = crestMap[match.awayTeam] || "";

            // 1) csapatok + kezd√©s
            const teamsCell = document.createElement("div");
            teamsCell.innerHTML = `
              <div class="teams">
                <img src="${homeCrest}" class="crest" alt="">
                <strong>${match.homeTeam}</strong>
                <span>vs</span>
                <strong>${match.awayTeam}</strong>
                <img src="${awayCrest}" class="crest" alt="">
              </div>
              <div class="kickoff">Kezd√©s: ${start? start.toLocaleString("hu-HU") : "-"}</div>
            `;
            row.appendChild(teamsCell);

            // 2) tipp select
            const existing = userTips[match.id];
            const odds1 = match.odds?.["1"] ?? "-";
            const oddsX = match.odds?.["X"] ?? "-";
            const odds2 = match.odds?.["2"] ?? "-";

            const pickCell = document.createElement("div");
            const select = document.createElement("select");
            select.innerHTML = `
              <option value="">V√°lassz tippet</option>
              <option value="1">1 (odds: ${odds1})</option>
              <option value="X">X (odds: ${oddsX})</option>
              <option value="2">2 (odds: ${odds2})</option>
            `;
            if (existing) select.value = existing.tip;
            if (hasStarted) select.disabled = true;
            pickCell.appendChild(select);
            row.appendChild(pickCell);

            // 3) dupla (r√°di√≥-szer≈± egyedis√©ggel a fordul√≥n bel√ºl)
            const doubleCell = document.createElement("div");
            doubleCell.className = "double-wrap";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.dataset.group = groupName;
            checkbox.checked = existing?.isDouble || false;
            if (roundStarted) checkbox.disabled = true;

            // ha bepip√°lod, a fordul√≥n bel√ºli t√∂bbit kikapcsolja
            checkbox.addEventListener("change", (e)=>{
              if (!e.target.checked) return;
              document
                .querySelectorAll(`input[type="checkbox"][data-group="${groupName}"]`)
                .forEach(cb => { if (cb!==checkbox) cb.checked = false; });
            });

            const label = document.createElement("label");
            label.textContent = "Dupla pont";

            const duplaInfo = document.createElement("span");
            if (roundStarted) { duplaInfo.className="dupla-lezart"; duplaInfo.textContent="(dupl√°z√°s lez√°rva)"; }

            doubleCell.appendChild(checkbox);
            doubleCell.appendChild(label);
            doubleCell.appendChild(duplaInfo);
            row.appendChild(doubleCell);

            // 4) st√°tusz
            const status = document.createElement("div");
            status.className = "status status-col " + (existing? "ok":"muted");
            status.textContent = existing
              ? `‚úÖ Tippelt√©l: ${existing.tip}${existing.isDouble ? " (dupla)" : ""}`
              : "M√©g nincs tipped.";
            row.appendChild(status);

            rowRefs.push({ match, select, checkbox, started: hasStarted, existing });
            card.appendChild(row);
          });

          // l√°bl√©c ‚Äì fordul√≥ ment√©se
          const footer = document.createElement("div");
          footer.className = "round-footer";
          const info = document.createElement("div");
          info.className = "status muted";
          info.textContent = "V√°lassz tippet(eket), majd mentsd el.";
          const saveRoundBtn = document.createElement("button");
          saveRoundBtn.className = "btn";
          saveRoundBtn.textContent = "Fordul√≥ ment√©se";
          footer.appendChild(info);
          footer.appendChild(saveRoundBtn);
          card.appendChild(footer);

          // ment√©s: csak a m√©g el nem kezdett meccsekre √©s csak a kiv√°lasztott tippeket menti
          saveRoundBtn.addEventListener("click", async ()=>{
            saveRoundBtn.disabled = true;
            info.textContent = "Ment√©s folyamatban‚Ä¶";

            try{
              // kiv√°lasztott dupla (ha a fordul√≥ban b√°rki be van jel√∂lve)
              const chosenDouble = rowRefs.find(r => r.checkbox.checked);
              const chosenDoubleMatchId = chosenDouble ? chosenDouble.match.id : null;

              const tipRef = db.collection("tips");

              // ha most m√°shova jel√∂lt√ºnk dupl√°t, szedd le a r√©gi dupl√°t ugyanebb≈ël a fordul√≥b√≥l
              if (chosenDoubleMatchId){
                const old = Object.entries(userTips).find(([mid, t]) =>
                  t.roundId === roundId && t.isDouble && mid !== chosenDoubleMatchId
                );
                if (old){
                  await tipRef.doc(old[1].id).update({ isDouble:false });
                  userTips[old[0]].isDouble = false;
                }
              }

              // v√©gigmegy√ºnk a sorokon
              for (const r of rowRefs){
                if (r.started) continue; // m√°r elindult meccs: kihagyjuk

                const selected = r.select.value;
                const makeDouble = (r.match.id === chosenDoubleMatchId) && !roundStarted;

                // nincs kiv√°lasztott tipp ‚Üí semmit nem csin√°lunk (nem t√∂rl√ºnk)
                if (!selected){
                  // ha kor√°bban dupla volt √©s most m√°sra jel√∂lted ‚Üí itt is levehetj√ºk a dupl√°t
                  if (r.existing?.id && r.existing.isDouble && chosenDoubleMatchId && r.match.id !== chosenDoubleMatchId){
                    await tipRef.doc(r.existing.id).update({ isDouble:false });
                    userTips[r.match.id].isDouble = false;
                  }
                  continue;
                }

                if (r.existing?.id){
                  await tipRef.doc(r.existing.id).update({
                    tip: selected,
                    isDouble: !!makeDouble
                  });
                  userTips[r.match.id].tip = selected;
                  userTips[r.match.id].isDouble = !!makeDouble;
                } else {
                  const newDoc = await tipRef.add({
                    user: auth.currentUser.email,
                    matchId: r.match.id,
                    tip: selected,
                    isDouble: !!makeDouble,
                    roundId: roundId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                  });
                  userTips[r.match.id] = {
                    id: newDoc.id, tip: selected, isDouble: !!makeDouble, roundId
                  };
                }
              }

              info.className = "status ok";
              info.textContent = "Sikeresen mentve.";
              loadMatches(); // friss√≠ts√ºk a st√°tuszokat
            } catch(err){
              console.error(err);
              info.className = "status";
              info.textContent = "Hiba t√∂rt√©nt ment√©s k√∂zben.";
            } finally {
              saveRoundBtn.disabled = false;
            }
          });

          matchesContainer.appendChild(card);
        }

        if (window.hideLoader) hideLoader();
      });
    }
  </script>
</body>
</html>
