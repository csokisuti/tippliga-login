<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>NB1 TippLiga – Meccstippek</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    .layout{ display:flex; flex-direction:column; gap:16px; max-width:1200px; margin:0 auto; padding:20px; }
    .content-grid{ display:grid; grid-template-columns: 1fr; gap:16px; }
    .header{ display:flex; align-items:center; justify-content:space-between; }
    .page-title{ font-size:28px; font-weight:700; display:flex; align-items:center; gap:10px; }
    .subtitle{ color:#666; font-size:14px; }
    .card{ background:#fff; border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,0.08); padding:16px; }
    .grid{ display:grid; gap:12px; }

    .nav-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap:14px;
    }
    .nav-card{
      display:flex; gap:12px; align-items:center;
      background:#fff; border-radius:16px; padding:14px;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
      text-decoration:none; color:inherit;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .nav-card:hover{ transform:translateY(-2px); box-shadow:0 6px 18px rgba(0,0,0,0.12); }
    .icon-wrap{
      width:44px; height:44px; border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background:var(--brand-100,#eef4ff);
    }
    .text{ display:flex; flex-direction:column; }
    .title{ font-weight:700; }
    .desc{ color:#666; font-size:12px; }

    .pill-badge{
      background:#ff4757; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px; margin-left:6px;
    }

    .match-card{ display:grid; gap:10px; }
    .teams{ display:flex; align-items:center; justify-content:space-between; font-size:18px; font-weight:600; }
    .meta{ color:#666; font-size:13px; }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .btn{ padding:8px 12px; border-radius:10px; border:none; background:#1a73e8; color:#fff; cursor:pointer; }
    .btn:disabled{ background:#9bb8ee; cursor:not-allowed; }
    .select, select{ padding:8px 10px; border-radius:10px; border:1px solid #ddd; min-width:120px; }
    .checkbox{ display:flex; align-items:center; gap:8px; }
  </style>
</head>
<body>
  <div class="layout">
    <header class="header">
      <div class="page-title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1.7 3.5 1.7-1.2 1.7 1.2-.6 2 1.6 1.2h-2L12 7.2l-1.7 1.5h-2l1.6-1.2-.6-2ZM6.2 9.3l1.9-.3.9 1.7-.8 1.8-1.8.2-1.2-1.6 1-1.8Zm11.6 0 1 1.8-1.2 1.6-1.8-.2-.8-1.8.9-1.7 1.9.3ZM8.9 17.9l-.7-1.9 1.5-1.2h1.9l.9 1.7-1.5 1.4-2.1 0Zm6.2 0-2.1 0-1.5-1.4.9-1.7h1.9l1.5 1.2-.7 1.9Z"/></svg>
        Meccstippek
      </div>
      <div class="subtitle">Közelgő meccsek – itt tudsz tippelni</div>
    </header>

    <!-- NAVIGÁCIÓ – FRISSÍTVE: hozzáadva a Főoldal menüpont -->
    <nav class="nav-grid">
      <a class="nav-card" href="dashboard.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3.1 3 10v11h6v-6h6v6h6V10L12 3.1Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Főoldal</span>
          <span class="desc">Vissza a dashboardra</span>
        </div>
      </a>

      <a class="nav-card" href="matches.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1.7 3.5 1.7-1.2 1.7 1.2-.6 2 1.6 1.2h-2L12 7.2l-1.7 1.5h-2l1.6-1.2-.6-2ZM6.2 9.3l1.9-.3.9 1.7-.8 1.8-1.8.2-1.2-1.6 1-1.8Zm11.6 0 1 1.8-1.2 1.6-1.8-.2-.8-1.8.9-1.7 1.9.3ZM8.9 17.9l-.7-1.9 1.5-1.2h1.9l.9 1.7-1.5 1.4-2.1 0Zm6.2 0-2.1 0-1.5-1.4.9-1.7h1.9l1.5 1.2-.7 1.9Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span>
          <span class="desc">Közelgő meccsek & tippek</span>
        </div>
      </a>

      <a class="nav-card" href="positions.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg>
        </div>
        <div class="text">
          <span class="title">Szezon végi sorrend</span>
          <span class="desc">12 csapat – húzd a helyekre</span>
        </div>
      </a>

      <a class="nav-card" href="results.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2Zm0 4h6V4H9v2Zm1 6h8v2h-8v-2Zm0 4h8v2h-8v-2ZM6 10h3v2H6v-2Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Eredmények</span>
          <span class="desc">Fordulónkénti bontás</span>
        </div>
      </a>

      <a class="nav-card" href="leaderboard.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h3a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2Zm-2 2H9V3h6v2ZM4 6a3 3 0 0 0 3 3h1a4 4 0 0 1-1-3V5H4v1Zm16-1h-3v1a4 4 0 0 1-1 3h1a3 3 0 0 0 3-3V5Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Összpontszám</span>
          <span class="desc">Toplista & bónusz</span>
        </div>
      </a>

      <a class="nav-card" href="profile.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Profil</span>
          <span class="desc">Beállítások & kedvenc csapat</span>
        </div>
      </a>

      <a class="nav-card" id="adminLink" href="admin.html" style="display:none;">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Zm8.94 4a6.94 6.94 0 0 0-.12-1l2.02-1.56-2-3.46-2.44 1a6.9 6.9 0 0 0-1.74-1l-.37-2.6H9.71l-.37 2.6a6.9 6.9 0 0 0-1.74 1l-2.44-1-2 3.46L5.18 11a7 7 0 0 0 0 2l-2.02 1.56 2 3.46 2.44-1a6.9 6.9 0 0 0 1.74 1l.37 2.6h4.56l.37-2.6a6.9 6.9 0 0 0 1.74-1l2.44 1 2-3.46L20.82 13a6.94 6.94 0 0 0 .12-1Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Admin</span>
          <span class="desc">Szezon-zár & beállítások</span>
        </div>
      </a>
    </nav>
    <!-- /NAVIGÁCIÓ -->

    <main class="content-grid">
      <section class="card">
        <div class="grid" id="upcomingMatches"></div>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, getDocs, Timestamp,
      doc, updateDoc, deleteDoc, getDoc, setDoc, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoN-REDACTED",
      authDomain: "tippliga.firebaseapp.com",
      projectId: "tippliga",
      storageBucket: "tippliga.appspot.com",
      messagingSenderId: "000000000000",
      appId: "1:000000000000:web:xxxxxxxxxxxxxxxx"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const adminLink = document.getElementById("adminLink");
    const tipsBadge = document.getElementById("tipsBadge");

    function formatDate(ts){
      const d = ts instanceof Date ? ts : ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString("hu-HU", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    async function updatePendingBadge(userEmail){
      const tipsSnap = await getDocs(query(collection(db,"tips"), where("userEmail","==",userEmail)));
      const tippedMatchIds = new Set(tipsSnap.docs.map(d => d.data().matchId));

      const upcomingSnap = await getDocs(query(collection(db,"matches"), orderBy("startTime","asc")));
      let pending = 0;
      const now = new Date();
      upcomingSnap.forEach(docu => {
        const m = docu.data();
        const start = m.startTime?.toDate ? m.startTime.toDate() : new Date(m.startTime);
        if(start > now && !tippedMatchIds.has(docu.id)) pending++;
      });

      if(pending > 0){
        tipsBadge.textContent = pending;
        tipsBadge.hidden = false;
      } else {
        tipsBadge.hidden = true;
      }
    }

    function outcomeFromScore(score){
      const m = /^\\s*(\\d+)\\s*[-:]\\s*(\\d+)\\s*$/.exec(score || "");
      if(!m) return null;
      const a = parseInt(m[1],10), b = parseInt(m[2],10);
      if(a > b) return "1";
      if(a < b) return "2";
      return "X";
    }

    async function renderUpcoming(userEmail){
      const cont = document.getElementById("upcomingMatches");
      cont.innerHTML = "";

      const now = new Date();
      const snap = await getDocs(query(collection(db,"matches"), orderBy("startTime","asc")));
      snap.forEach(docu => {
        const data = docu.data();
        const start = data.startTime?.toDate ? data.startTime.toDate() : new Date(data.startTime);
        if(start <= now) return;

        const card = document.createElement("div");
        card.className = "match-card";

        const teams = document.createElement("div");
        teams.className = "teams";
        teams.textContent = data.homeTeam + "  –  " + data.awayTeam;

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = "Kezdés: " + formatDate(start) + " | Odds: 1=" + data.odds1 + "  X=" + data.oddsX + "  2=" + data.odds2;

        const row = document.createElement("div");
        row.className = "row";

        const sel = document.createElement("select");
        sel.className = "select";
        ["","1","X","2"].forEach(v=>{
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v ? v : "Válassz 1/X/2";
          sel.appendChild(opt);
        });

        const dblWrap = document.createElement("label");
        dblWrap.className = "checkbox";
        const dbl = document.createElement("input");
        dbl.type = "checkbox";
        const dblSpan = document.createElement("span");
        dblSpan.textContent = "Duplázom ezt a tippet";
        dblWrap.appendChild(dbl);
        dblWrap.appendChild(dblSpan);

        const save = document.createElement("button");
        save.className = "btn";
        save.textContent = "Tipp mentése";

        save.addEventListener("click", async ()=>{
          if(!sel.value){
            alert("Válassz 1/X/2 tippet.");
            return;
          }
          const tipRef = collection(db,"tips");
          await addDoc(tipRef, {
            userEmail,
            matchId: docu.id,
            pick: sel.value,
            doubled: !!dbl.checked,
            createdAt: new Date()
          });
          save.disabled = true;
          await updatePendingBadge(userEmail);
          alert("Mentve.");
        });

        row.appendChild(sel);
        row.appendChild(dblWrap);
        row.appendChild(save);

        card.appendChild(teams);
        card.appendChild(meta);
        card.appendChild(row);

        cont.appendChild(card);
      });
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        window.location.href = "login.html";
        return;
      }

      try{
        const u = await getDoc(doc(db,"users", user.email));
        const role = u.exists() ? (u.data().role || "user") : "user";
        if(role === "admin") adminLink.style.display = "";

        await updatePendingBadge(user.email);
        await renderUpcoming(user.email);
      }catch(e){
        console.error(e);
      }
    });
  </script>
</body>
</html>

