<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Meccsek √©s Tippel√©s</title>

  <!-- Firebase (compat, a jelenlegi k√≥dodhoz passzol) -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>

  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e6eaf1; --text:#0f172a; --muted:#64748b;
      --accent:#3b82f6; --ok:#16a34a;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; padding:24px;
      background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }

    /* Vissza gomb */
    .back-btn{
      display:inline-block; text-decoration:none;
      background:#e5e7eb; color:#111;
      padding:8px 12px; border-radius:10px;
      border:1px solid var(--line);
    }

    h1{ margin:16px 0 12px; font-size:22px; }
    .page-muted{ color:var(--muted); margin-bottom:16px; }

    /* Fordul√≥ k√°rtya */
    .round-card{
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      box-shadow:0 6px 18px rgba(15,23,42,.05);
      margin:18px auto; max-width:1100px; overflow:hidden;
    }
    .round-head{
      padding:10px 14px; border-bottom:1px solid var(--line);
      background:#f7f9fd; font-weight:700; display:flex; align-items:center; gap:10px;
    }
    .round-head small{ font-weight:400; color:var(--muted); }

    /* Meccs sor k√°rty√°n bel√ºl (r√°cs) */
    .match-row{
      display:grid;
      grid-template-columns: 1.6fr 1fr .8fr .9fr 1.2fr;
      gap:10px; align-items:center;
      padding:12px 14px; border-bottom:1px solid var(--line);
      background:#fff;
    }
    .match-row:last-child{ border-bottom:0; }
    .match-row:nth-child(even){ background:#fcfdff; }

    .teams{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .team-names{ display:flex; gap:6px; align-items:center; flex-wrap:wrap }
    .crest{ width:26px; height:26px; object-fit:contain }
    .kickoff{ color:var(--muted); font-size:12px; }

    select, button, label{ font:inherit; }
    select{
      width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff;
    }

    .double-wrap{ display:flex; align-items:center; gap:8px; }
    .dupla-lezart{ color:#888; font-size:12px; }

    .btn{
      border:0; background:var(--accent); color:#fff;
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .status{ font-size:13px; }
    .status.ok{ color:var(--ok); }
    .status.muted{ color:var(--muted); }

    /* Mobil/ keskeny */
    @media (max-width: 900px){
      .match-row{
        grid-template-columns: 1.6fr 1fr 1fr;
        grid-auto-rows:auto;
      }
      .double-wrap{ order:3 }
      .save-col{ order:4 }
      .status-col{ grid-column: 1 / -1; }
    }
  </style>
</head>
<body>
  <a href="dashboard.html" class="back-btn">‚Üê Vissza a f≈ëoldalra</a>
  <h1>Meccsek √©s tippel√©s</h1>
  <div class="page-muted">Itt adhatod le a tippjeidet. A ‚ÄúDupla pont‚Äù az adott fordul√≥ els≈ë meccs√©nek kezdet√©ig √°ll√≠that√≥.</div>

  <div id="matchesContainer"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const matchesContainer = document.getElementById("matchesContainer");
    let currentUserId = null;
    let userTips = {};

    const crestMap = {
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Di√≥sgy≈ëri VTK": "crest/crest-dvtk.png",
      "Ferencv√°ros": "crest/crest-fradi.png",
      "ETO FC Gy≈ër": "crest/crest-gyor.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Kisv√°rda FC": "crest/crest-kisvarda.png",
      "MTK Budapest": "crest/crest-mtk.png",
      "Ny√≠regyh√°za Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Pusk√°s Akad√©mia": "crest/crest-puskas.png",
      "√öjpest FC": "crest/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png"
    };

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUserId = user.uid;
        await fetchUserTips();
        loadMatches();
      } else {
        alert("Nincs bejelentkezve!");
        window.location.href = "login.html";
      }
    });

    async function fetchUserTips() {
      try {
        const tipsSnapshot = await db.collection("tips")
          .where("user", "==", auth.currentUser.email)
          .get();

        userTips = {};
        tipsSnapshot.forEach((doc) => {
          const data = doc.data();
          userTips[data.matchId] = {
            tip: data.tip,
            isDouble: data.isDouble,
            id: doc.id,
            roundId: data.roundId
          };
        });
      } catch (error) {
        console.error("Hiba a tippek lek√©r√©sekor:", error);
      }
    }

    function loadMatches() {
      db.collection("matches").orderBy("startTime").onSnapshot(async (querySnapshot) => {
        await fetchUserTips();
        const matchesByRound = {};

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const roundId = data.roundId || "Egy√©b";
          if (!matchesByRound[roundId]) matchesByRound[roundId] = [];
          matchesByRound[roundId].push({ id: doc.id, ...data });
        });

        matchesContainer.innerHTML = "";
        const now = new Date();

        const sortedRounds = Object.keys(matchesByRound).sort((a, b) => {
          const numA = parseInt(a.replace(/\D/g, '')) || 0;
          const numB = parseInt(b.replace(/\D/g, '')) || 0;
          return numA - numB;
        });

        sortedRounds.forEach((roundId) => {
          const matches = matchesByRound[roundId];

          // ha a fordul√≥ √∂sszes meccse elkezd≈ëd√∂tt, ne mutassuk
          const allStarted = matches.every(m => m.startTime?.toDate?.() <= now);
          if (allStarted) return;

          // k√°rtya a fordul√≥nak
          const card = document.createElement("div");
          card.className = "round-card";

          const roundHeader = document.createElement("div");
          roundHeader.className = "round-head";

          const roundStartTime = matches.reduce((earliest, m) => {
            const t = m.startTime?.toDate?.();
            return (!earliest || t < earliest) ? t : earliest;
          }, null);
          const roundStarted = roundStartTime && roundStartTime <= now;

          const roundNum = roundId.replace(/\D*(\d+)/, "$1");
          roundHeader.innerHTML = `üèÅ ${roundNum}. fordul√≥ <small>${roundStartTime ? roundStartTime.toLocaleString("hu-HU") : ""}</small>`;
          card.appendChild(roundHeader);

          matches.forEach((match) => {
            const row = document.createElement("div");
            row.className = "match-row";

            const startTime = match.startTime?.toDate?.();
            const formattedTime = startTime ? startTime.toLocaleString("hu-HU") : "Invalid Date";
            const hasStarted = startTime && startTime <= now;

            const homeCrest = crestMap[match.homeTeam] || "";
            const awayCrest = crestMap[match.awayTeam] || "";

            // 1) csapatok + kezd√©s
            const teamsCell = document.createElement("div");
            teamsCell.innerHTML = `
              <div class="teams">
                <img src="${homeCrest}" class="crest" alt="">
                <strong>${match.homeTeam}</strong>
                <span>vs</span>
                <strong>${match.awayTeam}</strong>
                <img src="${awayCrest}" class="crest" alt="">
              </div>
              <div class="kickoff">Kezd√©s: ${formattedTime}</div>
            `;
            row.appendChild(teamsCell);

            // 2) tipp select
            const existingTip = userTips[match.id];
            const odds1 = match.odds?.["1"] ?? "-";
            const oddsX = match.odds?.["X"] ?? "-";
            const odds2 = match.odds?.["2"] ?? "-";

            const pickCell = document.createElement("div");
            const select = document.createElement("select");
            select.innerHTML = `
              <option value="">V√°lassz tippet</option>
              <option value="1">1 (odds: ${odds1})</option>
              <option value="X">X (odds: ${oddsX})</option>
              <option value="2">2 (odds: ${odds2})</option>
            `;
            if (existingTip) select.value = existingTip.tip;
            if (hasStarted) select.disabled = true;
            pickCell.appendChild(select);
            row.appendChild(pickCell);

            // 3) dupla
            const doubleCell = document.createElement("div");
            doubleCell.className = "double-wrap";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = existingTip?.isDouble || false;
            if (roundStarted) checkbox.disabled = true;

            const label = document.createElement("label");
            label.textContent = "Dupla pont";
            label.htmlFor = "";

            const duplaInfo = document.createElement("span");
            if (roundStarted) {
              duplaInfo.className = "dupla-lezart";
              duplaInfo.textContent = "(dupl√°z√°s lez√°rva)";
            }

            doubleCell.appendChild(checkbox);
            doubleCell.appendChild(label);
            doubleCell.appendChild(duplaInfo);
            row.appendChild(doubleCell);

            // 4) ment√©s gomb
            const saveCell = document.createElement("div");
            saveCell.className = "save-col";
            const saveBtn = document.createElement("button");
            saveBtn.className = "btn";
            saveBtn.textContent = "Tipp ment√©se";
            if (hasStarted) saveBtn.disabled = true;
            saveCell.appendChild(saveBtn);
            row.appendChild(saveCell);

            // 5) st√°tusz
            const statusCell = document.createElement("div");
            statusCell.className = "status status-col";
            if (existingTip) {
              statusCell.classList.add("ok");
              statusCell.textContent = `‚úÖ Tippelt√©l: ${existingTip.tip}${existingTip.isDouble ? " (dupla)" : ""}`;
            } else {
              statusCell.classList.add("muted");
              statusCell.textContent = "M√©g nincs tipped.";
            }
            row.appendChild(statusCell);

            // ment√©s logika (v√°ltozatlan)
            saveBtn.onclick = async () => {
              const selected = select.value;
              const isDouble = checkbox.checked;

              if (!selected) {
                alert("K√©rlek v√°lassz egy tippet.");
                return;
              }

              const tipRef = db.collection("tips");
              const existing = userTips[match.id];

              // egy fordul√≥ban csak 1 dupla
              if (isDouble) {
                const oldDouble = Object.entries(userTips).find(
                  ([, tip]) => tip.roundId === match.roundId && tip.isDouble && tip.id !== existing?.id
                );
                if (oldDouble) {
                  await tipRef.doc(oldDouble[1].id).update({ isDouble: false });
                  userTips[oldDouble[0]].isDouble = false;
                }
              }

              if (existing) {
                await tipRef.doc(existing.id).update({
                  tip: selected,
                  isDouble,
                });
                userTips[match.id].tip = selected;
                userTips[match.id].isDouble = isDouble;
              } else {
                const newDoc = await tipRef.add({
                  user: auth.currentUser.email,
                  matchId: match.id,
                  tip: selected,
                  isDouble,
                  roundId: match.roundId,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                });
                userTips[match.id] = {
                  id: newDoc.id,
                  tip: selected,
                  isDouble,
                  roundId: match.roundId,
                };
              }

              loadMatches();
            };

            card.appendChild(row);
          });

          matchesContainer.appendChild(card);
        });

        if (window.hideLoader) hideLoader();
      });
    }
  </script>
</body>
</html>
