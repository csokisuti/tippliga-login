<!DOCTYPE html>
<html>
<head>
  <title>Meccsek √©s Tippel√©s</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, addDoc, updateDoc, doc,
      query, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
  authDomain: "tippliga-4b3af.firebaseapp.com",
  projectId: "tippliga-4b3af",
  storageBucket: "tippliga-4b3af.firebasestorage.app",
  messagingSenderId: "720359845241",
  appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const matchesContainer = document.createElement("div");
    document.body.appendChild(matchesContainer);

    let user;

    onAuthStateChanged(auth, async (currentUser) => {
      if (!currentUser) {
        window.location.href = "login.html";
        return;
      }

      user = currentUser;

      const matchesSnap = await getDocs(collection(db, "matches"));
      const matches = matchesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const tipsSnap = await getDocs(
        query(collection(db, "tips"), where("userId", "==", user.uid))
      );
      const userTips = tipsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      function isAnotherDoubleInRound(currentMatchId, roundId) {
        return userTips.some(t =>
          t.roundId === roundId &&
          t.isDouble === true &&
          t.matchId !== currentMatchId
        );
      }

      matches.forEach(match => {
        const container = document.createElement("div");
        container.style.border = "1px solid #ccc";
        container.style.margin = "10px";
        container.style.padding = "10px";

        const title = document.createElement("h3");
        title.textContent = `${match.homeTeam} vs ${match.awayTeam}`;
        container.appendChild(title);

        const roundNumber = match.roundId?.replace("round", "") ?? "";
        const roundInfo = document.createElement("p");
        roundInfo.textContent = `Fordul√≥: ${roundNumber}. fordul√≥`;
        container.appendChild(roundInfo);

        const matchStartTime = match.startTime?.toDate
          ? match.startTime.toDate()
          : new Date(match.startTime);
        const isMatchStarted = Date.now() > matchStartTime.getTime();

        const timeInfo = document.createElement("p");
        timeInfo.textContent = `Kezd√©s: ${matchStartTime.toLocaleString()}`;
        container.appendChild(timeInfo);

        const existingTip = userTips.find(t => t.matchId === match.id);

        if (!isMatchStarted) {
          const select = document.createElement("select");
          ["", "1", "X", "2"].forEach(opt => {
            const option = document.createElement("option");
            option.value = opt;
            if (opt === "") {
              option.textContent = "V√°lassz tippet";
            } else if (match.odds && match.odds[opt] !== undefined) {
              option.textContent = `${opt} (odds: ${match.odds[opt]})`;
            } else {
              option.textContent = `${opt} (odds: nincs megadva)`;
            }
            select.appendChild(option);
          });
          container.appendChild(select);

          const doubleCheckbox = document.createElement("input");
          doubleCheckbox.type = "checkbox";
          doubleCheckbox.id = `double-${match.id}`;

          if (isAnotherDoubleInRound(match.id, match.roundId)) {
            doubleCheckbox.disabled = true;
            doubleCheckbox.title = "M√°r van dupl√°zott tipped ebben a fordul√≥ban";
          }

          const doubleLabel = document.createElement("label");
          doubleLabel.htmlFor = `double-${match.id}`;
          doubleLabel.textContent = "Dupla pont";
          container.appendChild(document.createElement("br"));
          container.appendChild(doubleCheckbox);
          container.appendChild(doubleLabel);

          if (existingTip) {
            select.value = existingTip.tip;
            doubleCheckbox.checked = existingTip.isDouble;
          }

          const button = document.createElement("button");
          button.textContent = existingTip ? "Tipp friss√≠t√©se" : "Tipp ment√©se";
          button.onclick = async () => {
            const selectedOption = select.value;
            const isDouble = doubleCheckbox.checked;

            if (!["1", "X", "2"].includes(selectedOption)) {
              alert("K√©rlek v√°lassz √©rv√©nyes tippet.");
              return;
            }

            if (isDouble && isAnotherDoubleInRound(match.id, match.roundId)) {
              alert("M√°r van m√°sik dupl√°z√°sod ebben a fordul√≥ban. El≈ëbb vedd le onnan.");
              return;
            }

            if (existingTip) {
              const tipRef = doc(db, "tips", existingTip.id);
              await updateDoc(tipRef, {
                tip: selectedOption,
                isDouble: isDouble,
                timestamp: serverTimestamp()
              });
            } else {
              await addDoc(collection(db, "tips"), {
                userId: user.uid,
                matchId: match.id,
                roundId: match.roundId,
                tip: selectedOption,
                isDouble: isDouble,
                timestamp: serverTimestamp()
              });
            }

            alert("Tipped mentve!");
            window.location.reload();
          };
          container.appendChild(document.createElement("br"));
          container.appendChild(button);
        } else {
          const lockText = document.createElement("p");
          lockText.textContent = "‚õî A meccs elkezd≈ëd√∂tt, m√°r nem lehet tippelni.";
          lockText.style.color = "red";
          container.appendChild(lockText);
        }

        if (existingTip) {
          const tipInfo = document.createElement("p");
          tipInfo.innerHTML = `üü© Tippelt√©l: <strong>${existingTip.tip}</strong> ${existingTip.isDouble ? "(dupla)" : ""}`;
          container.appendChild(tipInfo);
        }

        matchesContainer.appendChild(container);
      });
    });
  </script>
</head>
<body>
  <h1>Meccsek √©s Tippel√©s</h1>
</body>
</html>

