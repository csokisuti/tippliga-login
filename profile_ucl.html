<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL TippLiga – Profil</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    .layout{ display:flex; flex-direction:column; gap:16px; max-width:1200px; margin:0 auto; padding:20px; }

    /* Fejléc/nav – egységes */
    .header{ display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; }
    .fav-crest{ width:46px; height:46px; object-fit:contain; border-radius:8px; border:1px solid var(--line,#e6eaf1); background:#fff; }
    .welcome{ color:var(--muted,#64748b); margin:4px 0 0; }

    .nav-grid{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; }
    @media (max-width:1100px){ .nav-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width:700px){ .nav-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .nav-card{ display:flex; gap:12px; align-items:center; text-decoration:none; color:inherit; padding:14px; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 6px 18px rgba(15,23,42,.05); }
    .nav-card .icon-wrap{ width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:color-mix(in oklab, var(--accent,#3b82f6) 15%, white); color:var(--accent,#3b82f6); }
    .nav-card .text{ display:flex; flex-direction:column; line-height:1.2; }
    .nav-card .title{ font-weight:800; }
    .nav-card .desc{ color:var(--muted,#64748b); font-size:12px; }
    .pill-badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; margin-left:6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700; line-height:1; vertical-align:middle; }
    .pill-badge[hidden]{ display:none !important; }

    /* NAV visszaszámláló – ugyanaz a kinézet, mint a mintában (piros badge, monospaced számok) */
    .pill-badge.countdown{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-variant-numeric: tabular-nums;
      letter-spacing:.2px;
    }
    .pill-badge.countdown.urgent{ animation:pulse 1s ease-in-out infinite }
    @keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.06)} 100%{transform:scale(1)} }
    .blink{ animation:blink 1s steps(2,start) infinite }
    @keyframes blink{ to{ opacity:.2 } }

    .btn{ border:0; background:#e5e7eb; color:#111; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-accent{ min-height:40px; padding:10px 14px; border-radius:10px; background:var(--accent,#3b82f6); color:#fff; border:1px solid var(--line,#e6eaf1); font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .btn-accent:hover{ filter:brightness(.95); }
    .btn-accent:disabled{ opacity:.6; cursor:not-allowed; }

    .card{ background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,.06); overflow:hidden; }
    .card h3{ margin:0; padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd; }

    .form{ display:grid; gap:12px; padding:12px; }
    .row{ display:grid; gap:8px; }
    .row > label{ font-weight:700; }
    .row-inline{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .inp{ width:100%; max-width:420px; height:40px; padding:8px 10px; border-radius:10px; border:1px solid var(--line,#e6eaf1); }
    .hint{ color:#64748b; font-size:12px; }
    .ok{ color:#065f46; }
    .err{ color:#991b1b; }

    .team-preview{ display:flex; align-items:center; gap:10px; }
    .crest{ width:40px; height:40px; object-fit:contain; border-radius:8px; border:1px solid var(--line,#e6eaf1); background:#fff; }

    /* Chat – egységes */
    .chat-fab{ position:fixed; right:22px; bottom:22px; z-index:999; width:52px; height:52px; border-radius:999px; border:0; background:var(--accent,#3b82f6); color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 26px rgba(0,0,0,.15); }
    .chat-fab .fab-badge{ position:absolute; top:-4px; right:-4px; min-width:20px; height:20px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:800; line-height:20px; display:none; }
    .chat-fab.has-unread .fab-badge{ display:inline-block; }
    .chat-panel{ position:fixed; right:22px; bottom:86px; z-index:998; width:380px; max-width:calc(100vw - 32px); max-height:70vh; display:none; flex-direction:column; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 10px 32px rgba(0,0,0,.14); }
    .chat-panel.open{ display:flex; }
    .chat-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd; }
    .chat-title{ font-weight:800; }
    #chatClose{ width:28px; height:28px; border-radius:8px; font-size:18px; line-height:28px; display:inline-flex; align-items:center; justify-content:center; background:#eef2ff; color:#111; border:1px solid var(--line,#e6eaf1); cursor:pointer; }
    #chatClose:hover{ filter:brightness(0.95); }
    .chat-list{ overflow:auto; padding:8px 10px; }
    .chat-empty{ color:#64748b; font-size:13px; padding:8px 10px; }
    .msg{ padding:8px 10px; border-bottom:1px solid var(--line,#e6eaf1); display:flex; gap:8px; align-items:flex-start; }
    .msg .meta{ font-size:12px; color:#64748b; margin-bottom:2px; }
    .msg .text{ white-space:pre-wrap; word-break:break-word; }
    .msg .del{ margin-left:auto; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:2px 8px; border-radius:8px; font-size:12px; cursor:pointer; display:none; }
    .msg:hover .del{ display:inline-block; }

    #chatComposer{ display:flex; gap:8px; align-items:center; padding:10px; border-top:1px solid var(--line,#e6eaf1); background:#fff; }
    #chatInput{ background:#fff; color:#111; border:1px solid var(--line,#e6eaf1); height:40px; padding:8px 10px; border-radius:10px; font-size:14px; outline:none; width:100%; box-sizing:border-box; }
    #chatInput::placeholder{ color:#6b7280; }
    #chatSendBtn{ min-width:90px; padding:8px 12px; border-radius:10px; background:var(--accent,#3b82f6); color:#fff; border:0; font-weight:600; cursor:pointer; }

    /* === Ligaváltó (NB I ↔ BL) – csak ez az új rész === */
    .league-switch{ display:inline-flex; gap:8px; align-items:center; }
    .league-switch .ls-tab{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px; border:1px solid var(--line,#e6eaf1);
      border-radius:10px; background:#fff; text-decoration:none;
      color:#111; font-weight:700; line-height:1;
    }
    .league-switch .ls-tab.is-active{
      background:var(--accent,#3b82f6); color:#fff;
      border-color: color-mix(in oklab, var(--accent,#3b82f6) 55%, white);
    }
    .league-switch .ls-tab:hover{ filter:brightness(.97); }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc, collection, getDocs, addDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ---------------- Firebase init ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ---------------- Helpers ---------------- */
    /* Címerek – BL/UCL mezőny */
    const crestMap = {
      "Ajax": "ucl_crest/ajax.png","Arsenal": "ucl_crest/arsenal.png","Atalanta": "ucl_crest/atalanta.png","Athletic Bilbao": "ucl_crest/athletic.png",
      "Atlético Madrid": "ucl_crest/atletico.png","Barcelona": "ucl_crest/barcelona.png","Bayern München": "ucl_crest/bayern.png","Benfica": "ucl_crest/benfica.png",
      "Borussia Dortmund": "ucl_crest/borussia.png","Bodø/Glimt": "ucl_crest/bodo.png","Club Bruges": "ucl_crest/brugge.png","Chelsea": "ucl_crest/chelsea.png",
      "FC Köbenhavn": "ucl_crest/copenhagen.png","Eintracht Frankfurt": "ucl_crest/frankfurt.png","Galatasaray": "ucl_crest/galata.png","Internazionale": "ucl_crest/inter.png",
      "Juventus": "ucl_crest/juventus.png","Bayer Leverkusen": "ucl_crest/leverkusen.png","Liverpool": "ucl_crest/liverpool.png","Manchester City": "ucl_crest/mancity.png",
      "Olympique Marseille": "ucl_crest/marseille.png","Monaco": "ucl_crest/monaco.png","Napoli": "ucl_crest/napoli.png","Newcastle United": "ucl_crest/newcastle.png",
      "Olympiakosz Pireusz": "ucl_crest/olympiacos.png","Pafosz": "ucl_crest/pafos.png","Paris Saint-Germain": "ucl_crest/psg.png","PSV": "ucl_crest/psv.png",
      "Qarabag": "ucl_crest/qarabag.png","Real Madrid": "ucl_crest/real.png","Slavia Praha": "ucl_crest/slavia.png","Sporting CP": "ucl_crest/sporting.png",
      "Tottenham Hotspur": "ucl_crest/tottenham.png","Union Saint-Gilloise": "ucl_crest/usg.png","Villarreal": "ucl_crest/villareal.png","Kajrat Almati": "ucl_crest/kairat.png"
    };
    const escapeHtml = s => String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const fmtTime = ts => { try{ return ts.toDate().toLocaleString("hu-HU",{hour12:false}); }catch{ return ""; } };

    /* ===== NAV Top8 visszaszámláló (helper) – mint a mintában ===== */
    let navCdTimer = null;
    function formatCountdown(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const d = Math.floor(total/86400);
      const h = Math.floor((total%86400)/3600);
      const m = Math.floor((total%3600)/60);
      const s = total%60;
      const H = String(h).padStart(2,'0');
      const M = String(m).padStart(2,'0');
      const S = String(s).padStart(2,'0');
      const labelHTML = d>0
        ? `<span class="mono">${d}n&nbsp;</span><span class="mono">${H}<span class="blink">:</span>${M}<span class="blink">:</span>${S}</span>`
        : `<span class="mono">${H}<span class="blink">:</span>${M}<span class="blink">:</span>${S}</span>`;
      const aria = d>0
        ? `${d} nap ${h} óra ${m} perc ${s} másodperc`
        : `${h} óra ${m} perc ${s} másodperc`;
      return { labelHTML, aria };
    }
    function startNavTop8Countdown(until){
      clearInterval(navCdTimer);
      const el = document.getElementById('top8CountdownNav');
      if (!el){ return; }
      el.classList.add('countdown');
      if (!until){
        el.hidden = true;
        return;
      }
      function tick(){
        const ms = until - new Date();
        if (ms <= 0){
          el.hidden = true;
          clearInterval(navCdTimer);
          return;
        }
        const { labelHTML, aria } = formatCountdown(ms);
        el.innerHTML = labelHTML;
        el.setAttribute('aria-live','polite');
        el.setAttribute('aria-label', `Visszaszámláló: ${aria}`);
        el.title = `Határidő: ${until.toLocaleString('hu-HU')}`;
        if (ms <= 5*60*1000){ el.classList.add('urgent'); }
        else { el.classList.remove('urgent'); }
      }
      tick();
      navCdTimer = setInterval(tick, 1000);
      el.hidden = false;
    }
    /* ======================================== */

    /* ---------------- Állapot ---------------- */
    let currentUserEmail = "";
    let currentUserNick = "";
    let currentUserRole = "user";
    let favouriteTeamucl = "";   // UCL kedvenc csapat mező
    let chatLastSeenUcl = null;  // <-- UCL-specifikus

    /* ---------------- INIT ---------------- */
    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login_ucl.html"; return; }
        currentUserEmail = user.email;

        const userRef = doc(db, "users", currentUserEmail);
        const userSnap = await getDoc(userRef);

        // UI elemek
        const welcome = document.getElementById("welcome");
        const favCrestImg = document.getElementById("favCrest");
        const emailEl = document.getElementById("email");
        const nickInp = document.getElementById("nick");
        const nickSave = document.getElementById("saveNick");
        const teamSel = document.getElementById("favoriteTeamSelect");
        const teamSave = document.getElementById("saveTeam");
        const teamCrest = document.getElementById("favoriteTeamLogo");
        const pw1 = document.getElementById("newPassword");
        const pw2 = document.getElementById("newPassword2");
        const pwBtn = document.getElementById("changePasswordBtn");
        const msg = document.getElementById("message");

        // ÚJ: emlékeztető kapcsoló elemei
        const reminderToggle = document.getElementById("reminderEmailUcl");
        const reminderHint = document.getElementById("reminderHint");

        function showMsg(text, type="ok"){ msg.textContent = text; msg.className = type==="ok" ? "hint ok" : "hint err"; }
        function clearMsg(){ msg.textContent=""; msg.className="hint"; }

        // Alapadatok
        emailEl.textContent = currentUserEmail;
        if (userSnap.exists()){
          const d = userSnap.data();
          currentUserNick = d.nickname || currentUserEmail;
          currentUserRole = d.role || "user";
          favouriteTeamucl = d.favouriteTeamucl || "";
          chatLastSeenUcl = d.chatLastSeenUcl || null; // <-- UCL-specifikus mező olvasás
          if (typeof d.reminderEmailUcl !== "undefined") {
            reminderToggle.checked = !!d.reminderEmailUcl;
          }
        } else {
          currentUserNick = currentUserEmail;
          currentUserRole = "user";
        }
        welcome.textContent = `Üdv, ${currentUserNick}!`;
        if (currentUserRole === "admin") document.getElementById("adminLink").style.display = "flex";

        // Téma a kedvenc UCL csapat alapján
        if (favouriteTeamucl) {
          const themeClass = "theme-" + favouriteTeamucl.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-');
          document.body.classList.add(themeClass);
          const crest = crestMap[favouriteTeamucl];
          if (crest) { favCrestImg.src = crest; favCrestImg.alt = favouriteTeamucl; favCrestImg.hidden = false; }
        }

        /* ===== Countdown határidő lekérés + indítás (mint a mintában) ===== */
        try{
          const snap = await getDoc(doc(db,'settings','positionsLock_ucl'));
          let until = null;
          let isLocked = false;
          if (snap.exists()){
            const d = snap.data() || {};
            until = d.lockUntil?.toDate?.() || null;
            const now = new Date();
            isLocked = !!d.isLocked || (until && now >= until);
          }
          startNavTop8Countdown(isLocked ? null : until);
        }catch(e){
          startNavTop8Countdown(null);
        }
        /* ================================================================ */

        // Becenév szerkesztése
        nickInp.value = currentUserNick === currentUserEmail ? "" : currentUserNick;
        nickSave.addEventListener("click", async ()=>{
          const val = nickInp.value.trim();
          try{
            await setDoc(userRef, { nickname: val || currentUserEmail }, { merge:true });
            currentUserNick = val || currentUserEmail;
            welcome.textContent = `Üdv, ${currentUserNick}!`;
            showMsg("Becenév frissítve.");
          }catch(e){ showMsg("Hiba a becenév mentésekor.", "err"); }
        });

        // Kedvenc UCL csapat választó
        Object.keys(crestMap).forEach(team=>{
          const opt = document.createElement("option");
          opt.value = team; opt.textContent = team;
          if (team === favouriteTeamucl) opt.selected = true;
          teamSel.appendChild(opt);
        });
        function updateCrestPreview(){
          const team = teamSel.value;
          const src = crestMap[team];
          if (src){ teamCrest.src = src; teamCrest.alt = team; teamCrest.style.display="inline-block"; }
          else { teamCrest.style.display="none"; }
        }
        updateCrestPreview();
        teamSel.addEventListener("change", updateCrestPreview);
        teamSave.addEventListener("click", async ()=>{
          try{
            await setDoc(userRef, { favouriteTeamucl: teamSel.value }, { merge:true });
            showMsg("Kedvenc csapat (BL) frissítve.");
          }catch(e){ showMsg("Hiba a csapat mentésekor.", "err"); }
        });

        // Jelszó: 2 mező, ellenőrzés
        function validatePw(){
          const a = pw1.value.trim();
          const b = pw2.value.trim();
          const ok = a.length >= 6 && a === b;
          pwBtn.disabled = !ok;
          if (!a && !b){ clearMsg(); return; }
          if (a !== b) showMsg("A két jelszó nem egyezik.", "err");
          else if (a.length < 6) showMsg("Legalább 6 karakteres legyen a jelszó.", "err");
          else clearMsg();
        }
        pw1.addEventListener("input", validatePw);
        pw2.addEventListener("input", validatePw);

        pwBtn.addEventListener("click", async ()=>{
          const newPw = pw1.value.trim();
          if (newPw.length < 6 || newPw !== pw2.value.trim()) return;
          try{
            await updatePassword(user, newPw);
            showMsg("Jelszó sikeresen módosítva.");
            pw1.value = ""; pw2.value = ""; validatePw();
          }catch(err){
            if (err?.code === "auth/requires-recent-login"){
              showMsg("Biztonsági okból kérlek jelentkezz ki és be újra, majd próbáld meg ismét.", "err");
            }else{
              showMsg("Hiba a jelszó módosításakor: " + (err?.message || ""), "err");
            }
          }
        });

        // ÚJ: emlékeztető toggle mentése
        reminderToggle.addEventListener("change", async ()=>{
          try{
            await setDoc(userRef, { reminderEmailUcl: reminderToggle.checked }, { merge:true });
            reminderHint.textContent = reminderToggle.checked
              ? "Emlékeztető bekapcsolva. Csak akkor megy e-mail, ha 12 órával a forduló első meccse előtt még nem tippeltél minden meccsre."
              : "Emlékeztető kikapcsolva.";
          }catch(e){
            reminderHint.textContent = "Hiba a beállítás mentésekor.";
          }
        });

        // Menü badge
        updatePendingBadge();

        // Chat (UCL)
        initChat(userRef);

        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(() => window.location.href = "login_ucl.html");
      });
    });

    /* ---------------- Nav „függő tippek” badge (UCL) ---------------- */
    function updatePendingBadge(){
      getDocs(query(collection(db,"ucl_matches"), where("startTime", ">=", new Date()))).then(upcomingSnap=>{
        const upcoming = upcomingSnap.docs.map(d => ({ id:d.id, ...d.data() }));
        getDocs(query(collection(db,"ucl_tips"), where("user","==", currentUserEmail))).then(tipsSnap=>{
          const tippedIds = new Set();
          tipsSnap.forEach(x=>{ const t=x.data(); if(t?.matchId) tippedIds.add(t.matchId); });
          const pending = upcoming.filter(m => !tippedIds.has(m.id)).length;
          const badge = document.getElementById("tipsBadge");
          if (pending>0){ badge.textContent = pending; badge.hidden = false; } else { badge.hidden = true; }
        });
      });
    }

    /* ---------------- Chat (UCL külön: chatMessages_ucl + chatLastSeenUcl) ---------------- */
    function initChat(userRef){
      const fab = document.getElementById('chatToggle');
      const fabBadge = document.getElementById('chatFabBadge');
      const panel = document.getElementById('chatPanel');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatMessages');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSendBtn');

      function open(){ panel.classList.add('open'); setTimeout(()=>inputEl?.focus(), 50); markSeen(); }
      function close(){ panel.classList.remove('open'); }
      function toggle(){ panel.classList.contains('open') ? close() : open(); }
      fab.addEventListener('click', toggle);
      closeBtn.addEventListener('click', close);

      let lastSeenMs = chatLastSeenUcl?.toMillis ? chatLastSeenUcl.toMillis() : 0;

      const qAll = query(collection(db,'chatMessages_ucl'), orderBy('ts','asc')); // <-- UCL kollekció
      onSnapshot(qAll, snap => {
        listEl.innerHTML = '';
        if (snap.empty){
          const empty = document.createElement('div');
          empty.className = 'chat-empty';
          empty.textContent = 'Még nincs üzenet. Légy te az első!';
          listEl.appendChild(empty);
        } else {
          let unread = 0;
          snap.forEach(docu=>{
            const d = docu.data();
            const tsMs = d.ts?.toMillis?.() || 0;
            if (tsMs > lastSeenMs) unread++;

            const row = document.createElement('div');
            row.className = 'msg';
            row.innerHTML = `
              <div style="flex:1 1 auto">
                <div class="meta"><strong>${escapeHtml(d.nick || 'Ismeretlen')}</strong> • ${d.ts ? fmtTime(d.ts) : ''}</div>
                <div class="text">${(d.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
              </div>
            `;
            const canDelete = (currentUserRole === 'admin') || (d.email === currentUserEmail);
            if (canDelete){
              const del = document.createElement('button');
              del.className = 'del';
              del.textContent = 'Törlés';
              del.title = 'Üzenet törlése';
              del.addEventListener('click', async ()=>{
                try{ await deleteDoc(doc(db, 'chatMessages_ucl', docu.id)); }catch(e){}
              });
              row.appendChild(del);
            }
            listEl.appendChild(row);
          });

          if (!panel.classList.contains('open') && unread > 0){
            fab.classList.add('has-unread');
            fabBadge.textContent = unread > 99 ? '99+' : String(unread);
          } else {
            fab.classList.remove('has-unread');
            fabBadge.textContent = '';
          }

          setTimeout(()=>{ listEl.scrollTop = listEl.scrollHeight; }, 0);
        }
      });

      sendBtn.addEventListener('click', async ()=>{
        const txt = (inputEl.value || '').trim();
        if (!txt){ inputEl.focus(); return; }
        const backup = txt;
        inputEl.value = '';
        try{
          await addDoc(collection(db,'chatMessages_ucl'), { // <-- UCL kollekció
            email: currentUserEmail, nick: currentUserNick || 'Ismeretlen', text: backup, ts: serverTimestamp()
          });
          if (panel.classList.contains('open')) await markSeen();
        }catch(e){
          inputEl.value = backup; inputEl.focus();
        }
      });
      inputEl.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
      });

      async function markSeen(){
        try{
          await setDoc(userRef, { chatLastSeenUcl: serverTimestamp() }, { merge:true }); // <-- UCL mező
          lastSeenMs = Date.now();
          fab.classList.remove('has-unread');
          fabBadge.textContent = '';
        }catch(e){}
      }
    }
  </script>
</head>
<body>
  <div class="layout">
    <!-- Fejléc -->
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>BL TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>

        <!-- Ligaváltó (NB I ↔ BL). NB I: profile.html, BL: profile_ucl.html -->
        <div class="league-switch" role="tablist" aria-label="Liga váltó">
          <a class="ls-tab" role="tab" href="profile.html" aria-selected="false">NB I</a>
          <a class="ls-tab is-active" role="tab" href="profile_ucl.html" aria-selected="true">BL</a>
        </div>
      </div>

      <!-- JOBB OLDAL: kilépés -->
      <div style="display:flex; align-items:center; gap:10px;">
        <button id="logout" class="btn-accent" aria-label="Kilépés">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-3px;margin-right:6px">
            <path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2z"/>
          </svg>
          Kilépés
        </button>
      </div>
    </div>

    <nav class="nav-grid">
      <!-- Főoldal kártya -->
      <a class="nav-card" href="dashboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3L12 3z"/>
          </svg>
        </div>
        <div class="text">
          <span class="title">Főoldal</span>
          <span class="desc">Tabella, hírek, kedvencek</span>
        </div>
      </a>

      <!-- Szezon végi sorrend / Top8 -->
      <a class="nav-card" href="positions_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg>
        </div>
        <div class="text">
          <span class="title">
            Szezon végi sorrend
            <span id="top8CountdownNav" class="pill-badge countdown" hidden></span>
          </span>
          <span class="desc">Ligafázis Top 8, győztes, gólkirály</span>
        </div>
      </a>

      <!-- Meccstippek -->
      <a class="nav-card" href="matches_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1.7 3.5 1.7-1.2 1.7 1.2-.6 2 1.6 1.2h-2L12 7.2l-1.7 1.5h-2l1.6-1.2-.6-2ZM6.2 9.3l1.9-.3.9 1.7-.8 1.8-1.8.2-1.2-1.6 1-1.8Zm11.6 0 1 1.8-1.2 1.6-1.8-.2-.8-1.8.9-1.7 1.9.3ZM8.9 17.9l-.7-1.9 1.5-1.2h1.9l.9 1.7-1.5 1.4-2.1 0Zm6.2 0-2.1 0-1.5-1.4.9-1.7h1.9l1.5 1.2-.7 1.9Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span>
          <span class="desc">Közelgő meccsek & tippek</span>
        </div>
      </a>

      <!-- Eredmények -->
      <a class="nav-card" href="results_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Eredmények</span>
          <span class="desc">Fordulónkénti bontás</span>
        </div>
      </a>

      <!-- Összpontszám -->
      <a class="nav-card" href="leaderboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h3a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Összpontszám</span>
          <span class="desc">Toplista & bónusz</span>
        </div>
      </a>

      <!-- Profil -->
      <a class="nav-card" href="profile_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Profil</span>
          <span class="desc">Beállítások & kedvenc csapat</span>
        </div>
      </a>

      <!-- Admin a végén -->
      <a class="nav-card" id="adminLink" href="admin_ucl.html" style="display:none;">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Zm8.94 4a6.94 6.94 0 0 0-.12-1l2.02-1.56-2-3.46-2.44 1a6.9 6.9 0 0 0-1.74-1l-.37-2.6H9.71l-.37-2.6a6.9 6.9 0 0 0-1.74 1l-2.44-1-2 3.46L5.18 11a7 7 0 0 0 0 2l-2.02 1.56 2 3.46 2.44-1a6.9 6.9 0 0 0 1.74 1l.37 2.6h4.56l.37-2.6a6.9 6.9 0 0 0 1.74-1l2.44 1 2-3.46L20.82 13a6.94 6.94 0 0 0 .12-1Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Admin</span>
          <span class="desc">Szezon-zár & beállítások</span>
        </div>
      </a>
    </nav>

    <!-- Profil kártya -->
    <section class="card">
      <h3>Felhasználói adatok</h3>
      <div class="form">
        <div class="row">
          <label>E-mail</label>
          <div id="email" class="hint"></div>
        </div>

        <div class="row">
          <label for="nick">Becenév</label>
          <div class="row-inline">
            <input id="nick" class="inp" type="text" placeholder="Becenév (opcionális)">
            <button id="saveNick" class="btn">Mentés</button>
          </div>
          <div class="hint">Ha üresen hagyod, az e-mail jelenik meg névként.</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Kedvenc csapat</h3>
      <div class="form">
        <div class="row-inline">
          <select id="favoriteTeamSelect" class="inp" style="max-width:520px"></select>
          <button id="saveTeam" class="btn">Mentés</button>
          <span class="team-preview">
            <img id="favoriteTeamLogo" class="crest" alt="" />
          </span>
        </div>
        <div class="hint">A felület színezése és néhány ikon a kedvenc csapathoz igazodik.</div>
      </div>
    </section>

    <!-- ÚJ: Emlékeztető e-mail kapcsoló -->
    <section class="card">
      <h3>Emlékeztető e-mail</h3>
      <div class="form">
        <div class="row-inline">
          <label style="display:flex;align-items:center;gap:10px;">
            <input id="reminderEmailUcl" type="checkbox">
            <span>E-mailes emlékeztetőt kérek</span>
          </label>
        </div>
        <div id="reminderHint" class="hint">
          Ha be van kapcsolva, <strong>csak akkor</strong> küldünk e-mailt, ha a forduló első meccsének kezdete előtt <strong>12 órával</strong> még <strong>nem tippeltél minden meccsre</strong>.
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Jelszó megváltoztatása</h3>
      <div class="form">
        <div class="row-inline">
          <input id="newPassword" class="inp" type="password" placeholder="Új jelszó (min. 6 karakter)">
          <input id="newPassword2" class="inp" type="password" placeholder="Új jelszó ismét">
          <button id="changePasswordBtn" class="btn-accent" disabled>Jelszó módosítása</button>
        </div>
        <div id="message" class="hint"></div>
      </div>
    </section>
  </div>

  <!-- Chat -->
  <button id="chatToggle" class="chat-fab" title="Közösségi chat">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M4 4h16a2 2 0 0 1 2 2v11a2 2 0 0 1 2 2H8l-4 3V6a2 2 0 0 1 2-2Z"/>
    </svg>
    <span id="chatFabBadge" class="fab-badge"></span>
  </button>

  <section id="chatPanel" class="chat-panel" aria-label="Közösségi chat">
    <div class="chat-head">
      <div class="chat-title">Közösségi chat</div>
      <button id="chatClose" aria-label="Bezárás">✕</button>
    </div>
    <div id="chatMessages" class="chat-list" role="log" aria-live="polite"></div>
    <div id="chatComposer">
      <input id="chatInput" type="text" placeholder="Írj valamit…" autocomplete="off">
      <button id="chatSendBtn">Küldés</button>
    </div>
  </section>
</body>
</html>
