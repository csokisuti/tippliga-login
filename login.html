<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Bejelentkezés / Regisztráció</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e6eaf1;--accent:#3b82f6}
    body{background:var(--bg);color:var(--text);margin:0}
    .page{max-width:980px;margin:32px auto;padding:0 16px;display:flex;flex-direction:column;gap:16px}

    .notice{display:none;padding:10px 12px;border-radius:10px;border:1px solid var(--line);margin:0 0 10px}
    .notice.show{display:block}
    .notice.success{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .notice.error{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}

    .login-container{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,.06);padding:18px}
    .login-container h3{margin:6px 0 12px}
    .login-container input{width:100%;height:42px;border:1px solid var(--line);border-radius:10px;padding:8px 10px;box-sizing:border-box;margin:6px 0}
    .login-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{min-height:40px;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff;border:1px solid var(--line);box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .btn-ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(.25)}

    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,.06);overflow:hidden}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);background:#f7f9fd}
    .card .body{padding:12px}

    /* Liga blokk a login dobozon BELÜL */
    .league-block{margin-top:10px}
    .league-title{display:flex;align-items:center;gap:8px;font-weight:800;margin:10px 0 8px}
    .nav-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:700px){.nav-grid{grid-template-columns:1fr}}
    .select-card{position:relative;display:flex;align-items:center;gap:12px;text-align:left;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(15,23,42,.05);cursor:pointer;transition:.15s ease}
    .select-card:hover{transform:translateY(-2px)}

    /* PERSISTENS kijelölés – NEM hover-függő. Erős specifikáció + !important, hogy bármilyen alapstílust felülírjon. */
    .select-card[data-selected="true"]{
      border-color: color-mix(in oklab,var(--accent) 55%, white) !important;
      background: color-mix(in oklab, var(--accent) 12%, white) !important;
      outline: 2px solid color-mix(in oklab,var(--accent) 40%, white) !important;
      outline-offset: 2px !important;
      box-shadow: 0 6px 18px rgba(15,23,42,.08) !important;
    }
    .select-card[data-selected="true"] .title{color:#0f172a !important}
    .select-card[data-selected="true"] .desc{color:#475569 !important}

    /* MINDIG LÁTSZÓDJON a tartalom – soha ne legyen áttetsző/eltüntetve */
    .select-card .logo-wrap,
    .select-card .text,
    .select-card .title,
    .select-card .desc,
    .select-card .dot{width:14px;height:14px;border-radius:999px;border:2px solid color-mix(in oklab,var(--accent) 45%, white);background:transparent;margin-left:auto;transition:background .12s ease, border-color .12s ease;opacity:1 !important;visibility:visible !important}

    .logo-wrap{width:68px;height:68px;border-radius:14px;background:#fff;border:1px solid var(--line);display:flex;align-items:center;justify-content:center}
    .logo-wrap img{max-width:60px;max-height:60px}
    .text{display:flex;flex-direction:column;line-height:1.2}
    .title{font-weight:800}
    .desc{color:var(--muted);font-size:12px}
    .dot{width:14px;height:14px;border-radius:999px;box-shadow:inset 0 0 0 2px color-mix(in oklab,var(--accent) 40%, white);background:transparent;margin-left:auto;transition:background .12s ease}
    .dot.active{background:var(--accent);border-color:var(--accent)}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="page">
    <div id="notice" class="notice" role="status" aria-live="polite"></div>

    <!-- LOGIN doboz: mezők + LIGA VÁLASZTÓ (egyben) -->
    <div class="login-container">
      <h3>Bejelentkezés</h3>
      <input type="email" id="email" placeholder="Email:">
      <input type="password" id="password" placeholder="Jelszó:">

      <!-- Liga választó KÖZVETLENÜL a login alatt -->
      <div class="league-block" aria-label="Liga választó">
        <div class="league-title">Válaszd ki a ligát</div>
        <div class="nav-grid">
          <button class="select-card" data-league="nb1" aria-pressed="false" data-selected="false">
            <span class="logo-wrap">
              <img src="fizz.png" alt="NB I – Fizz Liga logó" onerror="this.onerror=null;this.src='fizz.svg'">
            </span>
            <span class="text">
              <span class="title">NB I TippLiga</span>
              <span class="desc">Hazai bajnokság</span>
            </span>
            <span class="dot" aria-hidden="true"></span>
          </button>

          <button class="select-card" data-league="ucl" aria-pressed="false" data-selected="false">
            <span class="logo-wrap">
              <img src="ucl.png" alt="UEFA Champions League logó" onerror="this.onerror=null;this.src='ucl.svg'">
            </span>
            <span class="text">
              <span class="title">BL TippLiga</span>
              <span class="desc">Bajnokok Ligája</span>
            </span>
            <span class="dot" aria-hidden="true"></span>
          </button>
        </div>
        <div id="leagueHint" class="hint">A belépés gomb a liga kiválasztása után aktiválódik.</div>
      </div>

      <div class="login-actions">
        <button id="loginBtn" class="btn btn-primary" onclick="login()" disabled>Bejelentkezés</button>
        <button class="btn btn-ghost" onclick="toggleRegister()">⇩ Regisztráció</button>
      </div>
    </div>

    <!-- REGISZTRÁCIÓ: külön kártyaként LENT -->
    <section id="registerCard" class="card" style="display:none" aria-label="Regisztráció">
      <h3>Regisztráció</h3>
      <div class="body">
        <input type="text" id="nickname" placeholder="Becenév">
        <input type="email" id="regEmail" placeholder="Email">
        <input type="password" id="regPassword" placeholder="Jelszó">
        <input type="password" id="regConfirmPassword" placeholder="Jelszó újra">
        <div style="margin-top:10px">
          <button class="btn btn-primary" onclick="register()">Regisztráció</button>
          <button class="btn btn-ghost" onclick="toggleRegister(false)">Mégse</button>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.firebasestorage.app",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function showNotice(msg, type='success', timeoutMs=3000){
      const n = document.getElementById('notice');
      if(!n) return;
      n.textContent = msg;
      n.className = `notice show ${type}`;
      if(timeoutMs){ setTimeout(()=>{ n.className = 'notice'; n.textContent=''; }, timeoutMs); }
    }

    let selectedLeague = null; // 'nb1' | 'ucl'
    function computeTarget(league){ if(league==='ucl') return 'dashboard_ucl.html'; if(league==='nb1') return 'dashboard.html'; return ''; }
    function setSelectedLeague(code){
      selectedLeague = code;
      document.querySelectorAll('.select-card').forEach(btn => {
        const active = btn.getAttribute('data-league') === code;
        btn.setAttribute('aria-pressed', active ? 'true' : 'false');
        btn.setAttribute('data-selected', active ? 'true' : 'false');
        btn.querySelector('.dot')?.classList.toggle('active', active);
      });
      document.getElementById('loginBtn').disabled = !selectedLeague;
      // mentés, hogy visszatöltse legközelebb
      try{ localStorage.setItem('lastLeague', code || ''); }catch{}
    }

    // induláskor visszatöltjük az utolsó választást (ha volt)
    try{
      const last = localStorage.getItem('lastLeague');
      if(last === 'nb1' || last === 'ucl'){ setSelectedLeague(last); }
    }catch{}

    // Liga kártyák események
    document.querySelectorAll('.select-card').forEach(btn => {
      btn.addEventListener('click', () => setSelectedLeague(btn.getAttribute('data-league')));
    });

    // Regisztrációs kártya mutatása/elrejtése
    window.toggleRegister = function (force){
      const card = document.getElementById('registerCard');
      const show = (typeof force === 'boolean') ? force : (card.style.display==='none');
      card.style.display = show ? 'block' : 'none';
      if(show){ card.scrollIntoView({ behavior:'smooth', block:'start' }); }
    }

    window.register = async function () {
      const nickname = document.getElementById('nickname').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;

      if (!nickname || !email || !password || !confirmPassword) { alert('Minden mezőt ki kell tölteni.'); return; }
      if (password !== confirmPassword) { alert('A jelszavak nem egyeznek.'); return; }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const profile = { email, nickname, role: 'user', uid: user.uid };
        try { await setDoc(doc(db, 'users', user.email), profile, { merge: true }); }
        catch (permErr) { console.warn('Profil mentése users/{email} alatt nem sikerült (rules?):', permErr); }

        showNotice('Sikeres regisztráció! Jelentkezz be az e-mail címeddel és jelszavaddal.', 'success', 6000);
        toggleRegister(false);
        const loginEmail = document.getElementById('email');
        const loginPass = document.getElementById('password');
        if (loginEmail) loginEmail.value = email;
        if (loginPass) loginPass.value = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        loginEmail?.focus();
      } catch (error) {
        showNotice('Hiba: ' + error.message, 'error', 6000);
      }
    }

    window.login = async function () {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { alert('Add meg az email címed és a jelszavad.'); return; }
      if (!selectedLeague) { alert('Válaszd ki a ligát a belépéshez.'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        window.location.href = computeTarget(selectedLeague);
      } catch (error) { showNotice('Hiba a bejelentkezéskor: ' + error.message, 'error', 6000); }
    }

    // Rövid önellenőrzés
    try{
      console.assert(computeTarget('nb1')==='dashboard.html','nb1 → dashboard.html');
      console.assert(computeTarget('ucl')==='dashboard_ucl.html','ucl → dashboard_ucl.html');
      console.assert(computeTarget(null)==='', 'null → empty');
      setSelectedLeague(null);
      console.assert(document.getElementById('loginBtn').disabled===true,'login disabled no league');
      setSelectedLeague('nb1');
      console.assert(document.getElementById('loginBtn').disabled===false,'login enabled after select');
      console.log('Login layout tesztek: OK');
    }catch(e){ console.error('Teszt hiba:', e); }
  </script>
</body>
</html>
