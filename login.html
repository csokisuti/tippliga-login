<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Bejelentkezés / Regisztráció</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e6eaf1;--accent:#3b82f6}
    body{background:var(--bg);color:var(--text);margin:0}
    .page{max-width:980px;margin:32px auto;padding:0 16px;display:flex;flex-direction:column;gap:16px}

    .notice{display:none;padding:10px 12px;border-radius:10px;border:1px solid var(--line);margin:0 0 10px}
    .notice.show{display:block}
    .notice.success{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}
    .notice.error{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}

    .login-container{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,.06);padding:18px}
    .login-container h3{margin:6px 0 12px}
    .login-container input{width:100%;height:42px;border:1px solid var(--line);border-radius:10px;padding:8px 10px;box-sizing:border-box;margin:6px 0}
    .login-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .btn{min-height:40px;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff;border:1px solid var(--line);box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .btn-ghost{background:#fff;color:#111;border:1px solid var(--line)}
    .btn[disabled]{opacity:.55;cursor:not-allowed;filter:grayscale(.25)}

    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,.06);overflow:hidden}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);background:#f7f9fd}
    .card .body{padding:12px}

    /* ===== Liga blokk a login dobozon BELÜL ===== */
    .league-block{margin-top:10px}
    .league-title{display:flex;align-items:center;gap:8px;font-weight:800;margin:10px 0 8px}
    .league-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:700px){.league-grid{grid-template-columns:1fr}}

    /* IMPORTANT: teljesen NEM generikus osztálynevek, hogy ne ütközzenek a global style.css-sel */
    .league-option{position:relative;display:flex;align-items:center;gap:14px;text-align:left;padding:12px;border:1px solid var(--line);border-radius:14px;background:#fff;box-shadow:0 6px 18px rgba(15,23,42,.05);cursor:pointer;transition:box-shadow .12s ease,border-color .12s ease, background .12s ease}
    .league-option:hover{box-shadow:0 8px 20px rgba(15,23,42,.08)}

    /* Tartós kiemelés – nem hover; nincs outline, hogy ne legyen "dupla keret" hatás */
    .league-option[data-selected="true"]{border-color:color-mix(in oklab,var(--accent) 45%, white);background:color-mix(in oklab,var(--accent) 10%, white)}

    .league-logo{width:68px;height:68px;border-radius:14px;background:#fff;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;flex:0 0 68px}
    .league-logo img{max-width:60px;max-height:60px}

    .league-copy{display:flex;flex-direction:column;line-height:1.2;flex:1 1 auto;min-width:0}
    .league-name{font-weight:800;color:#0f172a}
    .league-sub{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .league-radio{width:16px;height:16px;border-radius:999px;border:2px solid color-mix(in oklab,var(--accent) 45%, white);background:#fff;flex:0 0 16px}
    .league-radio.is-active{background:var(--accent);border-color:var(--accent)}

    .hint{color:var(--muted);font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="page">
    <div id="notice" class="notice" role="status" aria-live="polite"></div>

    <!-- LOGIN doboz: mezők + LIGA VÁLASZTÓ (egyben) -->
    <div class="login-container">
      <h3>Bejelentkezés</h3>
      <input type="email" id="email" placeholder="Email:">
      <input type="password" id="password" placeholder="Jelszó:">

      <!-- Liga választó KÖZVETLENÜL a login alatt -->
      <div class="league-block" aria-label="Liga választó">
        <div class="league-title">Válaszd ki a ligát</div>
        <div class="league-grid">
          <button class="league-option" data-league="nb1" data-selected="false">
            <span class="league-logo">
              <img src="fizz.png" alt="NB I – Fizz Liga logó" onerror="this.onerror=null;this.src='fizz.svg'">
            </span>
            <span class="league-copy">
              <span class="league-name">NB I TippLiga</span>
              <span class="league-sub">Hazai bajnokság</span>
            </span>
            <span class="league-radio" aria-hidden="true"></span>
          </button>

          <button class="league-option" data-league="ucl" data-selected="false">
            <span class="league-logo">
              <img src="ucl.png" alt="UEFA Champions League logó" onerror="this.onerror=null;this.src='ucl.svg'">
            </span>
            <span class="league-copy">
              <span class="league-name">BL TippLiga</span>
              <span class="league-sub">Bajnokok Ligája</span>
            </span>
            <span class="league-radio" aria-hidden="true"></span>
          </button>
        </div>
        <div id="leagueHint" class="hint">A belépés gomb a liga kiválasztása után aktiválódik.</div>
      </div>

      <div class="login-actions">
        <button id="loginBtn" class="btn btn-primary" onclick="login()" disabled>Bejelentkezés</button>
        <button class="btn btn-ghost" onclick="toggleRegister()">⇩ Regisztráció</button>
      </div>
    </div>

    <!-- REGISZTRÁCIÓ: külön kártyaként LENT -->
    <section id="registerCard" class="card" style="display:none" aria-label="Regisztráció">
      <h3>Regisztráció</h3>
      <div class="body">
        <input type="text" id="nickname" placeholder="Becenév">
        <input type="email" id="regEmail" placeholder="Email">
        <input type="password" id="regPassword" placeholder="Jelszó">
        <input type="password" id="regConfirmPassword" placeholder="Jelszó újra">
        <div style="margin-top:10px">
          <button class="btn btn-primary" onclick="register()">Regisztráció</button>
          <button class="btn btn-ghost" onclick="toggleRegister(false)">Mégse</button>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.firebasestorage.app",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function showNotice(msg, type='success', timeoutMs=3000){
      const n = document.getElementById('notice');
      if(!n) return;
      n.textContent = msg;
      n.className = `notice show ${type}`;
      if(timeoutMs){ setTimeout(()=>{ n.className = 'notice'; n.textContent=''; }, timeoutMs); }
    }

    // --- Liga kiválasztás logika (NEM generikus osztályokra támaszkodik) ---
    let selectedLeague = null; // 'nb1' | 'ucl'
    function computeTarget(l){ return l==='ucl' ? 'dashboard_ucl.html' : (l==='nb1' ? 'dashboard.html' : ''); }
    function setSelectedLeague(code){
      selectedLeague = code;
      document.querySelectorAll('.league-option').forEach(btn => {
        const active = btn.getAttribute('data-league') === code;
        btn.setAttribute('data-selected', active ? 'true' : 'false');
        const r = btn.querySelector('.league-radio');
        if(r){ r.classList.toggle('is-active', active); }
      });
      const loginBtn = document.getElementById('loginBtn');
      if(loginBtn) loginBtn.disabled = !selectedLeague;
      try{ localStorage.setItem('lastLeague', code || ''); }catch{}
    }

    // Induláskor visszatöltjük az utolsó választást
    try{ const last = localStorage.getItem('lastLeague'); if(last==='nb1'||last==='ucl'){ setSelectedLeague(last); } }catch{}

    // Kattintáskezelő
    document.querySelectorAll('.league-option').forEach(btn => {
      btn.addEventListener('click', () => setSelectedLeague(btn.getAttribute('data-league')));
    });

    // Regisztrációs kártya mutatása/elrejtése
    window.toggleRegister = function (force){
      const card = document.getElementById('registerCard');
      const show = (typeof force === 'boolean') ? force : (card.style.display==='none');
      card.style.display = show ? 'block' : 'none';
      if(show){ card.scrollIntoView({ behavior:'smooth', block:'start' }); }
    }

    // --- Regisztráció ---
    window.register = async function () {
      const nickname = document.getElementById('nickname').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;
      const confirmPassword = document.getElementById('regConfirmPassword').value;
      if (!nickname || !email || !password || !confirmPassword) { alert('Minden mezőt ki kell tölteni.'); return; }
      if (password !== confirmPassword) { alert('A jelszavak nem egyeznek.'); return; }
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const profile = { email, nickname, role: 'user', uid: user.uid };
        try { await setDoc(doc(db, 'users', user.email), profile, { merge: true }); }
        catch (permErr) { console.warn('Profil mentése users/{email} alatt nem sikerült (rules?):', permErr); }
        showNotice('Sikeres regisztráció! Jelentkezz be az e-mail címeddel és jelszavaddal.', 'success', 6000);
        toggleRegister(false);
        const loginEmail = document.getElementById('email');
        const loginPass = document.getElementById('password');
        if (loginEmail) loginEmail.value = email;
        if (loginPass) loginPass.value = '';
        window.scrollTo({ top: 0, behavior: 'smooth' });
        loginEmail?.focus();
      } catch (error) {
        showNotice('Hiba: ' + error.message, 'error', 6000);
      }
    }

    // --- Bejelentkezés ---
    window.login = async function () {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) { alert('Add meg az email címed és a jelszavad.'); return; }
      if (!selectedLeague) { alert('Válaszd ki a ligát a belépéshez.'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        window.location.href = computeTarget(selectedLeague);
      } catch (error) { showNotice('Hiba a bejelentkezéskor: ' + error.message, 'error', 6000); }
    }

    // Rövid önellenőrzés
    try{
      console.assert(computeTarget('nb1')==='dashboard.html','nb1 → dashboard.html');
      console.assert(computeTarget('ucl')==='dashboard_ucl.html','ucl → dashboard_ucl.html');
      console.assert(computeTarget(null)==='', 'null → empty');
      setSelectedLeague(null);
      console.assert(document.getElementById('loginBtn').disabled===true,'login disabled no league');
      setSelectedLeague('nb1');
      console.assert(document.getElementById('loginBtn').disabled===false,'login enabled after select');
      setSelectedLeague(null);
      console.log('Login layout tesztek: OK');
    }catch(e){ console.error('Teszt hiba:', e); }
  </script>
</body>
</html>
