<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .round-section {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .round-header {
      background-color: #f0f0f0;
      padding: 10px;
      cursor: pointer;
      font-weight: bold;
    }
    .match-container {
      padding: 10px;
      border-top: 1px solid #ccc;
    }
    .match-header {
      font-weight: bold;
      margin-bottom: 6px;
    }
    .outcome {
      display: inline-block;
      margin-left: 8px;
      padding: 2px 6px;
      background-color: #ddd;
      border-radius: 4px;
      font-size: 0.85em;
    }
    .tip-row {
      padding: 6px;
      margin: 4px 0;
      border-radius: 4px;
    }
    .correct {
      background-color: #d4edda;
    }
    .wrong {
      background-color: #f8d7da;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const resultsDiv = document.getElementById("results");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const matchesSnapshot = await getDocs(collection(db, "matches"));
      const tipsSnapshot = await getDocs(collection(db, "tips"));
      const usersSnapshot = await getDocs(collection(db, "users"));

      const matches = {};
      matchesSnapshot.forEach(doc => matches[doc.id] = { id: doc.id, ...doc.data() });

      const users = {};
      usersSnapshot.forEach(doc => users[doc.id] = doc.data().nickname || doc.data().email || doc.id);

      const tipsByRound = {};
      tipsSnapshot.forEach(doc => {
        const tip = doc.data();
        const match = matches[tip.matchId];
        if (!match || !match.result || !match.outcome) return;

        const roundId = match.roundId;
        if (!tipsByRound[roundId]) tipsByRound[roundId] = {};
        if (!tipsByRound[roundId][tip.matchId]) {
          tipsByRound[roundId][tip.matchId] = {
            match: match,
            tips: []
          };
        }
        tipsByRound[roundId][tip.matchId].tips.push({
          userId: tip.userId,
          tip: tip.tip,
          isDouble: tip.isDouble
        });
      });

      const sortedRounds = Object.keys(tipsByRound).sort((a, b) => b - a);

      sortedRounds.forEach(roundId => {
        const roundSection = document.createElement("div");
        roundSection.className = "round-section";

        const header = document.createElement("div");
        header.className = "round-header";
        header.textContent = `Forduló ${roundId}`;
        header.addEventListener("click", () => {
          content.style.display = content.style.display === "none" ? "block" : "none";
        });

        const content = document.createElement("div");
        content.style.display = "none";

        const matchGroup = tipsByRound[roundId];
        for (const matchId in matchGroup) {
          const { match, tips } = matchGroup[matchId];

          const matchDiv = document.createElement("div");
          matchDiv.className = "match-container";

          const matchHeader = document.createElement("div");
          matchHeader.className = "match-header";
          matchHeader.innerHTML = `${match.homeTeam} - ${match.awayTeam}: ${match.result} <span class="outcome">(${match.outcome})</span>`;
          matchDiv.appendChild(matchHeader);

          tips.forEach(tip => {
            const tipRow = document.createElement("div");
            tipRow.className = "tip-row";

            const correct = tip.tip === match.outcome;
            tipRow.classList.add(correct ? "correct" : "wrong");

            const user = users[tip.userId] || tip.userId;
            let pointText = "";
            if (correct && match.odds && match.odds[tip.tip]) {
              const base = tip.isDouble ? 2 : 1;
              const point = base * match.odds[tip.tip];
              pointText = ` (+${point} pont)`;
            }

            tipRow.textContent = `${user}: ${tip.tip}${tip.isDouble ? " (dupla)" : ""}${pointText}`;
            matchDiv.appendChild(tipRow);
          });

          content.appendChild(matchDiv);
        }

        roundSection.appendChild(header);
        roundSection.appendChild(content);
        resultsDiv.appendChild(roundSection);
      });
    });
  </script>
</head>
<body>
  <h1>Eredmények</h1>
  <div id="results"></div>
</body>
</html>

