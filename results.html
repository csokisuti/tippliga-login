<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
    h1, h2 { margin-top: 30px; }
    .match { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 0 5px #ccc; }
    .tip { margin-left: 20px; padding: 8px; border-radius: 6px; background: #eef; margin-top: 5px; }
    .correct { background: #d4edda; }
    .bold { font-weight: bold; }
    .hidden { display: none; }
    select { padding: 6px; margin-bottom: 20px; }
    .team-row { display: flex; align-items: center; gap: 8px; font-size: 1.1em; }
    .crest { height: 28px; width: 28px; object-fit: contain; }
    .back-btn { margin-bottom: 20px; display: inline-block; background: #007bff; color: white; padding: 10px 15px; border-radius: 6px; text-decoration: none; }
    .summary { font-weight: bold; background: #ffd; padding: 10px; border-radius: 8px; margin: 10px 0; }
    .summary span { margin-right: 15px; cursor: help; }
  </style>
</head>
<body>
  <a href="dashboard.html" class="back-btn">← Vissza a főoldalra</a>
  <h1>Eredmények</h1>
  <label for="roundSelector">Válassz fordulót:</label>
  <select id="roundSelector"></select>
  <div id="resultsContainer">Betöltés...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const crestMap = {
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Diósgyőri VTK": "crest/crest-dvtk.png",
      "Ferencváros": "crest/crest-fradi.png",
      "ETO FC Győr": "crest/crest-gyor.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Kisvárda FC": "crest/crest-kisvarda.png",
      "MTK Budapest": "crest/crest-mtk.png",
      "Nyíregyháza Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Puskás Akadémia": "crest/crest-puskas.png",
      "Újpest FC": "crest/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const resultsContainer = document.getElementById('resultsContainer');
    const roundSelector = document.getElementById('roundSelector');

    function formatDate(ts) {
      try {
        return ts.toDate().toLocaleString("hu-HU");
      } catch {
        return "Ismeretlen időpont";
      }
    }

    onAuthStateChanged(auth, async user => {
      if (!user) {
        resultsContainer.innerHTML = "<p>Be kell jelentkezned az eredmények megtekintéséhez.</p>";
        return;
      }

      const [matchesSnap, tipsSnap, usersSnap] = await Promise.all([
        getDocs(collection(db, "matches")),
        getDocs(collection(db, "tips")),
        getDocs(collection(db, "users"))
      ]);

      const matches = {};
      matchesSnap.forEach(doc => matches[doc.id] = { id: doc.id, ...doc.data() });

      const users = {};
      usersSnap.forEach(doc => users[doc.id] = doc.data().nickname || "Ismeretlen");

      const rounds = {};

      tipsSnap.forEach(doc => {
        const tip = doc.data();
        const match = matches[tip.matchId];
        if (!match || !match.outcome || !match.odds) return;

        const roundId = match.roundId || "Egyéb";
        if (!rounds[roundId]) rounds[roundId] = {};
        if (!rounds[roundId][match.id]) {
          rounds[roundId][match.id] = {
            match,
            tips: []
          };
        }

        const isCorrect = match.outcome === tip.tip;
        const oddsValue = match.odds[tip.tip];
        const point = (oddsValue || 0) * (tip.isDouble ? 2 : 1);

        rounds[roundId][match.id].tips.push({
          userId: tip.userId,
          nickname: users[tip.userId] || "Ismeretlen",
          tip: tip.tip,
          isDouble: tip.isDouble,
          correct: isCorrect,
          odds: oddsValue,
          point: isCorrect ? point : 0
        });
      });

      resultsContainer.innerHTML = "";
      roundSelector.innerHTML = "";

      const sortedRounds = Object.keys(rounds).sort((a, b) => parseInt(b) - parseInt(a));

      sortedRounds.forEach((roundId, idx) => {
        const option = document.createElement("option");
        option.value = roundId;
        option.textContent = roundId + ". forduló";
        if (idx === 0) option.selected = true;
        roundSelector.appendChild(option);

        const roundBlock = document.createElement("div");
        roundBlock.id = "round_" + roundId;
        if (idx !== 0) roundBlock.classList.add("hidden");

        const matchesInRound = rounds[roundId];

        const roundHeader = document.createElement("h2");
        roundHeader.textContent = roundId + ". forduló";
        roundBlock.appendChild(roundHeader);

        const scoreSummary = {};
        const scoreBreakdown = {};

        Object.values(matchesInRound).forEach(({ match, tips }) => {
          tips.forEach(t => {
            if (!scoreSummary[t.nickname]) {
              scoreSummary[t.nickname] = 0;
              scoreBreakdown[t.nickname] = [];
            }
            scoreSummary[t.nickname] += t.point;
            scoreBreakdown[t.nickname].push(`${match.homeTeam}–${match.awayTeam}: ${t.tip} → ${t.point.toFixed(2)} pont`);
          });
        });

        const summaryDiv = document.createElement("div");
        summaryDiv.className = "summary";
        summaryDiv.innerHTML = Object.entries(scoreSummary)
          .map(([nick, pt]) => {
            const tooltip = scoreBreakdown[nick].join('\n');
            return `<span title="${tooltip}">${nick}: ${pt.toFixed(2)} pont</span>`;
          }).join(" | ");
        roundBlock.appendChild(summaryDiv);

        Object.values(matchesInRound).forEach(({ match, tips }) => {
          const matchBlock = document.createElement("div");
          matchBlock.className = "match";

          const homeCrest = crestMap[match.homeTeam] || "";
          const awayCrest = crestMap[match.awayTeam] || "";

          matchBlock.innerHTML = `
            <div class="team-row">
              <img src="${homeCrest}" class="crest">
              <strong>${match.homeTeam}</strong> vs <strong>${match.awayTeam}</strong>
              <img src="${awayCrest}" class="crest">
            </div>
            <div>Eredmény: <span class="bold">${match.result || "?"}</span>, Kimenetel: <span class="bold">${match.outcome}</span></div>
            <div>Kezdés: ${formatDate(match.startTime)}</div>
            <div>Odds: 1 → ${match.odds["1"]}, X → ${match.odds["X"]}, 2 → ${match.odds["2"]}</div>
          `;

          tips.forEach(tip => {
            const tipDiv = document.createElement("div");
            tipDiv.className = "tip" + (tip.correct ? " correct" : "");
            tipDiv.innerHTML = `
              Tippelő: <strong>${tip.nickname}</strong> - 
              Tipp: ${tip.tip} ${tip.correct ? "✅" : "❌"} - 
              ${tip.isDouble ? "Dupla, " : ""}Odds: ${tip.odds ?? "-"}, 
              Pont: ${tip.point.toFixed(2)}
            `;
            matchBlock.appendChild(tipDiv);
          });

          roundBlock.appendChild(matchBlock);
        });

        resultsContainer.appendChild(roundBlock);
      });

      roundSelector.addEventListener("change", () => {
        sortedRounds.forEach(rid => {
          const section = document.getElementById("round_" + rid);
          if (section) section.classList.add("hidden");
        });
        const selected = roundSelector.value;
        const active = document.getElementById("round_" + selected);
        if (active) active.classList.remove("hidden");
      });
    });
  </script>
</body>
</html>
