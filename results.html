<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    h2 {
      background-color: #444;
      color: white;
      padding: 10px;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    .match-row {
      background-color: #f0f0f0;
      font-weight: bold;
    }
    .correct {
      background-color: #c8f7c5;
    }
    .incorrect {
      background-color: #f7c5c5;
    }
    .total-row {
      background-color: #eee;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const container = document.getElementById("results-container");

    function formatDate(timestamp) {
      try {
        const date = timestamp.toDate();
        return date.toLocaleString("hu-HU");
      } catch {
        return "Ismeretlen időpont";
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        container.innerHTML = "<p style='color: red;'>Be kell jelentkezned az eredmények megtekintéséhez.</p>";
        return;
      }

      try {
        const matchesSnap = await getDocs(collection(db, "matches"));
        const tipsSnap = await getDocs(collection(db, "tips"));

        const matches = [];
        matchesSnap.forEach(doc => {
          const data = doc.data();
          if (data.startTime && Timestamp.now().seconds >= data.startTime.seconds) {
            matches.push({ id: doc.id, ...data });
          }
        });

        const tipsByMatch = {};
        tipsSnap.forEach(doc => {
          const data = doc.data();
          if (!tipsByMatch[data.matchId]) tipsByMatch[data.matchId] = [];
          tipsByMatch[data.matchId].push({ id: doc.id, ...data });
        });

        const grouped = {};
        for (const match of matches) {
          const round = match.round || "Egyéb";
          if (!grouped[round]) grouped[round] = [];
          grouped[round].push(match);
        }

        const rounds = Object.keys(grouped).sort((a, b) => b - a);
        for (const round of rounds) {
          const section = document.createElement("div");
          const header = document.createElement("h2");
          header.textContent = `Forduló ${round}`;
          section.appendChild(header);

          const table = document.createElement("table");

          grouped[round].forEach(match => {
            const tr = document.createElement("tr");
            tr.className = "match-row";
            tr.innerHTML = `
              <td colspan="4">
                ${match.homeTeam} - ${match.awayTeam} (${match.result || "Nincs eredmény"})<br>
                Kezdés: ${formatDate(match.startTime)}<br>
                Odds: 1 - ${match.odds1}, X - ${match.oddsX}, 2 - ${match.odds2}
              </td>
            `;
            table.appendChild(tr);

            const roundPoints = {};

            if (tipsByMatch[match.id]) {
              tipsByMatch[match.id].forEach(tip => {
                const isCorrect = match.outcome && tip.prediction === match.outcome;
                const multiplier = tip.double ? 2 : 1;
                const odds = match["odds" + tip.prediction] || 1;
                const point = isCorrect ? multiplier * odds : 0;
                roundPoints[tip.userEmail] = (roundPoints[tip.userEmail] || 0) + point;

                const row = document.createElement("tr");
                row.className = isCorrect ? "correct" : "incorrect";
                row.innerHTML = `
                  <td>${tip.userEmail}</td>
                  <td>${tip.prediction}</td>
                  <td>${tip.double ? "Dupla" : "-"}</td>
                  <td>${point.toFixed(2)} pont</td>
                `;
                table.appendChild(row);
              });

              const totalRow = document.createElement("tr");
              totalRow.className = "total-row";
              totalRow.innerHTML = `
                <td colspan="4"><strong>Fordulónkénti összesített pontok:</strong><br>
                ${Object.entries(roundPoints).map(([email, pt]) => `${email}: ${pt.toFixed(2)} pont`).join("<br>")}
                </td>
              `;
              table.appendChild(totalRow);
            }
          });

          section.appendChild(table);
          container.appendChild(section);
        }

        if (container.innerHTML.trim() === "") {
          container.innerHTML = "<p>Nincs megjeleníthető eredmény.</p>";
        }

      } catch (e) {
        container.innerHTML = "<p style='color: red;'>Hiba történt az adatok betöltése közben.</p>";
        console.error(e);
      }
    });
  </script>
</head>
<body>
  <h1>Eredmények</h1>
  <div id="results-container"></div>
</body>
</html>
