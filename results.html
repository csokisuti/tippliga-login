<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.firebasestorage.app",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const container = document.getElementById("results-container");

    function formatDate(timestamp) {
      try {
        const date = timestamp.toDate();
        return date.toLocaleString("hu-HU");
      } catch {
        return "Ismeretlen időpont";
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        container.innerHTML = "<p style='color: red;'>Be kell jelentkezned az eredmények megtekintéséhez.</p>";
        return;
      }

      try {
        const [matchesSnap, tipsSnap, usersSnap] = await Promise.all([
          getDocs(collection(db, "matches")),
          getDocs(collection(db, "tips")),
          getDocs(collection(db, "users"))
        ]);

        const nicknameMap = {};
        usersSnap.forEach(doc => {
          const data = doc.data();
          if (data.email && data.nickname) {
            nicknameMap[data.email] = data.nickname;
          }
        });

        const matches = [];
        matchesSnap.forEach(doc => {
          const data = doc.data();
          if (data.startTime && Timestamp.now().seconds >= data.startTime.seconds) {
            matches.push({ id: doc.id, ...data });
          }
        });

        const tips = {};
        tipsSnap.forEach(doc => {
          const data = doc.data();
          if (!tips[data.matchId]) tips[data.matchId] = [];
          tips[data.matchId].push({ id: doc.id, ...data });
        });

        const grouped = {};
        for (const match of matches) {
          const round = match.round || "Egyéb";
          if (!grouped[round]) grouped[round] = [];
          grouped[round].push(match);
        }

        const rounds = Object.keys(grouped).sort((a, b) => b - a);
        for (const round of rounds) {
          const roundSection = document.createElement("div");
          const header = document.createElement("h2");
          header.textContent = `Forduló ${round}`;
          header.style.cursor = "pointer";
          roundSection.appendChild(header);

          const table = document.createElement("table");
          table.style.borderCollapse = "collapse";
          table.style.marginBottom = "20px";
          table.style.width = "100%";
          table.style.border = "1px solid #aaa";

          grouped[round].forEach(match => {
            const matchRow = document.createElement("tr");
            matchRow.innerHTML = `
              <td colspan="4" style="background: #ddd; padding: 8px;">
                <strong>${match.homeTeam} - ${match.awayTeam}</strong>
                (${match.result || "Nincs eredmény"})<br>
                <small>Kezdés: ${formatDate(match.startTime)}</small><br>
                <small>Oddsok: 1: ${match.odds1 || "-"} | X: ${match.oddsX || "-"} | 2: ${match.odds2 || "-"}</small>
              </td>
            `;
            table.appendChild(matchRow);

            let roundPoints = {};

            if (tips[match.id]) {
              tips[match.id].forEach(tip => {
                const isCorrect = match.outcome && tip.prediction === match.outcome;
                const oddsValue = match["odds" + tip.prediction] || 1;
                const points = isCorrect ? (tip.double ? 2 : 1) * oddsValue : 0;
                const displayName = nicknameMap[tip.userEmail] || tip.userEmail;

                roundPoints[displayName] = (roundPoints[displayName] || 0) + points;

                const row = document.createElement("tr");
                row.style.backgroundColor = isCorrect ? "#c8f7c5" : "#f7c5c5";
                row.innerHTML = `
                  <td style="padding: 6px;">${displayName}</td>
                  <td style="padding: 6px;">Tipp: ${tip.prediction}</td>
                  <td style="padding: 6px;">Dupla: ${tip.double ? "igen" : "nem"}</td>
                  <td style="padding: 6px;">Pont: ${points.toFixed(2)}</td>
                `;
                table.appendChild(row);
              });

              const totalRow = document.createElement("tr");
              totalRow.innerHTML = `
                <td colspan="4" style="padding: 6px; background: #eee;">
                  <strong>Összesített pontok ebben a fordulóban:</strong><br>
                  ${Object.entries(roundPoints).map(([name, pt]) => `${name}: ${pt.toFixed(2)} pont`).join("<br>")}
                </td>
              `;
              table.appendChild(totalRow);
            }
          });

          const collapsible = document.createElement("div");
          collapsible.style.display = "none";
          collapsible.appendChild(table);
          roundSection.appendChild(collapsible);

          header.addEventListener("click", () => {
            collapsible.style.display = collapsible.style.display === "none" ? "block" : "none";
          });

          container.appendChild(roundSection);
        }

        if (container.innerHTML === "") {
          container.innerHTML = "<p>Nincs megjeleníthető eredmény.</p>";
        }

      } catch (error) {
        container.innerHTML = "<p style='color: red;'>Hiba történt az adatok betöltésekor.</p>";
        console.error(error);
      }
    });
  </script>
</head>
<body>
  <h1>Eredmények</h1>
  <div id="results-container"></div>
</body>
</html>
