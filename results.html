<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Eredmények</h1>
  <div id="results-container"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
  authDomain: "tippliga-4b3af.firebaseapp.com",
  projectId: "tippliga-4b3af",
  storageBucket: "tippliga-4b3af.firebasestorage.app",
  messagingSenderId: "720359845241",
  appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const resultsContainer = document.getElementById("results-container");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const matchesSnap = await getDocs(collection(db, "matches"));
      const tipsSnap = await getDocs(collection(db, "tips"));

      const now = new Date();
      const matches = [];

      matchesSnap.forEach(doc => {
        const match = doc.data();
        let startTime;
        if (match.startTime instanceof Object && typeof match.startTime.seconds === "number") {
          startTime = new Date(match.startTime.seconds * 1000);
        }
        if (startTime && startTime <= now) {
          matches.push({ ...match, id: doc.id, startTime });
        }
      });

      const groupedByRound = {};
      matches.forEach(match => {
        const round = match.round || "Ismeretlen forduló";
        if (!groupedByRound[round]) {
          groupedByRound[round] = [];
        }
        groupedByRound[round].push(match);
      });

      const tips = {};
      tipsSnap.forEach(doc => {
        const data = doc.data();
        if (!tips[data.matchId]) tips[data.matchId] = [];
        tips[data.matchId].push(data);
      });

      const sortedRounds = Object.keys(groupedByRound).sort((a, b) => b - a);
      sortedRounds.forEach(round => {
        const details = document.createElement("details");
        details.open = true;

        const summary = document.createElement("summary");
        summary.textContent = `Forduló ${round}`;
        details.appendChild(summary);

        let roundTotal = 0;

        groupedByRound[round].forEach(match => {
          const matchDiv = document.createElement("div");
          matchDiv.className = "match";
          const startDate = match.startTime ? new Date(match.startTime).toLocaleString() : "Ismeretlen időpont";

          const outcome = match.outcome ? `<strong style="color:blue">(${match.outcome})</strong>` : "";
          matchDiv.innerHTML = `
            <h3>${match.teamA} vs ${match.teamB}</h3>
            <p>Dátum: ${startDate}</p>
            <p>Odds: ${match.oddsA} / ${match.oddsDraw} / ${match.oddsB}</p>
            <p>Eredmény: ${match.result || "Nincs rögzítve"} ${outcome}</p>
          `;

          const matchTips = tips[match.id] || [];
          matchTips.forEach(tip => {
            let point = 0;
            if (match.outcome && tip.tip === match.outcome) {
              const oddsMap = { "1": match.oddsA, "X": match.oddsDraw, "2": match.oddsB };
              point = (tip.double ? 2 : 1) * (oddsMap[match.outcome] || 1);
              roundTotal += point;
            }

            const tipDiv = document.createElement("div");
            tipDiv.textContent = `${tip.userEmail} tippje: ${tip.tip} (${tip.double ? "dupla" : "szimpla"}) → ${point} pont`;
            tipDiv.style.background = match.outcome
              ? (tip.tip === match.outcome ? "#c8e6c9" : "#ffcdd2")
              : "#eeeeee";
            tipDiv.style.padding = "5px";
            tipDiv.style.margin = "3px 0";
            matchDiv.appendChild(tipDiv);
          });

          details.appendChild(matchDiv);
        });

        const totalP = document.createElement("p");
        totalP.innerHTML = `<strong>Forduló összpontszám: ${roundTotal.toFixed(2)}</strong>`;
        totalP.style.marginTop = "10px";
        totalP.style.color = "darkgreen";
        details.appendChild(totalP);

        resultsContainer.appendChild(details);
      });
    });
  </script>
</body>
</html>
