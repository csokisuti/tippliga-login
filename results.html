<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h2 {
      color: #333;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }
    .match {
      background-color: #fff;
      margin: 10px 0;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tip {
      padding-left: 15px;
    }
    .highlight {
      font-weight: bold;
      color: green;
    }
    .wrong {
      color: red;
    }
    .total-points {
      margin-top: 5px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Eredmények</h2>
  <div id="results">Betöltés...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2Jo...",
      authDomain: "tippliga.firebaseapp.com",
      projectId: "tippliga",
      storageBucket: "tippliga.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdefg"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, async user => {
      if (!user) {
        document.getElementById("results").innerText = "Bejelentkezés szükséges.";
        return;
      }

      const matchesSnap = await getDocs(collection(db, "matches"));
      const tipsSnap = await getDocs(collection(db, "tips"));

      const matches = [];
      matchesSnap.forEach(doc => {
        const data = doc.data();
        matches.push({ id: doc.id, ...data });
      });

      const tips = [];
      tipsSnap.forEach(doc => {
        const data = doc.data();
        tips.push({ id: doc.id, ...data });
      });

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      const matchesByRound = {};
      matches.forEach(match => {
        if (match.result) {
          const round = match.round || "Ismeretlen forduló";
          if (!matchesByRound[round]) matchesByRound[round] = [];
          matchesByRound[round].push(match);
        }
      });

      Object.keys(matchesByRound).sort().forEach(round => {
        const roundTitle = document.createElement("h3");
        roundTitle.innerText = `Forduló: ${round}`;
        resultsDiv.appendChild(roundTitle);

        let roundTotalPoints = {};

        matchesByRound[round].forEach(match => {
          let matchDate = null;
          try {
            matchDate = match.startTime?.toDate?.();
          } catch (e) {
            console.warn("Hibás dátum a(z)", match.homeTeam, "-", match.awayTeam, "meccsen:", e.message);
          }

          const matchDiv = document.createElement("div");
          matchDiv.classList.add("match");

          matchDiv.innerHTML += `
            <strong>${match.homeTeam} - ${match.awayTeam}</strong><br>
            Eredmény: ${match.result || "nincs megadva"}<br>
            Oddsok: 1: ${match.odds1}, X: ${match.oddsX}, 2: ${match.odds2}<br>
            Kezdés: ${matchDate ? matchDate.toLocaleString("hu-HU") : "n.a."}
          `;

          const relevantTips = tips.filter(t => t.matchId === match.id);
          relevantTips.forEach(tip => {
            const outcome = match.outcome;
            const correct = tip.tip === outcome;
            const odds = match[`odds${tip.tip}`] || 1;
            const multiplier = tip.double ? 2 : 1;
            const point = correct ? odds * multiplier : 0;

            if (!roundTotalPoints[tip.user]) roundTotalPoints[tip.user] = 0;
            roundTotalPoints[tip.user] += point;

            const tipDiv = document.createElement("div");
            tipDiv.classList.add("tip");
            tipDiv.innerHTML = `
              ${tip.user}: <span class="${correct ? 'highlight' : 'wrong'}">${tip.tip}</span>
              ${tip.double ? '(dupla)' : ''}
              – ${correct ? `+${point} pont` : '+0 pont'}
            `;
            matchDiv.appendChild(tipDiv);
          });

          resultsDiv.appendChild(matchDiv);
        });

        const totalDiv = document.createElement("div");
        totalDiv.classList.add("total-points");

        totalDiv.innerHTML = Object.keys(roundTotalPoints).map(user =>
          `${user}: ${roundTotalPoints[user]} pont`
        ).join("<br>");

        resultsDiv.appendChild(totalDiv);
      });

      if (resultsDiv.innerHTML.trim() === "") {
        resultsDiv.innerText = "Nincsenek megjeleníthető meccsek.";
      }
    });
  </script>
</body>
</html>
