<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
    h1, h2 { margin-top: 20px; }
    .match { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 0 5px #ccc; }
    .tip { margin-left: 20px; padding: 8px; border-radius: 6px; background: #eef; margin-top: 5px; display: flex; align-items: center; gap: 10px; }
    .correct { background: #d4edda; }
    .incorrect::after { content: "❌"; color: red; margin-left: 8px; }
    .bold { font-weight: bold; }
    .crest { height: 24px; vertical-align: middle; margin-right: 5px; }
    .back-button { display: inline-block; margin-bottom: 20px; padding: 8px 12px; background: #007bff; color: white; text-decoration: none; border-radius: 6px; }
  </style>
</head>
<body>
  <a class="back-button" href="dashboard.html">← Vissza a főoldalra</a>
  <h1>Eredmények</h1>
  <div id="resultsContainer">Betöltés...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const resultsContainer = document.getElementById('resultsContainer');

    function getCrestFilename(teamName) {
      return "crest/crest-" + teamName.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]/g, "") + ".png";
    }

    function formatDate(timestamp) {
      const date = timestamp.toDate();
      return `${date.getFullYear()}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
    }

    onAuthStateChanged(auth, async user => {
      if (!user) {
        resultsContainer.innerHTML = "<p>Be kell jelentkezned az eredmények megtekintéséhez.</p>";
        return;
      }

      const [matchesSnap, tipsSnap, usersSnap] = await Promise.all([
        getDocs(collection(db, "matches")),
        getDocs(collection(db, "tips")),
        getDocs(collection(db, "users"))
      ]);

      const matches = {};
      matchesSnap.forEach(doc => matches[doc.id] = { id: doc.id, ...doc.data() });

      const users = {};
      usersSnap.forEach(doc => users[doc.id] = doc.data().nickname || "Ismeretlen";

      const rounds = {};

      tipsSnap.forEach(doc => {
        const tip = doc.data();
        const match = matches[tip.matchId];
        if (!match || !match.outcome || !match.odds) return;

        const roundId = match.roundId || "Egyéb";
        if (!rounds[roundId]) rounds[roundId] = {};
        if (!rounds[roundId][match.id]) {
          rounds[roundId][match.id] = {
            match,
            tips: []
          };
        }

        const isCorrect = match.outcome === tip.tip;
        const oddsValue = match.odds[tip.tip];
        const point = (oddsValue || 0) * (tip.isDouble ? 2 : 1);

        rounds[roundId][match.id].tips.push({
          userId: tip.userId,
          nickname: users[tip.userId] || "Ismeretlen",
          tip: tip.tip,
          isDouble: tip.isDouble,
          correct: isCorrect,
          odds: oddsValue,
          point: isCorrect ? point : 0
        });
      });

      resultsContainer.innerHTML = "";

      Object.keys(rounds).sort((a,b) => b - a).forEach(roundId => {
        const roundBlock = document.createElement("div");
        roundBlock.innerHTML = `<h2>${roundId}. forduló</h2>`;

        const matchesInRound = rounds[roundId];
        Object.values(matchesInRound).forEach(({ match, tips }) => {
          const matchBlock = document.createElement("div");
          matchBlock.className = "match";
          const homeLogo = getCrestFilename(match.homeTeam);
          const awayLogo = getCrestFilename(match.awayTeam);
          const startTime = match.startTime ? formatDate(match.startTime) : "ismeretlen";

          matchBlock.innerHTML = `
            <div>
              <img class="crest" src="${homeLogo}" alt=""> <span class="bold">${match.homeTeam}</span>
              -
              <img class="crest" src="${awayLogo}" alt=""> <span class="bold">${match.awayTeam}</span>
            </div>
            <div>Kezdés: <span class="bold">${startTime}</span></div>
            <div>Eredmény: <span class="bold">${match.result || "?"}</span>, Kimenetel: <span class="bold">${match.outcome}</span></div>
            <div>Odds: 1 → ${match.odds["1"]}, X → ${match.odds["X"]}, 2 → ${match.odds["2"]}</div>
          `;

          tips.forEach(tip => {
            const tipDiv = document.createElement("div");
            tipDiv.className = "tip" + (tip.correct ? " correct" : " incorrect");
            tipDiv.innerHTML = `
              Tippelő: <strong>${tip.nickname}</strong>,
              Tipp: ${tip.tip},
              ${tip.isDouble ? "Dupla, " : ""}
              Odds: ${tip.odds ?? "-"},
              Pont: ${tip.point.toFixed(2)}
            `;
            matchBlock.appendChild(tipDiv);
          });

          roundBlock.appendChild(matchBlock);
        });

        resultsContainer.appendChild(roundBlock);
      });
    });
  </script>
</body>
</html>
