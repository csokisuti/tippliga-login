<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Eredm√©nyek</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ====== UI / st√≠lus (matches/positions hangulat) ====== */
    const css = `
      :root{
        --bg:#f5f7fb; --card:#fff; --line:#e6eaf1; --text:#0f172a; --muted:#64748b;
        --chip:#eef2ff; --ok:#16a34a; --warn:#b45309;
      }
      *{ box-sizing:border-box }
      body{ margin:0; padding:24px; background:var(--bg); color:var(--text);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; }

      .back-btn{ display:inline-block; text-decoration:none; background:#e5e7eb; color:#111;
                 padding:8px 12px; border-radius:10px; border:1px solid var(--line); }
      h1{ margin:16px 0 12px; font-size:22px; text-align:center; color:#1f2a44 }
      .page-muted{ color:var(--muted); margin:10px 0 18px; text-align:center }

      .controls{ max-width:1100px; margin:0 auto 10px; display:flex; gap:10px; align-items:center; justify-content:center }
      .controls label{ color:var(--muted) }
      select{ padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; }

      .card{ background:var(--card); border:1px solid var(--line); border-radius:12px;
             box-shadow:0 6px 18px rgba(15,23,42,.05); margin:18px auto; max-width:1100px; overflow:hidden; }
      .subhdr{ padding:10px 14px; border-bottom:1px solid var(--line);
               background:#f7f9fd; font-weight:700; display:flex; align-items:center; gap:10px; }
      .subhdr small{ font-weight:400; color:var(--muted) }

      .summary{ padding:10px 14px; border-bottom:1px solid var(--line); display:flex; flex-wrap:wrap; gap:8px; }
      .sum-chip{ background:var(--chip); border:1px solid var(--line); border-radius:999px; padding:6px 10px; font-size:13px }
      .sum-chip b{ font-weight:800 }

      .match{ padding:12px 14px; border-bottom:1px solid var(--line); background:#fff; }
      .match:nth-child(even){ background:#fcfdff; }
      .team-row{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; font-size:15px }
      .crest{ width:22px; height:22px; object-fit:contain }
      .meta{ color:var(--muted); font-size:12px; margin-top:4px }

      .odds{ font-size:12px; background:var(--chip); border-radius:999px; padding:3px 8px; }
      .tips{ margin-top:8px; display:flex; flex-direction:column; gap:6px }
      .tip{ padding:8px 10px; border-radius:8px; background:#eef; }
      .tip.correct{ background:#ecfdf5 }
      .tip.wrong{ background:#fdecec }
      .tip b{ font-weight:700 }
      .kicker{ color:var(--muted); font-size:12px }
      .hidden-info{ color:var(--warn); font-size:13px; margin-top:6px }
      .empty{ padding:12px 14px; color:var(--muted) }
    `;
    const style = document.createElement('style'); style.textContent = css; document.head.appendChild(style);
    /* ======================================================= */

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const crestMap = {
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Di√≥sgy≈ëri VTK": "crest/crest-dvtk.png",
      "Ferencv√°ros": "crest/crest-fradi.png",
      "ETO FC Gy≈ër": "crest/crest-gyor.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Kisv√°rda FC": "crest/crest-kisvarda.png",
      "MTK Budapest": "crest/crest-mtk.png",
      "Ny√≠regyh√°za Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Pusk√°s Akad√©mia": "crest/crest-puskas.png",
      "√öjpest FC": "crest/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png"
    };

    const roundSelect = document.getElementById("roundSelect");
    const mount = document.getElementById("resultsContainer");

    const urlParams = new URLSearchParams(location.search);
    const desiredRoundParam = urlParams.get("round");

    let matches = [];
    let tipsByMatch = {};
    let nickByEmail = {};
    let allRoundsAsc = [];
    let currentUserEmail = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        mount.innerHTML = `<div class="empty">Jelentkezz be az eredm√©nyek megtekint√©s√©hez.</div>`;
        return;
      }
      currentUserEmail = user.email;

      try{
        // users ‚Üí becenevek
        const usersSnap = await getDocs(collection(db, "users"));
        usersSnap.forEach(d => {
          const u = d.data();
          if (u?.email) nickByEmail[u.email] = u.nickname || u.email;
        });

        // matches
        const matchesSnap = await getDocs(collection(db, "matches"));
        matches = matchesSnap.docs.map(d => ({ id:d.id, ...d.data() }));

        const set = new Set();
        matches.forEach(m => { if (m.roundId) set.add(String(m.roundId)); });
        allRoundsAsc = Array.from(set).sort((a,b)=> parseInt(a)-parseInt(b));

        if (!allRoundsAsc.length){
          mount.innerHTML = `<div class="empty">M√©g nincsenek eredm√©nyek.</div>`;
          if (window.hideLoader) hideLoader();
          return;
        }

        // tips
        tipsByMatch = {};
        const tipsSnap = await getDocs(collection(db, "tips"));
        tipsSnap.forEach(d => {
          const t = d.data();
          if (!t?.matchId) return;
          if (!tipsByMatch[t.matchId]) tipsByMatch[t.matchId] = [];
          tipsByMatch[t.matchId].push({ id:d.id, ...t });
        });

        // round select
        roundSelect.innerHTML = "";
        allRoundsAsc.forEach(r => {
          const o = document.createElement("option");
          o.value = r; o.textContent = `${r}. fordul√≥`;
          roundSelect.appendChild(o);
        });

        const lastRound = allRoundsAsc[allRoundsAsc.length-1];
        const startRound = (desiredRoundParam && allRoundsAsc.includes(String(desiredRoundParam)))
          ? String(desiredRoundParam)
          : lastRound;

        roundSelect.value = startRound;
        await renderRound(startRound);

        roundSelect.addEventListener("change", () => renderRound(roundSelect.value));
      }catch(e){
        console.error(e);
        mount.innerHTML = `<div class="empty">Hiba t√∂rt√©nt az adatok bet√∂lt√©se k√∂zben.</div>`;
      }finally{
        if (window.hideLoader) hideLoader();
      }
    });

    function fmt(n){ return (Number(n)||0).toFixed(2); }

    async function renderRound(roundId){
      mount.innerHTML = "";

      const card = document.createElement("div");
      card.className = "card";
      const sub = document.createElement("div");
      sub.className = "subhdr";
      sub.innerHTML = `üìÖ ${roundId}. fordul√≥ <small>V√°lts a fenti list√°ban m√°sik fordul√≥ra</small>`;
      card.appendChild(sub);

      // fordul√≥ meccsei id≈ërendben
      const list = matches
        .filter(m => String(m.roundId) === String(roundId))
        .sort((a,b)=>{
          const ta = a.startTime?.toDate?.() || 0;
          const tb = b.startTime?.toDate?.() || 0;
          return ta - tb;
        });

      if (!list.length){
        card.appendChild(divEmpty("Ehhez a fordul√≥hoz m√©g nincs meccs."));
        mount.appendChild(card);
        return;
      }

      /* ======= PONT√ñSSZES√çT≈ê (csak a lez√°rt meccsek alapj√°n) ======= */
      const summary = {};         // nick -> pont
      const breakdown = {};       // nick -> [ "Home‚ÄìAway: tip ‚Üí +x.xx pont", ... ]
      const now = new Date();

      list.forEach(m => {
        const mTips = tipsByMatch[m.id] || [];
        const outcomeKnown = !!m.outcome; // csak akkor sz√°moljon pontot, ha van outcome

        if (!outcomeKnown) return; // m√©g tart / nincs eredm√©ny ‚Üí nem sz√°moljuk

        mTips.forEach(t => {
          const correct = t.tip === m.outcome;
          const mult = t.isDouble ? 2 : 1;
          const oddsForPick = m.odds?.[t.tip];
          const pts = (correct && oddsForPick) ? (Number(oddsForPick) * mult) : 0;

          const nick = nickByEmail[t.user] || t.user || "Ismeretlen";
          if (!summary[nick]) { summary[nick] = 0; breakdown[nick] = []; }
          summary[nick] += pts;
          breakdown[nick].push(`${m.homeTeam}‚Äì${m.awayTeam}: ${t.tip} ‚Üí ${fmt(pts)} pont`);
        });
      });

      const summaryDiv = document.createElement("div");
      summaryDiv.className = "summary";
      if (Object.keys(summary).length){
        // rendezz√ºk pont szerint
        const ordered = Object.entries(summary).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
        ordered.forEach(([nick, pts]) => {
          const chip = document.createElement("span");
          chip.className = "sum-chip";
          chip.title = (breakdown[nick]||[]).join("\n");
          chip.innerHTML = `<b>${nick}</b>: ${fmt(pts)}`;
          summaryDiv.appendChild(chip);
        });
      } else {
        const none = document.createElement("span");
        none.className = "kicker";
        none.textContent = "M√©g nincs lez√°rt meccs ebben a fordul√≥ban.";
        summaryDiv.appendChild(none);
      }
      card.appendChild(summaryDiv);
      /* ============================================================= */

      // meccsek list√°ja
      list.forEach(m => {
        const div = document.createElement("div");
        div.className = "match";

        const crestHome = crestMap[m.homeTeam] || "";
        const crestAway = crestMap[m.awayTeam] || "";
        const ko = m.startTime?.toDate?.();
        const koStr = ko ? ko.toLocaleString("hu-HU") : "";

        const odds1 = m.odds?.["1"] ?? "-";
        const oddsX = m.odds?.["X"] ?? "-";
        const odds2 = m.odds?.["2"] ?? "-";

        div.innerHTML = `
          <div class="team-row">
            <img src="${crestHome}" class="crest" alt="">
            <strong>${m.homeTeam}</strong> vs
            <strong>${m.awayTeam}</strong>
            <img src="${crestAway}" class="crest" alt="">
            <span class="odds">1: ${odds1} ‚Ä¢ X: ${oddsX} ‚Ä¢ 2: ${odds2}</span>
          </div>
          <div class="meta">
            Kezd√©s: ${koStr || "-"} ‚Ä¢ Eredm√©ny: ${m.result || "-"} ‚Ä¢ Kimenetel: <b>${m.outcome || "-"}</b>
          </div>
        `;

        const tipsWrap = document.createElement("div");
        tipsWrap.className = "tips";

        const mTips = tipsByMatch[m.id] || [];
        const hasStarted = ko && ko <= now;

        if (!mTips.length){
          tipsWrap.appendChild(kicker("Ehhez a meccshez m√©g nincs leadott tipp."));
        } else {
          if (!hasStarted){
            // M√©g nem kezd≈ëd√∂tt: tippek rejtve ‚Äì kiv√©ve a saj√°tot
            tipsWrap.appendChild(hiddenInfo("A tippek a kezd√©sig nem nyilv√°nosak."));
            // saj√°t tipp megmutat√°sa
            mTips
              .filter(t => t.user === currentUserEmail)
              .forEach(t => {
                const row = document.createElement("div");
                row.className = "tip";
                row.innerHTML = `<b>Saj√°t tipped</b>: ${t.tip}${t.isDouble ? ' <span class="kicker">(dupla)</span>' : ''}`;
                tipsWrap.appendChild(row);
              });
          } else {
            // Kezd√©s ut√°n: tippek l√°that√≥k + pontsz√°m, ha m√°r outcome ismert
            mTips.forEach(t => {
              const correct = m.outcome && t.tip === m.outcome;
              const mult = t.isDouble ? 2 : 1;
              const oddsForPick = m.odds?.[t.tip];
              const pts = (correct && oddsForPick) ? (Number(oddsForPick) * mult) : 0;

              const row = document.createElement("div");
              row.className = "tip";
              if (correct) row.classList.add("correct");
              else if (m.result) row.classList.add("wrong");

              const nick = nickByEmail[t.user] || t.user || "Ismeretlen";
              row.innerHTML = `
                <b>${nick}</b>: ${t.tip}
                ${t.isDouble ? ' <span class="kicker">(dupla)</span>' : ''}
                ${m.result ? ` ‚Äì Pont: <b>${fmt(pts)}</b>` : ''}
              `;
              tipsWrap.appendChild(row);
            });
          }
        }

        div.appendChild(tipsWrap);
        card.appendChild(div);
      });

      mount.appendChild(card);
    }

    function divEmpty(text){
      const d = document.createElement("div");
      d.className = "empty";
      d.textContent = text;
      return d;
    }
    function kicker(text){
      const d = document.createElement("div");
      d.className = "kicker";
      d.textContent = text;
      return d;
    }
    function hiddenInfo(text){
      const d = document.createElement("div");
      d.className = "hidden-info";
      d.textContent = text;
      return d;
    }
  </script>
</head>
<body>
  <a href="dashboard.html" class="back-btn">‚Üê Vissza a f≈ëoldalra</a>
  <h1>Eredm√©nyek</h1>
  <div class="page-muted">V√°lassz fordul√≥t, n√©zd meg a meccseket √©s a pontokat. A m√©g el nem kezdett meccsek tippei a kezd√©sig rejtve maradnak (a saj√°todat l√°tod).</div>

  <div class="controls">
    <label for="roundSelect">V√°lassz fordul√≥t:</label>
    <select id="roundSelect"></select>
  </div>

  <div id="resultsContainer"></div>
</body>
</html>
