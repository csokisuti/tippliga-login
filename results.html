<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, query, where, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const resultsDiv = document.getElementById("results");

      const matchesSnapshot = await getDocs(collection(db, "matches"));
      const tipsSnapshot = await getDocs(collection(db, "tips"));
      const usersSnapshot = await getDocs(collection(db, "users"));

      const usersMap = {};
      usersSnapshot.forEach(doc => {
        usersMap[doc.id] = doc.data().nickname || doc.data().email;
      });

      const tipsByMatch = {};
      tipsSnapshot.forEach(tipDoc => {
        const tip = tipDoc.data();
        if (!tipsByMatch[tip.matchId]) tipsByMatch[tip.matchId] = [];
        tipsByMatch[tip.matchId].push(tip);
      });

      const matchesByRound = {};
      matchesSnapshot.forEach(doc => {
        const match = doc.data();
        if (!match.startTime) return;

        const start = match.startTime.toDate?.() || match.startTime;
        if (new Date() < new Date(start)) return;

        if (!matchesByRound[match.roundId]) matchesByRound[match.roundId] = [];
        matchesByRound[match.roundId].push({ id: doc.id, ...match });
      });

      const sortedRounds = Object.keys(matchesByRound).sort();

      sortedRounds.forEach(roundId => {
        const roundSection = document.createElement("section");
        roundSection.innerHTML = `<h2>${roundId}. forduló</h2>`;
        matchesByRound[roundId]
          .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))
          .forEach(match => {
            const matchDiv = document.createElement("div");
            matchDiv.classList.add("match-block");
            matchDiv.innerHTML = `<h3>${match.homeTeam} - ${match.awayTeam}</h3>`;
            if (match.result) {
              matchDiv.innerHTML += `<p>Eredmény: <strong>${match.result}</strong></p>`;
            } else {
              matchDiv.innerHTML += `<p><em>Nincs még eredmény rögzítve.</em></p>`;
            }

            const tipList = document.createElement("ul");

            (tipsByMatch[match.id] || []).forEach(tip => {
              const li = document.createElement("li");
              const user = usersMap[tip.userId] || "Ismeretlen";
              const double = tip.isDouble ? " (dupla)" : "";
              let points = "";
              if (match.outcome && tip.tip === match.outcome) {
                const multiplier = tip.isDouble ? 2 : 1;
                const odds = match.odds?.[tip.tip] || 1;
                points = ` - ${odds * multiplier} pont`;
              } else if (match.outcome) {
                points = " - 0 pont";
              }

              li.textContent = `${user}: ${tip.tip}${double}${points}`;
              tipList.appendChild(li);
            });

            matchDiv.appendChild(tipList);
            roundSection.appendChild(matchDiv);
          });

        resultsDiv.appendChild(roundSection);
      });
    });
  </script>
</head>
<body>
  <h1>Eredmények</h1>
  <div id="results"></div>
</body>
</html>

