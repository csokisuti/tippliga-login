<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredm√©nyek</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f8f8f8; }
    h2 { cursor: pointer; background: #ddd; padding: 10px; border-radius: 4px; }
    .match { margin: 10px 0; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 5px; }
    .tip { margin-left: 20px; padding: 6px; border-radius: 4px; }
    .tip.correct { background-color: #d4edda; }
    .tip.incorrect { background-color: #f8d7da; }
    .hidden { display: none; }
    .match-meta { font-size: 0.9em; color: #666; margin-top: 4px; }
    .outcome-highlight { font-weight: bold; color: #333; }
    .total-points { font-weight: bold; margin: 10px 0 20px 10px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const content = document.createElement('div');
    document.body.appendChild(content);

    onAuthStateChanged(auth, async user => {
      if (!user) {
        alert("Bejelentkez√©s sz√ºks√©ges!");
        window.location.href = "login.html";
        return;
      }

      try {
        const matchesSnapshot = await getDocs(collection(db, "matches"));
        const tipsSnapshot = await getDocs(collection(db, "tips"));
        const usersSnapshot = await getDocs(collection(db, "users"));

        const now = new Date();
        const matches = [];
        matchesSnapshot.forEach(doc => {
          const m = doc.data();
          m.id = doc.id;
          try {
            const matchDate = m.matchDate.toDate?.() || new Date(m.matchDate);
            if (matchDate <= now) matches.push({ ...m, matchDate });
          } catch (e) {
            console.warn(`Hib√°s d√°tum a(z) ${m.homeTeam} - ${m.awayTeam} meccsen:`, e);
          }
        });

        if (matches.length === 0) {
          content.innerHTML = "<p>Nincsenek megjelen√≠thet≈ë meccsek.</p>";
          console.log("Nem tal√°ltunk elkezd≈ëd√∂tt meccseket.");
          return;
        }

        const tips = {};
        tipsSnapshot.forEach(doc => {
          const t = doc.data();
          if (!tips[t.matchId]) tips[t.matchId] = [];
          tips[t.matchId].push({ ...t, id: doc.id });
        });

        const nicknames = {};
        usersSnapshot.forEach(doc => {
          const u = doc.data();
          nicknames[doc.id] = u.nickname || doc.id;
        });

        const grouped = {};
        matches.forEach(match => {
          const round = match.round || "Ismeretlen fordul√≥";
          if (!grouped[round]) grouped[round] = [];
          grouped[round].push(match);
        });

        const sortedRounds = Object.keys(grouped).sort((a, b) => b.localeCompare(a, undefined, { numeric: true }));

        sortedRounds.forEach(round => {
          const header = document.createElement("h2");
          header.textContent = `Fordul√≥ ${round}`;
          const section = document.createElement("div");
          section.classList.add("hidden");

          let roundPoints = {};

          grouped[round].forEach(match => {
            const matchDiv = document.createElement("div");
            matchDiv.classList.add("match");

            const outcome = match.outcome;
            const hasResult = !!outcome;
            const home = match.homeTeam;
            const away = match.awayTeam;
            const result = match.result || "‚Äì";
            const matchDate = match.matchDate.toLocaleString();
            const odds = `1: ${match.odds1}, X: ${match.oddsX}, 2: ${match.odds2}`;
            const outcomeText = hasResult ? ` ‚Üí <span class="outcome-highlight">${outcome}</span>` : "";

            matchDiv.innerHTML = `<strong>${home} ‚Äì ${away}</strong><div class="match-meta">Eredm√©ny: ${result}${outcomeText}<br>D√°tum: ${matchDate}<br>Odds: ${odds}</div>`;

            const tipList = tips[match.id] || [];

            tipList.forEach(tip => {
              const div = document.createElement("div");
              const correct = hasResult && tip.tip === outcome;
              div.classList.add("tip", correct ? "correct" : "incorrect");

              const points = hasResult ? parseFloat(match["odds" + tip.tip]) * (tip.double ? 2 : 1) : null;
              const userPoints = correct && points ? points : 0;
              const name = nicknames[tip.userId] || tip.userId;

              if (!roundPoints[name]) roundPoints[name] = 0;
              roundPoints[name] += userPoints;

              div.textContent = `${name}: ${tip.tip}${tip.double ? " (dupla)" : ""}${hasResult ? ` ‚Üí ${userPoints.toFixed(1)} pont` : ""}`;
              matchDiv.appendChild(div);
            });

            section.appendChild(matchDiv);
          });

          const sumDiv = document.createElement("div");
          sumDiv.className = "total-points";
          sumDiv.innerHTML = "Fordul√≥ √∂sszpontsz√°m:<br>" + Object.entries(roundPoints)
            .map(([user, points]) => `${user}: ${points.toFixed(1)} pont`)
            .join("<br>");
          section.appendChild(sumDiv);

          header.addEventListener("click", () => {
            section.classList.toggle("hidden");
          });

          content.appendChild(header);
          content.appendChild(section);
        });
      } catch (e) {
        console.error("Hiba az adatok bet√∂lt√©se k√∂zben:", e);
        content.innerHTML = "<p>Hiba t√∂rt√©nt az adatok bet√∂lt√©se k√∂zben. R√©szletek a konzolban.</p>";
      }
    });
  </script>
</head>
<body>
  <h1>üìú Eredm√©nyek</h1>
</body>
</html>
