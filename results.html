<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h2 { cursor: pointer; background-color: #ddd; padding: 10px; margin: 10px 0; }
    .match { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    .tip { padding: 5px; margin-left: 10px; }
    .tip.correct { background-color: #c8e6c9; }
    .tip.incorrect { background-color: #ffcdd2; }
    .details { display: none; padding-left: 20px; }
    .outcome { font-weight: bold; margin-top: 5px; }
    .summary { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Eredmények</h1>
  <div id="results"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
  apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
  authDomain: "tippliga-4b3af.firebaseapp.com",
  projectId: "tippliga-4b3af",
  storageBucket: "tippliga-4b3af.firebasestorage.app",
  messagingSenderId: "720359845241",
  appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
};

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, async user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      loadResults();
    });

    async function loadResults() {
      const matchesSnap = await getDocs(collection(db, "matches"));
      const tipsSnap = await getDocs(collection(db, "tips"));
      const usersSnap = await getDocs(collection(db, "users"));
      const matches = [];
      const tipsByMatch = {};
      const users = {};

      usersSnap.forEach(doc => {
        users[doc.id] = doc.data().nickname || doc.id;
      });

      const now = new Date();

      tipsSnap.forEach(doc => {
        const tip = doc.data();
        if (!tipsByMatch[tip.matchId]) tipsByMatch[tip.matchId] = [];
        tipsByMatch[tip.matchId].push({ ...tip, id: doc.id });
      });

      matchesSnap.forEach(doc => {
        const match = doc.data();
        const startTime = match.startTime?.toDate?.();
        if (startTime && startTime <= now) {
          matches.push({ ...match, id: doc.id });
        }
      });

      const resultsContainer = document.getElementById("results");

      const groupedByRound = {};
      matches.forEach(match => {
        const round = match.round || "Ismeretlen forduló";
        if (!groupedByRound[round]) groupedByRound[round] = [];
        groupedByRound[round].push(match);
      });

      const sortedRounds = Object.keys(groupedByRound).sort((a, b) => b - a);

      sortedRounds.forEach(round => {
        const header = document.createElement("h2");
        header.textContent = `Forduló ${round}`;
        const section = document.createElement("div");
        section.className = "details";

        let roundTotal = 0;

        groupedByRound[round].forEach(match => {
          const matchDiv = document.createElement("div");
          matchDiv.className = "match";
          const startTime = match.startTime?.toDate?.();
          const result = match.result || "-";
          const outcome = match.outcome || "-";
          const home = match.homeTeam || "Hazai";
          const away = match.awayTeam || "Vendég";
          const homeOdds = match.odds?.home || "-";
          const drawOdds = match.odds?.draw || "-";
          const awayOdds = match.odds?.away || "-";
          const tips = tipsByMatch[match.id] || [];

          matchDiv.innerHTML = `
            <strong>${home} vs ${away}</strong><br>
            Dátum: ${startTime?.toLocaleString() || "-"}<br>
            Odds: Hazai: ${homeOdds}, Döntetlen: ${drawOdds}, Vendég: ${awayOdds}<br>
            Eredmény: ${result} (${outcome !== "-" ? `<span class="outcome">${outcome}</span>` : "-"})<br>
          `;

          tips.forEach(tip => {
            const tipDiv = document.createElement("div");
            const isCorrect = tip.prediction === outcome;
            const multiplier = tip.double ? 2 : 1;
            const odds = tip.prediction === "1" ? homeOdds : tip.prediction === "X" ? drawOdds : awayOdds;
            const point = isCorrect ? Number(odds) * multiplier : 0;
            if (isCorrect) roundTotal += point;

            tipDiv.className = "tip " + (outcome !== "-" ? (isCorrect ? "correct" : "incorrect") : "");
            tipDiv.textContent = `${users[tip.user] || tip.user}: ${tip.prediction} ${tip.double ? "(dupla)" : ""} → ${point} pont`;
            matchDiv.appendChild(tipDiv);
          });

          section.appendChild(matchDiv);
        });

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.textContent = `Forduló összpont: ${roundTotal.toFixed(2)} pont`;
        section.appendChild(summary);

        header.addEventListener("click", () => {
          section.style.display = section.style.display === "none" ? "block" : "none";
        });

        resultsContainer.appendChild(header);
        resultsContainer.appendChild(section);
      });
    }
  </script>
</body>
</html>
