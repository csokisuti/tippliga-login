<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
    h1, h2 { margin-top: 30px; }
    .match { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 0 5px #ccc; }
    .tip { margin-left: 20px; padding: 8px; border-radius: 6px; background: #eef; margin-top: 5px; }
    .correct { background: #d4edda; }
    .bold { font-weight: bold; }
    .hidden { display: none; }
    select { padding: 6px; margin-bottom: 20px; }
    .team-row { display: flex; align-items: center; gap: 8px; font-size: 1.1em; }
    .crest { width: 20px; height: 20px; }

    /* Új: játékoslista gomb fix */
    .userrow { 
      color:#111 !important; 
      background:#fff; 
      border:1px solid #eee; 
      padding:8px; 
      width:100%; 
      text-align:left; 
      border-radius:4px; 
      cursor:pointer;
    }
    .userrow * { color:inherit; }
    .userrow:hover { background:#f6f6f6; }

    /* Modal */
    #bonusOverlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      display: none; align-items: center; justify-content: center;
      z-index: 9999;
    }
    #bonusOverlay .modal {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 900px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      gap: 20px;
    }
    #bonusOverlay .playerlist {
      flex: 1;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      padding-right: 10px;
    }
    #bonusOverlay .comparison {
      flex: 3;
      overflow-y: auto;
    }
    #bonusOverlay table {
      width: 100%;
      border-collapse: collapse;
    }
    #bonusOverlay th, #bonusOverlay td {
      padding: 6px;
      border-bottom: 1px solid #ddd;
    }
    #bonusOverlay tr.correct { background: #d4edda; }
    #bonusOverlay .closeBtn {
      background: #ccc;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #bonusOverlay .closeBtn:hover {
      background: #bbb;
    }
  </style>
</head>
<body>

<a href="dashboard.html" class="btn">&larr; Vissza a főoldalra</a>
<h1>Eredmények</h1>

<div>
  <h3>Szezon végi bónusz</h3>
  <div id="bonusScore">0/12 → +0%</div>
  <div style="background:#ddd; border-radius:5px; height:10px; width:200px;">
    <div id="bonusBar" style="background:green; height:10px; width:0%; border-radius:5px;"></div>
  </div>
</div>

<label for="roundSelect">Válassz fordulót:</label>
<select id="roundSelect"></select>

<div id="matchesContainer"></div>

<!-- Modal -->
<div id="bonusOverlay">
  <div class="modal">
    <div class="playerlist">
      <input type="text" id="playerSearch" placeholder="Keresés..." style="width:100%;padding:5px;margin-bottom:10px;">
      <div id="playerList"></div>
    </div>
    <div class="comparison">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 id="comparisonTitle"></h3>
        <button class="closeBtn" onclick="closeBonusOverlay()">Bezár</button>
      </div>
      <div id="comparisonContent"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
  apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
  authDomain: "tippliga-4b3af.firebaseapp.com",
  projectId: "tippliga-4b3af",
  storageBucket: "tippliga-4b3af.firebasestorage.app",
  messagingSenderId: "720359845241",
  appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
};

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let officialPositions = [];
  let userPositions = {};

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      document.body.innerHTML = "<p>Be kell jelentkezned az eredmények megtekintéséhez.</p>";
      return;
    }

    await loadOfficialPositions();
    await loadUserPositions();

    renderPlayerList();
    calculateBonusForUser(user.email);
  });

  async function loadOfficialPositions() {
    const docRef = doc(db, "finalStandings", "official");
    const snap = await getDoc(docRef);
    if (snap.exists()) {
      officialPositions = snap.data().teams || [];
    }
  }

  async function loadUserPositions() {
    const colRef = collection(db, "standingsTips");
    const snaps = await getDocs(colRef);
    snaps.forEach(snap => {
      userPositions[snap.id] = snap.data().teams || [];
    });
  }

  function renderPlayerList() {
    const container = document.getElementById("playerList");
    container.innerHTML = "";
    Object.keys(userPositions).forEach(email => {
      const correct = countCorrectPositions(userPositions[email]);
      const btn = document.createElement("button");
      btn.className = "userrow";
      btn.textContent = `${email}  ${correct}/12`;
      btn.onclick = () => showComparison(email);
      container.appendChild(btn);
    });
  }

  function countCorrectPositions(userList) {
    let correct = 0;
    officialPositions.forEach((team, i) => {
      if (userList[i] === team) correct++;
    });
    return correct;
  }

  function calculateBonusForUser(email) {
    const correct = countCorrectPositions(userPositions[email] || []);
    document.getElementById("bonusScore").textContent = `${correct}/12 → +${correct}%`;
    document.getElementById("bonusBar").style.width = `${(correct/12)*100}%`;
  }

  function showComparison(email) {
    document.getElementById("bonusOverlay").style.display = "flex";
    document.getElementById("comparisonTitle").textContent = `Összehasonlítás – ${email}`;
    const correct = countCorrectPositions(userPositions[email]);
    let html = `<p>${correct}/12 → +${correct}%</p>`;
    html += `<table><tr><th>Hely</th><th>Hivatalos</th><th>Tippelt</th><th>Stimmel</th></tr>`;
    officialPositions.forEach((team, i) => {
      const guessed = userPositions[email][i] || "";
      const isCorrect = guessed === team;
      html += `<tr class="${isCorrect ? 'correct':''}">
        <td>${i+1}</td>
        <td>${team}</td>
        <td>${guessed}</td>
        <td>${isCorrect ? '✅':'❌'}</td>
      </tr>`;
    });
    html += `</table>`;
    document.getElementById("comparisonContent").innerHTML = html;
  }

  function closeBonusOverlay() {
    document.getElementById("bonusOverlay").style.display = "none";
  }
</script>

</body>
</html>
