<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8fafd;
      padding: 20px;
    }
    .round-header {
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
      background: #e8e8e8;
      padding: 10px;
      border-radius: 5px;
    }
    .match {
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 10px 0;
      padding: 10px;
    }
    .match.correct {
      background-color: #d4f8d4;
    }
    .match.incorrect {
      background-color: #f8d4d4;
    }
    .match .result {
      font-weight: bold;
    }
    .outcome {
      padding: 2px 6px;
      border-radius: 4px;
      background: #ddd;
      margin-left: 5px;
      font-size: 0.9em;
    }
    .summary {
      margin: 10px 0 20px;
      font-weight: bold;
    }
    .tip {
      margin-left: 10px;
      font-style: italic;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc,
      query,
      where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const userId = user.uid;
      const userDoc = await getDoc(doc(db, "users", userId));
      const nickname = userDoc.exists() ? userDoc.data().nickname || user.email : user.email;

      const tipsSnap = await getDocs(query(collection(db, "tips"), where("userId", "==", userId)));
      const tips = tipsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const matchesSnap = await getDocs(collection(db, "matches"));
      const matches = matchesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const rounds = {};

      for (const tip of tips) {
        const match = matches.find(m => m.id === tip.matchId);
        if (!match || !match.result || !match.outcome) continue;

        const roundId = match.roundId || "1";
        if (!rounds[roundId]) rounds[roundId] = [];
        rounds[roundId].push({ tip, match });
      }

      const container = document.body;
      const sortedRounds = Object.keys(rounds).sort((a, b) => b - a);

      for (const roundId of sortedRounds) {
        let totalPoints = {};
        const header = document.createElement("div");
        header.className = "round-header";
        header.textContent = `Forduló ${roundId}`;
        const roundContent = document.createElement("div");
        roundContent.style.display = "none";

        header.addEventListener("click", () => {
          roundContent.style.display = roundContent.style.display === "none" ? "block" : "none";
        });

        for (const { tip, match } of rounds[roundId]) {
          const matchDiv = document.createElement("div");
          const correct = tip.tip === match.outcome;
          const odds = match.odds?.[tip.tip] || 0;
          const multiplier = tip.isDouble ? 2 : 1;
          const points = correct ? (odds * multiplier).toFixed(1) : "0";
          const userLabel = `${nickname}: ${tip.tip}${tip.isDouble ? " (dupla)" : ""} (${correct ? "+" + points : "+0"} pont)`;

          totalPoints[nickname] = (totalPoints[nickname] || 0) + parseFloat(points);

          matchDiv.className = "match " + (correct ? "correct" : "incorrect");
          matchDiv.innerHTML = `
            <div class="result">${match.homeTeam} - ${match.awayTeam}: ${match.result}
              <span class="outcome">(${match.outcome})</span>
            </div>
            <div class="details">
              Dátum: ${match.startTime?.seconds ? new Date(match.startTime.seconds * 1000).toLocaleString() : "-"}<br>
              Oddsok: 1 - ${match.odds?.["1"] ?? "-"}, X - ${match.odds?.["X"] ?? "-"}, 2 - ${match.odds?.["2"] ?? "-"}
            </div>
            <div class="tip">${userLabel}</div>
          `;
          roundContent.appendChild(matchDiv);
        }

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.innerHTML = `Forduló összesítés:<br>${nickname}: ${totalPoints[nickname].toFixed(1)} pont`;
        roundContent.appendChild(summary);

        container.appendChild(header);
        container.appendChild(roundContent);
      }
    });
  </script>
</head>
<body>
  <h1>Eredmények</h1>
</body>
</html>
