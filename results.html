<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredm√©nyek</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    h2 { margin-top: 30px; }
    .match-box { background: white; padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc; }
    .tip { margin-left: 20px; padding: 4px 0; }
    .tip.correct { color: green; font-weight: bold; }
    .tip.incorrect { color: red; }
  </style>
</head>
<body>
  <h1>Eredm√©nyek</h1>
  <div id="resultsContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadData() {
      const [matchesSnap, tipsSnap, usersSnap] = await Promise.all([
        getDocs(collection(db, "matches")),
        getDocs(collection(db, "tips")),
        getDocs(collection(db, "users"))
      ]);

      const now = new Date();
      const users = {};
      usersSnap.forEach(doc => users[doc.id] = doc.data().nickname || doc.data().email);

      const tipsByMatch = {};
      tipsSnap.forEach(doc => {
        const data = doc.data();
        if (!tipsByMatch[data.matchId]) tipsByMatch[data.matchId] = [];
        tipsByMatch[data.matchId].push({ ...data, id: doc.id });
      });

      const matchesByRound = {};
      matchesSnap.forEach(doc => {
        const data = doc.data();
        const start = data.startTime?.toDate?.();
        if (!start || start > now) return;
        const round = data.roundId || "Egy√©b";
        if (!matchesByRound[round]) matchesByRound[round] = [];
        matchesByRound[round].push({ id: doc.id, ...data });
      });

      const container = document.getElementById("resultsContainer");
      container.innerHTML = "";

      Object.keys(matchesByRound).sort().forEach(roundId => {
        const h2 = document.createElement("h2");
        h2.textContent = `${roundId}. fordul√≥`;
        container.appendChild(h2);

        matchesByRound[roundId].forEach(match => {
          const box = document.createElement("div");
          box.className = "match-box";

          const start = match.startTime?.toDate?.()?.toLocaleString("hu-HU") || "";
          const resultText = match.result ? `Eredm√©ny: ${match.result}` : "Eredm√©ny m√©g nincs";

          box.innerHTML = `
            <strong>${match.homeTeam} - ${match.awayTeam}</strong><br>
            Kezd√©s: ${start}<br>
            ${resultText}<br>
          `;

          const matchTips = tipsByMatch[match.id] || [];
          matchTips.forEach(tip => {
            const p = document.createElement("div");
            const userName = users[tip.userId] || tip.userId;
            const tipVal = tip.tip;
            const isDouble = tip.isDouble;
            let outcome = match.outcome;
            let correct = outcome && tipVal === outcome;
            let pont = 0;
            if (correct) {
              const odd = match.odds?.[tipVal];
              pont = odd ? (isDouble ? 2 * odd : odd) : 0;
            }

            p.className = "tip" + (outcome ? (correct ? " correct" : " incorrect") : "");
            p.textContent = `üëâ ${userName} tippje: ${tipVal}${isDouble ? " (dupla)" : ""}${outcome ? ` ‚Üí ${correct ? `‚úîÔ∏è ${pont} pont` : " ‚ùå 0 pont"}` : ""}`;
            box.appendChild(p);
          });

          container.appendChild(box);
        });
      });
    }

    loadData();
  </script>
</body>
</html>
