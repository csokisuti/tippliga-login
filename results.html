<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
    h1, h2 { margin-top: 30px; }
    .match { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 0 5px #ccc; }
    .tip { margin-left: 20px; padding: 8px; border-radius: 6px; background: #eef; margin-top: 5px; }
    .correct { background: #d4edda; }
    .wrong { background: #f8d7da; }
    .bold { font-weight: bold; }
    .hidden { display: none; }
    select { padding: 6px; margin-bottom: 20px; }
    .team-row { display: flex; align-items: center; gap: 8px; font-size: 1.1em; }
    .crest { width: 24px; height: 24px; }
  </style>
</head>
<body>
  <h1>Eredmények</h1>
  <button onclick="window.location.href='dashboard.html'">⬅ Vissza a főoldalra</button>
  <br><br>
  <label for="roundSelect">Válassz fordulót:</label>
  <select id="roundSelect"></select>
  <div id="resultsContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const crestMap = {
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Diósgyőri VTK": "crest/crest-dvtk.png",
      "Ferencváros": "crest/crest-fradi.png",
      "ETO FC Győr": "crest/crest-gyor.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Kisvárda FC": "crest/crest-kisvarda.png",
      "MTK Budapest": "crest/crest-mtk.png",
      "Nyíregyháza Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Puskás Akadémia": "crest/crest-puskas.png",
      "Újpest FC": "crest/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png"
    };

    const roundSelect = document.getElementById("roundSelect");
    const resultsContainer = document.getElementById("resultsContainer");

    // URL paraméter figyelés
    const urlParams = new URLSearchParams(window.location.search);
    const preselectRound = urlParams.get("round");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        document.body.innerHTML = "<h2>Be kell jelentkezned az eredmények megtekintéséhez.</h2>";
        return;
      }

      const matchesSnapshot = await getDocs(collection(db, "matches"));
      const rounds = [...new Set(matchesSnapshot.docs.map(doc => doc.data().round))].sort((a,b) => a - b);

      rounds.forEach(round => {
        const option = document.createElement("option");
        option.value = round;
        option.textContent = `${round}. forduló`;
        roundSelect.appendChild(option);
      });

      // Ha URL paraméterben érkezett a forduló
      if (preselectRound && roundSelect.querySelector(`option[value="${preselectRound}"]`)) {
        roundSelect.value = preselectRound;
        await loadResultsForRound(preselectRound);
      }

      roundSelect.addEventListener("change", () => {
        loadResultsForRound(roundSelect.value);
      });
    });

    async function loadResultsForRound(round) {
      resultsContainer.innerHTML = "";

      const matchesQuery = query(collection(db, "matches"), where("round", "==", parseInt(round)), orderBy("date"));
      const matchesSnapshot = await getDocs(matchesQuery);

      for (const matchDoc of matchesSnapshot.docs) {
        const match = matchDoc.data();
        const matchDiv = document.createElement("div");
        matchDiv.classList.add("match");

        const crestHome = crestMap[match.home] || "";
        const crestAway = crestMap[match.away] || "";

        matchDiv.innerHTML = `
          <div class="team-row">
            <img src="${crestHome}" class="crest"> ${match.home} (${match.homeOdds})
            vs 
            <img src="${crestAway}" class="crest"> ${match.away} (${match.awayOdds})
          </div>
          <div>Eredmény: ${match.result || "-"}</div>
        `;

        const tipsQuery = query(collection(db, "tips"), where("matchId", "==", matchDoc.id));
        const tipsSnapshot = await getDocs(tipsQuery);

        tipsSnapshot.forEach(tipDoc => {
          const tip = tipDoc.data();
          const correct = match.outcome && tip.prediction === match.outcome;
          const tipDiv = document.createElement("div");
          tipDiv.classList.add("tip");
          if (correct) tipDiv.classList.add("correct");
          else if (match.result) tipDiv.classList.add("wrong");

          const points = correct ? (match.odds * (tip.double ? 2 : 1)).toFixed(2) : 0;

          tipDiv.innerHTML = `
            <span class="bold">${tip.user}</span>: ${tip.prediction} 
            ${match.result ? `- Pont: ${points}` : ""}
          `;
          matchDiv.appendChild(tipDiv);
        });

        resultsContainer.appendChild(matchDiv);
      }
    }
  </script>
</body>
</html>
