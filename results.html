<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Eredmények</title>
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
        authDomain: "tippliga-4b3af.firebaseapp.com",
        projectId: "tippliga-4b3af",
        storageBucket: "tippliga-4b3af.appspot.com",
        messagingSenderId: "720359845241",
        appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
      };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const resultsContainer = document.getElementById("results");

    async function renderResults() {
      const matchesSnapshot = await getDocs(collection(db, "matches"));
      const tipsSnapshot = await getDocs(collection(db, "tips"));
      const usersSnapshot = await getDocs(collection(db, "users"));

      const matches = [];
      matchesSnapshot.forEach(doc => matches.push({ id: doc.id, ...doc.data() }));

      const tips = [];
      tipsSnapshot.forEach(doc => tips.push({ id: doc.id, ...doc.data() }));

      const users = {};
      usersSnapshot.forEach(doc => {
        users[doc.id] = doc.data().displayName || doc.id;
      });

      const now = new Date();
      const pastMatches = matches.filter(match => match.startTime && match.startTime.toDate() < now);

      const matchesByRound = {};
      pastMatches.forEach(match => {
        const roundId = match.roundId || "Egyéb";
        if (!matchesByRound[roundId]) matchesByRound[roundId] = [];
        matchesByRound[roundId].push(match);
      });

      const sortedRounds = Object.keys(matchesByRound).sort((a, b) => parseInt(b) - parseInt(a));

      sortedRounds.forEach(roundId => {
        const roundDiv = document.createElement("div");
        const toggle = document.createElement("button");
        toggle.textContent = `Forduló ${roundId}`;
        toggle.onclick = () => {
          content.classList.toggle("hidden");
        };
        roundDiv.appendChild(toggle);

        const content = document.createElement("div");
        let roundTotal = {};

        matchesByRound[roundId].forEach(match => {
          const matchTips = tips.filter(tip => tip.matchId === match.id);

          const matchDiv = document.createElement("div");
          matchDiv.className = "match-block";

          const result = match.result || "?";
          const outcome = match.outcome || "";

          matchDiv.innerHTML = `
            <strong>${match.homeTeam} - ${match.awayTeam}: ${result}</strong>
            <span class="outcome-tag">(${outcome})</span>
            <div>Dátum: ${match.startTime.toDate().toLocaleString("hu-HU")}</div>
            <div>Oddsok: 1 - ${match.odds?.["1"]}, X - ${match.odds?.["X"]}, 2 - ${match.odds?.["2"]}</div>
          `;

          matchTips.forEach(tip => {
            const userName = users[tip.userId] || tip.userId;
            const correct = match.outcome && tip.tip === match.outcome;
            const basePoint = match.odds?.[tip.tip] || 0;
            const score = correct ? basePoint * (tip.isDouble ? 2 : 1) : 0;
            const tipRow = document.createElement("div");
            tipRow.className = correct ? "correct" : "incorrect";

            if (score > 0) {
              roundTotal[userName] = (roundTotal[userName] || 0) + score;
            }

            tipRow.innerHTML = `${userName}: ${tip.tip}${tip.isDouble ? " (dupla)" : ""} ${correct ? `(+${score.toFixed(1)} pont)` : "(0 pont)"}`;
            matchDiv.appendChild(tipRow);
          });

          content.appendChild(matchDiv);
        });

        const totalDiv = document.createElement("div");
        totalDiv.innerHTML = "<strong>Forduló összesítés:</strong><br>" +
          Object.entries(roundTotal).map(([user, points]) => `${user}: ${points.toFixed(1)} pont`).join("<br>");
        content.appendChild(totalDiv);
        roundDiv.appendChild(content);
        resultsContainer.appendChild(roundDiv);
      });
    }

    renderResults();
  </script>
  <style>
    .match-block { border: 1px solid #ccc; margin: 10px 0; padding: 10px; border-radius: 6px; background: #f9f9f9; }
    .correct { background-color: #d4f5d4; padding: 4px; margin-top: 4px; }
    .incorrect { background-color: #f7cccc; padding: 4px; margin-top: 4px; }
    .hidden { display: none; }
    .outcome-tag { font-weight: bold; margin-left: 5px; }
    button { font-weight: bold; padding: 6px 12px; margin-top: 20px; background: #eee; border: 1px solid #ccc; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Eredmények</h2>
  <div id="results"></div>
</body>
</html>

