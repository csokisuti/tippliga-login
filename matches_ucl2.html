<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL TippLiga – Meccstippek</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="fav2.png" sizes="16x16">
  <link rel="icon" type="image/png" href="fav2.png" sizes="32x32">
  <link rel="icon" type="image/png" href="fav2.png">
  <script src="loader.js" defer></script>

  <style>
    .layout{ display:flex; flex-direction:column; gap:16px; max-width:1200px; margin:0 auto; padding:20px; }
    .content-grid{ display:grid; grid-template-columns: 1fr; gap:16px; }
    .header{ display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; }
    .fav-crest{ width:46px; height:46px; object-fit:contain; border-radius:8px; border:1px solid var(--line,#e6eaf1); background:#fff; }
    .welcome{ color:var(--muted,#64748b); margin:4px 0 0; }

    /* liga-váltó balra, a cím mellé */
    .league-switch-left{margin-left:8px}
    @media (max-width:700px){.league-switch-left{width:100%;margin-left:0}}

    .nav-grid{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; }
    @media (max-width: 1100px){ .nav-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width: 700px){ .nav-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .nav-card{ display:flex; gap:12px; align-items:center; text-decoration:none; color:inherit; padding:14px; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 6px 18px rgba(15,23,42,.05); }
    .nav-card .icon-wrap{ width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:color-mix(in oklab, var(--accent,#3b82f6) 15%, white); color:var(--accent,#3b82f6); }
    .nav-card .text{ display:flex; flex-direction:column; line-height:1.2; }
    .nav-card .title{ font-weight:800; }
    .nav-card .desc{ color:var(--muted,#64748b); font-size:12px; }
    .pill-badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; margin-left:6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700; line-height:1; }
    .pill-badge[hidden]{ display:none !important; }

    /* === NAV visszaszámláló kinézet (Top8) === */
    .pill-badge.countdown{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-variant-numeric: tabular-nums;
      letter-spacing:.2px;
    }
    .pill-badge.countdown.urgent{ animation:pulse 1s ease-in-out infinite }
    @keyframes pulse{
      0%{ transform:scale(1) } 50%{ transform:scale(1.06) } 100%{ transform:scale(1) }
    }
    .blink{ animation:blink 1s steps(2,start) infinite }
    @keyframes blink{ to{ opacity:.2 } }
    /* ======================================== */

    .card{ background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,.06); overflow:hidden; }
    .card h3{ margin:0; padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd; }

    /* Nap blokkok */
    .day-block{ padding:12px; }
    .day-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border:1px dashed var(--line,#e6eaf1); border-radius:10px; background:#fafbff; margin-bottom:10px; }
    .day-title{ font-weight:800; }
    .dbl-flag{ display:inline-flex; align-items:center; gap:6px; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--line,#e6eaf1); background:#fff; color:#334155; }
    .dbl-flag svg{ width:14px; height:14px; }
    .dbl-flag.done{ background:#ecfdf5; border-color:#16a34a; color:#166534; }
    .dbl-flag .muted{ color:#64748b; }

    .match-list{ display:flex; flex-direction:column; gap:12px; }
    .match{ display:grid; grid-template-columns: 1fr auto; gap:12px; padding:12px; border:1px solid var(--line,#e6eaf1); border-radius:12px; background:#fff; }
    @media (max-width: 700px){ .match{ grid-template-columns: 1fr; } }
    .teams{ display:flex; align-items:center; gap:12px; }
    .team{ display:flex; align-items:center; gap:8px; }
    .crest{ width:28px; height:28px; object-fit:contain; border-radius:6px; background:#fff; border:1px solid var(--line,#e6eaf1); }
    .vs{ font-weight:700; color:#475569; }
    .meta{ color:#64748b; font-size:12px; }
    .odds{ display:flex; gap:10px; font-size:12px; color:#475569; flex-wrap:wrap; }
    .ctl{ display:flex; align-items:center; gap:10px; }
    .select{ padding:8px 10px; border-radius:10px; border:1px solid var(--line,#e6eaf1); }
    .double-wrap{ display:flex; align-items:center; gap:6px; }
    .save-state{ font-size:12px; color:#16a34a; display:none; }
    .save-state.show{ display:inline-flex; }

    .btn-accent{
      min-height:40px; padding:10px 14px; border-radius:10px;
      background:var(--accent,#3b82f6); color:#fff; border:1px solid var(--line,#e6eaf1);
      font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .btn-accent:hover{ filter:brightness(.95); }
    .btn-accent:focus{ outline:2px solid color-mix(in oklab, var(--accent,#3b82f6) 30%, white); outline-offset:2px; }
    .btn-icon{ width:18px; height:18px; display:inline-block; }

    /* Chat – BL külön gyűjtemény */
    .chat-fab{ position:fixed; right:22px; bottom:22px; z-index:999; width:52px; height:52px; border-radius:999px; border:0; background:var(--accent,#3b82f6); color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 26px rgba(0,0,0,.15); }
    .chat-fab .fab-badge{ position:absolute; top:-4px; right:-4px; min-width:20px; height:20px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:800; line-height:20px; display:none; }
    .chat-fab.has-unread .fab-badge{ display:inline-block; }
    .chat-panel{ position:fixed; right:22px; bottom:86px; z-index:998; width:380px; max-width:calc(100vw - 32px); max-height:70vh; display:none; flex-direction:column; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 10px 32px rgba(0,0,0,.14); }
    .chat-panel.open{ display:flex; }
    .chat-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd; }
    .chat-title{ font-weight:800; }
    #chatClose{ width:28px; height:28px; border-radius:8px; font-size:18px; line-height:28px; display:inline-flex; align-items:center; justify-content:center; background:#eef2ff; color:#111; border:1px solid var(--line,#e6eaf1); cursor:pointer; }
    #chatClose:hover{ filter:brightness(0.95); }
    .chat-list{ overflow:auto; padding:8px 10px; }
    .chat-empty{ color:#64748b; font-size:13px; padding:8px 10px; }
    .msg{ padding:8px 10px; border-bottom:1px solid var(--line,#e6eaf1); display:flex; gap:8px; align-items:flex-start; }
    .msg .meta{ font-size:12px; color:#64748b; margin-bottom:2px; }
    .msg .text{ white-space:pre-wrap; word-break:break-word; }
    .msg .del{ margin-left:auto; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:2px 8px; border-radius:8px; font-size:12px; cursor:pointer; display:none; }
    .msg:hover .del{ display:inline-block; }
    #chatComposer{ display:flex; gap:8px; align-items:center; padding:10px; border-top:1px solid var(--line,#e6eaf1); background:#fff; }
    #chatInput{ background:#fff; color:#111; border:1px solid var(--line,#e6eaf1); height:40px; padding:8px 10px; border-radius:10px; font-size:14px; outline:none; }
    #chatSendBtn{ min-width:90px; padding:8px 12px; border-radius:10px; background:var(--accent,#3b82f6); color:#fff; border:0; font-weight:600; cursor:pointer; }

    /* NB1-hez igazított odds méret – minimális override, mást nem piszkálunk */
    .match .odds{ font-size:16px !important; }

    .advance-box{margin-top:10px;padding:10px;border:1px dashed rgba(148,163,184,.55);border-radius:12px;background:#fff}
    .advance-title{font-weight:800;font-size:12px;margin:0 0 8px;color:#0f172a}
    .advance-options{display:flex;flex-direction:column;gap:6px}
    .adv-opt{display:flex;align-items:center;gap:8px;font-size:13px}
    .adv-odds{margin-left:auto;font-weight:800;font-variant-numeric:tabular-nums;color:#0f172a}
    .adv-lock{opacity:.6}

    /* Mobil: továbbjutó blokk ne lógjon ki */
    @media (max-width: 600px){
      .advance-box{ padding:8px; }
      .adv-opt{ font-size:12px; }
      .adv-odds{ font-size:12px; }
    }
    @media (max-width: 420px){
      .adv-opt{ flex-wrap:wrap; }
      .adv-odds{ width:100%; text-align:right; margin-top:2px; }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, getDocs, addDoc, serverTimestamp,
      query, where, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initLeagueSwitcher } from "./league-switcher.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const TIP_HISTORY = "tipHistory";

    const crestMap = {
      "Ajax": "ucl_crest/ajax.png",
      "Arsenal": "ucl_crest/arsenal.png",
      "Atalanta": "ucl_crest/atalanta.png",
      "Athletic Bilbao": "ucl_crest/athletic.png",
      "Atlético Madrid": "ucl_crest/atletico.png",
      "Barcelona": "ucl_crest/barcelona.png",
      "Bayern München": "ucl_crest/bayern.png",
      "Benfica": "ucl_crest/benfica.png",
      "Borussia Dortmund": "ucl_crest/borussia.png",
      "Bodø/Glimt": "ucl_crest/bodo.png",
      "Club Bruges": "ucl_crest/brugge.png",
      "Chelsea": "ucl_crest/chelsea.png",
      "FC Köbenhavn": "ucl_crest/copenhagen.png",
      "Eintracht Frankfurt": "ucl_crest/frankfurt.png",
      "Galatasaray": "ucl_crest/galata.png",
      "Internazionale": "ucl_crest/inter.png",
      "Juventus": "ucl_crest/juventus.png",
      "Bayer Leverkusen": "ucl_crest/leverkusen.png",
      "Liverpool": "ucl_crest/liverpool.png",
      "Manchester City": "ucl_crest/mancity.png",
      "Olympique Marseille": "ucl_crest/marseille.png",
      "Monaco": "ucl_crest/monaco.png",
      "Napoli": "ucl_crest/napoli.png",
      "Newcastle United": "ucl_crest/newcastle.png",
      "Olympiakosz Pireusz": "ucl_crest/olympiacos.png",
      "Pafosz": "ucl_crest/pafos.png",
      "Paris Saint-Germain": "ucl_crest/psg.png",
      "PSV": "ucl_crest/psv.png",
      "Qarabag": "ucl_crest/qarabag.png",
      "Real Madrid": "ucl_crest/real.png",
      "Slavia Praha": "ucl_crest/slavia.png",
      "Sporting CP": "ucl_crest/sporting.png",
      "Tottenham Hotspur": "ucl_crest/tottenham.png",
      "Union Saint-Gilloise": "ucl_crest/usg.png",
      "Villarreal": "ucl_crest/villareal.png",
      "Kajrat Almati": "ucl_crest/kairat.png"
    };
    const crestFor = t => crestMap[t] || "";
    const fmtTime = ts => { try{ return ts.toDate().toLocaleString("hu-HU",{hour12:false}); }catch{ return ""; } };

    function getOdds(m, key){
      if (m?.odds && (key in m.odds)) return m.odds[key];
      if (key==="1") return m.odds1 ?? m["odds1"];
      if (key==="X") return m.oddsX ?? m["oddsX"];
      if (key==="2") return m.odds2 ?? m["odds2"];
      return undefined;
    }

    const matchRound = m => String(m.round ?? m.roundId ?? "");
    const tipChoice = t => (t?.choice ?? t?.tip ?? "");
    const tipDouble = t => !!(t?.double ?? t?.isDouble);
    const tipTsMs   = t => t?.updatedAt?.toMillis?.() || t?.createdAt?.toMillis?.() || t?.timestamp?.toMillis?.() || 0;

    const sanitizeEmail = (e)=> String(e).replace(/[^a-zA-Z0-9._-]/g,'_');
    const oddsSnapshotFromMatch = (m)=> m ? ({
      "1": m?.odds?.["1"] ?? m?.odds1 ?? null,
      "X": m?.odds?.["X"] ?? m?.oddsX ?? null,
      "2": m?.odds?.["2"] ?? m?.odds2 ?? null
    }) : null;

    const pad2 = n => String(n).padStart(2,'0');
    function asDate(v){ return v?.toDate?.() ? v.toDate() : new Date(v); }
    function dayKeyFromDate(dt){ return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`; }
    function dayLabel(dayKey){
      const [y,m,d] = dayKey.split('-').map(Number);
      const dt = new Date(y, m-1, d);
      return dt.toLocaleDateString('hu-HU', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    }

    let navCdTimer = null;
    function formatCountdown(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const d = Math.floor(total/86400);
      const h = Math.floor((total%86400)/3600);
      const m = Math.floor((total%3600)/60);
      const s = total%60;
      const H = String(h).padStart(2,'0');
      const M = String(m).padStart(2,'0');
      const S = String(s).padStart(2,'0');
      const labelHTML = d>0
        ? `<span class="mono">${d}n&nbsp;</span><span class="mono">${H}<span class="blink">:</span>${M}<span class="blink">:</span>${S}</span>`
        : `<span class="mono">${H}<span class="blink">:</span>${M}<span class="blink">:</span>${S}</span>`;
      const aria = d>0
        ? `${d} nap ${h} óra ${m} perc ${s} másodperc`
        : `${h} óra ${m} perc ${s} másodperc`;
      return { labelHTML, aria };
    }
    function startNavTop8Countdown(until){
      clearInterval(navCdTimer);
      const el = document.getElementById('top8CountdownNav');
      if (!el){ return; }
      el.classList.add('countdown');
      if (!until){
        el.hidden = true;
        return;
      }
      function tick(){
        const ms = until - new Date();
        if (ms <= 0){
          el.hidden = true;
          clearInterval(navCdTimer);
          return;
        }
        const { labelHTML, aria } = formatCountdown(ms);
        el.innerHTML = labelHTML;
        el.setAttribute('aria-live','polite');
        el.setAttribute('aria-label', `Visszaszámláló: ${aria}`);
        el.title = `Határidő: ${until.toLocaleString('hu-HU')}`;
        if (ms <= 5*60*1000){ el.classList.add('urgent'); }
        else { el.classList.remove('urgent'); }
      }
      tick();
      navCdTimer = setInterval(tick, 1000);
      el.hidden = false;
    }

    async function dayKeyForMatchId(matchId){
      try{
        const s = await getDoc(doc(db, "ucl_matches", matchId));
        if (!s.exists()) return null;
        const dt = asDate(s.data().startTime);
        if (isNaN(+dt)) return null;
        return dayKeyFromDate(dt);
      }catch{ return null; }
    }

    async function rebuildDoublesFromTips(tipsArr){
      doublesByDay.clear();
      const latestByDay = new Map();

      const pending = [];
      for (const t of tipsArr){
        if (!tipDouble(t)) continue;
        const ts = tipTsMs(t) || 0;
        if (t.day){
          const prev = latestByDay.get(t.day);
          if (!prev || ts > prev.ts) latestByDay.set(t.day, { matchId:t.matchId, ts });
        }else{
          pending.push((async()=>{
            const dk = await dayKeyForMatchId(t.matchId);
            if (!dk) return;
            const prev = latestByDay.get(dk);
            if (!prev || ts > prev.ts) latestByDay.set(dk, { matchId:t.matchId, ts });
          })());
        }
      }
      await Promise.all(pending);
      latestByDay.forEach((v, dk)=> doublesByDay.set(dk, v.matchId));
    }

    function numOrNull(v){
      const n = parseFloat(String(v ?? "").replace(",", "."));
      return (isFinite(n) ? n : null);
    }

    async function loadBracketFirstLegs(){
      firstLegByMatchId.clear();
      try{
        const snap = await getDoc(doc(db,"settings","ucl_bracket"));
        if (!snap.exists()) return;
        const data = snap.data() || {};
        const slots = (data.slots && typeof data.slots === "object") ? data.slots : {};
        Object.entries(slots).forEach(([slotId, s])=>{
          const matchIds = Array.isArray(s?.matchIds) ? s.matchIds : [];
          const firstLegId = matchIds[0];
          if (!firstLegId) return;

          const oh = numOrNull(s.advanceOddsHome ?? s.advanceOdds?.home);
          const oa = numOrNull(s.advanceOddsAway ?? s.advanceOdds?.away);
          if (!oh || !oa || oh <= 1 || oa <= 1) return;

          firstLegByMatchId.set(String(firstLegId), {
            slotId,
            oddsHome: oh,
            oddsAway: oa
          });
        });
      }catch(e){
        console.warn("loadBracketFirstLegs err:", e);
      }
    }

    async function loadMyAdvanceTips(){
      myAdvanceTipsBySlot.clear();
      try{
        const snap = await getDocs(query(collection(db,"ucl_advance_tips"),
          where("user","==", currentUserEmail)
        ));
        snap.forEach(d=>{
          const v = d.data() || {};
          const slotId = v.slotId || v.slot || "";
          if (!slotId) return;
          myAdvanceTipsBySlot.set(String(slotId), { id:d.id, ...v });
        });
      }catch(e){
        console.warn("loadMyAdvanceTips err:", e);
      }
    }

    async function saveAdvanceTipWithAudit(matchObj, slotInfo, pick, savedEl){
      const slotId = slotInfo.slotId;
      const matchId = matchObj.id;
      const pickVal = pick || "";
      const odds = pickVal === "home" ? slotInfo.oddsHome : (pickVal === "away" ? slotInfo.oddsAway : null);

      if (!pickVal){
        alert("Válaszd ki a továbbjutót!");
        return;
      }
      if (!odds){
        alert("Hiányzó továbbjutó odds (admin).");
        return;
      }

      const kickoff = asDate(matchObj.startTime);
      if (!isNaN(+kickoff) && new Date() >= kickoff){
        alert("A továbbjutó tipp az első meccs kezdetéig adható le.");
        return;
      }

      const fixedId = `${sanitizeEmail(currentUserEmail)}_${slotId}`;
      const prev = myAdvanceTipsBySlot.get(String(slotId));
      const prevPick = prev?.pick ?? prev?.advancePick ?? prev?.choice ?? null;

      if (prevPick === pickVal){
        savedEl.classList.add("show");
        setTimeout(()=>savedEl.classList.remove("show"), 900);
        return;
      }

      try{
        await setDoc(doc(db,"ucl_advance_tips", fixedId), {
          user: currentUserEmail,
          nick: currentUserNick || currentUserEmail,
          slotId,
          matchId: String(matchId),
          pick: pickVal,
          odds: odds,
          updatedAt: serverTimestamp(),
          timestamp: serverTimestamp(),
          createdAt: prev ? (prev.createdAt || serverTimestamp()) : serverTimestamp()
        }, { merge:true });

        await addDoc(collection(db, TIP_HISTORY), {
          user: currentUserEmail,
          slotId,
          matchId,
          kind: "advance",
          prevPick,
          newPick: pickVal,
          odds,
          page: "matches_ucl.html",
          ts: serverTimestamp()
        });

        myAdvanceTipsBySlot.set(String(slotId), {
          id: fixedId,
          user: currentUserEmail,
          slotId,
          matchId,
          pick: pickVal,
          odds
        });

        savedEl.classList.add("show");
        setTimeout(()=>savedEl.classList.remove("show"), 900);
      }catch(e){
        console.warn("saveAdvanceTipWithAudit err:", e);
        alert("Mentési hiba (továbbjutó): " + (e?.message || String(e)));
      }
    }

    let currentUserEmail = "";
    let currentUserNick  = "";
    let currentUserRole  = "user";
    let favouriteTeamucl = "";
    let chatLastSeenUcl  = null;

    let myAdvanceTipsBySlot = new Map();
    let firstLegByMatchId = new Map();

    let myTipsByMatch = new Map();
    let doublesByDay  = new Map();
    let earliestStartByDay = new Map();
    let matchesByDay = new Map();

    const isDayLocked = dayKey => {
      const first = earliestStartByDay.get(dayKey);
      return first ? (new Date() >= first) : false;
    };

    function getStakeValue(m){
      const s = m?.stake ?? m?.stakeUcl ?? m?.stakeMultiplier ?? m?.roundStake ?? null;
      const n = parseFloat(String(s ?? "").replace(",", "."));
      if (isFinite(n)) return n;
      if (s === null || s === undefined || s === "") return null;
      return s;
    }
    function fmtStake(st){
      if (st === null || st === undefined) return "-";
      if (typeof st === "number") return String(st).replace(".", ",");
      return String(st);
    }
    function isDoubleRound(m){
      const rnum = parseInt(matchRound(m)) || 0;
      return rnum > 0 && rnum <= 8;
    }

    document.addEventListener("DOMContentLoaded", () => {
      initLeagueSwitcher({ mountTarget: document.getElementById('leagueSwitchMount') });

      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login_ucl.html"; return; }
        currentUserEmail = user.email;

        const userRef = doc(db, "users", currentUserEmail);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const d = userSnap.data();
          currentUserNick  = d.nickname || currentUserEmail;
          currentUserRole  = d.role || "user";
          favouriteTeamucl = d.favouriteTeamucl || "";
          chatLastSeenUcl  = d.chatLastSeenUcl || null;
        } else {
          currentUserNick = currentUserEmail;
        }

        document.getElementById("welcome").textContent = `Üdv, ${currentUserNick}!`;
        if (currentUserRole === "admin") document.getElementById("adminLink").style.display = "flex";

        if (favouriteTeamucl) {
          const themeClass = "theme-" + favouriteTeamucl.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-');
          document.body.classList.add(themeClass);
          const crest = crestMap[favouriteTeamucl];
          if (crest) { const img = document.getElementById("favCrest"); img.src = crest; img.alt = favouriteTeamucl; img.hidden = false; }
        }

        try{
          const snap = await getDoc(doc(db,'settings','positionsLock_ucl'));
          let until = null, isLocked = false;
          if (snap.exists()){
            const d = snap.data() || {};
            until = d.lockUntil?.toDate?.() || null;
            const now = new Date();
            isLocked = !!d.isLocked || (until && now >= until);
          }
          startNavTop8Countdown(isLocked ? null : until);
        }catch{
          startNavTop8Countdown(null);
        }

        try{
          const now = new Date();

          const upcomingSnap = await getDocs(query(collection(db,"ucl_matches"), where("startTime", ">=", now), orderBy("startTime","asc")));
          const upcoming = upcomingSnap.docs.map(d => ({ id:d.id, ...d.data() }));

          const tipsSnap = await getDocs(query(collection(db,"ucl_tips"), where("user","==", currentUserEmail)));
          const tips = tipsSnap.docs.map(x=>({ id:x.id, ...x.data() }));
          const latestByMatch = new Map();
          for (const t of tips){
            const k = t.matchId;
            if (!k) continue;
            const prev = latestByMatch.get(k);
            if (!prev || tipTsMs(t) >= tipTsMs(prev)) latestByMatch.set(k, t);
          }
          myTipsByMatch = latestByMatch;

          await loadBracketFirstLegs();
          await loadMyAdvanceTips();

          await rebuildDoublesFromTips(tips);

          matchesByDay.clear();
          for (const m of upcoming){
            const st = asDate(m.startTime);
            const dk = dayKeyFromDate(st);
            if (!matchesByDay.has(dk)) matchesByDay.set(dk, []);
            matchesByDay.get(dk).push(m);

            const t = myTipsByMatch.get(m.id);
            if (t && tipDouble(t) && !doublesByDay.has(dk)) {
              doublesByDay.set(dk, m.id);
            }
          }
          for (const arr of matchesByDay.values()){
            arr.sort((a,b)=> asDate(a.startTime) - asDate(b.startTime));
          }

          earliestStartByDay.clear();
          const allSnap = await getDocs(query(collection(db,"ucl_matches"), orderBy("startTime","asc")));
          allSnap.forEach(docu=>{
            const m = docu.data();
            const dt = asDate(m.startTime);
            if (isNaN(+dt)) return;
            const dk = dayKeyFromDate(dt);
            const prev = earliestStartByDay.get(dk);
            if (!prev || dt < prev) earliestStartByDay.set(dk, dt);
          });

          buildMatchesList();
          updatePendingBadge(upcoming);
        }catch(e){ console.warn(e); }

        initChat(userRef);

        document.getElementById("logout").addEventListener("click", () => {
          signOut(auth).then(() => window.location.href = "login_ucl.html");
        });

        if (window.hideLoader) hideLoader();
      });
    });

    function updatePendingBadge(upcoming){
      const tippedIds = new Set(Array.from(myTipsByMatch.keys()));
      const pending = upcoming.filter(m => !tippedIds.has(m.id)).length;
      const badge = document.getElementById("tipsBadge");
      if (badge){ if (pending>0){ badge.textContent = pending; badge.hidden = false; } else { badge.hidden = true; } }
    }

    function buildMatchesList(){
      const wrap = document.getElementById("matchList");
      wrap.innerHTML = "";

      const dayKeys = Array.from(matchesByDay.keys()).sort();
      for (const dk of dayKeys){
        const matches = matchesByDay.get(dk) || [];
        const dayHasDouble = matches.some(m => isDoubleRound(m));

        const dayBlock = document.createElement('div');
        dayBlock.className = 'day-block';
        dayBlock.dataset.day = dk;

        const head = document.createElement('div');
        head.className = 'day-head';

        head.innerHTML = `
          <div class="day-title">${dayLabel(dk)}</div>
          ${dayHasDouble ? `
          <div class="dbl-flag" id="flag-${dk}">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2l2.39 4.84L20 7.27l-4 3.9.94 5.49L12 14.77 7.06 16.66 8 11.94l-4-3.9 5.61-.43L12 2z"/></svg>
            <span class="txt">Ne felejtsd el a mai duplázót ;)</span>
          </div>` : ``}
        `;
        dayBlock.appendChild(head);

        const list = document.createElement('div');
        list.className = 'match-list';
        dayBlock.appendChild(list);

        wrap.appendChild(dayBlock);

        for (const m of matches){
          const tip = myTipsByMatch.get(m.id) || {};
          const curChoice = tipChoice(tip);
          const isDouble  = tipDouble(tip);
          const roundStr  = matchRound(m);

          const o1 = getOdds(m,"1"); const oX = getOdds(m,"X"); const o2 = getOdds(m,"2");
          const oddsLine = `Odds: 1: ${o1 ?? "-"} • X: ${oX ?? "-"} • 2: ${o2 ?? "-"}`;

          const stakeVal = getStakeValue(m);
          const stakeLine = `Stake: ${fmtStake(stakeVal)}`;

          const row = document.createElement('div');
          row.className = 'match';
          row.dataset.day = dk;
          row.dataset.matchId = m.id;

          const left = document.createElement('div');
          left.innerHTML = `
            <div class="teams">
              <div class="team"><img class="crest" src="${crestFor(m.homeTeam)||''}" alt=""> <span>${m.homeTeam||''}</span></div>
              <span class="vs">vs</span>
              <div class="team"><img class="crest" src="${crestFor(m.awayTeam)||''}" alt=""> <span>${m.awayTeam||''}</span></div>
            </div>
            <div class="meta">${fmtTime(m.startTime)} • Forduló: ${roundStr || "–"}</div>
            <div class="odds">${oddsLine}</div>
            <div class="meta">${stakeLine}</div>
          `;

          const right = document.createElement('div');
          right.className = 'ctl';
          const select = document.createElement('select');
          select.className = 'select';
          select.innerHTML = `<option value="">Válassz tippet</option><option value="1">1</option><option value="X">X</option><option value="2">2</option>`;
          select.value = curChoice;

          const dblWrap = document.createElement('label');
          dblWrap.className = 'double-wrap';
          const dbl = document.createElement('input');
          dbl.type = 'checkbox';
          dbl.checked = isDouble;
          dbl.dataset.kind = 'double';
          const dblText = document.createElement('span');
          dblText.textContent = 'Dupla';
          dblWrap.appendChild(dbl); dblWrap.appendChild(dblText);

          const saved = document.createElement('span');
          saved.className = 'save-state';
          saved.textContent = 'Mentve';

          right.appendChild(select);
          const rnum = parseInt(matchRound(m))||0;
          if (rnum<=8) right.appendChild(dblWrap);
          right.appendChild(saved);

          const slotInfo = firstLegByMatchId.get(String(m.id));
          if (slotInfo){
            const box = document.createElement('div');
            box.className = 'advance-box';

            const title = document.createElement('div');
            title.className = 'advance-title';
            title.textContent = 'Továbbjutó tipp (csak az 1. meccs előtt)';
            box.appendChild(title);

            const opts = document.createElement('div');
            opts.className = 'advance-options';

            const saved2 = document.createElement('span');
            saved2.className = 'save-state';
            saved2.textContent = 'Mentve';

            const kickoff = asDate(m.startTime);
            const locked = (!isNaN(+kickoff) && new Date() >= kickoff);

            const curAdv = myAdvanceTipsBySlot.get(String(slotInfo.slotId));
            const curPick = (curAdv?.pick ?? curAdv?.advancePick ?? curAdv?.choice ?? "");

            const mkOpt = (val, label, odds)=>{
              const lab = document.createElement('label');
              lab.className = 'adv-opt' + (locked ? ' adv-lock' : '');
              const r = document.createElement('input');
              r.type = 'radio';
              r.name = `adv_${m.id}`;
              r.value = val;
              r.checked = (curPick === val);
              r.disabled = locked;
              const sp = document.createElement('span');
              sp.textContent = label;
              const od = document.createElement('span');
              od.className = 'adv-odds';
              od.textContent = odds ? String(odds).replace('.', ',') : '-';
              lab.appendChild(r); lab.appendChild(sp); lab.appendChild(od);
              r.addEventListener('change', async ()=>{
                await saveAdvanceTipWithAudit(m, slotInfo, val, saved2);
              });
              return lab;
            };

            opts.appendChild(mkOpt('home', m.homeTeam || 'Hazai', slotInfo.oddsHome));
            opts.appendChild(mkOpt('away', m.awayTeam || 'Vendég', slotInfo.oddsAway));
            box.appendChild(opts);

            const foot = document.createElement('div');
            foot.style.display = 'flex';
            foot.style.justifyContent = 'flex-end';
            foot.style.marginTop = '8px';
            foot.appendChild(saved2);
            box.appendChild(foot);

            right.appendChild(box);
          }

          row.appendChild(left);
          row.appendChild(right);
          list.appendChild(row);

          if (isDayLocked(dk)){
            dbl.disabled = true;
            dbl.title = "Ezen a napon a duplázás már lezárt (az első meccs elkezdődött).";
          }

          select.addEventListener('change', async ()=>{ await saveTipWithAudit(m, select.value, dbl.checked, dk, saved); });

          dbl.addEventListener('change', async ()=>{
            if (isDayLocked(dk)){
              const lockedId = doublesByDay.get(dk);
              dbl.checked = (lockedId === m.id);
              alert("Ezen a napon a duplázás már lezárt (az első meccs elkezdődött).");
              return;
            }
            if (dbl.checked){
              reflectDoubleStateForDay(dk, m.id);
              await enforceSingleDoubleForDay(dk, m.id);
              doublesByDay.set(dk, m.id);
              updateDayFlag(dk);
            }else{
              if (doublesByDay.get(dk) === m.id) doublesByDay.delete(dk);
              updateDayFlag(dk);
            }
            await saveTipWithAudit(m, select.value, dbl.checked, dk, saved);
          });

          const lockedId = doublesByDay.get(dk);
          if (lockedId && lockedId !== m.id){ dbl.checked = false; }
        }

        if (dayHasDouble) updateDayFlag(dk);
      }
    }

    function updateDayFlag(dayKey){
      const flag = document.getElementById(`flag-${dayKey}`);
      if (!flag) return;

      const selId = doublesByDay.get(dayKey);
      const has = !!selId;
      flag.classList.toggle('done', has);

      if (has){
        const visibleRow = document.querySelector(`.match[data-day="${dayKey}"][data-match-id="${selId}"], .match[data-day="${dayKey}"][data-matchid="${selId}"]`);
        const suffix = visibleRow ? '' : ' (már elkezdődött)';
        flag.querySelector('.txt').textContent = 'Dupla kiválasztva' + suffix;
        if (!visibleRow){
          flag.title = 'A kiválasztott dupla meccs már elkezdődött, ezért nem látszik a listában.';
        } else {
          flag.removeAttribute('title');
        }
      } else {
        flag.querySelector('.txt').textContent = 'Ne felejtsd el a mai duplázót ;)';
        flag.removeAttribute('title');
      }
    }

    function reflectDoubleStateForDay(dayKey, keepMatchId){
      document.querySelectorAll(`.match[data-day="${dayKey}"]`).forEach(row=>{
        const chk = row.querySelector('input[type="checkbox"][data-kind="double"]');
        if (chk) chk.checked = (row.dataset.matchId === String(keepMatchId));
      });
    }

    async function enforceSingleDoubleForDay(dayKey, keepMatchId){
      const idsForDay = new Set((matchesByDay.get(dayKey) || []).map(m=>m.id));
      const qTips = query(collection(db,"ucl_tips"), where("user","==", currentUserEmail));
      const snap = await getDocs(qTips);
      for (const docu of snap.docs){
        const d = docu.data();
        if (!d?.matchId) continue;
        if (!idsForDay.has(d.matchId)) continue;
        if (d.matchId !== keepMatchId && (d.double === true || d.isDouble === true)){
          const prevChoice = d.choice ?? d.tip ?? "";
          try{
            await updateDoc(doc(db,"ucl_tips", docu.id), {
              double:false, isDouble:false, updatedAt: serverTimestamp(), timestamp: serverTimestamp(), day: dayKey
            });
            await addDoc(collection(db, TIP_HISTORY), {
              user: d.user || currentUserEmail,
              matchId: d.matchId,
              tipDocId: docu.id,
              day: dayKey,
              round: String(d.round ?? d.roundId ?? ""),
              prevChoice,
              prevDouble: true,
              newChoice: prevChoice,
              newDouble: false,
              reason: "system:enforceSingleDouble",
              page: "matches_ucl.html",
              ts: serverTimestamp()
            });
          }catch(e){ console.warn("enforceSingleDoubleForDay err:", e); }
        }
      }
    }

    async function saveTipWithAudit(matchObj, choice, isDouble, dayKey, savedEl){
      const matchId = matchObj.id;
      const roundStr = matchRound(matchObj);

      let existingId = null, prevChoice = null, prevDouble = null;
      try{
        const snap = await getDocs(query(collection(db,"ucl_tips"),
          where("user","==", currentUserEmail),
          where("matchId","==", matchId)
        ));
        if (!snap.empty){
          const d = snap.docs[0];
          const v = d.data() || {};
          existingId = d.id;
          prevChoice = v.choice ?? v.tip ?? null;
          prevDouble = !!(v.double ?? v.isDouble);
        }
      }catch(e){}

      const newChoice = choice || "";
      const newDouble = !!isDouble;

      if (existingId && prevChoice === newChoice && prevDouble === newDouble){
        savedEl.classList.add("show");
        setTimeout(()=>savedEl.classList.remove("show"), 900);
        return;
      }

      try{
        if (existingId){
          await updateDoc(doc(db,"ucl_tips", existingId), {
            choice: newChoice,
            tip: newChoice,
            double: newDouble,
            isDouble: newDouble,
            day: dayKey,
            round: String(roundStr),
            roundId: String(roundStr),
            updatedAt: serverTimestamp(),
            timestamp: serverTimestamp()
          });
        } else {
          const fixedId = `${sanitizeEmail(currentUserEmail)}_${matchId}`;
          await setDoc(doc(db,"ucl_tips", fixedId), {
            user: currentUserEmail,
            nick: currentUserNick || currentUserEmail,
            matchId,
            day: dayKey,
            round: String(roundStr),
            roundId: String(roundStr),
            choice: newChoice,
            tip: newChoice,
            double: newDouble,
            isDouble: newDouble,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            timestamp: serverTimestamp()
          }, { merge:true });
          existingId = fixedId;
        }

        await addDoc(collection(db, TIP_HISTORY), {
          user: currentUserEmail,
          matchId,
          tipDocId: existingId,
          day: dayKey,
          round: String(roundStr),
          prevChoice,
          prevDouble,
          newChoice,
          newDouble,
          oddsSnapshot: oddsSnapshotFromMatch(matchObj),
          reason: "user",
          page: "matches_ucl.html",
          ts: serverTimestamp()
        });

        myTipsByMatch.set(matchId, {
          user: currentUserEmail,
          matchId,
          day: dayKey,
          round: String(roundStr),
          choice: newChoice,
          double: newDouble
        });

        savedEl.classList.add("show");
        setTimeout(()=>savedEl.classList.remove("show"), 900);
      }catch(e){
        console.warn("saveTipWithAudit err:", e);
        alert("Mentési hiba: " + (e?.message || String(e)));
      }
    }

    function initChat(userRef){
      const fab = document.getElementById('chatToggle');
      const fabBadge = document.getElementById('chatFabBadge');
      const panel = document.getElementById('chatPanel');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatMessages');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSendBtn');

      function open(){ panel.classList.add('open'); setTimeout(()=>inputEl?.focus(), 50); markSeen(); }
      function close(){ panel.classList.remove('open'); }
      function toggle(){ panel.classList.contains('open') ? close() : open(); }
      fab.addEventListener('click', toggle);
      closeBtn.addEventListener('click', close);

      let lastSeenMs = chatLastSeenUcl?.toMillis ? chatLastSeenUcl.toMillis() : 0;

      const qAll = query(collection(db,'chatMessages_ucl'), orderBy('ts','asc'));
      onSnapshot(qAll, snap => {
        listEl.innerHTML = '';
        if (snap.empty){
          const empty = document.createElement('div');
          empty.className = 'chat-empty';
          empty.textContent = 'Még nincs üzenet. Légy te az első!';
          listEl.appendChild(empty);
        } else {
          let unread = 0;
          snap.forEach(docu=>{
            const d = docu.data();
            const tsMs = d.ts?.toMillis?.() || 0;
            if (tsMs > lastSeenMs) unread++;

            const row = document.createElement('div');
            row.className = 'msg';
            row.innerHTML = `
              <div style="flex:1 1 auto">
                <div class="meta"><strong>${d.nick || 'Ismeretlen'}</strong> • ${d.ts ? fmtTime(d.ts) : ''}</div>
                <div class="text">${(d.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
              </div>
            `;
            const canDelete = (currentUserRole === 'admin') || (d.email === currentUserEmail);
            if (canDelete){
              const del = document.createElement('button');
              del.className = 'del';
              del.textContent = 'Törlés';
              del.title = 'Üzenet törlése';
              del.addEventListener('click', async ()=>{ try{ await deleteDoc(doc(db, 'chatMessages_ucl', docu.id)); }catch(e){} });
              row.appendChild(del);
            }
            listEl.appendChild(row);
          });

          if (!panel.classList.contains('open') && unread > 0){
            fab.classList.add('has-unread');
            fabBadge.textContent = unread > 99 ? '99+' : String(unread);
          } else {
            fab.classList.remove('has-unread');
            fabBadge.textContent = '';
          }

          setTimeout(()=>{ listEl.scrollTop = listEl.scrollHeight; }, 0);
        }
      });

      sendBtn.addEventListener('click', async ()=>{
        const txt = (inputEl.value || '').trim();
        if (!txt){ inputEl.focus(); return; }
        const backup = txt;
        inputEl.value = '';
        try{
          await addDoc(collection(db,'chatMessages_ucl'), {
            email: currentUserEmail,
            nick: currentUserNick || 'Ismeretlen',
            text: backup,
            ts: serverTimestamp()
          });
          if (panel.classList.contains('open')) await markSeen();
        }catch(e){
          inputEl.value = backup; inputEl.focus();
        }
      });
      inputEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

      async function markSeen(){
        try{
          await setDoc(userRef, { chatLastSeenUcl: serverTimestamp() }, { merge:true });
          fab.classList.remove('has-unread');
          fabBadge.textContent = '';
        }catch(e){}
      }
    }
  </script>
</head>
<body>
  <div class="layout">
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>BL TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
        <div id="leagueSwitchMount" class="league-switch-left" aria-label="Tippjáték választó"></div>
      </div>
      <div>
        <button id="logout" class="btn-accent" aria-label="Kilépés">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/>
          </svg>
          Kilépés
        </button>
      </div>
    </div>

    <nav class="nav-grid">
      <a class="nav-card" href="dashboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3L12 3z"/>
          </svg>
        </div>
        <div class="text">
          <span class="title">Főoldal</span>
          <span class="desc">Tabella, hírek, kedvencek</span>
        </div>
      </a>

      <a class="nav-card" href="positions_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg>
        </div>
        <div class="text">
          <span class="title">
            Szezon végi sorrend
            <span id="top8CountdownNav" class="pill-badge countdown" hidden></span>
          </span>
          <span class="desc">Ligafázis Top 8, győztes, gólkirály</span>
        </div>
      </a>

      <a class="nav-card" href="matches_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span>
          <span class="desc">Közelgő meccsek & tippek</span>
        </div>
      </a>

      <a class="nav-card" href="results_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Eredmények</span>
          <span class="desc">Fordulónkénti bontás</span>
        </div>
      </a>

      <a class="nav-card" href="leaderboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h3a2 2 0 0 1 2-2z"/></svg>
        </div>
        <div class="text">
          <span class="title">Összpontszám</span>
          <span class="desc">Toplista & bónusz</span>
        </div>
      </a>

      <a class="nav-card" href="profile_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Profil</span>
          <span class="desc">Beállítások & kedvenc csapat</span>
        </div>
      </a>

      <a class="nav-card" id="adminLink" href="admin_ucl.html" style="display:none;">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Admin</span>
          <span class="desc">Szezon-zár & beállítások</span>
        </div>
      </a>
    </nav>

    <section class="card">
      <h3>Közelgő meccsnapok</h3>
      <div id="matchList"></div>
    </section>
  </div>

  <button id="chatToggle" class="chat-fab" title="Közösségi chat">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M4 4h16a2 2 0 0 1 2 2v11a2 2 0 0 1 2 2H8l-4 3V6a2 2 0 0 1 2-2Z"/>
    </svg>
    <span id="chatFabBadge" class="fab-badge"></span>
  </button>

  <section id="chatPanel" class="chat-panel" aria-label="Közösségi chat">
    <div class="chat-head">
      <div class="chat-title">Közösségi chat</div>
      <button id="chatClose" aria-label="Bezárás">✕</button>
    </div>
    <div id="chatMessages" class="chat-list" role="log" aria-live="polite"></div>
    <div id="chatComposer">
      <input id="chatInput" type="text" placeholder="Írj valamit…" autocomplete="off">
      <button id="chatSendBtn">Küldés</button>
    </div>
  </section>
</body>
</html>
