<!DOCTYPE html> 
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL Admin felület</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-600:#1d4ed8;--danger:#ef4444;--border:#e5e7eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left{display:flex;gap:8px;align-items:center}
    .topbar .right{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}

    .cards{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;background:linear-gradient(180deg,#fff, #fafafa)}
    .card-head h3{margin:0;font-size:16px}
    .card-head .hint{color:var(--muted);font-size:12px}
    .card-body{display:none;padding:16px;border-top:1px solid var(--border)}
    .card.open .card-body{display:block}

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input[type="datetime-local"]{min-width:230px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f9fafb;color:#334155;font-weight:600}
    .muted{color:var(--muted)}
    .ok{color:#16a34a;font-weight:700}
    .warn{color:#b45309;font-weight:700}

    .sortable{list-style:none;padding:0;counter-reset:pos}
    .sortable li{position:relative;padding:10px 10px 10px 36px;margin:5px 0;background:#f2f2f2;border:1px solid #ccc;border-radius:8px;cursor:grab}
    .sortable li.dragging{opacity:.5}
    .sortable li::before{counter-increment:pos;content: counter(pos) ". ";position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted)}

    .filterbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .chip.selected{outline:2px solid color-mix(in oklab, var(--primary) 35%, white)}
    .count{font-size:12px;color:#111;background:#e6f1ff;border:1px solid var(--border);padding:2px 8px;border-radius:999px}

    .grid-odds{display:grid;grid-template-columns:280px 1fr;gap:14px}
    @media (max-width:900px){.grid-odds{grid-template-columns:1fr}}
    .panel{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .panel h4{margin:0 0 10px}
    .help{font-size:12px;color:#64748b}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .form-row label{min-width:110px;color:#475569;font-size:13px}
    .num{width:110px}
    .wide{width:160px}
    .sticky-bottom{display:flex;gap:8px;align-items:center;margin-top:10px}
    .tag{font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;background:#fafafa}
    .mono{font-variant-numeric:tabular-nums}
    .muted-note{font-size:12px;color:#64748b;margin-top:6px}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, Timestamp, doc, updateDoc, deleteDoc, getDoc, setDoc, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain:"tippliga-4b3af.firebaseapp.com", projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com", messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // UCL 36 csapat
    const teams = [
      "Ajax","Arsenal","Atalanta","Athletic Bilbao","Atlético Madrid","Barcelona","Bayern München","Benfica","Borussia Dortmund","Bodø/Glimt","Club Bruges","Chelsea","FC Köbenhavn","Eintracht Frankfurt","Galatasaray","Internazionale","Juventus","Bayer Leverkusen","Liverpool","Manchester City","Olympique Marseille","Monaco","Napoli","Newcastle United","Olympiakosz Pireusz","Pafosz","Paris Saint-Germain","PSV","Qarabag","Real Madrid","Slavia Praha","Sporting CP","Tottenham Hotspur","Union Saint-Gilloise","Villarreal","Kajrat Almati"
    ];

    // helpers
    function parseOutcome(r){ const p=r.split("-").map(x=>parseInt(x.trim())); if(p.length!==2||isNaN(p[0])||isNaN(p[1])) return ""; if(p[0]>p[1]) return "1"; if(p[0]<p[1]) return "2"; return "X" }
    const stripNumPrefix = s => (s||'').replace(/^\s*\d+[\.\)]?\s*/, '');
    const norm = s => stripNumPrefix(s).replace(/\s+/g,' ').trim().toLowerCase();
    const toNum = (v) => { if (v==null || v==='') return null; if (typeof v === 'string') v = v.replace(',', '.'); const n = Number(v); return Number.isFinite(n) ? n : null; };
    const fromCandidateOdds = (c) => { const direct = toNum(c?.odds); if (direct != null) return direct; const dec = toNum(c?.oddsDecimal); if (dec != null) return dec; const pct = toNum(c?.oddsPercent); if (pct != null && pct > 0) return 100 / pct; return null; };
    const fmtOdds = (v) => (v==null ? '' : toNum(v).toFixed(2));

    let championCandidates = [];
    let goldenCandidates   = [];
    let officialTop8 = [];
    let officialChampion = "";
    let officialGolden = { player:"", team:"" };

    onAuthStateChanged(auth, async (user) => {
      if(!user){ document.body.innerHTML = "<h2 style='padding:20px'>⛔ Nincs jogosultságod az admin felülethez.</h2>"; return }
      const userSnap = await getDoc(doc(db, "users", user.email));
      if(!userSnap.exists() || (userSnap.data().role !== "admin")){
        document.body.innerHTML = "<h2 style='padding:20px'>⛔ Nincs jogosultságod az admin felülethez.</h2>"; return
      }
      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
      await loadPositionsLock();
      await loadOfficialOrder();
      await loadBonusMarkets();
      await loadOfficialBonus();
      await loadScoringSettings();
      renderOddsPreview();
    });

    function makeCard({title, hint, id, open=false, bodyHTML=''}) {
      const s=document.createElement('section'); s.className='card'; if(id) s.id=id; if(open) s.classList.add('open');
      const h=document.createElement('div'); h.className='card-head'; h.innerHTML = `<h3>${title}</h3><div class="hint">${hint||''}</div>`; h.onclick=()=>s.classList.toggle('open');
      const b=document.createElement('div'); b.className='card-body'; b.innerHTML=bodyHTML;
      s.append(h,b); return {section:s, body:b}
    }

    function initUI(){
      const top=document.createElement('div'); top.className='topbar';
      const left=document.createElement('div'); left.className='left';
      const right=document.createElement('div'); right.className='right';
      const back=document.createElement('button'); back.className='btn'; back.textContent='⬅️ Vissza a dashboardra'; back.onclick=()=>location.href='dashboard_ucl.html';
      const expand=document.createElement('button'); expand.className='btn'; expand.textContent='Mindet nyisd le'; expand.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.add('open'));
      const collapse=document.createElement('button'); collapse.className='btn'; collapse.textContent='Mindet csukd össze'; collapse.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.remove('open'));
      const refresh=document.createElement('button'); refresh.className='btn'; refresh.textContent='Frissítés'; refresh.onclick=()=>{ loadMatches(); loadUsers(); loadResults(); loadPositionsLock(); loadOfficialOrder(); loadBonusMarkets(); loadOfficialBonus(); renderOddsPreview(); };
      left.appendChild(back); right.append(expand, collapse, refresh); document.body.append(top);

      const wrap=document.createElement('div'); wrap.className='cards';

      const teamOpts = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
      const cAdd = makeCard({title:'Új UCL meccs hozzáadása', hint:'Gyors űrlap', id:'card-add', open:true, bodyHTML:`
        <form id="matchForm">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${teamOpts}</select>
            <select id="awayTeam" required><option value="">Vendég csapat</option>${teamOpts}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Forduló / kör ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn primary">Mentés</button>
          </div>
        </form>`});

      const cManage = makeCard({title:'Feltöltött UCL meccsek', hint:'Szűrés, gyors szerkesztés', id:'card-manage', bodyHTML:`
        <div class="filterbar">
          <select id="filterRound"><option value="">Összes forduló</option></select>
          <input id="filterTeam" placeholder="Csapat szűrés" />
          <button class="btn" id="applyFilters">Szűrés</button>
          <button class="btn" id="resetFilters">Törlés</button>
        </div>
        <div id="matchesList"></div>`});

      const cRes = makeCard({title:'UCL meccseredmények kezelése', hint:'Gyors beírás', id:'card-results', bodyHTML:`
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>🟡 Eredmény nélküli meccsek</h3></div>
          <div class="card-body" id="noResultContent"></div>
        </div>
        <div class="card" style="margin:0">
          <div class="card-head" id="withResultHeader"><h3>🟢 Rögzített eredmények</h3></div>
          <div class="card-body" id="withResultContent" style="display:block"></div>
        </div>`});

      const cUsers = makeCard({title:'Felhasználók kezelése', hint:'Szerepkör váltás, törlés', id:'card-users', bodyHTML:`<ul id="userList" class="list" style="margin:0"></ul>`});

      const cTable = makeCard({title:'BL tabella kép feltöltése', hint:'PNG/JPG, base64 tárolás', id:'card-table', bodyHTML:`
        <div class="row">
          <input type="file" id="tableImageInput" accept="image/*">
          <button id="uploadTableImage" class="btn primary">Feltöltés</button>
        </div>`});

      const cOrder = makeCard({title:'Hivatalos UCL sorrend / fázisok (régi)', hint:'Húzd–és–vidd, mentés', id:'card-order', bodyHTML:`
        <button id="toggleOrder" class="btn">Sorrend szerkesztése/elrejtése</button>
        <ul id="sortableList" class="sortable" style="display:none; margin-top:10px;"></ul>
        <button id="saveOrderBtn" style="display:none;" class="btn primary">Mentés</button>`});

      const cLock = makeCard({title:'Pozíciós/Top8 tipp lezárás (UCL)', hint:'Azonnal vagy időpontra', id:'card-lock', bodyHTML:`
        <div class="muted">Itt szabályozható a Top 8 tipp módosíthatósága.</div>
        <div class="row" style="margin-top:8px">
          <label><input type="checkbox" id="lockNow"> Azonnali lezárás</label>
          <span class="muted">vagy</span>
          <label>Automatikus zárás időpontja: <input type="datetime-local" id="lockUntil"></label>
        </div>
        <div class="row"><input type="text" id="lockMessage" placeholder="Opcionális üzenet" style="flex:1;"></div>
        <div class="row">
          <button id="saveLock" class="btn primary">Lezárás beállítása</button>
          <button id="clearLock" class="btn danger">Lezárás feloldása</button>
          <span id="lockStatus" class="muted"></span>
        </div>`});

      const cBonusCh = makeCard({title:'Bónusz piacok – Végső győztes jelöltek', hint:'`ucl_championCandidates` (odds: decimális, pl. 2.00)', id:'card-bonus-ch', bodyHTML:`
        <form id="chAddForm">
          <div class="row">
            <select id="chAddTeam"><option value="">Válassz csapatot</option>${teamOpts}</select>
            <input type="text" id="chAddOdds" inputmode="decimal" placeholder="Odds (pl. 2.00)">
            <button class="btn primary" type="submit">Hozzáadás</button>
          </div>
          <div class="muted" style="margin-top:6px">Az odds decimális formátum (pl. 2.00). Régi adatoknál, ha csak % volt, automatikusan átszámoljuk.</div>
        </form>
        <div style="margin-top:12px">
          <table id="chTable">
            <thead><tr><th>Csapat</th><th>Odds (dec)</th><th>Művelet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`});

      const cBonusGb = makeCard({title:'Bónusz piacok – Gólkirály jelöltek', hint:'`ucl_goldenBootCandidates` (odds: decimális, pl. 3.50)', id:'card-bonus-gb', bodyHTML:`
        <form id="gbAddForm">
          <div class="row">
            <input id="gbAddPlayer" placeholder="Játékos neve">
            <select id="gbAddTeam"><option value="">Klub (opcionális)</option>${teamOpts}</select>
            <input type="text" id="gbAddOdds" inputmode="decimal" placeholder="Odds (pl. 3.50)">
            <button class="btn primary" type="submit">Hozzáadás</button>
          </div>
          <div class="muted" style="margin-top:6px">A klub opcionális. Az odds decimális; régi % adatokból konvertálunk.</div>
        </form>
        <div style="margin-top:12px">
          <table id="gbTable">
            <thead><tr><th>Játékos</th><th>Klub</th><th>Odds (dec)</th><th>Művelet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`});

      const cOfficial = makeCard({title:'Hivatalos eredmények – Top 8 / Győztes / Gólkirály', hint:'`ucl_official/current`', id:'card-official', bodyHTML:`
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>Top 8 (sorrend nélkül)</h3><div class="hint"><span id="top8Count" class="count">0/8</span></div></div>
          <div class="card-body">
            <div class="row">
              <div style="flex:1">
                <div class="muted" style="margin-bottom:6px">Kattints a csapatokra a kiválasztáshoz/kivételhez (max. 8).</div>
                <div id="top8Chips" class="chips"></div>
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="saveTop8" class="btn primary">Top 8 mentése</button>
            </div>
          </div>
        </div>
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>Végső győztes</h3></div>
          <div class="card-body">
            <div class="row">
              <select id="officialChampion"><option value="">Válassz csapatot</option>${teamOpts}</select>
              <button id="saveChampion" class="btn primary">Győztes mentése</button>
            </div>
            <div class="muted" style="margin-top:6px">Bármely csapat kiválasztható (nem kötött a jelöltekhez).</div>
          </div>
        </div>
        <div class="card" style="margin:0">
          <div class="card-head"><h3>Gólkirály</h3></div>
          <div class="card-body">
            <div class="row">
              <select id="officialGoldenPlayer"><option value="">Válassz játékost (jelöltek)</option></select>
              <input id="officialGoldenTeam" placeholder="Klub (betöltve a jelöltből)" readonly>
              <button id="saveGolden" class="btn primary">Gólkirály mentése</button>
            </div>
            <div class="muted" style="margin-top:6px">A játékost a jelöltek közül válaszd ki; a klub mező automatikusan kitöltődik.</div>
          </div>
        </div>`});

      /* ÚJ: Odds → % + Pont */
      const cOdds = makeCard({title:'Végső győztes – odds → megjelenített % + pont', hint:'Jelöltek normalizálása + favorit-laposítás', id:'card-odds', open:true, bodyHTML:`
        <div class="grid-odds">
          <div class="panel">
            <h4>Beállítás</h4>
            <div class="help">T – hőmérséklet a %-hoz (nagyobb = laposabb). A pontszámhoz: BASE, O<sub>0</sub> (ahol 10 pont), A (görbe), LO/HI clamp.</div>
            <div class="form-row"><label>Hőmérséklet (T)</label><input id="T" class="num" type="number" step="0.01" value="1.30"></div>
            <div class="form-row"><label>BASE</label><input id="BASE" class="num" type="number" step="0.1" value="10"></div>
            <div class="form-row"><label>O<sub>0</sub> (pivot odds)</label><input id="PIVOT" class="num" type="number" step="1" value="65"></div>
            <div class="form-row"><label>A (exponens)</label><input id="AEXP" class="num" type="number" step="0.01" value="0.33"></div>
            <div class="form-row"><label>LO (min ×BASE)</label><input id="LO" class="num" type="number" step="0.01" value="0.5"></div>
            <div class="form-row"><label>HI (max ×BASE)</label><input id="HI" class="num" type="number" step="0.01" value="2.5"></div>
            <div class="sticky-bottom">
              <button id="recalc" class="btn primary">Számold újra & mentsd</button>
              <span class="tag">Implied = 1/odds</span><span class="tag">softmax p^(1/T)</span><span class="tag">clamp pont</span>
            </div>
            <div class="muted-note">Lépések: (1) Implied p = 1/odds → normalizálás overroundra, (2) p' = p^(1/T), (3) újranormalizálás, (4) % = 100·p', (5) pont = BASE·clamp((odds/O0)^A, LO, HI).</div>
          </div>
          <div class="panel">
            <h4>Előnézet</h4>
            <div class="help">Jelöltek a mentett oddsok alapján</div>
            <div style="overflow:auto">
              <table id="oddsPreview">
                <thead><tr><th>Csapat</th><th>Odds (dec)</th><th>Implied % (raw)</th><th>Megjelenített %</th><th>Pont</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>`});

      /* ÚJ KÁRTYA: Tömeges import – Gólkirály jelöltek */
      const cBulkGb = makeCard({
        title: 'Tömeges import – Gólkirály jelöltek',
        hint: 'Beillesztés soronként (Név [Klub] Odds). Klubot az előnézetben is kiválaszthatod.',
        id: 'card-bulk-gb',
        bodyHTML: `
          <div class="row" style="gap:12px;">
            <textarea id="gbBulkText" placeholder="Pl.:
Erling Haaland 6,75
Kylian Mbappé 7,75
Robert Lewandowski 8,75" style="min-width:420px;min-height:140px;flex:1;"></textarea>
            <div style="display:flex;flex-direction:column;gap:8px;min-width:260px">
              <label><input type="checkbox" id="gbBulkWipe"> Előtte URÍTSD a jelölteket</label>
              <button id="gbBulkParse" class="btn">Előkészítés</button>
              <button id="gbBulkUpload" class="btn primary" disabled>Feltöltés Firestore-ba</button>
              <div class="muted">Formátum rugalmas: a sor végén legyen az odds (pl. 16,50 vagy 16.50). Klub megadható szögletes zárójelben is: <code>Név [Klub] 25,00</code>.</div>
            </div>
          </div>
          <div id="gbBulkPreview" style="margin-top:12px; overflow:auto"></div>
        `
      });

      document.body.append(wrap);
      wrap.append(
        cAdd.section, cManage.section, cRes.section, cUsers.section, cTable.section,
        cOrder.section, cLock.section,
        cBonusCh.section, cBonusGb.section, cBulkGb.section,  /* ⟵ az új kártya itt */
        cOfficial.section,
        cOdds.section
      );

      document.getElementById('matchForm').addEventListener('submit', onAddMatch);
      document.getElementById('uploadTableImage').addEventListener('click', onUploadTableImage);
      document.getElementById('withResultHeader').onclick=()=>{ const c=document.getElementById('withResultContent'); c.style.display = c.style.display==='none' ? 'block':'none'; };
      const sortableList = document.getElementById('sortableList');
      document.getElementById('toggleOrder').onclick=()=>{ const vis = sortableList.style.display==='block'; sortableList.style.display = vis? 'none':'block'; document.getElementById('saveOrderBtn').style.display = vis? 'none':'inline-block'; };
      document.getElementById('saveOrderBtn').onclick = saveOfficialOrder;
      document.getElementById('applyFilters').onclick = renderMatchesFiltered;
      document.getElementById('resetFilters').onclick = ()=>{ document.getElementById('filterRound').value=''; document.getElementById('filterTeam').value=''; renderMatchesFiltered(); };
      document.getElementById('saveLock').onclick = saveLock;
      document.getElementById('clearLock').onclick = clearLock;

      document.getElementById('chAddForm').addEventListener('submit', onAddChampionCandidate);
      document.getElementById('gbAddForm').addEventListener('submit', onAddGoldenCandidate);

      document.getElementById('saveTop8').onclick = saveOfficialTop8;
      document.getElementById('saveChampion').onclick = saveOfficialChampion;
      document.getElementById('saveGolden').onclick = saveOfficialGolden;

      document.getElementById('recalc').addEvent
