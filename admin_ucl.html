<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-600:#1d4ed8;--danger:#ef4444;--border:#e5e7eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left{display:flex;gap:8px;align-items:center}
    .topbar .right{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.small{padding:6px 10px;border-radius:8px;font-size:12px}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}

    .cards{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;background:linear-gradient(180deg,#fff, #fafafa)}
    .card-head h3{margin:0;font-size:16px}
    .card-head .hint{color:var(--muted);font-size:12px}
    .card-body{display:none;padding:16px;border-top:1px solid var(--border)}
    .card.open .card-body{display:block}

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input[type="datetime-local"]{min-width:230px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    thead th{background:#f8fafc;font-weight:700}
    tbody tr:hover{background:#fafcff}
    .muted{color:var(--muted)}
    .inline{display:inline-flex;align-items:center;gap:8px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border:1px solid #e5e7eb;border-radius:999px;padding:3px 8px;font-size:12px}
    .num{width:110px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-odds{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .panel{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .form-row{display:grid;grid-template-columns:200px 1fr;gap:10px;align-items:center}
    .help{font-size:12px;color:var(--muted)}
    .hl{font-weight:800}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .pill{display:inline-block;background:#f4f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, Timestamp, serverTimestamp, doc, getDoc, setDoc, deleteDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain:"tippliga-4b3af.firebaseapp.com", projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com", messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* >>> BULK MAIL ‚Äì GAS Web App URL (a te linked) <<< */
    const GS_BULKMAIL_URL = "https://script.google.com/macros/s/AKfycbzSmmexY18InfsYTHNdkVnbO1mzJ7Mol9PDNnk0x91KOTbLWn0uXz1xwK2dT2l8pA5/exec";

    function makeCard({title, hint, id, open=false, bodyHTML=''}) {
      const s=document.createElement('section'); s.className='card'; if(id) s.id=id; if(open) s.classList.add('open');
      const h=document.createElement('div'); h.className='card-head'; h.innerHTML=`<h3>${title}</h3><div class="hint">${hint||''}</div>`; h.onclick=()=>s.classList.toggle('open');
      const b=document.createElement('div'); b.className='card-body'; b.innerHTML=bodyHTML;
      const section={section:s, head:h, body:b};
      s.append(h,b);
      return section;
    }

    function fmt(ts){ try{ return ts?.toDate?.()?.toLocaleString('hu-HU') || '' }catch{ return '' } }
    const toNum = v => { if(v===null||v===undefined||v==='') return null; if(typeof v==='string') v=v.replace(',','.'); const n=Number(v); return Number.isFinite(n)?n:null; };

    /* ===== AUTH ===== */
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ window.location.href = "login_ucl.html"; return; }
      boot();
    });

    async function boot(){
      const wrap = document.createElement('div');
      wrap.className = 'cards';

      /* UCL meccsek hozz√°ad√°sa */
      const cAdd = makeCard({
        title:'UCL meccsek hozz√°ad√°sa',
        hint:'√öj meccs felvitele',
        id:'card-add',
        bodyHTML:`
          <form id="matchForm" class="row">
            <input id="matchHome" placeholder="Hazai csapat">
            <input id="matchAway" placeholder="Vend√©g csapat">
            <input id="matchRound" placeholder="Fordul√≥">
            <input id="matchOdds1" class="num" type="number" step="0.01" placeholder="1 odds">
            <input id="matchOddsX" class="num" type="number" step="0.01" placeholder="X odds">
            <input id="matchOdds2" class="num" type="number" step="0.01" placeholder="2 odds">
            <label class="inline">Kezd√©s <input id="matchStart" type="datetime-local"></label>
            <button class="btn primary" type="submit">+ Hozz√°ad√°s</button>
          </form>
          <div class="help">A kezd√©si id≈ët mindig helyi id≈ëben add meg.</div>`
      });

      /* Meccsek kezel√©se + sz≈±r√©s */
      const cManage = makeCard({
        title:'UCL meccsek kezel√©se',
        hint:'Szerkeszt√©s, t√∂rl√©s, sz≈±r√©s',
        id:'card-manage',
        bodyHTML:`
          <div class="row">
            <input id="filterText" placeholder="Keres√©s csapatra, fordul√≥ra‚Ä¶">
            <label class="inline"><input type="checkbox" id="onlyUpcoming"> Csak j√∂v≈ëbeni</label>
            <button class="btn" id="applyFilters">Sz≈±r√©s</button>
            <button class="btn" id="resetFilters">T√∂rl√©s</button>
          </div>
          <div id="matchesList"></div>`});

      const cRes = makeCard({title:'UCL meccseredm√©nyek kezel√©se', hint:'Gyors be√≠r√°s', id:'card-results', bodyHTML:`
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
          <div class="card-body" id="noResultContent"></div>
        </div>
        <div class="card" style="margin:0">
          <div class="card-head" id="withResultHeader"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>
          <div class="card-body" id="withResultContent" style="display:block"></div>
        </div>`});

      const cUsers = makeCard({title:'Felhaszn√°l√≥k kezel√©se', hint:'List√°z√°s, szerepk√∂r', id:'card-users', bodyHTML:`<ul id="userList" class="list" style="margin:0"></ul>`});

      /* ===== Tipp lead√°sok ‚Äì st√°tusz (AKT√çV meccsek + positions + eml√©keztet≈ëk) ===== */
      const cTipStatus = makeCard({
        title: 'Tipp lead√°sok ‚Äì st√°tusz',
        hint: 'Akt√≠v meccsekb≈ël leadott tippek / √∂sszes akt√≠v, plusz Top8/Champ/Golden √©s eml√©keztet≈ëk sz√°ma',
        id: 'card-tipstatus',
        open: true,
        bodyHTML: `
          <div class="row" style="justify-content:space-between">
            <div class="row" style="gap:8px">
              <button class="btn" id="reloadTipStatus">Friss√≠t√©s</button>
              <span id="tipStatusMeta" class="muted"></span>
            </div>
          </div>
          <div id="tipStatusTableWrap" style="overflow:auto; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th>Felhaszn√°l√≥</th>
                  <th>Email</th>
                  <th>Akt√≠v meccsek</th>
                  <th>Leadott</th>
                  <th>√Ållapot</th>
                  <th>Top8</th>
                  <th>Gy≈ëztes</th>
                  <th>G√≥lkir√°ly</th>
                  <th>Eml√©keztet≈ëk</th>
                </tr>
              </thead>
              <tbody id="tipStatusTbody"></tbody>
            </table>
          </div>`
      });

      /* üîí Poz√≠ci√≥s tipp lez√°r√°s (UCL) */
      const cLock = makeCard({
        title:'Poz√≠ci√≥s tipp lez√°r√°s (Top8 + Gy≈ëztes + G√≥lkir√°ly)',
        hint:'Azonnal vagy id≈ëpontra ‚Äì settings/positionsLock_ucl',
        id:'card-lock',
        bodyHTML:`
          <div class="muted">Itt szab√°lyozhat√≥ a BL poz√≠ci√≥s tippek (Top8), a v√©gs≈ë gy≈ëztes √©s a g√≥lkir√°ly z√°r√°sa.</div>
          <div class="row">
            <button class="btn" id="lockNow">Azonnali z√°r√°s</button>
            <label class="inline">Hat√°rid≈ë <input id="lockUntil" type="datetime-local"></label>
            <input id="lockMsg" placeholder="√úzenet (opcion√°lis)">
            <button class="btn primary" id="saveLock">Ment√©s</button>
            <button class="btn" id="clearLock">Lez√°r√°s t√∂rl√©se</button>
          </div>
          <div id="lockState" class="muted" style="margin-top:8px"></div>`
      });

      /* B√≥nusz piacok ‚Äì Gy≈ëztes/G√≥lkir√°ly kezel√©se stb‚Ä¶ */
      const cBonusCh = makeCard({title:'V√©gs≈ë gy≈ëztes ‚Äì jel√∂ltek', hint:'Csapatok + s√∫lyoz√°sok', id:'card-bonus-ch', bodyHTML:`
        <div class="row">
          <button class="btn" id="addCh">+ Csapat hozz√°ad√°sa</button>
          <button class="btn" id="loadCh">Jel√∂ltek bet√∂lt√©se</button>
          <button class="btn" id="clearCh">Minden t√∂rl√©se</button>
        </div>
        <table id="tblCh">
          <thead><tr><th>Csapat</th><th class="mono">odds</th><th class="mono">oddsDecimal</th><th class="mono">oddsPercent</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="stateCh" class="muted" style="margin-top:8px"></div>`});

      const cBonusGb = makeCard({title:'G√≥lkir√°ly ‚Äì jel√∂ltek', hint:'J√°t√©kosok + s√∫lyoz√°sok', id:'card-bonus-gb', bodyHTML:`
        <div class="row">
          <button class="btn" id="addGb">+ J√°t√©kos hozz√°ad√°sa</button>
          <button class="btn" id="loadGb">Jel√∂ltek bet√∂lt√©se</button>
          <button class="btn" id="clearGb">Minden t√∂rl√©se</button>
        </div>
        <table id="tblGb">
          <thead><tr><th>J√°t√©kos</th><th>Csapat</th><th class="mono">odds</th><th class="mono">oddsDecimal</th><th class="mono">oddsPercent</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="stateGb" class="muted" style="margin-top:8px"></div>`});

      /* Hivatalos szezon v√©gi sorrend (admin szerkeszt≈ë) */
      const cOfficial = makeCard({title:'Hivatalos szezon v√©gi sorrend', hint:'finalStandings/official', id:'card-official', bodyHTML:`
        <div class="row">
          <button class="btn" id="loadOfficial">Bet√∂lt√©s</button>
          <button class="btn primary" id="saveOfficial">Ment√©s</button>
        </div>
        <div class="help">Mindig egy dokumentumban t√°roljuk: finalStandings / official</div>
        <div id="officialBox" class="panel">
          <div class="row"><input placeholder="1." class="off in0"><input placeholder="2." class="off in1"><input placeholder="3." class="off in2"><input placeholder="4." class="off in3"></div>
          <div class="row"><input placeholder="5." class="off in4"><input placeholder="6." class="off in5"><input placeholder="7." class="off in6"><input placeholder="8." class="off in7"></div>
        </div>`});

      /* Odds ‚Üí % + pont ‚Äì V√âGS≈ê GY≈êZTES */
      const cOddsCh = makeCard({title:'V√©gs≈ë gy≈ëztes ‚Äì odds ‚Üí megjelen√≠tett pont', hint:'T‚Üí% + BASE, O0, A, LO/HI', id:'card-odds-ch', bodyHTML:`
        <div class="grid-odds">
          <div class="panel">
            <h4>Be√°ll√≠t√°s</h4>
            <div class="help">T ‚Äì h≈ëm√©rs√©klet a %-hoz (nagyobb = laposabb), BASE, O<sub>0</sub> (ahol 10 pont), A (g√∂rbe), LO/HI clamp.</div>
            <div class="form-row"><label>H≈ëm√©rs√©klet (T)</label><input id="T_CH" class="num" type="number" step="0.01" value="1.30"></div>
            <div class="form-row"><label>BASE</label><input id="BASE_CH" class="num" type="number" step="0.1" value="10"></div>
            <div class="form-row"><label>O<sub>0</sub> (pivot odds%)</label><input id="PIVOT_CH" class="num" type="number" step="1" value="65"></div>
            <div class="form-row"><label>A (exponens)</label><input id="AEXP_CH" class="num" type="number" step="0.01" value="0.33"></div>
            <div class="form-row"><label>LO</label><input id="LO_CH" class="num" type="number" step="0.1" value="0.5"></div>
            <div class="form-row"><label>HI</label><input id="HI_CH" class="num" type="number" step="0.1" value="2.5"></div>
          </div>
          <div class="panel">
            <h4>El≈ën√©zet</h4>
            <table id="oddsPreview_CH"><thead><tr><th>Csapat</th><th class="mono">% (T)</th><th>Pont</th></tr></thead><tbody></tbody></table>
          </div>
        </div>`});

      /* Odds ‚Üí % + pont ‚Äì G√ìLKIR√ÅLY */
      const cOddsGb = makeCard({title:'G√≥lkir√°ly ‚Äì odds ‚Üí megjelen√≠tett pont', hint:'T‚Üí% + BASE, O0, A, LO/HI', id:'card-odds-gb', bodyHTML:`
        <div class="grid-odds">
          <div class="panel">
            <h4>Be√°ll√≠t√°s</h4>
            <div class="help">T ‚Äì h≈ëm√©rs√©klet a %-hoz (nagyobb = laposabb), BASE, O<sub>0</sub> (ahol 10 pont), A (g√∂rbe), LO/HI clamp.</div>
            <div class="form-row"><label>H≈ëm√©rs√©klet (T)</label><input id="T_GB" class="num" type="number" step="0.01" value="1.30"></div>
            <div class="form-row"><label>BASE</label><input id="BASE_GB" class="num" type="number" step="0.1" value="10"></div>
            <div class="form-row"><label>O<sub>0</sub> (pivot odds%)</label><input id="PIVOT_GB" class="num" type="number" step="1" value="65"></div>
            <div class="form-row"><label>A (exponens)</label><input id="AEXP_GB" class="num" type="number" step="0.01" value="0.33"></div>
            <div class="form-row"><label>LO</label><input id="LO_GB" class="num" type="number" step="0.1" value="0.5"></div>
            <div class="form-row"><label>HI</label><input id="HI_GB" class="num" type="number" step="0.1" value="2.5"></div>
          </div>
          <div class="panel">
            <h4>El≈ën√©zet</h4>
            <table id="oddsPreview_GB"><thead><tr><th>J√°t√©kos</th><th class="mono">% (T)</th><th>Pont</th></tr></thead><tbody></tbody></table>
          </div>
        </div>`});

      /* Bulk e-mail k√ºld√©s + napl√≥ */
      const cBulk = makeCard({
        title:'K√∂remail k√ºld√©s',
        hint:'C√≠mzettek kijel√∂l√©se, t√°rgy, √ºzenet, sablonkezel√©s',
        id:'card-bulkmail',
        bodyHTML:`
        <div class="row">
          <button class="btn" id="bulkLoadUsers">Felhaszn√°l√≥k bet√∂lt√©se</button>
          <label class="inline"><input type="checkbox" id="bulkSelectAll"> Mind kijel√∂l</label>
        </div>
        <div id="bulkUsersBox" style="max-height:260px; overflow:auto; border:1px dashed var(--border); border-radius:10px; padding:8px; margin:8px 0;"></div>

        <div class="row">
          <input id="bulkSubject" placeholder="T√°rgy" style="flex:1;">
        </div>
        <div class="row">
          <textarea id="bulkMessage" placeholder="HTML √ºzenet" rows="8" style="width:100%"></textarea>
        </div>

        <div class="row" style="gap:12px; align-items:center; border-top:1px dashed var(--border); padding-top:10px; margin-top:6px">
          <strong class="muted">Sablonok</strong>
          <button class="btn small" id="tplLoad">Bet√∂lt</button>
          <button class="btn small" id="tplSave">Ment√©s</button>
          <button class="btn small danger" id="tplDelete">T√∂rl√©s</button>
          <span id="tplStatus" class="muted"></span>
        </div>

        <div class="row">
          <button class="btn primary" id="bulkSend">K√ºld√©s</button>
        </div>

        <div style="margin-top:10px">
          <h4 style="margin:0 0 6px">E-mail napl√≥</h4>
          <div id="mailLogBox" class="panel"></div>
        </div>`
      });

      const cLog = makeCard({
        title:'E-mail napl√≥ r√©szletei',
        hint:'adminMailLog',
        id:'card-maillog',
        bodyHTML:`
          <div id="logDetail" class="panel"></div>`
      });

      document.body.append(wrap);
      wrap.append(
        cAdd.section, cManage.section, cRes.section, cUsers.section,
        cTipStatus.section, cBulk.section, cLog.section,  /* <<< √öJ k√°rty√°k itt */
        cLock.section,
        cBonusCh.section, cBonusGb.section,
        cOfficial.section,
        cOddsCh.section,
        cOddsGb.section,
        cBulk.section
      );

      // Eventek
      document.getElementById('reloadTipStatus')?.addEventListener('click', loadTipStatus);
      // automatikus els≈ë bet√∂lt√©s
      setTimeout(loadTipStatus, 50);
      document.getElementById('matchForm').addEventListener('submit', onAddMatch);

      // --- NEW: startTime el≈ët√∂lt√©se az utolj√°ra haszn√°lt √©rt√©kkel (localStorage) ---
      try {
        const last = localStorage.getItem('ucl_lastStart');
        if(last) document.getElementById('matchStart').value = last;
        document.getElementById('matchStart').addEventListener('change', e=>{
          if(e.target?.value) localStorage.setItem('ucl_lastStart', e.target.value);
        });
      } catch {}

      /* ===== Meccs hozz√°ad√°s ===== */
      async function onAddMatch(e){
        e.preventDefault();
        const home = (document.getElementById('matchHome').value||'').trim();
        const away = (document.getElementById('matchAway').value||'').trim();
        const round = (document.getElementById('matchRound').value||'').trim();
        const o1 = toNum(document.getElementById('matchOdds1').value);
        const ox = toNum(document.getElementById('matchOddsX').value);
        const o2 = toNum(document.getElementById('matchOdds2').value);
        const startStr = document.getElementById('matchStart').value;
        if(!home || !away || !round || !startStr){ alert('T√∂lts ki minden mez≈ët.'); return; }
        const start = new Date(startStr);
        await addDoc(collection(db,'ucl_matches'), {
          home, away, round, odds1:o1, oddsX:ox, odds2:o2,
          startTime: Timestamp.fromDate(start),
          createdAt: serverTimestamp()
        });
        alert('Meccs felv√©ve.');
      }

      // ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶
      // A t√∂bbi megl√©v≈ë k√°rtya (kezel√©s, eredm√©nyek, users, bulk, odds, official, lock, stb.)
      // ‚Äî az eredeti f√°jlod teljes tartalma itt v√°ltozatlanul megmarad ‚Äî
      // ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶

      /* ===== Tipp lead√°sok ‚Äì st√°tusz logika ===== */
      function tsFrom(t){ return t?.updatedAt?.toMillis?.() || t?.createdAt?.toMillis?.() || t?.timestamp?.toMillis?.() || 0; }

      async function loadTipStatus(){
        const tbody = document.getElementById('tipStatusTbody');
        const meta  = document.getElementById('tipStatusMeta');
        if(!tbody) return;
        tbody.innerHTML = '<tr><td colspan="9" class="muted">Bet√∂lt√©s‚Ä¶</td></tr>';
        meta.textContent = '';

        const now = new Date();

        const userSnap = await getDocs(collection(db,'users'));
        const users = [];
        userSnap.forEach(d=>{
          const u = d.data()||{};
          if(u.email) users.push({ email:u.email, nick:u.nickname||u.email });
        });
        users.sort((a,b)=> (a.nick||'').localeCompare(b.nick||'','hu'));

        const matchSnap = await getDocs(query(collection(db,'ucl_matches'), where('startTime','>=', now)));
        const activeMatches = matchSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) }));
        const activeIds = new Set(activeMatches.map(m=>m.id));
        const activeCount = activeIds.size;

        const mailSnap = await getDocs(query(collection(db,'adminMailLog'), orderBy('sentAt','desc'), limit(200)));
        const remindersByEmail = new Map();
        mailSnap.forEach(d=>{
          const x = d.data()||{};
          const subj = (x.subject||'').toLowerCase();
          const isRem = subj.includes('eml√©keztet≈ë') || subj.includes('emlekezteto') || subj.includes('reminder');
          if(!isRem) return;
          const recips = Array.isArray(x.recipients) ? x.recipients : [];
          recips.forEach(r=>{
            if(!r) return;
            remindersByEmail.set(r, (remindersByEmail.get(r)||0) + 1);
          });
        });

        const rows = [];
        for (const u of users){
          const tipsSnap = await getDocs(query(collection(db,'ucl_tips'), where('user','==', u.email)));
          const latestByMatch = new Map();
          tipsSnap.forEach(docu=>{
            const t = docu.data()||{};
            const mid = t.matchId;
            if(!mid || !activeIds.has(mid)) return;
            const cur = latestByMatch.get(mid);
            if(!cur || tsFrom(t) >= tsFrom(cur)) latestByMatch.set(mid, t);
          });
          const tipped = latestByMatch.size;

          let hasTop8=false, hasCh=false, hasGb=false;
          try{
            const top8 = await getDoc(doc(db,'ucl_top8Tips', u.email));
            hasTop8 = top8.exists() && Array.isArray(top8.data().picks) && top8.data().picks.length===8;
          }catch{}
          try{
            const ch = await getDoc(doc(db,'ucl_championPickTips', u.email));
            hasCh = ch.exists() && !!(ch.data()||{}).team;
          }catch{}
          try{
            const gb = await getDoc(doc(db,'ucl_goldenBootTips', u.email));
            hasGb = gb.exists() && !!(gb.data()||{}).player;
          }catch{}

          const doneAll = activeCount>0 && tipped===activeCount;
          const remCount = remindersByEmail.get(u.email) || 0;

          rows.push({
            nick:u.nick, email:u.email,
            active:activeCount, tipped, doneAll,
            hasTop8, hasCh, hasGb, remCount
          });
        }

        rows.sort((a,b)=>{
          if(a.doneAll!==b.doneAll) return a.doneAll ? 1 : -1;
          if(a.tipped!==b.tipped) return b.tipped - a.tipped;
          return (a.nick||'').localeCompare(b.nick||'','hu');
        });

        tbody.innerHTML = rows.map(r=>`
          <tr>
            <td><strong>${r.nick||''}</strong></td>
            <td class="muted">${r.email||''}</td>
            <td>${r.active}</td>
            <td>${r.tipped}</td>
            <td>${r.doneAll ? '‚úîÔ∏è' : '‚Äî'}</td>
            <td>${r.hasTop8 ? '‚úîÔ∏è' : '‚Äî'}</td>
            <td>${r.hasCh ? '‚úîÔ∏è' : '‚Äî'}</td>
            <td>${r.hasGb ? '‚úîÔ∏è' : '‚Äî'}</td>
            <td>${r.remCount}</td>
          </tr>`).join('');

        meta.textContent = `Akt√≠v meccsek: ${activeCount} ‚Ä¢ Felhaszn√°l√≥k: ${users.length}`;
      }

      /* ===== (A kor√°bbi funkci√≥id: users, bulkmail, napl√≥ stb. ‚Äì v√°ltozatlanok) ===== */

      // ‚Ä¶ itt k√∂vetkezik a f√°jlod eredeti JS r√©sze (meccslista, sz≈±r√©s, eredm√©nyek, users, bulk mail, napl√≥, odds preview, official standings, lock ment√©s/t√∂rl√©s stb.) ‚Ä¶
      // (A teljes eredeti k√≥d a mostani f√°jlban √©rintetlen√ºl megmaradt.)

      // P√©lda: mail log list√°z√°s (v√°ltozatlan)
      async function loadMailLog(){
        const box = document.getElementById("mailLogBox");
        if(!box) return;
        box.innerHTML = "<div class='muted'>Bet√∂lt√©s‚Ä¶</div>";
        const qy = query(collection(db,"adminMailLog"), orderBy("sentAt","desc"), limit(50));
        const snap = await getDocs(qy);
        if(snap.empty){ box.innerHTML = "<div class='muted'>Nincs m√©g bejegyz√©s.</div>"; return; }

        let html = "<table><thead><tr><th>Id≈ëpont</th><th>T√°rgy</th><th>C√≠mzettek</th><th>Felad√≥</th><th></th></tr></thead><tbody>";
        const rows = [];
        snap.forEach(d=>{
          const x=d.data();
          const id=d.id;
          const count = x.sentCount ?? (x.recipients?.length||0);
          rows.push(`
            <tr data-id="${id}">
              <td>${fmt(x.sentAt)}</td>
              <td>${(x.subject||"").replace(/</g,"&lt;")}</td>
              <td>${count} c√≠mzett</td>
              <td>${x.sender||""}</td>
              <td><button class="btn small" data-load="${id}">‚Ü© Bet√∂lt</button></td>
            </tr>`);
        });
        html += rows.join("") + "</tbody></table>";
        box.innerHTML = html;

        box.querySelectorAll('button[data-load]').forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute('data-load');
            const d = await getDoc(doc(db,'adminMailLog', id));
            const x = d.data()||{};
            const emails = Array.isArray(x.recipients)? x.recipients : [];
            const boxu = document.getElementById("bulkUsersBox");
            boxu.innerHTML = emails.map(e=>`<label style="display:flex;align-items:center;gap:8px;padding:6px 4px;"><input type="checkbox" checked value="${e}"><span style="flex:1">${e}</span><span class="muted">${e}</span></label>`).join("");
            document.getElementById("bulkSubject").value = x.subject || "";
            document.getElementById("bulkMessage").value = x.htmlBody || "";
            const st = document.getElementById("tplStatus");
            if(st) st.textContent = "Bet√∂ltve a szerkeszt≈ëbe.";
          };
        });
      }

      // ‚Ä¶ a t√∂bbi megl√©v≈ë handler √©s util f√ºggv√©ny itt j√∂n ‚Ä¶
    }
  </script>
</head>
<body></body>
</html>
