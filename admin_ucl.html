<!DOCTYPE html> 
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL Admin felület</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-600:#1d4ed8;--danger:#ef4444;--border:#e5e7eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left{display:flex;gap:8px;align-items:center}
    .topbar .right{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}

    .cards{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;background:linear-gradient(180deg,#fff, #fafafa)}
    .card-head h3{margin:0;font-size:16px}
    .card-head .hint{color:var(--muted);font-size:12px}
    .card-body{display:none;padding:16px;border-top:1px solid var(--border)}
    .card.open .card-body{display:block}

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input[type="datetime-local"]{min-width:230px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f9fafb;color:#334155;font-weight:600}
    .muted{color:var(--muted)}
    .ok{color:#16a34a;font-weight:700}
    .warn{color:#b45309;font-weight:700}

    .sortable{list-style:none;padding:0;counter-reset:pos}
    .sortable li{position:relative;padding:10px 10px 10px 36px;margin:5px 0;background:#f2f2f2;border:1px solid #ccc;border-radius:8px;cursor:grab}
    .sortable li.dragging{opacity:.5}
    .sortable li::before{counter-increment:pos;content: counter(pos) ". ";position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted)}

    .filterbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .chip.selected{outline:2px solid color-mix(in oklab, var(--primary) 35%, white)}
    .count{font-size:12px;color:#111;background:#e6f1ff;border:1px solid var(--border);padding:2px 8px;border-radius:999px}

    /* Odds → % + Pont kártya */
    .grid-odds{display:grid;grid-template-columns:280px 1fr;gap:14px}
    @media (max-width:900px){.grid-odds{grid-template-columns:1fr}}
    .panel{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .panel h4{margin:0 0 10px}
    .help{font-size:12px;color:#64748b}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .form-row label{min-width:110px;color:#475569;font-size:13px}
    .num{width:110px}
    .wide{width:160px}
    .sticky-bottom{display:flex;gap:8px;align-items:center;margin-top:10px}
    .tag{font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;background:#fafafa}
    .mono{font-variant-numeric:tabular-nums}
    .muted-note{font-size:12px;color:#64748b;margin-top:6px}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, Timestamp, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain:"tippliga-4b3af.firebaseapp.com", projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com", messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UCL 36 csapat
    const teams = [
      "Ajax","Arsenal","Atalanta","Athletic Bilbao","Atlético Madrid","Barcelona","Bayern München","Benfica","Borussia Dortmund","Bodø/Glimt","Club Bruges","Chelsea","FC Köbenhavn","Eintracht Frankfurt","Galatasaray","Internazionale","Juventus","Bayer Leverkusen","Liverpool","Manchester City","Olympique Marseille","Monaco","Napoli","Newcastle United","Olympiakosz Pireusz","Pafosz","Paris Saint-Germain","PSV","Qarabag","Real Madrid","Slavia Praha","Sporting CP","Tottenham Hotspur","Union Saint-Gilloise","Villarreal","Kajrat Almati"
    ];

    function parseOutcome(r){ const p=r.split("-").map(x=>parseInt(x.trim())); if(p.length!==2||isNaN(p[0])||isNaN(p[1])) return ""; if(p[0]>p[1]) return "1"; if(p[0]<p[1]) return "2"; return "X" }
    const stripNumPrefix = s => (s||'').replace(/^\s*\d+[\.\)]?\s*/, '');
    const norm = s => stripNumPrefix(s).replace(/\s+/g,' ').trim().toLowerCase();

    const toNum = (v) => {
      if (v === null || v === undefined || v === '') return null;
      if (typeof v === 'string') v = v.replace(',', '.');
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };
    const fromCandidateOdds = (c) => {
      const direct = toNum(c?.odds);
      if (direct != null) return direct;
      const dec = toNum(c?.oddsDecimal);
      if (dec != null) return dec;
      const pct = toNum(c?.oddsPercent);
      if (pct != null && pct > 0) return 100 / pct;
      return null;
    };
    const fmtOdds = (v) => (v==null ? '' : toNum(v).toFixed(2));

    let championCandidates = [];
    let goldenCandidates   = [];
    let officialTop8 = [];
    let officialChampion = "";
    let officialGolden = { player:"", team:"" };

    onAuthStateChanged(auth, async (user) => {
      if(!user){ document.body.innerHTML = "<h2 style='padding:20px'>⛔ Nincs jogosultságod az admin felülethez.</h2>"; return }
      const userSnap = await getDoc(doc(db, "users", user.email));
      if(!userSnap.exists() || (userSnap.data().role !== "admin")){
        document.body.innerHTML = "<h2 style='padding:20px'>⛔ Nincs jogosultságod az admin felülethez.</h2>"; return
      }
      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
      await loadPositionsLock();
      await loadOfficialOrder();
      await loadBonusMarkets();
      await loadOfficialBonus();
      await loadScoringSettings();   // betöltjük a pontozási UI-t (ha később settingsből jön)
      renderOddsPreview();           // és előnézetet is számolunk
    });

    function makeCard({title, hint, id, open=false, bodyHTML=''}){
      const s=document.createElement('section'); s.className='card'; if(id) s.id=id; if(open) s.classList.add('open');
      const h=document.createElement('div'); h.className='card-head'; h.innerHTML = `<h3>${title}</h3><div class="hint">${hint||''}</div>`; h.onclick=()=>s.classList.toggle('open');
      const b=document.createElement('div'); b.className='card-body'; b.innerHTML=bodyHTML;
      s.append(h,b); return {section:s, body:b}
    }

    function initUI(){
      const top=document.createElement('div'); top.className='topbar';
      const left=document.createElement('div'); left.className='left';
      const right=document.createElement('div'); right.className='right';
      const back=document.createElement('button'); back.className='btn'; back.textContent='⬅️ Vissza a dashboardra'; back.onclick=()=>location.href='dashboard_ucl.html';
      const expand=document.createElement('button'); expand.className='btn'; expand.textContent='Mindet nyisd le'; expand.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.add('open'));
      const collapse=document.createElement('button'); collapse.className='btn'; collapse.textContent='Mindet csukd össze'; collapse.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.remove('open'));
      const refresh=document.createElement('button'); refresh.className='btn'; refresh.textContent='Frissítés'; refresh.onclick=()=>{ loadMatches(); loadUsers(); loadResults(); loadPositionsLock(); loadOfficialOrder(); loadBonusMarkets(); loadOfficialBonus(); renderOddsPreview(); };
      left.appendChild(back); right.append(expand, collapse, refresh); document.body.append(top);

      const wrap=document.createElement('div'); wrap.className='cards';

      const teamOpts = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
      const cAdd = makeCard({title:'Új UCL meccs hozzáadása', hint:'Gyors űrlap', id:'card-add', open:true, bodyHTML:`
        <form id="matchForm">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${teamOpts}</select>
            <select id="awayTeam" required><option value="">Vendég csapat</option>${teamOpts}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Forduló / kör ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn primary">Mentés</button>
          </div>
        </form>`});

      const cManage = makeCard({title:'Feltöltött UCL meccsek', hint:'Szűrés, gyors szerkesztés', id:'card-manage', bodyHTML:`
        <div class="filterbar">
          <select id="filterRound"><option value="">Összes forduló</option></select>
          <input id="filterTeam" placeholder="Csapat szűrés" />
          <button class="btn" id="applyFilters">Szűrés</button>
          <button class="btn" id="resetFilters">Törlés</button>
        </div>
        <div id="matchesList"></div>`});

      const cRes = makeCard({title:'UCL meccseredmények kezelése', hint:'Gyors beírás', id:'card-results', bodyHTML:`
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>🟡 Eredmény nélküli meccsek</h3></div>
          <div class="card-body" id="noResultContent"></div>
        </div>
        <div class="card" style="margin:0">
          <div class="card-head" id="withResultHeader"><h3>🟢 Rögzített eredmények</h3></div>
          <div class="card-body" id="withResultContent" style="display:block"></div>
        </div>`});

      const cUsers = makeCard({title:'Felhasználók kezelése', hint:'Szerepkör váltás, törlés', id:'card-users', bodyHTML:`<ul id="userList" class="list" style="margin:0"></ul>`});

      const cTable = makeCard({title:'BL tabella kép feltöltése', hint:'PNG/JPG, base64 tárolás', id:'card-table', bodyHTML:`
        <div class="row">
          <input type="file" id="tableImageInput" accept="image/*">
          <button id="uploadTableImage" class="btn primary">Feltöltés</button>
        </div>`});

      const cOrder = makeCard({title:'Hivatalos UCL sorrend / fázisok (régi)', hint:'Húzd–és–vidd, mentés', id:'card-order', bodyHTML:`
        <button id="toggleOrder" class="btn">Sorrend szerkesztése/elrejtése</button>
        <ul id="sortableList" class="sortable" style="display:none; margin-top:10px;"></ul>
        <button id="saveOrderBtn" style="display:none;" class="btn primary">Mentés</button>`});

      const cLock = makeCard({title:'Pozíciós/Top8 tipp lezárás (UCL)', hint:'Azonnal vagy időpontra', id:'card-lock', bodyHTML:`
        <div class="muted">Itt szabályozható a Top 8 tipp módosíthatósága.</div>
        <div class="row" style="margin-top:8px">
          <label><input type="checkbox" id="lockNow"> Azonnali lezárás</label>
          <span class="muted">vagy</span>
          <label>Automatikus zárás időpontja: <input type="datetime-local" id="lockUntil"></label>
        </div>
        <div class="row"><input type="text" id="lockMessage" placeholder="Opcionális üzenet" style="flex:1;"></div>
        <div class="row">
          <button id="saveLock" class="btn primary">Lezárás beállítása</button>
          <button id="clearLock" class="btn danger">Lezárás feloldása</button>
          <span id="lockStatus" class="muted"></span>
        </div>`});

      const cBonusCh = makeCard({title:'Bónusz piacok – Végső győztes jelöltek', hint:'`ucl_championCandidates` (odds: decimális, pl. 2.00)', id:'card-bonus-ch', bodyHTML:`
        <form id="chAddForm">
          <div class="row">
            <select id="chAddTeam"><option value="">Válassz csapatot</option>${teamOpts}</select>
            <input type="text" id="chAddOdds" inputmode="decimal" placeholder="Odds (pl. 2.00)">
            <button class="btn primary" type="submit">Hozzáadás</button>
          </div>
          <div class="muted" style="margin-top:6px">Az odds decimális formátum (pl. 2.00). Régi adatoknál, ha csak % volt, automatikusan átszámoljuk.</div>
        </form>
        <div style="margin-top:12px">
          <table id="chTable">
            <thead><tr><th>Csapat</th><th>Odds (dec)</th><th>Művelet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`});

      const cBonusGb = makeCard({title:'Bónusz piacok – Gólkirály jelöltek', hint:'`ucl_goldenBootCandidates` (odds: decimális, pl. 3.50)', id:'card-bonus-gb', bodyHTML:`
        <form id="gbAddForm">
          <div class="row">
            <input id="gbAddPlayer" placeholder="Játékos neve">
            <select id="gbAddTeam"><option value="">Klub (opcionális)</option>${teamOpts}</select>
            <input type="text" id="gbAddOdds" inputmode="decimal" placeholder="Odds (pl. 3.50)">
            <button class="btn primary" type="submit">Hozzáadás</button>
          </div>
          <div class="muted" style="margin-top:6px">A klub opcionális. Az odds decimális; régi % adatokból konvertálunk.</div>
        </form>
        <div style="margin-top:12px">
          <table id="gbTable">
            <thead><tr><th>Játékos</th><th>Klub</th><th>Odds (dec)</th><th>Művelet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`});

      const cOfficial = makeCard({title:'Hivatalos eredmények – Top 8 / Győztes / Gólkirály', hint:'`ucl_official/current`', id:'card-official', bodyHTML:`
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>Top 8 (sorrend nélkül)</h3><div class="hint"><span id="top8Count" class="count">0/8</span></div></div>
          <div class="card-body">
            <div class="row">
              <div style="flex:1">
                <div class="muted" style="margin-bottom:6px">Kattints a csapatokra a kiválasztáshoz/kivételhez (max. 8).</div>
                <div id="top8Chips" class="chips"></div>
              </div>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="saveTop8" class="btn primary">Top 8 mentése</button>
            </div>
          </div>
        </div>
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>Végső győztes</h3></div>
          <div class="card-body">
            <div class="row">
              <select id="officialChampion"><option value="">Válassz csapatot</option>${teamOpts}</select>
              <button id="saveChampion" class="btn primary">Győztes mentése</button>
            </div>
            <div class="muted" style="margin-top:6px">Bármely csapat kiválasztható (nem kötött a jelöltekhez).</div>
          </div>
        </div>
        <div class="card" style="margin:0">
          <div class="card-head"><h3>Gólkirály</h3></div>
          <div class="card-body">
            <div class="row">
              <select id="officialGoldenPlayer"><option value="">Válassz játékost (jelöltek)</option></select>
              <input id="officialGoldenTeam" placeholder="Klub (betöltve a jelöltből)" readonly>
              <button id="saveGolden" class="btn primary">Gólkirály mentése</button>
            </div>
            <div class="muted" style="margin-top:6px">A játékost a jelöltek közül válaszd ki; a klub mező automatikusan kitöltődik.</div>
          </div>
        </div>`});

      /* ÚJ: Odds → % + Pont */
      const cOdds = makeCard({title:'Végső győztes – odds → megjelenített % + pont', hint:'Jelöltek normalizálása + favorit-laposítás', id:'card-odds', open:true, bodyHTML:`
        <div class="grid-odds">
          <div class="panel">
            <h4>Beállítás</h4>
            <div class="help">T – hőmérséklet a %-hoz (nagyobb = laposabb). A pontszámhoz: BASE, O<sub>0</sub> (ahol 10 pont), A (görbe), LO/HI clamp.</div>
            <div class="form-row"><label>Hőmérséklet (T)</label><input id="T" class="num" type="number" step="0.01" value="1.30"></div>
            <div class="form-row"><label>BASE</label><input id="BASE" class="num" type="number" step="0.1" value="10"></div>
            <div class="form-row"><label>O<sub>0</sub> (pivot odds)</label><input id="PIVOT" class="num" type="number" step="1" value="65"></div>
            <div class="form-row"><label>A (exponens)</label><input id="AEXP" class="num" type="number" step="0.01" value="0.33"></div>
            <div class="form-row"><label>LO (min ×BASE)</label><input id="LO" class="num" type="number" step="0.01" value="0.5"></div>
            <div class="form-row"><label>HI (max ×BASE)</label><input id="HI" class="num" type="number" step="0.01" value="2.5"></div>
            <div class="sticky-bottom">
              <button id="recalc" class="btn primary">Számold újra & mentsd</button>
              <span class="tag">Implied = 1/odds</span><span class="tag">softmax p^(1/T)</span><span class="tag">clamp pont</span>
            </div>
            <div class="muted-note">Lépések: (1) Implied p = 1/odds → normalizálás overroundra, (2) p' = p^(1/T), (3) újranormalizálás, (4) % = 100·p', (5) pont = BASE·clamp((odds/O0)^A, LO, HI).</div>
          </div>
          <div class="panel">
            <h4>Előnézet</h4>
            <div class="help">Jelöltek a mentett oddsok alapján</div>
            <div style="overflow:auto">
              <table id="oddsPreview">
                <thead><tr><th>Csapat</th><th>Odds (dec)</th><th>Implied % (raw)</th><th>Megjelenített %</th><th>Pont</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>`});

      document.body.append(wrap);
      wrap.append(
        cAdd.section, cManage.section, cRes.section, cUsers.section, cTable.section,
        cOrder.section, cLock.section,
        cBonusCh.section, cBonusGb.section, cOfficial.section,
        cOdds.section
      );

      document.getElementById('matchForm').addEventListener('submit', onAddMatch);
      document.getElementById('uploadTableImage').addEventListener('click', onUploadTableImage);
      document.getElementById('withResultHeader').onclick=()=>{ const c=document.getElementById('withResultContent'); c.style.display = c.style.display==='none' ? 'block':'none'; };
      const sortableList = document.getElementById('sortableList');
      document.getElementById('toggleOrder').onclick=()=>{ const vis = sortableList.style.display==='block'; sortableList.style.display = vis? 'none':'block'; document.getElementById('saveOrderBtn').style.display = vis? 'none':'inline-block'; };
      document.getElementById('saveOrderBtn').onclick = saveOfficialOrder;
      document.getElementById('applyFilters').onclick = renderMatchesFiltered;
      document.getElementById('resetFilters').onclick = ()=>{ document.getElementById('filterRound').value=''; document.getElementById('filterTeam').value=''; renderMatchesFiltered(); };
      document.getElementById('saveLock').onclick = saveLock;
      document.getElementById('clearLock').onclick = clearLock;

      document.getElementById('chAddForm').addEventListener('submit', onAddChampionCandidate);
      document.getElementById('gbAddForm').addEventListener('submit', onAddGoldenCandidate);

      document.getElementById('saveTop8').onclick = saveOfficialTop8;
      document.getElementById('saveChampion').onclick = saveOfficialChampion;
      document.getElementById('saveGolden').onclick = saveOfficialGolden;

      // odds → % + pont kalkulátor gomb
      document.getElementById('recalc').addEventListener('click', recalcAndSaveAll);
      // változtatásra azonnali előnézet
      ['T','BASE','PIVOT','AEXP','LO','HI'].forEach(id=>{
        document.getElementById(id).addEventListener('input', renderOddsPreview);
      });
    }

    let _matchesCache = [];
    async function loadMatches(){
      const container = document.getElementById('matchesList');
      if(!container) return;
      container.innerHTML = '';

      const snap = await getDocs(collection(db,'ucl_matches'));
      _matchesCache = [];
      const rounds = new Set();

      snap.forEach(docSnap=>{
        const d=docSnap.data();
        _matchesCache.push({ id:docSnap.id, ...d });
        if(d.roundId!=null) rounds.add(String(d.roundId));
      });

      const fr=document.getElementById('filterRound');
      if(fr) fr.innerHTML = '<option value="">Összes forduló</option>' + Array.from(rounds).sort((a,b)=>parseInt(a)-parseInt(b)).map(r=>`<option value="${r}">${r}</option>`).join('');

      renderMatchesFiltered();
    }

    function renderMatchesFiltered(){
      const container = document.getElementById('matchesList');
      if(!container) return;
      const r = document.getElementById('filterRound').value.trim();
      const q = (document.getElementById('filterTeam').value||'').toLowerCase();
      const list = _matchesCache.filter(m=> (!r || String(m.roundId)===r) && (!q || (m.homeTeam||'').toLowerCase().includes(q) || (m.awayTeam||'').toLowerCase().includes(q)) );
      renderMatches(list);
    }

    function renderMatches(list){
      const container = document.getElementById('matchesList');
      if(!container) return;
      container.innerHTML = '';
      if(list.length===0){ container.innerHTML = '<div class="muted">Nincs találat.</div>'; return }

      list.sort((a,b)=>{
        const ra = (parseInt(a.roundId||0) - parseInt(b.roundId||0)); if(ra) return ra;
        const ta = (a.startTime?.toDate?.()||new Date(0)) - (b.startTime?.toDate?.()||new Date(0)); return ta;
      });

      const dataList = document.createElement('datalist');
      dataList.id = 'teamsList';
      dataList.innerHTML = teams.map(t=>`<option value="${t}">`).join('');
      container.appendChild(dataList);

      list.forEach(d=>{
        const div=document.createElement('div');
        div.className='card';
        const iso = d.startTime?.toDate ? new Date(d.startTime.toDate()).toISOString().slice(0,16) : new Date(d.startTime).toISOString().slice(0,16);
        div.innerHTML = `
          <div class="card-head"><h3>${d.roundId||''}. forduló – ${d.homeTeam||''} vs ${d.awayTeam||''}</h3><div class="hint">${d.startTime?.toDate?.()?.toLocaleString('hu-HU')||''}</div></div>
          <div class="card-body">
            <div class="row">
              <input list="teamsList" value="${d.homeTeam||''}" id="home-${d.id}">
              <input list="teamsList" value="${d.awayTeam||''}" id="away-${d.id}">
              <input type="datetime-local" value="${iso}" id="start-${d.id}">
              <input value="${d.roundId||''}" id="round-${d.id}">
              <input value="${d.odds?.["1"]??''}" id="odds1-${d.id}" placeholder="Odds 1" style="width:90px">
              <input value="${d.odds?.["X"]??''}" id="oddsX-${d.id}" placeholder="Odds X" style="width:90px">
              <input value="${d.odds?.["2"]??''}" id="odds2-${d.id}" placeholder="Odds 2" style="width:90px">
              <button class="btn primary" onclick="updateMatch('${d.id}')">Mentés</button>
              <button class="btn danger" onclick="deleteMatch('${d.id}')">Törlés</button>
            </div>
          </div>`;
        div.querySelector('.card-head').onclick = ()=> div.classList.toggle('open');
        container.appendChild(div);
      });
    }

    async function updateMatch(id){
      const ref = doc(db,'ucl_matches',id);
      await updateDoc(ref,{
        homeTeam: document.getElementById(`home-${id}`).value,
        awayTeam: document.getElementById(`away-${id}`).value,
        startTime: Timestamp.fromDate(new Date(document.getElementById(`start-${id}`).value)),
        roundId: document.getElementById(`round-${id}`).value,
        odds: {
          "1": parseFloat(document.getElementById(`odds1-${id}`).value),
          "X": parseFloat(document.getElementById(`oddsX-${id}`).value),
          "2": parseFloat(document.getElementById(`odds2-${id}`).value)
        }
      });
      alert('Mentve');
      await loadMatches();
      await loadResults();
    }

    async function deleteMatch(id){
      if(!confirm('Biztos törölni akarod?')) return;
      await deleteDoc(doc(db,'ucl_matches',id));
      await loadMatches();
      await loadResults();
    }

    async function onAddMatch(e){
      e.preventDefault();
      const startTime = Timestamp.fromDate(new Date(document.getElementById('startTime').value));
      await addDoc(collection(db,'ucl_matches'),{
        homeTeam: homeTeam.value,
        awayTeam: awayTeam.value,
        startTime,
        roundId: roundId.value,
        odds: {"1":parseFloat(odds1.value),"X":parseFloat(oddsX.value),"2":parseFloat(odds2.value)}
      });
      alert('UCL meccs mentve');
      e.target.reset();
      await loadMatches();
      await loadResults();
    }

    async function onUploadTableImage(){
      const f=document.getElementById('tableImageInput').files[0];
      if(!f) return alert('Válassz ki egy képet!');
      const rd=new FileReader();
      rd.onload=async()=>{
        const b64=rd.result.split(',')[1];
        await setDoc(doc(db,'settings','ucl_table_image'),{ base64:b64 });
        alert('Kép elmentve (settings/ucl_table_image).');
      };
      rd.readAsDataURL(f);
    }

    async function loadResults(){
      const noC=document.getElementById('noResultContent');
      const withC=document.getElementById('withResultContent');
      if(!noC || !withC) return;
      noC.innerHTML=''; withC.innerHTML='';

      const snap = await getDocs(collection(db,'ucl_matches'));
      const no=[], yes=[];
      snap.forEach(docSnap=>{ const d=docSnap.data(); const m={ id:docSnap.id, ...d }; if(d.result) yes.push(m); else no.push(m) });
      renderMatchGroup(no, noC, false);
      renderMatchGroup(yes, withC, true);
    }

    function renderMatchGroup(matches, container, hasResult){
      const grouped={};
      matches.forEach(m=>{ const r=m.roundId||'Egyéb'; (grouped[r]||(grouped[r]=[])).push(m) });
      Object.keys(grouped).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(r=>{
        const title=document.createElement('h4'); title.textContent = `${r}. forduló`; container.appendChild(title);
        grouped[r].forEach(match=>{
          const div=document.createElement('div'); div.className='card';
          div.innerHTML = `
            <div class="card-head"><h3>${match.homeTeam} - ${match.awayTeam}</h3><div class="hint">${match.startTime?.toDate?.()?.toLocaleString('hu-HU')||''}</div></div>
            <div class="card-body">
              <div class="row">
                <input placeholder="pl. 2-1" value="${match.result||''}" id="res-${match.id}" style="width:80px">
                <button class="btn primary" id="btn-${match.id}">${hasResult? 'Módosítás':'Mentés'}</button>
              </div>
            </div>`;
          div.querySelector('.card-head').onclick = ()=> div.classList.toggle('open');
          div.querySelector(`#btn-${match.id}`).onclick = async ()=>{
            const v=document.getElementById(`res-${match.id}`).value.trim();
            const oc=parseOutcome(v); if(!oc){ alert('Hibás formátum. pl. 3-1 vagy 1-1'); return }
            await updateDoc(doc(db,'ucl_matches',match.id),{ result:v, outcome:oc });
            await loadResults();
          };
          container.appendChild(div);
        });
      });
    }

    async function loadUsers(){
      const list=document.getElementById('userList'); if(!list) return;
      list.innerHTML='';
      const snap=await getDocs(collection(db,'users'));
      snap.forEach(docSnap=>{
        const user=docSnap.data();
        const li=document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="card-head"><h3>${user.nickname||user.email}</h3><div class="hint">${user.email}</div></div>
          <div class="card-body">
            <div class="row">
              <select class="roleSel">
                <option value="user" ${user.role==='user'?'selected':''}>User</option>
                <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
              </select>
              <button class="btn primary save-role">Mentés</button>
              <button class="btn danger delete-user">Törlés</button>
            </div>
          </div>`;
        li.querySelector('.card-head').onclick=()=>li.classList.toggle('open');
        const sel=li.querySelector('.roleSel');
        li.querySelector('.save-role').onclick=async ()=>{ await updateDoc(doc(db,'users',user.email),{ role: sel.value }); alert('Szerepkör frissítve.') };
        li.querySelector('.delete-user').onclick=async ()=>{ if(!confirm(`Törlöd: ${user.email}? Ez nem törli a belépési fiókot, csak a Firestore-ból.`)) return; await deleteDoc(doc(db,'users',user.email)); await loadUsers() };
        list.appendChild(li);
      });
    }

    async function loadPositionsLock(){
      const status=document.getElementById('lockStatus'); if(!status) return;
      const snap=await getDoc(doc(db,'settings','positionsLock_ucl'));
      if(!snap.exists()){ status.textContent='Jelenleg nyitva.'; status.className='muted'; return }
      const d=snap.data()||{}; const isLocked=!!d.isLocked; const until=d.lockUntil?.toDate?.()||null; const msg=d.message||''; const now=new Date(); const timeLocked=until && now>=until;
      if(isLocked || timeLocked){ status.textContent = `ZÁRVA ${timeLocked&&until?`(határidő: ${until.toLocaleString('hu-HU')})`:'(azonnali zárás)'}${msg?` – ${msg}`:''}`; status.className='warn' } else { status.textContent='Jelenleg nyitva.'; status.className='ok' }
    }
    async function saveLock(){
      const lockNow=document.getElementById('lockNow').checked; const untilStr=document.getElementById('lockUntil').value; const message=document.getElementById('lockMessage').value.trim();
      let docObj={ isLocked:!!lockNow, message: message||'' };
      if(untilStr){ const dt=new Date(untilStr); if(isNaN(+dt)) return alert('Hibás dátum/idő.'); docObj.lockUntil = Timestamp.fromDate(dt) } else { docObj.lockUntil = null }
      await setDoc(doc(db,'settings','positionsLock_ucl'), docObj);
      alert('Lezárás beállítva.');
      await loadPositionsLock();
    }
    async function clearLock(){ await setDoc(doc(db,'settings','positionsLock_ucl'),{ isLocked:false, lockUntil:null, message:'' }); alert('Lezárás feloldva.'); await loadPositionsLock(); }

    async function loadOfficialOrder(){
      const ref=doc(db,'finalStandings_ucl','official');
      const listEl=document.getElementById('sortableList'); if(!listEl) return;
      listEl.innerHTML='';
      const snap=await getDoc(ref);
      const source = snap.exists() && Array.isArray(snap.data().teams) ? snap.data().teams : teams;
      const arr = source.map(stripNumPrefix);
      let dragged=null;
      arr.forEach(team=>{
        const li=document.createElement('li'); li.textContent=team; li.draggable=true;
        li.addEventListener('dragstart',()=>{ dragged=li; li.classList.add('dragging') });
        li.addEventListener('dragend',()=>{ dragged=null; li.classList.remove('dragging') });
        li.addEventListener('dragover',(e)=>{ e.preventDefault(); const r=li.getBoundingClientRect(); const after=(e.clientY - (r.top + r.height/2))>0; const p=li.parentNode; p.insertBefore(dragged, after? li.nextSibling: li); });
        listEl.appendChild(li);
      });
    }

    async function saveOfficialOrder(){
      const list=[...document.querySelectorAll('#sortableList li')].map(li=> stripNumPrefix(li.textContent.trim()));
      await setDoc(doc(db,'finalStandings_ucl','official'),{ teams:list, positions:list.map((t,i)=>({ team:t, position:i+1 })) });
      alert('Sorrend elmentve.');
    }

    async function loadBonusMarkets(){
      const cSnap = await getDocs(collection(db,'ucl_championCandidates'));
      championCandidates = cSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) })).filter(x=>x.team);
      renderChampionCandidates();

      const gSnap = await getDocs(collection(db,'ucl_goldenBootCandidates'));
      goldenCandidates = gSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) })).filter(x=>x.player);
      renderGoldenCandidates();

      const sel = document.getElementById('officialGoldenPlayer');
      if(sel){
        sel.innerHTML = '<option value="">Válassz játékost (jelöltek)</option>' + goldenCandidates.map(c=>`<option value="${c.player}" data-team="${c.team||''}">${c.player}${c.team?` (${c.team})`:''}</option>`).join('');
        sel.onchange = ()=>{
          const teamInput = document.getElementById('officialGoldenTeam');
          const opt = sel.options[sel.selectedIndex];
          teamInput.value = opt?.dataset?.team || '';
        };
      }
    }

    function renderChampionCandidates(){
      const tbody=document.querySelector('#chTable tbody'); if(!tbody) return;
      tbody.innerHTML='';
      championCandidates.sort((a,b)=>norm(a.team).localeCompare(norm(b.team),'hu'));
      championCandidates.forEach(c=>{
        const currentOdds = fromCandidateOdds(c);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>
            <select id="ch-team-${c.id}">
              ${teams.map(t=>`<option value="${t}" ${t===c.team?'selected':''}>${t}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" id="ch-odds-${c.id}" value="${fmtOdds(currentOdds)}" placeholder="pl. 2.00" style="width:120px"></td>
          <td>
            <button class="btn primary" data-act="save" data-id="${c.id}">Mentés</button>
            <button class="btn danger" data-act="del" data-id="${c.id}">Törlés</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const id=btn.dataset.id;
          if(btn.dataset.act==='save'){
            const team = document.getElementById(`ch-team-${id}`).value;
            const oddsDec = toNum(document.getElementById(`ch-odds-${id}`).value);
            if(!team) return alert('Válassz csapatot!');
            if(oddsDec==null || oddsDec<=0) return alert('Adj meg érvényes decimális oddsot (pl. 2.00)!');
            const dup = championCandidates.find(x=>x.id!==id && norm(x.team)===norm(team));
            if(dup) return alert('Már van ilyen csapat a jelöltek között.');
            await updateDoc(doc(db,'ucl_championCandidates',id),{
              team,
              odds: oddsDec,
              oddsDecimal: oddsDec,
              oddsPercent: Math.round(100/oddsDec)
            });
            await loadBonusMarkets();
            renderOddsPreview();
          } else if(btn.dataset.act==='del'){
            if(!confirm('Törlöd a jelöltet?')) return;
            await deleteDoc(doc(db,'ucl_championCandidates',id));
            await loadBonusMarkets();
            renderOddsPreview();
          }
        };
      });
    }

    async function onAddChampionCandidate(e){
      e.preventDefault();
      const teamSel = document.getElementById('chAddTeam');
      const oddsInp = document.getElementById('chAddOdds');
      const team = teamSel.value;
      const oddsDec = toNum(oddsInp.value);
      if(!team) return alert('Válassz csapatot!');
      if(oddsDec==null || oddsDec<=0) return alert('Adj meg érvényes decimális oddsot (pl. 2.00)!');
      if(championCandidates.some(c=>norm(c.team)===norm(team))) return alert('Ez a csapat már szerepel a jelöltek között.');
      await addDoc(collection(db,'ucl_championCandidates'),{
        team,
        odds: oddsDec,
        oddsDecimal: oddsDec,
        oddsPercent: Math.round(100/oddsDec)
      });
      teamSel.value=''; oddsInp.value='';
      await loadBonusMarkets();
      renderOddsPreview();
    }

    function renderGoldenCandidates(){
      const tbody=document.querySelector('#gbTable tbody'); if(!tbody) return;
      tbody.innerHTML='';
      goldenCandidates.sort((a,b)=>norm(a.player).localeCompare(norm(b.player),'hu'));
      goldenCandidates.forEach(c=>{
        const currentOdds = fromCandidateOdds(c);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input id="gb-player-${c.id}" value="${c.player}"></td>
          <td>
            <select id="gb-team-${c.id}">
              <option value="">–</option>
              ${teams.map(t=>`<option value="${t}" ${t===(c.team||'')?'selected':''}>${t}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" id="gb-odds-${c.id}" value="${fmtOdds(currentOdds)}" placeholder="pl. 3.50" style="width:120px"></td>
          <td>
            <button class="btn primary" data-act="save" data-id="${c.id}">Mentés</button>
            <button class="btn danger" data-act="del" data-id="${c.id}">Törlés</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const id=btn.dataset.id;
          if(btn.dataset.act==='save'){
            const player = document.getElementById(`gb-player-${id}`).value.trim();
            const team = document.getElementById(`gb-team-${id}`).value || '';
            const oddsDec = toNum(document.getElementById(`gb-odds-${id}`).value);
            if(!player) return alert('A játékos neve kötelező.');
            if(oddsDec==null || oddsDec<=0) return alert('Adj meg érvényes decimális oddsot (pl. 3.50)!');
            const dup = goldenCandidates.find(x=>x.id!==id && norm(x.player)===norm(player));
            if(dup) return alert('Ez a játékos már szerepel a jelöltek között.');
            await updateDoc(doc(db,'ucl_goldenBootCandidates',id),{
              player, team,
              odds: oddsDec,
              oddsDecimal: oddsDec,
              oddsPercent: Math.round(100/oddsDec)
            });
            await loadBonusMarkets();
          } else if(btn.dataset.act==='del'){
            if(!confirm('Törlöd a jelöltet?')) return;
            await deleteDoc(doc(db,'ucl_goldenBootCandidates',id));
            await loadBonusMarkets();
          }
        };
      });
    }

    async function onAddGoldenCandidate(e){
      e.preventDefault();
      const player = document.getElementById('gbAddPlayer').value.trim();
      const team = document.getElementById('gbAddTeam').value || '';
      const oddsDec = toNum(document.getElementById('gbAddOdds').value);
      if(!player) return alert('Írd be a játékos nevét!');
      if(oddsDec==null || oddsDec<=0) return alert('Adj meg érvényes decimális oddsot (pl. 3.50)!');
      if(goldenCandidates.some(c=>norm(c.player)===norm(player))) return alert('Ez a játékos már szerepel a jelöltek között.');
      await addDoc(collection(db,'ucl_goldenBootCandidates'),{
        player, team,
        odds: oddsDec,
        oddsDecimal: oddsDec,
        oddsPercent: Math.round(100/oddsDec)
      });
      document.getElementById('gbAddPlayer').value='';
      document.getElementById('gbAddTeam').value='';
      document.getElementById('gbAddOdds').value='';
      await loadBonusMarkets();
    }

    function renderTop8Chips(){
      const box = document.getElementById('top8Chips'); if(!box) return;
      box.innerHTML='';
      const set = new Set(officialTop8);
      teams.forEach(t=>{
        const div=document.createElement('div');
        div.className='chip' + (set.has(t)?' selected':'');
        div.textContent = t;
        div.onclick = ()=>{
          if(set.has(t)){ set.delete(t) }
          else{
            if(set.size>=8) return;
            set.add(t);
          }
          officialTop8 = Array.from(set);
          renderTop8Chips();
          updateTop8Count();
        };
        box.appendChild(div);
      });
      updateTop8Count();
    }
    function updateTop8Count(){
      const el=document.getElementById('top8Count'); if(el) el.textContent = `${officialTop8.length}/8`;
    }

    async function loadOfficialBonus(){
      const ref=doc(db,'ucl_official','current');
      const snap=await getDoc(ref);
      if(snap.exists()){
        const d=snap.data()||{};
        officialTop8 = Array.isArray(d.top8)? d.top8.filter(x=>teams.includes(x)).slice(0,8): [];
        officialChampion = teams.includes(d.champion)? d.champion : "";
        officialGolden = d.goldenBoot && d.goldenBoot.player ? { player:d.goldenBoot.player, team:d.goldenBoot.team||"" } : { player:"", team:"" };
      }else{
        officialTop8 = [];
        officialChampion = "";
        officialGolden = { player:"", team:"" };
      }
      renderTop8Chips();
      const chSel = document.getElementById('officialChampion'); if(chSel) chSel.value = officialChampion || "";
      const gbSel = document.getElementById('officialGoldenPlayer'); if(gbSel) {
        gbSel.value = officialGolden.player || "";
        const opt = gbSel.options[gbSel.selectedIndex];
        document.getElementById('officialGoldenTeam').value = opt?.dataset?.team || officialGolden.team || "";
      }
    }

    async function saveOfficialTop8(){
      if(officialTop8.length!==8) return alert('Pontosan 8 csapatot válassz ki a Top 8-hoz.');
      await setDoc(doc(db,'ucl_official','current'),{
        top8: officialTop8,
      },{ merge:true });
      alert('Top 8 elmentve.');
    }
    async function saveOfficialChampion(){
      const val = document.getElementById('officialChampion').value || "";
      if(!val) return alert('Válassz csapatot!');
      await setDoc(doc(db,'ucl_official','current'),{ champion: val },{ merge:true });
      officialChampion = val;
      alert('Győztes elmentve.');
    }
    async function saveOfficialGolden(){
      const playerSel = document.getElementById('officialGoldenPlayer');
      const player = playerSel.value || "";
      if(!player) return alert('Válassz játékost!');
      const team = playerSel.options[playerSel.selectedIndex]?.dataset?.team || "";
      await setDoc(doc(db,'ucl_official','current'),{ goldenBoot: { player, team } },{ merge:true });
      officialGolden = { player, team };
      document.getElementById('officialGoldenTeam').value = team;
      alert('Gólkirály elmentve.');
    }

    /* ===== Odds → % + Pont logika ===== */
    // %-hoz: implied -> norm -> p^(1/T) -> norm -> %
    function computeDisplayedPerc(rows, T){
      const ps = rows.map(r=>{
        const o = toNum(r.odds);
        return (o && o>0) ? (1/o) : 0;
      });
      let S = ps.reduce((a,b)=>a+b,0); if(!S) S=1;
      const p = ps.map(x => x/S);
      const q = p.map(x => Math.pow(x, 1/Math.max(T, 0.0001)));
      let Z = q.reduce((a,b)=>a+b,0); if(!Z) Z=1;
      return q.map(x => 100 * x / Z);
    }
    // ponthoz: BASE * clamp((odds/O0)^A, LO, HI)
    function computePoints(odds, BASE, O0, A, LO, HI){
      const o = toNum(odds); if(!o || o<=0) return 0;
      const ratio = Math.pow(o/Math.max(O0,1e-9), A);
      const clamped = Math.min(Math.max(ratio, LO), HI);
      return BASE * clamped;
    }

    async function loadScoringSettings(){
      // Opcionális: később beolvasható settingsből.
    }

    function currentParams(){
      return {
        T:   toNum(document.getElementById('T').value)    ?? 1.30,
        BASE:toNum(document.getElementById('BASE').value) ?? 10,
        O0:  toNum(document.getElementById('PIVOT').value)?? 65,
        A:   toNum(document.getElementById('AEXP').value) ?? 0.33,
        LO:  toNum(document.getElementById('LO').value)   ?? 0.5,
        HI:  toNum(document.getElementById('HI').value)   ?? 2.5,
      };
    }

    function renderOddsPreview(){
      const tbody = document.querySelector('#oddsPreview tbody'); if(!tbody) return;
      tbody.innerHTML='';
      const rows = championCandidates.map(c=>({ team:c.team, odds: fromCandidateOdds(c) })).filter(r=>r.odds);
      if(rows.length===0){ tbody.innerHTML = '<tr><td colspan="5" class="muted">Nincs jelölt</td></tr>'; return; }

      const {T, BASE, O0, A, LO, HI} = currentParams();
      const shown = computeDisplayedPerc(rows, T);

      rows.forEach((r,idx)=>{
        const implied = (100/r.odds);
        const pts = computePoints(r.odds, BASE, O0, A, LO, HI);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${r.team}</td>
          <td class="mono">${fmtOdds(r.odds)}</td>
          <td class="mono">${implied.toFixed(1)}%</td>
          <td class="mono"><strong>${shown[idx].toFixed(1)}%</strong></td>
          <td class="mono">${pts.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Bajnok + gólkirály jelöltekre is mentjük a displayPercent/displayPoints értékeket (2 tizedes pont!)
    async function recalcAndSaveAll(){
      const {T, BASE, O0, A, LO, HI} = currentParams();

      // --- 1) Bajnok jelöltek ---
      const rowsCh = championCandidates
        .map(c=>({ id:c.id, odds: fromCandidateOdds(c) }))
        .filter(r=>r.odds);
      if(rowsCh.length>0){
        const shownCh = computeDisplayedPerc(rowsCh, T);
        for(let i=0;i<rowsCh.length;i++){
          const r = rowsCh[i];
          const displayPercent = Number(shownCh[i].toFixed(1));
          const displayPoints  = Number(computePoints(r.odds, BASE, O0, A, LO, HI).toFixed(2)); // 2 tizedes
          await updateDoc(doc(db,'ucl_championCandidates', r.id), {
            displayPercent,
            displayPoints,
            _calc: { T, BASE, O0, A, LO, HI, updated: Date.now() }
          });
        }
      }

      // --- 2) Gólkirály jelöltek ---
      const rowsGb = goldenCandidates
        .map(c=>({ id:c.id, odds: fromCandidateOdds(c) }))
        .filter(r=>r.odds);
      if(rowsGb.length>0){
        const shownGb = computeDisplayedPerc(rowsGb, T);
        for(let i=0;i<rowsGb.length;i++){
          const r = rowsGb[i];
          const displayPercent = Number(shownGb[i].toFixed(1));
          const displayPoints  = Number(computePoints(r.odds, BASE, O0, A, LO, HI).toFixed(2)); // 2 tizedes
          await updateDoc(doc(db,'ucl_goldenBootCandidates', r.id), {
            displayPercent,
            displayPoints,
            _calc: { T, BASE, O0, A, LO, HI, updated: Date.now() }
          });
        }
      }

      alert('Megjelenített % és Pont mentve a jelöltekhez (bajnok + gólkirály).');
      renderOddsPreview(); // (előnézet most a bajnok-listát mutatja)
    }

    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;
    window.saveLock = saveLock;
    window.clearLock = clearLock;
    window.saveOfficialOrder = saveOfficialOrder;
  </script>
</head>
<body></body>
</html>
