<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-600:#1d4ed8;--danger:#ef4444;--border:#e5e7eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left{display:flex;gap:8px;align-items:center}
    .topbar .right{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}

    .cards{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer;background:linear-gradient(180deg,#fff, #fafafa)}
    .card-head h3{margin:0;font-size:16px}
    .card-head .hint{color:var(--muted);font-size:12px}
    .card-body{display:none;padding:16px;border-top:1px solid var(--border)}
    .card.open .card-body{display:block}

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input[type="datetime-local"]{min-width:230px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    thead th{background:#f8fafc;font-weight:700}
    tbody tr:hover{background:#fafcff}
    .muted{color:var(--muted)}
    .ok{color:#16a34a;font-weight:700}
    .warn{color:#b45309;font-weight:700}

    .filterbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .chip.selected{outline:2px solid color-mix(in oklab, var(--primary) 35%, white)}
    .count{font-size:12px;color:#111;background:#e6f1ff;border:1px solid var(--border);padding:2px 8px;border-radius:999px}

    /* Odds ‚Üí % + Pont k√°rty√°k */
    .grid-odds{display:grid;grid-template-columns:280px 1fr;gap:14px}
    @media (max-width:900px){.grid-odds{grid-template-columns:1fr}}
    .panel{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace}
    .xscroll{overflow:auto}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, Timestamp, serverTimestamp, doc, getDoc, setDoc, deleteDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain:"tippliga-4b3af.firebaseapp.com", projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com", messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* >>> BULK MAIL ‚Äì GAS Web App URL (a te linked) <<< */
    const GS_BULKMAIL_URL = "https://script.google.com/macros/s/AKfycbzSmmexY18InfsYTHNdkVnbO1mzJ7Mol9PDNnk0x91KOTbLfPpwcZwsP7A94owxS5FovQ/exec";

    // UCL 36 csapat
    const teams = [
      "Ajax","Arsenal","Atalanta","Athletic Bilbao","Atl√©tico Madrid","Barcelona","Bayer Leverkusen","Bayern M√ºnchen","Benfica","Bologna","Borussia Dortmund","Chelsea","Club Brugge","Copenhagen","Crvena zvezda","Dinamo Zagreb","Feyenoord","Galatasaray","Girona","Inter","Juventus","Leipzig","Liverpool","Manchester City","Milan","Monaco","Newcastle","Olympiacos","Pafos","PSG","PSV","Porto","Real Madrid","Salzburg","Shakhtar","Sporting CP"
    ];

    onAuthStateChanged(auth, async (user) => {
      if(!user){ document.body.innerHTML = "<h2 style='padding:20px'>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return }
      const userSnap = await getDoc(doc(db, "users", user.email));
      if(!userSnap.exists() || (userSnap.data().role !== "admin")){
        document.body.innerHTML = "<h2 style='padding:20px'>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return
      }
      initUI();
      await loadMatches();
      await loadUsers();
      await loadTipStatus();
      await loadResults();
      await loadPositionsLock();
      await loadBonusMarkets();
      await loadOfficialBonus();
      await loadScoringSettings();
      // + bulk mail r√©szek:
      await loadTemplates();
      await loadMailLog();

      renderChampionOddsPreview();
      renderGoldenOddsPreview();
    });

    function makeCard({title, hint, id, open=false, bodyHTML=''}) {
      const s=document.createElement('section'); s.className='card'; if(id) s.id=id; if(open) s.classList.add('open');
      const h=document.createElement('div'); h.className='card-head'; h.innerHTML=`<h3>${title}</h3><div class="hint">${hint||''}</div>`; h.onclick=()=>s.classList.toggle('open');
      const b=document.createElement('div'); b.className='card-body'; b.innerHTML=bodyHTML;
      s.append(h,b); return {section:s, body:b}
    }

    function initUI(){
      const top=document.createElement('div'); top.className='topbar';
      const left=document.createElement('div'); left.className='left';
      const right=document.createElement('div'); right.className='right';
      const back=document.createElement('button'); back.className='btn'; back.textContent='‚Üê Vissza a dashboardra'; back.onclick=()=>location.href='dashboard_ucl.html';
      const expand=document.createElement('button'); expand.className='btn'; expand.textContent='Mindent lenyit'; expand.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.add('open'));
      const collapse=document.createElement('button'); collapse.className='btn'; collapse.textContent='Mindent csuk'; collapse.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.remove('open'));
      const refresh=document.createElement('button'); refresh.className='btn'; refresh.textContent='Friss√≠t'; refresh.onclick=async()=>{ await loadMatches(); await loadUsers(); await loadTipStatus(); await loadResults(); await loadPositionsLock(); await loadBonusMarkets(); await loadOfficialBonus(); await loadScoringSettings(); renderChampionOddsPreview(); renderGoldenOddsPreview(); loadTemplates(); loadMailLog(); };

      left.appendChild(back);
      right.append(expand, collapse, refresh);
      top.append(left, right);
      document.body.append(top);

      const wrap=document.createElement('div'); wrap.className='cards';

      const teamOpts = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
      const cAdd = makeCard({title:'√öj UCL meccs hozz√°ad√°sa', hint:'Gyors ≈±rlap', id:'card-add', bodyHTML:`
        <form id="matchForm">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${teamOpts}</select>
            <select id="awayTeam" required><option value="">Vend√©g csapat</option>${teamOpts}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Fordul√≥ / k√∂r ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn primary">Ment√©s</button>
          </div>
        </form>`});

      const cManage = makeCard({title:'UCL meccsek kezel√©se', hint:'Sz≈±r√©s, szerkeszt√©s, t√∂rl√©s', id:'card-manage', bodyHTML:`
        <div class="filterbar">
          <input id="filterTeam" placeholder="Csapatn√©v‚Ä¶">
          <select id="filterRound"><option value="">√ñsszes fordul√≥</option></select>
          <button class="btn" id="applyFilters">Sz≈±r√©s</button>
          <button class="btn" id="resetFilters">T√∂rl√©s</button>
        </div>
        <div id="matchesList"></div>`});

      const cRes = makeCard({title:'UCL meccseredm√©nyek kezel√©se', hint:'Gyors r√∂gz√≠t√©s', id:'card-results', bodyHTML:`
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
          <div class="card-body" id="noResultContent"></div>
        </div>
        <div class="card" style="margin:0">
          <div class="card-head" id="withResultHeader"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>
          <div class="card-body" id="withResultContent" style="display:block"></div>
        </div>`});

      const cUsers = makeCard({title:'Felhaszn√°l√≥k kezel√©se', hint:'List√°z√°s, szerepk√∂r', id:'card-users', bodyHTML:`<ul id="userList" class="list" style="margin:0"></ul>`});

      /* ===== Tipp lead√°sok ‚Äì st√°tusz (AKT√çV meccsek + positions + eml√©keztet≈ëk) ===== */
      const cTipStatus = makeCard({
        title: 'Tipp lead√°sok ‚Äì st√°tusz',
        hint: 'Akt√≠v meccsekb≈ël leadott tippek / √∂sszes akt√≠v, Top8/Champ/Golden √©s eml√©keztet≈ëk sz√°ma',
        id: 'card-tipstatus',
        open: false,
        bodyHTML: `
          <div class="row" style="justify-content:space-between">
            <div class="row" style="gap:8px">
              <button class="btn" id="reloadTipStatus">Friss√≠t√©s</button>
              <span id="tipStatusMeta" class="muted"></span>
            </div>
          </div>
          <div id="tipStatusTableWrap" class="xscroll" style="overflow:auto; margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th>Felhaszn√°l√≥</th>
                  <th>Email</th>
                  <th>Akt√≠v meccsek</th>
                  <th>Leadott</th>
                  <th>√Ållapot</th>
                  <th>Top8</th>
                  <th>Gy≈ëztes</th>
                  <th>G√≥lkir√°ly</th>
                  <th>Eml√©keztet≈ëk</th>
                </tr>
              </thead>
              <tbody id="tipStatusTbody"></tbody>
            </table>
          </div>`
      });

      /* üîí Poz√≠ci√≥s tipp lez√°r√°s (UCL) */
      const cLock = makeCard({
        title:'Poz√≠ci√≥s tipp lez√°r√°s (Top8 + Gy≈ëztes + G√≥lkir√°ly)',
        hint:'settings/positionsLock_ucl',
        id:'card-lock',
        bodyHTML:`
          <div class="row">
            <label class="row">√úzenet <input id="lockMsg" placeholder="√úzenet (opcion√°lis)"></label>
            <label class="row">Hat√°rid≈ë <input id="lockUntil" type="datetime-local"></label>
            <button class="btn primary" id="saveLock">Ment√©s</button>
            <button class="btn" id="clearLock">Lez√°r√°s t√∂rl√©se</button>
          </div>
          <div id="lockState" class="muted" style="margin-top:8px"></div>`});

      /* B√≥nusz piacok ‚Äì Gy≈ëztes/G√≥lkir√°ly kezel√©se ‚Äì ‚Ä¶ (eredeti tartalom v√°ltozatlan) */
      const cBonusCh = makeCard({title:'V√©gs≈ë gy≈ëztes ‚Äì jel√∂ltek', hint:'Csapatok + s√∫ly', id:'card-bonus-ch', bodyHTML:`<div id="bonusChWrap"></div>`});
      const cBonusGb = makeCard({title:'G√≥lkir√°ly ‚Äì jel√∂ltek', hint:'J√°t√©kosok + s√∫ly', id:'card-bonus-gb', bodyHTML:`<div id="bonusGbWrap"></div>`});

      /* Hivatalos eredm√©nyek ‚Äì Gy≈ëztes & G√≥lkir√°ly */
      const cOfficial = makeCard({
        title:'Hivatalos eredm√©nyek ‚Äì Gy≈ëztes / G√≥lkir√°ly',
        hint:'`ucl_official/current`',
        id:'card-official',
        bodyHTML: `
          <div class="card" style="margin:0 0 12px 0">
            <div class="card-head"><h3>V√©gs≈ë gy≈ëztes</h3></div>
            <div class="card-body">
              <div class="row">
                <select id="officialChampion"><option value="">V√°lassz csapatot</option>${teamOpts}</select>
                <button id="saveChampion" class="btn primary">Gy≈ëztes ment√©se</button>
                <button id="clearChampion" class="btn">Alaphelyzet</button>
              </div>
              <div class="muted" id="officialChampionState" style="margin-top:6px"></div>
            </div>
          </div>

          <div class="card" style="margin:0">
            <div class="card-head"><h3>G√≥lkir√°ly</h3></div>
            <div class="card-body">
              <div class="row">
                <input id="officialGolden" placeholder="J√°t√©kos neve">
                <input id="officialGoldenTeam" placeholder="Csapat">
                <button id="saveGolden" class="btn primary">G√≥lkir√°ly ment√©se</button>
                <button id="clearGolden" class="btn">Alaphelyzet</button>
              </div>
              <div class="muted" id="officialGoldenState" style="margin-top:6px"></div>
            </div>
          </div>
        `});

      /* Odds ‚Üí % + pont el≈ën√©zet (eredeti tartalom v√°ltozatlan) */
      const cOddsCh = makeCard({title:'V√©gs≈ë gy≈ëztes ‚Äì odds ‚Üí pont', hint:'El≈ën√©zet', id:'card-odds-ch', bodyHTML:`<div id="oddsPreview_CH"></div>`});
      const cOddsGb = makeCard({title:'G√≥lkir√°ly ‚Äì odds ‚Üí pont', hint:'El≈ën√©zet', id:'card-odds-gb', bodyHTML:`<div id="oddsPreview_GB"></div>`});
      const cBulk   = makeCard({title:'K√∂remail k√ºld√©s', hint:'C√≠mzettek, t√°rgy, sablonok', id:'card-bulkmail', bodyHTML:`<div id="bulkWrap"></div>`});
      const cLog    = makeCard({title:'E-mail napl√≥', hint:'adminMailLog', id:'card-maillog', bodyHTML:`<div><div class="muted" style="margin-bottom:6px">A <span class="kbd">‚Ü© Bet√∂lt</span> gombbal visszat√∂ltheted a t√°rgy/√ºzenet mez≈ëkbe</div><div id="mailLogBox" class="xscroll"></div></div>`});
      const cBulkGb = makeCard({title:'Sablonok', hint:'Ment√©s/Bet√∂lt√©s', id:'card-bulkgb', bodyHTML:`<div id="tplBox"></div>`});

      document.body.append(wrap);
      wrap.append(
        cAdd.section, cManage.section, cRes.section, cUsers.section,
        cTipStatus.section,
        cBulk.section, cLog.section,  /* <<< √öJ k√°rty√°k itt */
        cLock.section,
        cBonusCh.section, cBonusGb.section,
        cOfficial.section,
        cOddsCh.section,
        cOddsGb.section,
        cBulkGb.section
      );

      // Eventek
      document.getElementById('matchForm').addEventListener('submit', onAddMatch);
    }

    /* ===== Tipp lead√°sok ‚Äì st√°tusz logika ===== */
    function _tsOf(t){ try{ return t?.updatedAt?.toMillis?.() || t?.createdAt?.toMillis?.() || t?.timestamp?.toMillis?.() || 0 }catch{ return 0 } }

    async function loadTipStatus(){
      const tbody = document.getElementById('tipStatusTbody');
      const meta  = document.getElementById('tipStatusMeta');
      if(!tbody) return;
      tbody.innerHTML = '<tr><td colspan="9" class="muted">Bet√∂lt√©s‚Ä¶</td></tr>';
      if(meta) meta.textContent = '';

      const now = new Date();

      // Felhaszn√°l√≥k
      const usersSnap = await getDocs(collection(db,'users'));
      const users = [];
      usersSnap.forEach(d=>{
        const u=d.data()||{};
        if(u.email) users.push({ email:u.email, nick:u.nickname||u.email });
      });
      users.sort((a,b)=> (a.nick||'').localeCompare(b.nick||'','hu'));

      // Akt√≠v meccsek
      const actSnap = await getDocs(query(collection(db,'ucl_matches'), where('startTime','>=', now)));
      const activeIds = new Set();
      actSnap.forEach(d=> activeIds.add(d.id));
      const activeCount = activeIds.size;

      // Eml√©keztet≈ë e-mailek sz√°ma subject alapj√°n
      const mailSnap = await getDocs(query(collection(db,'adminMailLog'), orderBy('sentAt','desc'), limit(300)));
      const remByEmail = new Map();
      mailSnap.forEach(d=>{
        const x = d.data()||{};
        const subj = (x.subject||'').toLowerCase();
        const isRem = subj.includes('eml√©keztet≈ë') || subj.includes('emlekezteto') || subj.includes('reminder');
        if(!isRem) return;
        const recips = Array.isArray(x.recipients) ? x.recipients : [];
        for(const r of recips){ if(r) remByEmail.set(r, (remByEmail.get(r)||0)+1); }
      });

      // Sorok fel√©p√≠t√©se
      const rows = [];
      for(const u of users){
        // Tippek: matchId szerint a legfrissebb
        const tipsSnap = await getDocs(query(collection(db,'ucl_tips'), where('user','==', u.email)));
        const latestByMatch = new Map();
        tipsSnap.forEach(docu=>{
          const t = docu.data()||{};
          const mid = t.matchId;
          if(!mid || !activeIds.has(mid)) return;
          const cur = latestByMatch.get(mid);
          if(!cur || _tsOf(t) >= _tsOf(cur)) latestByMatch.set(mid, t);
        });
        const tipped = latestByMatch.size;

        // Positions tippek (Top8/Champion/Golden)
        let hasTop8=false, hasCh=false, hasGb=false;
        try{ const top8 = await getDoc(doc(db,'ucl_top8Tips', u.email)); hasTop8 = top8.exists() && Array.isArray(top8.data().picks) && top8.data().picks.length===8 }catch{}
        try{ const ch = await getDoc(doc(db,'ucl_championPickTips', u.email)); hasCh = ch.exists() && !!(ch.data()||{}).team }catch{}
        try{ const gb = await getDoc(doc(db,'ucl_goldenBootTips', u.email)); hasGb = gb.exists() && !!(gb.data()||{}).player }catch{}

        rows.push({
          nick:u.nick, email:u.email,
          active:activeCount,
          tipped,
          doneAll: activeCount>0 && tipped===activeCount,
          hasTop8, hasCh, hasGb,
          rem: remByEmail.get(u.email)||0
        });
      }

      rows.sort((a,b)=>{
        if(a.doneAll!==b.doneAll) return a.doneAll ? -1 : 1;
        if(a.tipped!==b.tipped) return b.tipped - a.tipped;
        return (a.nick||'').localeCompare(b.nick||'','hu');
      });

      tbody.innerHTML = rows.map(r=>`
        <tr>
          <td><strong>${r.nick||''}</strong></td>
          <td class="muted">${r.email||''}</td>
          <td>${r.active}</td>
          <td>${r.tipped}</td>
          <td>${r.doneAll ? '‚úîÔ∏è' : '‚Äî'}</td>
          <td>${r.hasTop8 ? '‚úîÔ∏è' : '‚Äî'}</td>
          <td>${r.hasCh ? '‚úîÔ∏è' : '‚Äî'}</td>
          <td>${r.hasGb ? '‚úîÔ∏è' : '‚Äî'}</td>
          <td>${r.rem}</td>
        </tr>`).join('');

      if(meta) meta.textContent = `Akt√≠v meccsek: ${activeCount} ‚Ä¢ Felhaszn√°l√≥k: ${users.length}`;

      document.getElementById('reloadTipStatus')?.addEventListener('click', loadTipStatus);
    }

    /* ===== Meccsek hozz√°ad√°sa, kezel√©se, eredm√©nyek, users, bulk, odds, official, lock stb. ‚Äì a TE eredeti k√≥dod ===== */
    // --- A lenti r√©szek √©rintetlenek maradtak. ---

    async function onAddMatch(e){
      e.preventDefault();
      const homeTeam = document.getElementById('homeTeam').value;
      const awayTeam = document.getElementById('awayTeam').value;
      const startTime = document.getElementById('startTime').value;
      const roundId = parseInt(document.getElementById('roundId').value,10);
      const odds1 = parseFloat(document.getElementById('odds1').value);
      const oddsX = parseFloat(document.getElementById('oddsX').value);
      const odds2 = parseFloat(document.getElementById('odds2').value);
      if(!homeTeam || !awayTeam || !startTime || !roundId){ alert('Minden mez≈ë k√∂telez≈ë'); return; }
      await addDoc(collection(db,'ucl_matches'), {
        homeTeam, awayTeam, roundId,
        odds1, oddsX, odds2,
        startTime: Timestamp.fromDate(new Date(startTime)),
        createdAt: serverTimestamp()
      });
      alert('Meccs felv√©ve.');
      await loadMatches();
    }

    // ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ A TE EREDETI F√úGGV√âNYEID ITT FOLYTAT√ìDNAK (v√°ltozatlanul) ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶
    /* ===== Matches bet√∂lt√©s, filter UI, szerkeszt√©s/t√∂rl√©s ===== */
    let _matchesCache=[];
    async function loadMatches(){
      const container = document.getElementById('matchesList');
      if(!container) return;
      container.innerHTML = '';

      const snap = await getDocs(collection(db,'ucl_matches'));
      _matchesCache = [];
      const rounds = new Set();

      snap.forEach(docSnap=>{
        const d=docSnap.data();
        _matchesCache.push({ id:docSnap.id, ...d });
        if(d.roundId!=null) rounds.add(String(d.roundId));
      });

      const fr=document.getElementById('filterRound');
      if(fr) fr.innerHTML = '<option value="">√ñsszes fordul√≥</option>' + Array.from(rounds).sort((a,b)=>parseInt(a)-parseInt(b)).map(r=>`<option value="${r}">${r}</option>`).join('');

      renderMatchesFiltered();
    }

    function renderMatchesFiltered(){
      const container = document.getElementById('matchesList');
      if(!container) return;
      const r = document.getElementById('filterRound').value.trim();
      const q = (document.getElementById('filterTeam').value||'').toLowerCase();
      const list = _matchesCache.filter(m=> (!r || String(m.roundId)===r) && ((m.homeTeam||'').toLowerCase().includes(q) || (m.awayTeam||'').toLowerCase().includes(q)) );
      list.sort((a,b)=> (a.startTime?.seconds||0)-(b.startTime?.seconds||0));

      container.innerHTML = list.map(match=>{
        const start = match.startTime?.seconds ? new Date(match.startTime.seconds*1000).toLocaleString('hu-HU') : '';
        return `
          <div class="card">
            <div class="card-head"><h3>${match.homeTeam} ‚Äì ${match.awayTeam}</h3><div class="hint">Fordul√≥: ${match.roundId ?? ''} ‚Ä¢ ${start}</div></div>
            <div class="card-body">
              <div class="row">
                <label>Odds 1 <input class="o1" type="number" step="0.01" value="${match.odds1??''}"></label>
                <label>Odds X <input class="ox" type="number" step="0.01" value="${match.oddsX??''}"></label>
                <label>Odds 2 <input class="o2" type="number" step="0.01" value="${match.odds2??''}"></label>
                <button class="btn primary" onclick="updateMatch('${match.id}', this)">Ment√©s</button>
                <button class="btn danger" onclick="deleteMatch('${match.id}')">T√∂rl√©s</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    async function updateMatch(matchId, btn){
      const card = btn.closest('.card');
      const o1 = parseFloat(card.querySelector('.o1').value);
      const ox = parseFloat(card.querySelector('.ox').value);
      const o2 = parseFloat(card.querySelector('.o2').value);
      await setDoc(doc(db,'ucl_matches', matchId), { odds1:o1, oddsX:ox, odds2:o2 }, { merge:true });
      alert('Mentve.');
    }

    async function deleteMatch(matchId){
      if(!confirm('Biztosan t√∂rl√∂d a meccset?')) return;
      await deleteDoc(doc(db,'ucl_matches', matchId));
      await loadMatches();
    }

    /* ===== Felhaszn√°l√≥k ===== */
    async function loadUsers(){
      const list=document.getElementById('userList'); if(!list) return;
      list.innerHTML='';
      const snap=await getDocs(collection(db,'users'));
      snap.forEach(docSnap=>{
        const user=docSnap.data();
        const li=document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="card-head"><h3>${user.nickname||user.email}</h3><div class="hint">${user.email}</div></div>
          <div class="card-body">
            <div class="row">
              <select class="roleSel">
                <option value="user" ${user.role==='user'?'selected':''}>User</option>
                <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
              </select>
              <button class="btn primary save-role">Ment√©s</button>
              <button class="btn danger delete-user">T√∂rl√©s</button>
            </div>
          </div>`;
        li.querySelector('.card-head').onclick=()=>li.classList.toggle('open');
        const sel=li.querySelector('.roleSel');
        li.querySelector('.save-role').onclick=async ()=>{ await setDoc(doc(db,'users', user.email),{ role: sel.value },{merge:true}); alert('Szerepk√∂r friss√≠tve.') };
        li.querySelector('.delete-user').onclick=async ()=>{ if(confirm(`T√∂rl√∂d a felhaszn√°l√≥t?\\n${user.email}? Ez nem t√∂rli a bel√©p√©si fi√≥kot, csak a Firestore-b√≥l a user docot.`)){ await deleteDoc(doc(db,'users', user.email)); await loadUsers(); } };
        list.appendChild(li);
      });
    }

    /* ===== (A tov√°bbi eredeti moduljaid: eredm√©nyek, z√°r√°s, bonusz, official, odds el≈ën√©zet, bulk mail, napl√≥ stb.) ===== */
    // ... (v√°ltozatlan eredeti k√≥dod) ...

    /* ===== Window hooks ===== */
    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;
    window.saveLock = saveLock;
    window.clearLock = clearLock;
  </script>
</head>
<body></body>
</html>
