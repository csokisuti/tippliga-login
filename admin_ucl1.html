<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL Admin fel√ºlet</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-600:#1d4ed8;--danger:#ef4444;--border:#e5e7eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left{display:flex;gap:8px;align-items:center}
    .topbar .right{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}

    .cards{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;background:linear-gradient(180deg,#fff, #fafafa)}
    .card-head h3{margin:0;font-size:16px}
    .card-head .hint{color:var(--muted);font-size:12px}
    .card-body{display:none;padding:16px;border-top:1px solid var(--border)}
    .card.open .card-body{display:block}

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input[type="datetime-local"]{min-width:230px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f9fafb;color:#334155;font-weight:600}
    .muted{color:var(--muted)}
    .ok{color:#16a34a;font-weight:700}
    .warn{color:#b45309;font-weight:700}

    .filterbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;cursor:pointer}
    .chip.selected{outline:2px solid color-mix(in oklab, var(--primary) 35%, white)}
    .count{font-size:12px;color:#111;background:#e6f1ff;border:1px solid var(--border);padding:2px 8px;border-radius:999px}

    /* Odds ‚Üí % + Pont k√°rty√°k */
    .grid-odds{display:grid;grid-template-columns:280px 1fr;gap:14px}
    @media (max-width:900px){.grid-odds{grid-template-columns:1fr}}
    .panel{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    .panel h4{margin:0 0 10px}
    .help{font-size:12px;color:#64748b}
    .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .form-row label{min-width:110px;color:#475569;font-size:13px}
    .num{width:110px}
    .wide{width:160px}
    .sticky-bottom{display:flex;gap:8px;align-items:center;margin-top:10px}
    .tag{font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;background:#fafafa}
    .mono{font-variant-numeric:tabular-nums}
    .muted-note{font-size:12px;color:#64748b;margin-top:6px}

    /* +++ NB1 bulk mail st√≠lusok a BL adminhoz +++ */
    .small{font-size:12px}
    .inline{display:inline-flex;gap:8px;align-items:center}
    .xscroll{overflow:auto}
    details summary{cursor:pointer;color:#334155}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  
  .ucl-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .ucl-tabbtn{border:1px solid var(--line);background:rgba(255,255,255,.04);color:var(--text);padding:8px 10px;border-radius:12px;font-weight:700;font-size:13px;cursor:pointer}
  .ucl-tabbtn[aria-selected="true"]{box-shadow:0 0 0 2px rgba(59,130,246,.25) inset}
  .ucl-bracket-admin-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px}
  @media (max-width: 980px){.ucl-bracket-admin-grid{grid-template-columns:1fr}}
  .ucl-slot-admin{border:1px solid var(--line);border-radius:14px;background:rgba(255,255,255,.03);padding:12px;display:flex;flex-direction:column;gap:10px}
  .ucl-slot-admin h3{margin:0;font-size:14px}
  .ucl-row{display:flex;gap:10px;flex-wrap:wrap}
  .ucl-row .field{flex:1 1 160px;display:flex;flex-direction:column;gap:6px}
  .ucl-row label{font-size:12px;opacity:.8}
  .ucl-row input,.ucl-row select{width:100%}
  .ucl-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .ucl-mini{font-size:12px;opacity:.8}

</style>

  <script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, Timestamp, doc, updateDoc, deleteDoc, getDoc, setDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain:"tippliga-4b3af.firebaseapp.com", projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com", messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

  

  function uclBracketSlotDefs(){
    const defs=[];
    for(let i=1;i<=8;i++) defs.push({id:"PO"+i,round:"PO",label:"Play-off "+i,legs:2});
    for(let i=1;i<=8;i++) defs.push({id:"R16_"+i,round:"R16",label:"Nyolcadd√∂nt≈ë "+i,legs:2});
    for(let i=1;i<=4;i++) defs.push({id:"QF"+i,round:"QF",label:"Negyedd√∂nt≈ë "+i,legs:2});
    for(let i=1;i<=2;i++) defs.push({id:"SF"+i,round:"SF",label:"El≈ëd√∂nt≈ë "+i,legs:2});
    defs.push({id:"F1",round:"F",label:"D√∂nt≈ë",legs:1});
    return defs;
  }

  function normalizeTeam(t){ return (t||"").toString().trim(); }

  function formatStart(ts){
    try{
      if(!ts) return "";
      const d = ts.toDate ? ts.toDate() : (typeof ts==="number" ? new Date(ts) : new Date(ts));
      if(String(d)==="Invalid Date") return "";
      return d.toLocaleString("hu-HU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"});
    }catch(e){ return ""; }
  }

  async function loadKnockoutMatchesOptions(){
    const snap = await getDocs(collection(db,"ucl_matches"));
    const arr=[];
    snap.forEach(d=>{
      const m=d.data()||{};
      const rid = Number(m.roundId ?? m.round ?? 0);
      if(rid < 9) return;
      const home = normalizeTeam(m.homeTeam||m.home||"");
      const away = normalizeTeam(m.awayTeam||m.away||"");
      const st = formatStart(m.startTime||m.start||m.kickoff||m.date||"");
      const label = `${rid}. ${home} - ${away}${st?` ‚Ä¢ ${st}`:""}`;
      arr.push({id:d.id,label,ts:(m.startTime?.toMillis?m.startTime.toMillis():0)});
    });
    arr.sort((a,b)=>(b.ts||0)-(a.ts||0));
    return arr;
  }

  async function loadBracketDocs(){
    const ref = doc(db,"settings","ucl_bracket");
    const snap = await getDoc(ref);
    const data = snap.exists() ? (snap.data()||{}) : {};
    const slots = (data.slots && typeof data.slots==="object") ? data.slots : {};
    return slots;
  }

  function optionHtml(opts, selectedId){
    const s = selectedId || "";
    const rows = [`<option value="">‚Äî</option>`];
    opts.forEach(o=>{
      rows.push(`<option value="${o.id}" ${o.id===s?"selected":""}>${o.label}</option>`);
    });
    return rows.join("");
  }

  function slotCardHtml(def, docData, matchOpts){
    const d = docData || {};
    const home = d.homeTeam || "";
    const away = d.awayTeam || "";
    const matchIds = Array.isArray(d.matchIds) ? d.matchIds : [];
    const m1 = matchIds[0] || "";
    const m2 = matchIds[1] || "";
    const decided = !!d.decidedByPenalties;
    const pw = d.penaltyWinner || "";
    const hasLeg2 = def.legs===2;

    return `
      <div class="ucl-slot-admin" data-slot="${def.id}">
        <h3>${def.label}</h3>
        <div class="ucl-row">
          <div class="field">
            <label>Hazai csapat</label>
            <input type="text" value="${home.replaceAll('"',"&quot;")}" data-field="homeTeam" placeholder="pl. Real Madrid">
          </div>
          <div class="field">
            <label>Vend√©g csapat</label>
            <input type="text" value="${away.replaceAll('"',"&quot;")}" data-field="awayTeam" placeholder="pl. Manchester City">
          </div>
        </div>
        <div class="ucl-row">
          <div class="field">
            <label>Meccs 1 (roundId ‚â• 9)</label>
            <select data-field="match1">${optionHtml(matchOpts,m1)}</select>
          </div>
          ${hasLeg2?`
          <div class="field">
            <label>Meccs 2 (visszav√°g√≥)</label>
            <select data-field="match2">${optionHtml(matchOpts,m2)}</select>
          </div>
          `:""}
        </div>
        <div class="ucl-row">
          <div class="field" style="flex:0 0 auto;min-width:220px;">
            <label style="display:flex;gap:10px;align-items:center;user-select:none;">
              <input type="checkbox" data-field="decidedByPenalties" ${decided?"checked":""}>
              11-esekkel d≈ëlt el
            </label>
          </div>
          <div class="field" style="min-width:220px;">
            <label>11-es gy≈ëztes</label>
            <select data-field="penaltyWinner">
              <option value="" ${pw===""?"selected":""}>‚Äî</option>
              <option value="home" ${pw==="home"?"selected":""}>Hazai csapat jutott tov√°bb</option>
              <option value="away" ${pw==="away"?"selected":""}>Vend√©g csapat jutott tov√°bb</option>
            </select>
          </div>
        </div>
        <div class="ucl-actions">
          <span class="ucl-mini" data-status=""></span>
          <button class="btn" data-action="save">Ment√©s</button>
        </div>
      </div>
    `;
  }

  function renderBracketAdmin(roundKey, defs, docsById, matchOpts){
    const body = document.getElementById("uclBracketAdminBody");
    const status = document.getElementById("uclBracketAdminStatus");
    if(!body) return;
    const roundDefs = defs.filter(x=>x.round===roundKey);
    const grid = document.createElement("div");
    grid.className="ucl-bracket-admin-grid";
    grid.innerHTML = roundDefs.map(def=>slotCardHtml(def, docsById[def.id], matchOpts)).join("");
    body.innerHTML = "";
    body.appendChild(grid);
    if(status) status.textContent = `Szerkeszthet≈ë p√°rok: ${roundDefs.length} ‚Ä¢ Meccs opci√≥k: ${matchOpts.length}`;
  }

  async function saveSlot(slotId, el){
    const get = (sel)=>el.querySelector(sel);
    const home = normalizeTeam(get('input[data-field="homeTeam"]')?.value||"");
    const away = normalizeTeam(get('input[data-field="awayTeam"]')?.value||"");
    const m1 = get('select[data-field="match1"]')?.value||"";
    const m2 = get('select[data-field="match2"]')?.value||"";
    const decided = !!get('input[data-field="decidedByPenalties"]')?.checked;
    const pw = get('select[data-field="penaltyWinner"]')?.value||"";
    const matchIds = [m1,m2].filter(Boolean);
    const payload = { homeTeam:home, awayTeam:away, matchIds, decidedByPenalties:decided, penaltyWinner:pw, updatedAt: serverTimestamp() };
    await setDoc(doc(db,"settings","ucl_bracket"), { slots: { [slotId]: payload } }, { merge:true });
  }

  async function initBracketAdmin(){
    const defs = uclBracketSlotDefs();
    let currentRound = "PO";
    let matchOpts = [];
    let docsById = {};
    const tabs = document.getElementById("uclBracketTabs");
    const reloadBtn = document.getElementById("uclBracketReload");
    const status = document.getElementById("uclBracketAdminStatus");

    const loadAll = async ()=>{
      try{
        if(status) status.textContent = "Bet√∂lt√©s‚Ä¶";
        matchOpts = await loadKnockoutMatchesOptions();
        docsById = await loadBracketDocs();
        renderBracketAdmin(currentRound, defs, docsById, matchOpts);
      }catch(e){
        if(status) status.textContent = "Hiba a bet√∂lt√©sn√©l.";
      }
    };

    if(tabs){
      [...tabs.querySelectorAll(".ucl-tabbtn")].forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          currentRound = btn.dataset.round || "PO";
          [...tabs.querySelectorAll(".ucl-tabbtn")].forEach(b=>b.setAttribute("aria-selected", b===btn ? "true" : "false"));
          renderBracketAdmin(currentRound, defs, docsById, matchOpts);
        });
      });
    }

    if(reloadBtn) reloadBtn.addEventListener("click", loadAll);

    document.addEventListener("click", async (e)=>{
      const btn = e.target?.closest?.('button[data-action="save"]');
      if(!btn) return;
      const card = btn.closest(".ucl-slot-admin");
      const slotId = card?.dataset?.slot;
      const st = card?.querySelector('[data-status]');
      if(!slotId || !card) return;
      try{
        if(st) st.textContent = "Ment√©s‚Ä¶";
        await saveSlot(slotId, card);
        if(st) st.textContent = "Mentve.";
        docsById[slotId] = {
          homeTeam: normalizeTeam(card.querySelector('input[data-field="homeTeam"]')?.value||""),
          awayTeam: normalizeTeam(card.querySelector('input[data-field="awayTeam"]')?.value||""),
          matchIds: [card.querySelector('select[data-field="match1"]')?.value||"", card.querySelector('select[data-field="match2"]')?.value||""].filter(Boolean),
          decidedByPenalties: !!card.querySelector('input[data-field="decidedByPenalties"]')?.checked,
          penaltyWinner: card.querySelector('select[data-field="penaltyWinner"]')?.value||""
        };
      }catch(err){
        if(st) st.textContent = `Hiba ment√©skor: ${err?.code||""} ${err?.message||err}`.trim();
      }
    });

    await loadAll();
  }

async function loadUclBracketUiSettingAdmin() {
    const cb = document.getElementById('uclBracketOpenByDefault');
    const status = document.getElementById('uclBracketUiStatus');
    try {
      const uiRef = doc(db, "settings", "ucl_bracket_ui");
      const snap = await getDoc(uiRef);
      cb.checked = snap.exists() ? !!snap.data().openByDefault : false;
      if (status) status.textContent = "";
    } catch (e) {
      if (status) status.textContent = "Nem siker√ºlt bet√∂lteni a be√°ll√≠t√°st.";
    }
  }

  async function saveUclBracketUiSettingAdmin() {
    const cb = document.getElementById('uclBracketOpenByDefault');
    const status = document.getElementById('uclBracketUiStatus');
    try {
      const uiRef = doc(db, "settings", "ucl_bracket_ui");
      await setDoc(uiRef, { openByDefault: !!cb.checked, updatedAt: serverTimestamp() }, { merge: true });
      if (status) status.textContent = "Mentve.";
      setTimeout(()=>{ if(status) status.textContent=""; }, 2000);
    } catch (e) {
      if (status) status.textContent = "Ment√©s sikertelen.";
    }
  }


    /* >>> BULK MAIL ‚Äì GAS Web App URL (a te linked) <<< */
    const GS_BULKMAIL_URL = "https://script.google.com/macros/s/AKfycbzSmmexY18InfsYTHNdkVnbO1mzJ7Mol9PDNnk0x91KOTbLfPpwcZwsP7A94owxS5FovQ/exec";

    // UCL 36 csapat
    const teams = [
      "Ajax","Arsenal","Atalanta","Athletic Bilbao","Atl√©tico Madrid","Barcelona","Bayern M√ºnchen","Benfica","Borussia Dortmund","Bod√∏/Glimt","Club Bruges","Chelsea","FC K√∂benhavn","Eintracht Frankfurt","Galatasaray","Internazionale","Juventus","Bayer Leverkusen","Liverpool","Manchester City","Olympique Marseille","Monaco","Napoli","Newcastle United","Olympiakosz Pireusz","Pafosz","Paris Saint-Germain","PSV","Qarabag","Real Madrid","Slavia Praha","Sporting CP","Tottenham Hotspur","Union Saint-Gilloise","Villarreal","Kajrat Almati"
    ];

    // helpers
    function parseOutcome(r){ const p=r.split("-").map(x=>parseInt(x.trim())); if(p.length!==2||isNaN(p[0])||isNaN(p[1])) return ""; if(p[0]>p[1]) return "1"; if(p[0]<p[1]) return "2"; return "X" }
    const stripNumPrefix = s => (s||'').replace(/^\s*\d+[\.\)]?\s*/, '');
    const norm = s => stripNumPrefix(s).replace(/\s+/g,' ').trim().toLowerCase();
    const toNum = (v) => { if (v==null || v==='') return null; if (typeof v === 'string') v = v.replace(',', '.'); const n = Number(v); return Number.isFinite(n) ? n : null; };
    const fromCandidateOdds = (c) => { const direct = toNum(c?.odds); if (direct != null) return direct; const dec = toNum(c?.oddsDecimal); if (dec != null) return dec; const pct = toNum(c?.oddsPercent); if (pct != null && pct > 0) return 100 / pct; return null; };
    const fmtOdds = (v) => (v==null ? '' : toNum(v).toFixed(2));

    let championCandidates = [];
    let goldenCandidates   = [];
    let officialChampion = "";
    let officialGolden = { player:"", team:"" };

    /* === Bulk mail seg√©dek === */
    let _currentTplId = null;
    function esc(s){ return (s ?? '').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // glob√°lis hibafog√≥k
    window.onerror = (msg,src,lin,col,err)=>{ console.error('window.onerror',msg,src,lin,col,err); };
    window.onunhandledrejection = (ev)=>{ console.error('Unhandled promise rejection:', ev.reason||ev); };

    onAuthStateChanged(auth, async (user) => {
      if(!user){ document.body.innerHTML = "<h2 style='padding:20px'>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return }
      const userSnap = await getDoc(doc(db, "users", user.email));
      if(!userSnap.exists() || (userSnap.data().role !== "admin")){
        document.body.innerHTML = "<h2 style='padding:20px'>‚õî Nincs jogosults√°god az admin fel√ºlethez.</h2>"; return
      }
      initUI();
      await loadMatches();
      await loadUsers();
      await initBracketAdmin();
      await loadResults();
      await loadPositionsLock();
      await loadBonusMarkets();
      await loadOfficialBonus();
      await loadScoringSettings();
      // + bulk mail r√©szek:
      await loadTemplates();
      await loadMailLog();
      await loadTipStatus();

      renderChampionOddsPreview();
      renderGoldenOddsPreview();
    });

    function makeCard({title, hint, id, open=false, bodyHTML=''}) {
      const s=document.createElement('section'); s.className='card'; if(id) s.id=id; if(open) s.classList.add('open');
      const h=document.createElement('div'); h.className='card-head'; h.innerHTML = `<h3>${title}</h3><div class="hint">${hint||''}</div>`; h.onclick=()=>s.classList.toggle('open');
      const b=document.createElement('div'); b.className='card-body'; b.innerHTML=bodyHTML;
      s.append(h,b); return {section:s, body:b}
    }

    function initUI(){
      const top=document.createElement('div'); top.className='topbar';
      const left=document.createElement('div'); left.className='left';
      const right=document.createElement('div'); right.className='right';
      const back=document.createElement('button'); back.className='btn'; back.textContent='‚¨ÖÔ∏è Vissza a dashboardra'; back.onclick=()=>location.href='dashboard_ucl.html';
      const expand=document.createElement('button'); expand.className='btn'; expand.textContent='Mindet nyisd le'; expand.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.add('open'));
      const collapse=document.createElement('button'); collapse.className='btn'; collapse.textContent='Mindet csukd √∂ssze'; collapse.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.remove('open'));
      const refresh=document.createElement('button'); refresh.className='btn'; refresh.textContent='Friss√≠t√©s'; refresh.onclick=()=>{ loadMatches(); loadUsers(); loadResults(); loadPositionsLock(); loadBonusMarkets(); loadOfficialBonus(); renderChampionOddsPreview(); renderGoldenOddsPreview(); loadTemplates(); loadMailLog(); loadTipStatus(); };

      left.appendChild(back);
      right.append(expand, collapse, refresh);
      top.append(left, right);
      document.body.append(top);

      const wrap=document.createElement('div'); wrap.className='cards';

      const teamOpts = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
      const cAdd = makeCard({title:'√öj UCL meccs hozz√°ad√°sa', hint:'Gyors ≈±rlap', id:'card-add', bodyHTML:`
        <form id="matchForm">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${teamOpts}</select>
            <select id="awayTeam" required><option value="">Vend√©g csapat</option>${teamOpts}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Fordul√≥ / k√∂r ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn primary">Ment√©s</button>
          </div>
        </form>`});

      const cManage = makeCard({title:'Felt√∂lt√∂tt UCL meccsek', hint:'Sz≈±r√©s, gyors szerkeszt√©s', id:'card-manage', bodyHTML:`
        <div class="filterbar">
          <select id="filterRound"><option value="">√ñsszes fordul√≥</option></select>
          <input id="filterTeam" placeholder="Csapat sz≈±r√©s" />
          <button class="btn" id="applyFilters">Sz≈±r√©s</button>
          <button class="btn" id="resetFilters">T√∂rl√©s</button>
        </div>
        <div id="matchesList"></div>`});

      const cRes = makeCard({title:'UCL meccseredm√©nyek kezel√©se', hint:'Gyors be√≠r√°s', id:'card-results', bodyHTML:`
        <div class="card" style="margin:0 0 12px 0">
          <div class="card-head"><h3>üü° Eredm√©ny n√©lk√ºli meccsek</h3></div>
          <div class="card-body" id="noResultContent"></div>
        </div>
        <div class="card" style="margin:0">
          <div class="card-head" id="withResultHeader"><h3>üü¢ R√∂gz√≠tett eredm√©nyek</h3></div>
          <div class="card-body" id="withResultContent" style="display:block"></div>
        </div>`});

      const cUsers = makeCard({title:'Felhaszn√°l√≥k kezel√©se', hint:'Szerepk√∂r v√°lt√°s, t√∂rl√©s', id:'card-users', bodyHTML:`<ul id="userList" class="list" style="margin:0"></ul>`});

      /* üîí Poz√≠ci√≥s tipp lez√°r√°s (UCL) */
      const cLock = makeCard({
        title:'Poz√≠ci√≥s tipp lez√°r√°s (Top8 + Gy≈ëztes + G√≥lkir√°ly)',
        hint:'Azonnal vagy id≈ëpontra ‚Äì settings/positionsLock_ucl',
        id:'card-lock',
        bodyHTML:`
          <div class="muted">Itt szab√°lyozhat√≥ a BL poz√≠ci√≥s tippek (Top8), a v√©gs≈ë gy≈ëztes √©s a g√≥lkir√°ly m√≥dos√≠that√≥s√°ga.</div>
          <div class="row" style="margin-top:8px">
            <label><input type="checkbox" id="lockNow"> Azonnali lez√°r√°s</label>
            <span class="muted">vagy</span>
            <label>Automatikus z√°r√°s id≈ëpontja: <input type="datetime-local" id="lockUntil"></label>
          </div>
          <div class="row"><input type="text" id="lockMessage" placeholder="Opcion√°lis √ºzenet" style="flex:1;"></div>
          <div class="row">
            <button id="saveLock" class="btn primary">Lez√°r√°s be√°ll√≠t√°sa</button>
            <button id="clearLock" class="btn danger">Lez√°r√°s felold√°sa</button>
            <span id="lockStatus" class="muted"></span>
          </div>`
      });

      /* B√≥nusz piacok ‚Äì jel√∂ltek */
      const cBonusCh = makeCard({title:'B√≥nusz piacok ‚Äì V√©gs≈ë gy≈ëztes jel√∂ltek', hint:'`ucl_championCandidates` (odds: decim√°lis, pl. 2.00)', id:'card-bonus-ch', bodyHTML:`
        <form id="chAddForm">
          <div class="row">
            <select id="chAddTeam"><option value="">V√°lassz csapatot</option>${teamOpts}</select>
            <input type="text" id="chAddOdds" inputmode="decimal" placeholder="Odds (pl. 2.00)">
            <button class="btn primary" type="submit">Hozz√°ad√°s</button>
          </div>
          <div class="muted" style="margin-top:6px">Az odds decim√°lis form√°tum (pl. 2.00). R√©gi adatokn√°l, ha csak % volt, automatikusan √°tsz√°moljuk.</div>
        </form>
        <div style="margin-top:12px">
          <table id="chTable">
            <thead><tr><th>Csapat</th><th>Odds (dec)</th><th>M≈±velet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`});

      const cBonusGb = makeCard({title:'B√≥nusz piacok ‚Äì G√≥lkir√°ly jel√∂ltek', hint:'`ucl_goldenBootCandidates` (odds: decim√°lis, pl. 3.50)', id:'card-bonus-gb', bodyHTML:`
        <form id="gbAddForm">
          <div class="row">
            <input id="gbAddPlayer" placeholder="J√°t√©kos neve">
            <select id="gbAddTeam"><option value="">Klub (opcion√°lis)</option>${teamOpts}</select>
            <input type="text" id="gbAddOdds" inputmode="decimal" placeholder="Odds (pl. 3.50)">
            <button class="btn primary" type="submit">Hozz√°ad√°s</button>
          </div>
          <div class="muted" style="margin-top:6px">A klub opcion√°lis. Az odds decim√°lis; r√©gi % adatokb√≥l konvert√°lunk.</div>
        </form>
        <div style="margin-top:12px">
          <table id="gbTable">
            <thead><tr><th>J√°t√©kos</th><th>Klub</th><th>Odds (dec)</th><th>M≈±velet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`});

      /* Hivatalos eredm√©nyek ‚Äì Gy≈ëztes & G√≥lkir√°ly */
      const cOfficial = makeCard({
        title:'Hivatalos eredm√©nyek ‚Äì Gy≈ëztes / G√≥lkir√°ly',
        hint:'`ucl_official/current`',
        id:'card-official',
        bodyHTML: `
          <div class="card" style="margin:0 0 12px 0">
            <div class="card-head"><h3>V√©gs≈ë gy≈ëztes</h3></div>
            <div class="card-body">
              <div class="row">
                <select id="officialChampion"><option value="">V√°lassz csapatot</option>${teamOpts}</select>
                <button id="saveChampion" class="btn primary">Gy≈ëztes ment√©se</button>
                <button id="clearChampion" class="btn">Alaphelyzet</button>
              </div>
              <div class="muted" style="margin-top:6px">B√°rmely csapat kiv√°laszthat√≥ (nem k√∂t√∂tt a jel√∂ltekhez).</div>
            </div>
          </div>

          <div class="card" style="margin:0">
            <div class="card-head"><h3>G√≥lkir√°ly</h3></div>
            <div class="card-body">
              <div class="row">
                <select id="officialGoldenPlayer"><option value="">V√°lassz j√°t√©kost (jel√∂ltek)</option></select>
                <input id="officialGoldenTeam" placeholder="Klub (bet√∂ltve a jel√∂ltb≈ël)" readonly>
                <button id="saveGolden" class="btn primary">G√≥lkir√°ly ment√©se</button>
                <button id="clearGolden" class="btn">Alaphelyzet</button>
              </div>
              <div class="muted" style="margin-top:6px">A j√°t√©kost a jel√∂ltek k√∂z√ºl v√°laszd ki; a klub mez≈ë automatikusan kit√∂lt≈ëdik.</div>
            </div>
          </div>`
      });

      /* Odds ‚Üí % + pont ‚Äì V√âGS≈ê GY≈êZTES */
      const cOddsCh = makeCard({title:'V√©gs≈ë gy≈ëztes ‚Äì odds ‚Üí megjelen√≠tett % + pont', hint:'Jel√∂ltek normaliz√°l√°sa + favorit-lapos√≠t√°s (csak csapatokhoz)', id:'card-odds-ch', bodyHTML:`
        <div class="grid-odds">
          <div class="panel">
            <h4>Be√°ll√≠t√°s</h4>
            <div class="help">T ‚Äì h≈ëm√©rs√©klet a %-hoz (nagyobb = laposabb). A pontsz√°mhoz: BASE, O<sub>0</sub> (ahol 10 pont), A (g√∂rbe), LO/HI clamp.</div>
            <div class="form-row"><label>H≈ëm√©rs√©klet (T)</label><input id="T_CH" class="num" type="number" step="0.01" value="1.30"></div>
            <div class="form-row"><label>BASE</label><input id="BASE_CH" class="num" type="number" step="0.1" value="10"></div>
            <div class="form-row"><label>O<sub>0</sub> (pivot odds)</label><input id="PIVOT_CH" class="num" type="number" step="1" value="65"></div>
            <div class="form-row"><label>A (exponens)</label><input id="AEXP_CH" class="num" type="number" step="0.01" value="0.33"></div>
            <div class="form-row"><label>LO (min √óBASE)</label><input id="LO_CH" class="num" type="number" step="0.01" value="0.5"></div>
            <div class="form-row"><label>HI (max √óBASE)</label><input id="HI_CH" class="num" type="number" step="0.01" value="2.5"></div>
            <div class="sticky-bottom">
              <button id="recalc_CH" class="btn primary">Sz√°mold √∫jra & mentsd</button>
              <span class="tag">Implied = 1/odds</span><span class="tag">softmax p^(1/T)</span><span class="tag">clamp pont</span>
            </div>
            <div class="muted-note">L√©p√©sek: (1) Implied p = 1/odds ‚Üí normaliz√°l√°s, (2) p' = p^(1/T), (3) % = 100¬∑p', (4) pont = BASE¬∑clamp((odds/O0)^A, LO, HI).</div>
          </div>
          <div class="panel">
            <h4>El≈ën√©zet ‚Äì Bajnok jel√∂ltek</h4>
            <div class="help">Odds szerint n√∂vekv≈ë sorrend</div>
            <div style="overflow:auto">
              <table id="oddsPreview_CH">
                <thead><tr><th>Csapat</th><th>Odds (dec)</th><th>Implied % (raw)</th><th>Megjelen√≠tett %</th><th>Pont</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>`});

      /* Odds ‚Üí % + pont ‚Äì G√ìLKIR√ÅLY */
      const cOddsGb = makeCard({title:'G√≥lkir√°ly ‚Äì odds ‚Üí megjelen√≠tett % + pont', hint:'Ugyanaz az elv, k√ºl√∂n param√©terezve √©s k√ºl√∂n ment√©s a g√≥lkir√°ly jel√∂ltekre', id:'card-odds-gb', bodyHTML:`
        <div class="grid-odds">
          <div class="panel">
            <h4>Be√°ll√≠t√°s</h4>
            <div class="help">T ‚Äì h≈ëm√©rs√©klet; BASE, O<sub>0</sub>, A, LO/HI a pontokhoz (csak a g√≥lkir√°ly jel√∂ltekhez).</div>
            <div class="form-row"><label>H≈ëm√©rs√©klet (T)</label><input id="T_GB" class="num" type="number" step="0.01" value="1.30"></div>
            <div class="form-row"><label>BASE</label><input id="BASE_GB" class="num" type="number" step="0.1" value="10"></div>
            <div class="form-row"><label>O<sub>0</sub> (pivot odds)</label><input id="PIVOT_GB" class="num" type="number" step="1" value="65"></div>
            <div class="form-row"><label>A (exponens)</label><input id="AEXP_GB" class="num" type="number" step="0.01" value="0.33"></div>
            <div class="form-row"><label>LO (min √óBASE)</label><input id="LO_GB" class="num" type="number" step="0.01" value="0.5"></div>
            <div class="form-row"><label>HI (max √óBASE)</label><input id="HI_GB" class="num" type="number" step="0.01" value="2.5"></div>
            <div class="sticky-bottom">
              <button id="recalc_GB" class="btn primary">Sz√°mold √∫jra & mentsd</button>
              <span class="tag">Implied = 1/odds</span><span class="tag">softmax p^(1/T)</span><span class="tag">clamp pont</span>
            </div>
            <div class="muted-note">A gomb csak a g√≥lkir√°ly jel√∂ltek dokumentumait friss√≠ti.</div>
          </div>
          <div class="panel">
            <h4>El≈ën√©zet ‚Äì G√≥lkir√°ly jel√∂ltek</h4>
            <div class="help">Odds szerint n√∂vekv≈ë sorrend</div>
            <div style="overflow:auto">
              <table id="oddsPreview_GB">
                <thead><tr><th>J√°t√©kos</th><th>Klub</th><th>Odds (dec)</th><th>Implied % (raw)</th><th>Megjelen√≠tett %</th><th>Pont</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>`});

      /* T√∂meges import ‚Äì G√≥lkir√°ly jel√∂ltek */
      const cBulkGb = makeCard({
        title: 'T√∂meges import ‚Äì G√≥lkir√°ly jel√∂ltek',
        hint: 'Beilleszt√©s soronk√©nt (N√©v [Klub] Odds). Klubot az el≈ën√©zetben is v√°laszthatsz.',
        id: 'card-bulk-gb',
        bodyHTML: `
          <div class="row" style="gap:12px;">
            <textarea id="gbBulkText" placeholder="Pl.:
Erling Haaland [Manchester City] 6,75
Kylian Mbapp√© [Real Madrid] 7,75
Robert Lewandowski [Barcelona] 8,75" style="min-width:420px;min-height:140px;flex:1;"></textarea>
            <div style="display:flex;flex-direction:column;gap:8px;min-width:260px">
              <label><input type="checkbox" id="gbBulkWipe"> El≈ëtte √úR√çTSD a jel√∂lteket</label>
              <button id="gbBulkParse" class="btn">El≈ëk√©sz√≠t√©s</button>
              <button id="gbBulkUpload" class="btn primary" disabled>Felt√∂lt√©s Firestore-ba</button>
              <div class="muted">Rugalmas form√°tum: a sor v√©g√©n legyen az odds (pl. 16,50 vagy 16.50). Klub megadhat√≥ [sz√∂gletes]/(kerek) z√°r√≥jelben is.</div>
            </div>
          </div>
          <div id="gbBulkPreview" style="margin-top:12px; overflow:auto"></div>
        `
      });

      /* >>> √öJ: K√∂remail k√ºld√©se + sablonok (NB1-b≈ël √°temelve) <<< */
      const cBulk = makeCard({title:"K√∂remail k√ºld√©se + sablonok", hint:"C√≠mzettek kijel√∂l√©se, t√°rgy, √ºzenet, sablonkezel√©s", id:"card-bulkmail", bodyHTML:`
        <div class="row">
          <button class="btn" id="bulkLoadUsers">Felhaszn√°l√≥k bet√∂lt√©se</button>
          <label class="inline"><input type="checkbox" id="bulkSelectAll"> Mind kijel√∂l</label>
        </div>
        <div id="bulkUsersBox" style="max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:8px; margin:8px 0;"></div>

        <div class="row">
          <input id="bulkSubject" placeholder="T√°rgy" style="flex:1;">
        </div>
        <div class="row">
          <textarea id="bulkMessage" placeholder="HTML √ºzenet" rows="8" style="width:100%"></textarea>
        </div>

        <div class="row" style="gap:12px; align-items:center; border-top:1px dashed var(--border); padding-top:10px; margin-top:6px">
          <strong class="muted">Sablonok</strong>
          <select id="tplSelect" style="min-width:240px"><option value="">‚Äî V√°lassz sablont ‚Äî</option></select>
          <button class="btn" id="tplRefresh" title="Sablonok friss√≠t√©se">Friss√≠t</button>
          <button class="btn" id="tplLoad" title="Bet√∂lt√©s a szerkeszt≈ëbe">Bet√∂lt</button>
          <button class="btn" id="tplSaveAs" title="Jelenlegi tartalom ment√©se √∫j sablonk√©nt">Ment√©s √∫jk√©nt</button>
          <button class="btn" id="tplSave" title="Kijel√∂lt sablon fel√ºl√≠r√°sa a jelenlegi tartalommal">Fel√ºl√≠r√°s</button>
          <button class="btn danger" id="tplDelete" title="Kijel√∂lt sablon t√∂rl√©se">T√∂rl√©s</button>
          <span class="muted small" id="tplStatus"></span>
        </div>

        <div class="row">
          <button class="btn primary" id="bulkSendBtn">K√ºld√©s</button>
          <button class="btn" id="bulkPing" title="GAS webapp ellen≈ërz√©s (verzi√≥)">Ping</button>
          <span id="bulkInfo" class="muted small"></span>
        </div>`});

      const cLog = makeCard({title:"K√∂remail napl√≥", hint:"Utols√≥ 50 k√ºld√©s", id:"card-maillog", bodyHTML:`
        <div class="row">
          <button class="btn" id="logRefresh">Friss√≠t</button>
          <span class="muted small">Katt a sorra a r√©szletekhez ‚Ä¢ <span class="kbd">‚Ü© Bet√∂lt</span> gombbal visszat√∂ltheted a t√°rgy/√ºzenet mez≈ëkbe</span>
        </div>
        <div id="mailLogBox" class="xscroll"></div>`});
      /* >>> √öJ: Tipp lead√°sok ‚Äì st√°tusz (nem b√°nt semmi m√°st) <<< */
      const cTipStatus = makeCard({title:"Tipp lead√°sok ‚Äì st√°tusz", hint:"Akt√≠v meccsekre leadott tippek + poz√≠ci√≥s tippek + eml√©keztet≈ëk", id:"card-tipstatus", bodyHTML:`
        <div class="filterbar">
          <button class="btn" id="tipstatusRefresh">Friss√≠t</button>
          <span class="muted small" id="tipstatusInfo"></span>
        </div>
        <div id="tipstatusTable" class="xscroll"></div>
      `});


      document.body.append(wrap);
      wrap.append(
        cAdd.section, cManage.section, cRes.section, cUsers.section,
        cBulk.section, cLog.section, cTipStatus.section,  /* <<< √öJ k√°rty√°k itt */
        cLock.section,
        cBonusCh.section, cBonusGb.section,
        cOfficial.section,
        cOddsCh.section,
        cOddsGb.section,
        cBulkGb.section
      );

      // Eventek
      document.getElementById('matchForm').addEventListener('submit', onAddMatch);

      // --- NEW: startTime el≈ët√∂lt√©se az utolj√°ra haszn√°lt √©rt√©kkel (localStorage) ---
      try {
        const lastStart = localStorage.getItem('ucl_lastStartTime');
        if (lastStart) {
          const stEl = document.getElementById('startTime');
          if (stEl) stEl.value = lastStart; // pl. "2025-09-01T20:45"
        }
      } catch (err) {
        console.warn('lastStartTime read failed:', err);
      }
      // --- END NEW ---

      const wrh = document.getElementById('withResultHeader');
      if(wrh){ wrh.onclick=()=>{ const c=document.getElementById('withResultContent'); c.style.display = c.style.display==='none' ? 'block':'none'; }; }

      document.getElementById('applyFilters').onclick = renderMatchesFiltered;
      document.getElementById('resetFilters').onclick = ()=>{ document.getElementById('filterRound').value=''; document.getElementById('filterTeam').value=''; renderMatchesFiltered(); };

      const saveLockBtn = document.getElementById('saveLock');
      if(saveLockBtn) saveLockBtn.onclick = saveLock;
      const clearLockBtn = document.getElementById('clearLock');
      if(clearLockBtn) clearLockBtn.onclick = clearLock;

      // Jel√∂lt add-form handlerek
      document.getElementById('chAddForm').addEventListener('submit', window.onAddChampionCandidate);
      document.getElementById('gbAddForm').addEventListener('submit', window.onAddGoldenCandidate);

      // Hivatalos eredm√©nyek esem√©nyek
      document.getElementById('saveChampion').onclick = saveOfficialChampion;
      document.getElementById('saveGolden').onclick   = saveOfficialGolden;
      document.getElementById('clearChampion').onclick = clearOfficialChampion;
      document.getElementById('clearGolden').onclick   = clearOfficialGolden;

      // Kalkul√°tor esem√©nyek ‚Äì bajnok
      document.getElementById('recalc_CH').addEventListener('click', recalcAndSaveChampion);
      ['T_CH','BASE_CH','PIVOT_CH','AEXP_CH','LO_CH','HI_CH'].forEach(id=>{
        const el = document.getElementById(id); if(el) el.addEventListener('input', renderChampionOddsPreview);
      });

      // Kalkul√°tor esem√©nyek ‚Äì g√≥lkir√°ly
      document.getElementById('recalc_GB').addEventListener('click', recalcAndSaveGolden);
      ['T_GB','BASE_GB','PIVOT_GB','AEXP_GB','LO_GB','HI_GB'].forEach(id=>{
        const el = document.getElementById(id); if(el) el.addEventListener('input', renderGoldenOddsPreview);
      });

      // Bulk import events
      document.getElementById('gbBulkParse').addEventListener('click', bulkGbParse);
      document.getElementById('gbBulkUpload').addEventListener('click', bulkGbUpload);

      /* >>> Bulk mail esem√©nyek <<< */
      document.getElementById("bulkLoadUsers").onclick = bulkLoadUsers;
      document.getElementById("bulkSelectAll").onchange = (e)=>{ document.querySelectorAll("#bulkUsersBox input[type=checkbox]").forEach(cb=> cb.checked = e.target.checked) };
      document.getElementById("bulkSendBtn").onclick = bulkSend;
      document.getElementById("bulkPing").onclick = pingServer;

      document.getElementById("tplRefresh").onclick = loadTemplates;
      document.getElementById("tplLoad").onclick = loadTemplateIntoForm;
      document.getElementById("tplSaveAs").onclick = saveTemplateAs;
      document.getElementById("tplSave").onclick = saveTemplateUpdate;
      document.getElementById("tplDelete").onclick = deleteTemplate;

      document.getElementById("logRefresh").onclick = loadMailLog;
      document.getElementById('tipstatusRefresh').onclick = loadTipStatus;
    }

    /* ===== Meccsek ===== */
    let _matchesCache = [];
    async function loadMatches(){
      const container = document.getElementById('matchesList');
      if(!container) return;
      container.innerHTML = '';

      const snap = await getDocs(collection(db,'ucl_matches'));
      _matchesCache = [];
      const rounds = new Set();

      snap.forEach(docSnap=>{
        const d=docSnap.data();
        _matchesCache.push({ id:docSnap.id, ...d });
        if(d.roundId!=null) rounds.add(String(d.roundId));
      });

      const fr=document.getElementById('filterRound');
      if(fr) fr.innerHTML = '<option value="">√ñsszes fordul√≥</option>' + Array.from(rounds).sort((a,b)=>parseInt(a)-parseInt(b)).map(r=>`<option value="${r}">${r}</option>`).join('');

      renderMatchesFiltered();
    }

    function renderMatchesFiltered(){
      const container = document.getElementById('matchesList');
      if(!container) return;
      const r = document.getElementById('filterRound').value.trim();
      const q = (document.getElementById('filterTeam').value||'').toLowerCase();
      const list = _matchesCache.filter(m=> (!r || String(m.roundId)===r) && (!q || (m.homeTeam||'').toLowerCase().includes(q) || (m.awayTeam||'').toLowerCase().includes(q)) );
      renderMatches(list);
    }

    function renderMatches(list){
      const container = document.getElementById('matchesList');
      if(!container) return;
      container.innerHTML = '';
      if(list.length===0){ container.innerHTML = '<div class="muted">Nincs tal√°lat.</div>'; return }

      list.sort((a,b)=>{
        const ra = (parseInt(a.roundId||0) - parseInt(b.roundId||0)); if(ra) return ra;
        const ta = (a.startTime?.toDate?.()||new Date(0)) - (b.startTime?.toDate?.()||new Date(0)); return ta;
      });

      const dataList = document.createElement('datalist');
      dataList.id = 'teamsList';
      dataList.innerHTML = teams.map(t=>`<option value="${t}">`).join('');
      container.appendChild(dataList);

      list.forEach(d=>{
        const div=document.createElement('div');
        div.className='card';
        const iso = d.startTime?.toDate ? new Date(d.startTime.toDate()).toISOString().slice(0,16) : new Date(d.startTime).toISOString().slice(0,16);
        div.innerHTML = `
          <div class="card-head"><h3>${d.roundId||''}. fordul√≥ ‚Äì ${d.homeTeam||''} vs ${d.awayTeam||''}</h3><div class="hint">${d.startTime?.toDate?.()?.toLocaleString('hu-HU')||''}</div></div>
          <div class="card-body">
            <div class="row">
              <input list="teamsList" value="${d.homeTeam||''}" id="home-${d.id}">
              <input list="teamsList" value="${d.awayTeam||''}" id="away-${d.id}">
              <input type="datetime-local" value="${iso}" id="start-${d.id}">
              <input value="${d.roundId||''}" id="round-${d.id}">
              <input value="${d.odds?.["1"]??''}" id="odds1-${d.id}" placeholder="Odds 1" style="width:90px">
              <input value="${d.odds?.["X"]??''}" id="oddsX-${d.id}" placeholder="Odds X" style="width:90px">
              <input value="${d.odds?.["2"]??''}" id="odds2-${d.id}" placeholder="Odds 2" style="width:90px">
              <button class="btn primary" onclick="updateMatch('${d.id}')">Ment√©s</button>
              <button class="btn danger" onclick="deleteMatch('${d.id}')">T√∂rl√©s</button>
            </div>
          </div>`;
        div.querySelector('.card-head').onclick = ()=> div.classList.toggle('open');
        container.appendChild(div);
      });
    }

    async function updateMatch(id){
      const ref = doc(db,'ucl_matches',id);
      await updateDoc(ref,{
        homeTeam: document.getElementById(`home-${id}`).value,
        awayTeam: document.getElementById(`away-${id}`).value,
        startTime: Timestamp.fromDate(new Date(document.getElementById(`start-${id}`).value)),
        roundId: document.getElementById(`round-${id}`).value,
        odds: {
          "1": parseFloat(document.getElementById(`odds1-${id}`).value),
          "X": parseFloat(document.getElementById(`oddsX-${id}`).value),
          "2": parseFloat(document.getElementById(`odds2-${id}`).value)
        }
      });
      alert('Mentve');
      await loadMatches();
      await loadResults();
    }

    async function deleteMatch(id){
      if(!confirm('Biztos t√∂r√∂lni akarod?')) return;
      await deleteDoc(doc(db,'ucl_matches',id));
      await loadMatches();
      await loadResults();
    }

    async function onAddMatch(e){
      e.preventDefault();

      // --- NEW: ments√ºk el a legut√≥bbi startTime √©rt√©ket (datetime-local form√°tum) ---
      const startStr = document.getElementById('startTime').value; // pl. "2025-09-01T20:45"
      try { localStorage.setItem('ucl_lastStartTime', startStr); } catch (err) { console.warn('lastStartTime save failed:', err); }
      // --- END NEW ---

      const startTime = Timestamp.fromDate(new Date(startStr));
      const home = document.getElementById('homeTeam').value;
      const away = document.getElementById('awayTeam').value;
      const round = document.getElementById('roundId').value;
      const o1 = parseFloat(document.getElementById('odds1').value);
      const oX = parseFloat(document.getElementById('oddsX').value);
      const o2 = parseFloat(document.getElementById('odds2').value);

      await addDoc(collection(db,'ucl_matches'),{
        homeTeam: home,
        awayTeam: away,
        startTime,
        roundId: round,
        odds: {"1":o1,"X":oX,"2":o2}
      });
      alert('UCL meccs mentve');
      e.target.reset();

      // --- NEW: reset ut√°n vissza√≠rjuk ugyanazt az id≈ëpontot a k√∂vetkez≈ë felvitelhez ---
      try {
        const stEl = document.getElementById('startTime');
        if (stEl) stEl.value = startStr;
      } catch (err) { /* no-op */ }
      // --- END NEW ---

      await loadMatches();
      await loadResults();
    }

    /* ===== Eredm√©nyek k√°rtya ===== */
    async function loadResults(){
      const noC=document.getElementById('noResultContent');
      const withC=document.getElementById('withResultContent');
      if(!noC || !withC) return;
      noC.innerHTML=''; withC.innerHTML='';

      const snap = await getDocs(collection(db,'ucl_matches'));
      const no=[], yes=[];
      snap.forEach(docSnap=>{ const d=docSnap.data(); const m={ id:docSnap.id, ...d }; if(d.result) yes.push(m); else no.push(m) });
      renderMatchGroup(no, noC, false);
      renderMatchGroup(yes, withC, true);
    }

    function renderMatchGroup(matches, container, hasResult){
      const grouped={};
      matches.forEach(m=>{ const r=m.roundId||'Egy√©b'; (grouped[r]||(grouped[r]=[])).push(m) });
      Object.keys(grouped).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(r=>{
        const title=document.createElement('h4'); title.textContent = `${r}. fordul√≥`; container.appendChild(title);
        grouped[r].forEach(match=>{
          const div=document.createElement('div'); div.className='card';
          div.innerHTML = `
            <div class="card-head"><h3>${match.homeTeam} - ${match.awayTeam}</h3><div class="hint">${match.startTime?.toDate?.()?.toLocaleString('hu-HU')||''}</div></div>
            <div class="card-body">
              <div class="row">
                <input placeholder="pl. 2-1" value="${match.result||''}" id="res-${match.id}" style="width:80px">
                <button class="btn primary" id="btn-${match.id}">${hasResult? 'M√≥dos√≠t√°s':'Ment√©s'}</button>
              </div>
            </div>`;
          div.querySelector('.card-head').onclick = ()=> div.classList.toggle('open');
          div.querySelector(`#btn-${match.id}`).onclick = async ()=>{
            const v=document.getElementById(`res-${match.id}`).value.trim();
            const oc=parseOutcome(v); if(!oc){ alert('Hib√°s form√°tum. pl. 3-1 vagy 1-1'); return }
            await updateDoc(doc(db,'ucl_matches',match.id),{ result:v, outcome:oc });
            await loadResults();
          };
          container.appendChild(div);
        });
      });
    }

    /* ===== Felhaszn√°l√≥k ===== */
    async function loadUsers(){
      const list=document.getElementById('userList'); if(!list) return;
      list.innerHTML='';
      const snap=await getDocs(collection(db,'users'));
      snap.forEach(docSnap=>{
        const user=docSnap.data();
        const li=document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="card-head"><h3>${user.nickname||user.email}</h3><div class="hint">${user.email}</div></div>
          <div class="card-body">
            <div class="row">
              <select class="roleSel">
                <option value="user" ${user.role==='user'?'selected':''}>User</option>
                <option value="admin" ${user.role==='admin'?'selected':''}>Admin</option>
              </select>
              <button class="btn primary save-role">Ment√©s</button>
              <button class="btn danger delete-user">T√∂rl√©s</button>
            </div>
          </div>`;
        li.querySelector('.card-head').onclick=()=>li.classList.toggle('open');
        const sel=li.querySelector('.roleSel');
        li.querySelector('.save-role').onclick=async ()=>{ await updateDoc(doc(db,'users',user.email),{ role: sel.value }); alert('Szerepk√∂r friss√≠tve.') };
        li.querySelector('.delete-user').onclick=async ()=>{ if(!confirm(`T√∂rl√∂d: ${user.email}? Ez nem t√∂rli a bel√©p√©si fi√≥kot, csak a Firestore-b√≥l.`)) return; await deleteDoc(doc(db,'users',user.email)); await loadUsers() };
        list.appendChild(li);
      });
    }

    /* ===== Lez√°r√°s (Top8/bonus) UCL ===== */
    async function loadPositionsLock(){
      const status=document.getElementById('lockStatus'); if(!status) return;
      const snap=await getDoc(doc(db,'settings','positionsLock_ucl'));
      if(!snap.exists()){ status.textContent='Jelenleg nyitva.'; status.className='muted'; return }
      const d=snap.data()||{}; const isLocked=!!d.isLocked; const until=d.lockUntil?.toDate?.()||null; const msg=d.message||''; const now=new Date(); const timeLocked=until && now>=until;
      if(isLocked || timeLocked){ status.textContent = `Z√ÅRVA ${timeLocked&&until?`(hat√°rid≈ë: ${until.toLocaleString('hu-HU')})`:'(azonnali z√°r√°s)'}${msg?` ‚Äì ${msg}`:''}`; status.className='warn' } else { status.textContent='Jelenleg nyitva.'; status.className='ok' }
    }
    async function saveLock(){
      const lockNow=document.getElementById('lockNow')?.checked; const untilStr=document.getElementById('lockUntil')?.value; const message=document.getElementById('lockMessage')?.value?.trim()||'';
      let docObj={ isLocked:!!lockNow, message: message||'' };
      if(untilStr){ const dt=new Date(untilStr); if(isNaN(+dt)) return alert('Hib√°s d√°tum/id≈ë.'); docObj.lockUntil = Timestamp.fromDate(dt) } else { docObj.lockUntil = null }
      await setDoc(doc(db,'settings','positionsLock_ucl'), docObj);
      alert('Lez√°r√°s be√°ll√≠tva.');
      await loadPositionsLock();
    }
    async function clearLock(){ await setDoc(doc(db,'settings','positionsLock_ucl'),{ isLocked:false, lockUntil:null, message:'' }); alert('Lez√°r√°s feloldva.'); await loadPositionsLock(); }

    /* ===== B√≥nusz piacok (jel√∂ltek list√°k) ===== */
    async function loadBonusMarkets(){
      const cSnap = await getDocs(collection(db,'ucl_championCandidates'));
      championCandidates = cSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) })).filter(x=>x.team);
      renderChampionCandidates();

      const gSnap = await getDocs(collection(db,'ucl_goldenBootCandidates'));
      goldenCandidates = gSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) })).filter(x=>x.player);
      renderGoldenCandidates();

      // G√≥lkir√°ly szekci√≥ leg√∂rd√ºl≈ë felt√∂lt√©se
      const sel = document.getElementById('officialGoldenPlayer');
      if(sel){
        sel.innerHTML = '<option value="">V√°lassz j√°t√©kost (jel√∂ltek)</option>' + goldenCandidates.map(c=>`<option value="${c.player}" data-team="${c.team||''}">${c.player}${c.team?` (${c.team})`:''}</option>`).join('');
        sel.onchange = ()=>{
          const teamInput = document.getElementById('officialGoldenTeam');
          const opt = sel.options[sel.selectedIndex];
          teamInput.value = opt?.dataset?.team || '';
        };
      }

      renderChampionOddsPreview();
      renderGoldenOddsPreview();
    }

    function renderChampionCandidates(){
      const tbody=document.querySelector('#chTable tbody'); if(!tbody) return;
      tbody.innerHTML='';
      championCandidates.sort((a,b)=>{
        const oa = fromCandidateOdds(a) ?? Number.POSITIVE_INFINITY;
        const ob = fromCandidateOdds(b) ?? Number.POSITIVE_INFINITY;
        if(oa===ob){
          return norm(a.team).localeCompare(norm(b.team),'hu');
        }
        return oa - ob;
      });
      championCandidates.forEach(c=>{
        const currentOdds = fromCandidateOdds(c);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>
            <select id="ch-team-${c.id}">
              ${teams.map(t=>`<option value="${t}" ${t===c.team?'selected':''}>${t}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" id="ch-odds-${c.id}" value="${fmtOdds(currentOdds)}" placeholder="pl. 2.00" style="width:120px"></td>
          <td>
            <button class="btn primary" data-act="save" data-id="${c.id}">Ment√©s</button>
            <button class="btn danger" data-act="del" data-id="${c.id}">T√∂rl√©s</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const id=btn.dataset.id;
          if(btn.dataset.act==='save'){
            const team = document.getElementById(`ch-team-${id}`).value;
            const oddsDec = toNum(document.getElementById(`ch-odds-${id}`).value);
            if(!team) return alert('V√°lassz csapatot!');
            if(oddsDec==null || oddsDec<=0) return alert('Adj meg √©rv√©nyes decim√°lis oddsot (pl. 2.00)!');
            const dup = championCandidates.find(x=>x.id!==id && norm(x.team)===norm(team));
            if(dup) return alert('M√°r van ilyen csapat a jel√∂ltek k√∂z√∂tt.');
            await updateDoc(doc(db,'ucl_championCandidates',id),{
              team,
              odds: oddsDec,
              oddsDecimal: oddsDec,
              oddsPercent: Math.round(100/oddsDec)
            });
            await loadBonusMarkets();
          } else if(btn.dataset.act==='del'){
            if(!confirm('T√∂rl√∂d a jel√∂ltet?')) return;
            await deleteDoc(doc(db,'ucl_championCandidates',id));
            await loadBonusMarkets();
          }
        };
      });
    }

    // glob√°lis add-form handlerek
    window.onAddChampionCandidate = async function onAddChampionCandidate(e){
      e.preventDefault();
      const teamSel = document.getElementById('chAddTeam');
      const oddsInp = document.getElementById('chAddOdds');
      const team = teamSel.value;
      const oddsDec = toNum(oddsInp.value);
      if(!team) return alert('V√°lassz csapatot!');
      if(oddsDec==null || oddsDec<=0) return alert('Adj meg √©rv√©nyes decim√°lis oddsot (pl. 2.00)!');
      if(championCandidates.some(c=>norm(c.team)===norm(team))) return alert('Ez a csapat m√°r szerepel a jel√∂ltek k√∂z√∂tt.');
      await addDoc(collection(db,'ucl_championCandidates'),{
        team,
        odds: oddsDec,
        oddsDecimal: oddsDec,
        oddsPercent: Math.round(100/oddsDec)
      });
      teamSel.value=''; oddsInp.value='';
      await loadBonusMarkets();
    };

    function renderGoldenCandidates(){
      const tbody=document.querySelector('#gbTable tbody'); if(!tbody) return;
      tbody.innerHTML='';
      goldenCandidates.sort((a,b)=>{
        const oa = fromCandidateOdds(a) ?? Number.POSITIVE_INFINITY;
        const ob = fromCandidateOdds(b) ?? Number.POSITIVE_INFINITY;
        if(oa===ob){
          return norm(a.player).localeCompare(norm(b.player),'hu');
        }
        return oa - ob;
      });
      goldenCandidates.forEach(c=>{
        const currentOdds = fromCandidateOdds(c);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input id="gb-player-${c.id}" value="${c.player}"></td>
          <td>
            <select id="gb-team-${c.id}">
              <option value="">‚Äì</option>
              ${teams.map(t=>`<option value="${t}" ${t===(c.team||'')?'selected':''}>${t}</option>`).join('')}
            </select>
          </td>
          <td><input type="text" id="gb-odds-${c.id}" value="${fmtOdds(currentOdds)}" placeholder="pl. 3.50" style="width:120px"></td>
          <td>
            <button class="btn primary" data-act="save" data-id="${c.id}">Ment√©s</button>
            <button class="btn danger" data-act="del" data-id="${c.id}">T√∂rl√©s</button>
          </td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const id=btn.dataset.id;
          if(btn.dataset.act==='save'){
            const player = document.getElementById(`gb-player-${id}`).value.trim();
            const team = document.getElementById(`gb-team-${id}`).value || '';
            const oddsDec = toNum(document.getElementById(`gb-odds-${id}`).value);
            if(!player) return alert('A j√°t√©kos neve k√∂telez≈ë.');
            if(oddsDec==null || oddsDec<=0) return alert('Adj meg √©rv√©nyes decim√°lis oddsot (pl. 3.50)!');
            const dup = goldenCandidates.find(x=>x.id!==id && norm(x.player)===norm(player));
            if(dup) return alert('Ez a j√°t√©kos m√°r szerepel a jel√∂ltek k√∂z√∂tt.');
            await updateDoc(doc(db,'ucl_goldenBootCandidates',id),{
              player, team,
              odds: oddsDec,
              oddsDecimal: oddsDec,
              oddsPercent: Math.round(100/oddsDec)
            });
            await loadBonusMarkets();
          } else if(btn.dataset.act==='del'){
            if(!confirm('T√∂rl√∂d a jel√∂ltet?')) return;
            await deleteDoc(doc(db,'ucl_goldenBootCandidates',id));
            await loadBonusMarkets();
          }
        };
      });
    }

    window.onAddGoldenCandidate = async function onAddGoldenCandidate(e){
      e.preventDefault();
      const player = document.getElementById('gbAddPlayer').value.trim();
      const team = document.getElementById('gbAddTeam').value || '';
      const oddsDec = toNum(document.getElementById('gbAddOdds').value);
      if(!player) return alert('√çrd be a j√°t√©kos nev√©t!');
      if(oddsDec==null || oddsDec<=0) return alert('Adj meg √©rv√©nyes decim√°lis oddsot (pl. 3.50)!');
      if(goldenCandidates.some(c=>norm(c.player)===norm(player))) return alert('Ez a j√°t√©kos m√°r szerepel a jel√∂ltek k√∂z√∂tt.');
      await addDoc(collection(db,'ucl_goldenBootCandidates'),{
        player, team,
        odds: oddsDec,
        oddsDecimal: oddsDec,
        oddsPercent: Math.round(100/oddsDec)
      });
      document.getElementById('gbAddPlayer').value='';
      document.getElementById('gbAddTeam').value='';
      document.getElementById('gbAddOdds').value='';
      await loadBonusMarkets();
    };

    /* ===== Hivatalos b√≥nuszok ===== */
    async function loadOfficialBonus(){
      const ref=doc(db,'ucl_official','current');
      const snap=await getDoc(ref);
      if(snap.exists()){
        const d=snap.data()||{};
        officialChampion = teams.includes(d.champion)? d.champion : "";
        officialGolden = d.goldenBoot && d.goldenBoot.player ? { player:d.goldenBoot.player, team:d.goldenBoot.team||"" } : { player:"", team:"" };
      }else{
        officialChampion = "";
        officialGolden = { player:"", team:"" };
      }
      const chSel = document.getElementById('officialChampion'); if(chSel) chSel.value = officialChampion || "";
      const gbSel = document.getElementById('officialGoldenPlayer'); if(gbSel) {
        gbSel.value = officialGolden.player || "";
        const opt = gbSel.options[gbSel.selectedIndex];
        document.getElementById('officialGoldenTeam').value = opt?.dataset?.team || officialGolden.team || "";
      }
    }
    async function saveOfficialChampion(){
      const val = document.getElementById('officialChampion').value || "";
      if(!val) return alert('V√°lassz csapatot!');
      await setDoc(doc(db,'ucl_official','current'),{ champion: val },{ merge:true });
      officialChampion = val;
      alert('Gy≈ëztes elmentve.');
    }
    async function clearOfficialChampion(){
      await setDoc(doc(db,'ucl_official','current'), { champion: "" }, { merge:true });
      officialChampion = "";
      const chSel = document.getElementById('officialChampion');
      if (chSel) chSel.value = "";
      alert('V√©gs≈ë gy≈ëztes t√∂r√∂lve.');
    }
    async function saveOfficialGolden(){
      const playerSel = document.getElementById('officialGoldenPlayer');
      const player = playerSel.value || "";
      if(!player) return alert('V√°lassz j√°t√©kost!');
      const team = playerSel.options[playerSel.selectedIndex]?.dataset?.team || "";
      await setDoc(doc(db,'ucl_official','current'),{ goldenBoot: { player, team } },{ merge:true });
      officialGolden = { player, team };
      document.getElementById('officialGoldenTeam').value = team;
      alert('G√≥lkir√°ly elmentve.');
    }
    async function clearOfficialGolden(){
      await setDoc(doc(db,'ucl_official','current'), { goldenBoot: null }, { merge:true });
      officialGolden = { player:"", team:"" };
      const gpSel = document.getElementById('officialGoldenPlayer');
      const teamInp = document.getElementById('officialGoldenTeam');
      if (gpSel) gpSel.value = "";
      if (teamInp) teamInp.value = "";
      alert('G√≥lkir√°ly t√∂r√∂lve.');
    }

    /* ===== Odds ‚Üí % + Pont k√∂z√∂s logika ===== */
    function computeDisplayedPerc(rows, T){
      const ps = rows.map(r=>{
        const o = toNum(r.odds);
        return (o && o>0) ? (1/o) : 0;
      });
      let S = ps.reduce((a,b)=>a+b,0); if(!S) S=1;
      const p = ps.map(x => x/S);
      const q = p.map(x => Math.pow(x, 1/Math.max(T, 0.0001)));
      let Z = q.reduce((a,b)=>a+b,0); if(!Z) Z=1;
      return q.map(x => 100 * x / Z);
    }
    function computePoints(odds, BASE, O0, A, LO, HI){
      const o = toNum(odds); if(!o || o<=0) return 0;
      const ratio = Math.pow(o/Math.max(O0,1e-9), A);
      const clamped = Math.min(Math.max(ratio, LO), HI);
      return BASE * clamped;
    }

    async function loadScoringSettings(){}

    // CH kalkul√°tor
    function paramsCH(){
      return {
        T:   toNum(document.getElementById('T_CH').value)    ?? 1.30,
        BASE:toNum(document.getElementById('BASE_CH').value) ?? 10,
        O0:  toNum(document.getElementById('PIVOT_CH').value)?? 65,
        A:   toNum(document.getElementById('AEXP_CH').value) ?? 0.33,
        LO:  toNum(document.getElementById('LO_CH').value)   ?? 0.5,
        HI:  toNum(document.getElementById('HI_CH').value)   ?? 2.5,
      };
    }
    function renderChampionOddsPreview(){
      const tbody = document.querySelector('#oddsPreview_CH tbody'); if(!tbody) return;
      tbody.innerHTML='';
      const baseRows = championCandidates.map(c=>({ label:c.team, odds: fromCandidateOdds(c) })).filter(r=>r.odds);
      if(baseRows.length===0){ tbody.innerHTML = '<tr><td colspan="5" class="muted">Nincs jel√∂lt</td></tr>'; return; }
      const {T, BASE, O0, A, LO, HI} = paramsCH();
      const shown = computeDisplayedPerc(baseRows, T);
      const items = baseRows.map((r,idx)=>({
        label: r.label,
        odds: r.odds,
        implied: 100/r.odds,
        shown: shown[idx],
        points: computePoints(r.odds, BASE, O0, A, LO, HI)
      }));
      items.sort((a,b)=>a.odds - b.odds);
      items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.label}</td>
          <td class="mono">${fmtOdds(it.odds)}</td>
          <td class="mono">${it.implied.toFixed(1)}%</td>
          <td class="mono"><strong>${it.shown.toFixed(1)}%</strong></td>
          <td class="mono">${it.points.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }
    async function recalcAndSaveChampion(){
      const {T, BASE, O0, A, LO, HI} = paramsCH();
      const rows = championCandidates.map(c=>({ id:c.id, odds: fromCandidateOdds(c) })).filter(r=>r.odds);
      if(rows.length>0){
        const shown = computeDisplayedPerc(rows, T);
        for(let i=0;i<rows.length;i++){
          const r = rows[i];
          const displayPercent = Number(shown[i].toFixed(1));
          const displayPoints  = Number(computePoints(r.odds, BASE, O0, A, LO, HI).toFixed(1));
          await updateDoc(doc(db,'ucl_championCandidates', r.id), {
            displayPercent,
            displayPoints,
            _calc: { scope:'champion', T, BASE, O0, A, LO, HI, updated: Date.now() }
          });
        }
      }
      alert('Bajnok jel√∂ltek friss√≠tve.');
      renderChampionOddsPreview();
    }

    // GB kalkul√°tor
    function paramsGB(){
      return {
        T:   toNum(document.getElementById('T_GB').value)    ?? 1.30,
        BASE:toNum(document.getElementById('BASE_GB').value) ?? 10,
        O0:  toNum(document.getElementById('PIVOT_GB').value)?? 65,
        A:   toNum(document.getElementById('AEXP_GB').value) ?? 0.33,
        LO:  toNum(document.getElementById('LO_GB').value)   ?? 0.5,
        HI:  toNum(document.getElementById('HI_GB').value)   ?? 2.5,
      };
    }
    function renderGoldenOddsPreview(){
      const tbody = document.querySelector('#oddsPreview_GB tbody'); if(!tbody) return;
      tbody.innerHTML='';
      const baseRows = goldenCandidates.map(c=>({ label:c.player, team:c.team||'', odds: fromCandidateOdds(c) })).filter(r=>r.odds);
      if(baseRows.length===0){ tbody.innerHTML = '<tr><td colspan="6" class="muted">Nincs jel√∂lt</td></tr>'; return; }
      const {T, BASE, O0, A, LO, HI} = paramsGB();
      const shown = computeDisplayedPerc(baseRows, T);
      const items = baseRows.map((r,idx)=>({
        label: r.label,
        team: r.team||'‚Äì',
        odds: r.odds,
        implied: 100/r.odds,
        shown: shown[idx],
        points: computePoints(r.odds, BASE, O0, A, LO, HI)
      }));
      items.sort((a,b)=>a.odds - b.odds);
      items.forEach(it=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${it.label}</td>
          <td>${it.team}</td>
          <td class="mono">${fmtOdds(it.odds)}</td>
          <td class="mono">${it.implied.toFixed(1)}%</td>
          <td class="mono"><strong>${it.shown.toFixed(1)}%</strong></td>
          <td class="mono">${it.points.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      });
    }
    async function recalcAndSaveGolden(){
      const {T, BASE, O0, A, LO, HI} = paramsGB();
      const rows = goldenCandidates.map(c=>({ id:c.id, odds: fromCandidateOdds(c) })).filter(r=>r.odds);
      if(rows.length>0){
        const shown = computeDisplayedPerc(rows, T);
        for(let i=0;i<rows.length;i++){
          const r = rows[i];
          const displayPercent = Number(shown[i].toFixed(1));
          const displayPoints  = Number(computePoints(r.odds, BASE, O0, A, LO, HI).toFixed(1));
          await updateDoc(doc(db,'ucl_goldenBootCandidates', r.id), {
            displayPercent,
            displayPoints,
            _calc: { scope:'golden', T, BASE, O0, A, LO, HI, updated: Date.now() }
          });
        }
      }
      alert('G√≥lkir√°ly jel√∂ltek friss√≠tve.');
      renderGoldenOddsPreview();
    }

    /* ===== BULK ‚Äì g√≥lkir√°ly jel√∂ltek ===== */
    let _bulkRows = []; // {player, team, odds}
    function pickOddsFloat(s){
      const m = s.match(/(\d{1,4}(?:[.,]\d{1,2})?)\s*$/);
      if(!m) return null;
      return Number(String(m[1]).replace(',','.'));
    }
    function bulkParseLine(line){
      const clean = line.replace(/\s{2,}/g,' ').trim();
      if(!clean) return null;
      const odds = pickOddsFloat(clean);
      if(!odds) return null;
      const head = clean.replace(/(\d{1,4}(?:[.,]\d{1,2})?)\s*$/,'').trim();

      // [Klub] vagy (Klub)
      let m = head.match(/^(.+?)\s*[\[\(]([^)\]]+)[\]\)]\s*$/);
      if(m){ return { player:m[1].trim(), team: normalizeClubName(m[2].trim()), odds }; }

      // N√©v ‚Äì Klub
      m = head.match(/^(.+?)[‚Äì-]\s*(.+)$/);
      if(m){ return { player:m[1].trim(), team: normalizeClubName(m[2].trim()), odds }; }

      // Egy√©b: csak n√©v
      return { player: head, team:'', odds };
    }
    const CLUB_ALIASES = new Map([
      ['manchester city','Manchester City'], ['man city','Manchester City'], ['m city','Manchester City'], ['city','Manchester City'],
      ['real madrid','Real Madrid'], ['r madrid','Real Madrid'], ['real','Real Madrid'],
      ['barcelona','Barcelona'], ['fc barcelona','Barcelona'], ['bar√ßa','Barcelona'],
      ['bayern','Bayern M√ºnchen'], ['bayern munich','Bayern M√ºnchen'], ['fc bayern','Bayern M√ºnchen'],
      ['psg','Paris Saint-Germain'], ['paris saint-germain','Paris Saint-Germain'], ['paris sg','Paris Saint-Germain'],
      ['arsenal','Arsenal'], ['liverpool','Liverpool'], ['internazionale','Internazionale'], ['inter','Internazionale'],
      ['juventus','Juventus'], ['leverkusen','Bayer Leverkusen'], ['borussia dortmund','Borussia Dortmund'], ['dortmund','Borussia Dortmund'],
      ['napoli','Napoli'], ['chelsea','Chelsea'], ['ajax','Ajax'], ['benfica','Benfica'], ['atletico','Atl√©tico Madrid'],
      ['marseille','Olympique Marseille'], ['monaco','Monaco'], ['psv','PSV'], ['sporting','Sporting CP'],
      ['kobenhavn','FC K√∂benhavn'], ['copenhagen','FC K√∂benhavn'], ['eintracht frankfurt','Eintracht Frankfurt'],
      ['galatasaray','Galatasaray'], ['athletic bilbao','Athletic Bilbao'], ['union saint-gilloise','Union Saint-Gilloise'],
      ['villarreal','Villarreal'], ['slavia praha','Slavia Praha'], ['qarabag','Qarabag'], ['tottenham','Tottenham Hotspur'],
      ['newcastle','Newcastle United'], ['olympiacos','Olympiakosz Pireusz'], ['pafos','Pafosz'], ['kairat','Kajrat Almati'],
      ['bodo/glimt','Bod√∏/Glimt'], ['club bruges','Club Bruges']
    ]);
    function normalizeClubName(raw){
      if(!raw) return '';
      const k = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/\./g,'').trim();
      if(CLUB_ALIASES.has(k)) return CLUB_ALIASES.get(k);
      const hit = teams.find(t=> t.toLowerCase()===raw.toLowerCase());
      if(hit) return hit;
      for(const [key,val] of CLUB_ALIASES.entries()){ if(k.includes(key)) return val; }
      return '';
    }
    function bulkGbParse(){
      const src = (document.getElementById('gbBulkText').value||'').split(/\r?\n/);
      _bulkRows = src.map(bulkParseLine).filter(Boolean);
      renderBulkPreview();
      document.getElementById('gbBulkUpload').disabled = _bulkRows.length===0;
    }
    function renderBulkPreview(){
      const host = document.getElementById('gbBulkPreview');
      if(_bulkRows.length===0){ host.innerHTML = '<div class="muted">Nincs feldolgozhat√≥ sor.</div>'; return; }
      const table = document.createElement('table');
      table.innerHTML = `
        <thead><tr><th>#</th><th>J√°t√©kos</th><th>Klub</th><th>Odds</th></tr></thead>
        <tbody></tbody>`;
      const tb = table.querySelector('tbody');
      _bulkRows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td><input value="${r.player}" data-i="${i}" data-k="player" style="width:220px"></td>
          <td>
            <select data-i="${i}" data-k="team">
              <option value="">‚Äì</option>
              ${teams.map(t=>`<option value="${t}" ${t===(r.team||'')?'selected':''}>${t}</option>`).join('')}
            </select>
          </td>
          <td><input value="${r.odds}" data-i="${i}" data-k="odds" style="width:90px"></td>`;
        tb.appendChild(tr);
      });
      host.innerHTML=''; host.appendChild(table);
      tb.querySelectorAll('input,select').forEach(el=>{
        el.oninput = ()=>{
          const i = +el.dataset.i, k = el.dataset.k;
          let v = el.value;
          if(k==='odds' && v) v = Number(String(v).replace(',','.'));
          _bulkRows[i][k] = v;
        };
      });
    }
    async function bulkGbUpload(){
      const wipe = document.getElementById('gbBulkWipe')?.checked;
      if(wipe){
        const snap = await getDocs(collection(db,'ucl_goldenBootCandidates'));
        for(const d of snap.docs){ await deleteDoc(doc(db,'ucl_goldenBootCandidates', d.id)); }
      }
      const existingSnap = await getDocs(collection(db,'ucl_goldenBootCandidates'));
      const existing = new Set(existingSnap.docs.map(d=>(d.data()?.player||'').toLowerCase().trim()));

      let saved=0, skipped=0;
      for(const r of _bulkRows){
        const player = (r.player||'').trim();
        const oddsDec = toNum(r.odds);
        if(!player || !oddsDec || oddsDec<=0){ skipped++; continue; }
        if(existing.has(player.toLowerCase())){ skipped++; continue; }
        const team = r.team && teams.includes(r.team) ? r.team : '';
        await addDoc(collection(db,'ucl_goldenBootCandidates'),{
          player, team,
          odds: oddsDec,
          oddsDecimal: oddsDec,
          oddsPercent: Math.round(100/oddsDec)
        });
        existing.add(player.toLowerCase());
        saved++;
      }
      alert(`Mentve: ${saved}, kihagyva: ${skipped}`);
      await loadBonusMarkets();
    }

    /* ====== BULK MAIL FUNKCI√ìK (NB1-b≈ël hozva) ====== */
    async function bulkLoadUsers(){
      const box=document.getElementById("bulkUsersBox");
      box.innerHTML = "<div class='muted'>Bet√∂lt√©s‚Ä¶</div>";
      const snap = await getDocs(collection(db,"users"));
      const arr=[];
      snap.forEach(d=>{ const u=d.data(); if(u&&u.email) arr.push({email:u.email,nickname:u.nickname||u.email,role:u.role||"user"}) });
      arr.sort((a,b)=>(a.nickname||"").localeCompare(b.nickname||"","hu"));
      box.innerHTML = arr.map(u=>`
        <label style="display:flex;align-items:center;gap:8px;padding:6px 4px;">
          <input type="checkbox" value="${u.email}">
          <span style="flex:1">${u.nickname}</span>
          <span class="muted">${u.email}</span>
          ${u.role==="admin" ? '<span class="muted">(admin)</span>' : ''}
        </label>`).join("");
    }

    async function bulkSend(){
      const subject=(document.getElementById("bulkSubject").value||"").trim();
      const htmlBody=(document.getElementById("bulkMessage").value||"").trim();
      const emails=Array.from(document.querySelectorAll("#bulkUsersBox input[type=checkbox]:checked")).map(cb=>cb.value).filter(Boolean);
      if(emails.length===0){ alert("V√°lassz legal√°bb egy c√≠mzettet."); return }
      if(!subject){ alert("Adj meg t√°rgyat."); return }
      if(!htmlBody){ alert("Adj meg √ºzenetet."); return }
      const user=auth.currentUser; if(!user){ alert("Nincs bejelentkezve."); return }
      const idToken=await user.getIdToken();
      document.getElementById("bulkInfo").textContent = "K√ºld√©s folyamatban‚Ä¶";
      const res = await fetch(GS_BULKMAIL_URL, {
        method: "POST",
        body: JSON.stringify({ action:"sendBulkEmail", idToken, emails, subject, htmlBody, templateId: _currentTplId || "" })
      });
      const data=await res.json().catch(()=>({ok:false,error:"JSON hiba"}));
      document.getElementById("bulkInfo").textContent = "";
      if(!data.ok){ alert("Hiba a k√ºld√©sn√©l: " + (data.error||"")); return }
      const v  = data.version || 'n/a';
      const hl = (data.echo && typeof data.echo.htmlLen==='number') ? data.echo.htmlLen : (htmlBody||'').length;
      const ec = (data.echo && typeof data.echo.emailsCount==='number') ? data.echo.emailsCount : emails.length;
      alert(`K√©sz. Kik√ºldve: ${data.sent} c√≠mre.
verzi√≥: ${v}
htmlLen: ${hl} | c√≠mzettek: ${ec}`);
      await loadMailLog();
    }

    async function pingServer(){
      try{
        const res = await fetch(GS_BULKMAIL_URL, {
          method: "POST",
          body: JSON.stringify({ action:"ping" })
        });
        const data = await res.json().catch(()=>({ok:false}));
        alert(`Ping: ${data.ok ? 'OK' : 'HIBA'}
verzi√≥: ${data.version || 'n/a'}`);
      }catch(e){
        alert('Ping hiba: ' + e);
      }
    }

    async function loadTemplates(){
      const sel = document.getElementById("tplSelect");
      if(!sel) return;
      sel.innerHTML = `<option value="">‚Äî V√°lassz sablont ‚Äî</option>`;
      const qy = query(collection(db,"mailTemplates"), orderBy("updatedAt","desc"), limit(100));
      const snap = await getDocs(qy);
      const opts = [];
      snap.forEach(d=>{
        const t = d.data();
        opts.push(`<option value="${d.id}">${t.title||"(n√©vtelen)"} ‚Äî ${t.subject||""}</option>`);
      });
      sel.insertAdjacentHTML("beforeend", opts.join(""));
      const st = document.getElementById("tplStatus");
      if(st) st.textContent = `Sablonok: ${opts.length} db`;
    }

    async function loadTemplateIntoForm(){
      const id = document.getElementById("tplSelect").value;
      if(!id) return alert("V√°lassz sablont.");
      const d = await getDoc(doc(db,"mailTemplates", id));
      if(!d.exists()) return alert("A sablon nem tal√°lhat√≥.");
      const t = d.data();
      document.getElementById("bulkSubject").value = t.subject || "";
      document.getElementById("bulkMessage").value = t.htmlBody || "";
      _currentTplId = id;
      const st = document.getElementById("tplStatus");
      if(st) st.textContent = `Bet√∂ltve: ${t.title||id}`;
    }

    async function saveTemplateAs(){
      const title = prompt("Sablon neve:");
      if(!title) return;
      const subject=(document.getElementById("bulkSubject").value||"").trim();
      const htmlBody=(document.getElementById("bulkMessage").value||"").trim();
      const user = auth.currentUser;
      await addDoc(collection(db,"mailTemplates"),{
        title, subject, htmlBody,
        createdBy: user?.email || "",
        updatedAt: Timestamp.fromDate(new Date())
      });
      _currentTplId = null;
      await loadTemplates();
      const st = document.getElementById("tplStatus");
      if(st) st.textContent = `Mentve: ${title}`;
    }

    async function saveTemplateUpdate(){
      const id = document.getElementById("tplSelect").value;
      if(!id) return alert("V√°lassz sablont, amit fel√ºl√≠runk.");
      const subject=(document.getElementById("bulkSubject").value||"").trim();
      const htmlBody=(document.getElementById("bulkMessage").value||"").trim();
      await updateDoc(doc(db,"mailTemplates", id),{
        subject, htmlBody, updatedAt: Timestamp.fromDate(new Date())
      });
      _currentTplId = id;
      await loadTemplates();
      const st = document.getElementById("tplStatus");
      if(st) st.textContent = "Sablon friss√≠tve.";
    }

    async function deleteTemplate(){
      const id = document.getElementById("tplSelect").value;
      if(!id) return alert("V√°lassz sablont a t√∂rl√©shez.");
      if(!confirm("Biztos t√∂rl√∂d a sablont?")) return;
      await deleteDoc(doc(db,"mailTemplates", id));
      _currentTplId = null;
      await loadTemplates();
      const st = document.getElementById("tplStatus");
      if(st) st.textContent = "Sablon t√∂r√∂lve.";
    }

    function fmtDate(ts){ try{ return ts?.toDate?.()?.toLocaleString("hu-HU") || "" }catch{ return "" } }

    async function loadMailLog(){
      const box = document.getElementById("mailLogBox");
      if(!box) return;
      box.innerHTML = "<div class='muted'>Bet√∂lt√©s‚Ä¶</div>";
      const qy = query(collection(db,"adminMailLog"), orderBy("sentAt","desc"), limit(50));
      const snap = await getDocs(qy);
      if(snap.empty){ box.innerHTML = "<div class='muted'>Nincs m√©g bejegyz√©s.</div>"; return; }

      let html = "<table><thead><tr><th>Id≈ëpont</th><th>T√°rgy</th><th>C√≠mzettek</th><th>Felad√≥</th><th></th></tr></thead><tbody>";
      const rows = [];
      snap.forEach(d=>{
        const x=d.data();
        const id=d.id;
        const count = x.sentCount ?? (x.recipients?.length||0);
        rows.push(`
          <tr data-id="${id}">
            <td>${fmtDate(x.sentAt)}</td>
            <td>${(x.subject||"").replace(/</g,"&lt;")}</td>
            <td>${count} c√≠mzett</td>
            <td>${x.sender||""}</td>
            <td><button class="btn small" data-load="${id}">‚Ü© Bet√∂lt</button></td>
          </tr>
          <tr><td colspan="5">
            <details>
              <summary>R√©szletek</summary>
              <div class="small" style="margin:8px 0"><strong>C√≠mzettek:</strong> ${(x.recipients||[]).join(", ")||"‚Äî"}</div>
              <div class="small"><strong>Forr√°s sablon:</strong> ${x.templateId||"‚Äî"}</div>
              <div class="small"><strong>S√©ma:</strong> ${x.schema||"‚Äî"} ‚Ä¢ <strong>T√∂rzs hossza:</strong> ${x.bodyLen ?? ((x.bodyHtml||x.htmlBody||x.html||'')+'').length}</div>
              <div style="border:1px solid var(--border); border-radius:10px; padding:8px; background:#fff; margin-top:8px">
                ${x.bodyHtml || x.htmlBody || x.html || "<em class='muted'>Nincs bodyHtml/htmlBody/html mez≈ë a dokumentumban.</em>"}
              </div>
              <details style="margin-top:8px">
                <summary class="small">Nyers dokumentum (debug)</summary>
                <pre class="small" style="white-space:pre-wrap; background:#f8fafc; padding:8px; border:1px solid var(--border); border-radius:8px;">${esc(JSON.stringify(x,null,2))}</pre>
              </details>
            </details>
          </td></tr>
        `);
      });
      html += rows.join("") + "</tbody></table>";
      box.innerHTML = html;

      box.querySelectorAll("button[data-load]").forEach(btn=>{
        btn.onclick = async ()=>{
          const id = btn.getAttribute("data-load");
          const d = await getDoc(doc(db,"adminMailLog", id));
          if(!d.exists()) return;
          const x = d.data();
          document.getElementById("bulkSubject").value = x.subject || "";
          document.getElementById("bulkMessage").value = (x.bodyHtml || x.htmlBody || x.html || "");
          _currentTplId = x.templateId || null;
          alert("Bet√∂ltve a szerkeszt≈ëbe.");
        };
      });
    }

    /* ===== Window hooks ===== */
    window.updateMatch = updateMatch;
    window.deleteMatch = deleteMatch;
    window.saveLock = saveLock;
    window.clearLock = clearLock;
  
    /* ===== Tipp lead√°sok ‚Äì st√°tusz ===== */
     async function loadTipStatus(){
    const info = document.getElementById('tipstatusInfo');
    const host = document.getElementById('tipstatusTable');
    if(!host) return;
    if(info) info.textContent = "Bet√∂lt√©s‚Ä¶";
    host.innerHTML = "<div class='muted'>Bet√∂lt√©s‚Ä¶</div>";

    const usersSnap = await getDocs(collection(db, "users"));
    const users = [];
    usersSnap.forEach(d => { const u=d.data(); if(u && u.email) users.push({ email:u.email, name:u.nickname || u.email }); });
    users.sort((a,b)=> (a.name||"").localeCompare(b.name||"","hu"));

    const matchesSnap = await getDocs(collection(db, "ucl_matches"));
    const now = new Date();
    const activeMatchIds = new Set();
    matchesSnap.forEach(d => {
      const m = d.data() || {};
      let st=null; try{ st = m.startTime?.toDate?.() || (m.startTime? new Date(m.startTime): null); }catch{}
      if(!m.result && st && st>now) activeMatchIds.add(d.id);
    });
    const activeCount = activeMatchIds.size;

    // helper: legjobb id≈ëb√©lyeg kiv√°laszt√°sa egy doku-b√≥l
    const pickTs = (o)=>{
      const c = o||{};
      const cand = [
        c.updatedAt, c.ts, c.timestamp, c.savedAt, c.modifiedAt, c.createdAt, c.time,
        (c._updatedAt), (c._createdAt)
      ];
      for(const t of cand){ if(t && typeof t==='object') return t; }
      return null;
    };

    // 3) Leadott meccstipp-ek felhaszn√°l√≥nk√©nt + utols√≥ m√≥dos√≠t√°s
    const tipsSnap = await getDocs(collection(db, "ucl_tips"));
    const tipsByUser = new Map();       // email -> Set(matchId)
    const lastTsByUser = new Map();     // email -> Timestamp (max)

    tipsSnap.forEach(d => {
      const t = d.data() || {};
      const email = t.user || t.email || t.uid || t.userEmail;
      const mid   = t.matchId || t.mid || t.match || t.m;
      if(!email || !mid) return;
      if(activeMatchIds.has(mid)){
        if(!tipsByUser.has(email)) tipsByUser.set(email, new Set());
        tipsByUser.get(email).add(mid);
      }
      const ts = pickTs(t);
      if(ts){
        const cur = lastTsByUser.get(email);
        if(!cur || (ts.toMillis?.()?ts.toMillis():+new Date(ts)) > (cur.toMillis?.()?cur.toMillis():+new Date(cur))){
          lastTsByUser.set(email, ts);
        }
      }
    });

    // 4) Poz√≠ci√≥s tippek st√°tusz + utols√≥ m√≥dos√≠t√°s gy≈±jt√©se
    const top8Snap     = await getDocs(collection(db, "ucl_top8Tips")).catch(()=>({empty:true, forEach:()=>{}}));
    const championSnap = await getDocs(collection(db, "ucl_championPickTips")).catch(()=>({empty:true, forEach:()=>{}}));
    const goldenSnap   = await getDocs(collection(db, "ucl_goldenBootTips")).catch(()=>({empty:true, forEach:()=>{}}));

    const top8Users = new Set();
    const championUsers = new Set();
    const goldenUsers = new Set();

    if(!top8Snap.empty) top8Snap.forEach(d => {
      const x=d.data()||{}; const e=x.user||x.email||x.userEmail; if(e){ top8Users.add(e);
        const ts = pickTs(x); if(ts){ const cur=lastTsByUser.get(e); if(!cur || ts.toMillis?.()>cur.toMillis?.()) lastTsByUser.set(e,ts); }
      }
    });
    if(!championSnap.empty) championSnap.forEach(d => {
      const x=d.data()||{}; const e=x.user||x.email||x.userEmail; if(e){ championUsers.add(e);
        const ts = pickTs(x); if(ts){ const cur=lastTsByUser.get(e); if(!cur || ts.toMillis?.()>cur.toMillis?.()) lastTsByUser.set(e,ts); }
      }
    });
    if(!goldenSnap.empty) goldenSnap.forEach(d => {
      const x=d.data()||{}; const e=x.user||x.email||x.userEmail; if(e){ goldenUsers.add(e);
        const ts = pickTs(x); if(ts){ const cur=lastTsByUser.get(e); if(!cur || ts.toMillis?.()>cur.toMillis?.()) lastTsByUser.set(e,ts); }
      }
    });

    // 5) Eml√©keztet≈ëk sz√°ml√°l√≥
    const mailLogQ = query(collection(db,"adminMailLog"), orderBy("sentAt","desc"), limit(500));
    const mailLog = await getDocs(mailLogQ).catch(()=>({empty:true, forEach:()=>{}}));
    const reminders = new Map(); // email -> count
    if(!mailLog.empty){
      mailLog.forEach(d => {
        const x = d.data() || {};
        const subj = (x.subject || "").toLowerCase();
        const isReminder = subj.includes("eml√©keztet≈ë") || (x.schema||"").toLowerCase().includes("reminder");
        if(!isReminder) return;
        const recips = Array.isArray(x.recipients) ? x.recipients : [];
        recips.forEach(e => { if(!e) return; reminders.set(e, (reminders.get(e)||0) + 1); });
      });
    }

    // 6) Render
    const rows = users.map(u => {
      const tipSet = tipsByUser.get(u.email) || new Set();
      const tipped = tipSet.size;
      const allOk = (activeCount>0) ? (tipped === activeCount) : false;
      const mark = allOk ? "‚úÖ" : (tipped>0 ? "üü°" : "‚Äî");
      const rCount = reminders.get(u.email) || 0;
      const hasTop8 = top8Users.has(u.email);
      const hasCh   = championUsers.has(u.email);
      const hasGb   = goldenUsers.has(u.email);
      const ts      = lastTsByUser.get(u.email);
      const lastStr = ts ? (ts.toDate?.()?.toLocaleString('hu-HU') || '') : '‚Äî';
      return { ...u, tipped, activeCount, mark, rCount, hasTop8, hasCh, hasGb, lastStr };
    });

    let html = "<table><thead><tr><th>Felhaszn√°l√≥</th><th>Email</th><th>Akt√≠v tippek</th><th>√Ållapot</th><th>Top8</th><th>Gy≈ëztes</th><th>G√≥lkir√°ly</th><th>Eml√©keztet≈ëk</th><th>Utolj√°ra m√≥dos√≠tva</th></tr></thead><tbody>";
    for(const r of rows){
      html += `<tr>
        <td>${r.name}</td>
        <td class="muted">${r.email}</td>
        <td class="mono">${r.tipped} / ${r.activeCount}</td>
        <td>${r.mark}</td>
        <td>${r.hasTop8 ? '‚úÖ' : '‚Äî'}</td>
        <td>${r.hasCh ? '‚úÖ' : '‚Äî'}</td>
        <td>${r.hasGb ? '‚úÖ' : '‚Äî'}</td>
        <td class="mono">${r.rCount}</td>
        <td class="mono">${r.lastStr}</td>
      </tr>`;
    }
    html += "</tbody></table>";
    host.innerHTML = html;
    if(info) info.textContent = `Akt√≠v meccsek: ${activeCount} db ‚Ä¢ Felhaszn√°l√≥k: ${users.length} f≈ë`;
  }


  document.getElementById('saveUclBracketUi')?.addEventListener('click', saveUclBracketUiSettingAdmin);
  loadUclBracketUiSettingAdmin();


</script>
</head>
<body>

<section class="card" id="uclBracketUiCard">
  <h2>BL √°grajz megjelen√≠t√©s</h2>
  <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap;">
    <label style="display:flex;gap:10px;align-items:center;">
      <input type="checkbox" id="uclBracketOpenByDefault" />
      <span>Alap√©rtelmezetten legyen lenyitva a dashboardon</span>
    </label>
    <button id="saveUclBracketUi" class="btn">Ment√©s</button>
    <span id="uclBracketUiStatus" style="opacity:.8;font-size:13px;"></span>
  </div>
</section>

<section class="card" style="margin-top:14px;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
    <h2 style="margin:0;">BL kies√©ses √°grajz szerkeszt√©se</h2>
    <button id="uclBracketReload" class="btn">Friss√≠t√©s</button>
  </div>
  <div id="uclBracketAdminStatus" style="margin-top:8px;font-size:13px;opacity:.8;"></div>
  <div class="ucl-tabs" id="uclBracketTabs">
    <button class="ucl-tabbtn" data-round="PO" aria-selected="true">Play-off</button>
    <button class="ucl-tabbtn" data-round="R16" aria-selected="false">Nyolcadd√∂nt≈ë</button>
    <button class="ucl-tabbtn" data-round="QF" aria-selected="false">Negyedd√∂nt≈ë</button>
    <button class="ucl-tabbtn" data-round="SF" aria-selected="false">El≈ëd√∂nt≈ë</button>
    <button class="ucl-tabbtn" data-round="F" aria-selected="false">D√∂nt≈ë</button>
  </div>
  <div id="uclBracketAdminBody"></div>
</section>

</body>
</html>
