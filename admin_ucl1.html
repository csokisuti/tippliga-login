<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL Admin felület</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-600:#1d4ed8;--danger:#ef4444;--border:#e5e7eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left{display:flex;gap:8px;align-items:center}
    .topbar .right{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}

    .cards{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer;background:linear-gradient(180deg,#fff, #fafafa)}
    .card-head h3{margin:0;font-size:16px}
    .card-head .hint{color:var(--muted);font-size:12px}
    .card-body{display:none;padding:16px;border-top:1px solid var(--border)}
    .card.open .card-body{display:block}

    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,input,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    input[type="datetime-local"]{min-width:230px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;font-size:13px;text-align:left}
    thead{background:#f9fafb}
    tbody tr:nth-child(even){background:#f9fafb}
    tbody tr:hover{background:#eef2ff}
    .muted{color:var(--muted)}
    .filterbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:800px){.grid2{grid-template-columns:1fr}}

    .badge{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;border:1px solid var(--border);font-size:11px}
    .badge.green{background:#ecfdf5;border-color:#bbf7d0;color:#15803d}
    .badge.red{background:#fef2f2;border-color:#fecaca;color:#b91c1c}
    .badge.gray{background:#f3f4f6;border-color:#e5e7eb;color:#4b5563}

    .grid-odds{display:grid;grid-template-columns:1.4fr 1fr;gap:16px}
    @media(max-width:1000px){.grid-odds{grid-template-columns:1fr}}
    .panel{border-radius:10px;border:1px solid var(--border);background:#fff;padding:10px 12px}
    .panel h4{margin:0 0 6px;font-size:14px}
    .help{font-size:12px;color:var(--muted);margin-bottom:8px}
    .form-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
    .form-row label{font-size:13px}
    .form-row input{min-width:80px}

    .pill{display:inline-flex;align-items:center;gap:4px;padding:1px 6px;border-radius:999px;border:1px solid var(--border);font-size:11px;background:#f9fafb}

    .log-table{max-height:220px;overflow:auto;border-radius:10px;border:1px solid var(--border);background:#fff}
    .log-table table{border-spacing:0;border-collapse:separate;width:100%}
    .log-table th,.log-table td{padding:5px 8px;font-size:12px}
    .log-table tbody tr:nth-child(odd){background:#f9fafb}

    .tag{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;font-size:11px;background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe}

    .golden-grid{display:grid;grid-template-columns:1.4fr 1fr;gap:16px}
    @media(max-width:1000px){.golden-grid{grid-template-columns:1fr}}

    .locked-label{font-weight:600;color:#b91c1c}

    .note{font-size:12px;color:var(--muted);margin-top:4px}
  </style>
</head>
<body>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, getDoc, getDocs, updateDoc, deleteDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const teams = [
      "Ajax","Arsenal","Atalanta","Athletic Bilbao","Atlético Madrid","Barcelona","Bayern München","Benfica","Bodø/Glimt","Club Bruges","Chelsea","FC Köbenhavn","Eintracht Frankfurt","Feyenoord","Inter","Juventus","Leverkusen","Liverpool","Milan","Monaco","Napoli","Newcastle","Paris Saint-Germain","Real Madrid","RB Leipzig","PSV","Porto","Sporting CP","Stuttgart","Dortmund","Celtic","Rangers","Young Boys","Galatasaray","Shakhtar","Red Star"
    ];
    const BRACKET_ROUNDS_ADMIN = [
      { id: "PO",  label: "Rájátszás a 16 közé", ties: 8 },
      { id: "R16", label: "Nyolcaddöntő",        ties: 8 },
      { id: "QF",  label: "Negyeddöntő",         ties: 4 },
      { id: "SF",  label: "Elődöntő",            ties: 2 },
      { id: "F",   label: "Döntő",               ties: 1 }
    ];

    let currentUser = null;
    let currentRole = "user";

    function initUI(){
      const top=document.createElement('div'); top.className='topbar';
      const left=document.createElement('div'); left.className='left';
      const right=document.createElement('div'); right.className='right';
      const back=document.createElement('button'); back.className='btn'; back.textContent='Vissza a dashboardra'; back.onclick=()=>location.href='dashboard_ucl.html';
      const expand=document.createElement('button'); expand.className='btn'; expand.textContent='Összes nyitása'; expand.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.add('open'));
      const collapse=document.createElement('button'); collapse.className='btn'; collapse.textContent='Összes zárása'; collapse.onclick=()=>document.querySelectorAll('.card').forEach(c=>c.classList.remove('open'));
      const refresh=document.createElement('button'); refresh.className='btn'; refresh.textContent='Frissítés';
      refresh.onclick=()=>{ loadMatches(); loadUsers(); loadResults(); loadPositionsLock(); loadBonusMarkets(); loadOfficialBonus(); loadScoringSettings(); loadBracketAdmin(); loadTemplates(); loadMailLog(); loadTipStatus(); };

      left.appendChild(back);
      right.append(expand, collapse, refresh);
      top.append(left, right);
      document.body.append(top);

      const wrap=document.createElement('div'); wrap.className='cards';

      const teamOpts = teams.map(t=>`<option value="${t}">${t}</option>`).join('');
      const cAdd = makeCard({title:'Új UCL meccs hozzáadása', hint:'Gyors űrlap', id:'card-add', bodyHTML:`
        <form id="matchForm">
          <div class="row">
            <select id="homeTeam" required><option value="">Hazai csapat</option>${teamOpts}</select>
            <select id="awayTeam" required><option value="">Vendég csapat</option>${teamOpts}</select>
            <input type="datetime-local" id="startTime" required>
            <input placeholder="Forduló / kör ID (pl. 1)" id="roundId" required>
            <input type="number" step="0.01" placeholder="Odds 1" id="odds1" required>
            <input type="number" step="0.01" placeholder="Odds X" id="oddsX" required>
            <input type="number" step="0.01" placeholder="Odds 2" id="odds2" required>
            <button type="submit" class="btn primary">Mentés</button>
          </div>
        </form>`});

      const cManage = makeCard({title:'Feltöltött UCL meccsek', hint:'Szűrés, gyors szerkesztés', id:'card-manage', bodyHTML:`
        <div class="filterbar">
          <select id="filterRound"><option value="">Összes forduló</option></select>
          <input id="filterTeam" placeholder="Csapat szűrés" />
          <button class="btn" id="applyFilters">Szűrés</button>
        </div>
        <div id="matchesList"></div>`});

      const cRes = makeCard({title:'UCL eredmények rögzítése', hint:'Eredmények + outcome', id:'card-res', bodyHTML:`
        <p class="muted">Az itt rögzített eredmények alapján számolja a rendszer a ligatáblát és a tippek pontjait.</p>
        <div id="resultsList" style="margin-top:8px"></div>`});

      const cUsers = makeCard({title:'Felhasználók és jogosultságok', hint:'users kollekció', id:'card-users', bodyHTML:`
        <p class="muted">Itt tudod módosítani a BL TippLiga felhasználóinak szerepkörét (user / admin), illetve törölni őket.</p>
        <table>
          <thead><tr><th>E-mail</th><th>Becenév</th><th>Szerepkör</th><th>Művelet</th></tr></thead>
          <tbody id="usersTable"></tbody>
        </table>`});

      const cBulk = makeCard({title:'Bulk tipp státusz / +1 listák', hint:'tips kollekció – státuszok', id:'card-bulk', bodyHTML:`
        <p class="muted">Különféle státuszokat tudsz menet közben módosítani (pl. +1 lista, kizárt tippek, stb.).</p>
        <div id="bulkTipContainer"></div>`});

      const cLog = makeCard({title:'Értesítési log', hint:'bulkMailLog / systemLog', id:'card-log', bodyHTML:`
        <div class="log-table">
          <table>
            <thead><tr><th>Időpont</th><th>Típus</th><th>Címzettek</th><th>Üzenet</th></tr></thead>
            <tbody id="logTableBody"></tbody>
          </table>
        </div>`});

      const cTipStatus = makeCard({title:'Tippek státuszai', hint:'Statisztika: X db leadott tipp, stb.', id:'card-tipstatus', bodyHTML:`
        <div id="tipStatusContainer"></div>`});

      const cLock = makeCard({
        title:'Pozíciós tipp lezárás (Top8 + Győztes + Gólkirály)',
        hint:'Azonnal vagy időpontra – settings/positionsLock_ucl',
        id:'card-lock',
        bodyHTML:`
          <div class="muted">Itt szabályozható a BL pozíciós tippek lezárása. A lezárás után a felhasználók nem tudják módosítani a Top8, végső győztes és gólkirály tippjeiket.</div>
          <div class="row" style="margin-top:8px">
            <label><input type="checkbox" id="lockNow"> Azonnali lezárás</label>
            <span class="muted">vagy</span>
            <label>Automatikus zárás időpontja: <input type="datetime-local" id="lockUntil"></label>
          </div>
          <div class="row"><input type="text" id="lockMessage" placeholder="Opcionális üzenet" style="flex:1;"></div>
          <div class="row">
            <button id="saveLock" class="btn primary">Lezárás beállítása</button>
            <button id="clearLock" class="btn danger">Lezárás feloldása</button>
            <span id="lockStatus" class="muted"></span>
          </div>`
      });

      const cBracket = makeCard({
        title:'BL kieséses ágrajz',
        hint:'ucl_bracket + ucl_matches',
        id:'card-bracket',
        bodyHTML:`
          <p class="muted">
            Itt tudod beállítani a BL kieséses szakasz párosításait.
            A meccsek maguk továbbra is a Meccsek / Eredmények kártyán jönnek létre;
            itt csak összekötöd az ágrajzot a meccs(ek)kel, és jelölöd, ha 11-esekkel dőlt el.
          </p>
          <div id="bracketAdminContainer" style="margin-top:8px; overflow-x:auto;"></div>
        `
      });

      /* Bónusz piacok – jelöltek */
      const cBonusCh = makeCard({title:'Bónusz piacok – Végső győztes jelöltek', hint:'`ucl_bonusCandidates_CH` (odds: decimális, pl. 2.00)', id:'card-bonus-ch', bodyHTML:`
        <form id="chAddForm">
          <div class="row">
            <select id="chAddTeam"><option value="">Válassz csapatot</option>${teamOpts}</select>
            <input type="text" id="chAddOdds" inputmode="decimal" placeholder="Odds (pl. 2.00)">
            <button class="btn primary" type="submit">Hozzáadás</button>
          </div>
          <div class="muted" style="margin-top:6px">Az odds decimális formátumú (pl. 2.00). Régi adatoknál, ha csak % volt, automatikusan átszámoljuk.</div>
        </form>
        <div style="margin-top:12px">
          <table id="chTable">
            <thead><tr><th>Csapat</th><th>Odds (dec)</th><th>Művelet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`});

      const cBonusGb = makeCard({title:'Bónusz piacok – Gólkirály jelöltek', hint:'`ucl_bonusCandidates_GB` (odds: decimális)', id:'card-bonus-gb', bodyHTML:`
        <form id="gbAddForm">
          <div class="row">
            <input type="text" id="gbAddPlayer" placeholder="Játékos neve">
            <input type="text" id="gbAddClub" placeholder="Klub (opcionális)">
            <input type="text" id="gbAddOdds" inputmode="decimal" placeholder="Odds (pl. 5.50)">
            <button class="btn primary" type="submit">Hozzáadás</button>
          </div>
          <div class="muted" style="margin-top:6px">A klub mező opcionális, de ajánlott kitölteni (könnyebb keresni).</div>
        </form>
        <div style="margin-top:12px">
          <table id="gbTable">
            <thead><tr><th>Játékos</th><th>Klub</th><th>Odds</th><th>Művelet</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`});

      const cOfficial = makeCard({title:'Hivatalos bajnoki sorrend rögzítése', hint:'finalStandings/official dokumentum', id:'card-official', bodyHTML:`
        <p class="muted">Itt egyetlen dokumentumban tartjuk nyilván az aktuális hivatalos BL végeredményt (pozíciós tippek kiértékeléséhez). A csapatok számozását a rendszer automatikusan generálja.</p>
        <div class="row" style="margin-top:8px">
          <textarea id="officialStandingsInput" rows="4" style="flex:1" placeholder="Minden sor egy csapat neve, pl.&#10;1. Real Madrid&#10;2. Bayern München&#10;3. Manchester City"></textarea>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="saveOfficial" class="btn primary">Sorrend mentése</button>
          <span id="officialStatus" class="muted"></span>
        </div>
        <div style="margin-top:10px">
          <table>
            <thead><tr><th>Hely</th><th>Csapat</th></tr></thead>
            <tbody id="officialTableBody"></tbody>
          </table>
        </div>`});

      const cOddsCh = makeCard({title:'Végső győztes – odds → megjelenített % + pont', hint:'settings/oddsConfig_CH – görbe paraméterek, merit-laposítás (csak csapatokhoz)', id:'card-odds-ch', bodyHTML:`
        <div class="grid-odds">
          <div class="panel">
            <h4>Beállítás</h4>
            <div class="help">T – hőmérséklet a %-hoz (nagyobb = laposabb eloszlás), BASE, O<sub>0</sub> (ahol 10 pont), A (görbe), LO/HI clamp.</div>
            <div class="form-row"><label>Hőmérséklet T: <input id="chT" type="number" step="0.1"></label><label>BASE: <input id="chBase" type="number" step="0.01"></label></div>
            <div class="form-row"><label>O<sub>0</sub>: <input id="chO0" type="number" step="0.01"></label><label>A: <input id="chA" type="number" step="0.01"></label></div>
            <div class="form-row"><label>LO clamp: <input id="chLo" type="number" step="0.01"></label><label>HI clamp: <input id="chHi" type="number" step="0.01"></label></div>
            <div class="form-row">
              <button id="saveOddsCfg_CH" class="btn primary">Beállítás mentése</button>
              <span id="oddsCfgStatus_CH" class="muted"></span>
            </div>
          </div>
          <div class="panel">
            <h4>Előnézet – Bajnok jelöltek</h4>
            <div class="help">Odds szerint növekvő sorrend</div>
            <div style="overflow:auto">
              <table id="oddsPreview_CH">
                <thead><tr><th>Csapat</th><th>Odds (dec)</th><th>Raw p</th><th>Skálázott p</th><th>Clampelt p</th><th>Merit % (raw)</th><th>Megjelenített %</th><th>Pont</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>`});

      const cOddsGb = makeCard({title:'Gólkirály – odds → megjelenített % + pont', hint:'settings/oddsConfig_GB – görbe paraméterek (játékosokra)', id:'card-odds-gb', bodyHTML:`
        <div class="grid-odds">
          <div class="panel">
            <h4>Beállítás</h4>
            <div class="help">Hasonló logika, de a gólkirály piacra kalibrálva.</div>
            <div class="form-row"><label>Hőmérséklet T: <input id="gbT" type="number" step="0.1"></label><label>BASE: <input id="gbBase" type="number" step="0.01"></label></div>
            <div class="form-row"><label>O<sub>0</sub>: <input id="gbO0" type="number" step="0.01"></label><label>A: <input id="gbA" type="number" step="0.01"></label></div>
            <div class="form-row"><label>LO clamp: <input id="gbLo" type="number" step="0.01"></label><label>HI clamp: <input id="gbHi" type="number" step="0.01"></label></div>
            <div class="form-row">
              <button id="saveOddsCfg_GB" class="btn primary">Beállítás mentése</button>
              <span id="oddsCfgStatus_GB" class="muted"></span>
            </div>
          </div>
          <div class="panel">
            <h4>Előnézet – Gólkirály jelöltek</h4>
            <div class="help">Odds szerint növekvő sorrend</div>
            <div style="overflow:auto">
              <table id="oddsPreview_GB">
                <thead><tr><th>Játékos</th><th>Klub</th><th>Odds</th><th>Raw p</th><th>Skálázott p</th><th>Clampelt p</th><th>Merit % (raw)</th><th>Megjelenített %</th><th>Pont</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>`});

      const cBulkGb = makeCard({title:'Gólkirály – jelöltek karbantartása', hint:'ucl_bonusCandidates_GB bulk műveletek', id:'card-bulk-gb', bodyHTML:`
        <p class="muted">Gyors szűrés / törlés a gólkirály jelöltek között.</p>
        <div id="bulkGbContainer"></div>`});

      wrap.append(
        cAdd.section, cManage.section, cRes.section, cUsers.section,
        cBulk.section, cLog.section, cTipStatus.section,  /* <<< ÚJ kártyák itt */
        cLock.section,
        cBracket.section,
        cBonusCh.section, cBonusGb.section,
        cOfficial.section,
        cOddsCh.section,
        cOddsGb.section,
        cBulkGb.section
      );

      document.body.append(wrap);
    }

    function makeCard({title, hint, id, open=false, bodyHTML=''}) {
      const s=document.createElement('section'); s.className='card'; if(id) s.id=id; if(open) s.classList.add('open');
      const h=document.createElement('div'); h.className='card-head'; h.innerHTML=`<div><h3>${title}</h3><div class="hint">${hint||''}</div></div>`; h.onclick=()=>s.classList.toggle('open');
      const b=document.createElement('div'); b.className='card-body'; b.innerHTML=bodyHTML;
      s.append(h,b); return {section:s, body:b}
    }

    onAuthStateChanged(auth, async user => {
      if(!user){location.href='login.html';return;}
      currentUser = user;
      const userDoc = await getDoc(doc(db,"users",user.email));
      currentRole = userDoc.exists() ? (userDoc.data().role || "user") : "user";
      initUI();
      await loadMatches();
      await loadUsers();
      await loadResults();
      await loadPositionsLock();
      await loadBonusMarkets();
      await loadOfficialBonus();
      await loadScoringSettings();
      await loadBracketAdmin();
      // + bulk mail részek:
      await loadTemplates();
      await loadMailLog();
      await loadTipStatus();

      renderChampionOddsPreview();
      renderGoldenOddsPreview();
    });

    let _matchesCache = [];
    async function loadMatches(){
      const container = document.getElementById('matchesList');
      if(!container) return;
      container.innerHTML = '';

      const snap = await getDocs(collection(db,'ucl_matches'));
      const rows = [];
      const roundsSet = new Set();
      snap.forEach(d=>{
        const m=d.data()||{};
        rows.push({id:d.id,...m});
        if(m.roundId) roundsSet.add(m.roundId);
      });
      _matchesCache = rows;

      const filterRound = document.getElementById('filterRound');
      if(filterRound && !filterRound.dataset.filled){
        Array.from(roundsSet).sort((a,b)=>String(a).localeCompare(String(b),'hu')).forEach(r=>{
          const opt=document.createElement('option'); opt.value=r; opt.textContent=`Forduló ${r}`; filterRound.appendChild(opt);
        });
        filterRound.dataset.filled="1";
      }

      const table=document.createElement('table');
      table.innerHTML=`
        <thead>
          <tr>
            <th>Forduló</th>
            <th>Hazai</th>
            <th>Vendég</th>
            <th>Kezdés</th>
            <th>Odds 1</th>
            <th>Odds X</th>
            <th>Odds 2</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody=table.querySelector('tbody');

      rows.forEach(m=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${m.roundId||''}</td>
          <td>${m.homeTeam||''}</td>
          <td>${m.awayTeam||''}</td>
          <td>${m.startTime ? (m.startTime.toDate ? m.startTime.toDate().toLocaleString('hu-HU') : m.startTime) : ''}</td>
          <td>${m.odds1||''}</td>
          <td>${m.oddsX||''}</td>
          <td>${m.odds2||''}</td>
          <td><button class="btn" data-id="${m.id}">Szerk.</button></td>
        `;
        tbody.appendChild(tr);
      });

      container.appendChild(table);
    }

    async function loadBracketAdmin(){
      const host=document.getElementById('bracketAdminContainer');
      if(!host) return;
      host.innerHTML="<div class='muted'>Betöltés…</div>";

      if(!_matchesCache||!_matchesCache.length){
        await loadMatches();
      }

      const snap=await getDocs(collection(db,'ucl_bracket'));
      const existing=new Map();
      snap.forEach(d=>{
        const data=d.data()||{};
        existing.set(d.id,Object.assign({id:d.id},data));
      });

      const rows=[];
      BRACKET_ROUNDS_ADMIN.forEach(cfg=>{
        for(let i=1;i<=cfg.ties;i++){
          const id=cfg.id+String(i);
          const base=existing.get(id)||{round:cfg.id,index:i};
          rows.push({id,cfg,data:base});
        }
      });

      const tbl=document.createElement('table');
      tbl.innerHTML=`
        <thead>
          <tr>
            <th>Kör</th>
            <th>Pár</th>
            <th>Hazai</th>
            <th>Vendég</th>
            <th>Meccsek (9. fordulótól)</th>
            <th>11-esek</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tb=tbl.querySelector('tbody');

      const koMatches=(_matchesCache||[]).filter(m=>{
        const raw=m.roundId||m.round||"";
        const num=parseInt(raw,10);
        return Number.isFinite(num)&&num>=9;
      });

      rows.forEach(row=>{
        const d=row.data;
        const id=row.id;
        const mIds=Array.isArray(d.matchIds)?d.matchIds:(d.matchId?[d.matchId]:[]);

        const options=['<option value="">–</option>'].concat(
          koMatches.map(m=>{
            const label=(m.roundId?`R${m.roundId} – `:'')+
              (m.homeTeam||m.home||'?')+
              ' – '+
              (m.awayTeam||m.away||'?');
            const selected=mIds.includes(m.id)?'selected':'';
            return `<option value="${m.id}" ${selected}>${label}</option>`;
          })
        ).join('');

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${row.cfg.label}</td>
          <td>${d.label||d.index||''}</td>
          <td>
            <input data-id="${id}" data-k="homeTeam"
                   value="${d.homeTeam||''}"
                   placeholder="${d.homeSeedLabel||''}">
          </td>
          <td>
            <input data-id="${id}" data-k="awayTeam"
                   value="${d.awayTeam||''}"
                   placeholder="${d.awaySeedLabel||''}">
          </td>
          <td>
            <select data-id="${id}" data-k="matchIds" multiple size="2">
              ${options}
            </select>
          </td>
          <td>
            <div style="display:flex;flex-direction:column;gap:4px;">
              <label style="display:flex;align-items:center;gap:4px;">
                <input type="checkbox" data-id="${id}" data-k="pens" ${d.decidedByPenalties?'checked':''}>
                <span class="muted">11-esekkel</span>
              </label>
              <select data-id="${id}" data-k="penWinner">
                <option value="">Győztes</option>
                <option value="home" ${d.penaltyWinner==='home'?'selected':''}>Hazai</option>
                <option value="away" ${d.penaltyWinner==='away'?'selected':''}>Vendég</option>
              </select>
            </div>
          </td>
          <td>
            <button class="btn primary" data-act="save" data-id="${id}">Mentés</button>
          </td>
        `;
        tb.appendChild(tr);
      });

      host.innerHTML="";
      host.appendChild(tbl);

      tb.querySelectorAll('button[data-act="save"]').forEach(btn=>{
        btn.onclick=async()=>{
          const id=btn.dataset.id;
          const inputs=tb.querySelectorAll(`[data-id="${id}"]`);
          const row=rows.find(r=>r.id===id);
          const payload={};
          inputs.forEach(el=>{
            const k=el.dataset.k;
            if(k==='homeTeam'||k==='awayTeam'){
              payload[k]=(el.value||'').trim();
            }else if(k==='matchIds'){
              const vals=Array.from(el.selectedOptions).map(o=>o.value).filter(Boolean);
              payload.matchIds=vals;
            }else if(k==='pens'){
              payload.decidedByPenalties=!!el.checked;
            }else if(k==='penWinner'){
              payload.penaltyWinner=el.value||'';
            }
          });
          payload.round=row.cfg.id;
          payload.index=row.data.index||row.index||1;
          await setDoc(doc(db,'ucl_bracket',id),payload,{merge:true});
          alert('Ágrajz-pár mentve.');
          await loadBracketAdmin();
        };
      });
    }

    async function loadResults(){
      const container=document.getElementById('resultsList');
      if(!container) return;
      container.innerHTML='';

      const snap=await getDocs(collection(db,'ucl_matches'));
      const rows=[];
      snap.forEach(d=>{
        const m=d.data()||{};
        rows.push({id:d.id,...m});
      });

      const table=document.createElement('table');
      table.innerHTML=`
        <thead>
          <tr>
            <th>Forduló</th>
            <th>Hazai</th>
            <th>Vendég</th>
            <th>Kezdés</th>
            <th>Eredmény</th>
            <th>Outcome</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody=table.querySelector('tbody');

      rows.forEach(m=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${m.roundId||''}</td>
          <td>${m.homeTeam||''}</td>
          <td>${m.awayTeam||''}</td>
          <td>${m.startTime ? (m.startTime.toDate ? m.startTime.toDate().toLocaleString('hu-HU') : m.startTime) : ''}</td>
          <td><input data-id="${m.id}" data-role="result" value="${m.result||''}" style="width:80px"></td>
          <td>
            <select data-id="${m.id}" data-role="outcome">
              <option value="">–</option>
              <option value="1" ${m.outcome==='1'?'selected':''}>1</option>
              <option value="X" ${m.outcome==='X'?'selected':''}>X</option>
              <option value="2" ${m.outcome==='2'?'selected':''}>2</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });

      container.appendChild(table);
    }

    async function loadUsers(){
      const body=document.getElementById('usersTable');
      if(!body) return;
      body.innerHTML='';
      const snap=await getDocs(collection(db,'users'));
      snap.forEach(d=>{
        const u=d.data()||{};
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${d.id}</td>
          <td>${u.nickname||''}</td>
          <td>
            <select data-id="${d.id}" data-role="role">
              <option value="user" ${u.role==='user'?'selected':''}>user</option>
              <option value="admin" ${u.role==='admin'?'selected':''}>admin</option>
            </select>
          </td>
          <td><button class="btn danger" data-id="${d.id}" data-act="del">Törlés</button></td>
        `;
        body.appendChild(tr);
      });
    }

    async function loadPositionsLock(){/* eredeti logika marad */}    
    async function loadBonusMarkets(){/* eredeti logika marad */}    
    async function loadOfficialBonus(){/* eredeti logika marad */}    
    async function loadScoringSettings(){/* eredeti logika marad */}    
    async function loadTemplates(){/* eredeti logika marad */}    
    async function loadMailLog(){/* eredeti logika marad */}    
    async function loadTipStatus(){/* eredeti logika marad */}    
    function renderChampionOddsPreview(){/* eredeti logika marad */}    
    function renderGoldenOddsPreview(){/* eredeti logika marad */}    
  </script>
</body>
</html>
