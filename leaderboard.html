<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>NB1 TippLiga ‚Äì √ñsszes√≠tett ranglista</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    .layout{ display:flex; flex-direction:column; gap:16px; max-width:1200px; margin:0 auto; padding:20px; }

    .header{ display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; }
    .fav-crest{ width:46px; height:46px; object-fit:contain; border-radius:8px; border:1px solid var(--line,#e6eaf1); background:#fff; }
    .welcome{ color:var(--muted,#64748b); margin:4px 0 0; }

    .nav-grid{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; }
    @media (max-width:1100px){ .nav-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width:700px){ .nav-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .nav-card{ display:flex; gap:12px; align-items:center; text-decoration:none; color:inherit; padding:14px; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 6px 18px rgba(15,23,42,.05); }
    .nav-card .icon-wrap{ width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:color-mix(in oklab, var(--accent,#3b82f6) 15%, white); color:var(--accent,#3b82f6); }
    .nav-card .text{ display:flex; flex-direction:column; line-height:1.2; }
    .nav-card .title{ font-weight:800; }
    .nav-card .desc{ color:var(--muted,#64748b); font-size:12px; }
    .pill-badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; margin-left:6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700; line-height:1; vertical-align:middle; }
    .pill-badge[hidden]{ display:none !important; }

    .btn{ border:0; background:#e5e7eb; color:#111; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .muted{ color:#64748b; }

    /* K√°rtya */
    .card{ background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,.06); overflow:hidden; }
    .subhdr{ background:#f7f9fd; border-bottom:1px solid var(--line,#e6eaf1); padding:10px 12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    /* ----- Ranglista: EGY r√°cs, sticky els≈ë oszlopok ----- */
    .table-scroll{ overflow:auto; }
    .leader-grid{
      display:grid;
      /* ezek az √©rt√©kek JS-b≈ël is fel√ºl√≠r√≥dnak (gridTemplateColumns) */
      grid-template-columns: var(--w-rank) var(--w-player) var(--w-total) var(--w-bonus) var(--w-base);
      grid-auto-rows: auto;
    }
    .hdr, .row{ display:contents; }
    .cell{ padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#fff; }
    .hdr .cell{ font-weight:700; background:#f7f8fc; }

    /* sticky bal oszlopok ‚Äì numerikus bal √©rt√©keket adunk (JS √°ll√≠tja a width-eket) */
    .sticky{ position:sticky; z-index:2; background:#fff; }
    .c0{ left: 0; }                               /* Hely */
    .c1{ left: var(--left-1); }                   /* J√°t√©kos */
    .c2{ left: calc(var(--left-1) + var(--w-player)); }  /* √ñsszesen */
    .c3{ left: calc(var(--left-1) + var(--w-player) + var(--w-total)); }  /* B√≥nusz */
    .c4{ left: calc(var(--left-1) + var(--w-player) + var(--w-total) + var(--w-bonus)); } /* Alap */

    .rank{ text-align:right; color:#64748b; white-space:nowrap; }
    .num{ text-align:right; white-space:nowrap; }
    .total{ font-weight:800; }
    .round-cell{ min-width:78px; text-align:right; }
    .round-link{ display:block; color:inherit; text-decoration:none; }
    .round-link:hover{ text-decoration:underline; }
    .top{ background:#fff8e1 !important; font-weight:700; }

    /* J√°t√©kos cella */
    .player-cell{ display:flex; align-items:center; gap:10px; }
    .mini-crest{ width:20px; height:20px; object-fit:contain; border-radius:4px; border:1px solid var(--line,#e6eaf1); background:#fff; }
    .player-name{ font-weight:800; }

    /* Chat */
    .chat-fab{ position:fixed; right:22px; bottom:22px; z-index:999; width:52px; height:52px; border-radius:999px; border:0; background:var(--accent,#3b82f6); color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 26px rgba(0,0,0,.15); }
    .chat-fab .fab-badge{ position:absolute; top:-4px; right:-4px; min-width:20px; height:20px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:800; line-height:20px; display:none; }
    .chat-fab.has-unread .fab-badge{ display:inline-block; }
    .chat-panel{ position:fixed; right:22px; bottom:86px; z-index:998; width:380px; max-width:calc(100vw - 32px); max-height:70vh; display:none; flex-direction:column; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 10px 32px rgba(0,0,0,.14); }
    .chat-panel.open{ display:flex; }
    .chat-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd; }
    .chat-title{ font-weight:800; }
    #chatClose{ width:28px; height:28px; border-radius:8px; font-size:18px; line-height:28px; display:inline-flex; align-items:center; justify-content:center; background:#eef2ff; color:#111; border:1px solid var(--line,#e6eaf1); cursor:pointer; }
    #chatClose:hover{ filter:brightness(0.95); }
    .chat-list{ overflow:auto; padding:8px 10px; }
    .chat-empty{ color:#64748b; font-size:13px; padding:8px 10px; }
    .msg{ padding:8px 10px; border-bottom:1px solid var(--line,#e6eaf1); display:flex; gap:8px; align-items:flex-start; }
    .msg .meta{ font-size:12px; color:#64748b; margin-bottom:2px; }
    .msg .text{ white-space:pre-wrap; word-break:break-word; }
    .msg .del{ margin-left:auto; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:2px 8px; border-radius:8px; font-size:12px; cursor:pointer; display:none; }
    .msg:hover .del{ display:inline-block; }

    #chatComposer{ display:flex; gap:8px; align-items:center; padding:10px; border-top:1px solid var(--line,#e6eaf1); background:#fff; }
    #chatInput{ background:#fff; color:#111; border:1px solid var(--line,#e6eaf1); height:40px; padding:8px 10px; border-radius:10px; font-size:14px; outline:none; width:100%; box-sizing:border-box; }
    #chatInput::placeholder{ color:#6b7280; }
    #chatSendBtn{ min-width:90px; padding:8px 12px; border-radius:10px; background:var(--accent,#3b82f6); color:#fff; border:0; font-weight:600; cursor:pointer; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* --- C√≠merek + sz√≠nek --- */
    const crestMap = {
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Di√≥sgy≈ëri VTK": "crest/crest-dvtk.png",
      "Ferencv√°ros": "crest/crest-fradi.png",
      "ETO FC Gy≈ër": "crest/crest-gyor.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Kisv√°rda FC": "crest/crest-kisvarda.png",
      "MTK Budapest": "crest/crest-mtk.png",
      "Ny√≠regyh√°za Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Pusk√°s Akad√©mia": "crest/crest-puskas.png",
      "√öjpest FC": "crest/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png"
    };
    const teamColors = {
      "Debreceni VSC": "#b91c1c",
      "Di√≥sgy≈ëri VTK": "#dc2626",
      "Ferencv√°ros": "#168a3b",
      "ETO FC Gy≈ër": "#0e7a0d",
      "Kazincbarcikai SC": "#1e3a8a",
      "Kisv√°rda FC": "#ef4444",
      "MTK Budapest": "#2563eb",
      "Ny√≠regyh√°za Spartacus": "#1d4ed8",
      "Paksi FC": "#059669",
      "Pusk√°s Akad√©mia": "#0ea5e9",
      "√öjpest FC": "#7e22ce",
      "Zalaegerszegi TE FC": "#1e40af"
    };

    const fmt = n => (Number(n)||0).toFixed(2);
    const fmtTime = ts => { try{ return ts.toDate().toLocaleString("hu-HU",{hour12:false}); }catch{ return ""; } };
    const escapeHtml = s => String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    const tipChoice = t => t.choice ?? t.tip ?? "";
    const tipDouble = t => !!(t.double ?? t.isDouble);
    const matchRound = m => String(m.round ?? m.roundId ?? "");
    const NORM = s => String(s ?? "").trim().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const eqTeam = (a,b) => !!a && !!b && NORM(a) === NORM(b);
    function officialArrayFrom(d){
      if (!d) return [];
      if (Array.isArray(d.order)) return d.order;
      if (Array.isArray(d.teams)) return d.teams;
      if (Array.isArray(d.positions)) return d.positions.slice().sort((a,b)=>(a.position||0)-(b.position||0)).map(x=>x.team);
      return [];
    }
    function pctColor(pct){ const p=Math.max(0,Math.min(12, pct)); const hue=(p/12)*120; return `hsl(${hue}deg,85%,40%)`; }

    /* --- √Ållapot --- */
    let currentUserEmail = "";
    let currentUserNick = "";
    let currentUserRole = "user";
    let favoriteTeam = "";
    let chatLastSeen = null;

    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        currentUserEmail = user.email;

        const userRef = doc(db, "users", currentUserEmail);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()){
          const d = userSnap.data();
          currentUserNick = d.nickname || currentUserEmail;
          currentUserRole = d.role || "user";
          favoriteTeam = d.favoriteTeam || "";
          chatLastSeen = d.chatLastSeen || null;
        } else {
          currentUserNick = currentUserEmail;
          currentUserRole = "user";
          favoriteTeam = ""; chatLastSeen = null;
        }
        document.getElementById("welcome").textContent = `√údv, ${currentUserNick}!`;
        if (currentUserRole === "admin") document.getElementById("adminLink").style.display = "flex";

        if (favoriteTeam) {
          const crest = crestMap[favoriteTeam];
          if (crest) { const img = document.getElementById("favCrest"); img.src = crest; img.alt = favoriteTeam; img.hidden = false; }
        }

        await buildLeaderboard();
        updatePendingBadge();
        initChat(userRef);
        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(() => window.location.href = "login.html");
      });

      document.getElementById('toggleAll').addEventListener('click', ()=>{
        showAll = !showAll;
        document.getElementById('toggleAll').textContent = showAll ? 'Csak az utols√≥ 5 fordul√≥' : 'Mutasd az √∂sszes fordul√≥t';
        renderTable();
      });
    });

    /* --- Bet√∂lt√©s + pontsz√°m√≠t√°s --- */
    let showAll = false;
    let rows = [];
    let roundsAsc = [];
    let officialOrder = [];

    async function buildLeaderboard(){
      const [matchesSnap, tipsSnap, usersSnap, officialSnap, standingsTipsSnap] = await Promise.all([
        getDocs(collection(db, "matches")),
        getDocs(collection(db, "tips")),
        getDocs(collection(db, "users")),
        getDoc(doc(db, "finalStandings", "official")),
        getDocs(collection(db, "standingsTips"))
      ]);

      const matches = {};
      matchesSnap.forEach(d => matches[d.id] = { id:d.id, ...d.data() });

      const usersInfo = {};
      usersSnap.forEach(d => {
        const u = d.data();
        if (u?.email) usersInfo[u.email] = { nick: u.nickname || u.email, favoriteTeam: u.favoriteTeam || "" };
      });

      officialOrder = officialArrayFrom(officialSnap.exists() ? officialSnap.data() : []).slice(0,12);
      while (officialOrder.length < 12) officialOrder.push("");

      const orderByEmail = {};
      standingsTipsSnap.forEach(d=>{
        const data = d.data() || {};
        let arr = [];
        if (Array.isArray(data.order)) arr = data.order;
        else if (Array.isArray(data.teams)) arr = data.teams;
        else if (Array.isArray(data.ranking)) arr = data.ranking;
        orderByEmail[d.id] = (arr || []).slice(0,12);
      });

      const latest = new Map();
      tipsSnap.forEach(docu=>{
        const t = docu.data(); if (!t?.matchId || !t?.user) return;
        const k = t.user + "|" + t.matchId;
        const cur = latest.get(k);
        const curTs = cur?.updatedAt?.toMillis?.() || cur?.createdAt?.toMillis?.() || 0;
        const ts = t.updatedAt?.toMillis?.() || t.createdAt?.toMillis?.() || 0;
        if (!cur || ts >= curTs) latest.set(k, { id:docu.id, ...t });
      });

      const player = {};
      const rounds = new Set();

      for (const tip of latest.values()){
        const m = matches[tip.matchId]; if (!m) continue;
        const roundId = String(m.round ?? m.roundId ?? ""); if (!roundId) continue;
        rounds.add(roundId);

        if (!m.outcome) continue;
        const pick = tipChoice(tip); if (!pick) continue;

        const ov = m?.odds?.[pick] ?? (pick==="1" ? m.odds1 : pick==="X" ? m.oddsX : pick==="2" ? m.odds2 : undefined);
        const mult = tipDouble(tip) ? 2 : 1;
        const pts = (pick === m.outcome && ov) ? Number(ov) * mult : 0;

        const info = usersInfo[tip.user] || { nick: tip.user, favoriteTeam: "" };
        const nick = info.nick;
        if (!player[nick]) player[nick] = { base:0, perRound:{}, email: tip.user };
        player[nick].base += pts;
        player[nick].perRound[roundId] = (player[nick].perRound[roundId]||0) + pts;
      }

      roundsAsc = Array.from(rounds).sort((a,b)=> (parseInt(a)||0)-(parseInt(b)||0));

      function calcHits(order, official){
        let h = 0; for (let i=0;i<12;i++){ if (eqTeam(order?.[i], official?.[i])) h++; } return h;
      }

      rows = Object.entries(player).map(([nick,obj])=>{
        const info = usersInfo[obj.email] || { nick, favoriteTeam: "" };
        const order = orderByEmail[obj.email] || [];
        const hits = calcHits(order, officialOrder);
        const bonusPct = hits;
        const bonusPts = Math.round(obj.base * (bonusPct/100));
        const total = obj.base + bonusPts;
        return { nick: info.nick || nick, email: obj.email, favTeam: info.favoriteTeam || "", base: obj.base, perRound: obj.perRound, bonusPct, bonusPts, total };
      });

      rows.sort((a,b)=> b.total - a.total || a.nick.localeCompare(b.nick));
      renderTable();
    }

    /* --- Rajzol√°s: egyetlen grid + sticky els≈ë 5 oszlop --- */
    function renderTable(){
      const mount = document.getElementById('tableMount');
      if (!rows.length){
        mount.innerHTML = "<div style='padding:12px'>M√©g nincs megjelen√≠thet≈ë pontsz√°m.</div>";
        return;
      }

      const RANK_W  = 70;
      const PLAYER_W= 320;  // fix px, hogy a sticky bal oldal sz√°m√≠that√≥ legyen
      const TOTAL_W = 140;
      const BONUS_W = 180;
      const BASE_W  = 140;
      const ROUND_W = 78;

      const roundsDesc = roundsAsc.slice().reverse();
      const toShow = showAll ? roundsDesc : roundsDesc.slice(0, Math.min(5, roundsDesc.length));

      const rangeLabel = document.getElementById('rangeLabel');
      rangeLabel.textContent = showAll
        ? "Teljes n√©zet: minden fordul√≥ l√°tszik (balr√≥l jobbra: legut√≥bbi ‚Üí r√©gebbi)"
        : (toShow.length ? `Csak az utols√≥ ${toShow.length} fordul√≥ l√°tszik (balr√≥l jobbra: F${toShow[0]} ‚Üí ‚Ä¶)` : "Nincs m√©g lez√°rt fordul√≥.");

      const maxPerRound = toShow.map(r=>{
        let m = -Infinity;
        rows.forEach(row => { m = Math.max(m, row.perRound[r]||0); });
        return m === -Infinity ? 0 : m;
      });

      const templateCols =
        `${RANK_W}px ${PLAYER_W}px ${TOTAL_W}px ${BONUS_W}px ${BASE_W}px ` +
        `${(''+Array(toShow.length)).split(',').map(()=>`${ROUND_W}px`).join(' ')}`;

      const scroll = document.createElement('div');
      scroll.className = 'table-scroll';

      const grid = document.createElement('div');
      grid.className = 'leader-grid';
      grid.style.gridTemplateColumns = templateCols;

      // bal offset az els≈ë ragad√≥s oszlop ut√°n (rank sz√©less√©ge)
      grid.style.setProperty('--w-rank',  RANK_W  + 'px');
      grid.style.setProperty('--w-player',PLAYER_W + 'px');
      grid.style.setProperty('--w-total', TOTAL_W + 'px');
      grid.style.setProperty('--w-bonus', BONUS_W + 'px');
      grid.style.setProperty('--w-base',  BASE_W  + 'px');
      grid.style.setProperty('--left-1',  RANK_W  + 'px');

      // fejl√©cek
      grid.insertAdjacentHTML('beforeend', `
        <div class="hdr">
          <div class="cell rank sticky c0">Hely</div>
          <div class="cell sticky c1">J√°t√©kos</div>
          <div class="cell num sticky c2">√ñsszesen</div>
          <div class="cell num sticky c3">B√≥nusz (pont + %)</div>
          <div class="cell num sticky c4">Alap pont</div>
          ${toShow.map(r=>`<div class="cell round-cell">F${r}</div>`).join('')}
        </div>
      `);

      // sorok
      rows.forEach((r,i)=>{
        const crest = r.favTeam && crestMap[r.favTeam] ? `<img class="mini-crest" src="${crestMap[r.favTeam]}" alt="${escapeHtml(r.favTeam)}">` : '';
        const color = r.favTeam && teamColors[r.favTeam] ? ` style="color:${teamColors[r.favTeam]};"` : '';

        const rightCells = toShow.map((rid, idx)=>{
          const val = r.perRound[rid]||0;
          const isTop = val === maxPerRound[idx] && val !== 0;
          return `<div class="cell round-cell num ${isTop?'top':''}">
                    <a class="round-link" href="results.html?round=${encodeURIComponent(rid)}">${fmt(val)}${isTop?' ‚≠ê':''}</a>
                  </div>`;
        }).join('');

        grid.insertAdjacentHTML('beforeend', `
          <div class="row">
            <div class="cell rank sticky c0">${i+1}.</div>
            <div class="cell sticky c1">
              <div class="player-cell">
                ${crest}
                <span class="player-name"${color}>${escapeHtml(r.nick)}</span>
              </div>
            </div>
            <div class="cell num total sticky c2">${fmt(r.total)}</div>
            <div class="cell num sticky c3">
              +${r.bonusPts}
              <span style="color:${pctColor(r.bonusPct)}"> ( +${r.bonusPct}% )</span>
            </div>
            <div class="cell num sticky c4">${fmt(r.base)}</div>
            ${rightCells}
          </div>
        `);
      });

      mount.innerHTML = '';
      scroll.appendChild(grid);
      mount.appendChild(scroll);
    }

    /* ---- F√ºgg≈ë tippek badge ---- */
    function updatePendingBadge(){
      getDocs(query(collection(db,"matches"), where("startTime", ">=", new Date()))).then(upcomingSnap=>{
        const upcoming = upcomingSnap.docs.map(d => ({ id:d.id, ...d.data() }));
        getDocs(query(collection(db,"tips"), where("user","==", currentUserEmail))).then(tipsSnap=>{
          const tippedIds = new Set(tipsSnap.docs.map(x=>x.data().matchId));
          const pending = upcoming.filter(m => !tippedIds.has(m.id)).length;
          const badge = document.getElementById("tipsBadge");
          if (pending>0){ badge.textContent = pending; badge.hidden = false; } else { badge.hidden = true; }
        });
      });
    }

    /* ---- Chat (v√°ltozatlan) ---- */
    function initChat(userRef){
      const fab = document.getElementById('chatToggle');
      const fabBadge = document.getElementById('chatFabBadge');
      const panel = document.getElementById('chatPanel');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatMessages');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSendBtn');

      function open(){ panel.classList.add('open'); setTimeout(()=>inputEl?.focus(), 50); markSeen(); }
      function close(){ panel.classList.remove('open'); }
      function toggle(){ panel.classList.contains('open') ? close() : open(); }
      fab.addEventListener('click', toggle);
      closeBtn.addEventListener('click', close);

      let lastSeenMs = chatLastSeen?.toMillis ? chatLastSeen.toMillis() : 0;

      const qAll = query(collection(db,'chatMessages'), orderBy('ts','asc'));
      onSnapshot(qAll, snap => {
        listEl.innerHTML = '';
        if (snap.empty){
          const empty = document.createElement('div');
          empty.className = 'chat-empty';
          empty.textContent = 'M√©g nincs √ºzenet. L√©gy te az els≈ë!';
          listEl.appendChild(empty);
        } else {
          let unread = 0;
          snap.forEach(docu=>{
            const d = docu.data();
            const tsMs = d.ts?.toMillis?.() || 0;
            if (tsMs > lastSeenMs) unread++;

            const row = document.createElement('div');
            row.className = 'msg';
            row.innerHTML = `
              <div style="flex:1 1 auto">
                <div class="meta"><strong>${d.nick || 'Ismeretlen'}</strong> ‚Ä¢ ${d.ts ? fmtTime(d.ts) : ''}</div>
                <div class="text">${(d.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
              </div>
            `;
            const canDelete = (currentUserRole === 'admin') || (d.email === currentUserEmail);
            if (canDelete){
              const del = document.createElement('button');
              del.className = 'del';
              del.textContent = 'T√∂rl√©s';
              del.title = '√úzenet t√∂rl√©se';
              del.addEventListener('click', async ()=>{
                try{ await deleteDoc(doc(db, 'chatMessages', docu.id)); }catch(e){}
              });
              row.appendChild(del);
            }
            listEl.appendChild(row);
          });

          if (!panel.classList.contains('open') && unread > 0){
            fab.classList.add('has-unread');
            fabBadge.textContent = unread > 99 ? '99+' : String(unread);
          } else {
            fab.classList.remove('has-unread');
            fabBadge.textContent = '';
          }

          setTimeout(()=>{ listEl.scrollTop = listEl.scrollHeight; }, 0);
        }
      });

      sendBtn.addEventListener('click', async ()=>{
        const txt = (inputEl.value || '').trim();
        if (!txt){ inputEl.focus(); return; }
        const backup = txt;
        inputEl.value = '';
        try{
          await addDoc(collection(db,'chatMessages'), { email: currentUserEmail, nick: currentUserNick || 'Ismeretlen', text: backup, ts: serverTimestamp() });
          if (panel.classList.contains('open')) await markSeen();
        }catch(e){
          inputEl.value = backup; inputEl.focus();
        }
      });
      inputEl.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
      });

      async function markSeen(){
        try{
          await setDoc(userRef, { chatLastSeen: serverTimestamp() }, { merge:true });
          lastSeenMs = Date.now();
          fab.classList.remove('has-unread');
          fabBadge.textContent = '';
        }catch(e){}
      }
    }
  </script>
</head>
<body>
  <div class="layout">
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>NB1 TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
      </div>
      <div>
        <button id="logout" class="btn" aria-label="Kil√©p√©s" style="background:var(--accent,#3b82f6);color:#fff;border:1px solid var(--line,#e6eaf1);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-3px;margin-right:6px">
            <path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/>
          </svg>
          Kil√©p√©s
        </button>
      </div>
    </div>

    <nav class="nav-grid">
      <a class="nav-card" href="dashboard.html">
        <div class="icon-wrap"><div class="icon">üè†</div></div>
        <div class="text"><span class="title">F≈ëoldal</span><span class="desc">Tabella, h√≠rek, kedvencek</span></div>
      </a>
      <a class="nav-card" href="positions.html">
        <div class="icon-wrap"><div class="icon">üèÜ</div></div>
        <div class="text"><span class="title">Szezon v√©gi sorrend</span><span class="desc">12 csapat ‚Äì h√∫zd a helyekre</span></div>
      </a>
      <a class="nav-card" href="matches.html">
        <div class="icon-wrap"><div class="icon">üìÖ</div></div>
        <div class="text"><span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span><span class="desc">K√∂zelg≈ë meccsek & tippek</span></div>
      </a>
      <a class="nav-card" href="results.html">
        <div class="icon-wrap"><div class="icon">üìÑ</div></div>
        <div class="text"><span class="title">Eredm√©nyek</span><span class="desc">Fordul√≥nk√©nti bont√°s</span></div>
      </a>
      <a class="nav-card" href="leaderboard.html">
        <div class="icon-wrap"><div class="icon">üìä</div></div>
        <div class="text"><span class="title">√ñsszpontsz√°m</span><span class="desc">Toplista & b√≥nusz</span></div>
      </a>
      <a class="nav-card" href="profile.html">
        <div class="icon-wrap"><div class="icon">üë§</div></div>
        <div class="text"><span class="title">Profil</span><span class="desc">Be√°ll√≠t√°sok & kedvenc csapat</span></div>
      </a>
      <a class="nav-card" id="adminLink" href="admin.html" style="display:none;">
        <div class="icon-wrap"><div class="icon">‚öôÔ∏è</div></div>
        <div class="text"><span class="title">Admin</span><span class="desc">Szezon-z√°r & be√°ll√≠t√°sok</span></div>
      </a>
    </nav>

    <section class="card">
      <div class="subhdr">
        <button id="toggleAll" class="btn">Mutasd az √∂sszes fordul√≥t</button>
        <span id="rangeLabel" class="muted">Alap: az utols√≥ 5 fordul√≥ l√°tszik</span>
      </div>
      <div id="tableMount"></div>
      <div style="padding:8px 12px; font-size:12px; color:#64748b;">‚≠ê = adott fordul√≥ legmagasabb pontja</div>
    </section>
  </div>

  <!-- Chat -->
  <button id="chatToggle" class="chat-fab" title="K√∂z√∂ss√©gi chat">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M4 4h16a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H8l-4 3V6a2 2 0 0 1 2-2Z"/>
    </svg>
    <span id="chatFabBadge" class="fab-badge"></span>
  </button>

  <section id="chatPanel" class="chat-panel" aria-label="K√∂z√∂ss√©gi chat">
    <div class="chat-head">
      <div class="chat-title">K√∂z√∂ss√©gi chat</div>
      <button id="chatClose" aria-label="Bez√°r√°s">‚úï</button>
    </div>
    <div id="chatMessages" class="chat-list" role="log" aria-live="polite"></div>
    <div id="chatComposer">
      <input id="chatInput" type="text" placeholder="√çrj valamit‚Ä¶" autocomplete="off">
      <button id="chatSendBtn">K√ºld√©s</button>
    </div>
  </section>
</body>
</html>
