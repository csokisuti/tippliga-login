<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>üèÜ Toplista</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e6eaf1; --text:#0f172a; --muted:#64748b;
      --accent:#3b82f6;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; padding:24px; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }
    /* Vissza gomb */
    .back-btn{
      display:inline-block; text-decoration:none;
      background:#e5e7eb; color:#111;
      padding:8px 12px; border-radius:10px;
      border:1px solid var(--line);
    }
    h1{ margin:16px 0 6px; font-size:22px; }
    .muted{ color:var(--muted); margin-bottom:12px; }

    .btn{ border:0; background:#e5e7eb; color:#111; padding:8px 12px; border-radius:10px; cursor:pointer; font-size:14px; }

    /* K√°rtya */
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; box-shadow:0 6px 18px rgba(15,23,42,.05); }
    .subhdr{ background:#f7f9fd; border-bottom:1px solid var(--line); padding:10px 12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .legend{ font-size:12px; color:var(--muted); padding:8px 12px 12px; }

    /* T√°bl√°zat */
    .table-wrap{ display:flex; }
    .grid{ display:grid; }
    .hdr, .row{ display:contents; }
    .cell{ padding:10px 12px; border-bottom:1px solid var(--line); background:#fff; }
    .hdr .cell{ font-weight:700; background:#f7f8fc; }
    .row-bg:nth-child(even) .cell{ background:#fcfdff; }

    /* Bal, fix r√©sz */
    .left{ position:sticky; left:0; z-index:3; background:#fff; border-right:1px solid var(--line); }
    .left .cell{ background:#fff; }
    .rank{ text-align:right; color:var(--muted); white-space:nowrap; }
    .num{ text-align:right; white-space:nowrap; }
    .total{ font-weight:800; }

    /* Fordul√≥k */
    .round-cell{ min-width:70px; text-align:right; }
    .round-link{ display:block; color:inherit; text-decoration:none; }
    .round-link:hover{ text-decoration:underline; }
    .top{ background:#fff8e1 !important; font-weight:700; }

    @media (max-width: 900px){
      .left{ min-width:640px; max-width:640px; }
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const mount = document.getElementById('tableMount');
    const rangeLabel = document.getElementById('rangeLabel');
    const toggleBtn = document.getElementById('toggleAll');

    // 0..12% ‚Üí HSL (piros‚Üíz√∂ld)
    function pctColor(pct){
      const p = Math.max(0, Math.min(12, pct));
      const hue = (p/12)*120; // 0..120
      return `hsl(${hue}deg,85%,40%)`;
    }
    const fmt = n => (Number(n)||0).toFixed(2);

    let showAll = false;

    onAuthStateChanged(auth, async user => {
      if (!user) {
        mount.innerHTML = "<div style='padding:12px'>Be kell jelentkezned a toplista megtekint√©s√©hez.</div>";
        return;
      }

      // adatok
      const [matchesSnap, tipsSnap, usersSnap, officialSnap, standingsTipsSnap] = await Promise.all([
        getDocs(collection(db, "matches")),
        getDocs(collection(db, "tips")),
        getDocs(collection(db, "users")),
        getDoc(doc(db, "finalStandings", "official")),
        getDocs(collection(db, "standingsTips"))
      ]);

      const matches = {};
      matchesSnap.forEach(d => matches[d.id] = { id:d.id, ...d.data() });

      const usersMap = {};
      usersSnap.forEach(d => { const u = d.data(); if (u.email) usersMap[u.email] = u.nickname || u.email; });

      const officialTeams = (officialSnap.exists() && Array.isArray(officialSnap.data().teams)) ? officialSnap.data().teams : [];

      // email -> ranking
      const rankingByEmail = {};
      standingsTipsSnap.forEach(d => {
        const data = d.data();
        const ranking = Array.isArray(data.ranking) ? data.ranking : (Array.isArray(data.teams) ? data.teams : []);
        rankingByEmail[d.id] = ranking;
      });

      // pontok + fordul√≥k
      const player = {}; // nick -> {base, perRound, email}
      const allRounds = new Set();

      tipsSnap.forEach(t => {
        const tip = t.data();
        const match = matches[tip.matchId];
        if (!match || !match.outcome || !match.odds) return;

        const roundId = String(match.roundId || "");
        if (!roundId) return;
        allRounds.add(roundId);

        const isCorrect = match.outcome === tip.tip;
        const oddsValue = match.odds[tip.tip];
        const pts = isCorrect ? (oddsValue || 0) * (tip.isDouble ? 2 : 1) : 0;

        const nick = usersMap[tip.user] || tip.user;
        if (!player[nick]) player[nick] = { base:0, perRound:{}, email: tip.user };
        player[nick].base += pts;
        player[nick].perRound[roundId] = (player[nick].perRound[roundId]||0) + pts;
      });

      // b√≥nusz%
      function calcBonusPct(official=[], ranking=[]){
        const TOTAL=12; let correct=0;
        for(let i=0;i<TOTAL;i++){
          const o=official[i], r=ranking[i];
          if (o && r && o===r) correct++;
        }
        return correct; // 1 hely = 1%
      }

      const rows = Object.entries(player).map(([nick, obj])=>{
        const ranking = rankingByEmail[obj.email] || [];
        const bonusPct = officialTeams.length ? calcBonusPct(officialTeams, ranking) : 0;
        const bonusPts = Math.round(obj.base * (bonusPct/100));
        const total = obj.base + bonusPts;
        return { nick, base: obj.base, perRound: obj.perRound, bonusPct, bonusPts, total };
      });

      if (!rows.length){
        mount.innerHTML = "<div style='padding:12px'>M√©g nincs megjelen√≠thet≈ë pontsz√°m.</div>";
        return;
      }

      rows.sort((a,b)=> b.total - a.total || a.nick.localeCompare(b.nick));

      const roundsAsc = Array.from(allRounds).sort((a,b)=> (parseInt(a)||0)-(parseInt(b)||0));
      const roundsDesc = roundsAsc.slice().reverse(); // legut√≥bbi legyen legk√∂zelebb a f≈ë oszlopokhoz

      function build(){
        const toShow = showAll ? roundsDesc : roundsDesc.slice(0,5);
        rangeLabel.textContent = showAll
          ? "Teljes n√©zet: minden fordul√≥ l√°tszik (balr√≥l jobbra: legut√≥bbi ‚Üí r√©gebbi)"
          : `Csak az utols√≥ ${toShow.length} fordul√≥ l√°tszik (balr√≥l jobbra: ${toShow[0]} ‚Üí ‚Ä¶)`;

        // max per l√°that√≥ fordul√≥
        const maxPerRound = toShow.map(r=>{
          let m = -Infinity;
          rows.forEach(row => { m = Math.max(m, row.perRound[r]||0); });
          return m;
        });

        // bal, fix r√©sz ‚Äì k√©rt oszlopsorrend
        const leftHeader = `
          <div class="hdr">
            <div class="cell left rank">Hely</div>
            <div class="cell left">J√°t√©kos</div>
            <div class="cell left num">√ñsszesen</div>
            <div class="cell left num">B√≥nusz (pont + %)</div>
            <div class="cell left num">Alap pont</div>
          </div>`;

        const rightHeader = toShow
          .map(r=>`<div class="cell round-cell"><a class="round-link" href="results.html?round=${encodeURIComponent(r)}">F${r}</a></div>`)
          .join('');

        const container = document.createElement('div');
        container.className = 'table-wrap';

        const left = document.createElement('div');
        left.className = 'left';
        left.style.minWidth = '720px';
        left.style.maxWidth = '720px';
        left.innerHTML = `
          <div class="grid" style="grid-template-columns:70px 1.6fr 140px 180px 140px;">
            ${leftHeader}
            ${rows.map((r,i)=>`
              <div class="row row-bg">
                <div class="cell left rank">${i+1}.</div>
                <div class="cell left">${r.nick}</div>
                <div class="cell left num total">${fmt(r.total)}</div>
                <div class="cell left num">
                  +${r.bonusPts}
                  <span style="color:${pctColor(r.bonusPct)}"> ( +${r.bonusPct}% )</span>
                </div>
                <div class="cell left num">${fmt(r.base)}</div>
              </div>
            `).join('')}
          </div>
        `;

        const right = document.createElement('div');
        right.style.overflow = 'auto';
        right.style.flex = '1';
        right.innerHTML = `
          <div class="grid" style="grid-template-columns:${'70px '.repeat(toShow.length)};">
            <div class="hdr">${rightHeader}</div>
            ${rows.map(r=>{
              const cells = toShow.map((rid, idx)=>{
                const val = r.perRound[rid]||0;
                const isTop = val === maxPerRound[idx];
                return `<div class="cell round-cell num ${isTop?'top':''}">
                          <a class="round-link" href="results.html?round=${encodeURIComponent(rid)}">${fmt(val)}${isTop?' ‚≠ê':''}</a>
                        </div>`;
              }).join('');
              return `<div class="row row-bg">${cells}</div>`;
            }).join('')}
          </div>
        `;

        mount.innerHTML = '';
        container.appendChild(left);
        container.appendChild(right);
        mount.appendChild(container);
        if (window.hideLoader) hideLoader();
      }

      toggleBtn.addEventListener('click', ()=>{
        showAll = !showAll;
        toggleBtn.textContent = showAll ? 'Csak az utols√≥ 5 fordul√≥' : 'Mutasd az √∂sszes fordul√≥t';
        build();
      });

      build();
    });
  </script>
</head>
<body>
  <a href="dashboard.html" class="back-btn">‚Üê Vissza a f≈ëoldalra</a>
  <h1>üèÜ √ñsszes√≠tett ranglista</h1>
  <div class="muted">Szezon v√©gi b√≥nusz: minden pontos helyez√©s +1% (max 12%). A b√≥nusz **sz√≠ne** a %-t k√∂veti (0‚Üípiros, 12‚Üíz√∂ld). A fordul√≥k balr√≥l jobbra: legut√≥bbi ‚Üí r√©gebbi.</div>

  <div class="card">
    <div class="subhdr">
      <button id="toggleAll" class="btn">Mutasd az √∂sszes fordul√≥t</button>
      <span id="rangeLabel" class="muted">Alap: az utols√≥ 5 fordul√≥ l√°tszik</span>
    </div>
    <div id="tableMount"></div>
    <div class="legend">‚≠ê = adott fordul√≥ legmagasabb pontja</div>
  </div>
</body>
</html>
