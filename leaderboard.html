<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>TippLiga – Ranglista</title>
<link rel="icon" href="fav2.png">
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --line:#e5e7eb; --muted:#64748b;
    --text:#0f172a; --accent:#2563eb; --shadow:0 8px 28px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif}
  .page{max-width:1200px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:16px}
  .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .brand{display:flex;align-items:center;gap:10px}
  .brand h1{font-size:20px;margin:0}
  .logout{appearance:none;border:1px solid var(--line);background:var(--accent);color:#fff;
    padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;letter-spacing:.2px}
  .logout:active{transform:translateY(1px)}
  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111827;
    padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600}
  .chk{display:flex;align-items:center;gap:6px;font-size:14px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
  .subhdr{padding:10px 12px;border-bottom:1px solid var(--line);background:#f8fafc;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}

  /* DESKTOP GRID (>= 821px) */
  .table-wrap{display:none}
  @media (min-width: 821px){
    .table-wrap{display:flex}
    .grid{display:grid}
    .hdr,.row{display:contents}
    .cell{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;white-space:nowrap}
    .hdr .cell{font-weight:800;background:#f8fafc}
    .left{position:sticky;left:0;z-index:2;background:#fff;border-right:1px solid var(--line)}
    .col-rank{width:64px;justify-content:flex-end;color:var(--muted)}
    .col-name{min-width:240px;max-width:360px;overflow:hidden;text-overflow:ellipsis}
    .col-total,.col-bonus,.col-base{text-align:right;justify-content:flex-end}
    .round-cell{text-align:right;width:84px}
  }

  /* TABLET (481–820px): no sticky, but still grid */
  @media (min-width:481px) and (max-width:820px){
    .left{position:relative !important;left:auto !important;border-right:0}
    .round-cell{width:72px}
  }

  /* MOBILE CARDS (<=480px) */
  .m-list{display:grid;gap:10px;padding:10px}
  .m-row{border-top:1px solid var(--line)}
  .m-item{padding:10px 12px}
  .m-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .m-name{font-weight:800;overflow:hidden;text-overflow:ellipsis;max-width:56vw}
  .m-rank{color:var(--muted);font-weight:700}
  .m-stats{display:flex;gap:10px;margin-top:6px;color:#111}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
  .m-rounds{display:flex;gap:6px;overflow:auto;padding:6px 0}
  .rchip{min-width:60px;text-align:right;border:1px solid var(--line);border-radius:10px;padding:6px 8px;background:#fff}
  .rchip b{font-variant-numeric:tabular-nums}
  .top{background:#fff8e1 !important}

  /* helpers */
  .crest{width:20px;height:20px;border:1px solid var(--line);border-radius:6px;background:#fff;object-fit:contain}
  .pct{font-weight:700}
</style>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const cfg = {
  apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
  authDomain:"tippliga-4b3af.firebaseapp.com",
  projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com",
  messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8"
};
const app = initializeApp(cfg);
const auth = getAuth(app);
const db = getFirestore(app);

const fmt = n => (Number(n)||0).toFixed(2);

let rows=[], roundsAsc=[];

function isMobile(){ return (window.innerWidth||480) <= 480; }

document.addEventListener('DOMContentLoaded', () => {
  onAuthStateChanged(auth, async user => {
    if(!user){ location.href="login.html"; return; }
    document.getElementById('logout')?.addEventListener('click', ()=> signOut(auth).then(()=>location.href="login.html"));

    await buildData();
    render();
    window.addEventListener('resize', ()=>{ render(); });
  });
});

async function buildData(){
  // matches + tips + users
  const [mSnap,tSnap,uSnap] = await Promise.all([
    getDocs(collection(db,"matches")),
    getDocs(collection(db,"tips")),
    getDocs(collection(db,"users"))
  ]);

  const usersInfo={};
  uSnap.forEach(d=>{
    const u=d.data()||{};
    if(u.email) usersInfo[u.email]={ nick:u.nickname||u.email, team:u.favoriteTeam||"" };
  });

  const matches={};
  const rounds=new Set();
  mSnap.forEach(d=>{ const m = d.data(); matches[d.id]={ id:d.id, ...m }; if(m.roundId!=null) rounds.add(String(m.roundId)); });

  // tips: keep latest per (user,match)
  const latest=new Map();
  tSnap.forEach(d=>{
    const t=d.data(); if(!t?.matchId||!t?.user) return;
    const k=t.user+"|"+t.matchId;
    const cur=latest.get(k);
    const curTs=cur?.updatedAt?.toMillis?.()||cur?.createdAt?.toMillis?.()||0;
    const ts=t.updatedAt?.toMillis?.()||t.createdAt?.toMillis?.()||0;
    if(!cur || ts>=curTs) latest.set(k,{id:d.id,...t});
  });

  const map={};
  latest.forEach(t=>{
    const m=matches[t.matchId]; if(!m||!m.outcome) return;
    const r=String(m.roundId||"");
    const pick=(t.choice||t.tip||"");
    const isDouble=!!(t.double||t.isDouble);
    const odds = (m.odds && m.odds[pick]) || m["odds"+pick] || 0;
    const correct = pick === m.outcome;
    const pts = correct ? (Number(odds)||0) * (isDouble?2:1) : 0;
    const nick = (usersInfo[t.user]?.nick) || t.user;
    if(!map[nick]) map[nick]={ nick, email:t.user, team:(usersInfo[t.user]?.team)||"", base:0, perRound:{} };
    map[nick].base += pts;
    map[nick].perRound[r]=(map[nick].perRound[r]||0)+pts;
  });

  rows = Object.values(map);
  rows.forEach(r=>{
    r.bonusPct = 0;        // ha lesz bónusz logika, ide visszatehető
    r.bonusPts = Math.round(r.base * (r.bonusPct/100));
    r.total = r.base + r.bonusPts;
  });
  rows.sort((a,b)=> b.total-a.total || a.nick.localeCompare(b.nick));

  roundsAsc = Array.from(rounds).sort((a,b)=>(parseInt(a)||0)-(parseInt(b)||0));
}

function render(){
  if(isMobile()) renderMobile(); else renderDesktop();
}

function renderDesktop(){
  const wrap = document.getElementById('desktopMount');
  const mob  = document.getElementById('mobileMount');
  mob.innerHTML = "";
  wrap.parentElement.style.display = "flex";

  if(!rows.length){
    wrap.innerHTML = "<div style='padding:12px'>Nincs adat.</div>";
    return;
  }
  const roundsDesc = roundsAsc.slice().reverse();
  const toShow = roundsDesc;
  const leftCols = "64px 2.6fr 130px 160px 120px";
  const rightCols = toShow.map(_=> "84px").join(" ");

  const maxPerRound = toShow.map(rid=>{
    let m=-Infinity; rows.forEach(row=>{ m=Math.max(m,row.perRound[rid]||0);});
    return m===-Infinity?0:m;
  });

  const leftHeader = `
    <div class="hdr">
      <div class="cell col-rank">Hely</div>
      <div class="cell col-name">Játékos</div>
      <div class="cell col-total">Összesen</div>
      <div class="cell col-bonus">Bónusz</div>
      <div class="cell col-base">Alap</div>
    </div>`;
  const rightHeader = toShow.map(r=>`<div class="cell round-cell">F${r}</div>`).join("");

  const leftRows = rows.map((r,i)=>`
    <div class="row">
      <div class="cell col-rank">${i+1}.</div>
      <div class="cell col-name">${escapeHtml(r.nick)}</div>
      <div class="cell col-total" style="font-weight:800">${fmt(r.total)}</div>
      <div class="cell col-bonus">+${r.bonusPts} <span class="muted">(+${r.bonusPct}%)</span></div>
      <div class="cell col-base">${fmt(r.base)}</div>
    </div>
  `).join("");

  const rightRows = rows.map(r=>{
    const cells = toShow.map((rid,idx)=>{
      const val = r.perRound[rid]||0;
      const isTop = val === maxPerRound[idx] && val>0;
      return `<div class="cell round-cell${isTop?' top':''}">${fmt(val)}${isTop?' ⭐':''}</div>`;
    }).join("");
    return `<div class="row">${cells}</div>`;
  }).join("");

  wrap.innerHTML = `
    <div class="table-wrap">
      <div class="grid left" style="grid-template-columns:${leftCols};">
        ${leftHeader}
        ${leftRows}
      </div>
      <div style="overflow:auto;flex:1">
        <div class="grid" style="grid-template-columns:${rightCols};">
          <div class="hdr">${rightHeader}</div>
          ${rightRows}
        </div>
      </div>
    </div>`;
}

function renderMobile(){
  const wrap = document.getElementById('mobileMount');
  const desk = document.getElementById('desktopMount');
  desk.parentElement.style.display = "none";
  if(!rows.length){ wrap.innerHTML = "<div style='padding:10px'>Nincs adat.</div>"; return; }

  const roundsDesc = roundsAsc.slice().reverse();
  const recent = roundsDesc.slice(0,5);

  let html = `<div class="m-list">`;
  rows.forEach((r,i)=>{
    const chips = recent.map(rid=>{
      const val = r.perRound[rid]||0;
      return `<div class="rchip"><small>F${rid}</small><br><b>${fmt(val)}</b></div>`;
    }).join("");
    html += `
      <div class="card m-row">
        <div class="m-item">
          <div class="m-head">
            <div class="m-name">${escapeHtml(r.nick)}</div>
            <div class="m-rank">${i+1}.</div>
          </div>
          <div class="m-stats">
            <div class="chip"><strong>Össz:</strong> ${fmt(r.total)}</div>
            <div class="chip"><strong>Alap:</strong> ${fmt(r.base)}</div>
            <div class="chip"><strong>Bónusz:</strong> +${r.bonusPts} <span class="pct muted">(+${r.bonusPct}%)</span></div>
          </div>
          <div class="m-rounds">${chips}</div>
        </div>
      </div>`;
  });
  html += `</div>`;
  wrap.innerHTML = html;
}

// tiny helpers
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>
</head>
<body>
  <div class="page">
    <div class="top">
      <div class="brand">
        <img src="fav2.png" alt="" width="28" height="28" style="border-radius:6px;border:1px solid var(--line);background:#fff">
        <h1>NB1 TippLiga – Ranglista</h1>
      </div>
      <button id="logout" class="logout">Kilépés</button>
    </div>

    <div class="card">
      <div class="subhdr">
        <button class="btn" id="dummyToggle" disabled>Összes forduló</button>
        <label class="chk"><input type="checkbox" disabled> Botok mutatása (hamarosan)</label>
        <span class="muted">Mobilon kártyás nézet, asztalin görgethető táblázat</span>
      </div>
      <div id="desktopMount"></div>
      <div id="mobileMount"></div>
      <div style="padding:8px 12px;color:var(--muted);font-size:12px">⭐ = az adott forduló legmagasabb pontja</div>
    </div>
  </div>
</body>
</html>
