<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
  <title>NB1 TippLiga – Összesített ranglista (scrollos mobilnézet)</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="fav2.png" sizes="16x16">
  <link rel="icon" type="image/png" href="fav2.png" sizes="32x32">
  <link rel="icon" type="image/png" href="fav2.png">
  <script src="loader.js" defer></script>

  <style>
    :root{ --line:#e6eaf1; --muted:#64748b; --accent:#3b82f6; --rowh:48px; --hdrh:44px; }
    .layout{ display:flex; flex-direction:column; gap:16px; max-width:1200px; margin:0 auto; padding:20px; }

    .header{ display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .fav-crest{ width:46px; height:46px; object-fit:contain; border-radius:8px; border:1px solid var(--line); background:#fff; }
    .welcome{ color:var(--muted); margin:4px 0 0; }

    .league-switch-left{ margin-left:8px; }
    @media (max-width:700px){ .league-switch-left{ width:100%; margin-left:0; } }

    .nav-grid{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; }
    @media (max-width:1100px){ .nav-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width:700px){ .nav-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .nav-card{ display:flex; gap:12px; align-items:center; text-decoration:none; color:inherit; padding:14px; background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 6px 18px rgba(15,23,42,.05); }
    .nav-card .icon-wrap{ width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:color-mix(in oklab, var(--accent) 15%, white); color:var(--accent); }
    .nav-card .text{ display:flex; flex-direction:column; line-height:1.2; }
    .nav-card .title{ font-weight:800; }
    .nav-card .desc{ color:var(--muted); font-size:12px; }
    .pill-badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; margin-left:6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700; line-height:1; vertical-align:middle; }
    .pill-badge[hidden]{ display:none !important; }

    .btn{ border:0; background:#e5e7eb; color:#111; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .muted{ color:var(--muted); }

    .card{ background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,.06); overflow:hidden; }
    .subhdr{ background:#f7f9fd; border-bottom:1px solid var(--line); padding:10px 12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    /* === SCROLL-TÁBLÁZAT MOBILON === */
    .table-shell{ display:flex; flex-direction:column; gap:6px; }
    .scroll-hint{ font-size:12px; color:#64748b; padding:6px 10px 0; display:none; }
    .scroller{ overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling: touch; overscroll-behavior-x: contain; touch-action: pan-x; }
    .scroller::-webkit-scrollbar{ height:10px; }
    .scroller::-webkit-scrollbar-thumb{ background:#c7d2fe; border-radius:8px; }
    .scroller-inner{ display:flex; align-items:stretch; min-width: 680px; } /* kényszerített szélesség, hogy legyen mit görgetni */

    .table-wrap{ display:flex; }
    .grid{ display:grid; }
    .hdr, .row{ display:contents; }
    .cell{ padding:8px 12px; border-bottom:1px solid var(--line); background:#fff; display:flex; align-items:center; gap:8px; box-sizing:border-box; height:var(--rowh); overflow:hidden; }
    .hdr .cell{ font-weight:700; background:#f7f8fc; height:var(--hdrh); }
    .row-bg:nth-child(even) .cell{ background:#fcfdff; }

    .left{ position:sticky; left:0; z-index:3; background:#fff; border-right:1px solid var(--line); }
    .left .cell{ background:#fff; }
    .rank{ text-align:right; color:#64748b; white-space:nowrap; }
    .num{ text-align:right; white-space:nowrap; }
    .total{ font-weight:800; }
    .round-cell{ min-width:78px; text-align:right; }
    .round-link{ display:block; color:inherit; text-decoration:none; }
    .round-link:hover{ text-decoration:underline; }
    .top{ background:#fff8e1 !important; font-weight:700; }

    .name-wrap{ display:flex; align-items:center; gap:6px; white-space:nowrap; overflow:hidden; min-width:0; }
    .name-crest{ width:22px; height:22px; object-fit:contain; border-radius:6px; border:1px solid var(--line); background:#fff; flex:0 0 auto; }
    .avatar-mini{ width:22px; height:22px; object-fit:cover; border-radius:6px; border:1px solid var(--line); flex:0 0 auto; }
    .name-text{ font-weight:700; overflow:hidden; text-overflow:ellipsis; }
    .name-subtle{ font-weight:700; opacity:.9; overflow:hidden; text-overflow:ellipsis; font-size:14px; }
    .name-actions{ display:inline-flex; gap:4px; margin-left:6px; white-space:nowrap; flex-shrink:0; }
    .link-btn{ font-size:11px; padding:3px 7px; border:1px solid var(--line); border-radius:8px; background:#f8fafc; cursor:pointer; line-height:1; white-space:nowrap; }
    .bot-btn{ border-color: color-mix(in oklab, var(--accent) 40%, white); background: color-mix(in oklab, var(--accent) 12%, white); color: var(--accent); font-weight:700; }

    .btn-accent{ background:var(--accent); color:#fff; border:1px solid color-mix(in oklab, var(--accent) 40%, white); }
    .btn-accent:hover{ filter:brightness(.96); }

    /* Tablet- és mobilbarát finomhangolás */
    @media (max-width: 1024px) {
      .scroll-hint{ display:block; }
      .left { position:sticky; left:0; z-index:2; border-right:1px solid var(--line); }
      .cell { padding:8px 10px; }
      .round-cell { min-width:64px; }
      .scroller-inner{ min-width: 920px; }
    }
    @media (max-width: 640px) {
      .layout { padding:14px; }
      .hdr .cell { height:40px; }
      .cell { height:42px; font-size:14px; }
      .scroller-inner{ min-width: 1100px; } /* így tuti lesz vízszintes görgetés álló mobilon is */
    }
    @media (pointer: coarse) {
      .btn, .link-btn { min-height:40px; }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initLeagueSwitcher } from "./league-switcher.js";

    const BOT_META = {
      "Evidens Elek": { avatar:"elek-256.webp", avatar2x:"elek-512.webp", intro:"„A legkisebb kockázat is kockázat, de még mindig a legkisebb.”", bio:"Odds-alapú, mindig a legalacsonyabb kimenetelt választja." },
      "Hazai Hugó":  { avatar:"hugo-256.webp",  avatar2x:"hugo-512.webp",  intro:"„Otthon a pálya, otthon a pont.”", bio:"Mindig a hazaira (1) megy." },
      "Ikszes Ilona":{ avatar:"ilona-256.webp",  avatar2x:"ilona-512.webp",  intro:"„Az egyensúly szép – főleg a jegyzőkönyvben.”", bio:"Mindig X-et tippel." },
      "Vendég Vendel":{avatar:"vendel-256.webp", avatar2x:"vendel-512.webp", intro:"„Az idegen győzelem a legédesebb meglepetés.”", bio:"Mindig a vendégre (2) megy." }
    };

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const crestMap = {
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Diósgyőri VTK": "crest/crest-dvtk.png",
      "Ferencváros": "crest/crest-fradi.png",
      "ETO FC Győr": "crest/crest-gyor.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Kisvárda FC": "crest/crest-kisvarda.png",
      "MTK Budapest": "crest/crest-mtk.png",
      "Nyíregyháza Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Puskás Akadémia": "crest/crest-puskas.png",
      "Újpest FC": "crest/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png"
    };
    const teamColor = {
      "Debreceni VSC":"#b91c1c","Diósgyőri VTK":"#dc2626","Ferencváros":"#166534","ETO FC Győr":"#14532d",
      "Kazincbarcikai SC":"#1d4ed8","Kisvárda FC":"#991b1b","MTK Budapest":"#2563eb","Nyíregyháza Spartacus":"#1e40af",
      "Paksi FC":"#047857","Puskás Akadémia":"#065f46","Újpest FC":"#6b21a8","Zalaegerszegi TE FC":"#1d4ed8"
    };

    const fmt = n => (Number(n)||0).toFixed(2);
    const fmtTime = ts => { try{ return ts.toDate().toLocaleString("hu-HU",{hour12:false}); }catch{ return ""; } };
    const escapeHtml = s => String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const NORM = s => String(s ?? "").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const eqTeam = (a,b) => !!a && !!b && NORM(a) === NORM(b);
    const pctColor = p => `hsl(${Math.max(0,Math.min(12,p))/12*120}deg,85%,40%)`;

    function getOdds(m, key){
      if (m?.odds && (key in m.odds)) return m.odds[key];
      if (key==="1") return m.odds1 ?? m["odds1"];
      if (key==="X") return m.oddsX ?? m["oddsX"];
      if (key==="2") return m.odds2 ?? m["odds2"];
      return undefined;
    }
    const tipChoice = t => t.choice ?? t.tip ?? "";
    function tipDouble(t){ return !!(t.double ?? t.isDouble); }
    const matchRound = m => String(m.round ?? m.roundId ?? "");

    function readLiveOrderFromLocal(){
      try{
        const raw = localStorage.getItem("liveStandingsOrder");
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr.slice(0,12).map(x => String(x||""));
      }catch{ return []; }
    }

    let currentUserEmail = "";
    let currentUserNick = "";
    let currentUserRole = "user";
    let favoriteTeam = "";
    let showAllView = false;
    let showBots = false;

    let rows = [];
    let roundsAsc = [];
    let officialOrder = [];
    let usersInfo = {};
    let matchesCache = {};
    let botPickStore = {};

    let LB_MODE = "full";
    let LB_START = 1;

    function leftCols() {
      const w = window.innerWidth || 1200;
      if (w <= 820)   return "60px 2.2fr 110px 150px 110px";
      if (w <= 1024)  return "64px 2.4fr 120px 160px 115px";
      return "70px 2.8fr 130px 170px 120px";
    }
    function roundCellWidth() {
      const w = window.innerWidth || 1200;
      if (w <= 820)  return 60;
      if (w <= 1024) return 68;
      return 78;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const mount = document.getElementById('leagueSwitchMount');
      if (mount) initLeagueSwitcher({ mountTarget: mount });

      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        currentUserEmail = user.email;

        const userRef = doc(db, "users", currentUserEmail);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()){
          const d = userSnap.data();
          currentUserNick = d.nickname || currentUserEmail;
          currentUserRole = d.role || "user";
          favoriteTeam = d.favoriteTeam || "";
        } else {
          currentUserNick = currentUserEmail;
        }
        document.getElementById("welcome").textContent = `Üdv, ${currentUserNick}!`;
        if (currentUserRole === "admin") document.getElementById("adminLink").style.display = "flex";

        if (favoriteTeam) {
          const themeClass = "theme-" + favoriteTeam.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-');
          document.body.classList.add(themeClass);
          const crest = crestMap[favoriteTeam];
          if (crest) { const img = document.getElementById("favCrest"); img.src = crest; img.alt = favoriteTeam; img.hidden = false; }
        }

        const lbSnap = await getDoc(doc(db,"settings","leaderboardConfig"));
        if (lbSnap.exists()){
          const cfg = lbSnap.data()||{};
          LB_MODE  = (cfg.mode==="fromRound") ? "fromRound" : "full";
          LB_START = Math.max(1, Number(cfg.startFrom)||1);
        }

        await buildLeaderboard();
        updateControlsText();
        updatePendingBadge();
        initChat(userRef);

        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(() => window.location.href = "login.html");
      });

      document.getElementById('toggleAll').addEventListener('click', ()=>{
        showAllView = !showAllView;
        updateControlsText();
        renderTable();
      });

      const botsEl = document.getElementById('showBots');
      if (botsEl){
        botsEl.checked = showBots;
        botsEl.addEventListener('change', async e=>{
          showBots = e.target.checked;
          await buildLeaderboard();
        });
      }

      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-bot-view]');
        if (btn){ openBotModal(btn.getAttribute('data-bot-view')); }
        if (e.target.matches('.close-x')) closeBotModal();
        if (e.target.classList.contains('modal')) closeBotModal();

        const trigger = e.target.closest('[data-bot-card]');
        if (trigger){ openBotCard(trigger.getAttribute('data-bot-card'), trigger); return; }
        if (e.target.matches('[data-bc-open-tips]')){ const n=document.getElementById('botCard').dataset.name; closeBotCard(); if (n) openBotModal(n); return; }
        if (e.target.matches('[data-bc-close]')){ closeBotCard(); return; }
        if (!e.target.closest('#botCard')) closeBotCard();
      });

      let rbTimer=null;
      window.addEventListener('resize', ()=>{
        closeBotCard();
        clearTimeout(rbTimer);
        rbTimer=setTimeout(()=>renderTable(),120);
      });
    });

    function updateControlsText(){
      const btn = document.getElementById('toggleAll');
      const rangeLabel = document.getElementById('rangeLabel');
      btn.textContent = showAllView ? 'Csak az utolsó 5 forduló' : 'Mutasd az összes fordulót';
      rangeLabel.textContent =
        (LB_MODE==='fromRound'
          ? `Számolás: ${LB_START}. fordulótól • Nézet: ${showAllView ? 'összes forduló' : 'utolsó 5 forduló'}`
          : `Számolás: teljes szezon • Nézet: ${showAllView ? 'összes forduló' : 'utolsó 5 forduló'}`);
    }

    async function buildLeaderboard(){
      const [matchesSnap, tipsSnap, usersSnap, officialSnap, standingsTipsSnap] = await Promise.all([
        getDocs(collection(db, "matches")),
        getDocs(collection(db, "tips")),
        getDocs(collection(db, "users")),
        getDoc(doc(db, "finalStandings", "official")),
        getDocs(collection(db, "standingsTips"))
      ]);

      matchesCache = {};
      matchesSnap.forEach(d => matchesCache[d.id] = { id:d.id, ...d.data() });

      usersInfo = {};
      usersSnap.forEach(d => { const u = d.data(); if (u?.email) usersInfo[u.email] = { nick: u.nickname || u.email, team: u.favoriteTeam || "" }; });

      officialOrder = officialArrayFrom(officialSnap.exists() ? officialSnap.data() : []).slice(0,12);
      while (officialOrder.length < 12) officialOrder.push("");

      const liveOrder = readLiveOrderFromLocal();
      const refOrder = liveOrder.filter(Boolean).length ? liveOrder : officialOrder;

      const orderByEmail = {};
      standingsTipsSnap.forEach(d=>{
        const data = d.data() || {};
        let arr = [];
        if (Array.isArray(data.order)) arr = data.order;
        else if (Array.isArray(data.teams)) arr = data.teams;
        else if (Array.isArray(data.ranking)) arr = data.ranking;
        orderByEmail[d.id] = (arr || []).slice(0,12);
      });

      const latest = new Map();
      tipsSnap.forEach(docu=>{
        const t = docu.data(); if (!t?.matchId || !t?.user) return;
        const k = t.user + "|" + t.matchId;
        const cur = latest.get(k);
        const curTs = cur?.updatedAt?.toMillis?.() || cur?.createdAt?.toMillis?.() || 0;
        const ts = t.updatedAt?.toMillis?.() || t.createdAt?.toMillis?.() || 0;
        if (!cur || ts >= curTs) latest.set(k, { id:docu.id, ...t });
      });

      const player = {};
      const rounds = new Set();

      for (const tip of latest.values()){
        const m = matchesCache[tip.matchId]; if (!m) continue;
        const roundId = matchRound(m); if (!roundId) continue;
        if (LB_MODE === "fromRound" && (parseInt(roundId)||0) < LB_START) continue;

        rounds.add(roundId);
        if (!m.outcome) continue;
        const pick = tipChoice(tip); if (!pick) continue;

        const correct = pick === m.outcome;
        const ov = getOdds(m, pick);
        const mult = tipDouble(tip) ? 2 : 1;
        const pts = (correct && ov) ? Number(ov) * mult : 0;

        const info = usersInfo[tip.user] || { nick: tip.user, team: "" };
        const nick = info.nick;
        if (!player[nick]) player[nick] = { base:0, perRound:{}, email: tip.user, team: info.team };
        player[nick].base += pts;
        player[nick].perRound[roundId] = (player[nick].perRound[roundId]||0) + pts;
      }

      roundsAsc = Array.from(rounds).sort((a,b)=> (parseInt(a)||0)-(parseInt(b)||0));

      function calcHits(order, official){
        let h = 0; for (let i=0;i<12;i++){ if (eqTeam(order?.[i], official?.[i])) h++; } return h;
      }

      rows = Object.entries(player).map(([nick,obj])=>{
        const order = orderByEmail[obj.email] || [];
        const hits = calcHits(order, refOrder);
        const bonusPct = hits;
        const bonusPts = Math.round(obj.base * (bonusPct/100));
        const total = obj.base + bonusPts;
        return { nick, email: obj.email, team: obj.team || "", base: obj.base, perRound: obj.perRound, bonusPct, bonusPts, total, isBot:false };
      });

      if (showBots){
        const botRows = addBotRows(matchesCache, roundsAsc);
        rows = rows.concat(botRows);
      }

      rows.sort((a,b)=> b.total - a.total || a.nick.localeCompare(b.nick));
      renderTable();
    }

    function officialArrayFrom(d){
      if (!d) return [];
      if (Array.isArray(d.order)) return d.order;
      if (Array.isArray(d.teams)) return d.teams;
      if (Array.isArray(d.positions)) return d.positions.slice().sort((a,b)=>(a.position||0)-(b.position||0)).map(x=>x.team);
      return [];
    }

    function addBotRows(matches, roundsAsc){
      botPickStore = {};
      const bots = [];
      function calcForBot(type){
        let base = 0; const perRound = {}; const byRound = {};
        for (const r of roundsAsc){
          const ms = Object.values(matches).filter(m=>matchRound(m)===r && m.outcome);
          if (!ms.length) continue;

          const tips = ms.map(m=>{
            let pick="", odds=0;
            const o1=getOdds(m,"1"), oX=getOdds(m,"X"), o2=getOdds(m,"2");
            if (type==="Evidens Elek"){
              const minVal = Math.min(o1 ?? Infinity, oX ?? Infinity, o2 ?? Infinity);
              if (minVal===o1){ pick="1"; odds=o1; }
              else if (minVal===oX){ pick="X"; odds=oX; }
              else if (minVal===o2){ pick="2"; odds=o2; }
            } else if (type==="Hazai Hugó"){ pick="1"; odds=o1; }
            else if (type==="Ikszes Ilona"){ pick="X"; odds=oX; }
            else if (type==="Vendég Vendel"){ pick="2"; odds=o2; }
            return {m,pick,odds};
          });

          let bestIdx=-1, bestVal=Infinity;
          tips.forEach((t,i)=>{
            let val;
            if (type==="Evidens Elek"){
              const a=getOdds(t.m,"1"), b=getOdds(t.m,"X"), c=getOdds(t.m,"2");
              val = Math.min(a ?? Infinity, b ?? Infinity, c ?? Infinity);
            } else if (type==="Hazai Hugó"){ val = getOdds(t.m,"1"); }
            else if (type==="Ikszes Ilona"){ val = getOdds(t.m,"X"); }
            else if (type==="Vendég Vendel"){ val = getOdds(t.m,"2"); }
            if (val!=null && isFinite(val) && val>0 && val < bestVal){ bestVal=val; bestIdx=i; }
          });

          const list = [];
          tips.forEach((t,i)=>{
            if (!t.pick || !t.odds || !isFinite(t.odds)) return;
            const doubled = i===bestIdx;
            const correct = t.m.outcome===t.pick;
            const mult = doubled?2:1;
            if (correct){ base += t.odds*mult; perRound[r] = (perRound[r]||0)+t.odds*mult; }
            else { perRound[r] = (perRound[r]||0)+0; }
            list.push({
              matchId: t.m.id,
              homeTeam: t.m.homeTeam || t.m.home || "",
              awayTeam: t.m.awayTeam || t.m.away || "",
              pick: t.pick, odds: t.odds || 0, doubled, correct, outcome: t.m.outcome || ""
            });
          });
          if (list.length) byRound[r]=list;
        }
        return {base, perRound, byRound};
      }
      ["Evidens Elek","Hazai Hugó","Ikszes Ilona","Vendég Vendel"].forEach(name=>{
        const {base, perRound, byRound} = calcForBot(name);
        bots.push({ nick:name, email:"", team:"", base, perRound, bonusPct:0, bonusPts:0, total:base, isBot:true });
        botPickStore[name] = byRound;
      });
      return bots;
    }

    function renderTable(){
      const mount = document.getElementById('tableMount');
      if (!rows.length){ mount.innerHTML = "<div style='padding:12px'>Még nincs megjeleníthető pontszám.</div>"; return; }

      const roundsDesc = roundsAsc.slice().reverse();
      const toShow = showAllView ? roundsDesc : roundsDesc.slice(0, 5);

      const maxPerRound = toShow.map(r=>{
        let m = -Infinity;
        rows.forEach(row => { m = Math.max(m, row.perRound[r]||0); });
        return m === -Infinity ? 0 : m;
      });

      const leftHeader = `
        <div class="hdr">
          <div class="cell left rank">Hely</div>
          <div class="cell left">Játékos</div>
          <div class="cell left num">Összesen</div>
          <div class="cell left num">Bónusz (pont + %)</div>
          <div class="cell left num">Alap pont</div>
        </div>`;

      const rightHeader = toShow.map(r=>`<div class="cell round-cell"><a class="round-link" href="results.html?round=${encodeURIComponent(r)}">F${r}</a></div>`).join('');

      // === Scroll-shell mobilra: a két oszlop együtt egy vízszintes görgetőben
      const shell = document.createElement('div');
      shell.className = 'table-shell';

      const hint = document.createElement('div');
      hint.className = 'scroll-hint';
      hint.textContent = '↔ Húzd oldalra a teljes táblához';
      shell.appendChild(hint);

      const scroller = document.createElement('div');
      scroller.className = 'scroller';
      const inner = document.createElement('div');
      inner.className = 'scroller-inner';

      const container = document.createElement('div'); container.className = 'table-wrap';

      const left = document.createElement('div');
      left.className = 'left';
      left.innerHTML = `
        <div class="grid" style="grid-template-columns:${leftCols()};">
          ${leftHeader}
          ${rows.map((r,i)=> renderLeftRow(r,i)).join('')}
        </div>
      `;

      const right = document.createElement('div');
      right.style.overflow = 'hidden';
      right.style.flex = '1';
      const rcw = roundCellWidth();
      right.innerHTML = `
        <div class="grid" style="grid-template-columns:${(`${rcw}px `).repeat(toShow.length)};">
          <div class="hdr">${rightHeader}</div>
          ${rows.map(r=>{
            const cells = toShow.map((rid, idx)=>{
              const val = r.perRound[rid]||0;
              const isTop = val === maxPerRound[idx] && val !== 0;
              return `<div class="cell round-cell num ${isTop?'top':''}">
                        <a class="round-link" href="results.html?round=${encodeURIComponent(rid)}">${fmt(val)}${isTop?' ⭐':''}</a>
                      </div>`;
            }).join('');
            return `<div class="row row-bg">${cells}</div>`;
          }).join('')}
        </div>
      `;

      container.appendChild(left);
      container.appendChild(right);
      inner.appendChild(container);
      scroller.appendChild(inner);
      shell.appendChild(scroller);

      mount.innerHTML = '';
      mount.appendChild(shell);
    }

    function renderLeftRow(r,i){
      let nameHtml = "";
      if (r.isBot){
        const meta = BOT_META[r.nick] || {};
        const av = meta.avatar
          ? `<img class="avatar-mini" src="${meta.avatar}" ${meta.avatar2x ? `srcset="${meta.avatar} 1x, ${meta.avatar2x} 2x"` : ""} alt="${escapeHtml(r.nick)}" loading="lazy" decoding="async">`
          : "";
        nameHtml = `
          <div class="name-wrap">
            ${av}
            <span class="name-subtle">${escapeHtml(r.nick)}</span>
            <span class="name-actions">
              <button class="link-btn bot-btn" data-bot-card="${escapeHtml(r.nick)}">Profil</button>
              <button class="link-btn bot-btn" data-bot-view="${escapeHtml(r.nick)}">Tippjei</button>
            </span>
          </div>`;
      } else {
        const crest = r.team && ( ${JSON.stringify(Object.keys(crestMap))}.includes(r.team) ) ? `<img class="name-crest" src="${crestMap[r.team]}" alt="${escapeHtml(r.team)}">` : "";
        const color = r.team && ( ${JSON.stringify(Object.keys(crestMap))}.includes(r.team) ) ? ({
          "Debreceni VSC":"#b91c1c","Diósgyőri VTK":"#dc2626","Ferencváros":"#166534","ETO FC Győr":"#14532d",
          "Kazincbarcikai SC":"#1d4ed8","Kisvárda FC":"#991b1b","MTK Budapest":"#2563eb","Nyíregyháza Spartacus":"#1e40af",
          "Paksi FC":"#047857","Puskás Akadémia":"#065f46","Újpest FC":"#6b21a8","Zalaegerszegi TE FC":"#1d4ed8"
        }[r.team] || "#111827") : "#111827";
        nameHtml = `
          <div class="name-wrap">
            ${crest || ""}
            <span class="name-text" style="color:${color}">${escapeHtml(r.nick)}</span>
          </div>`;
      }
      return `
        <div class="row row-bg">
          <div class="cell left rank">${i+1}.</div>
          <div class="cell left">${nameHtml}</div>
          <div class="cell left num total">${fmt(r.total)}</div>
          <div class="cell left num">
            +${r.bonusPts}
            <span style="color:${pctColor(r.bonusPct)}"> ( +${r.bonusPct}% )</span>
          </div>
          <div class="cell left num">${fmt(r.base)}</div>
        </div>
      `;
    }

    function openBotCard(){}
    function closeBotCard(){}
    function openBotModal(){}
    function closeBotModal(){}

    function updatePendingBadge(){
      getDocs(query(collection(db,"matches"), where("startTime", ">=", new Date()))).then(upcomingSnap=>{
        const upcoming = upcomingSnap.docs.map(d => ({ id:d.id, ...d.data() }));
        getDocs(query(collection(db,"tips"), where("user","==", currentUserEmail))).then(tipsSnap=>{
          const tippedIds = new Set(tipsSnap.docs.map(x=>x.data().matchId));
          const pending = upcoming.filter(m => !tippedIds.has(m.id)).length;
          const badge = document.getElementById("tipsBadge");
          if (pending>0){ badge.textContent = pending; badge.hidden = false; } else { badge.hidden = true; }
        });
      });
    }

    function initChat(){ /* chat kód változatlanul ide illeszthető, kihagytam a rövidség kedvéért */ }
  </script>
</head>
<body>
  <div class="layout">
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>NB1 TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
        <div id="leagueSwitchMount" class="league-switch-left" aria-label="Tippjáték választó"></div>
      </div>
      <div>
        <button id="logout" class="btn" aria-label="Kilépés" style="background:var(--accent);color:#fff;border:1px solid var(--line);">
          Kilépés
        </button>
      </div>
    </div>

    <nav class="nav-grid">
      <a class="nav-card" href="dashboard.html"><div class="icon-wrap"></div><div class="text"><span class="title">Főoldal</span><span class="desc">Tabella, hírek</span></div></a>
      <a class="nav-card" href="positions.html"><div class="icon-wrap"></div><div class="text"><span class="title">Szezon végi sorrend</span><span class="desc">12 csapat – húzd a helyekre</span></div></a>
      <a class="nav-card" href="matches.html"><div class="icon-wrap"></div><div class="text"><span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span><span class="desc">Közelgő meccsek & tippek</span></div></a>
      <a class="nav-card" href="results.html"><div class="icon-wrap"></div><div class="text"><span class="title">Eredmények</span><span class="desc">Fordulónkénti bontás</span></div></a>
      <a class="nav-card" href="leaderboard.html"><div class="icon-wrap"></div><div class="text"><span class="title">Összpontszám</span><span class="desc">Toplista & bónusz</span></div></a>
      <a class="nav-card" href="profile.html"><div class="icon-wrap"></div><div class="text"><span class="title">Profil</span><span class="desc">Beállítások</span></div></a>
      <a class="nav-card" id="adminLink" href="admin.html" style="display:none;"><div class="icon-wrap"></div><div class="text"><span class="title">Admin</span><span class="desc">Beállítások</span></div></a>
    </nav>

    <section class="card">
      <div class="subhdr">
        <button id="toggleAll" class="btn">Mutasd az összes fordulót</button>
        <label style="display:flex; align-items:center; gap:6px; font-size:14px; user-select:none;">
          <input type="checkbox" id="showBots">
          Mutasd a gépi tippelőket
        </label>
        <span id="rangeLabel" class="muted"></span>
      </div>
      <div id="tableMount"></div>
      <div style="padding:8px 12px; font-size:12px; color:#64748b;">⭐ = adott forduló legmagasabb pontja • Tipp: mobilon húzd oldalra</div>
    </section>
  </div>

  <script type="module" src="logger.js"></script>
</body>
</html>
