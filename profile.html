<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Profil</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Profilom</h1>
  <div id="profileContainer">
    <p><strong>Email:</strong> <span id="emailDisplay"></span></p>
    <p><strong>Becenév:</strong> <span id="nicknameDisplay"></span></p>

    <label for="favoriteTeam">Kedvenc csapat:</label>
    <select id="favoriteTeamSelect"></select>
    <br />
    <img id="favoriteTeamLogo" style="height: 40px; margin-top: 10px;" />

    <br /><br />
    <button id="saveTeamBtn">Mentés</button>

    <h2>Jelszó megváltoztatása</h2>
    <input type="password" id="newPassword" placeholder="Új jelszó">
    <br />
    <button id="changePasswordBtn">Jelszó módosítása</button>

    <div id="message" style="margin-top: 20px;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailDisplay = document.getElementById("emailDisplay");
    const nicknameDisplay = document.getElementById("nicknameDisplay");
    const favoriteTeamSelect = document.getElementById("favoriteTeamSelect");
    const favoriteTeamLogo = document.getElementById("favoriteTeamLogo");
    const saveTeamBtn = document.getElementById("saveTeamBtn");
    const newPasswordInput = document.getElementById("newPassword");
    const changePasswordBtn = document.getElementById("changePasswordBtn");
    const messageDiv = document.getElementById("message");

    const crestMap = {
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Diósgyőri VTK": "crest/crest-dvtk.png",
      "Ferencváros": "crest/crest-fradi.png",
      "ETO FC Győr": "crest/crest-gyor.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Kisvárda FC": "crest/crest-kisvarda.png",
      "MTK Budapest": "crest/crest-mtk.png",
      "Nyíregyháza Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Puskás Akadémia": "crest/crest-puskas.png",
      "Újpest FC": "crest/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png"
    };

    function showMessage(text, color = "green") {
      messageDiv.textContent = text;
      messageDiv.style.color = color;
    }

    function updateFavoriteTeamLogo(teamName) {
      const logo = crestMap[teamName];
      if (logo) {
        favoriteTeamLogo.src = logo;
        favoriteTeamLogo.alt = teamName;
        favoriteTeamLogo.style.display = "inline-block";
      } else {
        favoriteTeamLogo.style.display = "none";
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      emailDisplay.textContent = user.email;

      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);

      if (userSnap.exists()) {
        const userData = userSnap.data();
        nicknameDisplay.textContent = userData.nickname || "—";

        Object.keys(crestMap).forEach(team => {
          const option = document.createElement("option");
          option.value = team;
          option.textContent = team;
          if (userData.favoriteTeam === team) {
            option.selected = true;
            updateFavoriteTeamLogo(team);
          }
          favoriteTeamSelect.appendChild(option);
        });

        favoriteTeamSelect.addEventListener("change", (e) => {
          updateFavoriteTeamLogo(e.target.value);
        });

        saveTeamBtn.onclick = async () => {
          const selectedTeam = favoriteTeamSelect.value;
          await updateDoc(userRef, { favoriteTeam: selectedTeam });
          showMessage("Kedvenc csapat frissítve.");
        };
      } else {
        showMessage("Felhasználói adatok nem találhatók.", "red");
      }

      changePasswordBtn.onclick = async () => {
        const newPassword = newPasswordInput.value.trim();
        if (newPassword.length < 6) {
          showMessage("A jelszónak legalább 6 karakteresnek kell lennie.", "red");
          return;
        }

        try {
          await updatePassword(user, newPassword);
          showMessage("Jelszó sikeresen módosítva.");
          newPasswordInput.value = "";
        } catch (error) {
          console.error(error);
          showMessage("Hiba a jelszó módosításakor: " + error.message, "red");
        }
      };
    });
  </script>
</body>
</html>
