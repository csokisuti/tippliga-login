<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>

  <!-- Témázás + általános stílusok -->
  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    .layout{
      display:flex; flex-direction:column; gap:16px;
      max-width:1200px; margin:0 auto; padding:20px;
    }
    .content-grid{
      display:grid; grid-template-columns: 1.2fr 1fr; gap:16px;
    }
    @media (max-width: 1000px){
      .content-grid{ grid-template-columns: 1fr; }
    }

    /* === Lebegő chat === */
    .chat-fab{
      position: fixed; right: 20px; bottom: 20px;
      display:flex; align-items:center; gap:8px;
      background: var(--accent, #3b82f6); color:#fff;
      padding:10px 14px; border-radius:999px; cursor:pointer;
      box-shadow: 0 8px 22px rgba(0,0,0,.18);
      z-index: 1000; user-select:none;
    }
    .chat-fab:hover{ filter: brightness(.95); }
    .chat-badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:18px; height:18px; padding:0 6px;
      border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700;
    }
    .chat-badge[hidden]{ display:none !important; }

    .chat-panel{
      position: fixed; right: 20px; bottom: 74px;
      width: min(380px, calc(100vw - 40px));
      background:#fff; border:1px solid #e6eaf1; border-radius:12px;
      box-shadow: 0 10px 28px rgba(15,23,42,.18);
      display:flex; flex-direction:column; overflow:hidden; z-index:1000;
    }
    .chat-header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; background:#f7f9fd; border-bottom:1px solid #e6eaf1;
      font-weight:700;
    }
    .chat-close{ background:transparent; color:#111; border:0; cursor:pointer; padding:6px 8px; border-radius:8px; }
    .chat-close:hover{ background:#e7eaf3; }

    .chat-list{
      max-height: 340px; overflow:auto; padding:10px 10px 0 10px; background:#fff;
    }
    .chat-item{
      display:flex; align-items:flex-start; gap:10px; padding:8px 6px; border-bottom:1px solid #f0f2f7;
    }
    .chat-item:last-child{ border-bottom:0; }
    .chat-nick{ font-weight:700; color:#0f172a; margin-right:6px; }
    .chat-meta{ color:#64748b; font-size:12px; }
    .chat-text{ white-space:pre-wrap; word-break:break-word; }
    .chat-actions{ margin-left:auto; }
    .chat-del{
      border:0; background:#fee2e2; color:#991b1b; border-radius:8px; cursor:pointer;
      padding:4px 6px; font-size:12px;
    }
    .chat-del:hover{ filter:brightness(.95); }

    .chat-input{
      display:flex; gap:8px; padding:10px; border-top:1px solid #e6eaf1; background:#fafbfe;
    }
    .chat-input input{
      flex:1; border:1px solid #e1e5ee; border-radius:10px; padding:10px; font:inherit;
    }
    .chat-input button{
      border:0; background:var(--accent, #3b82f6); color:#fff; border-radius:10px; padding:10px 12px; cursor:pointer;
    }
    .chat-input button[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc,
      collection, getDocs, addDoc, deleteDoc,
      query, where, orderBy, limit, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const crestMap = {
      "Ferencváros": "crest/crest-fradi.png",
      "Újpest FC": "crest/crest-ujpest.png",
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Nyíregyháza Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Puskás Akadémia": "crest/crest-puskas.png",
      "Kisvárda FC": "crest/crest-kisvarda.png",
      "Diósgyőri VTK": "crest/crest-dvtk.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png",
      "ETO FC Győr": "crest/crest-gyor.png",
      "MTK Budapest": "crest/crest-mtk.png"
    };

    const facebookLinks = {
      "Ferencváros": "https://www.facebook.com/fradi.hu",
      "Újpest FC": "https://www.facebook.com/ujpestfootballclub",
      "Debreceni VSC": "https://www.facebook.com/dvscfoci",
      "Nyíregyháza Spartacus": "https://www.facebook.com/NYSFC",
      "Paksi FC": "https://www.facebook.com/paksifcofficialsite",
      "Kazincbarcikai SC": "https://www.facebook.com/kolorcitykbsc",
      "Puskás Akadémia": "https://www.facebook.com/PFLAhu",
      "Kisvárda FC": "https://www.facebook.com/kisvardafc",
      "Diósgyőri VTK": "https://www.facebook.com/DVTK1910",
      "Zalaegerszegi TE FC": "https://www.facebook.com/ztefc.hu",
      "ETO FC Győr": "https://www.facebook.com/etofcgyor",
      "MTK Budapest": "https://www.facebook.com/MTKBudapest"
    };

    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        const email = user.email;
        let nickname = email;
        let role = "user";
        let favoriteTeam = "";

        // Felhasználói adatok
        const userRef = doc(db, "users", email);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          nickname = data.nickname || email;
          role = data.role || "user";
          favoriteTeam = data.favoriteTeam || "";
        }

        // Fejléc
        document.getElementById("welcome").textContent = `Üdv, ${nickname}!`;
        if (role === "admin") {
          document.getElementById("adminLink").style.display = "inline";
        }

        // Téma + címer
        if (favoriteTeam) {
          const themeClass = "theme-" + favoriteTeam.toLowerCase().normalize("NFD")
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-');
          document.body.classList.add(themeClass);

          const crest = crestMap[favoriteTeam];
          if (crest) {
            const img = document.getElementById("favCrest");
            img.src = crest;
            img.alt = favoriteTeam;
            img.hidden = false;
          }
        }

        // NAV kártyák: meccstippek badge (függő tippek száma)
        try{
          const now = new Date();

          // jövőbeli meccsek
          const upcomingSnap = await getDocs(
            query(collection(db, "matches"), where("startTime", ">=", now))
          );
          const upcoming = upcomingSnap.docs.map(d => ({ id: d.id, ...d.data() }));

          // saját tippek
          const myTipsSnap = await getDocs(
            query(collection(db, "tips"), where("user", "==", email))
          );
          const tippedIds = new Set(myTipsSnap.docs.map(d => d.data().matchId));

          // függő tippek
          const pending = upcoming.filter(m => !tippedIds.has(m.id)).length;

          const badge = document.getElementById("tipsBadge");
          if (pending > 0){
            badge.textContent = pending;
            badge.hidden = false;
            badge.title = `${pending} közelgő meccsre még nincs tipped`;
          } else {
            badge.hidden = true;
          }
        }catch(e){
          console.warn("Badge számítás hiba:", e);
        }

        // Tabella kép
        try {
          const tableDoc = await getDoc(doc(db, "settings", "nbi_table_image"));
          if (tableDoc.exists()) {
            const base64 = tableDoc.data().base64;
            const img = document.createElement("img");
            img.src = `data:image/png;base64,${base64}`;
            img.alt = "NB I tabella";
            document.getElementById("tableContainer").appendChild(img);
          }
        } catch(e){ console.warn(e); }

        // Facebook feed (keret nélkül)
        try {
          const fbLink = facebookLinks[favoriteTeam];
          if (fbLink) {
            const fbDiv = document.createElement("div");
            fbDiv.className = "fb-wrap";
            fbDiv.innerHTML = `
              <iframe 
                src="https://www.facebook.com/plugins/page.php?href=${encodeURIComponent(fbLink)}&tabs=timeline&width=560&height=540&small_header=false&adapt_container_width=true&hide_cover=false&show_facepile=true&appId"
                scrolling="no" frameborder="0" allowfullscreen="true"
                allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>`;
            document.getElementById("facebookFeedContainer").appendChild(fbDiv);
          }
        } catch(e){ console.warn(e); }

        /* ===== Lebegő chat ===== */
        const chatFab = document.getElementById('chatFab');
        const chatBadge = document.getElementById('chatBadge');
        const chatPanel = document.getElementById('chatPanel');
        const chatList = document.getElementById('chatList');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatClose = document.getElementById('chatClose');

        let panelOpen = false;
        let lastSeenTs = Date.now(); // amikor megnyílik, erre frissítjük
        let unseenCount = 0;

        function fmtTime(ts){
          try{
            return ts?.toDate ? ts.toDate().toLocaleString('hu-HU') : new Date(ts).toLocaleString('hu-HU');
          }catch{ return ''; }
        }

        function renderMsg(docSnap){
          const d = docSnap.data();
          const li = document.createElement('div');
          li.className = 'chat-item';

          const who = document.createElement('div');
          who.innerHTML = `<span class="chat-nick">${d.nick || 'Ismeretlen'}</span> <span class="chat-meta">${fmtTime(d.ts)}</span>`;

          const body = document.createElement('div');
          body.className = 'chat-text';
          body.textContent = d.text || '';

          li.appendChild(who);
          li.appendChild(body);

          if (role === 'admin'){
            const act = document.createElement('div');
            act.className = 'chat-actions';
            const btn = document.createElement('button');
            btn.className = 'chat-del';
            btn.textContent = 'Törlés';
            btn.onclick = async () => {
              try{
                await deleteDoc(doc(db, 'chatMessages', docSnap.id));
              }catch(e){ console.warn(e); }
            };
            act.appendChild(btn);
            li.appendChild(act);
          }
          return li;
        }

        // Realtime feliratkozás
        const q = query(collection(db, 'chatMessages'), orderBy('ts', 'asc'), limit(200));
        onSnapshot(q, (snap)=>{
          chatList.innerHTML = '';
          snap.forEach(s => chatList.appendChild(renderMsg(s)));

          // ha zárva van a panel és jött új másik felhasználótól származó msg, számláljuk
          const latest = snap.docs[snap.docs.length-1];
          if (!panelOpen && latest){
            const d = latest.data();
            const t = d.ts?.toMillis ? d.ts.toMillis() : Date.now();
            if (d.uid !== auth.currentUser.uid && t > lastSeenTs){
              unseenCount++;
              chatBadge.textContent = unseenCount;
              chatBadge.hidden = unseenCount <= 0;
            }
          }

          // ha nyitva, görgess az aljára
          if (panelOpen){
            chatList.scrollTop = chatList.scrollHeight;
          }
        });

        function openChat(){
          panelOpen = true;
          chatPanel.hidden = false;
          unseenCount = 0;
          chatBadge.hidden = true;
          lastSeenTs = Date.now();
          setTimeout(()=>{ chatList.scrollTop = chatList.scrollHeight; }, 0);
        }
        function closeChat(){
          panelOpen = false;
          chatPanel.hidden = true;
          lastSeenTs = Date.now();
        }

        chatFab.addEventListener('click', openChat);
        chatClose.addEventListener('click', closeChat);

        chatSend.addEventListener('click', async ()=>{
          const text = (chatInput.value || '').trim();
          if (!text) return;
          chatSend.disabled = true;
          try{
            await addDoc(collection(db, 'chatMessages'), {
              uid: auth.currentUser.uid,
              nick: nickname || 'Ismeretlen',
              text,
              ts: serverTimestamp()
            });
            chatInput.value = '';
            chatList.scrollTop = chatList.scrollHeight;
          }catch(e){
            console.warn(e);
            alert('Nem sikerült elküldeni az üzenetet.');
          }finally{
            chatSend.disabled = false;
          }
        });
        chatInput.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter' && !e.shiftKey){
            e.preventDefault();
            chatSend.click();
          }
        });

        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(() => {
          window.location.href = "login.html";
        });
      });
    });
  </script>
</head>
<body>
  <div class="layout">
    <!-- Fejléc -->
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>NB1 TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
      </div>
      <div>
        <button id="logout">Kilépés</button>
      </div>
    </div>

    <!-- Kártyás fő navigáció -->
    <nav class="nav-grid">
      <a class="nav-card" href="matches.html">
        <div class="icon-wrap" aria-hidden="true">
          <!-- soccer ball -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1.7 3.5 1.7-1.2 1.7 1.2-.6 2 1.6 1.2h-2L12 7.2l-1.7 1.5h-2l1.6-1.2-.6-2ZM6.2 9.3l1.9-.3.9 1.7-.8 1.8-1.8.2-1.2-1.6 1-1.8Zm11.6 0 1 1.8-1.2 1.6-1.8-.2-.8-1.8.9-1.7 1.9.3ZM8.9 17.9l-.7-1.9 1.5-1.2h1.9l.9 1.7-1.5 1.4-2.1 0Zm6.2 0-2.1 0-1.5-1.4.9-1.7h1.9l1.5 1.2-.7 1.9Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span>
          <span class="desc">Közelgő meccsek & tippek</span>
        </div>
      </a>

      <a class="nav-card" href="positions.html">
        <div class="icon-wrap" aria-hidden="true">
          <!-- podium -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg>
        </div>
        <div class="text">
          <span class="title">Szezon végi sorrend</span>
          <span class="desc">12 csapat – húzd a helyekre</span>
        </div>
      </a>

      <a class="nav-card" href="results.html">
        <div class="icon-wrap" aria-hidden="true">
          <!-- clipboard list -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2Zm0 4h6V4H9v2Zm1 6h8v2h-8v-2Zm0 4h8v2h-8v-2ZM6 10h3v2H6v-2Zm0 4h3v2H6v-2Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Eredmények</span>
          <span class="desc">Fordulónkénti bontás</span>
        </div>
      </a>

      <a class="nav-card" href="leaderboard.html">
        <div class="icon-wrap" aria-hidden="true">
          <!-- trophy -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2Zm-2 2H9V3h6v2ZM4 6a3 3 0 0 0 3 3h1a4 4 0 0 1-1-3V5H4v1Zm16-1h-3v1a4 4 0 0 1-1 3h1a3 3 0 0 0 3-3V5Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Összpontszám</span>
          <span class="desc">Toplista & bónusz</span>
        </div>
      </a>

      <a class="nav-card" href="profile.html">
        <div class="icon-wrap" aria-hidden="true">
          <!-- user -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Profil</span>
          <span class="desc">Beállítások & kedvenc csapat</span>
        </div>
      </a>

      <a class="nav-card" id="adminLink" href="admin.html" style="display:none;">
        <div class="icon-wrap" aria-hidden="true">
          <!-- settings -->
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Zm8.94 4a6.94 6.94 0 0 0-.12-1l2.02-1.56-2-3.46-2.44 1a6.9 6.9 0 0 0-1.74-1l-.37-2.6H9.71l-.37 2.6a6.9 6.9 0 0 0-1.74 1l-2.44-1-2 3.46L5.18 11a7 7 0 0 0 0 2l-2.02 1.56 2 3.46 2.44-1a6.9 6.9 0 0 0 1.74 1l.37 2.6h4.56l.37-2.6a6.9 6.9 0 0 0 1.74-1l2.44 1 2-3.46L20.82 13a6.94 6.94 0 0 0 .12-1Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Admin</span>
          <span class="desc">Szezon-zár & beállítások</span>
        </div>
      </a>
    </nav>

    <!-- Tartalomkártyák -->
    <div class="content-grid">
      <section class="card table-wrap">
        <h3>NB I tabella</h3>
        <div id="tableContainer"></div>
      </section>

      <section class="card">
        <h3>Csapatod hírei</h3>
        <div id="facebookFeedContainer"></div>
      </section>
    </div>
  </div>

  <!-- Lebegő chat UI -->
  <div id="chatFab" class="chat-fab" title="Közösségi chat megnyitása">💬 <span id="chatBadge" class="chat-badge" hidden>0</span></div>

  <div id="chatPanel" class="chat-panel" hidden>
    <div class="chat-header">
      <span>Közösségi chat</span>
      <button id="chatClose" class="chat-close">✕</button>
    </div>
    <div id="chatList" class="chat-list"></div>
    <div class="chat-input">
      <input id="chatInput" type="text" placeholder="Írj üzenetet… (Enter küld)" maxlength="1000">
      <button id="chatSend">Küldés</button>
    </div>
  </div>
</body>
</html>
