<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="loader.js" defer></script>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e6eaf1; --text:#0f172a; --muted:#64748b;
      --accent:#3b82f6; --ok:#16a34a; --warn:#b45309;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; padding:24px; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
    }

    /* fejléc + nav */
    h1{ margin:0 0 6px; font-size:22px }
    #welcome{ margin:0 0 12px; color:var(--muted) }
    nav{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:0 0 18px }
    nav a{ text-decoration:none; color:#111; background:#eef2ff; border:1px solid var(--line); padding:8px 10px; border-radius:10px }
    nav a:hover{ background:#e5e7eb }
    nav button{ border:0; background:#ef4444; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }

    /* badge a Meccstippekhez */
    .pill-badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:18px; height:18px; padding:0 6px; margin-left:6px;
      border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700; line-height:1;
    }
    .pill-badge[hidden]{ display:none !important; }

    /* fő tartalom kártyákban */
    .wrap{ display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      box-shadow:0 6px 18px rgba(15,23,42,.05);
      padding:12px;
    }
    .card header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 4px 10px }
    .muted{ color:var(--muted) }

    /* bal: tabella */
    #tableCard{ flex:1 1 520px; min-width:320px }
    #tableContainer img{ max-width:100%; height:auto; display:block; border-radius:10px }

    /* jobb: FB feed */
    #fbCard{ flex:1 1 520px; min-width:320px }
    .fb-frame-wrap{
      border-radius:10px; overflow:hidden; /* << keret/görgető eltűnik */
      border:1px solid var(--line);
    }
    .fb-frame{
      width:100%; height:540px; border:0; overflow:hidden;
      display:block; background:#fff;
    }

    /* ----- mini chat (jobb alsó sarok) ----- */
    .chat-fab{
      position:fixed; right:18px; bottom:18px; z-index:60;
      width:48px; height:48px; border-radius:50%;
      background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center;
      box-shadow:0 8px 20px rgba(59,130,246,.35); cursor:pointer; border:0;
    }
    .chat-panel{
      position:fixed; right:18px; bottom:78px; z-index:60;
      width:320px; max-height:60vh; background:var(--card); border:1px solid var(--line); border-radius:12px;
      box-shadow:0 16px 36px rgba(15,23,42,.2); display:none; overflow:hidden;
    }
    .chat-panel.open{ display:flex; flex-direction:column }
    .chat-head{ padding:10px 12px; background:#f7f9fd; border-bottom:1px solid var(--line); font-weight:700; display:flex; align-items:center; justify-content:space-between }
    .chat-list{ padding:10px 12px; overflow:auto; flex:1; }
    .msg{ margin:8px 0; }
    .msg .meta{ font-size:11px; color:var(--muted) }
    .msg .bubble{
      display:inline-block; background:#f1f5ff; border:1px solid var(--line); border-radius:10px; padding:8px 10px; max-width:90%;
      white-space:pre-wrap; word-break:break-word;
    }
    .mine .bubble{ background:#e6f7ff; border-color:#cfe8ff }
    .chat-send{ padding:10px; border-top:1px solid var(--line); display:flex; gap:8px }
    .chat-send input{ flex:1; padding:8px 10px; border:1px solid var(--line); border-radius:10px }
    .chat-send button{ border:0; background:var(--accent); color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
    .chat-empty{ color:var(--muted); text-align:center; padding:12px 0 }

    @media (max-width: 980px){
      .chat-panel{ width:92vw; right:4vw }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc,
      collection, getDocs, addDoc,
      query, where, orderBy, limit, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const facebookLinks = {
      "Ferencváros": "https://www.facebook.com/fradi.hu",
      "Újpest FC": "https://www.facebook.com/ujpestfootballclub",
      "Debreceni VSC": "https://www.facebook.com/dvscfoci",
      "Nyíregyháza Spartacus": "https://www.facebook.com/NYSFC",
      "Paksi FC": "https://www.facebook.com/paksifcofficialsite",
      "Kazincbarcikai SC": "https://www.facebook.com/kolorcitykbsc",
      "Puskás Akadémia": "https://www.facebook.com/PFLAhu",
      "Kisvárda FC": "https://www.facebook.com/kisvardafc",
      "Diósgyőri VTK": "https://www.facebook.com/DVTK1910",
      "Zalaegerszegi TE FC": "https://www.facebook.com/ztefc.hu",
      "ETO FC Győr": "https://www.facebook.com/etofcgyor",
      "MTK Budapest": "https://www.facebook.com/MTKBudapest"
    };

    let currentEmail = null;
    let currentNick = null;

    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }

        currentEmail = user.email;
        let role = "user";
        let favoriteTeam = "";

        const userRef = doc(db, "users", currentEmail);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          currentNick = data.nickname || currentEmail;
          role = data.role || "user";
          favoriteTeam = data.favoriteTeam || "";
        } else {
          currentNick = currentEmail;
        }

        document.getElementById("welcome").textContent = `Üdv, ${currentNick}!`;
        if (role === "admin") document.getElementById("adminLink").style.display = "inline";

        // Tabella
        const tableDoc = await getDoc(doc(db, "settings", "nbi_table_image"));
        if (tableDoc.exists()) {
          const base64 = tableDoc.data().base64;
          const img = document.createElement("img");
          img.src = `data:image/png;base64,${base64}`;
          img.alt = "NB1 tabella";
          document.getElementById("tableContainer").appendChild(img);
        } else {
          document.getElementById("tableContainer").innerHTML = "<div class='muted'>Még nincs feltöltött tabella.</div>";
        }

        // Facebook – eltüntetett keret/scroll
        const params = new URLSearchParams(window.location.search);
        const nofb = params.get("nofb") === "1";
        const fbLink = facebookLinks[favoriteTeam];

        if (!nofb && fbLink) {
          const fbWrap = document.getElementById("fbWrap");
          fbWrap.innerHTML = `
            <iframe class="fb-frame"
              src="https://www.facebook.com/plugins/page.php?href=${encodeURIComponent(fbLink)}&tabs=timeline&width=520&height=540&small_header=true&adapt_container_width=true&hide_cover=true&show_facepile=false"
              scrolling="no" frameborder="0" allow="encrypted-media; picture-in-picture; web-share" allowfullscreen="true">
            </iframe>`;
        } else {
          document.getElementById("fbWrap").innerHTML = "<div class='muted'>Facebook-idővonal kikapcsolva.</div>";
        }

        // Tipp badge (mennyi közelgő meccsre nincs tipped)
        try{
          const now = new Date();
          const upcomingSnap = await getDocs(query(collection(db,"matches"), where("startTime", ">=", now)));
          const upcoming = upcomingSnap.docs.map(d => ({ id:d.id, ...d.data() }));
          const myTipsSnap = await getDocs(query(collection(db,"tips"), where("user","==", currentEmail)));
          const tipped = new Set(myTipsSnap.docs.map(d => d.data().matchId));
          const pending = upcoming.filter(m => !tipped.has(m.id)).length;
          const badge = document.getElementById("tipsBadge");
          if (pending>0){ badge.hidden=false; badge.textContent=pending; badge.title=`${pending} közelgő meccsre nincs tipped`; }
        }catch(e){ console.warn("Badge:", e) }

        // Chat indítása
        initChat();

        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(()=> window.location.href="login.html");
      });

      // Chat UI toggle
      document.getElementById("chatFab").addEventListener("click", ()=>{
        document.getElementById("chatPanel").classList.toggle("open");
        if (document.getElementById("chatPanel").classList.contains("open")){
          setTimeout(()=> scrollChatBottom(), 100);
        }
      });
    });

    // -------- Mini Chat (Firestore: chatMessages) --------
    let unsubChat = null;

    function scrollChatBottom(){
      const list = document.getElementById("chatList");
      list.scrollTop = list.scrollHeight;
    }

    async function initChat(){
      const list = document.getElementById("chatList");
      list.innerHTML = "<div class='chat-empty'>Csatlakozás a chathez…</div>";

      // realtime
      const q = query(collection(db,"chatMessages"), orderBy("ts","asc"), limit(100));
      unsubChat = onSnapshot(q, (snap)=>{
        list.innerHTML = "";
        if (snap.empty){
          list.innerHTML = "<div class='chat-empty'>Még nincs üzenet. Légy te az első! 🙂</div>";
        } else {
          snap.forEach(docu=>{
            const m = docu.data();
            const you = (m.userEmail === currentEmail);
            const row = document.createElement("div");
            row.className = "msg"+(you?" mine":"");
            const time = m.ts?.toDate ? m.ts.toDate().toLocaleString("hu-HU",{hour:"2-digit",minute:"2-digit"}) : "";
            row.innerHTML = `
              <div class="meta">${m.nickname || m.userEmail || "Ismeretlen"} • ${time}</div>
              <div class="bubble">${(m.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</div>`;
            list.appendChild(row);
          });
        }
        scrollChatBottom();
      });

      // küldés
      document.getElementById("chatSendBtn").addEventListener("click", sendChat);
      document.getElementById("chatInput").addEventListener("keydown", (e)=>{
        if (e.key === "Enter"){ e.preventDefault(); sendChat(); }
      });
    }

    async function sendChat(){
      const inp = document.getElementById("chatInput");
      const text = (inp.value||"").trim();
      if (!text) return;
      try{
        await addDoc(collection(db,"chatMessages"), {
          userEmail: currentEmail,
          nickname: currentNick || currentEmail,
          text,
          ts: serverTimestamp()
        });
        inp.value = "";
        scrollChatBottom();
      }catch(e){
        alert("Üzenetküldési hiba: "+(e?.message||e));
      }
    }
  </script>
</head>
<body>
  <h1>NB1 TippLiga</h1>
  <p id="welcome" class="muted"></p>

  <nav>
    <a href="matches.html">🔮 Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></a>
    <a href="results.html">📋 Eredmények</a>
    <a href="leaderboard.html">🏆 Összpontszám</a>
    <a href="positions.html">📊 Szezon végi sorrend tipp</a>
    <a href="profile.html">👤 Profil</a>
    <a href="admin.html" id="adminLink" style="display:none;">⚙️ Admin felület</a>
    <button id="logout">Kilépés</button>
  </nav>

  <div class="wrap">
    <section id="tableCard" class="card">
      <header><strong>Tabella</strong></header>
      <div id="tableContainer"></div>
    </section>

    <section id="fbCard" class="card">
      <header><strong>Kedvenc csapat – Facebook idővonal</strong> <span class="muted">(keret nélkül)</span></header>
      <div class="fb-frame-wrap" id="fbWrap"></div>
    </section>
  </div>

  <!-- Mini chat -->
  <button id="chatFab" class="chat-fab" title="Megnyitás">
    💬
  </button>
  <div id="chatPanel" class="chat-panel" aria-live="polite">
    <div class="chat-head">
      <div>Közösségi chat</div>
      <button style="border:0;background:transparent;cursor:pointer" onclick="document.getElementById('chatPanel').classList.remove('open')">✕</button>
    </div>
    <div id="chatList" class="chat-list"></div>
    <div class="chat-send">
      <input id="chatInput" placeholder="Írj üzenetet… (Enter küldi)" />
      <button id="chatSendBtn">Küld</button>
    </div>
  </div>
</body>
</html>
