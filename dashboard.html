<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="style-themed.css" />
  <div id="fb-root"></div>
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/hu_HU/sdk.js#xfbml=1&version=v19.0" nonce="fb"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const auth = getAuth(app);
    const db = getFirestore(app);

    const fbPages = {
      "Debreceni VSC": "https://www.facebook.com/DVSCfoci/",
      "Diósgyőri VTK": "https://www.facebook.com/DVTKOfficial/",
      "Ferencváros": "https://www.facebook.com/fradi.hu/",
      "ETO FC Győr": "https://www.facebook.com/EtoFCGyorOfficial/",
      "Kazincbarcikai SC": "https://www.facebook.com/KazincbarcikaiSC/",
      "Kisvárda FC": "https://www.facebook.com/Kisvardafc/",
      "MTK Budapest": "https://www.facebook.com/mtkbudapestofficial/",
      "Nyíregyháza Spartacus": "https://www.facebook.com/NYSFC/",
      "Paksi FC": "https://www.facebook.com/PaksiFootballClub/",
      "Puskás Akadémia": "https://www.facebook.com/puskasakademiafc/",
      "Újpest FC": "https://www.facebook.com/ujpestfcofficial/",
      "Zalaegerszegi TE FC": "https://www.facebook.com/ztefcofficial/"
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "login.html";

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      if (!snap.exists()) return alert("Felhasználói adatok nem találhatók.");
      const { nickname = user.email, favoriteTeam = "" } = snap.data();

      document.getElementById("welcome").textContent = `Üdv, ${nickname}!`;

      if (favoriteTeam) {
        const themeClass = "theme-" + favoriteTeam.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-');
        document.body.classList.add(themeClass);

        const logoImg = document.getElementById("teamLogo");
        logoImg.src = `crest/crest-${themeClass.replace("theme-", "")}.png`;
        logoImg.alt = favoriteTeam;

        const fbContainer = document.getElementById("fb-container");
        const pageUrl = fbPages[favoriteTeam];
        if (pageUrl) {
          fbContainer.innerHTML = `
            <div class="fb-page" data-href="${pageUrl}" data-tabs="timeline" data-width="400" data-height="500" 
              data-small-header="false" data-adapt-container-width="true" 
              data-hide-cover="false" data-show-facepile="true"></div>`;
          if (window.FB) window.FB.XFBML.parse(fbContainer);
        }
      }

      const tableDoc = await getDoc(doc(db, "settings", "nbi_table_image"));
      if (tableDoc.exists()) {
        const img = document.createElement("img");
        img.src = `data:image/png;base64,${tableDoc.data().base64}`;
        img.style.maxWidth = "60%";
        document.getElementById("tableContainer").appendChild(img);
      }
    });

    document.getElementById("logoutButton").addEventListener("click", () => {
      signOut(auth).then(() => window.location.href = "login.html");
    });
  </script>
</head>
<body>
  <header>
    <h1>NB1 TippLiga</h1>
    <img id="teamLogo" style="height:40px; vertical-align: middle; margin-left:10px;">
  </header>
  <p id="welcome"></p>
  <nav>
    <a href="matches.html">Meccsek és tippek</a> |
    <a href="results.html">Eredmények</a> |
    <a href="leaderboard.html">Összpontszám</a> |
    <a href="positions.html">Szezon végi sorrend</a> |
    <a href="profile.html">Profil</a> |
    <a id="adminLink" href="admin.html" style="display:none;">Admin felület</a> |
    <button id="logoutButton">Kilépés</button>
  </nav>

  <div style="display:flex; gap:20px;">
    <div id="tableContainer"></div>
    <div id="fb-container"></div>
  </div>
</body>
</html>
