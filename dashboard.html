<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#2563eb;--primary-600:#1d4ed8;--danger:#ef4444;--border:#e5e7eb;--shadow:0 6px 25px rgba(15,23,42,.08)}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topbar .left,.topbar .right{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#fff;color:#111827;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .cards{display:grid;grid-template-columns:1fr;gap:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;background:linear-gradient(180deg,#fff,#fafafa)}
    .card-head h3{margin:0;font-size:16px}
    .card-head .hint{color:var(--muted);font-size:12px}
    .card-body{display:none;padding:16px;border-top:1px solid var(--border)}
    .card.open .card-body{display:block}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{background:#f9fafb;color:#334155;font-weight:600}
    .muted{color:var(--muted)}
    .xscroll{overflow:auto}
    .teamcell{display:flex;align-items:center;gap:8px}
    .crest{width:22px;height:22px;object-fit:contain;border-radius:6px;border:1px solid var(--border);background:#fff}
    .small{font-size:12px}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, Timestamp, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = { apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc", authDomain:"tippliga-4b3af.firebaseapp.com", projectId:"tippliga-4b3af", storageBucket:"tippliga-4b3af.appspot.com", messagingSenderId:"720359845241", appId:"1:720359845241:web:d3d6edcac6b43ebff053a8" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const TEAMS = ["Debreceni VSC","Diósgyőri VTK","Ferencváros","ETO FC Győr","Kazincbarcikai SC","Kisvárda FC","MTK Budapest","Nyíregyháza Spartacus","Paksi FC","Puskás Akadémia","Újpest FC","Zalaegerszegi TE FC"];

    // Címerfájlok – tedd a képeket a megadott elérési útra; ha hiányzik, az img elrejti magát
    const CRESTS = {
      "Debreceni VSC": "crests/crest-dvsc.png",
      "Diósgyőri VTK": "crests/crest-dvtk.png",
      "Ferencváros": "crests/crest-fradi.png",
      "ETO FC Győr": "crests/crest-gyor.png",
      "Kazincbarcikai SC": "crests/crest-kazincbarcika.png",
      "Kisvárda FC": "crests/crest-kisvarda.png",
      "MTK Budapest": "crests/crest-mtk.png",
      "Nyíregyháza Spartacus": "crests/crest-nyiregyhaza.png",
      "Paksi FC": "crests/crest-paks.png",
      "Puskás Akadémia": "crests/crest-puskas.png",
      "Újpest FC": "crests/crest-ujpest.png",
      "Zalaegerszegi TE FC": "crests/crest-zte.png"
    };

    // --- Helper: result "2-1" -> {hg, ag}
    function parseGoals(res){
      if(!res || typeof res!=="string") return null;
      const m = res.trim().match(/^(\d+)\s*[-:]\s*(\d+)$/);
      if(!m) return null;
      return { hg: parseInt(m[1],10), ag: parseInt(m[2],10) };
    }

    // --- Táblázat számítás
    function emptyRow(team){ return {team,played:0,wins:0,draws:0,losses:0,gf:0,ga:0,gd:0,points:0}; }
    function applyResult(h,a,hg,ag){
      h.played++; a.played++;
      h.gf+=hg; h.ga+=ag; a.gf+=ag; a.ga+=hg;
      h.gd=h.gf-h.ga; a.gd=a.gf-a.ga;
      if(hg>ag){ h.wins++; a.losses++; h.points+=3; }
      else if(hg<ag){ a.wins++; h.losses++; a.points+=3; }
      else{ h.draws++; a.draws++; h.points++; a.points++; }
    }
    function groupKey(r){ return [r.points,r.wins,r.gd,r.gf].join("|"); }
    function miniStats(groupTeams, matches){
      const set = new Set(groupTeams);
      const m = new Map(groupTeams.map(t=>[t,{pts:0,gd:0}]));
      for(const x of matches){
        if(set.has(x.homeTeam) && set.has(x.awayTeam)){
          if(x.homeGoals>x.awayGoals) m.get(x.homeTeam).pts += 3;
          else if(x.homeGoals<x.awayGoals) m.get(x.awayTeam).pts += 3;
          else { m.get(x.homeTeam).pts++; m.get(x.awayTeam).pts++; }
          m.get(x.homeTeam).gd += (x.homeGoals - x.awayGoals);
          m.get(x.awayTeam).gd += (x.awayGoals - x.homeGoals);
        }
      }
      return m;
    }
    function officialSort(rows, playedMatches){
      rows.sort((a,b)=>{
        if(b.points!==a.points) return b.points-a.points;
        if(b.wins!==a.wins) return b.wins-a.wins;
        if(b.gd!==a.gd) return b.gd-a.gd;
        if(b.gf!==a.gf) return b.gf-a.gf;
        return a.team.localeCompare(b.team); // ideiglenes, H2H előtt
      });
      let i=0;
      while(i<rows.length){
        const k = groupKey(rows[i]); let j=i+1;
        while(j<rows.length && groupKey(rows[j])===k) j++;
        if(j-i>1){
          const teams = rows.slice(i,j).map(r=>r.team);
          const h2h = miniStats(teams, playedMatches);
          rows.splice(i, j-i, ...rows.slice(i,j).sort((x,y)=>{
            if(h2h.get(y.team).pts!==h2h.get(x.team).pts) return h2h.get(y.team).pts - h2h.get(x.team).pts;
            if(h2h.get(y.team).gd!==h2h.get(x.team).gd) return h2h.get(y.team).gd - h2h.get(x.team).gd;
            return x.team.localeCompare(y.team);
          }));
        }
        i=j;
      }
      return rows;
    }

    async function computeStandingsFullSeason(){
      const table = new Map(TEAMS.map(t=>[t, emptyRow(t)]));
      const played = [];
      const snap = await getDocs(collection(db,"matches"));
      snap.forEach(ds=>{
        const d = ds.data()||{};
        if(!TEAMS.includes(d.homeTeam) || !TEAMS.includes(d.awayTeam)) return;
        const g = parseGoals(d.result);
        if(!g) return; // csak rögzített eredmények számítanak
        const h = table.get(d.homeTeam), a = table.get(d.awayTeam);
        applyResult(h,a,g.hg,g.ag);
        played.push({ homeTeam:d.homeTeam, awayTeam:d.awayTeam, homeGoals:g.hg, awayGoals:g.ag });
      });
      const rows = officialSort([...table.values()], played);
      return rows;
    }
    async function saveStandings(rows){
      await setDoc(doc(db,"standings","current"), { updatedAt: Date.now(), rows }, { merge:true });
    }
    async function loadStandings(){
      const s = await getDoc(doc(db,"standings","current"));
      return s.exists()? (s.data().rows||[]) : [];
    }

    // --- Render
    function crestImg(team){
      const src = CRESTS[team] || "";
      return `<img class="crest" src="${src}" alt="" onerror="this.style.display='none'">`;
    }
    function renderStandings(rows, updatedAt){
      const wrap = document.getElementById("tableContainer");
      const meta = document.getElementById("tableMeta");
      const html = `
        <table>
          <thead>
            <tr>
              <th>H</th><th>Csapat</th><th>M</th><th>Gy</th><th>D</th><th>V</th><th>Lg</th><th>Kg</th><th>GK</th><th>P</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r,i)=>`
              <tr>
                <td>${i+1}</td>
                <td><div class="teamcell">${crestImg(r.team)} <span>${r.team}</span></div></td>
                <td>${r.played}</td><td>${r.wins}</td><td>${r.draws}</td><td>${r.losses}</td>
                <td>${r.gf}</td><td>${r.ga}</td><td>${r.gd}</td><td>${r.points}</td>
              </tr>`).join("")}
          </tbody>
        </table>`;
      wrap.innerHTML = html;
      meta.textContent = updatedAt ? ("Frissítve: " + new Date(updatedAt).toLocaleString("hu-HU")) : "";
    }

    // --- UI
    onAuthStateChanged(auth, async (user) => {
      if(!user){
        document.body.innerHTML = "<h2 style='padding:20px'>⛔ Jelentkezz be a folytatáshoz.</h2>";
        return;
      }
      initUI();
      // betöltjük az elmentett táblát (ha van)
      const s = await getDoc(doc(db,"standings","current"));
      if(s.exists()){
        const d = s.data()||{};
        renderStandings(d.rows||[], d.updatedAt||null);
      }
    });

    function initUI(){
      const top=document.createElement("div"); top.className="topbar";
      const left=document.createElement("div"); left.className="left";
      const right=document.createElement("div"); right.className="right";
      const toAdmin=document.createElement("button"); toAdmin.className="btn"; toAdmin.textContent="⚙️ Admin"; toAdmin.onclick=()=>location.href="admin.html";
      const logout=document.createElement("button"); logout.className="btn"; logout.textContent="Kijelentkezés"; logout.onclick=()=>signOut(auth);
      left.appendChild(toAdmin); right.append(logout); top.append(left,right); document.body.appendChild(top);

      const wrap=document.createElement("div"); wrap.className="cards"; document.body.appendChild(wrap);

      // --- NB1 Tabella (új kártya)
      const cTable=document.createElement("section"); cTable.className="card open";
      cTable.innerHTML = `
        <div class="card-head">
          <h3>NB1 Tabella</h3>
          <div class="hint">Hivatalos sorrend (H2H GK-ig)</div>
        </div>
        <div class="card-body">
          <div class="row" style="justify-content:space-between">
            <div class="small muted" id="tableMeta"></div>
            <div style="display:flex;gap:8px">
              <button class="btn" id="btnReloadSaved">Elmentett állapot betöltése</button>
              <button class="btn primary" id="btnRecompute">Tabella frissítése</button>
            </div>
          </div>
          <div id="tableContainer" class="xscroll" style="margin-top:10px"></div>
          <div class="small muted" style="margin-top:6px">Rendezés: pont → győzelem → GK → lőtt gól → egymás elleni pont → egymás elleni GK</div>
        </div>`;
      wrap.appendChild(cTable);

      document.getElementById("btnReloadSaved").onclick = async ()=>{
        const s = await getDoc(doc(db,"standings","current"));
        if(!s.exists()){ alert("Még nincs elmentett tabella."); return; }
        const d = s.data()||{};
        renderStandings(d.rows||[], d.updatedAt||null);
      };

      document.getElementById("btnRecompute").onclick = async ()=>{
        const btn = document.getElementById("btnRecompute");
        btn.disabled = true;
        try{
          const rows = await computeStandingsFullSeason();
          await setDoc(doc(db,"standings","current"), { updatedAt: Date.now(), rows }, { merge:true });
          renderStandings(rows, Date.now());
        } finally {
          btn.disabled = false;
        }
      };
    }
  </script>
</head>
<body></body>
</html>
