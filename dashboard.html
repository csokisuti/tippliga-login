<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>NB1 TippLiga</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="fav2.png" sizes="16x16">
  <link rel="icon" type="image/png" href="fav2.png" sizes="32x32">
  <link rel="icon" type="image/png" href="fav2.png">
  <script src="loader.js" defer></script>

  <style>
    .layout{
      display:flex; flex-direction:column; gap:16px;
      max-width:1200px; margin:0 auto; padding:20px;
    }
    .content-grid{
      display:grid; grid-template-columns: 1.2fr 1fr; gap:16px;
    }
    @media (max-width: 1000px){
      .content-grid{ grid-template-columns: 1fr; }
    }

    .header{ display:flex; align-items:center; justify-content:space-between; gap:14px; }
    .header-left{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .fav-crest{ width:46px; height:46px; object-fit:contain; border-radius:8px; border:1px solid var(--line,#e6eaf1); background:#fff; }
    .welcome{ color:var(--muted,#64748b); margin:4px 0 0; }

    /* liga-váltó balra, a cím mellé */
    .league-switch-left{ margin-left:8px; }
    @media (max-width:700px){ .league-switch-left{ width:100%; margin-left:0; } }

    .nav-grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:14px;
    }
    @media (max-width: 1100px){
      .nav-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (max-width: 700px){
      .nav-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    .nav-card{
      display:flex; gap:12px; align-items:center; text-decoration:none; color:inherit;
      padding:14px; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px;
      box-shadow:0 6px 18px rgba(15,23,42,.05);
    }
    .nav-card .icon-wrap{
      position:relative;
      width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center;
      background:color-mix(in oklab, var(--accent,#3b82f6) 15%, white);
      color:var(--accent,#3b82f6);
    }
    .nav-card .text{ display:flex; flex-direction:column; line-height:1.2; }
    .nav-card .title{ font-weight:800; }
    .nav-card .desc{ color:var(--muted,#64748b); font-size:12px; }

    .card{
      background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .card h3{ margin:0; padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd; }

    /* tabella kártya – gomb a cím mellé */
    .card-head-row{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd;
    }
    .card-head-row h3{ margin:0; padding:0; border:0; background:transparent; }

    .table-wrap{ overflow:auto; }
    .pill-badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:18px; height:18px; padding:0 6px; margin-left:6px;
      border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700;
      line-height:1; vertical-align:middle;
    }
    .pill-badge[hidden]{ display:none !important; }

    .fb-wrap iframe{
      width:100%; height:540px; border:0; overflow:hidden;
    }

    .chat-fab{
      position:fixed; right:22px; bottom:22px; z-index:999;
      width:52px; height:52px; border-radius:999px; border:0;
      background:var(--accent,#3b82f6); color:#fff; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 8px 26px rgba(0,0,0,.15);
    }
    .chat-fab .fab-badge{
      position:absolute; top:-4px; right:-4px;
      min-width:20px; height:20px; padding:0 6px;
      border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:800; line-height:20px; display:none;
    }
    .chat-fab.has-unread .fab-badge{ display:inline-block; }

    .chat-panel{
      position:fixed; right:22px; bottom:86px; z-index:998;
      width:380px; max-width:calc(100vw - 32px); max-height:70vh; display:none; flex-direction:column;
      background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 10px 32px rgba(0,0,0,.14);
    }
    .chat-panel.open{ display:flex; }
    .chat-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd;
    }
    .chat-title{ font-weight:800; }
    #chatClose{
      width:28px; height:28px; border-radius:8px;
      font-size:18px; line-height:28px;
      display:inline-flex; align-items:center; justify-content:center;
      background:#eef2ff; color:#111; border:1px solid var(--line,#e6eaf1); cursor:pointer;
    }
    #chatClose:hover{ filter:brightness(0.95); }

    .chat-list{ overflow:auto; padding:8px 10px; }
    .chat-empty{ color:var(--muted,#64748b); font-size:13px; padding:8px 10px; }

    .msg{ padding:8px 10px; border-bottom:1px solid var(--line,#e6eaf1); display:flex; gap:8px; align-items:flex-start; }
    .msg .meta{ font-size:12px; color:var(--muted,#64748b); margin-bottom:2px; }
    .msg .text{ white-space:pre-wrap; word-break:break-word; }
    .msg .del{
      margin-left:auto; background:#fee2e2; color:#991b1b; border:1px solid #fecaca;
      padding:2px 8px; border-radius:8px; font-size:12px; cursor:pointer; display:none;
    }
    .msg:hover .del{ display:inline-block; }

    #chatComposer{
      display:flex; gap:8px; align-items:center;
      padding:10px; border-top:1px solid var(--line,#e6eaf1); background:#fff;
    }
    #chatInput{
      background:#fff; color:#111;
      border:1px solid var(--line,#e6eaf1);
      height:40px; padding:8px 10px; border-radius:10px;
      font-size:14px; outline:none; width:100%; box-sizing:border-box;
    }
    #chatInput::placeholder{ color:#6b7280; }
    #chatSendBtn{
      min-width:90px; padding:8px 12px; border-radius:10px;
      background:var(--accent,#3b82f6); color:#fff; border:0; font-weight:600; cursor:pointer;
    }

    .btn-accent{
      min-height:40px; padding:10px 14px; border-radius:10px;
      background:var(--accent,#3b82f6); color:#fff; border:1px solid var(--line,#e6eaf1);
      font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px;
      box-shadow:0 6px 18px rgba(0,0,0,.08);
      text-decoration:none;
    }
    .btn-accent:hover{ filter:brightness(.95); }
    .btn-accent:focus{ outline:2px solid color-mix(in oklab, var(--accent,#3b82f6) 30%, white); outline-offset:2px; }
    .btn-icon{ width:18px; height:18px; display:inline-block; }

    /* --- Szabályzat modál --- */
    .rules-modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .rules-modal.open{display:flex}
    .rules-dialog{width:min(900px,92vw);max-height:80vh;background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:12px;box-shadow:0 16px 40px rgba(0,0,0,.2);display:flex;flex-direction:column;overflow:hidden}
    .rules-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line,#e6eaf1);background:#f7f9fd}
    .rules-title{font-weight:800}
    .rules-close{width:32px;height:32px;border:1px solid var(--line,#e6eaf1);border-radius:8px;background:#eef2ff;cursor:pointer}
    .rules-body{padding:14px;overflow:auto;line-height:1.5;color:#111;white-space:pre-wrap}
    .rules-body p{margin:0 0 10px}
    .rules-foot{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-top:1px solid var(--line,#e6eaf1);background:#fff}
    .rules-updated{font-size:12px;color:var(--muted,#64748b)}

    /* ===== Onboarding ===== */
    .onb-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1200;display:none;align-items:center;justify-content:center}
    .onb-backdrop.open{display:flex}
    .onb-dialog{width:min(720px,92vw);background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:14px;box-shadow:0 16px 44px rgba(0,0,0,.25);overflow:hidden}
    .onb-head{padding:12px 14px;background:#f7f9fd;border-bottom:1px solid var(--line,#e6eaf1);font-weight:800}
    .onb-body{padding:14px;display:grid;gap:12px}
    .onb-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .onb-foot{padding:12px 14px;background:#fff;border-top:1px solid var(--line,#e6eaf1);display:flex;justify-content:space-between;align-items:center}
    .onb-note{font-size:12px;color:var(--muted,#64748b)}
    .onb-actions{display:flex;gap:8px}
    .onb-btn{border:1px solid var(--line,#e6eaf1);background:#e5e7eb;color:#111;padding:8px 12px;border-radius:10px;font-weight:700;cursor:not-allowed;opacity:.6}
    .onb-btn.ok{background:var(--accent,#3b82f6);color:#fff;border-color:#dbeafe}
    .onb-btn.enabled{cursor:pointer;opacity:1}
    .onb-sel{border:1px solid var(--line,#e6eaf1);border-radius:10px;padding:8px 10px;min-width:260px}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc,
      collection, addDoc, deleteDoc, serverTimestamp,
      query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    import { initLeagueSwitcher } from "./league-switcher.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const crestMap = {
      "Ferencváros": "crest/crest-fradi.png",
      "Újpest FC": "crest/crest-ujpest.png",
      "Debreceni VSC": "crest/crest-dvsc.png",
      "Nyíregyháza Spartacus": "crest/crest-nyiregyhaza.png",
      "Paksi FC": "crest/crest-paks.png",
      "Kazincbarcikai SC": "crest/crest-kazincbarcika.png",
      "Puskás Akadémia": "crest/crest-puskas.png",
      "Kisvárda FC": "crest/crest-kisvarda.png",
      "Diósgyőri VTK": "crest/crest-dvtk.png",
      "Zalaegerszegi TE FC": "crest/crest-zte.png",
      "ETO FC Győr": "crest/crest-gyor.png",
      "MTK Budapest": "crest/crest-mtk.png"
    };

    const facebookLinks = {
      "Ferencváros": "https://www.facebook.com/fradi.hu",
      "Újpest FC": "https://www.facebook.com/ujpestfootballclub",
      "Debreceni VSC": "https://www.facebook.com/dvscfoci",
      "Nyíregyháza Spartacus": "https://www.facebook.com/NYSFC",
      "Paksi FC": "https://www.facebook.com/paksifcofficialsite",
      "Kazincbarcikai SC": "https://www.facebook.com/kolorcitykbsc",
      "Puskás Akadémia": "https://www.facebook.com/PFLAhu",
      "Kisvárda FC": "https://www.facebook.com/kisvardafc",
      "Diósgyőri VTK": "https://www.facebook.com/DVTK1910",
      "Zalaegerszegi TE FC": "https://www.facebook.com/ztefc.hu",
      "ETO FC Győr": "https://www.facebook.com/etofcgyor",
      "MTK Budapest": "https://www.facebook.com/MTKBudapest"
    };

    function fmtTime(ts){
      try{ return ts.toDate().toLocaleString("hu-HU", { hour12:false }); }catch{ return ""; }
    }

    /* ===== OLCSÓ OLVASÁS: computed/nb1_table feliratkozás ===== */
    function subscribeComputedTable(){
      const ref = doc(db, "computed", "nb1_table");
      const wrap = document.getElementById("tableContainer");
      wrap.innerHTML = '<div class="muted" style="padding:12px;">Tabella betöltése…</div>';

      onSnapshot(ref, (snap)=>{
        if(!snap.exists()){
          wrap.innerHTML = '<div class="muted" style="padding:12px;">Még nincs publikált tabella. Az admin felületen számoltasd újra.</div>';
          return;
        }
        const data = snap.data() || {};
        const rows = Array.isArray(data.rows) ? data.rows : [];
        renderComputedTable(rows, data.updatedAt);
      }, (err)=>{
        console.warn("Tabella snapshot hiba:", err);
        wrap.innerHTML = '<div class="muted" style="padding:12px;">Tabella betöltési hiba.</div>';
      });
    }

    function renderComputedTable(rows, updatedAt){
      const crest = {
        "Debreceni VSC":"crest/crest-dvsc.png","Diósgyőri VTK":"crest/crest-dvtk.png","Ferencváros":"crest/crest-fradi.png",
        "ETO FC Győr":"crest/crest-gyor.png","Kazincbarcikai SC":"crest/crest-kazincbarcika.png","Kisvárda FC":"crest/crest-kisvarda.png",
        "MTK Budapest":"crest/crest-mtk.png","Nyíregyháza Spartacus":"crest/crest-nyiregyhaza.png","Paksi FC":"crest/crest-paks.png",
        "Puskás Akadémia":"crest/crest-puskas.png","Újpest FC":"crest/crest-ujpest.png","Zalaegerszegi TE FC":"crest/crest-zte.png"
      };

      const wrap = document.getElementById("tableContainer");
      const tbl = document.createElement("table");
      tbl.style.width = "100%";
      tbl.style.borderCollapse = "separate";
      tbl.style.borderSpacing = "0";

      tbl.innerHTML = `
        <thead>
          <tr>
            <th style="text-align:right;padding:8px 10px;">H</th>
            <th style="padding:8px 10px;">Csapat</th>
            <th style="text-align:right;padding:8px 10px;">M</th>
            <th style="text-align:right;padding:8px 10px;">Gy</th>
            <th style="text-align:right;padding:8px 10px;">D</th>
            <th style="text-align:right;padding:8px 10px;">V</th>
            <th style="text-align:right;padding:8px 10px;">LG</th>
            <th style="text-align:right;padding:8px 10px;">KG</th>
            <th style="text-align:right;padding:8px 10px;">GK</th>
            <th style="text-align:right;padding:8px 10px;">P</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map((r,i)=>`
            <tr>
              <td style="text-align:right;padding:8px 10px;color:#64748b;">${i+1}.</td>
              <td style="padding:8px 10px;display:flex;align-items:center;gap:8px;">
                ${crest[r.team] ? `<img src="${crest[r.team]}" alt="" style="width:22px;height:22px;border-radius:6px;border:1px solid var(--line,#e6eaf1);background:#fff;object-fit:contain">` : ""}
                <strong>${r.team}</strong>
              </td>
              <td style="text-align:right;padding:8px 10px;">${r.MP ?? ""}</td>
              <td style="text-align:right;padding:8px 10px;">${r.W ?? ""}</td>
              <td style="text-align:right;padding:8px 10px;">${r.D ?? ""}</td>
              <td style="text-align:right;padding:8px 10px;">${r.L ?? ""}</td>
              <td style="text-align:right;padding:8px 10px;">${r.GF ?? ""}</td>
              <td style="text-align:right;padding:8px 10px;">${r.GA ?? ""}</td>
              <td style="text-align:right;padding:8px 10px;">${r.GD ?? ""}</td>
              <td style="text-align:right;padding:8px 10px;font-weight:800;">${r.Pts ?? ""}</td>
            </tr>
          `).join("")}
        </tbody>
      `;
      const footerInfo = document.createElement("div");
      footerInfo.className = "muted";
      footerInfo.style.cssText = "padding:8px 10px;border-top:1px solid var(--line,#e6eaf1);font-size:12px;";
      if(updatedAt?.toDate){
        footerInfo.textContent = "Frissítve: " + updatedAt.toDate().toLocaleString("hu-HU", { hour12:false });
      }else{
        footerInfo.textContent = "";
      }

      wrap.innerHTML = "";
      wrap.appendChild(tbl);
      wrap.appendChild(footerInfo);
    }

    let currentUserEmail = "";
    let currentUserNick = "";
    let currentUserRole = "user";
    let favoriteTeam = "";
    let chatLastSeen = null;

    document.addEventListener("DOMContentLoaded", () => {
      // Liga-váltó mount: BAL SZÉL – cím mellett
      initLeagueSwitcher({ mountTarget: document.getElementById('leagueSwitchMount') });

      // Szabályzat modal init
      initRulesModal();

      // Onboarding DOM elemek
      const onbEl  = document.getElementById("onbFav");
      const onbSel = document.getElementById("onbFavSelect");
      const onbRem = document.getElementById("onbRem");
      const onbSave= document.getElementById("onbFavSave");

      if (onbSel) {
        onbSel.innerHTML = `<option value="">– Válassz csapatot –</option>` +
          Object.keys(crestMap).map(t=>`<option value="${t}">${t}</option>`).join("");
        onbSel.addEventListener("change", () => {
          const ok = !!onbSel.value;
          if (onbSave){
            onbSave.disabled = !ok;
            onbSave.classList.toggle("enabled", ok);
          }
        });
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }

        currentUserEmail = user.email;

        const userRef = doc(db, "users", currentUserEmail);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const data = userSnap.data();
          currentUserNick = data.nickname || currentUserEmail;
          currentUserRole = data.role || "user";
          favoriteTeam = data.favoriteTeam || "";
          chatLastSeen = data.chatLastSeen || null;
        } else {
          currentUserNick = currentUserEmail;
          currentUserRole = "user";
          favoriteTeam = "";
          chatLastSeen = null;
        }

        document.getElementById("welcome").textContent = `Üdv, ${currentUserNick}!`;
        if (currentUserRole === "admin") {
          document.getElementById("adminLink").style.display = "flex";
        }

        if (favoriteTeam) {
          const themeClass = "theme-" + favoriteTeam.toLowerCase().normalize("NFD")
            .replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-');
          document.body.classList.add(themeClass);

          const crest = crestMap[favoriteTeam];
          if (crest) {
            const img = document.getElementById("favCrest");
            img.src = crest; img.alt = favoriteTeam; img.hidden = false;
          }
        }

        // Kötelező első beállítás (ha még nincs kedvenc)
        await maybeForceFavoriteSetup(userRef, { onbEl, onbSel, onbRem, onbSave });

        // --- OLCSÓ TABELLAv2: csak a computed doksit figyeljük ---
        subscribeComputedTable();

        try {
          const fbLink = facebookLinks[favoriteTeam];
          if (fbLink) {
            const fbDiv = document.createElement("div");
            fbDiv.className = "fb-wrap";
            fbDiv.innerHTML = `
              <iframe 
                src="https://www.facebook.com/plugins/page.php?href=${encodeURIComponent(fbLink)}&tabs=timeline&width=560&height=540&small_header=false&adapt_container_width=true&hide_cover=false&show_facepile=true&appId"
                scrolling="no" frameborder="0" allowfullscreen="true"
                allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>`;
            document.getElementById("facebookFeedContainer").appendChild(fbDiv);
          }
        } catch(e){ console.warn(e); }

        initChat(userRef);

        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(() => window.location.href = "login.html");
      });
    });

    function initChat(userRef){
      const fab = document.getElementById('chatToggle');
      const fabBadge = document.getElementById('chatFabBadge');
      const panel = document.getElementById('chatPanel');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatMessages');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSendBtn');

      function open(){ panel.classList.add('open'); setTimeout(()=>inputEl?.focus(), 50); markSeen(); }
      function close(){ panel.classList.remove('open'); }
      function toggle(){ panel.classList.contains('open') ? close() : open(); }
      fab.addEventListener('click', toggle);
      closeBtn.addEventListener('click', close);

      let lastSeenMs = chatLastSeen?.toMillis ? chatLastSeen.toMillis() : 0;

      const qAll = query(collection(db,'chatMessages'), orderBy('ts','asc'));
      onSnapshot(qAll, snap => {
        listEl.innerHTML = '';
        if (snap.empty){
          const empty = document.createElement('div');
          empty.className = 'chat-empty';
          empty.textContent = 'Még nincs üzenet. Légy te az első!';
          listEl.appendChild(empty);
        } else {
          let unread = 0;
          snap.forEach(docu=>{
            const d = docu.data();
            const tsMs = d.ts?.toMillis?.() || 0;
            if (tsMs > lastSeenMs) unread++;

            const row = document.createElement('div');
            row.className = 'msg';
            row.innerHTML = `
              <div style="flex:1 1 auto">
                <div class="meta"><strong>${d.nick || 'Ismeretlen'}</strong> • ${d.ts ? fmtTime(d.ts) : ''}</div>
                <div class="text">${(d.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
              </div>
            `;
            const canDelete = (currentUserRole === 'admin') || (d.email === currentUserEmail);
            if (canDelete){
              const del = document.createElement('button');
              del.className = 'del';
              del.textContent = 'Törlés';
              del.title = 'Üzenet törlése';
              del.addEventListener('click', async ()=>{
                try{ await deleteDoc(doc(db, 'chatMessages', docu.id)); }
                catch(e){ console.warn('Del failed', e); }
              });
              row.appendChild(del);
            }
            listEl.appendChild(row);
          });

          if (!panel.classList.contains('open') && unread > 0){
            fab.classList.add('has-unread');
            fabBadge.textContent = unread > 99 ? '99+' : String(unread);
          } else {
            fab.classList.remove('has-unread');
            fabBadge.textContent = '';
          }

          setTimeout(()=>{ listEl.scrollTop = listEl.scrollHeight; }, 0);
        }
      }, err => console.warn('chat snapshot error:', err));

      sendBtn.addEventListener('click', async ()=>{
        const txt = (inputEl.value || '').trim();
        if (!txt){ inputEl.focus(); return; }
        const backup = txt;
        inputEl.value = '';
        try{
          await addDoc(collection(db,'chatMessages'), {
            email: currentUserEmail,
            nick: currentUserNick || 'Ismeretlen',
            text: backup,
            ts: serverTimestamp()
          });
          if (panel.classList.contains('open')) await markSeen();
        }catch(e){
          console.warn('Chat send failed:', e);
          inputEl.value = backup; inputEl.focus();
        }
      });
      inputEl.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
      });

      async function markSeen(){
        try{
          await setDoc(userRef, { chatLastSeen: serverTimestamp() }, { merge:true });
          lastSeenMs = Date.now();
          fab.classList.remove('has-unread');
          fabBadge.textContent = '';
        }catch(e){ console.warn('markSeen failed', e); }
      }
    }

    function initRulesModal(){
      const rulesModal = document.getElementById('rulesModal');
      const openRulesBtn = document.getElementById('openRules');
      const closeRules = document.getElementById('closeRules');
      const closeRules2 = document.getElementById('closeRules2');

      function openRulesModal(){ rulesModal.classList.add('open'); }
      function closeRulesModal(){ rulesModal.classList.remove('open'); }

      openRulesBtn?.addEventListener('click', openRulesModal);
      closeRules?.addEventListener('click', closeRulesModal);
      closeRules2?.addEventListener('click', closeRulesModal);
      rulesModal?.addEventListener('click', (e)=>{ if(e.target===rulesModal) closeRulesModal(); });
    }

    async function maybeForceFavoriteSetup(userRef, refs){
      const { onbEl, onbSel, onbRem, onbSave } = refs || {};
      if (favoriteTeam) return;

      if (onbSave){
        onbSave.disabled = true;
        onbSave.classList.remove("enabled");
      }
      if (onbSel) onbSel.value = "";
      if (onbRem) onbRem.checked = true;
      if (onbEl) onbEl.classList.add("open");

      if (onbSave){
        onbSave.onclick = async ()=>{
          if (!onbSel?.value) return;
          try{
            await setDoc(userRef, {
              favoriteTeam: onbSel.value,
              reminderEmail: !!onbRem?.checked
            }, { merge:true });

            favoriteTeam = onbSel.value;
            const themeClass = "theme-" + favoriteTeam.toLowerCase().normalize("NFD")
              .replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-');
            document.body.classList.add(themeClass);
            const crest = crestMap[favoriteTeam];
            if (crest){
              const img = document.getElementById("favCrest");
              img.src = crest; img.alt = favoriteTeam; img.hidden = false;
            }
            onbEl?.classList.remove("open");
          }catch(e){
            alert("Hiba a beállítás mentésekor. Próbáld újra.");
          }
        };
      }
    }
  </script>
</head>
<body>
  <div class="layout">
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>NB1 TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
        <!-- LIGA / TIPPJÁTÉK VÁLASZTÓ – BAL OLDALON A CÍM MELLETT -->
        <div id="leagueSwitchMount" class="league-switch-left" aria-label="Tippjáték választó"></div>
      </div>

      <div>
        <!-- Kilépés – a régi liga-váltó helyén, jobb oldalon -->
        <button id="logout" class="btn-accent" aria-label="Kilépés">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/>
          </svg>
          Kilépés
        </button>

        <!-- Szabályzat -->
        <button id="openRules" class="btn-accent" style="display:block;margin-top:10px;">Szabályzat</button>
      </div>
    </div>

    <nav class="nav-grid">
      <a class="nav-card" href="dashboard.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3L12 3z"/>
          </svg>
        </div>
        <div class="text">
          <span class="title">Főoldal</span>
          <span class="desc">Tabella, hírek, kedvencek</span>
        </div>
      </a>

      <a class="nav-card" href="positions.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg>
        </div>
        <div class="text">
          <span class="title">Szezon végi sorrend</span>
          <span class="desc">12 csapat – húzd a helyekre</span>
        </div>
      </a>

      <a class="nav-card" href="matches.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1.7 3.5 1.7-1.2 1.7 1.2-.6 2 1.6 1.2h-2L12 7.2l-1.7 1.5h-2l1.6-1.2-.6-2ZM6.2 9.3l1.9-.3.9 1.7-.8 1.8-1.8.2-1.2-1.6 1-1.8Zm11.6 0 1 1.8-1.2 1.6-1.8-.2-.8-1.8.9-1.7 1.9.3ZM8.9 17.9l-.7-1.9 1.5-1.2h1.9l.9 1.7-1.5 1.4-2.1 0Zm6.2 0-2.1 0-1.5-1.4.9-1.7h1.9l1.5 1.2-.7 1.9Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Meccstippek</span>
          <span class="desc">Közelgő meccsek & tippek</span>
        </div>
      </a>

      <a class="nav-card" href="results.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1 2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2Zm0 4h6V4H9v2Zm1 6h8v2h-8v-2Zm0 4h8v2h-8v-2ZM6 10h3v2H6v-2Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Eredmények</span>
          <span class="desc">Fordulónkénti bontás</span>
        </div>
      </a>

      <a class="nav-card" href="leaderboard.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h3a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2Zm-2 2H9V3h6v2ZM4 6a3 3 0 0 0 3 3h1a4 4 0 0 1-1 3h1a3 3 0 0 0 3-3V5Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Összpontszám</span>
          <span class="desc">Toplista & bónusz</span>
        </div>
      </a>

      <a class="nav-card" href="profile.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Profil</span>
          <span class="desc">Beállítások & kedvenc csapat</span>
        </div>
      </a>

      <a class="nav-card" id="adminLink" href="admin.html" style="display:none;">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Zm8.94 4a6.94 6.94 0 0 0-.12-1l2.02-1.56-2-3.46-2.44 1a6.9 6.9 0 0 0-1.74-1l-.37-2.6H9.71l-.37-2.6a6.9 6.9 0 0 0-1.74 1l-2.44-1-2 3.46L5.18 11a7 7 0 0 0 0 2l-2.02 1.56 2 3.46 2.44-1a6.9 6.9 0 0 0 1.74 1l.37 2.6h4.56l.37-2.6a6.9 6.9 0 0 0 1.74-1l2.44 1 2-3.46L20.82 13a6.94 6.94 0 0 0 .12-1Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Admin</span>
          <span class="desc">Szezon-zár & beállítások</span>
        </div>
      </a>
    </nav>

    <!-- Kötelező első beállítás (kedvenc + emlékeztető) -->
    <div id="onbFav" class="onb-backdrop" aria-modal="true" role="dialog" aria-labelledby="onbFavTitle">
      <div class="onb-dialog">
        <div class="onb-head" id="onbFavTitle">Üdv a TippLigában! 🎉</div>
        <div class="onb-body">
          <div>Először <strong>válaszd ki a kedvenc NB I csapatodat</strong>, és döntsd el, kérsz-e e-mailes emlékeztetőt a tippek leadására. <em>Később a Profil oldalon bármikor módosítható.</em></div>
          <div class="onb-row">
            <label for="onbFavSelect"><strong>Kedvenc csapat</strong></label>
            <select id="onbFavSelect" class="onb-sel"></select>
          </div>
          <div class="onb-row">
            <label style="display:flex;align-items:center;gap:10px;">
              <input id="onbRem" type="checkbox" checked>
              <span>E-mailes emlékeztetőt kérek</span>
            </label>
          </div>
        </div>
        <div class="onb-foot">
          <span class="onb-note">Tipp: Ezeket később a <strong>Profil</strong> oldalon is módosíthatod.</span>
          <div class="onb-actions">
            <button id="onbFavSave" class="onb-btn ok" disabled>Mentés és folytatás</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Szabályzat modál -->
    <div id="rulesModal" class="rules-modal" aria-modal="true" role="dialog" aria-labelledby="rulesTitle">
      <div class="rules-dialog">
        <div class="rules-head">
          <div id="rulesTitle" class="rules-title">NB1 TippLiga – Szabályzat</div>
          <button id="closeRules" class="rules-close" aria-label="Bezárás">✕</button>
        </div>
        <div id="rulesBody" class="rules-body">
<p><strong>1. A játék célja</strong><br>
A TippLiga célja, hogy a játékosok minél több pontot gyűjtsenek az <strong>NB1-es mérkőzések eredményeinek</strong> és a <strong>szezon végi sorrendnek</strong> a megtippelésével.</p>
<p><strong>2. Tippelés</strong><br>
- Minden mérkőzésre <strong>1×2 (Hazai–Döntetlen–Vendég)</strong> tipp adható le.<br>
- A tipp a mérkőzés <strong>kezdési időpontjáig módosítható</strong>.<br>
- Minden fordulóban <strong>egyetlen mérkőzésre kijelölhető „dupla tét”</strong>, amely <strong>kétszeres pontszorzót</strong> ad.<br>
- <strong>A duplázás módosítása csak az adott forduló első mérkőzésének kezdetéig lehetséges</strong>, utána már nem változtatható.<br>
- A szezon kezdetén minden játékos <strong>leadhatja tippjét a teljes bajnokság végeredményének sorrendjére</strong> (1–12. hely).</p>
<p><strong>4. Pontszámítás</strong><br>
- A helyes tipp pontszáma: <strong>odds × tét</strong> (tét = 1 pont, duplázásnál 2 pont).<br>
- Rossz tipp esetén <strong>0 pont</strong> jár.<br>
- <strong>Szezon végi sorrend pontozás:</strong> ahány csapat pontos helyezését eltalálja a játékos, annyiszor <strong>+1% bónusz</strong> kerül hozzáadásra a <strong>teljes szezonos összpontszámához</strong>.<br>
  <em>Példa:</em> ha egy játékos <strong>5 csapat pontos helyét</strong> találja el, akkor a szezon végén összpontszámát <strong>+5%-kal növeljük</strong>.<br>
- Az oddsok <strong>a Tippmixpro alapján kerülnek meghatározásra</strong> abban az időpontban, amikor a mérkőzés feltöltésre kerül.<br>
  <strong>A kezdésig az odds módosulhat</strong>, és nem feltétlenül egyezik az aktuálisan érvényes oddsokkal, mivel az értékek manuálisan kerülnek feltöltésre, és nem frissülnek folyamatosan.</p>
<p><strong>5. Eredmények és rangsor</strong><br>
- A pontok összesítése <strong>fordulónként</strong> és <strong>teljes szezonra</strong> is megtörténik.<br>
- A „Toplista” a játékosokat <strong>összpontszám</strong> alapján sorolja.</p>
<p><strong>6. Tipp:</strong><br>
- <strong>A profil menüben érdemes kiválasztani a kedvenc csapatodat</strong>, mert így a felület színe és megjelenése a csapatodhoz igazodik, és a klubcímere is megjelenik a profilodnál.</p>
        </div>
        <div class="rules-foot">
          <span id="rulesUpdated" class="rules-updated">Utoljára frissítve: 2025. 08. 14.</span>
          <button id="closeRules2" class="btn-accent">Bezárás</button>
        </div>
      </div>
    </div>

    <div class="content-grid">
      <section class="card table-wrap">
        <!-- Fejléc sor gombbal a jobb oldalon -->
        <div class="card-head-row">
          <h3>NB I tabella</h3>
          <a id="statsLink" class="btn-accent" href="nb1-stats.html">Tippjáték statisztikák</a>
        </div>
        <div id="tableContainer"></div>
      </section>

      <section class="card">
        <h3>Csapatod hírei</h3>
        <div id="facebookFeedContainer"></div>
      </section>
    </div>
  </div>

  <button id="chatToggle" class="chat-fab" title="Közösségi chat">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M4 4h16a2 2 0 0 1 2 2v11a2 2 0 0 1 2 2H8l-4 3V6a2 2 0 0 1 2-2Z"/>
    </svg>
    <span id="chatFabBadge" class="fab-badge"></span>
  </button>

  <section id="chatPanel" class="chat-panel" aria-label="Közösségi chat">
    <div class="chat-head">
      <div class="chat-title">Közösségi chat</div>
      <button id="chatClose" aria-label="Bezárás">✕</button>
    </div>
    <div id="chatMessages" class="chat-list" role="log" aria-live="polite"></div>
    <div id="chatComposer">
      <input id="chatInput" type="text" placeholder="Írj valamit…" autocomplete="off">
      <button id="chatSendBtn">Küldés</button>
    </div>
  </section>
</body>
</html>
