<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL TippLiga ‚Äì √ñsszes√≠tett ranglista</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    .layout{ display:flex; flex-direction:column; gap:16px; max-width:1200px; margin:0 auto; padding:20px; }

    .header{ display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; }
    .fav-crest{ width:46px; height:46px; object-fit:contain; border-radius:8px; border:1px solid var(--line,#e6eaf1); background:#fff; }
    .welcome{ color:var(--muted,#64748b); margin:4px 0 0; }

    .nav-grid{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; }
    @media (max-width:1100px){ .nav-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width:700px){ .nav-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .nav-card{ display:flex; gap:12px; align-items:center; text-decoration:none; color:inherit; padding:14px; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 6px 18px rgba(15,23,42,.05); }
    .nav-card .icon-wrap{ width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:color-mix(in oklab, var(--accent,#3b82f6) 15%, white); color:var(--accent,#3b82f6); }
    .nav-card .text{ display:flex; flex-direction:column; line-height:1.2; }
    .nav-card .title{ font-weight:800; }
    .nav-card .desc{ color:var(--muted,#64748b); font-size:12px; }
    .pill-badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; margin-left:6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700; line-height:1; vertical-align:middle; }
    .pill-badge[hidden]{ display:none !important; }

    .btn{ border:0; background:#e5e7eb; color:#111; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .muted{ color:#64748b; }

    .card{ background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,.06); overflow:hidden; }
    .subhdr{ background:#f7f9fd; border-bottom:1px solid var(--line,#e6eaf1); padding:10px 12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    .table-wrap{ display:flex; }
    .grid{ display:grid; }
    .hdr, .row{ display:contents; }
    .cell{ padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#fff; }
    .hdr .cell{ font-weight:700; background:#f7f8fc; }
    .row-bg:nth-child(even) .cell{ background:#fcfdff; }

    .left{ position:sticky; left:0; z-index:3; background:#fff; border-right:1px solid var(--line,#e6eaf1); }
    .left .cell{ background:#fff; }
    .rank{ text-align:right; color:#64748b; white-space:nowrap; }
    .num{ text-align:right; white-space:nowrap; }
    .total{ font-weight:800; }
    .round-cell{ min-width:78px; text-align:right; }
    .round-link{ display:block; color:inherit; text-decoration:none; }
    .round-link:hover{ text-decoration:underline; }
    .top{ background:#fff8e1 !important; font-weight:700; }

    /* ==== Bonus ‚Äì kompakt inline + popover ==== */
    .bonus-inline{ display:flex; align-items:center; gap:8px; justify-content:flex-end; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .bonus-pts{ font-weight:700; }
    .bonus-pct{ font-weight:700; }
    .bonus-tokens{ color:#64748b; font-size:12px; }
    .bonus-info{
      border:1px solid var(--line,#e6eaf1); background:#fff; width:22px; height:22px;
      border-radius:999px; font-size:12px; line-height:1; cursor:pointer;
      display:inline-grid; place-items:center;
    }
    .bonus-info:focus{ outline:2px solid color-mix(in oklab, var(--accent,#3b82f6) 25%, white); outline-offset:2px; }

    .bonus-pop{ position:fixed; z-index:9999; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:12px;
      box-shadow:0 10px 28px rgba(0,0,0,.14); width:min(360px, calc(100vw - 32px)); padding:12px;
    }
    .bonus-pop .title{ font-weight:800; margin-bottom:8px; }
    .bonus-pop .grid{ display:grid; grid-template-columns:130px 1fr; gap:6px 10px; }
    .btag{ display:inline-flex; gap:6px; align-items:center; font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--line,#e6eaf1); background:#fff; color:#334155; }
    .btag.ok{ background:#ecfdf5; border-color:#bbf7d0; color:#166534; }
    .btag.pending{ background:#fffbeb; border-color:#fde68a; color:#a16207; }
    .btag.no{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }
    .bonus-pop .muted{ color:#64748b; font-size:12px; }
    .bonus-backdrop{ position:fixed; inset:0; z-index:9998; background:transparent; }

    /* Chat */
    .chat-fab{ position:fixed; right:22px; bottom:22px; z-index:999; width:52px; height:52px; border-radius:999px; border:0; background:var(--accent,#3b82f6); color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 26px rgba(0,0,0,.15); }
    .chat-fab .fab-badge{ position:absolute; top:-4px; right:-4px; min-width:20px; height:20px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:800; line-height:20px; display:none; }
    .chat-fab.has-unread .fab-badge{ display:inline-block; }
    .chat-panel{ position:fixed; right:22px; bottom:86px; z-index:998; width:380px; max-width:calc(100vw - 32px); max-height:70vh; display:none; flex-direction:column; background:#fff; border:1px solid var(--line,#e6eaf1); border-radius:14px; box-shadow:0 10px 32px rgba(0,0,0,.14); }
    .chat-panel.open{ display:flex; }
    .chat-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line,#e6eaf1); background:#f7f9fd; }
    .chat-title{ font-weight:800; }
    #chatClose{ width:28px; height:28px; border-radius:8px; font-size:18px; line-height:28px; display:inline-flex; align-items:center; justify-content:center; background:#eef2ff; color:#111; border:1px solid var(--line,#e6eaf1); cursor:pointer; }
    #chatClose:hover{ filter:brightness(0.95); }
    .chat-list{ overflow:auto; padding:8px 10px; }
    .chat-empty{ color:#64748b; font-size:13px; padding:8px 10px; }
    .msg{ padding:8px 10px; border-bottom:1px solid var(--line,#e6eaf1); display:flex; gap:8px; align-items:flex-start; }
    .msg .meta{ font-size:12px; color:#64748b; margin-bottom:2px; }
    .msg .text{ white-space:pre-wrap; word-break:break-word; }
    .msg .del{ margin-left:auto; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:2px 8px; border-radius:8px; font-size:12px; cursor:pointer; display:none; }
    .msg:hover .del{ display:inline-block; }
    #chatComposer{ display:flex; gap:8px; align-items:center; padding:10px; border-top:1px solid var(--line,#e6eaf1); background:#fff; }
    #chatInput{ background:#fff; color:#111; border:1px solid var(--line,#e6eaf1); height:40px; padding:8px 10px; border-radius:10px; font-size:14px; outline:none; width:100%; box-sizing:border-box; }
    #chatInput::placeholder{ color:#6b7280; }
    #chatSendBtn{ min-width:90px; padding:8px 12px; border-radius:10px; background:var(--accent,#3b82f6); color:#fff; border:0; font-weight:600; cursor:pointer; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ---------- Firebase ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ---------- Helper-ek ---------- */
    const crestMap = { "Ajax":"ucl_crest/ajax.png","Arsenal":"ucl_crest/arsenal.png","Atalanta":"ucl_crest/atalanta.png","Athletic Bilbao":"ucl_crest/athletic.png","Atl√©tico Madrid":"ucl_crest/atletico.png","Barcelona":"ucl_crest/barcelona.png","Bayern M√ºnchen":"ucl_crest/bayern.png","Benfica":"ucl_crest/benfica.png","Borussia Dortmund":"ucl_crest/borussia.png","Bod√∏/Glimt":"ucl_crest/bodo.png","Club Bruges":"ucl_crest/brugge.png","Chelsea":"ucl_crest/chelsea.png","FC K√∂benhavn":"ucl_crest/copenhagen.png","Eintracht Frankfurt":"ucl_crest/frankfurt.png","Galatasaray":"ucl_crest/galata.png","Internazionale":"ucl_crest/inter.png","Juventus":"ucl_crest/juventus.png","Bayer Leverkusen":"ucl_crest/leverkusen.png","Liverpool":"ucl_crest/liverpool.png","Manchester City":"ucl_crest/mancity.png","Olympique Marseille":"ucl_crest/marseille.png","Monaco":"ucl_crest/monaco.png","Napoli":"ucl_crest/napoli.png","Newcastle United":"ucl_crest/newcastle.png","Olympiakosz Pireusz":"ucl_crest/olympiacos.png","Pafosz":"ucl_crest/pafos.png","Paris Saint-Germain":"ucl_crest/psg.png","PSV":"ucl_crest/psv.png","Qarabag":"ucl_crest/qarabag.png","Real Madrid":"ucl_crest/real.png","Slavia Praha":"ucl_crest/slavia.png","Sporting CP":"ucl_crest/sporting.png","Tottenham Hotspur":"ucl_crest/tottenham.png","Union Saint-Gilloise":"ucl_crest/usg.png","Villarreal":"ucl_crest/villareal.png","Kajrat Almati":"ucl_crest/kairat.png" };
    const crestFor = t => crestMap[t] || "";
    const fmt = n => (Number(n)||0).toFixed(2);
    const fmtTime = ts => { try{ return ts.toDate().toLocaleString("hu-HU",{hour12:false}); }catch{ return ""; } };
    const escapeHtml = s => String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const NORM = s => String(s ?? "").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const eqTeam = (a,b) => !!a && !!b && NORM(a) === NORM(b);
    const eqText = (a,b) => NORM(a) === NORM(b);

    // odds schema: {odds:{'1','X','2'}} vagy odds1/oddsX/odds2
    function getOdds(m, key){
      if (m?.odds && (key in m.odds)) return m.odds[key];
      if (key==="1") return m.odds1 ?? m["odds1"];
      if (key==="X") return m.oddsX ?? m["oddsX"];
      if (key==="2") return m.odds2 ?? m["odds2"];
      return undefined;
    }
    const tipChoice = t => t?.choice ?? t?.tip ?? "";
    const tipDouble = t => !!(t?.double ?? t?.isDouble);
    const tipTsMs   = t => t?.updatedAt?.toMillis?.() || t?.createdAt?.toMillis?.() || t?.timestamp?.toMillis?.() || 0;
    const matchRound = m => String(m?.round ?? m?.roundId ?? "");

    // ---- Ugyanaz a pontk√©pz√©s, mint a results_ucl oldalon ----
    const toNum = v => {
      if (v === null || v === undefined || v === '') return null;
      if (typeof v === 'string') v = v.replace(',', '.');
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };
    const fromCandidateOdds = c => {
      const direct = toNum(c?.odds);
      if (direct != null) return direct;
      const dec = toNum(c?.oddsDecimal);
      if (dec != null) return dec;
      const pct = toNum(c?.oddsPercent);
      if (pct != null && pct > 0) return 100 / pct;
      return null;
    };
    const fromDisplayedPoints = c => toNum(c?.displayPoints);
    function computePoints(odds, BASE=10, O0=65, A=0.33, LO=0.5, HI=2.5){
      const o = toNum(odds);
      if(!o || o<=0) return null;
      const ratio   = Math.pow(o/Math.max(O0,1e-9), A);
      const clamped = Math.min(Math.max(ratio, LO), HI);
      return BASE * clamped;             // % √©rt√©k
    }
    function candidatePoints(c, scope){
      const dp = fromDisplayedPoints(c);
      if (dp != null) return dp;
      const odds = fromCandidateOdds(c);
      const cfg  = (c?._calc && c._calc.scope === scope) ? c._calc : {};
      return computePoints(
        odds,
        cfg.BASE ?? 10,
        cfg.O0   ?? 65,
        cfg.A    ?? 0.33,
        cfg.LO   ?? 0.5,
        cfg.HI   ?? 2.5
      );
    }

    /* ---------- Top8 sz√°m√≠t√°s (results_ucl logika) ---------- */
    function parseRes(str){
      const m=String(str||"").match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);
      return m ? [parseInt(m[1]), parseInt(m[2])] : null;
    }
    function deriveTop8FromMatches(allMatches){
      const teams = Object.keys(crestMap);
      const S={}; teams.forEach(t=>S[t]={team:t,MP:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,Pts:0});
      const H2H={};
      (allMatches||[]).forEach(m=>{
        const A=m.homeTeam||m.home||"";
        const B=m.awayTeam||m.away||"";
        const r=parseRes(m.result);
        const a=S[A], b=S[B];
        if(!a || !b || !r) return;
        const [hg,ag]=r;
        a.MP++; b.MP++;
        a.GF+=hg; a.GA+=ag; a.GD=a.GF-a.GA;
        b.GF+=ag; b.GA+=hg; b.GD=b.GF-b.GA;
        if(hg>ag){a.W++;b.L++;a.Pts+=3}
        else if(hg<ag){b.W++;a.L++;b.Pts+=3}
        else{a.D++;b.D++;a.Pts+=1;b.Pts+=1}
        const k=[A,B].slice().sort((x,y)=>x.localeCompare(y,'hu')).join('|');
        H2H[k] ||= {[A]:{Pts:0,GF:0,GA:0},[B]:{Pts:0,GF:0,GA:0}};
        if(hg>ag){H2H[k][A].Pts+=3}
        else if(hg<ag){H2H[k][B].Pts+=3}
        else{H2H[k][A].Pts+=1;H2H[k][B].Pts+=1}
        H2H[k][A].GF+=hg; H2H[k][A].GA+=ag;
        H2H[k][B].GF+=ag; H2H[k][B].GA+=hg;
      });
      function cmp(a,b){
        if(b.Pts!==a.Pts) return b.Pts-a.Pts;
        if(b.W!==a.W) return b.W-a.W;
        if(b.GD!==a.GD) return b.GD-a.GD;
        if(b.GF!==a.GF) return b.GF-a.GF;
        const k=[a.team,b.team].slice().sort((x,y)=>x.localeCompare(y,'hu')).join('|');
        const row=H2H[k];
        if(row){
          const pa=row[a.team]?.Pts??0, pb=row[b.team]?.Pts??0;
          if(pb!==pa) return pb-pa;
          const gda=(row[a.team]?.GF??0)-(row[a.team]?.GA??0);
          const gdb=(row[b.team]?.GF??0)-(row[b.team]?.GA??0);
          if(gdb!==gda) return gdb-gda;
        }
        return a.team.localeCompare(b.team,'hu');
      }
      const rows=Object.values(S).sort(cmp);
      return rows.slice(0,8).map(r=>r.team);
    }

    function pctColor(pct){
      const p=Math.max(0,Math.min(100,Number(pct)||0));
      const hue=(Math.min(p,12)/12)*120;
      return `hsl(${hue}deg,85%,40%)`;
    }

    /* ---------- B√ìNUSZ konfigur√°ci√≥ ---------- */
    const BONUS_CFG = Object.freeze({
      top8PerHitPct: 1,
      top8MaxPct: 8
    });

    /* ---------- √Ållapot ---------- */
    let currentUserEmail = "", currentUserNick = "", currentUserRole = "user";
    let favouriteTeamucl = "", chatLastSeen = null;

    let showAll = false;
    let rows = [];            // [{nick,email,base,perRound,bonusPct,bonusPts,total, parts:{...}}]
    let roundsAsc = [];       // ["1","2",...]

    let championCandidates = [];
    let goldenCandidates   = [];

    let seasonTipsByEmail = {};   // {email:{winnerTeam, topScorer}}
    let top8TipsByEmail   = {};   // {email:[...]}
    let officialAwards = {};      // {winnerTeam, topScorer}
    let officialTop8 = [];        // [8 csapat]

    /* ---------- INIT ---------- */
    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login_ucl.html"; return; }
        currentUserEmail = user.email;

        // user + t√©ma
        const userRef = doc(db, "users", currentUserEmail);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()){
          const d = userSnap.data();
          currentUserNick  = d.nickname || currentUserEmail;
          currentUserRole  = d.role || "user";
          favouriteTeamucl = d.favouriteTeamucl || "";
          chatLastSeen     = d.chatLastSeen || null;
        }else{
          currentUserNick = currentUserEmail;
        }
        document.getElementById("welcome").textContent = `√údv, ${currentUserNick}!`;
        if (currentUserRole === "admin") document.getElementById("adminLink").style.display = "flex";

        if (favouriteTeamucl) {
          const themeClass = "theme-" + favouriteTeamucl.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-');
          document.body.classList.add(themeClass);
          const crest = crestFor(favouriteTeamucl);
          if (crest) { const img = document.getElementById("favCrest"); img.src = crest; img.alt = favouriteTeamucl; img.hidden = false; }
        }

        await buildLeaderboard();
        updatePendingBadge();
        initChat(userRef);

        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(() => window.location.href = "login_ucl.html");
      });

      document.getElementById('toggleAll').addEventListener('click', ()=>{
        showAll = !showAll;
        document.getElementById('toggleAll').textContent = showAll ? 'Csak az utols√≥ 5 fordul√≥' : 'Mutasd az √∂sszes fordul√≥t';
        renderTable();
      });
    });

    /* ---------- Bet√∂lt√©s + sz√°m√≠t√°s ---------- */
    async function buildLeaderboard(){
      const [
        matchesSnap, tipsSnap, usersSnap,
        // hivatalos z√°r√≥ √°llapot √©s d√≠jak
        officialStandUcl, officialStandNb,
        // (r√©gi) v√©gs≈ë sorrend tippek ‚Äì most csak tartal√©knak
        standings_ucl, standings_nb,
        // szezon picks t√∂bb helyr≈ël (winner/topScorer)
        seasonTipsSnap, bonusTipsSnap,
        // results_ucl √°ltal haszn√°lt hivatalos d√≠jak
        awardsCurDoc,
        // jel√∂ltlist√°k √©s szezon picks gy≈±jtem√©nyek (results_ucl-hez illeszkedve)
        champCandSnap, goldenCandSnap,
        champTipsSnap, goldenTipsSnap,
        // Top8 tippek (results_ucl-hez)
        top8TipsSnap
      ] = await Promise.all([
        getDocs(collection(db, "ucl_matches")),
        getDocs(collection(db, "ucl_tips")),
        getDocs(collection(db, "users")),

        getDoc(doc(db, "finalStandings_ucl", "official")).catch(()=>({exists:()=>false,data:()=>({})})),
        getDoc(doc(db, "finalStandings", "official")).catch(()=>({exists:()=>false,data:()=>({})})),

        getDocs(collection(db, "standingsTips_ucl")).catch(()=>({empty:true,forEach(){}})),
        getDocs(collection(db, "standingsTips")).catch(()=>({empty:true,forEach(){}})),

        getDocs(collection(db, "seasonTips_ucl")).catch(()=>({empty:true,forEach(){}})),
        getDocs(collection(db, "bonusTips_ucl")).catch(()=>({empty:true,forEach(){}})),

        getDoc(doc(db, "ucl_official", "current")).catch(()=>({exists:()=>false,data:()=>({})})),

        getDocs(collection(db, "ucl_championCandidates")).catch(()=>({empty:true,docs:[]})),
        getDocs(collection(db, "ucl_goldenBootCandidates")).catch(()=>({empty:true,docs:[]})),

        getDocs(collection(db, "ucl_championPickTips")).catch(()=>({empty:true,forEach(){}})),
        getDocs(collection(db, "ucl_goldenBootTips")).catch(()=>({empty:true,forEach(){}})),

        getDocs(collection(db, "ucl_top8Tips")).catch(()=>({empty:true,forEach(){}}))
      ]);

      // matches by id + rounds
      const matches = {};
      const matchesArr = matchesSnap.docs.map(d => ({ id:d.id, ...d.data() }));
      matchesArr.forEach(d => matches[d.id] = d);

      // users nick
      const usersMap = {};
      usersSnap.forEach(d => { const u = d.data(); if (u?.email) usersMap[u.email] = u.nickname || u.email; });

      // hivatalos d√≠jak (results_ucl)
      const a = awardsCurDoc?.exists?.() ? (awardsCurDoc.data()||{}) : {};
      officialAwards = {
        winnerTeam: a.champion || a.winnerTeam || "",
        topScorer: (a.goldenBoot && a.goldenBoot.player) ? a.goldenBoot.player : (a.topScorer || "")
      };

      // results_ucl-nek megfelel≈ë aktu√°lis Top8 (meccsekb≈ël sz√°m√≠tva)
      officialTop8 = deriveTop8FromMatches(matchesArr);

      // jel√∂ltlist√°k
      championCandidates = champCandSnap?.docs?.map(d => ({ id:d.id, ...(d.data()||{}) })).filter(x => x.team) || [];
      goldenCandidates   = goldenCandSnap?.docs?.map(d => ({ id:d.id, ...(d.data()||{}) })).filter(x => x.player) || [];

      // Top8 tippek beolvas√°sa (email -> picks[8])
      top8TipsByEmail = {};
      top8TipsSnap?.forEach?.(d => {
        const t = d.data()||{};
        const email = t.email || d.id;
        const picks = Array.isArray(t.picks) ? t.picks.slice(0,8).filter(Boolean) : [];
        top8TipsByEmail[email] = picks;
      });

      // season picks winner/topScorer t√∂bb forr√°sb√≥l
      seasonTipsByEmail = {};
      const mergeTipDoc = (id, data) => {
        if (!id || !data) return;
        const cur = seasonTipsByEmail[id] || {};
        const winnerTeam = data.winnerTeam || data.team || cur.winnerTeam || "";
        const topScorer  = data.topScorer  || data.player || cur.topScorer  || "";
        seasonTipsByEmail[id] = { winnerTeam, topScorer };
      };
      seasonTipsSnap?.forEach?.(d => mergeTipDoc(d.id, d.data()));
      bonusTipsSnap?.forEach?.(d => mergeTipDoc(d.id, d.data()));
      champTipsSnap?.forEach?.(d => mergeTipDoc(d.id, d.data()));   // {team}
      goldenTipsSnap?.forEach?.(d => mergeTipDoc(d.id, d.data()));  // {player}

      // tippek ‚Äì legut√≥bbi per user|match (s√©ma-agnosztikusan)
      const latest = new Map();
      tipsSnap.forEach(docu=>{
        const t = docu.data(); if (!t?.matchId || !t?.user) return;
        const k = t.user + "|" + t.matchId;
        const cur = latest.get(k);
        if (!cur || tipTsMs(t) >= tipTsMs(cur)) latest.set(k, { id:docu.id, ...t });
      });

      // pontsz√°m√≠t√°s
      const player = {}; // nick -> {base, perRound, email}
      const rounds = new Set();

      for (const tip of latest.values()){
        const m = matches[tip.matchId]; if (!m) continue;
        const roundId = matchRound(m); if (!roundId) continue;
        rounds.add(roundId);

        if (!m.outcome) continue;                    // csak lez√°rt meccs
        const pick = tipChoice(tip); if (!pick) continue;

        const correct = pick === m.outcome;
        const ov = getOdds(m, pick);
        const mult = tipDouble(tip) ? 2 : 1;
        const pts = (correct && ov) ? Number(ov) * mult : 0;

        const nick = usersMap[tip.user] || tip.user;
        if (!player[nick]) player[nick] = { base:0, perRound:{}, email: tip.user };
        player[nick].base += pts;
        player[nick].perRound[roundId] = (player[nick].perRound[roundId]||0) + pts;
      }

      roundsAsc = Array.from(rounds).sort((a,b)=> (parseInt(a)||0)-(parseInt(b)||0));

      // b√≥nuszr√©szek sz√°m√≠t√°sa ‚Äì results_ucl logika
      function calcTop8Pct(email){
        const predictedTop8 = (top8TipsByEmail[email] || []).map(String).filter(Boolean);
        const offTop8 = (officialTop8 || []).map(String).filter(Boolean);
        if (!predictedTop8.length || !offTop8.length) return { hits:0, pct:0 };
        const setOfficial = new Set(offTop8.map(NORM));
        let hits = 0;
        for (const t of predictedTop8){ if (setOfficial.has(NORM(t))) hits++; }
        const pct = Math.min(hits * BONUS_CFG.top8PerHitPct, BONUS_CFG.top8MaxPct);
        return { hits, pct };
      }

      function calcBonusParts(email, base){
        const tips = seasonTipsByEmail[email] || {};
        const winnerPick = tips.winnerTeam || "";
        const scorerPick = tips.topScorer || "";

        const winnerOfficial = officialAwards.winnerTeam || "";
        const scorerOfficial = officialAwards.topScorer || "";

        const winnerHit = winnerOfficial && eqTeam(winnerPick, winnerOfficial);
        const scorerHit = scorerOfficial && eqText(scorerPick, scorerOfficial);

        // Csak TAL√ÅLAT eset√©n j√°r a jel√∂ltlist√°b√≥l sz√°molt +%
        let winnerPct = 0;
        if (winnerHit){
          const cand = championCandidates.find(x => eqTeam(x.team, winnerPick));
          winnerPct = toNum(candidatePoints(cand, 'champion')) || 0;
        }
        let scorerPct = 0;
        if (scorerHit){
          const cand = goldenCandidates.find(x => eqText(x.player, scorerPick));
          scorerPct = toNum(candidatePoints(cand, 'golden')) || 0;
        }

        const { hits:top8Hits, pct:top8Pct } = calcTop8Pct(email);

        const bonusPct = winnerPct + scorerPct + top8Pct;
        const bonusPts = Math.round((Number(base)||0) * (bonusPct/100));

        return {
          bonusPct, bonusPts,
          parts: {
            winner:    { pct:winnerPct, status: winnerHit ? 'ok' : (winnerOfficial ? 'no' : 'pending'), pick:winnerPick, official:winnerOfficial },
            topScorer: { pct:scorerPct, status: scorerHit ? 'ok' : (scorerOfficial ? 'no' : 'pending'), pick:scorerPick, official:scorerOfficial },
            top8: { pct:top8Pct, hits:top8Hits, of:8 }
          }
        };
      }

      rows = Object.entries(player).map(([nick,obj])=>{
        const { bonusPct, bonusPts, parts } = calcBonusParts(obj.email, obj.base);
        const total = obj.base + bonusPts;
        return { nick, email: obj.email, base: obj.base, perRound: obj.perRound, bonusPct, bonusPts, total, parts };
      });

      rows.sort((a,b)=> b.total - a.total || a.nick.localeCompare(b.nick));
      renderTable();
    }

    function renderTable(){
      const mount = document.getElementById('tableMount');
      if (!rows.length){
        mount.innerHTML = "<div style='padding:12px'>M√©g nincs megjelen√≠thet≈ë pontsz√°m.</div>";
        return;
      }

      const roundsDesc = roundsAsc.slice().reverse();
      const toShow = showAll ? roundsDesc : roundsDesc.slice(0,5);

      const rangeLabel = document.getElementById('rangeLabel');
      rangeLabel.textContent = showAll
        ? "Teljes n√©zet: minden fordul√≥ l√°tszik (balr√≥l jobbra: legut√≥bbi ‚Üí r√©gebbi)"
        : (toShow.length ? `Csak az utols√≥ ${toShow.length} fordul√≥ l√°tszik (balr√≥l jobbra: F${toShow[0]} ‚Üí ‚Ä¶)` : "Nincs m√©g lez√°rt fordul√≥.");

      const maxPerRound = toShow.map(r=>{
        let m = -Infinity;
        rows.forEach(row => { m = Math.max(m, row.perRound[r]||0); });
        return m === -Infinity ? 0 : m;
      });

      const leftHeader = `
        <div class="hdr">
          <div class="cell left rank">Hely</div>
          <div class="cell left">J√°t√©kos</div>
          <div class="cell left num">√ñsszesen</div>
          <div class="cell left num">B√≥nusz (pont + %)</div>
          <div class="cell left num">Alap pont</div>
        </div>`;

      const rightHeader = toShow.map(r=>`<div class="cell round-cell"><a class="round-link" href="results_ucl.html?round=${encodeURIComponent(r)}">F${r}</a></div>`).join('');

      const container = document.createElement('div'); container.className = 'table-wrap';

      const left = document.createElement('div');
      left.className = 'left';
      left.style.minWidth = '720px';
      left.style.maxWidth = '720px';
      left.innerHTML = `
        <div class="grid" style="grid-template-columns:70px 1.6fr 140px 180px 140px;">
          ${leftHeader}
          ${rows.map((r,i)=>`
            <div class="row row-bg" data-row="${i}">
              <div class="cell left rank">${i+1}.</div>
              <div class="cell left">${escapeHtml(r.nick)}</div>
              <div class="cell left num total">${fmt(r.total)}</div>
              <div class="cell left num">
                <div class="bonus-inline">
                  <span class="bonus-pts">+${r.bonusPts}</span>
                  <span class="bonus-pct" style="color:${pctColor(r.bonusPct)}">( +${r.bonusPct}% )</span>
                  <span class="bonus-tokens">‚Ä¢ üèÜ${r.parts.winner.pct}% üëü${r.parts.topScorer.pct}% üìä${r.parts.top8.pct}%</span>
                  <button class="bonus-info" data-idx="${i}" title="B√≥nusz r√©szletek" aria-label="B√≥nusz r√©szletek">‚ìò</button>
                </div>
              </div>
              <div class="cell left num">${fmt(r.base)}</div>
            </div>
          `).join('')}
        </div>
      `;

      const right = document.createElement('div');
      right.style.overflow = 'auto';
      right.style.flex = '1';
      right.innerHTML = `
        <div class="grid" style="grid-template-columns:${'78px '.repeat(toShow.length)};">
          <div class="hdr">${rightHeader}</div>
          ${rows.map((r,ri)=>{
            const cells = toShow.map((rid, idx)=>{
              const val = r.perRound[rid]||0;
              const isTop = val === maxPerRound[idx] && val !== 0;
              return `<div class="cell round-cell num ${isTop?'top':''}">
                        <a class="round-link" href="results_ucl.html?round=${encodeURIComponent(rid)}">${fmt(val)}${isTop?' ‚≠ê':''}</a>
                      </div>`;
            }).join('');
            return `<div class="row row-bg" data-row="${ri}">${cells}</div>`;
          }).join('')}
        </div>
      `;

      mount.innerHTML = '';
      container.appendChild(left);
      container.appendChild(right);
      mount.appendChild(container);

      // Popover esem√©nyek
      mount.querySelectorAll('.bonus-info').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const idx = Number(btn.dataset.idx||0);
          showBonusPopover(rows[idx], e.clientX, e.clientY);
        });
      });
    }

    /* ---------- Bonus popover ---------- */
    function showBonusPopover(row, clientX, clientY){
      // t√∂r√∂lj√ºk a kor√°bbit
      document.querySelectorAll('.bonus-backdrop,.bonus-pop').forEach(n=>n.remove());

      const backdrop = document.createElement('div');
      backdrop.className = 'bonus-backdrop';
      backdrop.addEventListener('click', ()=>{ backdrop.remove(); pop.remove(); });

      const pop = document.createElement('div');
      pop.className = 'bonus-pop';

      const winnerLine = (() => {
        const st = row.parts.winner.status;
        const cls = st==='ok'?'ok':(st==='pending'?'pending':'no');
        const icon = st==='ok'?'‚úî':(st==='pending'?'üïí':'‚úñ');
        const off = row.parts.winner.official || '‚Äî';
        const pick = row.parts.winner.pick || '‚Äî';
        return `<span class="btag ${cls}">üèÜ ${icon} +${row.parts.winner.pct}%</span>
                <div>Tip: <strong>${escapeHtml(pick)}</strong> ‚Ä¢ Hiv.: <strong>${escapeHtml(off)}</strong></div>`;
      })();

      const scorerLine = (() => {
        const st = row.parts.topScorer.status;
        const cls = st==='ok'?'ok':(st==='pending'?'pending':'no');
        const icon = st==='ok'?'‚úî':(st==='pending'?'üïí':'‚úñ');
        const off = row.parts.topScorer.official || '‚Äî';
        const pick = row.parts.topScorer.pick || '‚Äî';
        return `<span class="btag ${cls}">üëü ${icon} +${row.parts.topScorer.pct}%</span>
                <div>Tip: <strong>${escapeHtml(pick)}</strong> ‚Ä¢ Hiv.: <strong>${escapeHtml(off)}</strong></div>`;
      })();

      const top8Line = (() => {
        const hits = row.parts.top8.hits, of=row.parts.top8.of;
        return `<span class="btag ok">üìä +${row.parts.top8.pct}%</span>
                <div>Top8 tal√°lat: <strong>${hits}/${of}</strong> (1 tal√°lat = +1%, max +8%)</div>`;
      })();

      pop.innerHTML = `
        <div class="title">${escapeHtml(row.nick)} ‚Äì B√≥nusz r√©szletek</div>
        <div class="grid">
          <div class="muted">K√©plet</div>
          <div>Alap √ó (üèÜ+üëü+üìä)/100 = <strong>${fmt(row.base)} √ó ${fmt(row.bonusPct)}% = ${row.bonusPts}</strong></div>

          <div class="muted">V√©gs≈ë gy≈ëztes</div>
          <div>${winnerLine}</div>

          <div class="muted">G√≥lkir√°ly</div>
          <div>${scorerLine}</div>

          <div class="muted">Top 8 tal√°latok</div>
          <div>${top8Line}</div>

          <div class="muted">√ñsszes b√≥nusz</div>
          <div><strong>+${row.bonusPct}%</strong> ‚Üí <strong>+${row.bonusPts} pont</strong></div>
        </div>
      `;

      // pozicion√°l√°s: eg√©rhez k√∂zel, de a viewporton bel√ºl
      const pad = 10;
      const vw = window.innerWidth, vh = window.innerHeight;
      document.body.appendChild(pop);
      const rect = pop.getBoundingClientRect();
      let x = clientX + pad, y = clientY + pad;
      if (x + rect.width > vw - 8) x = vw - rect.width - 8;
      if (y + rect.height > vh - 8) y = vh - rect.height - 8;
      pop.style.left = Math.max(8, x) + 'px';
      pop.style.top  = Math.max(8, y) + 'px';
      document.body.appendChild(backdrop);
      document.body.appendChild(pop);
    }

    /* ---------- Nav ‚Äûf√ºgg≈ë tippek‚Äù badge ---------- */
    function updatePendingBadge(){
      getDocs(query(collection(db,"ucl_matches"), where("startTime", ">=", new Date()))).then(upcomingSnap=>{
        const upcoming = upcomingSnap.docs.map(d => ({ id:d.id, ...d.data() }));
        getDocs(query(collection(db,"ucl_tips"), where("user","==", currentUserEmail))).then(tipsSnap=>{
          const latestByMatch = new Map();
          tipsSnap.forEach(docu=>{ const t=docu.data(); if(!t?.matchId) return; const cur=latestByMatch.get(t.matchId); if(!cur||tipTsMs(t)>=tipTsMs(cur)) latestByMatch.set(t.matchId,t); });
          const tippedIds = new Set(Array.from(latestByMatch.keys()));
          const pending = upcoming.filter(m => !tippedIds.has(m.id)).length;
          const badge = document.getElementById("tipsBadge");
          if (pending>0){ badge.textContent = pending; badge.hidden = false; } else { badge.hidden = true; }
        });
      });
    }

    /* ---------- Chat ---------- */
    function initChat(userRef){
      const fab = document.getElementById('chatToggle');
      const fabBadge = document.getElementById('chatFabBadge');
      const panel = document.getElementById('chatPanel');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatMessages');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSendBtn');

      function open(){ panel.classList.add('open'); setTimeout(()=>inputEl?.focus(), 50); markSeen(); }
      function close(){ panel.classList.remove('open'); }
      function toggle(){ panel.classList.contains('open') ? close() : open(); }
      fab.addEventListener('click', toggle);
      closeBtn.addEventListener('click', close);

      let lastSeenMs = chatLastSeen?.toMillis ? chatLastSeen.toMillis() : 0;

      const qAll = query(collection(db,'chatMessages'), orderBy('ts','asc'));
      onSnapshot(qAll, snap => {
        listEl.innerHTML = '';
        if (snap.empty){
          const empty = document.createElement('div');
          empty.className = 'chat-empty';
          empty.textContent = 'M√©g nincs √ºzenet. L√©gy te az els≈ë!';
          listEl.appendChild(empty);
        } else {
          let unread = 0;
          snap.forEach(docu=>{
            const d = docu.data();
            const tsMs = d.ts?.toMillis?.() || 0;
            if (tsMs > lastSeenMs) unread++;

            const row = document.createElement('div');
            row.className = 'msg';
            row.innerHTML = `
              <div style="flex:1 1 auto">
                <div class="meta"><strong>${d.nick || 'Ismeretlen'}</strong> ‚Ä¢ ${d.ts ? fmtTime(d.ts) : ''}</div>
                <div class="text">${(d.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
              </div>
            `;
            const canDelete = (currentUserRole === 'admin') || (d.email === currentUserEmail);
            if (canDelete){
              const del = document.createElement('button');
              del.className = 'del';
              del.textContent = 'T√∂rl√©s';
              del.title = '√úzenet t√∂rl√©se';
              del.addEventListener('click', async ()=>{ try{ await deleteDoc(doc(db, 'chatMessages', docu.id)); }catch(e){} });
              row.appendChild(del);
            }
            listEl.appendChild(row);
          });

          if (!panel.classList.contains('open') && unread > 0){
            fab.classList.add('has-unread');
            fabBadge.textContent = unread > 99 ? '99+' : String(unread);
          } else {
            fab.classList.remove('has-unread');
            fabBadge.textContent = '';
          }

          setTimeout(()=>{ listEl.scrollTop = listEl.scrollHeight; }, 0);
        }
      });

      sendBtn.addEventListener('click', async ()=>{
        const txt = (inputEl.value || '').trim();
        if (!txt){ inputEl.focus(); return; }
        const backup = txt;
        inputEl.value = '';
        try{
          await addDoc(collection(db,'chatMessages'), { email: currentUserEmail, nick: currentUserNick || 'Ismeretlen', text: backup, ts: serverTimestamp() });
          if (panel.classList.contains('open')) await markSeen();
        }catch(e){
          inputEl.value = backup; inputEl.focus();
        }
      });
      inputEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } });

      async function markSeen(){
        try{
          await setDoc(userRef, { chatLastSeen: serverTimestamp() }, { merge:true });
          fab.classList.remove('has-unread');
          fabBadge.textContent = '';
        }catch(e){}
      }
    }
  </script>
</head>
<body>
  <div class="layout">
    <!-- Fejl√©c -->
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>BL TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
      </div>
      <div>
        <button id="logout" class="btn" aria-label="Kil√©p√©s" style="background:var(--accent,#3b82f6);color:#fff;border:1px solid var(--line,#e6eaf1);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-3px;margin-right:6px">
            <path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2z"/>
          </svg>
          Kil√©p√©s
        </button>
      </div>
    </div>

    <!-- UCL nav -->
    <nav class="nav-grid">
      <a class="nav-card" href="dashboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3L12 3z"/></svg>
        </div>
        <div class="text"><span class="title">F≈ëoldal</span><span class="desc">Tabella, h√≠rek, kedvencek</span></div>
      </a>
      <a class="nav-card" href="positions_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg>
        </div>
        <div class="text"><span class="title">Szezon v√©gi sorrend</span><span class="desc">12 csapat ‚Äì h√∫zd a helyekre</span></div>
      </a>
      <a class="nav-card" href="matches_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Z"/></svg>
        </div>
        <div class="text"><span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span><span class="desc">K√∂zelg≈ë meccsek & tippek</span></div>
      </a>
      <a class="nav-card" href="results_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2Z"/></svg>
        </div>
        <div class="text"><span class="title">Eredm√©nyek</span><span class="desc">Fordul√≥nk√©nti bont√°s</span></div>
      </a>
      <a class="nav-card" href="leaderboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2Z"/></svg>
        </div>
        <div class="text"><span class="title">√ñsszpontsz√°m</span><span class="desc">Toplista & b√≥nusz</span></div>
      </a>
      <a class="nav-card" href="profile_ucl.html">
        <div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg></div>
        <div class="text"><span class="title">Profil</span><span class="desc">Be√°ll√≠t√°sok & kedvenc csapat</span></div>
      </a>
      <a class="nav-card" id="adminLink" href="admin_ucl.html" style="display:none;">
        <div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Z"/></svg></div>
        <div class="text"><span class="title">Admin</span><span class="desc">Szezon-z√°r & be√°ll√≠t√°sok</span></div>
      </a>
    </nav>

    <!-- Ranglista -->
    <section class="card">
      <div class="subhdr">
        <button id="toggleAll" class="btn">Mutasd az √∂sszes fordul√≥t</button>
        <span id="rangeLabel" class="muted">Alap: az utols√≥ 5 fordul√≥ l√°tszik</span>
      </div>
      <div id="tableMount"></div>
      <div style="padding:8px 12px; font-size:12px; color:#64748b;">‚≠ê = adott fordul√≥ legmagasabb pontja</div>
    </section>
  </div>

  <!-- Chat -->
  <button id="chatToggle" class="chat-fab" title="K√∂z√∂ss√©gi chat">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M4 4h16a2 2 0 0 1 2 2v11a2 2 0 0 1 2 2H8l-4 3V6a2 2 0 0 1 2-2Z"/>
    </svg>
    <span id="chatFabBadge" class="fab-badge"></span>
  </button>

  <section id="chatPanel" class="chat-panel" aria-label="K√∂z√∂ss√©gi chat">
    <div class="chat-head">
      <div class="chat-title">K√∂z√∂ss√©gi chat</div>
      <button id="chatClose" aria-label="Bez√°r√°s">‚úï</button>
    </div>
    <div id="chatMessages" class="chat-list" role="log" aria-live="polite"></div>
    <div id="chatComposer">
      <input id="chatInput" type="text" placeholder="√çrj valamit‚Ä¶" autocomplete="off">
      <button id="chatSendBtn">K√ºld√©s</button>
    </div>
  </section>
</body>
</html>
