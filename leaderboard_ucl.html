<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>UCL TippLiga ‚Äì √ñsszes√≠tett ranglista</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    :root{ --line:#e6eaf1; --muted:#64748b; --accent:#3b82f6; --rowh:48px; --hdrh:44px; }
    .layout{ display:flex; flex-direction:column; gap:16px; max-width:1200px; margin:0 auto; padding:20px; }

    .header{ display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; }
    .welcome{ color:var(--muted); margin:4px 0 0; }

    .btn{ border:0; background:#e5e7eb; color:#111; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .muted{ color:var(--muted); }

    .card{ background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,.06); overflow:hidden; }
    .subhdr{ background:#f7f9fd; border-bottom:1px solid var(--line); padding:10px 12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    .table-wrap{ display:flex; }
    .grid{ display:grid; }
    .hdr, .row{ display:contents; }
    .cell{ padding:8px 12px; border-bottom:1px solid var(--line); background:#fff; display:flex; align-items:center; gap:8px; box-sizing:border-box; height:var(--rowh); overflow:hidden; }
    .hdr .cell{ font-weight:700; background:#f7f8fc; height:var(--hdrh); }
    .row-bg:nth-child(even) .cell{ background:#fcfdff; }

    .left{ position:sticky; left:0; z-index:3; background:#fff; border-right:1px solid var(--line); }
    .left .cell{ background:#fff; }
    .rank{ text-align:right; color:#64748b; white-space:nowrap; }
    .num{ text-align:right; white-space:nowrap; }
    .total{ font-weight:800; }
    .round-cell{ min-width:78px; text-align:right; }
    .round-link{ display:block; color:inherit; text-decoration:none; }
    .round-link:hover{ text-decoration:underline; }
    .top{ background:#fff8e1 !important; font-weight:700; }

    .name-wrap{ display:flex; align-items:center; gap:6px; white-space:nowrap; overflow:hidden; min-width:0; }
    .name-text{ font-weight:700; overflow:hidden; text-overflow:ellipsis; }

    /* --- B√≥nusz leny√≠l√≥ gomb + lebeg≈ë panel --- */
    .bonus-btn{
      width:24px; height:24px; border-radius:999px; border:1px solid var(--line);
      background:#f8fafc; display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer; margin-left:6px;
    }
    .bonus-btn svg{ width:14px; height:14px; transition: transform .18s ease; }
    .bonus-btn[aria-expanded="true"] svg{ transform: rotate(180deg); }

    .bonus-card{
      position:fixed; z-index:1200; display:none;
      width:min(340px, calc(100vw - 32px));
      background:#fff; border:1px solid var(--line); border-radius:12px;
      box-shadow:0 14px 36px rgba(0,0,0,.18);
    }
    .bonus-card.open{ display:block; }
    .bonus-card .head{ padding:10px 12px; border-bottom:1px solid var(--line); background:#f7f9fd; font-weight:800; }
    .bonus-card .body{ padding:10px 12px; display:grid; grid-template-columns:1fr; gap:8px; }
    .bonus-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid var(--line); border-radius:10px; padding:8px 10px; }
    .bonus-row .tag{ display:inline-flex; align-items:center; gap:6px; font-weight:700; }
    .bonus-row .pct{ font-variant-numeric: tabular-nums; font-weight:800; }
    .legend{ font-size:12px; color:var(--muted); padding:0 12px 10px; }

    .ok{ color:#15803d; font-weight:700; }
    .wrong{ color:#b91c1c; font-weight:700; }
    .dbl{ font-weight:800; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ------------------ UCL NAMESPACE ------------------ */
    const NS = "ucl";
    const col = (name) => `${NS}_${name}`;
    const settingsDocId = `${NS}_leaderboardConfig`;
    const localLiveKey = `${NS}_liveStandingsOrder`;

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ---- util ---- */
    const fmt = n => (Number(n)||0).toFixed(2);
    const fmtInt = n => (Number(n)||0).toFixed(0);
    const fmtTime = ts => { try{ return ts.toDate().toLocaleString("hu-HU",{hour12:false}); }catch{ return ""; } };
    const escapeHtml = s => String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const NORM = s => String(s ?? "").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const eqTeam = (a,b) => !!a && !!b && NORM(a) === NORM(b);
    const eqText = (a,b) => NORM(a) === NORM(b);
    const pctColor = p => `hsl(${Math.max(0,Math.min(12,p))/12*120}deg,85%,40%)`;
    const tipChoice = t => t.choice ?? t.tip ?? "";
    function tipDouble(t){ return !!(t.double ?? t.isDouble); }
    const matchRound = m => String(m.round ?? m.roundId ?? m.matchday ?? m.md ?? "");

    function getOdds(m, key){
      if (m?.odds && (key in m.odds)) return m.odds[key];
      if (key==="1") return m.odds1 ?? m["odds1"];
      if (key==="X") return m.oddsX ?? m["oddsX"];
      if (key==="2") return m.odds2 ?? m["odds2"];
      return undefined;
    }

    /* ---- √©l≈ë sorrend localStorage-b√≥l (UCL) ---- */
    function readLiveOrderFromLocal(){
      try{
        const raw = localStorage.getItem(localLiveKey);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr.slice(0,32).map(x => String(x||""));
      }catch{ return []; }
    }

    /* ---- B√≥nusz %-k (winner/golden/top8) ‚Äì rugalmas sz√°m√≠t√°s ---- */
    const toNum = v => {
      if (v === null || v === undefined || v === '') return null;
      if (typeof v === 'string') v = v.replace(',', '.');
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };
    const fromCandidateOdds = c => {
      const direct = toNum(c?.odds);
      if (direct != null) return direct;
      const dec = toNum(c?.oddsDecimal);
      if (dec != null) return dec;
      const pct = toNum(c?.oddsPercent);
      if (pct != null && pct > 0) return 100 / pct;
      return null;
    };
    const fromDisplayedPoints = c => toNum(c?.displayPoints);
    function computePoints(odds, BASE=10, O0=65, A=0.33, LO=0.5, HI=2.5){
      const o = toNum(odds);
      if(!o || o<=0) return null;
      const ratio   = Math.pow(o/Math.max(O0,1e-9), A);
      const clamped = Math.min(Math.max(ratio, LO), HI);
      return BASE * clamped; // %-pont
    }
    function candidatePoints(c, scope){
      const dp = fromDisplayedPoints(c);
      if (dp != null) return dp;
      const odds = fromCandidateOdds(c);
      const cfg  = (c?._calc && c._calc.scope === scope) ? c._calc : {};
      return computePoints(
        odds,
        cfg.BASE ?? 10,
        cfg.O0   ?? 65,
        cfg.A    ?? 0.33,
        cfg.LO   ?? 0.5,
        cfg.HI   ?? 2.5
      );
    }
    const BONUS_TOP8 = Object.freeze({ perHitPct: 1, maxPct: 8 });

    /* ---- √Ållapot ---- */
    let currentUserEmail = "";
    let currentUserNick = "";
    let currentUserRole = "user";

    let showAllView = false;
    let showBots = false;

    let rows = [];
    let roundsAsc = [];
    let usersInfo = {};
    let matchesCache = {};
    let botPickStore = {};

    let seasonTipsByEmail = {};
    let officialAwards = {};
    let officialOrder = [];
    let championCandidates = [];
    let goldenCandidates = [];

    // Admin be√°ll√≠t√°s ‚Äì SZ√ÅMOL√ÅSRA HAT
    let LB_MODE = "full";      // "full" | "fromRound"
    let LB_START = 1;

    /* ---------------- INIT ---------------- */
    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        currentUserEmail = user.email;

        const userRef = doc(db, "users", currentUserEmail);
        const userSnap = await getDoc(userRef);
        currentUserNick = userSnap.exists() ? (userSnap.data().nickname || user.email) : user.email;
        currentUserRole = userSnap.exists() ? (userSnap.data().role || "user") : "user";
        document.getElementById("welcome").textContent = `√údv, ${currentUserNick}!`;
        if (currentUserRole === "admin") document.getElementById("adminLink")?.style?.setProperty('display','flex');

        // Leaderboard config (UCL)
        const lbSnap = await getDoc(doc(db,"settings", settingsDocId));
        if (lbSnap.exists()){
          const cfg = lbSnap.data()||{};
          LB_MODE  = (cfg.mode==="fromRound") ? "fromRound" : "full";
          LB_START = Math.max(1, Number(cfg.startFrom)||1);
        }

        await buildLeaderboard();
        updateControlsText();

        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(() => window.location.href = "login.html");
      });

      document.getElementById('toggleAll').addEventListener('click', ()=>{
        showAllView = !showAllView;
        updateControlsText();
        renderTable();
      });

      const botsEl = document.getElementById('showBots');
      if (botsEl){
        botsEl.checked = showBots;
        botsEl.addEventListener('change', async e=>{
          showBots = e.target.checked;
          await buildLeaderboard();
        });
      }

      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-bonus]');
        if (btn){ openBonusCard(btn.getAttribute('data-bonus'), btn); }
        if (e.target.matches('[data-bonus-close]')){ closeBonusCard(); }
        if (!e.target.closest('#bonusCard')) closeBonusCard();
      });
      window.addEventListener('keydown', e=>{ if (e.key==='Escape') { closeBonusCard(); }});
      window.addEventListener('resize', ()=>{ closeBonusCard(); });
      window.addEventListener('scroll', ()=>{ closeBonusCard(); });
    });

    function updateControlsText(){
      const btn = document.getElementById('toggleAll');
      const rangeLabel = document.getElementById('rangeLabel');
      btn.textContent = showAllView ? 'Csak az utols√≥ 5 fordul√≥' : 'Mutasd az √∂sszes fordul√≥t';
      rangeLabel.textContent =
        (LB_MODE==='fromRound'
          ? `Sz√°mol√°s: ${LB_START}. fordul√≥t√≥l ‚Ä¢ N√©zet: ${showAllView ? '√∂sszes fordul√≥' : 'utols√≥ 5 fordul√≥'}`
          : `Sz√°mol√°s: teljes szezon ‚Ä¢ N√©zet: ${showAllView ? '√∂sszes fordul√≥' : 'utols√≥ 5 fordul√≥'}`);
    }

    /* ---------------- Adatok bet√∂lt√©se √©s SZ√ÅM√çT√ÅS (UCL) ---------------- */
    async function buildLeaderboard(){
      const [
        matchesSnap, tipsSnap, usersSnap,
        standingsTipsSnap, seasonTipsSnap, bonusTipsSnap,
        awardsDoc, champCandsSnap, goldenCandsSnap
      ] = await Promise.all([
        getDocs(collection(db, col("matches"))),
        getDocs(collection(db, col("tips"))),
        getDocs(collection(db, "users")),
        getDocs(collection(db, col("standingsTips"))).catch(()=>({empty:true, forEach(){}})),
        getDocs(collection(db, col("seasonTips"))).catch(()=>({empty:true, forEach(){}})),
        getDocs(collection(db, col("bonusTips"))).catch(()=>({empty:true, forEach(){}})),
        getDoc(doc(db, col("awards"), "official")).catch(()=>({exists:()=>false, data:()=>({})})),
        getDocs(collection(db, col("championCandidates"))).catch(()=>({empty:true, docs:[]})),
        getDocs(collection(db, col("goldenBootCandidates"))).catch(()=>({empty:true, docs:[]}))
      ]);

      matchesCache = {};
      matchesSnap.forEach(d => matchesCache[d.id] = { id:d.id, ...d.data() });

      usersInfo = {};
      usersSnap.forEach(d => { const u = d.data(); if (u?.email) usersInfo[u.email] = { nick: u.nickname || u.email }; });

      // UCL "official" adatok: gy≈ëztes, g√≥lkir√°ly, top8Teams, (opcion√°lisan officialOrder ‚Äì pl. power ranking / √©l≈ë elo)
      officialAwards = awardsDoc?.exists?.() ? (awardsDoc.data()||{}) : {};
      officialOrder = Array.isArray(officialAwards.order) ? officialAwards.order.slice() : [];
      const liveOrder = readLiveOrderFromLocal();
      const refOrder = liveOrder.filter(Boolean).length ? liveOrder : officialOrder;

      const orderByEmail = {};
      standingsTipsSnap?.forEach?.(d=>{
        const data = d.data() || {};
        let arr = [];
        if (Array.isArray(data.order)) arr = data.order;
        else if (Array.isArray(data.teams)) arr = data.teams;
        else if (Array.isArray(data.ranking)) arr = data.ranking;
        orderByEmail[d.id] = (arr || []).slice();
      });

      // Season picks (winner / topScorer / top8)
      seasonTipsByEmail = {};
      const mergeTipDoc = (id, data) => {
        if (!id || !data) return;
        const cur = seasonTipsByEmail[id] || {};
        const winnerTeam = data.winnerTeam || data.winner || cur.winnerTeam || "";
        const topScorer  = data.topScorer  || data.goldenBoot || cur.topScorer  || "";
        const top8       = Array.isArray(data.top8) ? data.top8 : (Array.isArray(cur.top8) ? cur.top8 : []);
        seasonTipsByEmail[id] = { winnerTeam, topScorer, top8 };
      };
      seasonTipsSnap?.forEach?.(d => mergeTipDoc(d.id, d.data()));
      bonusTipsSnap?.forEach?.(d => mergeTipDoc(d.id, d.data()));

      championCandidates = champCandsSnap?.docs?.map(d=>({ id:d.id, ...(d.data()||{}) })) || [];
      goldenCandidates   = goldenCandsSnap?.docs?.map(d=>({ id:d.id, ...(d.data()||{}) })) || [];

      // Utols√≥ tipp verzi√≥
      const latest = new Map();
      tipsSnap.forEach(docu=>{
        const t = docu.data(); if (!t?.matchId || !t?.user) return;
        const k = t.user + "|" + t.matchId;
        const cur = latest.get(k);
        const curTs = cur?.updatedAt?.toMillis?.() || cur?.createdAt?.toMillis?.() || 0;
        const ts = t.updatedAt?.toMillis?.() || t.createdAt?.toMillis?.() || 0;
        if (!cur || ts >= curTs) latest.set(k, { id:docu.id, ...t });
      });

      const player = {};
      const rounds = new Set();

      // SZ√ÅMOL√ÅS: admin be√°ll√≠t√°s szerint sz≈±rj√ºk a fordul√≥kat
      for (const tip of latest.values()){
        const m = matchesCache[tip.matchId]; if (!m) continue;
        const roundId = matchRound(m); if (!roundId) continue;
        if (LB_MODE === "fromRound" && (parseInt(roundId)||0) < LB_START) continue;

        rounds.add(roundId);
        if (!m.outcome) continue;
        const pick = tipChoice(tip); if (!pick) continue;

        const correct = pick === m.outcome;
        const ov = getOdds(m, pick);
        const mult = tipDouble(tip) ? 2 : 1;
        const pts = (correct && ov) ? Number(ov) * mult : 0;

        const info = usersInfo[tip.user] || { nick: tip.user };
        const nick = info.nick;
        if (!player[nick]) player[nick] = { base:0, perRound:{}, email: tip.user };
        player[nick].base += pts;
        player[nick].perRound[roundId] = (player[nick].perRound[roundId]||0) + pts;
      }

      roundsAsc = Array.from(rounds).sort((a,b)=> (parseInt(a)||0)-(parseInt(b)||0));

      // Top8% (UCL: negyedd√∂nt≈ës csapatok)
      function top8Pct(email){
        const userTop8 = (seasonTipsByEmail[email]?.top8 && seasonTipsByEmail[email].top8.length)
          ? seasonTipsByEmail[email].top8
          : (orderByEmail[email] || []).slice(0,8);
        const officialTop8 = Array.isArray(officialAwards.top8Teams) && officialAwards.top8Teams.length
          ? officialAwards.top8Teams
          : (refOrder || []).slice(0,8);
        if (!userTop8.length || !officialTop8.length) return 0;
        const setOfficial = new Set(officialTop8.map(NORM));
        let hits = 0;
        for (const t of userTop8){ if (setOfficial.has(NORM(t))) hits++; }
        return Math.min(hits * BONUS_TOP8.perHitPct, BONUS_TOP8.maxPct);
      }
      // Gy≈ëztes %
      function champBonusPct(email){
        const pick = seasonTipsByEmail[email]?.winnerTeam || "";
        const official = officialAwards.winnerTeam || officialAwards.winner || "";
        if (!pick || !official || !eqTeam(pick, official)) return 0;
        const c = championCandidates.find(x => eqTeam(x.team, pick));
        const pct = candidatePoints(c,'champion');
        return toNum(pct) ?? 0;
      }
      // G√≥lkir√°ly %
      function goldenBonusPct(email){
        const pick = seasonTipsByEmail[email]?.topScorer || "";
        const official = officialAwards.topScorer || "";
        if (!pick || !official || !eqText(pick, official)) return 0;
        const c = goldenCandidates.find(x => eqText(x.player, pick));
        const pct = candidatePoints(c,'golden');
        return toNum(pct) ?? 0;
      }

      rows = Object.entries(player).map(([nick,obj])=>{
        const champPct = champBonusPct(obj.email);
        const goldenPct = goldenBonusPct(obj.email);
        const top8 = top8Pct(obj.email);
        const bonusPct = (champPct || 0) + (goldenPct || 0) + (top8 || 0);
        const bonusPts = Math.round(obj.base * (bonusPct/100));
        const total = obj.base + bonusPts;
        return {
          nick, email: obj.email,
          base: obj.base, perRound: obj.perRound,
          parts: { champPct, goldenPct, top8Pct: top8 },
          bonusPct, bonusPts, total, isBot:false
        };
      });

      if (showBots){
        const botRows = addBotRows(matchesCache, roundsAsc);
        rows = rows.concat(botRows);
      }

      rows.sort((a,b)=> b.total - a.total || a.nick.localeCompare(b.nick));
      renderTable();
    }

    function addBotRows(matches, roundsAsc){
      botPickStore = {};
      const bots = [];
      function calcForBot(type){
        let base = 0; const perRound = {}; const byRound = {};
        for (const r of roundsAsc){
          const ms = Object.values(matches).filter(m=>matchRound(m)===r && m.outcome);
          if (!ms.length) continue;
          const tips = ms.map(m=>{
            let pick="", odds=0;
            const o1=getOdds(m,"1"), oX=getOdds(m,"X"), o2=getOdds(m,"2");
            if (type==="Evidens Elek"){
              const min = Math.min(o1||Infinity,oX||Infinity,o2||Infinity);
              if (min===o1){ pick="1"; odds=o1; } else if (min===oX){ pick="X"; odds=oX; } else if (min===o2){ pick="2"; odds=o2; }
            } else if (type==="Hazai Hug√≥"){ pick="1"; odds=o1; }
            else if (type==="Ikszes Ilona"){ pick="X"; odds=oX; }
            else if (type==="Vend√©g Vendel"){ pick="2"; odds=o2; }
            return {m,pick,odds};
          });
          let bestIdx=-1, bestVal=-1;
          tips.forEach((t,i)=>{
            if (!t || !t.m) return;
            let val=0;
            const o1=getOdds(t.m,"1"), oX=getOdds(t.m,"X"), o2=getOdds(t.m,"2");
            if (type==="Evidens Elek"){ val = Math.min(o1||Infinity,oX||Infinity,o2||Infinity); if (!isFinite(val)) val=-1; }
            else if (type==="Hazai Hug√≥"){ val = o1||0; }
            else if (type==="Ikszes Ilona"){ val = oX||0; }
            else if (type==="Vend√©g Vendel"){ val = o2||0; }
            if (val>bestVal){ bestVal=val; bestIdx=i; }
          });
          const list = [];
          tips.forEach((t,i)=>{
            if (!t.pick || !t.odds) return;
            const doubled = i===bestIdx;
            const correct = t.m.outcome===t.pick;
            const mult = doubled?2:1;
            if (correct){ base += t.odds*mult; perRound[r] = (perRound[r]||0)+t.odds*mult; }
            else { perRound[r] = (perRound[r]||0)+0; }
            list.push({
              matchId: t.m.id,
              homeTeam: t.m.homeTeam || t.m.home || "",
              awayTeam: t.m.awayTeam || t.m.away || "",
              pick: t.pick, odds: t.odds || 0, doubled, correct, outcome: t.m.outcome || ""
            });
          });
          if (list.length) byRound[r]=list;
        }
        return {base, perRound, byRound};
      }
      ["Evidens Elek","Hazai Hug√≥","Ikszes Ilona","Vend√©g Vendel"].forEach(name=>{
        const {base, perRound, byRound} = calcForBot(name);
        bots.push({ nick:name, email:"", base, perRound, bonusPct:0, bonusPts:0, total:base, isBot:true, parts:{champPct:0,goldenPct:0,top8Pct:0} });
        botPickStore[name] = byRound;
      });
      return bots;
    }

    function renderTable(){
      const mount = document.getElementById('tableMount');
      if (!rows.length){ mount.innerHTML = "<div style='padding:12px'>M√©g nincs megjelen√≠thet≈ë pontsz√°m.</div>"; return; }

      const roundsDesc = roundsAsc.slice().reverse();
      const toShow = showAllView ? roundsDesc : roundsDesc.slice(0, 5);

      const maxPerRound = toShow.map(r=>{
        let m = -Infinity;
        rows.forEach(row => { m = Math.max(m, row.perRound[r]||0); });
        return m === -Infinity ? 0 : m;
      });

      const leftHeader = `
        <div class="hdr">
          <div class="cell left rank">Hely</div>
          <div class="cell left">J√°t√©kos</div>
          <div class="cell left num">√ñsszesen</div>
          <div class="cell left num">B√≥nusz (pont + %)</div>
          <div class="cell left num">Alap pont</div>
        </div>`;

      const rightHeader = toShow.map(r=>`<div class="cell round-cell"><a class="round-link" href="results-ucl.html?round=${encodeURIComponent(r)}">F${r}</a></div>`).join('');

      const container = document.createElement('div'); container.className = 'table-wrap';

      const left = document.createElement('div');
      left.className = 'left';
      left.style.minWidth = '900px';
      left.style.maxWidth = '900px';
      left.innerHTML = `
        <div class="grid" style="grid-template-columns:70px 2.8fr 130px 200px 120px;">
          ${leftHeader}
          ${rows.map((r,i)=> renderLeftRow(r,i)).join('')}
        </div>
      `;

      const right = document.createElement('div');
      right.style.overflow = 'auto';
      right.style.flex = '1';
      right.innerHTML = `
        <div class="grid" style="grid-template-columns:${'78px '.repeat(toShow.length)};">
          <div class="hdr">${rightHeader}</div>
          ${rows.map(r=>{
            const cells = toShow.map((rid, idx)=>{
              const val = r.perRound[rid]||0;
              const isTop = val === maxPerRound[idx] && val !== 0;
              return `<div class="cell round-cell num ${isTop?'top':''}">
                        <a class="round-link" href="results-ucl.html?round=${encodeURIComponent(rid)}">${fmt(val)}${isTop?' ‚≠ê':''}</a>
                      </div>`;
            }).join('');
            return `<div class="row row-bg">${cells}</div>`;
          }).join('')}
        </div>
      `;

      mount.innerHTML = '';
      container.appendChild(left);
      container.appendChild(right);
      mount.appendChild(container);
    }

    function renderLeftRow(r,i){
      const bonusPctStr = `+${fmt(r.bonusPct)}%`;
      const bonusPctCol = `style="color:${pctColor(r.bonusPct)}"`;

      return `
        <div class="row row-bg">
          <div class="cell left rank">${i+1}.</div>
          <div class="cell left"><div class="name-wrap"><span class="name-text">${escapeHtml(r.nick)}</span></div></div>
          <div class="cell left num total">${fmt(r.total)}</div>
          <div class="cell left num">
            +${fmtInt(r.bonusPts)}
            <span ${bonusPctCol}> ( ${bonusPctStr} )</span>
            ${r.isBot ? '' : `<button class="bonus-btn" data-bonus="${escapeHtml(r.nick)}" aria-label="B√≥nusz bont√°s" aria-expanded="false" title="R√©szletek">
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 10l5 5 5-5z"/></svg>
            </button>`}
          </div>
          <div class="cell left num">${fmt(r.base)}</div>
        </div>
      `;
    }

    /* ---- B√≥nusz lebeg≈ë panel ---- */
    function openBonusCard(nick, anchorEl){
      const row = rows.find(r=>r.nick===nick);
      if (!row) return;

      const pop = document.getElementById('bonusCard');
      const head = pop.querySelector('.head');
      const body = pop.querySelector('.body');
      head.textContent = `${nick} ‚Äì b√≥nusz bont√°s (UCL)`;
      const items = [
        { icon:'üèÜ', label:'Gy≈ëztes', val: row.parts?.champPct || 0 },
        { icon:'üëü', label:'G√≥lkir√°ly', val: row.parts?.goldenPct || 0 },
        { icon:'üìä', label:'Top8', val: row.parts?.top8Pct || 0 },
      ];
      body.innerHTML = items.map(it=>`
        <div class="bonus-row">
          <div class="tag">${it.icon} ${it.label}</div>
          <div class="pct" style="color:${pctColor(it.val)}">+${fmt(it.val)}%</div>
        </div>
      `).join('') + `<div class="legend">√ñsszesen: <strong>+${fmt(row.bonusPct)}%</strong> ‚Üí <strong>+${fmtInt(row.bonusPts)}</strong> pont</div>`;

      // poz√≠cion√°l√°s
      pop.style.top = '0px'; pop.style.left = '0px';
      pop.classList.add('open');
      const r = anchorEl.getBoundingClientRect();
      const margin = 10;
      const pw = pop.offsetWidth, ph = pop.offsetHeight;
      let top = r.bottom + 8;
      let left = Math.min(Math.max(margin, r.right - pw), window.innerWidth - pw - margin);
      if (top + ph > window.innerHeight - margin) top = r.top - ph - 8;
      if (top < margin) top = margin;
      if (left < margin) left = margin;
      pop.style.top  = `${Math.round(top)}px`;
      pop.style.left = `${Math.round(left)}px`;

      // aria √°llapot
      document.querySelectorAll('[data-bonus][aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false'));
      anchorEl.setAttribute('aria-expanded','true');
    }
    function closeBonusCard(){
      const pop = document.getElementById('bonusCard');
      pop.classList.remove('open');
      document.querySelectorAll('[data-bonus][aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false'));
    }
  </script>
</head>
<body>
  <div class="layout">
    <!-- Fejl√©c -->
    <div class="header">
      <div class="header-left">
        <div>
          <h1>UCL TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
      </div>
      <div>
        <button id="logout" class="btn" aria-label="Kil√©p√©s" style="background:var(--accent);color:#fff;border:1px solid var(--line);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-3px;margin-right:6px">
            <path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"/>
          </svg>
          Kil√©p√©s
        </button>
      </div>
    </div>

    <!-- Ranglista -->
    <section class="card">
      <div class="subhdr">
        <button id="toggleAll" class="btn">Mutasd az √∂sszes fordul√≥t</button>
        <label style="display:flex; align-items:center; gap:6px; font-size:14px; user-select:none;">
          <input type="checkbox" id="showBots">
          Mutasd a g√©pi tippel≈ëket (Elek, Hug√≥, Ilona, Vendel)
        </label>
        <span id="rangeLabel" class="muted"></span>
      </div>
      <div id="tableMount"></div>
      <div style="padding:8px 12px; font-size:12px; color:#64748b;">‚≠ê = adott fordul√≥ legmagasabb pontja</div>
    </section>
  </div>

  <!-- B√≥nusz breakdown popover -->
  <div id="bonusCard" class="bonus-card" role="dialog" aria-modal="false" aria-hidden="true">
    <div class="head">B√≥nusz bont√°s</div>
    <div class="body"></div>
  </div>
</body>
</html>
