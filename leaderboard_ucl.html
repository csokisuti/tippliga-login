<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>BL TippLiga ‚Äì √ñsszes√≠tett ranglista</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="fav2.png" sizes="16x16">
  <link rel="icon" type="image/png" href="fav2.png" sizes="32x32">
  <link rel="icon" type="image/png" href="fav2.png">
  <script src="loader.js" defer></script>

  <style>
    :root{ --line:#e6eaf1; --muted:#64748b; --accent:#3b82f6; --rowh:48px; --hdrh:44px; }

    .layout{ display:flex; flex-direction:column; gap:16px; max-width:1200px; margin:0 auto; padding:20px; }

    /* Header / nav ‚Äì egys√©ges */
    .header{ display:flex; align-items:center; justify-content:space-between; }
    .header-left{ display:flex; align-items:center; gap:12px; }
    .fav-crest{ width:46px; height:46px; object-fit:contain; border-radius:8px; border:1px solid var(--line); background:#fff; }
    .welcome{ color:var(--muted); margin:4px 0 0; }

    /* Liga-v√°lt√≥ balra, a c√≠m mell√© */
    .league-switch-left{ margin-left:8px }
    @media (max-width:700px){ .league-switch-left{ width:100%; margin-left:0 } }

    .nav-grid{ display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:14px; }
    @media (max-width:1100px){ .nav-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width:700px){ .nav-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    .nav-card{ display:flex; gap:12px; align-items:center; text-decoration:none; color:inherit; padding:14px; background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 6px 18px rgba(15,23,42,.05); }
    .nav-card .icon-wrap{ width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center; background:color-mix(in oklab, var(--accent) 15%, white); color:var(--accent); }
    .nav-card .text{ display:flex; flex-direction:column; line-height:1.2; }
    .nav-card .title{ font-weight:800; }
    .nav-card .desc{ color:var(--muted); font-size:12px; }
    .pill-badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; margin-left:6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:700; line-height:1; vertical-align:middle; }
    .pill-badge[hidden]{ display:none !important; }

    /* Countdown badge a Top8-hoz */
    .pill-badge.countdown{
      background:#ef4444;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-variant-numeric: tabular-nums;
      letter-spacing:.2px;
    }
    .pill-badge.countdown.urgent{ animation:pulse 1s ease-in-out infinite }
    @keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.06)} 100%{transform:scale(1)} }
    .blink{ animation:blink 1s steps(2,start) infinite }
    @keyframes blink{ to{ opacity:.2 } }

    /* Gombok */
    .btn{ border:1px solid var(--line); background:#e5e7eb; color:#111; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .btn-accent{ background:var(--accent); color:#fff; border:1px solid var(--line); }
    .btn-accent:hover{ filter:brightness(.95); }
    .btn-accent:focus{ outline:2px solid color-mix(in oklab, var(--accent) 30%, white); outline-offset:2px; }

    .muted{ color:var(--muted); }

    /* K√°rtya */
    .card{ background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 6px 18px rgba(15,23,42,.06); overflow:hidden; }
    .subhdr{ background:#f7f9fd; border-bottom:1px solid var(--line); padding:10px 12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }

    /* T√ÅBL√ÅZAT ‚Äì NB1 st√≠lus */
    .table-wrap{ display:flex; }
    .table-wrap > div:last-child { -webkit-overflow-scrolling: touch; }
    .grid{ display:grid; }
    .hdr, .row{ display:contents; }
    .cell{ padding:8px 12px; border-bottom:1px solid var(--line); background:#fff; display:flex; align-items:center; gap:8px; box-sizing:border-box; height:var(--rowh); overflow:hidden; }
    .hdr .cell{ font-weight:700; background:#f7f8fc; height:var(--hdrh); }
    .row-bg:nth-child(even) .cell{ background:#fcfdff; }

    .left{ position:sticky; left:0; z-index:3; background:#fff; border-right:1px solid var(--line); }
    .left .cell{ background:#fff; }

    .rank{ text-align:right; color:#64748b; white-space:nowrap; }
    .num{ text-align:right; white-space:nowrap; }
    .total{ font-weight:800; }
    .round-cell{ min-width:78px; text-align:right; }
    .round-link{ display:block; color:inherit; text-decoration:none; }
    .round-link:hover{ text-decoration:underline; }
    .top{ background:#fff8e1 !important; font-weight:700; }

    /* N√©v + c√≠mer / bot mini avatar */
    .name-wrap{ display:flex; align-items:center; gap:6px; white-space:nowrap; overflow:hidden; min-width:0; }
    .name-crest{ width:22px; height:22px; object-fit:contain; border-radius:6px; border:1px solid var(--line); background:#fff; flex:0 0 auto; }
    .avatar-mini{ width:22px; height:22px; object-fit:cover; border-radius:6px; border:1px solid var(--line); flex:0 0 auto; }
    .name-text{ font-weight:700; overflow:hidden; text-overflow:ellipsis; }
    .name-subtle{ font-weight:700; opacity:.9; overflow:hidden; text-overflow:ellipsis; font-size:14px; }
    .name-actions{ display:inline-flex; gap:4px; margin-left:6px; white-space:nowrap; flex-shrink:0; }
    .link-btn{ font-size:11px; padding:3px 7px; border:1px solid var(--line); border-radius:8px; background:#f8fafc; cursor:pointer; line-height:1; white-space:nowrap; }
    .bot-btn{ border-color: color-mix(in oklab, var(--accent) 40%, white); background: color-mix(in oklab, var(--accent) 12%, white); color: var(--accent); font-weight:700; }

    /* B√ìNUSZ gomb */
    .bonus-cell{ justify-content:flex-end; }
    .bonus-chip{ display:inline-flex; align-items:center; gap:6px; }

    /* Bonus popover */
    .bonus-backdrop{ position:fixed; inset:0; z-index:9998; background:transparent; }
    .bonus-pop{
      position:fixed; z-index:9999; width:min(460px, calc(100vw - 32px));
      background:#fff; border:1px solid var(--line); border-radius:12px;
      box-shadow:0 14px 40px rgba(0,0,0,.22); padding:12px;
    }
    .bonus-pop .title{ font-weight:800; margin-bottom:8px; }
    .grid2{ display:grid; grid-template-columns:140px 1fr; gap:8px 12px; }
    .btag{ display:inline-flex; gap:6px; align-items:center; font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; color:#334155; }
    .btag.ok{ background:#ecfdf5; border-color:#bbf7d0; color:#166534; }
    .btag.pending{ background:#fffbeb; border-color:#fde68a; color:#a16207; }
    .btag.no{ background:#fef2f2; border-color:#fecaca; color:#991b1b; }
    .muted-xs{ color:var(--muted); font-size:12px; }

    /* Bot profil-popover √©s modal ‚Äì NB1-azonos */
    .bot-card{ position:fixed; z-index:1200; display:none; width:min(420px, calc(100vw - 32px)); background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 14px 36px rgba(0,0,0,.18); }
    .bot-card.open{ display:block; }
    .bot-card .head{ display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid var(--line); background:#f7f9fd; }
    .bot-card .avatar{ width:140px; height:140px; border-radius:14px; object-fit:cover; border:1px solid var(--line); flex:0 0 auto; }
    .bot-card .title{ font-weight:800; line-height:1.1; }
    .bot-card .tag{ font-size:12px; color:#64748b; }
    .bot-card .body{ padding:12px; font-size:14px; line-height:1.35; }
    .bot-card .actions{ display:flex; gap:8px; padding:10px 12px; border-top:1px solid var(--line); background:#fff; }

    .modal{ position:fixed; inset:0; background:rgba(15,23,42,.35); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal.open{ display:flex; }
    .modal-card{ width:min(900px, 96vw); max-height:84vh; background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 12px 34px rgba(0,0,0,.2); display:flex; flex-direction:column; }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-bottom:1px solid var(--line); background:#f7f9fd; }
    .modal-title{ font-weight:800; font-size:18px; white-space:nowrap; }
    .modal-body{ padding:12px; overflow:auto; }
    .close-x{ width:32px; height:32px; border-radius:8px; background:#eef2ff; color:#111; border:1px solid var(--line); cursor:pointer; }

    /* Tipp-lista jel√∂l√©sek a mod√°lban */
    .ok{ color:#15803d; font-weight:700; }
    .wrong{ color:#b91c1c; font-weight:700; }
    .dbl{ font-weight:800; }

    /* Chat ‚Äì egys√©ges */
    .chat-fab{ position:fixed; right:22px; bottom:22px; z-index:999; width:52px; height:52px; border-radius:999px; border:0; background:var(--accent); color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 26px rgba(0,0,0,.15); }
    .chat-fab .fab-badge{ position:absolute; top:-4px; right:-4px; min-width:20px; height:20px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:12px; font-weight:800; line-height:20px; display:none; }
    .chat-fab.has-unread .fab-badge{ display:inline-block; }
    .chat-panel{ position:fixed; right:22px; bottom:86px; z-index:998; width:380px; max-width:calc(100vw - 32px); max-height:70vh; display:none; flex-direction:column; background:#fff; border:1px solid var(--line); border-radius:14px; box-shadow:0 10px 32px rgba(0,0,0,.14); }
    .chat-panel.open{ display:flex; }
    .chat-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line); background:#f7f9fd; }
    .chat-title{ font-weight:800; }
    #chatClose{ width:28px; height:28px; border-radius:8px; font-size:18px; line-height:28px; display:inline-flex; align-items:center; justify-content:center; background:#eef2ff; color:#111; border:1px solid var(--line); cursor:pointer; }
    #chatClose:hover{ filter:brightness(0.95); }
    .chat-list{ overflow:auto; padding:8px 10px; }
    .chat-empty{ color:var(--muted); font-size:13px; padding:8px 10px; }
    .msg{ padding:8px 10px; border-bottom:1px solid var(--line); display:flex; gap:8px; align-items:flex-start; }
    .msg .meta{ font-size:12px; color:var(--muted); margin-bottom:2px; }
    .msg .text{ white-space:pre-wrap; word-break:break-word; }
    .msg .del{ margin-left:auto; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:2px 8px; border-radius:8px; font-size:12px; cursor:pointer; display:none; }
    .msg:hover .del{ display:inline-block; }
    #chatComposer{ display:flex; gap:8px; align-items:center; padding:10px; border-top:1px solid var(--line); background:#fff; }
    #chatInput{ background:#fff; color:#111; border:1px solid var(--line); height:40px; padding:8px 10px; border-radius:10px; font-size:14px; outline:none; width:100%; box-sizing:border-box; }
    #chatInput::placeholder{ color:#6b7280; }
    #chatSendBtn{ min-width:90px; padding:8px 12px; border-radius:10px; background:var(--accent); color:#fff; border:0; font-weight:600; cursor:pointer; }

    /* Tablet/phone finomhangol√°sok */
    @media (max-width: 1024px) {
      .left { position:relative; left:auto; z-index:1; border-right:0; }
      .table-wrap { overflow-x:auto; }
      .cell { padding:8px 10px; }
      .round-cell { min-width:64px; }
    }
    @media (max-width: 820px) {
      .layout { padding:14px; }
      .hdr .cell { height:40px; }
      .cell { height:42px; font-size:14px; }
      .nav-card { gap:10px; padding:12px; }
      .nav-card .icon-wrap { width:38px; height:38px; }
      .link-btn { padding:5px 9px; }
    }
    @media (pointer: coarse) {
      .btn, .link-btn, #chatSendBtn { min-height:40px; }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { initLeagueSwitcher } from "./league-switcher.js";

    /* ---------------- Firebase ---------------- */
    const firebaseConfig={apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",authDomain:"tippliga-4b3af.firebaseapp.com",projectId:"tippliga-4b3af",storageBucket:"tippliga-4b3af.appspot.com",messagingSenderId:"720359845241",appId:"1:720359845241:web:d3d6edcac6b43ebff053a8"};
    const app=initializeApp(firebaseConfig);const auth=getAuth(app);const db=getFirestore(app);

    /* --- Robot meta: NB1-tel egyez≈ë mott√≥ + r√©szletes bio --- */
    const BOT_META = {
      "Evidens Elek": {
        avatar:"elek-256.webp", avatar2x:"elek-512.webp",
        intro:"‚ÄûA legkisebb kock√°zat is kock√°zat, de m√©g mindig a legkisebb.‚Äù",
        bio: "Elek a ‚Äûkr√©t√°z√≥‚Äù tippmester: odds-alapon mindig a legalacsonyabb kimenetelt v√°lasztja. Stabil, apr√≥ hozamokra √©p√≠t, ritk√°n borul nagyot. A dupl√°j√°t mindig a fordul√≥ LEGKISEBB relev√°ns odds√°ra teszi."
      },
      "Hazai Hug√≥":  {
        avatar:"hugo-256.webp", avatar2x:"hugo-512.webp",
        intro:"‚ÄûOtthon a p√°lya, otthon a pont.‚Äù",
        bio: "Hug√≥ a hazai p√°ly√°ban hisz: minden meccsen 1-re megy. Amikor a favoritok hozz√°k a k√∂telez≈ët, sz√©pen termel. A dupl√°ja a fordul√≥ LEGKISEBB 1-es odds√°ra ker√ºl."
      },
      "Ikszes Ilona":{
        avatar:"ilona-256.webp", avatar2x:"ilona-512.webp",
        intro:"‚ÄûAz egyens√∫ly sz√©p ‚Äì f≈ëleg a jegyz≈ëk√∂nyvben.‚Äù",
        bio: "Ilona a d√∂ntetlenek specialist√°ja: minden meccsen X. Nagyobb egyedi tal√°latokra hajt, de nagyobb a sz√≥r√°sa is. A dupl√°ja a fordul√≥ LEGKISEBB X-odds√°ra megy."
      },
      "Vend√©g Vendel":{
        avatar:"vendel-256.webp", avatar2x:"vendel-512.webp",
        intro:"‚ÄûAz idegen gy≈ëzelem a leg√©desebb meglepet√©s.‚Äù",
        bio: "Vendel a vend√©gsikerekre j√°tszik, k√ºl√∂n√∂sen billeg≈ë pap√≠rform√°n√°l. Underdog-hull√°mban sokat ugrik. A dupl√°ja a fordul√≥ LEGKISEBB 2-es odds√°ra ker√ºl."
      }
    };

    /* ---------------- Helpers ---------------- */
    const crestMap={"Ajax":"ucl_crest/ajax.png","Arsenal":"ucl_crest/arsenal.png","Atalanta":"ucl_crest/atalanta.png","Athletic Bilbao":"ucl_crest/athletic.png","Atl√©tico Madrid":"ucl_crest/atletico.png","Barcelona":"ucl_crest/barcelona.png","Bayern M√ºnchen":"ucl_crest/bayern.png","Benfica":"ucl_crest/benfica.png","Borussia Dortmund":"ucl_crest/borussia.png","Bod√∏/Glimt":"ucl_crest/bodo.png","Club Bruges":"ucl_crest/brugge.png","Chelsea":"ucl_crest/chelsea.png","FC K√∂benhavn":"ucl_crest/copenhagen.png","Eintracht Frankfurt":"ucl_crest/frankfurt.png","Galatasaray":"ucl_crest/galata.png","Internazionale":"ucl_crest/inter.png","Juventus":"ucl_crest/juventus.png","Bayer Leverkusen":"ucl_crest/leverkusen.png","Liverpool":"ucl_crest/liverpool.png","Manchester City":"ucl_crest/mancity.png","Olympique Marseille":"ucl_crest/marseille.png","Monaco":"ucl_crest/monaco.png","Napoli":"ucl_crest/napoli.png","Newcastle United":"ucl_crest/newcastle.png","Olympiakosz Pireusz":"ucl_crest/olympiacos.png","Pafosz":"ucl_crest/pafos.png","Paris Saint-Germain":"ucl_crest/psg.png","PSV":"ucl_crest/psv.png","Qarabag":"ucl_crest/qarabag.png","Real Madrid":"ucl_crest/real.png","Slavia Praha":"ucl_crest/slavia.png","Sporting CP":"ucl_crest/sporting.png","Tottenham Hotspur":"ucl_crest/tottenham.png","Union Saint-Gilloise":"ucl_crest/usg.png","Villarreal":"ucl_crest/villareal.png","Kajrat Almati":"ucl_crest/kairat.png"};
    const crestFor=t=>crestMap[t]||"";
    const fmt=n=>(Number(n)||0).toFixed(2);
    const fmtTime=ts=>{try{return ts.toDate().toLocaleString("hu-HU",{hour12:false})}catch{return""}};
    const escapeHtml=s=>String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const NORM=s=>String(s??"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    const eqTeam=(a,b)=>!!a&&!!b&&NORM(a)===NORM(b);
    const eqText=(a,b)=>NORM(a)===NORM(b);

    function getOdds(m,key){
      if(m?.odds&&(key in m.odds))return m.odds[key];
      if(key==="1")return m.odds1??m["odds1"];
      if(key==="X")return m.oddsX??m["oddsX"];
      if(key==="2")return m.odds2??m["odds2"];
      return undefined;
    }
    const tipChoice=t=>t?.choice??t?.tip??"";
    const tipDouble=t=>!!(t?.double??t?.isDouble);
    const tipTsMs=t=>t?.updatedAt?.toMillis?.()||t?.createdAt?.toMillis?.()||t?.timestamp?.toMillis?.()||0;
    const matchRound=m=>String(m?.round??m?.roundId??"");

    function parseRes(str){const m=String(str||"").match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);return m?[parseInt(m[1]),parseInt(m[2])]:null}
    function deriveTop8FromMatches(allMatches){
      const teams=Object.keys(crestMap);const S={};teams.forEach(t=>S[t]={team:t,MP:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,Pts:0});const H2H={};
      (allMatches||[]).forEach(m=>{const A=m.homeTeam||m.home||"";const B=m.awayTeam||m.away||"";const r=parseRes(m.result);const a=S[A],b=S[B];if(!a||!b||!r)return;
        const[hg,ag]=r;a.MP++;b.MP++;a.GF+=hg;a.GA+=ag;a.GD=a.GF-a.GA;b.GF+=ag;b.GA+=hg;b.GD=b.GF-b.GA;
        if(hg>ag){a.W++;b.L++;a.Pts+=3}else if(hg<ag){b.W++;a.L++;b.Pts+=3}else{a.D++;b.D++;a.Pts+=1;b.Pts+=1}
        const k=[A,B].slice().sort((x,y)=>x.localeCompare(y,'hu')).join('|');H2H[k]||={[A]:{Pts:0,GF:0,GA:0},[B]:{Pts:0,GF:0,GA:0}};
        if(hg>ag){H2H[k][A].Pts+=3}else if(hg<ag){H2H[k][B].Pts+=3}else{H2H[k][A].Pts+=1;H2H[k][B].Pts+=1}
        H2H[k][A].GF+=hg;H2H[k][A].GA+=ag;H2H[k][B].GF+=ag;H2H[k][B].GA+=hg
      });
      function cmp(a,b){if(b.Pts!==a.Pts)return b.Pts-a.Pts;if(b.W!==a.W)return b.W-a.W;if(b.GD!==a.GD)return b.GD-a.GD;if(b.GF!==a.GF)return b.GF-a.GF;
        const k=[a.team,b.team].slice().sort((x,y)=>x.localeCompare(y,'hu')).join('|');const row=H2H[k];
        if(row){const pa=row[a.team]?.Pts??0,pb=row[b.team]?.Pts??0;if(pb!==pa)return pb-pa;const gda=(row[a.team]?.GF??0)-(row[a.team]?.GA??0);const gdb=(row[b.team]?.GF??0)-(row[b.team]?.GA??0);if(gdb!==gda)return gdb-gda}
        return a.team.localeCompare(b.team,'hu')}
      const rows=Object.values(S).sort(cmp);return rows.slice(0,8).map(r=>r.team)
    }

    /* ---- Bonus szab√°lyok ---- */
    const BONUS_CFG=Object.freeze({winnerPct:10,topScorerPct:5,top8PerHitPct:1,top8MaxPct:8});

    let currentUserEmail="",currentUserNick="",currentUserRole="user",favouriteTeamucl="",chatLastSeenUcl=null;

    /* √Ållapot ‚Äì BL kollekci√≥k */
    let usersMap={}, usersFavUcl={};
    let matchesById={}, roundsAsc=[];
    let officialTop8=[], officialChampion="", officialGoldenPlayer="";
    let top8TipsByEmail={}, championPickByEmail={}, goldenPickByEmail={};
    let latestTipsByUserMatch=new Map();

    let rows=[];
    let showBots=false;
    let botPickStore={};

    /* ===== Top8 visszasz√°ml√°l√≥ a NAV-hoz ===== */
    let POS_LOCK={active:false,until:null};
    let navCdTimer=null;

    function formatCountdown(ms){
      const total=Math.max(0,Math.floor(ms/1000));
      const d=Math.floor(total/86400);
      const h=Math.floor((total%86400)/3600);
      const m=Math.floor((total%3600)/60);
      const s=total%60;
      const H=String(h).padStart(2,"0"), M=String(m).padStart(2,"0"), S=String(s).padStart(2,"0");
      const labelHTML=d>0
        ? `<span class="mono">${d}n&nbsp;</span><span class="mono">${H}<span class="blink">:</span>${M}<span class="blink">:</span>${S}</span>`
        : `<span class="mono">${H}<span class="blink">:</span>${M}<span class="blink">:</span>${S}</span>`;
      const aria=d>0?`${d} nap ${h} √≥ra ${m} perc ${s} m√°sodperc`:`${h} √≥ra ${m} perc ${s} m√°sodperc`;
      return {labelHTML,aria,msLeft:total*1000};
    }
    function startNavTop8Countdown(until){
      clearInterval(navCdTimer);
      const el=document.getElementById("top8CountdownNav");
      if(!el){return}
      if(!until || POS_LOCK.active){ el.hidden=true; return; }
      function tick(){
        const ms=until-new Date();
        if(ms<=0){ el.hidden=true; clearInterval(navCdTimer); return; }
        const {labelHTML,aria,msLeft}=formatCountdown(ms);
        el.innerHTML=labelHTML;
        el.setAttribute("aria-live","polite");
        el.setAttribute("aria-label",`Visszasz√°ml√°l√≥: ${aria}`);
        el.title=`Hat√°rid≈ë: ${until.toLocaleString('hu-HU')}`;
        if(msLeft<=5*60*1000){ el.classList.add("urgent"); } else { el.classList.remove("urgent"); }
        el.hidden=false;
      }
      tick(); navCdTimer=setInterval(tick,1000);
    }
    async function loadPositionsLockAndApply(){
      try{
        const snap=await getDoc(doc(db,"settings","positionsLock_ucl"));
        let until=null,active=false;
        if(snap.exists()){
          const d=snap.data()||{};
          until=d.lockUntil?.toDate?.()||null;
          const now=new Date(); const timeLocked=until && now>=until;
          active=!!d.isLocked || timeLocked;
        }
        POS_LOCK={active,until};
      }catch{ POS_LOCK={active:false,until:null}; }
      startNavTop8Countdown(POS_LOCK.active?null:POS_LOCK.until);
    }

    document.addEventListener("DOMContentLoaded",()=>{
      /* Liga-v√°lt√≥ mount: BAL SZ√âL ‚Äì c√≠m mellett */
      initLeagueSwitcher({ mountTarget: document.getElementById('leagueSwitchMount') });

      onAuthStateChanged(auth,async(user)=>{
        if(!user){window.location.href="login_ucl.html";return}
        currentUserEmail=user.email;

        const userRef=doc(db,"users",currentUserEmail);
        const userSnap=await getDoc(userRef);
        if(userSnap.exists()){
          const d=userSnap.data();
          currentUserNick=d.nickname||currentUserEmail;
          currentUserRole=d.role||"user";
          favouriteTeamucl=d.favouriteTeamucl||"";
          chatLastSeenUcl=d.chatLastSeenUcl||null;
        }else{currentUserNick=currentUserEmail}
        document.getElementById("welcome").textContent=`√údv, ${currentUserNick}!`;
        if(currentUserRole==="admin")document.getElementById("adminLink").style.display="flex";
        if(favouriteTeamucl){
          const themeClass="theme-"+favouriteTeamucl.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-');
          document.body.classList.add(themeClass);
          const crest=crestFor(favouriteTeamucl);
          if(crest){const img=document.getElementById("favCrest");img.src=crest;img.alt=favouriteTeamucl;img.hidden=false}
        }

        /* NAV Top8 countdown bet√∂lt√©se */
        await loadPositionsLockAndApply();

        /* USERS */
        const usersSnap=await getDocs(collection(db,"users"));
        usersSnap.forEach(d=>{const u=d.data();if(u?.email){usersMap[u.email]=u.nickname||u.email;usersFavUcl[u.email]=u.favouriteTeamucl||""}});

        /* MATCHES (√©s fordul√≥k) */
        onSnapshot(collection(db,"ucl_matches"), snap=>{
          matchesById={};
          const roundSet=new Set();
          snap.forEach(d=>{const m={id:d.id,...d.data()};matchesById[m.id]=m;const r=matchRound(m);if(r)roundSet.add(r)});
          roundsAsc=Array.from(roundSet).sort((a,b)=>(parseInt(a)||0)-(parseInt(b)||0));
          officialTop8=deriveTop8FromMatches(Object.values(matchesById));
          recomputeRows(); renderTable();
        });

        /* TIPS ‚Äì utols√≥ verzi√≥ */
        const tipsAll=await getDocs(collection(db,"ucl_tips"));
        latestTipsByUserMatch=collectLatestTips(tipsAll);
        onSnapshot(collection(db,"ucl_tips"), snap=>{
          latestTipsByUserMatch=collectLatestTips(snap);
          recomputeRows(); renderTable();
        });

        /* OFFICIAL */
        onSnapshot(doc(db,"ucl_official","current"), snap=>{
          const d=snap.exists()?snap.data():{};
          officialChampion=d.champion||"";
          officialGoldenPlayer=(d.goldenBoot&&d.goldenBoot.player)?d.goldenBoot.player:"";
          recomputeRows(); renderTable();
        });

        /* TOP8/CHAMP/GOLDEN tippek */
        onSnapshot(collection(db,"ucl_top8Tips"), snap=>{
          top8TipsByEmail={};
          snap.forEach(docu=>{
            const t=docu.data()||{};const email=t.email||docu.id;
            top8TipsByEmail[email]=(Array.isArray(t.picks)?t.picks.slice(0,8):[]);
          });
          recomputeRows(); renderTable();
        });

        onSnapshot(collection(db,"ucl_championPickTips"), snap=>{
          championPickByEmail={};
          snap.forEach(docu=>{const t=docu.data()||{};const email=t.email||docu.id;championPickByEmail[email]=t.team||""});
          recomputeRows(); renderTable();
        });

        onSnapshot(collection(db,"ucl_goldenBootTips"), snap=>{
          goldenPickByEmail={};
          snap.forEach(docu=>{const t=docu.data()||{};const email=t.email||docu.id;goldenPickByEmail[email]=t.player||""});
          recomputeRows(); renderTable();
        });

        updatePendingBadge();
        initChat(userRef);
        if(window.hideLoader)hideLoader();
      });

      document.getElementById("logout").addEventListener("click",()=>{signOut(auth).then(()=>window.location.href="login_ucl.html")});
      document.getElementById("toggleAll").addEventListener("click",()=>{
        const st=document.getElementById("tableMount").dataset.mode!=="all";
        document.getElementById("tableMount").dataset.mode=st?"all":"last";
        document.getElementById("toggleAll").textContent=st?"Csak az utols√≥ 5 fordul√≥":"Mutasd az √∂sszes fordul√≥t";
        renderTable();
      });

      /* ROBOTOK kapcsol√≥ */
      const botsEl=document.getElementById('showBots');
      if(botsEl){
        botsEl.checked=showBots;
        botsEl.addEventListener('change',e=>{ showBots=e.target.checked; recomputeRows(); renderTable(); });
      }

      /* Bot UI esem√©nyek (NB1-azonos) */
      document.addEventListener('click',(e)=>{
        const trigger=e.target.closest('[data-bot-card]');
        if(trigger){ openBotCard(trigger.getAttribute('data-bot-card'), trigger); return; }
        if(e.target.matches('[data-bc-open-tips]')){ const n=document.getElementById('botCard').dataset.name; closeBotCard(); if(n) openBotModal(n); return; }
        if(e.target.matches('[data-bc-close]')){ closeBotCard(); return; }
        if(!e.target.closest('#botCard')) closeBotCard();

        const btn=e.target.closest('[data-bot-view]');
        if(btn){ openBotModal(btn.getAttribute('data-bot-view')); }
        if(e.target.matches('.close-x')) closeBotModal();
        if(e.target.classList.contains('modal')) closeBotModal();
      });

      window.addEventListener("scroll",closeBonusPopover,{passive:true});
      window.addEventListener("resize",()=>{ closeBonusPopover(); closeBotCard(); });
      document.addEventListener("keydown",e=>{if(e.key==="Escape"){closeBonusPopover(); closeBotModal(); closeBotCard(); }});
    });

    function collectLatestTips(snap){
      const latest=new Map();
      snap.forEach(docu=>{
        const t=docu.data();if(!t?.matchId||!t?.user)return;
        const k=t.user+"|"+t.matchId;
        const cur=latest.get(k);
        if(!cur||tipTsMs(t)>=tipTsMs(cur))latest.set(k,{id:docu.id,...t});
      });
      return latest;
    }

    function calcTop8Pct(email){
      const userPicks=(top8TipsByEmail[email]||[]).slice(0,8).filter(Boolean);
      const offTop8=(officialTop8||[]).slice(0,8).filter(Boolean);
      if(!userPicks.length||!offTop8.length)return{hits:0,pct:0};
      const setOfficial=new Set(offTop8.map(NORM));let hits=0;
      for(const t of userPicks){ if(setOfficial.has(NORM(t))) hits++; }
      const pct=Math.min(hits*BONUS_CFG.top8PerHitPct,BONUS_CFG.top8MaxPct);
      return{hits,pct};
    }

    /* ---------- ROBOTOK sz√°mol√°sa (NB1-azonos: dupla = LEGKISEBB relev√°ns odds) ---------- */
    function addBotRows(matches, roundsAsc){
      botPickStore={};
      const bots=[];

      function calcForBot(type){
        let base=0; const perRound={}; const byRound={};
        for(const r of roundsAsc){
          const ms=Object.values(matches).filter(m=>matchRound(m)===r && m.outcome);
          if(!ms.length) continue;

          // Tippk√©pz√©s meccsenk√©nt
          const tips=ms.map(m=>{
            let pick="", odds=0;
            const o1=getOdds(m,"1"), oX=getOdds(m,"X"), o2=getOdds(m,"2");
            if(type==="Evidens Elek"){
              const minVal=Math.min(
                o1 ?? Number.POSITIVE_INFINITY,
                oX ?? Number.POSITIVE_INFINITY,
                o2 ?? Number.POSITIVE_INFINITY
              );
              if(minVal===o1){ pick="1"; odds=o1; }
              else if(minVal===oX){ pick="X"; odds=oX; }
              else if(minVal===o2){ pick="2"; odds=o2; }
            }else if(type==="Hazai Hug√≥"){ pick="1"; odds=o1; }
            else if(type==="Ikszes Ilona"){ pick="X"; odds=oX; }
            else if(type==="Vend√©g Vendel"){ pick="2"; odds=o2; }
            return {m,pick,odds};
          });

          // Dupla kiv√°laszt√°sa: a LEGKISEBB relev√°ns odds kapja
          let bestIdx=-1, bestVal=Number.POSITIVE_INFINITY;
          tips.forEach((t,i)=>{
            if(!t || !t.m) return;
            let val;
            if(type==="Evidens Elek"){
              const a=getOdds(t.m,"1"), b=getOdds(t.m,"X"), c=getOdds(t.m,"2");
              val=Math.min(
                a ?? Number.POSITIVE_INFINITY,
                b ?? Number.POSITIVE_INFINITY,
                c ?? Number.POSITIVE_INFINITY
              );
            }else if(type==="Hazai Hug√≥"){ val=getOdds(t.m,"1"); }
            else if(type==="Ikszes Ilona"){ val=getOdds(t.m,"X"); }
            else if(type==="Vend√©g Vendel"){ val=getOdds(t.m,"2"); }
            if(val==null || !isFinite(val) || val<=0) return;
            if(val<bestVal){ bestVal=val; bestIdx=i; }
          });

          const list=[];
          tips.forEach((t,i)=>{
            if(!t.pick || !t.odds || !isFinite(t.odds)) return;
            const doubled=i===bestIdx;
            const correct=t.m.outcome===t.pick;
            const mult=doubled?2:1;
            if(correct){ base += t.odds*mult; perRound[r]=(perRound[r]||0)+t.odds*mult; }
            else { perRound[r]=(perRound[r]||0)+0; }
            list.push({
              matchId:t.m.id,
              homeTeam:t.m.homeTeam||t.m.home||"",
              awayTeam:t.m.awayTeam||t.m.away||"",
              pick:t.pick, odds:t.odds||0, doubled, correct, outcome:t.m.outcome||""
            });
          });
          if(list.length) byRound[r]=list;
        }
        return {base, perRound, byRound};
      }

      ["Evidens Elek","Hazai Hug√≥","Ikszes Ilona","Vend√©g Vendel"].forEach(name=>{
        const {base, perRound, byRound}=calcForBot(name);
        bots.push({ nick:name, email:"", fav:"", base, perRound, bonusPct:0, bonusPts:0, total:base, isBot:true });
        botPickStore[name]=byRound;
      });

      return bots;
    }

    function recomputeRows(){
      const perPlayer={}; // nick -> {base, perRound, email}
      for(const tip of latestTipsByUserMatch.values()){
        const m=matchesById[tip.matchId]; if(!m)continue;
        const roundId=matchRound(m)||""; if(!roundId)continue;
        if(!m.outcome)continue;
        const pick=tipChoice(tip); if(!pick)continue;
        const correct=pick===m.outcome;const ov=getOdds(m,pick);const mult=tipDouble(tip)?2:1;
        const pts=(correct&&ov)?Number(ov)*mult:0;
        const nick=usersMap[tip.user]||tip.user;
        if(!perPlayer[nick])perPlayer[nick]={base:0,perRound:{},email:tip.user};
        perPlayer[nick].base+=pts; perPlayer[nick].perRound[roundId]=(perPlayer[nick].perRound[roundId]||0)+pts;
      }

      rows=Object.entries(perPlayer).map(([nick,obj])=>{
        const email=obj.email;

        const {pct:top8Pct, hits:top8Hits}=calcTop8Pct(email);
        const champPick = championPickByEmail[email] || "";
        const goldenPick = goldenPickByEmail[email] || "";

        const champPct = (officialChampion && eqTeam(champPick, officialChampion)) ? BONUS_CFG.winnerPct : 0;
        const goldenPct= (officialGoldenPlayer && eqText(goldenPick, officialGoldenPlayer)) ? BONUS_CFG.topScorerPct : 0;

        const bonusPct = top8Pct + champPct + goldenPct;
        const bonusPts = Number((obj.base * (bonusPct/100)).toFixed(2));
        const total = Number((obj.base + bonusPts).toFixed(2));
        const fav=usersFavUcl[email]||"";

        return{
          nick,email,
          base:obj.base,total,
          perRound:obj.perRound,
          fav,
          bonusPct, bonusPts,
          parts:{
            top8:{pct:top8Pct,hits:top8Hits},
            winner:{pct:champPct, pick:champPick, official:officialChampion, status: champPct? 'ok' : (officialChampion? 'no':'pending')},
            topScorer:{pct:goldenPct, pick:goldenPick, official:officialGoldenPlayer, status: goldenPct? 'ok' : (officialGoldenPlayer? 'no':'pending')}
          }
        };
      });

      if(showBots){
        const botRows=addBotRows(matchesById, roundsAsc);
        rows = rows.concat(botRows);
      }

      rows.sort((a,b)=>b.total-a.total||a.nick.localeCompare(b.nick));
    }

    /* ---------------- Render ---------------- */
    function renderTable(){
      const mount=document.getElementById("tableMount");
      const mode=mount.dataset.mode==="all"?"all":"last";
      mount.dataset.mode=mode;

      if(!rows.length){mount.innerHTML="<div style='padding:12px'>M√©g nincs megjelen√≠thet≈ë pontsz√°m.</div>";return}

      const roundsDesc=roundsAsc.slice().reverse();
      const toShow = mode==="all" ? roundsDesc : roundsDesc.slice(0,5);

      const rangeLabel=document.getElementById("rangeLabel");
      rangeLabel.textContent = toShow.length
        ? (mode==="all" ? "Teljes n√©zet: minden fordul√≥ l√°tszik (balr√≥l jobbra: legut√≥bbi ‚Üí r√©gebbi)"
                        : `Csak az utols√≥ ${toShow.length} fordul√≥ l√°tszik (balr√≥l jobbra: F${toShow[0]} ‚Üí ‚Ä¶)`)
        : "Nincs m√©g lez√°rt fordul√≥.";

      const maxPerRound=toShow.map(r=>{let m=-Infinity;rows.forEach(row=>{m=Math.max(m,row.perRound[r]||0)});return m===-Infinity?0:m});

      const leftHeader = `
        <div class="hdr">
          <div class="cell left rank">Hely</div>
          <div class="cell left">J√°t√©kos</div>
          <div class="cell left num">√ñsszesen</div>
          <div class="cell left num">B√≥nusz (pont + %)</div>
          <div class="cell left num">Alap pont</div>
        </div>`;

      const rightHeader = toShow.map(r=>`<div class="cell round-cell"><a class="round-link" href="results_ucl.html?round=${encodeURIComponent(r)}">F${r}</a></div>`).join('');

      const container=document.createElement('div'); container.className='table-wrap';

      /* LEFT (sticky) */
      const left=document.createElement('div');
      left.className='left';
      left.style.minWidth='900px';
      left.style.maxWidth='900px';
      left.innerHTML=`
        <div class="grid" style="grid-template-columns:70px 2.8fr 130px 190px 120px;">
          ${leftHeader}
          ${rows.map((r,i)=> renderLeftRow(r,i)).join('')}
        </div>
      `;

      /* RIGHT (scroll) */
      const right=document.createElement('div');
      right.style.overflow='auto';
      right.style.flex='1';
      right.innerHTML=`
        <div class="grid" style="grid-template-columns:${'78px '.repeat(toShow.length)};">
          <div class="hdr">${rightHeader}</div>
          ${rows.map(r=>{
            const cells=toShow.map((rid,idx)=>{
              const val=r.perRound[rid]||0;
              const isTop=val===maxPerRound[idx]&&val!==0;
              return `<div class="cell round-cell num ${isTop?'top':''}">
                        <a class="round-link" href="results_ucl.html?round=${encodeURIComponent(rid)}">${fmt(val)}${isTop?' ‚≠ê':''}</a>
                      </div>`;
            }).join('');
            return `<div class="row row-bg">${cells}</div>`;
          }).join('')}
        </div>
      `;

      mount.innerHTML='';
      container.appendChild(left);
      container.appendChild(right);
      mount.appendChild(container);

      // Bonus chip katt ‚Äì csak emberekn√©l akt√≠v
      mount.querySelectorAll(".bonus-chip").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const idx=Number(btn.dataset.idx||0);
          const rect=btn.getBoundingClientRect();
          showBonusPopover(rows[idx],rect.right,rect.bottom);
        });
      });
    }

    function renderLeftRow(r,i){
      if(r.isBot){
        const meta=BOT_META[r.nick]||{};
        const av = meta.avatar
          ? `<img class="avatar-mini" src="${meta.avatar}" ${meta.avatar2x ? `srcset="${meta.avatar} 1x, ${meta.avatar2x} 2x"` : ""} alt="${escapeHtml(r.nick)}" loading="lazy" decoding="async">`
          : "";
        const nameHtml = `
          <div class="name-wrap">
            ${av}
            <span class="name-subtle">${escapeHtml(r.nick)}</span>
            <span class="name-actions">
              <button class="link-btn bot-btn" data-bot-card="${escapeHtml(r.nick)}">Profil</button>
              <button class="link-btn bot-btn" data-bot-view="${escapeHtml(r.nick)}">Tippjei</button>
            </span>
          </div>`;
        return `
          <div class="row row-bg">
            <div class="cell left rank">${i+1}.</div>
            <div class="cell left">${nameHtml}</div>
            <div class="cell left num total">${fmt(r.total)}</div>
            <div class="cell left num">+0.00 <span style="opacity:.8">( +0% )</span></div>
            <div class="cell left num">${fmt(r.base)}</div>
          </div>
        `;
      }

      const crest = r.fav && crestFor(r.fav)
        ? `<img class="name-crest" src="${crestFor(r.fav)}" alt="${escapeHtml(r.fav)}">`
        : "";
      const nameHtml = `
        <div class="name-wrap">
          ${crest || ""}
          <span class="name-text">${escapeHtml(r.nick)}</span>
        </div>
      `;
      return `
        <div class="row row-bg">
          <div class="cell left rank">${i+1}.</div>
          <div class="cell left">${nameHtml}</div>
          <div class="cell left num total">${fmt(r.total)}</div>
          <div class="cell left num bonus-cell">
            <button class="btn btn-accent bonus-chip" data-idx="${i}" title="B√≥nusz r√©szletek">
              +${fmt(r.bonusPts)} <span style="opacity:.9">(+${r.bonusPct}%)</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" style="margin-left:4px"><path d="M7 10l5 5 5-5z"/></svg>
            </button>
          </div>
          <div class="cell left num">${fmt(r.base)}</div>
        </div>
      `;
    }

    /* ---------------- Bonus popover ---------------- */
    function showBonusPopover(row,clientX,clientY){
      closeBonusPopover();

      const backdrop=document.createElement("div");
      backdrop.className="bonus-backdrop";
      backdrop.addEventListener("click",closeBonusPopover);

      const pop=document.createElement("div");
      pop.className="bonus-pop";
      const stW=row.parts.winner.status;const clW=stW==='ok'?'ok':(stW==='pending'?'pending':'no');const icW=stW==='ok'?'‚úî':(stW==='pending'?'üïí':'‚úñ');
      const stG=row.parts.topScorer.status;const clG=stG==='ok'?'ok':(stG==='pending'?'pending':'no');const icG=stG==='ok'?'‚úî':(stG==='pending'?'üïí':'‚úñ');

      pop.innerHTML=`
        <div class="title">${escapeHtml(row.nick)} ‚Äì B√≥nusz √∂sszefoglal√≥</div>
        <div class="grid2">
          <div class="muted-xs">K√©plet</div>
          <div><strong>${fmt(row.base)} √ó ${row.bonusPct}% = +${fmt(row.bonusPts)}</strong></div>

          <div class="muted-xs">V√©gs≈ë gy≈ëztes</div>
          <div><span class="btag ${clW}">üèÜ ${icW} +${row.parts.winner.pct}%</span><div class="muted-xs">Tipp: <strong>${escapeHtml(row.parts.winner.pick||'‚Äî')}</strong> ‚Ä¢ Hiv.: <strong>${escapeHtml(row.parts.winner.official||'‚Äî')}</strong></div></div>

          <div class="muted-xs">G√≥lkir√°ly</div>
          <div><span class="btag ${clG}">üëü ${icG} +${row.parts.topScorer.pct}%</span><div class="muted-xs">Tipp: <strong>${escapeHtml(row.parts.topScorer.pick||'‚Äî')}</strong> ‚Ä¢ Hiv.: <strong>${escapeHtml(row.parts.topScorer.official||'‚Äî')}</strong></div></div>

          <div class="muted-xs">Top 8 tal√°latok</div>
          <div><span class="btag ok">üìä +${row.parts.top8.pct}%</span> <span class="muted-xs">(${row.parts.top8.hits}/8)</span>
            <div class="muted-xs" style="margin-top:6px">A r√©szletes 8-as bont√°s az <strong>Eredm√©nyek</strong> oldalon l√°that√≥.</div>
          </div>
        </div>
      `;

      const pad=8;const vw=window.innerWidth,vh=window.innerHeight;
      document.body.appendChild(pop);
      const r=pop.getBoundingClientRect();
      let x=clientX+pad,y=clientY+pad;
      if(x+r.width>vw-8)x=vw-r.width-8;
      if(y+r.height>vh-8)y=vh-r.height-8;
      pop.style.left=Math.max(8,x)+"px";
      pop.style.top=Math.max(8,y)+"px";

      document.body.appendChild(backdrop);
    }

    function closeBonusPopover(){
      document.querySelectorAll(".bonus-backdrop,.bonus-pop").forEach(n=>n.remove());
    }

    /* ---------------- Bot profil popover (NB1-azonos tartalom) ---------------- */
    function openBotCard(name, anchorEl){
      const meta = BOT_META[name]; if (!meta) return;
      const pop = document.getElementById('botCard');
      pop.dataset.name = name;
      const imgEl = pop.querySelector('.bc-img');
      imgEl.src = meta.avatar || '';
      imgEl.srcset = meta.avatar2x ? `${meta.avatar} 1x, ${meta.avatar2x} 2x` : '';
      imgEl.loading = 'lazy'; imgEl.decoding = 'async';
      pop.querySelector('.bc-title').textContent = name;

      const body = pop.querySelector('.body');
      body.innerHTML = `<p class="bc-intro" style="margin:0 0 8px 0;">${escapeHtml(meta.intro||"")}</p>
                        <p style="margin:0;">${escapeHtml(meta.bio||"")}</p>`;

      // elhelyez√©s az anchor k√∂r√ºl
      pop.style.top = '0px'; pop.style.left = '0px';
      pop.classList.add('open');
      const r = anchorEl.getBoundingClientRect();
      const margin = 10;
      const pw = pop.offsetWidth, ph = pop.offsetHeight;
      let top = r.bottom + 8;
      let left = Math.min(Math.max(margin, r.left), window.innerWidth - pw - margin);
      if (top + ph > window.innerHeight - margin) top = r.top - ph - 8;
      if (top < margin) top = margin;
      pop.style.top  = `${Math.round(top)}px`;
      pop.style.left = `${Math.round(left)}px`;
    }
    function closeBotCard(){ const pop = document.getElementById('botCard'); pop.classList.remove('open'); pop.removeAttribute('data-name'); }

    /* ---------------- Bot ‚Äûtippjei‚Äù modal ---------------- */
    function openBotModal(botName){
      const modal = document.getElementById('botModal');
      const title = document.getElementById('botModalTitle');
      const body = document.getElementById('botModalBody');
      title.textContent = botName + " ‚Äì tippjei";
      const data = botPickStore[botName] || {};
      const rounds = Object.keys(data).sort((a,b)=>(parseInt(a)||0)-(parseInt(b)||0));
      if (!rounds.length){
        body.innerHTML = "<div class='muted'>Nincs megjelen√≠thet≈ë adat.</div>";
      } else {
        let html = "";
        rounds.forEach(r=>{
          html += `<h3 style="margin:12px 0 6px;font-weight:800;">Fordul√≥ ${r}</h3>`;
          html += `<div class="grid" style="grid-template-columns:1.4fr 1.4fr 80px 80px 90px 90px;">
            <div class="hdr"><div class="cell">Hazai</div></div>
            <div class="hdr"><div class="cell">Vend√©g</div></div>
            <div class="hdr"><div class="cell">Tipp</div></div>
            <div class="hdr"><div class="cell">Odds</div></div>
            <div class="hdr"><div class="cell">Dupla</div></div>
            <div class="hdr"><div class="cell">Eredm√©ny</div></div>`;
          (data[r]||[]).forEach(x=>{
            html += `
              <div class="row row-bg">
                <div class="cell">${escapeHtml(x.homeTeam||"")}</div>
                <div class="cell">${escapeHtml(x.awayTeam||"")}</div>
                <div class="cell">${escapeHtml(x.pick||"")}</div>
                <div class="cell">${fmt(x.odds||0)}</div>
                <div class="cell ${x.doubled?'dbl':''}">${x.doubled?'Igen':'-'}</div>
                <div class="cell ${x.correct?'ok':'wrong'}">${x.correct?'Tal√°lt':'Mell√©'}${x.outcome?`&nbsp;(${escapeHtml(x.outcome)})`:""}</div>
              </div>`;
          });
          html += `</div>`;
        });
        body.innerHTML = html;
      }
      modal.classList.add('open');
    }
    function closeBotModal(){ document.getElementById('botModal').classList.remove('open'); }

    /* ---------------- Nav ‚Äûf√ºgg≈ë tippek‚Äù badge ---------------- */
    function updatePendingBadge(){
      getDocs(query(collection(db,"ucl_matches"),where("startTime",">=",new Date()))).then(upcomingSnap=>{
        const upcoming=upcomingSnap.docs.map(d=>({id:d.id,...d.data()}));
        getDocs(query(collection(db,"ucl_tips"),where("user","==",currentUserEmail))).then(tipsSnap=>{
          const latestByMatch=new Map();
          tipsSnap.forEach(docu=>{const t=docu.data();if(!t?.matchId)return;const cur=latestByMatch.get(t.matchId);if(!cur||tipTsMs(t)>=tipTsMs(cur))latestByMatch.set(t.matchId,t)});
          const tippedIds=new Set(Array.from(latestByMatch.keys()));
          const pending=upcoming.filter(m=>!tippedIds.has(m.id)).length;
          const badge=document.getElementById("tipsBadge");if(pending>0){badge.textContent=pending;badge.hidden=false}else{badge.hidden=true}
        });
      });
    }

    /* ---------------- Chat (UCL k√ºl√∂n: chatMessages_ucl + chatLastSeenUcl) ---------------- */
    function initChat(userRef){
      const fab=document.getElementById('chatToggle');const fabBadge=document.getElementById('chatFabBadge');const panel=document.getElementById('chatPanel');const closeBtn=document.getElementById('chatClose');const listEl=document.getElementById('chatMessages');const inputEl=document.getElementById('chatInput');const sendBtn=document.getElementById('chatSendBtn');
      function open(){panel.classList.add('open');setTimeout(()=>inputEl?.focus(),50);markSeen()}
      function close(){panel.classList.remove('open')}
      function toggle(){panel.classList.contains('open')?close():open()}
      fab.addEventListener('click',toggle);closeBtn.addEventListener('click',close);
      let lastSeenMs=chatLastSeenUcl?.toMillis?chatLastSeenUcl.toMillis():0;

      const qAll=query(collection(db,'chatMessages_ucl'),orderBy('ts','asc'));
      onSnapshot(qAll,snap=>{
        listEl.innerHTML='';
        if(snap.empty){
          const empty=document.createElement('div');empty.className='chat-empty';empty.textContent='M√©g nincs √ºzenet. L√©gy te az els≈ë!';listEl.appendChild(empty)
        }else{
          let unread=0;
          snap.forEach(docu=>{
            const d=docu.data();const tsMs=d.ts?.toMillis?.()||0;if(tsMs>lastSeenMs)unread++;
            const row=document.createElement('div');row.className='msg';
            row.innerHTML=`<div style="flex:1 1 auto"><div class="meta"><strong>${d.nick||'Ismeretlen'}</strong> ‚Ä¢ ${d.ts?fmtTime(d.ts):''}</div><div class="text">${(d.text||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div></div>`;
            const canDelete=(currentUserRole==='admin')||(d.email===currentUserEmail);
            if(canDelete){const del=document.createElement('button');del.className='del';del.textContent='T√∂rl√©s';del.title='√úzenet t√∂rl√©se';del.addEventListener('click',async()=>{try{await deleteDoc(doc(db,'chatMessages_ucl',docu.id))}catch(e){}});row.appendChild(del)}
            listEl.appendChild(row);
          });
          if(!panel.classList.contains('open')&&unread>0){fab.classList.add('has-unread');fabBadge.textContent=unread>99?'99+':String(unread)}else{fab.classList.remove('has-unread');fabBadge.textContent=''}
          setTimeout(()=>{listEl.scrollTop=listEl.scrollHeight},0)
        }
      });
      sendBtn.addEventListener('click',async()=>{
        const txt=(inputEl.value||'').trim();if(!txt){inputEl.focus();return}
        const backup=txt;inputEl.value='';
        try{
          await addDoc(collection(db,'chatMessages_ucl'),{
            email:currentUserEmail,nick:currentUserNick||'Ismeretlen',text:backup,ts:serverTimestamp()
          });
          if(panel.classList.contains('open'))await markSeen()
        }catch(e){inputEl.value=backup;inputEl.focus()}
      });
      inputEl.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click()}})
      async function markSeen(){try{await setDoc(userRef,{chatLastSeenUcl:serverTimestamp()},{merge:true});lastSeenMs=Date.now();fab.classList.remove('has-unread');fabBadge.textContent=''}catch(e){}}
    }
  </script>
</head>
<body>
  <div class="layout">
    <!-- Fejl√©c -->
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>BL TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
        <!-- LIGA / TIPPJ√ÅT√âK V√ÅLASZT√ì ‚Äì BAL OLDALON A C√çM MELLETT -->
        <div id="leagueSwitchMount" class="league-switch-left" aria-label="Tippj√°t√©k v√°laszt√≥"></div>
      </div>
      <div>
        <button id="logout" class="btn btn-accent" aria-label="Kil√©p√©s">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-3px;margin-right:6px">
            <path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2z"/>
          </svg>
          Kil√©p√©s
        </button>
      </div>
    </div>

    <!-- NAV -->
    <nav class="nav-grid">
      <a class="nav-card" href="dashboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3L12 3z"/></svg>
        </div>
        <div class="text"><span class="title">F≈ëoldal</span><span class="desc">Tabella, h√≠rek, kedvencek</span></div>
      </a>
      <a class="nav-card" href="positions_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg>
        </div>
        <div class="text">
          <span class="title">
            Szezon v√©gi sorrend
            <span id="top8CountdownNav" class="pill-badge countdown" hidden></span>
          </span>
          <span class="desc">Ligaf√°zis Top 8, gy≈ëztes, g√≥lkir√°ly</span>
        </div>
      </a>
      <a class="nav-card" href="matches_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span>
          <span class="desc">K√∂zelg≈ë meccsek & tippek</span>
        </div>
      </a>
      <a class="nav-card" href="results_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2Z"/></svg>
        </div>
        <div class="text"><span class="title">Eredm√©nyek</span><span class="desc">Fordul√≥nk√©nti bont√°s</span></div>
      </a>
      <a class="nav-card" href="leaderboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h3a2 2 0 0 1 2-2Z"/></svg>
        </div>
        <div class="text"><span class="title">√ñsszpontsz√°m</span><span class="desc">Toplista & b√≥nusz</span></div>
      </a>
      <a class="nav-card" href="profile_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg>
        </div>
        <div class="text"><span class="title">Profil</span><span class="desc">Be√°ll√≠t√°sok & kedvenc csapat</span></div>
      </a>
      <a class="nav-card" id="adminLink" href="admin_ucl.html" style="display:none;">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Z"/></svg>
        </div>
        <div class="text"><span class="title">Admin</span><span class="desc">Szezon-z√°r & be√°ll√≠t√°sok</span></div>
      </a>
    </nav>

    <!-- Ranglista -->
    <section class="card">
      <div class="subhdr">
        <button id="toggleAll" class="btn">Mutasd az √∂sszes fordul√≥t</button>
        <label style="display:flex; align-items:center; gap:6px; font-size:14px; user-select:none;">
          <input type="checkbox" id="showBots">
          Mutasd a g√©pi tippel≈ëket (Elek, Hug√≥, Ilona, Vendel)
        </label>
        <span id="rangeLabel" class="muted">Alap: az utols√≥ 5 fordul√≥ l√°tszik</span>
      </div>
      <div id="tableMount" data-mode="last"></div>
      <div style="padding:8px 12px; font-size:12px; color:var(--muted)">‚≠ê = adott fordul√≥ legmagasabb pontja</div>
    </section>
  </div>

  <!-- Chat -->
  <button id="chatToggle" class="chat-fab" title="K√∂z√∂ss√©gi chat">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 4h16a2 2 0 0 1 2 2v11a2 2 0 0 1 2 2H8l-4 3V6a2 2 0 0 1 2-2Z"/></svg>
    <span id="chatFabBadge" class="fab-badge"></span>
  </button>

  <section id="chatPanel" class="chat-panel" aria-label="K√∂z√∂ss√©gi chat">
    <div class="chat-head">
      <div class="chat-title">K√∂z√∂ss√©gi chat</div>
      <button id="chatClose" aria-label="Bez√°r√°s">‚úï</button>
    </div>
    <div id="chatMessages" class="chat-list" role="log" aria-live="polite"></div>
    <div id="chatComposer">
      <input id="chatInput" type="text" placeholder="√çrj valamit‚Ä¶" autocomplete="off">
      <button id="chatSendBtn">K√ºld√©s</button>
    </div>
  </section>

  <!-- Bot tippjei modal -->
  <div id="botModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="botModalTitle">
      <div class="modal-head">
        <div id="botModalTitle" class="modal-title"></div>
        <button class="close-x" aria-label="Bez√°r√°s">‚úï</button>
      </div>
      <div id="botModalBody" class="modal-body"></div>
    </div>
  </div>

  <!-- Bot profil popover -->
  <div id="botCard" class="bot-card" role="dialog" aria-modal="false" aria-hidden="true">
    <div class="head">
      <img class="avatar bc-img" alt="">
      <div>
        <div class="title bc-title"></div>
        <div class="tag">G√©pi tippel≈ë</div>
      </div>
    </div>
    <div class="body"><p class="bc-intro" style="margin:0;"></p></div>
    <div class="actions">
      <button class="link-btn bot-btn" data-bc-open-tips>Mutasd a tippjeit</button>
      <button class="link-btn btn-accent" data-bc-close>Bez√°r</button>
    </div>
  </div>
</body>
</html>

