<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL TippLiga ‚Äì √ñsszes√≠tett ranglista</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>

  <style>
    .layout{display:flex;flex-direction:column;gap:16px;max-width:1200px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between}
    .header-left{display:flex;align-items:center;gap:12px}
    .fav-crest{width:46px;height:46px;object-fit:contain;border-radius:8px;border:1px solid var(--line,#e6eaf1);background:#fff}
    .welcome{color:var(--muted,#64748b);margin:4px 0 0}

    .nav-grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:14px}
    @media (max-width:1100px){.nav-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:700px){.nav-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .nav-card{display:flex;gap:12px;align-items:center;text-decoration:none;color:inherit;padding:14px;background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:14px;box-shadow:0 6px 18px rgba(15,23,42,.05)}
    .nav-card .icon-wrap{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:color-mix(in oklab,var(--accent,#3b82f6) 15%,white);color:var(--accent,#3b82f6)}
    .nav-card .text{display:flex;flex-direction:column;line-height:1.2}
    .nav-card .title{font-weight:800}
    .nav-card .desc{color:var(--muted,#64748b);font-size:12px}
    .pill-badge{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 6px;margin-left:6px;border-radius:999px;background:#ef4444;color:#fff;font-size:12px;font-weight:700;line-height:1;vertical-align:middle}
    .pill-badge[hidden]{display:none!important}

    .btn{border:0;background:#e5e7eb;color:#111;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .muted{color:#64748b}

    .card{background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,.06);overflow:hidden}
    .subhdr{background:#f7f9fd;border-bottom:1px solid var(--line,#e6eaf1);padding:10px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}

    .tbl-wrap{overflow:auto}
    table.rank{border-collapse:separate;border-spacing:0;min-width:980px}
    table.rank th,table.rank td{padding:10px 12px;border-bottom:1px solid var(--line,#e6eaf1);white-space:nowrap;background:#fff}
    table.rank thead th{position:sticky;top:0;background:#f7f8fc;z-index:5}
    .num{text-align:right}
    .top{background:#fff8e1!important;font-weight:700}
    .round-link{color:inherit;text-decoration:none}
    .round-link:hover{text-decoration:underline}

    .sticky-1, .sticky-2, .sticky-3, .sticky-4, .sticky-5{position:sticky;left:0;z-index:4;background:#fff}
    .sticky-2{left:70px}
    .sticky-3{left:310px}
    .sticky-4{left:430px}
    .sticky-5{left:650px}
    .sticky-border{box-shadow:1px 0 0 0 var(--line,#e6eaf1)}

    .player-cell{display:flex;align-items:center;gap:8px}
    .player-cell img{width:22px;height:22px;object-fit:contain;border-radius:4px;border:1px solid var(--line,#e6eaf1);background:#fff}

    .bonus-inline{display:flex;align-items:center;gap:8px;justify-content:flex-end}
    .bonus-pts{font-weight:700}
    .bonus-pct{font-weight:700}
    .bonus-toggle{border:1px solid var(--line,#e6eaf1);background:#fff;width:22px;height:22px;border-radius:999px;font-size:12px;line-height:1;cursor:pointer;display:inline-grid;place-items:center;padding:0}
    .bonus-toggle svg{width:14px;height:14px;transition:transform .18s ease}
    .bonus-toggle[aria-expanded="true"] svg{transform:rotate(180deg)}

    .bonus-backdrop{position:fixed;inset:0;z-index:9998;background:transparent}
    .bonus-pop{position:fixed;z-index:9999;background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.14);width:min(420px,calc(100vw - 32px));padding:12px}
    .bonus-pop .title{font-weight:800;margin-bottom:8px}
    .grid2{display:grid;grid-template-columns:130px 1fr;gap:6px 10px}
    .btag{display:inline-flex;gap:6px;align-items:center;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line,#e6eaf1);background:#fff;color:#334155}
    .btag.ok{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
    .btag.pending{background:#fffbeb;border-color:#fde68a;color:#a16207}
    .btag.no{background:#fef2f2;border-color:#fecaca;color:#991b1b}
    .muted-xs{color:#64748b;font-size:12px}

    .top8-mini{margin-top:8px;border-top:1px solid var(--line,#e6eaf1);padding-top:8px}
    .top8-row{display:grid;grid-template-columns:22px 1fr 1fr 26px;gap:8px;align-items:center;padding:4px 0}
    .top8-row:nth-child(even){background:#fcfdff}
    .top8-row strong{font-weight:700}

    .chat-fab{position:fixed;right:22px;bottom:22px;z-index:999;width:52px;height:52px;border-radius:999px;border:0;background:var(--accent,#3b82f6);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 26px rgba(0,0,0,.15)}
    .chat-fab .fab-badge{position:absolute;top:-4px;right:-4px;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;font-size:12px;font-weight:800;line-height:20px;display:none}
    .chat-fab.has-unread .fab-badge{display:inline-block}
    .chat-panel{position:fixed;right:22px;bottom:86px;z-index:998;width:380px;max-width:calc(100vw - 32px);max-height:70vh;display:none;flex-direction:column;background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:14px;box-shadow:0 10px 32px rgba(0,0,0,.14)}
    .chat-panel.open{display:flex}
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line,#e6eaf1);background:#f7f9fd}
    .chat-title{font-weight:800}
    #chatClose{width:28px;height:28px;border-radius:8px;font-size:18px;line-height:28px;display:inline-flex;align-items:center;justify-content:center;background:#eef2ff;color:#111;border:1px solid var(--line,#e6eaf1);cursor:pointer}
    #chatClose:hover{filter:brightness(.95)}
    .chat-list{overflow:auto;padding:8px 10px}
    .chat-empty{color:#64748b;font-size:13px;padding:8px 10px}
    .msg{padding:8px 10px;border-bottom:1px solid var(--line,#e6eaf1);display:flex;gap:8px;align-items:flex-start}
    .msg .meta{font-size:12px;color:#64748b;margin-bottom:2px}
    .msg .text{white-space:pre-wrap;word-break:break-word}
    .msg .del{margin-left:auto;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:2px 8px;border-radius:8px;font-size:12px;cursor:pointer;display:none}
    .msg:hover .del{display:inline-block}
    #chatComposer{display:flex;gap:8px;align-items:center;padding:10px;border-top:1px solid var(--line,#e6eaf1);background:#fff}
    #chatInput{background:#fff;color:#111;border:1px solid var(--line,#e6eaf1);height:40px;padding:8px 10px;border-radius:10px;font-size:14px;outline:none;width:100%;box-sizing:border-box}
    #chatInput::placeholder{color:#6b7280}
    #chatSendBtn{min-width:90px;padding:8px 12px;border-radius:10px;background:var(--accent,#3b82f6);color:#fff;border:0;font-weight:600;cursor:pointer}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc,
      query, where, orderBy, onSnapshot, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig={apiKey:"AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",authDomain:"tippliga-4b3af.firebaseapp.com",projectId:"tippliga-4b3af",storageBucket:"tippliga-4b3af.appspot.com",messagingSenderId:"720359845241",appId:"1:720359845241:web:d3d6edcac6b43ebff053a8"};
    const app=initializeApp(firebaseConfig);const auth=getAuth(app);const db=getFirestore(app);

    const crestMap={"Ajax":"ucl_crest/ajax.png","Arsenal":"ucl_crest/arsenal.png","Atalanta":"ucl_crest/atalanta.png","Athletic Bilbao":"ucl_crest/athletic.png","Atl√©tico Madrid":"ucl_crest/atletico.png","Barcelona":"ucl_crest/barcelona.png","Bayern M√ºnchen":"ucl_crest/bayern.png","Benfica":"ucl_crest/benfica.png","Borussia Dortmund":"ucl_crest/borussia.png","Bod√∏/Glimt":"ucl_crest/bodo.png","Club Bruges":"ucl_crest/brugge.png","Chelsea":"ucl_crest/chelsea.png","FC K√∂benhavn":"ucl_crest/copenhagen.png","Eintracht Frankfurt":"ucl_crest/frankfurt.png","Galatasaray":"ucl_crest/galata.png","Internazionale":"ucl_crest/inter.png","Juventus":"ucl_crest/juventus.png","Bayer Leverkusen":"ucl_crest/leverkusen.png","Liverpool":"ucl_crest/liverpool.png","Manchester City":"ucl_crest/mancity.png","Olympique Marseille":"ucl_crest/marseille.png","Monaco":"ucl_crest/monaco.png","Napoli":"ucl_crest/napoli.png","Newcastle United":"ucl_crest/newcastle.png","Olympiakosz Pireusz":"ucl_crest/olympiacos.png","Pafosz":"ucl_crest/pafos.png","Paris Saint-Germain":"ucl_crest/psg.png","PSV":"ucl_crest/psv.png","Qarabag":"ucl_crest/qarabag.png","Real Madrid":"ucl_crest/real.png","Slavia Praha":"ucl_crest/slavia.png","Sporting CP":"ucl_crest/sporting.png","Tottenham Hotspur":"ucl_crest/tottenham.png","Union Saint-Gilloise":"ucl_crest/usg.png","Villarreal":"ucl_crest/villareal.png","Kajrat Almati":"ucl_crest/kairat.png"};
    const crestFor=t=>crestMap[t]||"";
    const fmt=n=>(Number(n)||0).toFixed(2);
    const fmtTime=ts=>{try{return ts.toDate().toLocaleString("hu-HU",{hour12:false})}catch{return""}};
    const escapeHtml=s=>String(s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const NORM=s=>String(s??"").trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    const eqTeam=(a,b)=>!!a&&!!b&&NORM(a)===NORM(b);
    const eqText=(a,b)=>NORM(a)===NORM(b);

    const teamColorMap={
      "Arsenal":"#c3002f","Barcelona":"#a50044","Bayern M√ºnchen":"#dc052d","Benfica":"#d20a0a","Borussia Dortmund":"#111827",
      "Chelsea":"#034694","Internazionale":"#0c5fa9","Juventus":"#111111","Liverpool":"#d00027","Manchester City":"#6cabdd",
      "Paris Saint-Germain":"#004170","Real Madrid":"#0a2463","Tottenham Hotspur":"#132257","Bayer Leverkusen":"#e32219",
      "Atalanta":"#1b5fa7","Napoli":"#00a2e0","PSV":"#cc0000","Sporting CP":"#00824b","Galatasaray":"#a90432","Ajax":"#d31145",
      "Villarreal":"#1f2937","Athletic Bilbao":"#e11d48","Union Saint-Gilloise":"#1f2937","Monaco":"#c8102e","Newcastle United":"#111111",
      "Slavia Praha":"#d00027","FC K√∂benhavn":"#004a98","Eintracht Frankfurt":"#111111","Olympique Marseille":"#009fe3",
      "Olympiakosz Pireusz":"#c8102e","Qarabag":"#1f2937","Pafosz":"#1f2937","Kajrat Almati":"#1f2937","Bod√∏/Glimt":"#1f2937","Club Bruges":"#1f2937"
    };
    const colorForTeam=t=>teamColorMap[t]||"#374151";

    function getOdds(m,key){
      if(m?.odds&&(key in m.odds))return m.odds[key];
      if(key==="1")return m.odds1??m["odds1"];
      if(key==="X")return m.oddsX??m["oddsX"];
      if(key==="2")return m.odds2??m["odds2"];
      return undefined;
    }
    const tipChoice=t=>t?.choice??t?.tip??"";
    const tipDouble=t=>!!(t?.double??t?.isDouble);
    const tipTsMs=t=>t?.updatedAt?.toMillis?.()||t?.createdAt?.toMillis?.()||t?.timestamp?.toMillis?.()||0;
    const matchRound=m=>String(m?.round??m?.roundId??"");

    function parseRes(str){const m=String(str||"").match(/^\s*(\d+)\s*-\s*(\d+)\s*$/);return m?[parseInt(m[1]),parseInt(m[2])]:null}
    function deriveTop8FromMatches(allMatches){
      const teams=Object.keys(crestMap);const S={};teams.forEach(t=>S[t]={team:t,MP:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,Pts:0});const H2H={};
      (allMatches||[]).forEach(m=>{const A=m.homeTeam||m.home||"";const B=m.awayTeam||m.away||"";const r=parseRes(m.result);const a=S[A],b=S[B];if(!a||!b||!r)return;
        const[hg,ag]=r;a.MP++;b.MP++;a.GF+=hg;a.GA+=ag;a.GD=a.GF-a.GA;b.GF+=ag;b.GA+=hg;b.GD=b.GF-b.GA;
        if(hg>ag){a.W++;b.L++;a.Pts+=3}else if(hg<ag){b.W++;a.L++;b.Pts+=3}else{a.D++;b.D++;a.Pts+=1;b.Pts+=1}
        const k=[A,B].slice().sort((x,y)=>x.localeCompare(y,'hu')).join('|');H2H[k]||={[A]:{Pts:0,GF:0,GA:0},[B]:{Pts:0,GF:0,GA:0}};
        if(hg>ag){H2H[k][A].Pts+=3}else if(hg<ag){H2H[k][B].Pts+=3}else{H2H[k][A].Pts+=1;H2H[k][B].Pts+=1}
        H2H[k][A].GF+=hg;H2H[k][A].GA+=ag;H2H[k][B].GF+=ag;H2H[k][B].GA+=hg
      });
      function cmp(a,b){if(b.Pts!==a.Pts)return b.Pts-a.Pts;if(b.W!==a.W)return b.W-a.W;if(b.GD!==a.GD)return b.GD-a.GD;if(b.GF!==a.GF)return b.GF-a.GF;
        const k=[a.team,b.team].slice().sort((x,y)=>x.localeCompare(y,'hu')).join('|');const row=H2H[k];
        if(row){const pa=row[a.team]?.Pts??0,pb=row[b.team]?.Pts??0;if(pb!==pa)return pb-pa;const gda=(row[a.team]?.GF??0)-(row[a.team]?.GA??0);const gdb=(row[b.team]?.GF??0)-(row[b.team]?.GA??0);if(gdb!==gda)return gdb-gda}
        return a.team.localeCompare(b.team,'hu')}
      const rows=Object.values(S).sort(cmp);return rows.slice(0,8).map(r=>r.team)
    }

    function pctColor(pct){const p=Math.max(0,Math.min(100,pct));const hue=(Math.min(p,12)/12)*120;return `hsl(${hue}deg,85%,40%)`}

    const BONUS_CFG=Object.freeze({winnerPct:10,topScorerPct:5,top8PerHitPct:1,top8MaxPct:8});

    let currentUserEmail="",currentUserNick="",currentUserRole="user",favouriteTeamucl="",chatLastSeen=null;

    let rows=[],roundsAsc=[],officialOrder=[],officialTop8=[],officialAwards={};
    let seasonTipsByEmail={};
    let usersMap={}, usersFavUcl={};
    let matchesById={};

    document.addEventListener("DOMContentLoaded",()=>{
      onAuthStateChanged(auth,async(user)=>{
        if(!user){window.location.href="login_ucl.html";return}
        currentUserEmail=user.email;

        const userRef=doc(db,"users",currentUserEmail);
        const userSnap=await getDoc(userRef);
        if(userSnap.exists()){
          const d=userSnap.data();currentUserNick=d.nickname||currentUserEmail;currentUserRole=d.role||"user";favouriteTeamucl=d.favouriteTeamucl||"";chatLastSeen=d.chatLastSeen||null
        }else{currentUserNick=currentUserEmail}
        document.getElementById("welcome").textContent=`√údv, ${currentUserNick}!`;
        if(currentUserRole==="admin")document.getElementById("adminLink").style.display="flex";
        if(favouriteTeamucl){const themeClass="theme-"+favouriteTeamucl.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-');document.body.classList.add(themeClass);const crest=crestFor(favouriteTeamucl);if(crest){const img=document.getElementById("favCrest");img.src=crest;img.alt=favouriteTeamucl;img.hidden=false}}

        await buildLeaderboard();
        updatePendingBadge();
        initChat(userRef);
        if(window.hideLoader)hideLoader();
      });

      document.getElementById("logout").addEventListener("click",()=>{signOut(auth).then(()=>window.location.href="login_ucl.html")});
      document.getElementById("toggleAll").addEventListener("click",()=>{const st=document.getElementById("tableMount").dataset.mode!=="all";document.getElementById("tableMount").dataset.mode=st?"all":"last";document.getElementById("toggleAll").textContent=st?"Csak az utols√≥ 5 fordul√≥":"Mutasd az √∂sszes fordul√≥t";renderTable()});
      window.addEventListener("scroll",closeBonusPopover,{passive:true});window.addEventListener("resize",closeBonusPopover);document.addEventListener("keydown",e=>{if(e.key==="Escape")closeBonusPopover()});
    });

    async function buildLeaderboard(){
      const [matchesSnap,tipsSnap,usersSnap,standings_ucl,standings_nb,seasonTipsSnap,bonusTipsSnap,officialDoc]=await Promise.all([
        getDocs(collection(db,"ucl_matches")),
        getDocs(collection(db,"ucl_tips")),
        getDocs(collection(db,"users")),
        getDocs(collection(db,"standingsTips_ucl")).catch(()=>({empty:true,forEach(){}})),
        getDocs(collection(db,"standingsTips")).catch(()=>({empty:true,forEach(){}})),
        getDocs(collection(db,"seasonTips_ucl")).catch(()=>({empty:true,forEach(){}})),
        getDocs(collection(db,"bonusTips_ucl")).catch(()=>({empty:true,forEach(){}})),
        getDoc(doc(db,"ucl_official","current")).catch(()=>({exists:()=>false}))
      ]);

      matchesById={};const roundSet=new Set();
      matchesSnap.forEach(d=>{const m={id:d.id,...d.data()};matchesById[m.id]=m;const r=matchRound(m);if(r)roundSet.add(r)});
      roundsAsc=Array.from(roundSet).sort((a,b)=>(parseInt(a)||0)-(parseInt(b)||0));
      officialTop8=deriveTop8FromMatches(Object.values(matchesById));

      usersMap={};usersFavUcl={};
      usersSnap.forEach(d=>{const u=d.data();if(u?.email){usersMap[u.email]=u.nickname||u.email;usersFavUcl[u.email]=u.favouriteTeamucl||""}});

      function officialArrayFrom(d){if(!d)return[];if(Array.isArray(d.order))return d.order;if(Array.isArray(d.teams))return d.teams;if(Array.isArray(d.positions))return d.positions.slice().sort((a,b)=>(a.position||0)-(b.position||0)).map(x=>x.team);return[]}
      const officialStandings = officialArrayFrom({order:officialTop8}); // csak kompat
      officialOrder = (officialStandings.length?officialStandings:officialTop8).slice(0,12);while(officialOrder.length<12)officialOrder.push("");

      officialAwards = officialDoc?.exists?.() ? (officialDoc.data()||{}) : {};
      if(!officialAwards.winnerTeam && officialOrder[0]) officialAwards.winnerTeam = officialOrder[0];

      const orderByEmail={};
      const readStandings=snap=>{snap.forEach(d=>{const data=d.data()||{};let arr=[];if(Array.isArray(data.order))arr=data.order;else if(Array.isArray(data.teams))arr=data.teams;else if(Array.isArray(data.ranking))arr=data.ranking;orderByEmail[d.id]=(arr||[]).slice(0,12)})};
      if(standings_ucl && !standings_ucl.empty)readStandings(standings_ucl);else if(standings_nb && !standings_nb.empty)readStandings(standings_nb);

      seasonTipsByEmail={};
      const mergeTipDoc=(id,data)=>{if(!id||!data)return;const cur=seasonTipsByEmail[id]||{};const winnerTeam=data.winnerTeam||data.winner||cur.winnerTeam||"";const topScorer=data.topScorer||data.goldenBoot||cur.topScorer||"";seasonTipsByEmail[id]={winnerTeam,topScorer}};
      seasonTipsSnap?.forEach?.(d=>mergeTipDoc(d.id,d.data()));
      bonusTipsSnap?.forEach?.(d=>mergeTipDoc(d.id,d.data()));

      const latest=new Map();
      tipsSnap.forEach(docu=>{const t=docu.data();if(!t?.matchId||!t?.user)return;const k=t.user+"|"+t.matchId;const cur=latest.get(k);if(!cur||tipTsMs(t)>=tipTsMs(cur))latest.set(k,{id:docu.id,...t})});

      const player={};
      for(const tip of latest.values()){
        const m=matchesById[tip.matchId];if(!m)continue;
        const roundId=matchRound(m);if(!roundId)continue;
        if(!m.outcome)continue;
        const pick=tipChoice(tip);if(!pick)continue;
        const correct=pick===m.outcome;const ov=getOdds(m,pick);const mult=tipDouble(tip)?2:1;const pts=(correct&&ov)?Number(ov)*mult:0;
        const nick=usersMap[tip.user]||tip.user;
        if(!player[nick])player[nick]={base:0,perRound:{},email:tip.user};
        player[nick].base+=pts;player[nick].perRound[roundId]=(player[nick].perRound[roundId]||0)+pts;
      }

      function calcTop8Pct(email){
        const userOrder=(orderByEmail[email]||[]).slice(0,8).filter(Boolean);
        const offTop8=(officialTop8||[]).slice(0,8).filter(Boolean);
        if(!userOrder.length||!offTop8.length)return{hits:0,pct:0};
        const setOfficial=new Set(offTop8.map(NORM));let hits=0;for(const t of userOrder){if(setOfficial.has(NORM(t)))hits++}
        const pct=Math.min(hits*BONUS_CFG.top8PerHitPct,BONUS_CFG.top8MaxPct);
        return{hits,pct,userOrder,offTop8};
      }

      function calcBonusParts(email,base){
        const tips=seasonTipsByEmail[email]||{};const winnerPick=tips.winnerTeam||"";const scorerPick=tips.topScorer||"";
        const winnerOfficial=officialAwards.winnerTeam||"";const scorerOfficial=officialAwards.topScorer||"";
        const winnerStatus=winnerOfficial?(eqTeam(winnerPick,winnerOfficial)?'ok':(winnerPick?'no':'no')):'pending';
        const scorerStatus=scorerOfficial?(eqText(scorerPick,scorerOfficial)?'ok':(scorerPick?'no':'no')):'pending';
        const winnerPct=(winnerStatus==='ok')?BONUS_CFG.winnerPct:0;
        const scorerPct=(scorerStatus==='ok')?BONUS_CFG.topScorerPct:0;
        const {hits:top8Hits,pct:top8Pct,userOrder,offTop8}=calcTop8Pct(email);
        const bonusPct=winnerPct+scorerPct+top8Pct;
        const bonusPts=Math.round((Number(base)||0)*(bonusPct/100));
        return{bonusPct,bonusPts,parts:{winner:{pct:winnerPct,status:winnerStatus,pick:winnerPick,official:winnerOfficial},topScorer:{pct:scorerPct,status:scorerStatus,pick:scorerPick,official:scorerOfficial},top8:{pct:top8Pct,hits:top8Hits,of:8,order:userOrder,official:offTop8}}};
      }

      rows=Object.entries(player).map(([nick,obj])=>{
        const {bonusPct,bonusPts,parts}=calcBonusParts(obj.email,obj.base);
        const total=obj.base+bonusPts;
        const fav=usersFavUcl[obj.email]||"";
        return{nick,email:obj.email,base:obj.base,perRound:obj.perRound,bonusPct,bonusPts,total,parts,fav}
      });

      rows.sort((a,b)=>b.total-a.total||a.nick.localeCompare(b.nick));
      renderTable();
    }

    function renderTable(){
      const mount=document.getElementById("tableMount");
      const mode=mount.dataset.mode==="all"?"all":"last";
      mount.dataset.mode=mode;

      if(!rows.length){mount.innerHTML="<div style='padding:12px'>M√©g nincs megjelen√≠thet≈ë pontsz√°m.</div>";return}

      const roundsDesc=roundsAsc.slice().reverse();
      const toShow = mode==="all" ? roundsDesc : roundsDesc.slice(0,5);

      const rangeLabel=document.getElementById("rangeLabel");
      rangeLabel.textContent = toShow.length
        ? (mode==="all" ? "Teljes n√©zet: minden fordul√≥ l√°tszik (balr√≥l jobbra: legut√≥bbi ‚Üí r√©gebbi)"
                        : `Csak az utols√≥ ${toShow.length} fordul√≥ l√°tszik (balr√≥l jobbra: F${toShow[0]} ‚Üí ‚Ä¶)`)
        : "Nincs m√©g lez√°rt fordul√≥.";

      const maxPerRound=toShow.map(r=>{let m=-Infinity;rows.forEach(row=>{m=Math.max(m,row.perRound[r]||0)});return m===-Infinity?0:m});

      const table=document.createElement("table");
      table.className="rank";
      const thead=document.createElement("thead");
      thead.innerHTML=`
        <tr>
          <th class="sticky-1 sticky-border">Hely</th>
          <th class="sticky-2 sticky-border">J√°t√©kos</th>
          <th class="num sticky-3 sticky-border">√ñsszesen</th>
          <th class="num sticky-4 sticky-border">B√≥nusz (pont + %)</th>
          <th class="num sticky-5 sticky-border">Alap pont</th>
          ${toShow.map(r=>`<th class="num">F${r}</th>`).join('')}
        </tr>`;
      table.appendChild(thead);

      const tbody=document.createElement("tbody");
      rows.forEach((r,i)=>{
        const tr=document.createElement("tr");

        const tdRank=document.createElement("td");tdRank.className="sticky-1 sticky-border";tdRank.textContent=(i+1)+".";
        const tdPlayer=document.createElement("td");tdPlayer.className="sticky-2 sticky-border";
        const crest=crestFor(r.fav);
        tdPlayer.innerHTML=`<div class="player-cell">${crest?`<img src="${crest}" alt="">`:""}<span style="color:${colorForTeam(r.fav)}">${escapeHtml(r.nick)}</span></div>`;

        const tdTot=document.createElement("td");tdTot.className="num sticky-3 sticky-border";tdTot.innerHTML=`<span class="total">${fmt(r.total)}</span>`;

        const tdBonus=document.createElement("td");tdBonus.className="num sticky-4 sticky-border";
        tdBonus.innerHTML=`
          <div class="bonus-inline">
            <span class="bonus-pts">+${r.bonusPts}</span>
            <span class="bonus-pct" style="color:${pctColor(r.bonusPct)}">( +${r.bonusPct}% )</span>
            <button class="bonus-toggle" data-idx="${i}" aria-expanded="false" title="B√≥nusz r√©szletek" aria-label="B√≥nusz r√©szletek">
              <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M7 10l5 5 5-5z"/></svg>
            </button>
          </div>`;

        const tdBase=document.createElement("td");tdBase.className="num sticky-5 sticky-border";tdBase.textContent=fmt(r.base);

        tr.appendChild(tdRank);tr.appendChild(tdPlayer);tr.appendChild(tdTot);tr.appendChild(tdBonus);tr.appendChild(tdBase);

        toShow.forEach((rid,idx)=>{
          const val=r.perRound[rid]||0;
          const isTop=val===maxPerRound[idx]&&val!==0;
          const td=document.createElement("td");td.className="num"+(isTop?" top":"");
          td.innerHTML=`<a class="round-link" href="results_ucl.html?round=${encodeURIComponent(rid)}">${fmt(val)}${isTop?" ‚≠ê":""}</a>`;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      mount.innerHTML="";
      const wrap=document.createElement("div");wrap.className="tbl-wrap";wrap.appendChild(table);
      mount.appendChild(wrap);

      mount.querySelectorAll(".bonus-toggle").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const idx=Number(btn.dataset.idx||0);
          const rect=btn.getBoundingClientRect();
          const expanded=btn.getAttribute("aria-expanded")==="true";
          if(expanded){closeBonusPopover();return}
          document.querySelectorAll('.bonus-toggle[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false'));
          btn.setAttribute("aria-expanded","true");
          showBonusPopover(rows[idx],rect.right,rect.bottom,btn);
        })
      });
    }

    function showBonusPopover(row,clientX,clientY,anchorEl){
      closeBonusPopover();

      const backdrop=document.createElement("div");backdrop.className="bonus-backdrop";backdrop.addEventListener("click",closeBonusPopover);

      const pop=document.createElement("div");pop.className="bonus-pop";
      const stW=row.parts.winner.status;const clW=stW==='ok'?'ok':(stW==='pending'?'pending':'no');const icW=stW==='ok'?'‚úî':(stW==='pending'?'üïí':'‚úñ');
      const stG=row.parts.topScorer.status;const clG=stG==='ok'?'ok':(stG==='pending'?'pending':'no');const icG=stG==='ok'?'‚úî':(stG==='pending'?'üïí':'‚úñ');

      pop.innerHTML=`
        <div class="title">${escapeHtml(row.nick)} ‚Äì B√≥nusz r√©szletek</div>
        <div class="grid2">
          <div class="muted-xs">K√©plet</div>
          <div><strong>${fmt(row.base)} √ó ${fmt(row.bonusPct)}% = ${row.bonusPts}</strong></div>

          <div class="muted-xs">V√©gs≈ë gy≈ëztes</div>
          <div><span class="btag ${clW}">üèÜ ${icW} +${row.parts.winner.pct}%</span> <div class="muted-xs">Tip: <strong>${escapeHtml(row.parts.winner.pick||'‚Äî')}</strong> ‚Ä¢ Hiv.: <strong>${escapeHtml(row.parts.winner.official||'‚Äî')}</strong></div></div>

          <div class="muted-xs">G√≥lkir√°ly</div>
          <div><span class="btag ${clG}">üëü ${icG} +${row.parts.topScorer.pct}%</span> <div class="muted-xs">Tip: <strong>${escapeHtml(row.parts.topScorer.pick||'‚Äî')}</strong> ‚Ä¢ Hiv.: <strong>${escapeHtml(row.parts.topScorer.official||'‚Äî')}</strong></div></div>

          <div class="muted-xs">Top 8 tal√°latok</div>
          <div><span class="btag ok">üìä +${row.parts.top8.pct}%</span> <span class="muted-xs">(${row.parts.top8.hits}/8 tal√°lat, 1%/tal√°lat, max 8%)</span></div>
        </div>

        <div class="top8-mini">
          ${renderTop8Mini(row.parts.top8.official||[], row.parts.top8.order||[])}
        </div>
      `;

      function place(){
        const pad=8;const vw=window.innerWidth,vh=window.innerHeight;document.body.appendChild(pop);
        const r=pop.getBoundingClientRect();let x=clientX+pad,y=clientY+pad;
        if(x+r.width>vw-8)x=vw-r.width-8;if(y+r.height>vh-8)y=vh-r.height-8;
        pop.style.left=Math.max(8,x)+"px";pop.style.top=Math.max(8,y)+"px";
        document.body.appendChild(backdrop);
      }

      place();
    }

    function renderTop8Mini(official,picks){
      const off=(official||[]).slice(0,8);while(off.length<8)off.push("‚Äî");
      const pk=(picks||[]).slice(0,8);
      const used=new Set();const unmatched=pk.filter(p=>!off.map(NORM).includes(NORM(p)));
      let out="";
      for(let i=0;i<8;i++){
        const left=off[i];let right="‚Äî";let hit=false;
        if(left!=="‚Äî" && pk.map(NORM).includes(NORM(left)) && !used.has(NORM(left))){right=left;hit=true;used.add(NORM(left))}
        else if(unmatched.length){right=unmatched.shift()}
        out+=`<div class="top8-row"><div>${i+1}.</div><div><strong>${escapeHtml(left)}</strong></div><div>${escapeHtml(right)}</div><div>${hit?"‚úÖ":"‚úñ"}</div></div>`;
      }
      return out;
    }

    function closeBonusPopover(){
      document.querySelectorAll(".bonus-backdrop,.bonus-pop").forEach(n=>n.remove());
      document.querySelectorAll('.bonus-toggle[aria-expanded="true"]').forEach(b=>b.setAttribute('aria-expanded','false'));
    }

    function updatePendingBadge(){
      getDocs(query(collection(db,"ucl_matches"),where("startTime",">=",new Date()))).then(upcomingSnap=>{
        const upcoming=upcomingSnap.docs.map(d=>({id:d.id,...d.data()}));
        getDocs(query(collection(db,"ucl_tips"),where("user","==",currentUserEmail))).then(tipsSnap=>{
          const latestByMatch=new Map();
          tipsSnap.forEach(docu=>{const t=docu.data();if(!t?.matchId)return;const cur=latestByMatch.get(t.matchId);if(!cur||tipTsMs(t)>=tipTsMs(cur))latestByMatch.set(t.matchId,t)});
          const tippedIds=new Set(Array.from(latestByMatch.keys()));
          const pending=upcoming.filter(m=>!tippedIds.has(m.id)).length;
          const badge=document.getElementById("tipsBadge");if(pending>0){badge.textContent=pending;badge.hidden=false}else{badge.hidden=true}
        });
      });
    }

    function initChat(userRef){
      const fab=document.getElementById('chatToggle');const fabBadge=document.getElementById('chatFabBadge');const panel=document.getElementById('chatPanel');const closeBtn=document.getElementById('chatClose');const listEl=document.getElementById('chatMessages');const inputEl=document.getElementById('chatInput');const sendBtn=document.getElementById('chatSendBtn');
      function open(){panel.classList.add('open');setTimeout(()=>inputEl?.focus(),50);markSeen()}
      function close(){panel.classList.remove('open')}
      function toggle(){panel.classList.contains('open')?close():open()}
      fab.addEventListener('click',toggle);closeBtn.addEventListener('click',close);
      let lastSeenMs=chatLastSeen?.toMillis?chatLastSeen.toMillis():0;
      const qAll=query(collection(db,'chatMessages'),orderBy('ts','asc'));
      onSnapshot(qAll,snap=>{
        listEl.innerHTML='';
        if(snap.empty){
          const empty=document.createElement('div');empty.className='chat-empty';empty.textContent='M√©g nincs √ºzenet. L√©gy te az els≈ë!';listEl.appendChild(empty)
        }else{
          let unread=0;
          snap.forEach(docu=>{
            const d=docu.data();const tsMs=d.ts?.toMillis?.()||0;if(tsMs>lastSeenMs)unread++;
            const row=document.createElement('div');row.className='msg';
            row.innerHTML=`<div style="flex:1 1 auto"><div class="meta"><strong>${d.nick||'Ismeretlen'}</strong> ‚Ä¢ ${d.ts?fmtTime(d.ts):''}</div><div class="text">${(d.text||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div></div>`;
            const canDelete=(currentUserRole==='admin')||(d.email===currentUserEmail);
            if(canDelete){const del=document.createElement('button');del.className='del';del.textContent='T√∂rl√©s';del.title='√úzenet t√∂rl√©se';del.addEventListener('click',async()=>{try{await deleteDoc(doc(db,'chatMessages',docu.id))}catch(e){}});row.appendChild(del)}
            listEl.appendChild(row);
          });
          if(!panel.classList.contains('open')&&unread>0){fab.classList.add('has-unread');fabBadge.textContent=unread>99?'99+':String(unread)}else{fab.classList.remove('has-unread');fabBadge.textContent=''}
          setTimeout(()=>{listEl.scrollTop=listEl.scrollHeight},0)
        }
      });
      sendBtn.addEventListener('click',async()=>{
        const txt=(inputEl.value||'').trim();if(!txt){inputEl.focus();return}
        const backup=txt;inputEl.value='';
        try{await addDoc(collection(db,'chatMessages'),{email:currentUserEmail,nick:currentUserNick||'Ismeretlen',text:backup,ts:serverTimestamp()});if(panel.classList.contains('open'))await markSeen()}catch(e){inputEl.value=backup;inputEl.focus()}
      });
      inputEl.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBtn.click()}})
      async function markSeen(){try{await setDoc(userRef,{chatLastSeen:serverTimestamp()},{merge:true});fab.classList.remove('has-unread');fabBadge.textContent=''}catch(e){}}
    }
  </script>
</head>
<body>
  <div class="layout">
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>BL TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
      </div>
      <div>
        <button id="logout" class="btn" aria-label="Kil√©p√©s" style="background:var(--accent,#3b82f6);color:#fff;border:1px solid var(--line,#e6eaf1);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-3px;margin-right:6px"><path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2z"/></svg>
          Kil√©p√©s
        </button>
      </div>
    </div>

    <nav class="nav-grid">
      <a class="nav-card" href="dashboard_ucl.html"><div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3L12 3z"/></svg></div><div class="text"><span class="title">F≈ëoldal</span><span class="desc">Tabella, h√≠rek, kedvencek</span></div></a>
      <a class="nav-card" href="positions_ucl.html"><div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg></div><div class="text"><span class="title">Szezon v√©gi sorrend</span><span class="desc">12 csapat ‚Äì h√∫zd a helyekre</span></div></a>
      <a class="nav-card" href="matches_ucl.html"><div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Z"/></svg></div><div class="text"><span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span><span class="desc">K√∂zelg≈ë meccsek & tippek</span></div></a>
      <a class="nav-card" href="results_ucl.html"><div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2Z"/></svg></div><div class="text"><span class="title">Eredm√©nyek</span><span class="desc">Fordul√≥nk√©nti bont√°s</span></div></a>
      <a class="nav-card" href="leaderboard_ucl.html"><div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2-2Z"/></svg></div><div class="text"><span class="title">√ñsszpontsz√°m</span><span class="desc">Toplista & b√≥nusz</span></div></a>
      <a class="nav-card" href="profile_ucl.html"><div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg></div><div class="text"><span class="title">Profil</span><span class="desc">Be√°ll√≠t√°sok & kedvenc csapat</span></div></a>
      <a class="nav-card" id="adminLink" href="admin_ucl.html" style="display:none;"><div class="icon-wrap" aria-hidden="true"><svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Z"/></svg></div><div class="text"><span class="title">Admin</span><span class="desc">Szezon-z√°r & be√°ll√≠t√°sok</span></div></a>
    </nav>

    <section class="card">
      <div class="subhdr">
        <button id="toggleAll" class="btn">Mutasd az √∂sszes fordul√≥t</button>
        <span id="rangeLabel" class="muted">Alap: az utols√≥ 5 fordul√≥ l√°tszik</span>
      </div>
      <div id="tableMount" data-mode="last"></div>
      <div style="padding:8px 12px;font-size:12px;color:#64748b">‚≠ê = adott fordul√≥ legmagasabb pontja</div>
    </section>
  </div>

  <button id="chatToggle" class="chat-fab" title="K√∂z√∂ss√©gi chat">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 4h16a2 2 0 0 1 2 2v11a2 2 0 0 1 2 2H8l-4 3V6a2 2 0 0 1 2-2Z"/></svg>
    <span id="chatFabBadge" class="fab-badge"></span>
  </button>

  <section id="chatPanel" class="chat-panel" aria-label="K√∂z√∂ss√©gi chat">
    <div class="chat-head">
      <div class="chat-title">K√∂z√∂ss√©gi chat</div>
      <button id="chatClose" aria-label="Bez√°r√°s">‚úï</button>
    </div>
    <div id="chatMessages" class="chat-list" role="log" aria-live="polite"></div>
    <div id="chatComposer">
      <input id="chatInput" type="text" placeholder="√çrj valamit‚Ä¶" autocomplete="off">
      <button id="chatSendBtn">K√ºld√©s</button>
    </div>
  </section>

  <div class="bonus-backdrop" hidden></div>
</body>
</html>
