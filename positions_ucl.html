<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>BL TippLiga ‚Äì Top 8 + b√≥nuszok</title>

  <link rel="stylesheet" href="style-themed.css" />
  <link rel="stylesheet" href="style.css" />
  <script src="loader.js" defer></script>

  <style>
    .layout{display:flex;flex-direction:column;gap:16px;max-width:1200px;margin:0 auto;padding:20px}
    .content-grid{display:grid;grid-template-columns:1fr;gap:16px}

    .header{display:flex;align-items:center;justify-content:space-between}
    .header-left{display:flex;align-items:center;gap:12px}
    .fav-crest{width:46px;height:46px;object-fit:contain;border-radius:8px;border:1px solid var(--line,#e6eaf1);background:#fff}
    .welcome{color:var(--muted,#64748b);margin:4px 0 0}

    /* NAV */
    .nav-grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:14px}
    @media (max-width:1100px){.nav-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:700px){.nav-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .nav-card{display:flex;gap:12px;align-items:center;text-decoration:none;color:inherit;padding:14px;background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:14px;box-shadow:0 6px 18px rgba(15,23,42,.05)}
    .nav-card .icon-wrap{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:color-mix(in oklab, var(--accent,#3b82f6) 15%, white);color:var(--accent,#3b82f6)}
    .nav-card .text{display:flex;flex-direction:column;line-height:1.2}
    .nav-card .title{font-weight:800}
    .nav-card .desc{color:var(--muted,#64748b);font-size:12px}
    .pill-badge{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;padding:0 6px;margin-left:6px;border-radius:999px;background:#ef4444;color:#fff;font-size:12px;font-weight:700;line-height:1}
    .pill-badge[hidden]{display:none!important}

    /* Cards + accordion */
    .card{background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,.06);overflow:hidden}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line,#e6eaf1);background:#f7f9fd;cursor:pointer;gap:12px}
    .card-title{display:flex;align-items:center;gap:8px;font-weight:800;margin:0}
    .card-meta{display:flex;align-items:center;gap:10px}
    .card-body{display:none}
    .card.open .card-body{display:block}
    .arrow{transition:transform .18s ease}
    .card.open .arrow{transform:rotate(180deg)}

    /* Status pill */
    .status{display:inline-flex;align-items:center;gap:6px;font-size:12px}
    .dot{width:18px;height:18px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;background:#e2e8f0;color:#fff}
    .dot.ok{background:#16a34a}
    .dot svg{width:14px;height:14px}
    .count{font-size:12px;color:#111;background:#e6f1ff;border:1px solid var(--line,#e6eaf1);padding:2px 8px;border-radius:999px}

    /* === √öJ: visszasz√°ml√°l√≥ pill === */
    .countdown-pill{
      font-size:12px;color:#111;background:#fff4e6;border:1px solid var(--line,#e6eaf1);
      padding:2px 8px;border-radius:999px;white-space:nowrap
    }
    .countdown-pill.soon{ background:#fee2e2 }

    /* Top8 ‚Äì dupla lista */
    .top8-wrap{padding:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:800px){.top8-wrap{grid-template-columns:1fr}}
    .col{background:#fff;border:1px dashed var(--line,#e6eaf1);border-radius:12px}
    .col h4{margin:0;padding:10px 12px;border-bottom:1px dashed var(--line,#e6eaf1);font-size:14px}
    .search{width:100%;padding:8px 10px;border:1px solid var(--line,#e6eaf1);border-radius:10px;margin:10px 12px}
    .pool{padding:0 12px 12px;display:flex;flex-wrap:wrap;gap:10px;align-content:flex-start;min-height:86px}
    .team-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line,#e6eaf1);border-radius:10px;background:#fff;cursor:pointer}
    .team-chip[aria-pressed="true"]{outline:2px solid color-mix(in oklab, var(--accent,#3b82f6) 35%, white)}
    .crest{width:22px;height:22px;object-fit:contain;border-radius:4px;background:#fff;border:1px solid var(--line,#e6eaf1)}
    .selected-wrap{padding:12px;display:flex;flex-wrap:wrap;gap:10px;min-height:86px;background:#fafbff;border-radius:0 0 12px 12px}
    .selected-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line,#e6eaf1);border-radius:10px;background:#fff;cursor:pointer}

    .save-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-top:1px solid var(--line,#e6eaf1);background:#fff}
    .save-state{font-size:12px;color:#16a34a;display:none}
    .save-state.show{display:inline-flex}

    /* Pick cards */
    .grid-cards{padding:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .pick-card{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--line,#e6eaf1);border-radius:12px;background:#fff;cursor:pointer;transition:transform .08s ease}
    .pick-card:hover{transform:translateY(-1px)}
    .pick-card.selected{background:#ecfdf5;border-color:#16a34a;box-shadow:0 0 0 2px rgba(22,163,74,.15) inset}
    .pc-crest{width:34px;height:34px;object-fit:contain;border:1px solid var(--line,#e6eaf1);background:#fff}
    .pc-text{display:flex;flex-direction:column;line-height:1.15}
    .pc-name{font-weight:700}
    .pc-sub{font-size:12px;color:#64748b}
    .badge-odds{font-size:12px;background:#eef2ff;border:1px solid var(--line,#e6eaf1);padding:2px 6px;border-radius:999px;margin-top:4px;display:inline-block}
    .pc-check{margin-left:auto;font-weight:800;opacity:0}
    .pick-card.selected .pc-check{opacity:1;color:#16a34a}

    /* Chat FAB */
    .chat-fab{position:fixed;right:22px;bottom:22px;z-index:999;width:52px;height:52px;border-radius:999px;border:0;background:var(--accent,#3b82f6);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 26px rgba(0,0,0,.15)}
    .chat-fab .fab-badge{position:absolute;top:-4px;right:-4px;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;font-size:12px;font-weight:800;line-height:20px;display:none}
    .chat-fab.has-unread .fab-badge{display:inline-block}
    .chat-panel{position:fixed;right:22px;bottom:86px;z-index:998;width:380px;max-width:calc(100vw - 32px);max-height:70vh;display:none;flex-direction:column;background:#fff;border:1px solid var(--line,#e6eaf1);border-radius:14px;box-shadow:0 10px 32px rgba(0,0,0,.14)}
    .chat-panel.open{display:flex}
    .chat-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line,#e6eaf1);background:#f7f9fd}
    .chat-title{font-weight:800}
    #chatClose{width:28px;height:28px;border-radius:8px;font-size:18px;line-height:28px;display:inline-flex;align-items:center;justify-content:center;background:#eef2ff;color:#111;border:1px solid var(--line,#e6eaf1);cursor:pointer}
    #chatClose:hover{filter:brightness(.95)}
    .chat-list{overflow:auto;padding:8px 10px}
    .chat-empty{color:#64748b;font-size:13px;padding:8px 10px}
    .msg{padding:8px 10px;border-bottom:1px solid var(--line,#e6eaf1);display:flex;gap:8px;align-items:flex-start}
    .msg .meta{font-size:12px;color:#64748b;margin-bottom:2px}
    .msg .text{white-space:pre-wrap;word-break:break-word}
    .msg .del{margin-left:auto;background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:2px 8px;border-radius:8px;font-size:12px;cursor:pointer;display:none}
    .msg:hover .del{display:inline-block}

    .btn-accent{min-height:40px;padding:10px 14px;border-radius:10px;background:var(--accent,#3b82f6);color:#fff;border:1px solid var(--line,#e6eaf1);font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 6px 18px rgba(15,23,42,.08)}
    .btn-accent:hover{filter:brightness(.95)}
    .btn-icon{width:18px;height:18px;display:inline-block}

    /* === Hat√°rid≈ë s√°v + lock sz√ºrke√≠t√©s === */
    .deadline-banner{margin:8px 0 0;padding:10px 12px;border:1px solid var(--line,#e6eaf1);border-radius:10px;background:#f8fafc;color:#0f172a;display:flex;align-items:center;gap:8px;font-weight:600}
    .deadline-banner .em{font-weight:800}
    .deadline-banner.locked{background:#fff7ed;color:#7c2d12;border-color:#fed7aa}
    body.locked .pool, body.locked .selected-wrap, body.locked .grid-cards{filter:grayscale(.2);opacity:.6}
    body.locked .team-chip, body.locked .selected-chip, body.locked .pick-card{pointer-events:none;cursor:not-allowed}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, deleteDoc, serverTimestamp, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* C√≠merek ‚Äì BL mez≈ëny */
    const crestMap = {
      "Ajax": "ucl_crest/ajax.png",
      "Arsenal": "ucl_crest/arsenal.png",
      "Atalanta": "ucl_crest/atalanta.png",
      "Athletic Bilbao": "ucl_crest/athletic.png",
      "Atl√©tico Madrid": "ucl_crest/atletico.png",
      "Barcelona": "ucl_crest/barcelona.png",
      "Bayern M√ºnchen": "ucl_crest/bayern.png",
      "Benfica": "ucl_crest/benfica.png",
      "Borussia Dortmund": "ucl_crest/borussia.png",
      "Bod√∏/Glimt": "ucl_crest/bodo.png",
      "Club Bruges": "ucl_crest/brugge.png",
      "Chelsea": "ucl_crest/chelsea.png",
      "FC K√∂benhavn": "ucl_crest/copenhagen.png",
      "Eintracht Frankfurt": "ucl_crest/frankfurt.png",
      "Galatasaray": "ucl_crest/galata.png",
      "Internazionale": "ucl_crest/inter.png",
      "Juventus": "ucl_crest/juventus.png",
      "Bayer Leverkusen": "ucl_crest/leverkusen.png",
      "Liverpool": "ucl_crest/liverpool.png",
      "Manchester City": "ucl_crest/mancity.png",
      "Olympique Marseille": "ucl_crest/marseille.png",
      "Monaco": "ucl_crest/monaco.png",
      "Napoli": "ucl_crest/napoli.png",
      "Newcastle United": "ucl_crest/newcastle.png",
      "Olympiakosz Pireusz": "ucl_crest/olympiacos.png",
      "Pafosz": "ucl_crest/pafos.png",
      "Paris Saint-Germain": "ucl_crest/psg.png",
      "PSV": "ucl_crest/psv.png",
      "Qarabag": "ucl_crest/qarabag.png",
      "Real Madrid": "ucl_crest/real.png",
      "Slavia Praha": "ucl_crest/slavia.png",
      "Sporting CP": "ucl_crest/sporting.png",
      "Tottenham Hotspur": "ucl_crest/tottenham.png",
      "Union Saint-Gilloise": "ucl_crest/usg.png",
      "Villarreal": "ucl_crest/villareal.png",
      "Kajrat Almati": "ucl_crest/kairat.png"
    };

    const crestFor = t => crestMap[t] || "";
    const TEAMS = Object.keys(crestMap).sort((a,b)=>a.localeCompare(b,"hu"));
    const fmtTime = ts => { try{ return ts.toDate().toLocaleString("hu-HU",{hour12:false}); }catch{ return ""; } };
    const norm = s => (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();

    let currentUserEmail = "";
    let currentUserNick  = "";
    let currentUserRole  = "user";
    let favouriteTeamucl = "";
    let chatLastSeen     = null;

    // model
    let selectedTop8 = [];
    let championCandidates = [];
    let goldenCandidates   = [];
    let pickedChampion     = "";
    let pickedGolden       = "";
    let teamQuery          = "";

    /* üîí Lez√°r√°s √°llapot */
    let POS_LOCK = { active:false, text:'', info:'', until:null };

    /* visszasz√°ml√°l√≥ */
    let countdownTimer = null;
    function startCountdown(until){
      clearInterval(countdownTimer);
      const el = document.getElementById('cdTop8');
      if (!until || POS_LOCK.active){ if(el) el.hidden = true; return; }
      function render(){
        const ms = until - new Date();
        if (ms <= 0){ el.hidden = true; clearInterval(countdownTimer); return; }
        const s  = Math.floor(ms/1000);
        const d  = Math.floor(s/86400);
        const h  = Math.floor((s%86400)/3600);
        const m  = Math.floor((s%3600)/60);
        const ss = s%60;
        let txt = (d>0? `${d}n `:"") + String(h).padStart(2,'0')+":"+String(m).padStart(2,'0')+":"+String(ss).padStart(2,'0');
        el.textContent = txt;
        el.hidden = false;
        el.classList.toggle('soon', ms < 3600_000); // < 1 √≥ra => pirosas h√°tt√©r
      }
      render();
      countdownTimer = setInterval(render, 1000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login_ucl.html"; return; }
        currentUserEmail = user.email;

        const userRef = doc(db, "users", currentUserEmail);
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
          const d = userSnap.data();
          currentUserNick  = d.nickname || currentUserEmail;
          currentUserRole  = d.role || "user";
          favouriteTeamucl = d.favouriteTeamucl || "";
          chatLastSeen     = d.chatLastSeen || null;
        } else {
          currentUserNick = currentUserEmail;
        }

        document.getElementById("welcome").textContent = `√údv, ${currentUserNick}!`;
        if (currentUserRole === "admin") document.getElementById("adminLink").style.display = "flex";

        if (favouriteTeamucl) {
          const themeClass = "theme-" + favouriteTeamucl.toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-');
          document.body.classList.add(themeClass);
          const crest = crestFor(favouriteTeamucl);
          if (crest) { const img = document.getElementById("favCrest"); img.src = crest; img.alt = favouriteTeamucl; img.hidden = false; }
        }

        // kor√°bban mentett Top8
        try{
          const tipDoc = await getDoc(doc(db,"ucl_top8Tips", currentUserEmail));
          if (tipDoc.exists()){
            const arr = Array.isArray(tipDoc.data().picks) ? tipDoc.data().picks : [];
            selectedTop8 = arr.filter(t => TEAMS.includes(t)).slice(0,8);
          }
        }catch{}

        /* üîí lock + hat√°rid≈ë */
        await loadPositionsLockAndApply();

        await loadMarkets();
        await hydrateChampionPick();
        await hydrateGoldenPick();

        renderPool();
        renderSelected();
        updateBadges();

        initAccordions();
        initSearch();
        initChat(userRef);
        updatePendingBadge();
        if (window.hideLoader) hideLoader();
      });

      document.getElementById("logout").addEventListener("click", () => {
        signOut(auth).then(() => window.location.href = "login_ucl.html");
      });
    });

    /* ===== Helpers ===== */
    const toNum = (v) => {
      if (v === null || v === undefined || v === '') return null;
      if (typeof v === 'string') v = v.replace(',', '.');
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };
    const fromCandidateOdds = c => {
      const direct = toNum(c?.odds);
      if (direct != null) return direct;
      const dec = toNum(c?.oddsDecimal);
      if (dec != null) return dec;
      const pct = toNum(c?.oddsPercent);
      if (pct != null && pct > 0) return 100 / pct;
      return null;
    };
    const fromDisplayedPoints = c => toNum(c?.displayPoints);

    function computePoints(odds, BASE=10, O0=65, A=0.33, LO=0.5, HI=2.5){
      const o = toNum(odds);
      if(!o || o<=0) return null;
      const ratio   = Math.pow(o/Math.max(O0,1e-9), A);
      const clamped = Math.min(Math.max(ratio, LO), HI);
      return BASE * clamped;
    }
    function candidatePoints(c, scope){
      const dp = fromDisplayedPoints(c);
      if (dp != null) return dp;
      const odds = fromCandidateOdds(c);
      const cfg  = (c._calc && c._calc.scope === scope) ? c._calc : {};
      return computePoints(odds, cfg.BASE ?? 10, cfg.O0 ?? 65, cfg.A ?? 0.33, cfg.LO ?? 0.5, cfg.HI ?? 2.5);
    }
    const fmtPts = v => (v==null ? "‚Äî" : `+${toNum(v).toFixed(2)}`);

    /* ===== üîí Lez√°r√°s + hat√°rid≈ë ===== */
    async function loadPositionsLockAndApply(){
      try{
        const snap = await getDoc(doc(db,'settings','positionsLock_ucl'));
        let active=false, text='', info='', until=null, msg='';
        if(snap.exists()){
          const d = snap.data()||{};
          until = d.lockUntil?.toDate?.() || null;
          msg   = d.message || '';
          const now = new Date();
          const timeLocked = until && now >= until;
          active = !!d.isLocked || timeLocked;

          if (active){
            text = `üîí Lez√°rva ${timeLocked&&until?`(hat√°rid≈ë: ${until.toLocaleString('hu-HU')})`:'(azonnali z√°r√°s)'}${msg?` ‚Äì ${msg}`:''}`;
          }

          if (until && !active){
            info = `‚è≥ Hat√°rid≈ë: <span class="em">${until.toLocaleString('hu-HU')}</span> ‚Äì ut√°na lez√°rjuk a tippeket.${msg?` ${msg}`:''}`;
          } else if (active){
            info = text;
          } else {
            info = 'Nyitva ‚Äì nincs be√°ll√≠tott hat√°rid≈ë.';
          }
        } else {
          active = false; text=''; info='Nyitva ‚Äì nincs be√°ll√≠tott hat√°rid≈ë.'; until=null;
        }
        POS_LOCK = { active, text, info, until };
      }catch{
        POS_LOCK = { active:false, text:'', info:'Nyitva ‚Äì nincs be√°ll√≠tott hat√°rid≈ë.', until:null };
      }
      applyLockUI();
    }

    function ensureDeadlineBanner(){
      let banner = document.getElementById('deadlineBanner');
      if(!banner){
        banner = document.createElement('div');
        banner.id = 'deadlineBanner';
        banner.className = 'deadline-banner';
        const host = document.querySelector('.layout');
        const anchor = host?.querySelector('#card-top8');
        if (host && anchor) host.insertBefore(banner, anchor);
      }
      return banner;
    }

    function applyLockUI(){
      const banner = ensureDeadlineBanner();
      banner.innerHTML = POS_LOCK.info;
      banner.classList.toggle('locked', POS_LOCK.active);
      banner.hidden = false;

      document.body.classList.toggle('locked', POS_LOCK.active);
      const s = document.getElementById('teamSearch');
      if (s) s.disabled = POS_LOCK.active;

      if (POS_LOCK.active){
        document.querySelectorAll('.status .status-text').forEach(el=> el.textContent='Lez√°rva');
      } else {
        updateBadges();
      }

      // visszasz√°ml√°l√≥ friss√≠t√©se
      startCountdown(POS_LOCK.until);
    }

    /* ===== Accordion ===== */
    function initAccordions(){
      document.querySelectorAll('.card-head').forEach(h=>{
        h.addEventListener('click',()=> h.parentElement.classList.toggle('open'));
      });
      document.getElementById('card-top8').classList.add('open');
    }

    /* ===== Search ===== */
    function initSearch(){
      const inp = document.getElementById('teamSearch');
      inp.addEventListener('input', ()=>{ teamQuery = inp.value; renderPool(); });
    }

    /* ===== Markets ===== */
    async function loadMarkets(){
      try{
        const cSnap = await getDocs(collection(db,"ucl_championCandidates"));
        championCandidates = cSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) })).filter(x=>x.team);
      }catch{ championCandidates=[]; }

      try{
        const gSnap = await getDocs(collection(db,"ucl_goldenBootCandidates"));
        goldenCandidates = gSnap.docs.map(d=>({ id:d.id, ...(d.data()||{}) })).filter(x=>x.player);
      }catch{ goldenCandidates=[]; }

      function sortByPointsAsc(arr, scope, labelGetter){
        arr.sort((a,b)=>{
          const pa = candidatePoints(a, scope);
          const pb = candidatePoints(b, scope);
          if (pa==null && pb==null) return labelGetter(a).localeCompare(labelGetter(b),'hu');
          if (pa==null) return 1;
          if (pb==null) return -1;
          if (pa!==pb) return pa - pb;
          return labelGetter(a).localeCompare(labelGetter(b),'hu');
        });
      }
      sortByPointsAsc(championCandidates, 'champion', x=>x.team);
      sortByPointsAsc(goldenCandidates,  'golden',   x=>x.player);

      renderChampionGrid();
      renderGoldenGrid();
    }

    function renderChampionGrid(){
      const box = document.getElementById('chGrid');
      box.innerHTML = '';
      if(championCandidates.length===0){
        box.innerHTML = '<div class="pc-sub" style="padding:0 12px 12px">Nincs el√©rhet≈ë jel√∂lt. K√©rd az admint!</div>';
        return;
      }
      championCandidates.forEach(c=>{
        const pts  = candidatePoints(c,'champion');
        const odds = fromCandidateOdds(c);
        const el = document.createElement('div');
        el.className = 'pick-card';
        el.dataset.team = c.team;
        el.dataset.odds = odds==null ? "" : String(odds);
        el.dataset.points = pts==null ? "" : String(pts);
        el.innerHTML = `
          <img class="pc-crest" src="${crestFor(c.team)}" alt="">
          <div class="pc-text">
            <div class="pc-name">${c.team}</div>
            <div class="badge-odds">${fmtPts(pts)}</div>
          </div>
          <div class="pc-check">‚úì</div>`;
        el.addEventListener('click', ()=>{ if (POS_LOCK.active) return; saveChampionPickWith(c.team, odds); });
        box.appendChild(el);
      });
      highlightChampionCard();
    }

    function renderGoldenGrid(){
      const box = document.getElementById('gbGrid');
      box.innerHTML = '';
      if(goldenCandidates.length===0){
        box.innerHTML = '<div class="pc-sub" style="padding:0 12px 12px">Nincs el√©rhet≈ë jel√∂lt. K√©rd az admint!</div>';
        return;
      }
      goldenCandidates.forEach(c=>{
        const crest = crestFor(c.team||'') || '';
        const pts   = candidatePoints(c,'golden');
        const odds  = fromCandidateOdds(c);
        const el = document.createElement('div');
        el.className = 'pick-card';
        el.dataset.player = c.player;
        el.dataset.team = c.team || '';
        el.dataset.odds = odds==null ? "" : String(odds);
        el.dataset.points = pts==null ? "" : String(pts);
        el.innerHTML = `
          ${crest? `<img class="pc-crest" src="${crest}" alt="">` : `<div class="pc-crest" style="display:flex;align-items:center;justify-content:center;font-size:16px">‚öΩ</div>`}
          <div class="pc-text">
            <div class="pc-name">${c.player}</div>
            <div class="pc-sub">${c.team || '‚Äì'}</div>
            <div class="badge-odds">${fmtPts(pts)}</div>
          </div>
          <div class="pc-check">‚úì</div>`;
        el.addEventListener('click', ()=>{ if (POS_LOCK.active) return; saveGoldenPickWith(c.player, c.team||'', odds); });
        box.appendChild(el);
      });
      highlightGoldenCard();
    }

    /* ===== Saj√°t pickek ===== */
    async function hydrateChampionPick(){
      try{
        const chDoc = await getDoc(doc(db,"ucl_championPickTips", currentUserEmail));
        pickedChampion = (chDoc.exists() && chDoc.data().team) ? chDoc.data().team : "";
      }catch{ pickedChampion = ""; }
      highlightChampionCard(); updateBadges();
    }
    function highlightChampionCard(){
      document.querySelectorAll('#chGrid .pick-card').forEach(el=>{
        el.classList.toggle('selected', el.dataset.team === pickedChampion);
      });
      document.getElementById("saveStateC")?.classList.remove('show');
    }

    async function hydrateGoldenPick(){
      try{
        const gbDoc = await getDoc(doc(db,"ucl_goldenBootTips", currentUserEmail));
        pickedGolden = (gbDoc.exists() && gbDoc.data().player) ? gbDoc.data().player : "";
      }catch{ pickedGolden = ""; }
      highlightGoldenCard(); updateBadges();
    }
    function highlightGoldenCard(){
      document.querySelectorAll('#gbGrid .pick-card').forEach(el=>{
        el.classList.toggle('selected', el.dataset.player === pickedGolden);
      });
      document.getElementById("saveStateG")?.classList.remove('show');
    }

    /* ===== Ment√©sek ===== */
    let saveTimerTop8 = null;
    function autoSaveTop8(){ clearTimeout(saveTimerTop8); saveTimerTop8 = setTimeout(saveTop8Now, 250); }
    async function saveTop8Now(){
      if (POS_LOCK.active) return;
      const saved = document.getElementById("saveStateTop8");
      try{
        await setDoc(doc(db,"ucl_top8Tips", currentUserEmail), {
          email: currentUserEmail,
          nick: currentUserNick || currentUserEmail,
          picks: selectedTop8.slice(0,8),
          updatedAt: serverTimestamp()
        }, { merge:true });
        saved.classList.add("show");
        setTimeout(()=>saved.classList.remove("show"), 1100);
        updateBadges();
      }catch{}
    }

    let saveTimerC = null;
    function saveChampionPickWith(team, oddsDecimal){
      if (POS_LOCK.active) return;
      clearTimeout(saveTimerC);
      pickedChampion = team;
      highlightChampionCard(); updateBadges();
      saveTimerC = setTimeout(async ()=>{
        try{
          const oddsDec = toNum(oddsDecimal);
          const oddsPct = (oddsDec && oddsDec>0) ? (100/oddsDec) : null;
          await setDoc(doc(db,"ucl_championPickTips", currentUserEmail), {
            email: currentUserEmail, nick: currentUserNick || currentUserEmail,
            team, odds: oddsDec, oddsDecimal: oddsDec, oddsPercent: oddsPct, updatedAt: serverTimestamp()
          }, { merge:true });
          const s = document.getElementById("saveStateC");
          s.classList.add("show"); setTimeout(()=>s.classList.remove("show"), 1100);
        }catch{}
      }, 150);
    }

    let saveTimerG = null;
    function saveGoldenPickWith(player, team, oddsDecimal){
      if (POS_LOCK.active) return;
      clearTimeout(saveTimerG);
      pickedGolden = player;
      highlightGoldenCard(); updateBadges();
      saveTimerG = setTimeout(async ()=>{
        try{
          const oddsDec = toNum(oddsDecimal);
          const oddsPct = (oddsDec && oddsDec>0) ? (100/oddsDec) : null;
          await setDoc(doc(db,"ucl_goldenBootTips", currentUserEmail), {
            email: currentUserEmail, nick: currentUserNick || currentUserEmail,
            player, team, odds: oddsDec, oddsDecimal: oddsDec, oddsPercent: oddsPct, updatedAt: serverTimestamp()
          }, { merge:true });
          const s = document.getElementById("saveStateG");
          s.classList.add("show"); setTimeout(()=>s.classList.remove("show"), 1100);
        }catch{}
      }, 150);
    }

    /* ===== Top8 UI ===== */
    function renderPool(){
      const pool = document.getElementById("pool");
      pool.innerHTML = "";
      const q = norm(teamQuery);
      const notSelected = TEAMS.filter(t => !selectedTop8.includes(t)).filter(t => !q || norm(t).includes(q));
      for (const team of notSelected){
        const chip = document.createElement("div");
        chip.className = "team-chip";
        chip.setAttribute("role","button");
        chip.setAttribute("aria-pressed","false");
        chip.innerHTML = `<img class="crest" src="${crestFor(team)}" alt=""><span>${team}</span>`;
        chip.addEventListener("click", ()=>toggleSelect(team));
        pool.appendChild(chip);
      }
    }
    function renderSelected(){
      const sel = document.getElementById("selected");
      const countEl = document.getElementById("top8Count");
      sel.innerHTML = "";
      selectedTop8.forEach(team=>{
        const chip = document.createElement("div");
        chip.className = "selected-chip";
        chip.setAttribute("role","button");
        chip.setAttribute("aria-pressed","true");
        chip.title = "Elt√°vol√≠t√°s";
        chip.innerHTML = `<img class="crest" src="${crestFor(team)}" alt=""><span>${team}</span>`;
        chip.addEventListener("click", ()=>removeTeam(team));
        sel.appendChild(chip);
      });
      countEl.textContent = `${selectedTop8.length}/8`;
      document.getElementById("saveStateTop8").classList.toggle("show", false);
    }
    function toggleSelect(team){
      if (POS_LOCK.active) return;
      if (selectedTop8.includes(team)){ removeTeam(team); return; }
      if (selectedTop8.length>=8) return;
      selectedTop8.push(team);
      renderPool(); renderSelected(); autoSaveTop8();
    }
    function removeTeam(team){
      if (POS_LOCK.active) return;
      selectedTop8 = selectedTop8.filter(t=>t!==team);
      renderPool(); renderSelected(); autoSaveTop8();
    }

    /* ===== Fejl√©c pip√°k ===== */
    function updateBadges(){
      setStatus('stTop8', selectedTop8.length===8);
      setStatus('stChampion', !!pickedChampion);
      setStatus('stGolden', !!pickedGolden);
    }
    function setStatus(id, ok){
      const el = document.getElementById(id);
      if(!el) return;
      el.innerHTML = ok
        ? '<span class="dot ok" title="Tipp mentve"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg></span><span class="status-text">K√©sz</span>'
        : '<span class="dot" title="M√©g nincs tipp">‚Äì</span><span class="status-text">Nincs tipp</span>';
    }

    /* ===== Meccs badge a MECCSTIPPEK men√ºpontra ===== */
    function updatePendingBadge(){
      getDocs(query(collection(db,"ucl_matches"), where("startTime", ">=", new Date()))).then(upcomingSnap=>{
        const upcoming = upcomingSnap.docs.map(d => ({ id:d.id, ...d.data() }));
        getDocs(query(collection(db,"ucl_tips"), where("user","==", currentUserEmail))).then(tipsSnap=>{
          const latestByMatch = new Map();
          tipsSnap.forEach(x=>{ const t=x.data(); if(!t?.matchId) return; const cur=latestByMatch.get(t.matchId);
            const ts=(t.updatedAt?.toMillis?.()||t.createdAt?.toMillis?.()||t.timestamp?.toMillis?.()||0);
            const cts=(cur?.updatedAt?.toMillis?.()||cur?.createdAt?.toMillis?.()||cur?.timestamp?.toMillis?.()||0);
            if(!cur || ts>=cts) latestByMatch.set(t.matchId,t);
          });
          const tippedIds = new Set(Array.from(latestByMatch.keys()));
          const pending = upcoming.filter(m => !tippedIds.has(m.id)).length;
          const badge = document.getElementById("tipsBadge"); // ‚Üê MOST m√°r a Meccstippek k√°rty√°n van
          if (badge){
            if (pending>0){ badge.textContent = pending; badge.hidden = false; } else { badge.hidden = true; }
          }
        });
      });
    }

    /* ===== Chat ===== */
    function initChat(userRef){
      const fab = document.getElementById('chatToggle');
      const fabBadge = document.getElementById('chatFabBadge');
      const panel = document.getElementById('chatPanel');
      const closeBtn = document.getElementById('chatClose');
      const listEl = document.getElementById('chatMessages');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('chatSendBtn');

      function open(){ panel.classList.add('open'); setTimeout(()=>inputEl?.focus(), 50); markSeen(); }
      function close(){ panel.classList.remove('open'); }
      fab.addEventListener('click', ()=> panel.classList.contains('open') ? close() : open());
      closeBtn.addEventListener('click', close);

      let lastSeenMs = chatLastSeen?.toMillis ? chatLastSeen.toMillis() : 0;

      const qAll = query(collection(db,'chatMessages'), orderBy('ts','asc'));
      onSnapshot(qAll, snap => {
        listEl.innerHTML = '';
        if (snap.empty){
          const empty = document.createElement('div');
          empty.className = 'chat-empty';
          empty.textContent = 'M√©g nincs √ºzenet. L√©gy te az els≈ë!';
          listEl.appendChild(empty);
        } else {
          let unread = 0;
          snap.forEach(docu=>{
            const d = docu.data();
            const tsMs = d.ts?.toMillis?.() || 0;
            if (tsMs > lastSeenMs) unread++;

            const row = document.createElement('div');
            row.className = 'msg';
            row.innerHTML = `
              <div style="flex:1 1 auto">
                <div class="meta"><strong>${d.nick || 'Ismeretlen'}</strong> ‚Ä¢ ${d.ts ? fmtTime(d.ts) : ''}</div>
                <div class="text">${(d.text || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
              </div>`;
            const canDelete = (currentUserRole === 'admin') || (d.email === currentUserEmail);
            if (canDelete){
              const del = document.createElement('button');
              del.className = 'del';
              del.textContent = 'T√∂rl√©s';
              del.title = '√úzenet t√∂rl√©se';
              del.addEventListener('click', async ()=>{ try{ await deleteDoc(doc(db, 'chatMessages', docu.id)); }catch{} });
              row.appendChild(del);
            }
            listEl.appendChild(row);
          });

          if (!panel.classList.contains('open') && unread > 0){
            fab.classList.add('has-unread');
            fabBadge.textContent = unread > 99 ? '99+' : String(unread);
          } else {
            fab.classList.remove('has-unread');
            fabBadge.textContent = '';
          }

          setTimeout(()=>{ listEl.scrollTop = listEl.scrollHeight; }, 0);
        }
      });

      document.getElementById('chatSendBtn').addEventListener('click', async ()=>{
        const txt = (inputEl.value || '').trim();
        if (!txt){ inputEl.focus(); return; }
        const backup = txt;
        inputEl.value = '';
        try{
          await addDoc(collection(db,'chatMessages'), { email: currentUserEmail, nick: currentUserNick || 'Ismeretlen', text: backup, ts: serverTimestamp() });
          if (panel.classList.contains('open')) await markSeen();
        }catch{
          inputEl.value = backup; inputEl.focus();
        }
      });
      inputEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('chatSendBtn').click(); } });

      async function markSeen(){
        try{
          await setDoc(userRef, { chatLastSeen: serverTimestamp() }, { merge:true });
          lastSeenMs = Date.now();
          fab.classList.remove('has-unread');
          fabBadge.textContent = '';
        }catch{}
      }
    }
  </script>
</head>
<body>
  <div class="layout">
    <div class="header">
      <div class="header-left">
        <img id="favCrest" class="fav-crest" alt="" hidden>
        <div>
          <h1>BL TippLiga</h1>
          <p id="welcome" class="welcome"></p>
        </div>
      </div>
      <div>
        <button id="logout" class="btn-accent" aria-label="Kil√©p√©s">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H11a2 2 0 0 0-2 2v3h2V5h8v14h-8v-3H9v3a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2z"/>
          </svg>
          Kil√©p√©s
        </button>
      </div>
    </div>

    <!-- NAV -->
    <nav class="nav-grid">
      <a class="nav-card" href="dashboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3 2 12h3v8h6v-5h2v5h6v-8h3L12 3z"/></svg>
        </div>
        <div class="text"><span class="title">F≈ëoldal</span><span class="desc">Tabella, h√≠rek, kedvencek</span></div>
      </a>

      <!-- Itt NINCS m√°r match-badge -->
      <a class="nav-card" href="positions_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4h6v16H9zM3 10h4v10H3zm14 6h4v4h-4z"/></svg>
        </div>
        <div class="text"><span class="title">Top 8 + b√≥nusz</span><span class="desc">Ligaf√°zis Top 8, gy≈ëztes, g√≥lkir√°ly</span></div>
      </a>

      <!-- A match-badge IDE ker√ºlt -->
      <a class="nav-card" href="matches_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Z"/></svg>
        </div>
        <div class="text">
          <span class="title">Meccstippek <span id="tipsBadge" class="pill-badge" hidden></span></span>
          <span class="desc">K√∂zelg≈ë meccsek & tippek</span>
        </div>
      </a>

      <a class="nav-card" href="results_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 2h6a2 2 0 0 1 2 2h2v16a2 2 0 0 1 2 2H7a2 2 0 0 1-2-2V4h2a2 2 0 0 1 2-2Z"/></svg>
        </div>
        <div class="text"><span class="title">Eredm√©nyek</span><span class="desc">Fordul√≥nk√©nti bont√°s</span></div>
      </a>
      <a class="nav-card" href="leaderboard_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3h3a2 2 0 0 1 2 2v1a5 5 0 0 1-5 5h-1a6 6 0 0 1-4 3.9V17h3v2H9v-2h3v-2.1A6 6 0 0 1 8 11H7A5 5 0 0 1 2 6V5a2 2 0 0 1 2-2h3a2 2 0 0 1 2-2Z"/></svg>
        </div>
        <div class="text"><span class="title">√ñsszpontsz√°m</span><span class="desc">Toplista & b√≥nusz</span></div>
      </a>
      <a class="nav-card" href="profile_ucl.html">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5V22h18v-2.5C21 16.5 17 14 12 14Z"/></svg>
        </div>
        <div class="text"><span class="title">Profil</span><span class="desc">Be√°ll√≠t√°sok & kedvenc csapat</span></div>
      </a>
      <a class="nav-card" id="adminLink" href="admin_ucl.html" style="display:none;">
        <div class="icon-wrap" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Z"/></svg>
        </div>
        <div class="text"><span class="title">Admin</span><span class="desc">Szezon-z√°r & be√°ll√≠t√°sok</span></div>
      </a>
    </nav>

    <!-- Hat√°rid≈ë / z√°r√°s s√°v (mindig l√°tszik) -->
    <div id="deadlineBanner" class="deadline-banner" hidden>Bet√∂lt√©s‚Ä¶</div>

    <!-- 1) Top 8 -->
    <section id="card-top8" class="card">
      <div class="card-head" role="button" aria-expanded="true">
        <div class="card-title">Top 8 tipp</div>
        <div class="card-meta">
          <span class="count" id="top8Count">0/8</span>
          <!-- √öJ: visszasz√°ml√°l√≥ pill -->
          <span id="cdTop8" class="countdown-pill" hidden title="H√°tral√©v≈ë id≈ë a lez√°r√°sig"></span>
          <span class="status" id="stTop8"><span class="dot">‚Äì</span><span class="status-text">Nincs tipp</span></span>
          <svg class="arrow" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
        </div>
      </div>
      <div class="card-body">
        <div class="top8-wrap">
          <div class="col">
            <h4>√ñsszes csapat</h4>
            <input id="teamSearch" class="search" placeholder="Keres√©s‚Ä¶">
            <div id="pool" class="pool"></div>
          </div>
          <div class="col">
            <h4>Kiv√°lasztott (max. 8)</h4>
            <div id="selected" class="selected-wrap"></div>
          </div>
        </div>
        <div class="save-row"><span id="saveStateTop8" class="save-state">Mentve</span></div>
      </div>
    </section>

    <!-- 2) V√©gs≈ë gy≈ëztes -->
    <section id="card-champion" class="card">
      <div class="card-head" role="button" aria-expanded="false">
        <div class="card-title">V√©gs≈ë gy≈ëztes jel√∂ltek</div>
        <div class="card-meta">
          <span class="status" id="stChampion"><span class="dot">‚Äì</span><span class="status-text">Nincs tipp</span></span>
          <svg class="arrow" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
        </div>
      </div>
      <div class="card-body">
        <div id="chGrid" class="grid-cards"></div>
        <div class="save-row"><span id="saveStateC" class="save-state">Mentve</span></div>
      </div>
    </section>

    <!-- 3) G√≥lkir√°ly -->
    <section id="card-golden" class="card">
      <div class="card-head" role="button" aria-expanded="false">
        <div class="card-title">G√≥lkir√°ly jel√∂ltek</div>
        <div class="card-meta">
          <span class="status" id="stGolden"><span class="dot">‚Äì</span><span class="status-text">Nincs tipp</span></span>
          <svg class="arrow" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
        </div>
      </div>
      <div class="card-body">
        <div id="gbGrid" class="grid-cards"></div>
        <div class="save-row"><span id="saveStateG" class="save-state">Mentve</span></div>
      </div>
    </section>
  </div>

  <!-- Chat -->
  <button id="chatToggle" class="chat-fab" title="K√∂z√∂ss√©gi chat">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 4h16a2 2 0 0 1 2 2v11a2 2 0 0 1 2 2H8l-4 3V6a2 2 0 0 1 2-2Z"/></svg>
    <span id="chatFabBadge" class="fab-badge"></span>
  </button>

  <section id="chatPanel" class="chat-panel" aria-label="K√∂z√∂ss√©gi chat">
    <div class="chat-head">
      <div class="chat-title">K√∂z√∂ss√©gi chat</div>
      <button id="chatClose" aria-label="Bez√°r√°s">‚úï</button>
    </div>
    <div id="chatMessages" class="chat-list" role="log" aria-live="polite"></div>
    <div id="chatComposer">
      <input id="chatInput" type="text" placeholder="√çrj valamit‚Ä¶" autocomplete="off">
      <button id="chatSendBtn">K√ºld√©s</button>
    </div>
  </section>
</body>
</html>
