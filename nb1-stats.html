<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NB1 TippLiga – Statisztikák</title>
<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e6eaf1; --accent:#3b82f6;
    --good:#16a34a; --bad:#ef4444; --warn:#f59e0b;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,"Noto Sans",sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:16px}
  .hdr{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .hdr h1{margin:0;font-size:24px}
  .sub{color:var(--muted)}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .sel,.btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn-ac{background:var(--accent);color:#fff;border-color:#dbeafe}
  .grid{display:grid;gap:14px}
  .two{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media(max-width:980px){.two{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 22px rgba(15,23,42,.06);overflow:hidden}
  .card .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#f8faff}
  .card .title{font-weight:800}
  .card .muted{color:var(--muted);font-size:12px}
  .card .body{padding:12px}
  .kpi-row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  @media(max-width:900px){.kpi-row{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:center}
  .kpi .val{font-size:22px;font-weight:800}
  .kpi .spark{height:32px;width:120px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  thead{background:#f7f9fd}
  .mini-leader .pos{width:28px;text-align:right;color:var(--muted)}
  .note{font-size:12px;color:var(--muted)}
  .tag{display:inline-block;background:#eef2ff;border:1px solid var(--line);padding:3px 8px;border-radius:999px;font-size:12px}
  .hl{background:#fff8e1;border:1px solid #fde68a}
  .qq{cursor:help; font-weight:700; margin-left:.35rem; color:#64748b}
  details{display:inline-block}
  details summary{list-style:none;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  details summary::after{content:"⌄";font-size:12px;opacity:.7}
  details[open] summary::after{transform:rotate(180deg)}
  .pill{display:inline-block;padding:2px 6px;border:1px solid var(--line);border-radius:999px;background:#f3f6ff;margin:2px 4px 0 0;font-size:12px}
  .form-inline{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .input{border:1px solid var(--line);border-radius:10px;padding:6px 10px}
  .stat{display:inline-block;min-width:90px}
  .bank-summary{margin-top:8px}
  .result-good{color:var(--good);font-weight:800}
  .result-bad{color:var(--bad);font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <header class="hdr">
    <div>
      <h1>NB1 TippLiga – Statisztikák</h1>
      <div class="sub">Éles Firestore-adatok. <strong>Az 1–3. forduló NEM számít</strong> (játék a 4.-től).</div>
    </div>
    <div class="toolbar">
      <select id="winSel" class="sel" title="Időablak">
        <option value="all" selected>Teljes szezon (F4-től)</option>
        <option value="5">Utolsó 5 forduló</option>
        <option value="10">Utolsó 10 forduló</option>
      </select>
      <select id="playerSel" class="sel" title="Játékos">
        <option value="all" selected>Összes játékos</option>
      </select>
      <select id="oddsSel" class="sel" title="Odds-szűrő">
        <option value="all" selected>Összes odds</option>
        <option value="low">Alacsony (≤1.8)</option>
        <option value="mid">Közepes (1.81–2.99)</option>
        <option value="high">Magas (≥3.0)</option>
      </select>
      <button id="exportBtn" class="btn btn-ac">Export CSV</button>
    </div>
  </header>

  <section class="card">
    <div class="head">
      <div class="title">Egyedi statok</div>
      <div class="muted" id="whoLabel">Összes játékos</div>
    </div>
    <div class="body">
      <div class="kpi-row">
        <div class="kpi" title="Utolsó 5/10 forduló átlagpontja a kiválasztott időablakban. A vonal a trendet mutatja.">
          <div>
            <div class="muted">Forma-index<span class="qq">?</span></div>
            <div class="val" id="kpiForm">–</div>
            <div class="note">Pont / forduló</div>
          </div>
          <div class="spark" id="sparkForm"></div>
        </div>
        <div class="kpi" title="Dupla tippek találati aránya és a duplákból származó pontok aránya az összpontból.">
          <div style="flex:1 1 auto">
            <div class="muted">Duplázó-hatékonyság<span class="qq">?</span></div>
            <div class="val" id="kpiDouble">–</div>
            <div class="note" id="noteDouble">találat/összes • duplából jött pontok aránya</div>
          </div>
        </div>
        <div class="kpi" title="Átlagos választott odds (minden tipp) és a nyerő tippek átlagos oddsa.">
          <div style="flex:1 1 auto">
            <div class="muted">Kockázati profil<span class="qq">?</span></div>
            <div class="val" id="kpiRisk">–</div>
            <div class="note">Átlagos odds (nyerőknél is)</div>
          </div>
        </div>
        <div class="kpi" title="Hányszor találtad el a három kimenetel közül a legnagyobb oddsút és ezek átlaghozama.">
          <div style="flex:1 1 auto">
            <div class="muted">„Upset hunter” index<span class="qq">?</span></div>
            <div class="val" id="kpiUpset">–</div>
            <div class="note" id="noteUpset">ritka kimenetel találat + hozam</div>
          </div>
        </div>
      </div>

      <div class="grid two" style="margin-top:12px">
        <div class="card">
          <div class="head"><div class="title">Hazai / Döntetlen / Vendég bias<span class="qq" title="Milyen arányban választod az 1/X/2-t és ezek közül mennyi a találat.">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>Kimenetel</th><th>Választás</th><th>Találat</th></tr></thead>
              <tbody id="tableBias"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Csapatpreferencia és ROI<span class="qq" title="Mely csapatokra tippelsz a leggyakrabban, és mennyi pontot hoznak tipp/átlag alapon. X-nél mindkét csapat 0.5 tippel számol.">?</span></div><div class="muted">Top 5</div></div>
          <div class="body">
            <table>
              <thead><tr><th>Csapat</th><th>Tippek</th><th>Pts/Tipp</th></tr></thead>
              <tbody id="tableTeamRoi"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Bias index (kedvenc csapat)<span class="qq" title="A users.favoriteTeam alapján: hány tipp ment a kedvenc csapat meccseire, találati% és Pts/Tipp. Ha nincs beállítva, itt „—”.">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>Kedvenc csapat</th><th>Tippek</th><th>Találati %</th><th>Pts/Tipp</th></tr></thead>
              <tbody id="tableFavBias"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Odds-range teljesítmény<span class="qq" title="Odds sávokra bontva: tipp-szám, találati%, átlag pont és ROI (flat 1 egység/tipp).">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>Sáv</th><th>Tippek</th><th>Találati %</th><th>Átlag pont</th><th>ROI</th></tr></thead>
              <tbody id="tableOddsRange"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Sportfogadás-mutató<span class="qq" title="Két szcenárió: (1) minden tipp 1 egység tét; (2) a duplának jelölt tippek 2 egységgel mennek. Profit = Visszafizetés − Össz-tét, ROI = Profit / Össz-tét.">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>Modell</th><th>Találati %</th><th>Össz-tét</th><th>Visszafizetés</th><th>Profit</th><th>ROI</th></tr></thead>
              <tbody id="tableBetSim"></tbody>
            </table>
            <div class="note">A pontszám továbbra is odds-alapú; ez a blokk illusztratív bankroll-szemlélet.</div>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Bankroll-kalkulátor<span class="qq" title="Ha minden saját tippedre X Ft-ot tettél volna a szűrt időablakban: össz-tét, visszafizetés, profit és ROI. A fenti Játékos szűrő szerint számol.">?</span></div></div>
          <div class="body">
            <div class="form-inline" style="margin-bottom:10px">
              <label>Játékos:</label>
              <select id="bankUserSel" class="input"></select>
              <label>Tét / tipp (Ft):</label>
              <input id="bankStake" class="input" type="number" min="1" step="100" value="1000"/>
              <button id="bankRecalcBtn" class="btn">Számol</button>
            </div>
            <div id="bankSummary" class="bank-summary">—</div>
            <div style="margin-top:6px">
              <span class="stat"><strong>Tippek:</strong> <span id="bankOutTips">–</span></span>
              <span class="stat"><strong>Össz-tét:</strong> <span id="bankOutStake">–</span> Ft</span>
              <span class="stat"><strong>Visszafizetés:</strong> <span id="bankOutReturn">–</span> Ft</span>
              <span class="stat"><strong>Profit:</strong> <span id="bankOutProfit">–</span> Ft</span>
              <span class="stat"><strong>ROI:</strong> <span id="bankOutRoi">–</span></span>
            </div>
            <div class="note" style="margin-top:6px">Számítás: flat modell (1 tét egy tippre), a megadott X Ft-tal skálázva.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="head"><div class="title">Összesített liga statok</div><div class="muted" id="rangeLabel">Teljes szezon (F4-től)</div></div>
    <div class="body">
      <div class="grid two" style="margin-bottom:14px">
        <div class="card">
          <div class="head"><div class="title">Legnagyobb meglepetések (Top 5)<span class="qq" title="A legmagasabb nyertes oddsok a kiválasztott időablakon belül, és hogy kik találták el. Csak olyan meccs kerül be, ahol volt találó.">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>Meccs</th><th>Kimenetel</th><th>Odds</th><th>Találók</th></tr></thead>
              <tbody id="tableTopUpsets"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Kimaradt ziccerek (Top 5)<span class="qq" title="A legkisebb oddsok, amelyeket tippekben választottak, de tévesek lettek (’könnyűnek’ hitt, mégsem jött be).">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>Meccs</th><th>Tippelt kimenetel</th><th>Tipp odds</th><th>Rontók</th></tr></thead>
              <tbody id="tableMissedSitters"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="grid two">
        <div class="card">
          <div class="head"><div class="title">Tippeloszlás (1/X/2)<span class="qq" title="Összesen és fordulónként az 1/X/2 választási arány a szűrt időablakban.">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th></th><th>1</th><th>X</th><th>2</th></tr></thead>
              <tbody id="tablePickDist"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">„Bölcs tömeg” pontossága<span class="qq" title="Meccsenként a legnépszerűbb kimenetel talál-e. Mellette az átlagos pont/meccs.">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>Metrika</th><th>Érték</th></tr></thead>
              <tbody id="tableCrowd"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">ROI toplista (flat 1 egység/tipp)<span class="qq" title="Profit = visszafizetés − tét. ROI = Profit / Tét.">?</span></div></div>
          <div class="body">
            <table class="mini-leader">
              <thead><tr><th class="pos">#</th><th>Játékos</th><th>Tippek</th><th>Találati %</th><th>Profit</th><th>ROI</th></tr></thead>
              <tbody id="tableRoiTop"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Odds-kalibráció<span class="qq" title="A három kimenetel implied valószínűségeinek (overround-mentesítve) binelt összevetése a tényleges gyakorisággal.">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>P (bin)</th><th>Várt %</th><th>Valós %</th><th>Eltérés</th></tr></thead>
              <tbody id="tableCalib"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Ponteloszlás fordulónként<span class="qq" title="Medián, 90. percentilis és átlag pont fordulónként a szűrt időablakban.">?</span></div></div>
          <div class="body">
            <table>
              <thead><tr><th>Forduló</th><th>Medián</th><th>P90</th><th>Átlag</th></tr></thead>
              <tbody id="tableRoundDist"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="head"><div class="title">Gini az összpontban<span class="qq" title="0 = teljesen egyenlő eloszlás; 1 = a pontok egy kézben koncentrálódnak.">?</span></div></div>
          <div class="body">
            <div id="giniVal" class="tag">Gini: –</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
    authDomain: "tippliga-4b3af.firebaseapp.com",
    projectId: "tippliga-4b3af",
    storageBucket: "tippliga-4b3af.appspot.com",
    messagingSenderId: "720359845241",
    appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
  };

  const MIN_ROUND = 4;

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $  = (id)=>document.getElementById(id);
  const fmt= (n)=> (Number(n)||0).toFixed(2);
  const s  = (v)=> (v==null ? "" : String(v));

  const tipChoice = t => t?.choice ?? t?.tip ?? "";
  const tipDouble = t => !!(t?.double ?? t?.isDouble);
  const matchRound= m => s(m?.round ?? m?.roundId ?? "");
  function roundNum(m){ const r = parseInt(matchRound(m),10); return isNaN(r)? null : r; }

  function getOdds(m, key){
    if (m?.odds && (key in m.odds)) return Number(m.odds[key]) || 0;
    if (key==="1") return Number(m?.odds1 ?? m?.["odds1"]) || 0;
    if (key==="X") return Number(m?.oddsX ?? m?.["oddsX"]) || 0;
    if (key==="2") return Number(m?.odds2 ?? m?.["odds2"]) || 0;
    return 0;
  }

  const state = {
    tips: [],
    matches: {},
    users: {},
    roundsAsc: [],
    perUserLatest: new Map(),
  };

  onAuthStateChanged(auth, async () => {
    await loadAll();
    hydratePlayerSelect();
    recomputeAll();
    bindUi();
  });

  async function loadAll(){
    const [mSnap, tSnap, uSnap] = await Promise.all([
      getDocs(collection(db, "matches")),
      getDocs(collection(db, "tips")),
      getDocs(collection(db, "users"))
    ]);

    state.matches = {};
    mSnap.forEach(d => {
      const m = { id:d.id, ...d.data() };
      const rn = roundNum(m);
      if (rn==null || rn < MIN_ROUND) return;
      state.matches[d.id] = m;
    });

    state.tips = tSnap.docs.map(d=> ({ id:d.id, ...d.data() }))
      .filter(t => s(t.user).trim() && s(t.matchId).trim());

    state.perUserLatest = new Map();
    for (const tip of state.tips){
      if (!state.matches[s(tip.matchId)]) continue;
      const k = `${s(tip.user)}|${s(tip.matchId)}`;
      const cur = state.perUserLatest.get(k);
      const curTs = cur?.updatedAt?.toMillis?.() || cur?.timestamp?.toMillis?.() || cur?.createdAt?.toMillis?.() || 0;
      const ts    = tip.updatedAt?.toMillis?.() || tip.timestamp?.toMillis?.() || tip.createdAt?.toMillis?.() || 0;
      if (!cur || ts >= curTs) state.perUserLatest.set(k, tip);
    }

    state.users = {};
    uSnap.forEach(d=>{
      const u=d.data();
      if(u?.email){
        state.users[u.email] = { nick: u.nickname || u.email, fav: u.favoriteTeam || "" };
      }
    });

    const rset = new Set();
    Object.values(state.matches).forEach(m=>{ const r = matchRound(m); if (r) rset.add(r); });
    state.roundsAsc = Array.from(rset).map(x=>parseInt(x,10)).sort((a,b)=>a-b).map(x=>String(x));
  }

  function hydratePlayerSelect(){
    const sel = $("playerSel");
    const map = new Map();
    for (const tip of state.perUserLatest.values()){
      const email = s(tip.user).trim(); if (!email) continue;
      const nick = state.users[email]?.nick || email;
      map.set(email, nick);
    }
    const ordered = [...map.entries()].sort((a,b)=> String(a[1]).localeCompare(String(b[1]), "hu", {sensitivity:"base"}));
    ordered.forEach(([email, nick])=>{ const o=document.createElement('option'); o.value=email; o.textContent=nick; sel.appendChild(o); });
  }

  function bindUi(){
    ["playerSel","winSel","oddsSel"].forEach(id=> $(id).addEventListener('change', recomputeAll));
    $("exportBtn").addEventListener('click', exportCsv);
    $("bankRecalcBtn").addEventListener('click', (e)=>{ e.preventDefault(); recomputeBankroll(); });
    $("bankStake").addEventListener('change', recomputeBankroll);
    $("bankStake").addEventListener('input', ()=>{});
  }

  function currentFilters(){
    return { player:$("playerSel").value, win:$("winSel").value, odds:$("oddsSel").value };
  }

  function selectedRounds(){
    const { win } = currentFilters();
    let rounds = state.roundsAsc.slice();
    if (win !== 'all') rounds = rounds.slice(-parseInt(win,10));
    return rounds;
  }

  function tipPassesOddsChoice(o){
    const sel = $("oddsSel").value;
    if (!o) return false;
    if (sel === 'low') return o <= 1.8;
    if (sel === 'mid') return o > 1.8 && o < 3.0;
    if (sel === 'high') return o >= 3.0;
    return true;
  }

  function tipPassesOdds(t, m){
    const pick = tipChoice(t); if (!pick) return false;
    const o = getOdds(m, pick) || 0;
    return tipPassesOddsChoice(o);
  }

  function filterTipsByUi(){
    const { player } = currentFilters();
    const rset = new Set(selectedRounds());
    const out = [];
    for (const tip of state.perUserLatest.values()){
      const email = s(tip.user).trim(); if (!email) continue;
      if (player!=='all' && email!==player) continue;
      const m = state.matches[s(tip.matchId)]; if (!m) continue;
      if (!rset.has(matchRound(m))) continue;
      if (!tipPassesOdds(tip, m)) continue;
      out.push(tip);
    }
    return out;
  }

  function filterTipsForLeague(){
    const rset = new Set(selectedRounds());
    const out = [];
    for (const tip of state.perUserLatest.values()){
      const m = state.matches[s(tip.matchId)]; if (!m) continue;
      if (!rset.has(matchRound(m))) continue;
      if (!tipPassesOdds(tip, m)) continue;
      out.push(tip);
    }
    return out;
  }

  function recomputeAll(){
    const { player, win } = currentFilters();
    $("whoLabel").textContent = (player==='all' ? 'Összes játékos' : (state.users[player]?.nick || player));
    $("rangeLabel").textContent = (win==='all' ? 'Teljes szezon (F4-től)' : `Utolsó ${win} forduló`);

    const tips   = filterTipsByUi();
    const byUser = groupBy(tips, t=> s(t.user));
    const byMatch= groupBy(tips, t=> s(t.matchId));

    const perRoundPts = {};
    const userTotals  = {};
    for (const t of tips){
      const m = state.matches[s(t.matchId)]; if (!m) continue;
      const pick = tipChoice(t); if (!pick) continue;
      const ok   = !!m.outcome && pick===m.outcome;
      const mult = tipDouble(t) ? 2 : 1;
      const o    = getOdds(m, pick) || 0;
      const pts  = (ok && o) ? o*mult : 0;
      const r    = matchRound(m);
      (perRoundPts[t.user] ||= {});
      perRoundPts[t.user][r] = (perRoundPts[t.user][r]||0) + pts;
      userTotals[t.user] = (userTotals[t.user]||0) + pts;
    }

    const focusUsers = (player==='all' ? Object.keys(byUser) : [player]);
    const rds = selectedRounds();

    const sparkSeries=[], bias={ '1':{pick:0,hit:0}, 'X':{pick:0,hit:0}, '2':{pick:0,hit:0} };
    let sumForm=0,cntForm=0, dblHit=0,dblAll=0,dblPts=0,basePts=0;
    let riskAll=0,riskWin=0, riskCountAll=0,riskCountWin=0;
    let upsetWins=0,upsetAll=0,upsetPts=0;
    const teamRoi=new Map();
    let earlyCnt=0, earlyPts=0, lateCnt=0, latePts=0, midCnt=0, midPts=0;
    let safeCnt=0, safeWins=0, safePts=0, heroCnt=0, heroWins=0, heroPts=0;

    const favAgg = { team:'', tips:0, wins:0, pts:0 };
    const rangeAgg = {
      low:   {name:'≤1.80', tips:0, wins:0, pts:0, stake:0, ret:0},
      mid1:  {name:'1.81–2.50', tips:0, wins:0, pts:0, stake:0, ret:0},
      mid2:  {name:'2.51–3.50', tips:0, wins:0, pts:0, stake:0, ret:0},
      high:  {name:'≥3.51', tips:0, wins:0, pts:0, stake:0, ret:0},
    };
    const bucket=(o)=> o<=1.8?'low':(o<=2.5?'mid1':(o<=3.5?'mid2':'high'));

    for (const u of focusUsers){
      const arr = rds.map(r => perRoundPts[u]?.[r] || 0);
      sparkSeries.push(arr); arr.forEach(v=>{ sumForm+=v; cntForm++; });

      const favTeam = state.users[u]?.fav || "";
      if (player!=='all') favAgg.team = favTeam;

      for (const t of byUser[u] || []){
        const m = state.matches[s(t.matchId)]; if (!m) continue;
        const pick = tipChoice(t); if (!pick) continue;
        const o    = getOdds(m, pick) || 0;
        const ok   = !!m.outcome && pick===m.outcome;
        const mult = tipDouble(t) ? 2 : 1;
        const pts  = (ok && o) ? o*mult : 0;

        if (tipDouble(t)){ dblAll++; if (ok) dblHit++; if (pts) dblPts += pts; }
        basePts += pts;

        if (o){ riskAll+=o; riskCountAll++; if (ok){ riskWin+=o; riskCountWin++; } }

        const maxO = Math.max(getOdds(m,'1')||0, getOdds(m,'X')||0, getOdds(m,'2')||0);
        if (o && Math.abs(o-maxO)<1e-9){ upsetAll++; if (ok){ upsetWins++; upsetPts += pts; } }

        bias[pick].pick++; if (ok) bias[pick].hit++;

        function addTeam(team, w){ const obj=teamRoi.get(team)||{tips:0,pts:0}; obj.tips+=w; obj.pts+=pts*w; teamRoi.set(team,obj); }
        if (pick==='1') addTeam(m.homeTeam||m.home||'',1);
        else if (pick==='2') addTeam(m.awayTeam||m.away||'',1);
        else if (pick==='X'){ addTeam(m.homeTeam||m.home||'',.5); addTeam(m.awayTeam||m.away||'',.5); }

        const ts = t.updatedAt?.toMillis?.() || t.timestamp?.toMillis?.() || t.createdAt?.toMillis?.() || 0;
        const ko = m.startTime?.toMillis?.() || (m.startTime?.seconds? m.startTime.seconds*1000 : 0);
        if (ts && ko){
          const h = (ko - ts)/3600000;
          if (h>=24){ earlyCnt++; earlyPts+=pts; }
          else if (h<3){ lateCnt++;  latePts+=pts; }
          else { midCnt++; midPts+=pts; }
        }

        if (o && o<=1.8){ safeCnt++; if (ok) safeWins++; safePts+=pts; }
        else if (o && o>=3.0){ heroCnt++; if (ok) heroWins++; heroPts+=pts; }

        if (o){
          const b = rangeAgg[bucket(o)];
          b.tips++; if (ok) { b.wins++; b.pts+=pts; b.ret += o; }
          b.stake += 1;
        }
      }
    }

    const formAvg = cntForm ? (sumForm/cntForm) : 0;
    $("kpiForm").textContent = `${fmt(formAvg)} / ford.`;
    drawSpark($("sparkForm"), mergeSeries(sparkSeries));

    const dblRate = dblAll? (dblHit/dblAll*100):0;
    $("kpiDouble").textContent = dblAll? `${fmt(dblRate)}%` : '—';
    $("noteDouble").textContent = `${dblHit}/${dblAll} talált • duplából jött pontok: ${fmt(basePts? dblPts/basePts*100:0)}%`;

    $("kpiRisk").textContent = riskCountAll? `${fmt(riskAll/riskCountAll)} (nyerők: ${fmt(riskCountWin? riskWin/riskCountWin:0)})` : '—';

    $("kpiUpset").textContent = upsetAll? `${fmt(upsetWins/upsetAll*100)}%` : '—';
    $("noteUpset").textContent = `találat: ${upsetWins}/${upsetAll} • nyerő upset átlag: ${fmt(upsetWins? upsetPts/upsetWins:0)} pont`;

    fillBiasTable(bias);

    const topTeams = [...teamRoi.entries()].map(([team, o])=>({team, tips:o.tips, roi:o.tips? o.pts/o.tips:0}))
      .filter(x=>x.team).sort((a,b)=> b.roi - a.roi).slice(0,5);
    fillRows("tableTeamRoi", topTeams.map(x=>[`${x.team}`, fmt(x.tips), fmt(x.roi)]));

    fillRows("tableTiming", [
      ['Korai (≥24h)', earlyCnt, fmt(earlyCnt? earlyPts/earlyCnt:0)],
      ['Köztes',       midCnt,   fmt(midCnt?   midPts/midCnt:0)],
      ['Késői (<3h)',  lateCnt,  fmt(lateCnt?  latePts/lateCnt:0)],
    ]);

    fillRows("tableSafeHero", [
      ['Biztos (≤1.8)', fmt(safeCnt? safeWins/safeCnt*100:0)+'%', fmt(safeCnt? safePts/safeCnt:0)],
      ['Hős (≥3.0)',    fmt(heroCnt? heroWins/heroCnt*100:0)+'%', fmt(heroCnt? heroPts/heroCnt:0)]
    ]);

    const totalTips = tips.length;
    let flatStake=0, flatReturn=0, correct=0, mixStake=0, mixReturn=0;
    tips.forEach(t=>{
      const m=state.matches{s(t.matchId)}; 
    });
  }

  // The line above accidentally broken during copy; fixing by rewriting the stats block cleanly:
</script>

<script type="module">
  import { initializeApp as ia } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
</script>

</body>
</html>
