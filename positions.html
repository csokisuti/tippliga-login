<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>NB1 Tipp – Pozíciós sorrend</title>
  <link rel="stylesheet" href="style.css">
  <script src="loader.js" defer></script>
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e6eaf1; --text:#0f172a; --muted:#64748b;
      --accent:#3b82f6; --ok:#16a34a; --warn:#b45309; --warn-bg:#fff7ed;
    }
    * { box-sizing: border-box; }
    body{
      margin:0; padding:24px;
      background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
      display:block;
    }

    /* Vissza gomb */
    .back-btn{
      display:inline-block; text-decoration:none;
      background:#e5e7eb; color:#111;
      padding:8px 12px; border-radius:10px;
      border:1px solid var(--line);
      margin-bottom:10px;
    }

    h1{ margin:16px 0 12px; font-size:22px; }
    .page-muted{ color:var(--muted); margin-bottom:16px; }

    /* Lock banner */
    .lock-banner{
      display:none;
      background:var(--warn-bg);
      color:var(--warn);
      border:1px solid #fed7aa;
      padding:10px 12px;
      border-radius:10px;
      margin:0 0 10px;
      font-weight:600;
    }
    .locked .lock-banner{ display:block; }

    /* Lock info (lezárási dátum) */
    .lock-info{
      display:none;
      color:var(--muted);
      margin:0 0 14px;
      font-weight:500;
    }
    .lock-info.show{ display:block; }

    /* Kétpaneles elrendezés */
    .wrap{
      display:flex; gap:24px; align-items:flex-start;
    }
    .panel{
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      box-shadow:0 6px 18px rgba(15,23,42,.05);
    }

    /* Bal oldal – csapatok */
    .teams{
      width:300px; max-height:80vh; overflow:auto; position:sticky; top:20px;
      padding:14px;
    }
    .teams h3{ margin:0 0 10px; font-size:16px; }
    .team{
      display:flex; align-items:center; gap:10px;
      padding:8px; border:1px solid var(--line); border-radius:8px;
      margin-bottom:8px; background:#fafafa; cursor:grab;
    }
    .team img{ width:26px; height:26px; object-fit:contain }

    /* Jobb oldal – táblázat */
    .table{
      flex:1; overflow:hidden;
    }
    .table header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; border-bottom:1px solid var(--line); background:#f7f9fd;
    }
    .controls{ display:flex; gap:10px; }
    .btn{
      border:0; background:var(--accent); color:#fff;
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .btn-secondary{
      border:1px solid var(--line); background:#e5e7eb; color:#111;
      padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .btn[disabled], .btn-secondary[disabled]{ opacity:.5; cursor:not-allowed; }

    .positions{ padding:8px 0; }
    .position{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; border-bottom:1px solid var(--line); background:#fff;
      min-height:58px;
    }
    .position-number{
      font-weight:700; width:34px; text-align:right; color:#334155;
    }
    .dropzone{
      flex:1; min-height:40px; border:1px dashed #cbd5e1; border-radius:8px;
      padding:6px; display:flex; align-items:center; gap:8px; background:#f9fafb;
    }
    .dropzone.over{ border-color:#3b82f6; background:#e0f2fe; }

    /* Locked állapot: tiltsuk az interakciót vizuálisan is */
    .locked .team{ cursor:not-allowed; opacity:.7; }
    .locked .dropzone{ pointer-events:none; opacity:.7; }
    .locked #save, .locked #resetBtn{ opacity:.6; cursor:not-allowed; }
    @media (max-width:980px){
      .wrap{ flex-direction:column; }
      .teams{ position:static; width:100%; max-height:none; }
    }
  </style>
</head>
<body>
  <a href="dashboard.html" class="back-btn">← Vissza a főoldalra</a>
  <h1>Szezon végi helyezés tipp</h1>
  <div class="page-muted">Fogd-és-vidd módszerrel húzd a csapatokat a helyezésekhez. Mentés után később bármikor módosíthatod a határidőig.</div>

  <div id="lockBanner" class="lock-banner">⚠️ A pozíciós tippelés le van zárva. Sorrendet most nem lehet módosítani.</div>
  <div id="lockInfo" class="lock-info"></div>

  <div class="wrap">
    <aside class="panel teams" id="team-list">
      <h3>Csapatok</h3>
    </aside>

    <section class="panel table" id="table">
      <header>
        <strong>Helyezések</strong>
        <div class="controls">
          <button id="resetBtn" class="btn-secondary">Törlés</button>
          <button id="save" class="btn">Mentés</button>
        </div>
      </header>
      <div class="positions" id="positions"></div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const teams = [
      { name: "Debreceni VSC", logo: "crest/crest-dvsc.png" },
      { name: "Diósgyőri VTK", logo: "crest/crest-dvtk.png" },
      { name: "Ferencváros", logo: "crest/crest-fradi.png" },
      { name: "ETO FC Győr", logo: "crest/crest-gyor.png" },
      { name: "Kazincbarcikai SC", logo: "crest/crest-kazincbarcika.png" },
      { name: "Kisvárda FC", logo: "crest/crest-kisvarda.png" },
      { name: "MTK Budapest", logo: "crest/crest-mtk.png" },
      { name: "Nyíregyháza Spartacus", logo: "crest/crest-nyiregyhaza.png" },
      { name: "Paksi FC", logo: "crest/crest-paks.png" },
      { name: "Puskás Akadémia", logo: "crest/crest-puskas.png" },
      { name: "Újpest FC", logo: "crest/crest-ujpest.png" },
      { name: "Zalaegerszegi TE FC", logo: "crest/crest-zte.png" }
    ];

    const teamList = document.getElementById("team-list");
    const positions = document.getElementById("positions");
    const saveBtn = document.getElementById("save");
    const resetBtn = document.getElementById("resetBtn");
    const lockBanner = document.getElementById("lockBanner");
    const lockInfo = document.getElementById("lockInfo");
    let IS_LOCKED = false;

    function setLockedUI(locked, msg){
      IS_LOCKED = locked;
      document.body.classList.toggle('locked', locked);
      if (locked) {
        lockBanner.style.display = 'block';
        lockBanner.textContent = msg || "⚠️ A pozíciós tippelés le van zárva. Sorrendet most nem lehet módosítani.";
        saveBtn.disabled = true;
        resetBtn.disabled = true;
      } else {
        lockBanner.style.display = 'none';
        saveBtn.disabled = false;
        resetBtn.disabled = false;
      }
    }

    async function fetchLockState(){
      try{
        const snap = await getDoc(doc(db, "settings", "positionsLock"));
        if (!snap.exists()){
          // nincs beállítás → nincs lock, nincs dátum
          setLockedUI(false);
          lockInfo.classList.remove('show');
          lockInfo.textContent = "";
          return;
        }
        const data = snap.data() || {};
        const isLocked = !!data.isLocked;
        const untilTs = data.lockUntil;
        const msg = data.message || "";
        let timeLocked = false;
        let dateText = "";

        if (untilTs && typeof untilTs.toDate === 'function'){
          const untilDate = untilTs.toDate();
          dateText = `⏳ Lezárás időpontja: ${untilDate.toLocaleString("hu-HU")}`;
          timeLocked = new Date() >= untilDate;
        }

        // dátum kijelzése (akkor is, ha még nincs lezárva)
        if (dateText){
          lockInfo.textContent = dateText;
          lockInfo.classList.add('show');
        } else {
          lockInfo.classList.remove('show');
          lockInfo.textContent = "";
        }

        setLockedUI(isLocked || timeLocked, msg);
      }catch(e){
        console.warn("Lock lekérés hiba:", e?.message||e);
        setLockedUI(false);
        lockInfo.classList.remove('show');
        lockInfo.textContent = "";
      }
    }

    function createTeamElement(team) {
      const div = document.createElement("div");
      div.classList.add("team");
      div.setAttribute("draggable", IS_LOCKED ? "false" : "true");
      div.dataset.name = team.name;
      div.innerHTML = `<img src="${team.logo}" alt=""><span>${team.name}</span>`;
      return div;
    }

    function renderTeamList() {
      const usedNames = Array.from(document.querySelectorAll(".dropzone .team")).map(t => t.dataset.name);
      const existingHeader = teamList.querySelector("h3");
      teamList.innerHTML = "";
      teamList.appendChild(existingHeader);
      teams.forEach(team => {
        if (!usedNames.includes(team.name)) {
          teamList.appendChild(createTeamElement(team));
        }
      });
    }

    function renderPositions() {
      positions.innerHTML = "";
      for (let i = 1; i <= 12; i++) {
        const row = document.createElement("div");
        row.classList.add("position");
        row.innerHTML = `
          <div class="position-number">${i}.</div>
          <div class="dropzone" data-pos="${i}" id="pos-${i}"></div>
        `;
        positions.appendChild(row);
      }
    }

    function setupDragAndDrop() {
      document.addEventListener("dragstart", e => {
        if (IS_LOCKED) { e.preventDefault(); return; }
        if (e.target.classList.contains("team")) {
          e.dataTransfer.setData("text/plain", e.target.dataset.name);
          const parentZone = e.target.parentElement.closest(".dropzone");
          e.dataTransfer.setData("source", parentZone ? parentZone.id : "team-list");
        }
      });

      document.querySelectorAll(".dropzone").forEach(zone => {
        zone.addEventListener("dragover", e => {
          if (IS_LOCKED) return;
          e.preventDefault(); zone.classList.add("over");
        });
        zone.addEventListener("dragleave", () => { zone.classList.remove("over"); });
        zone.addEventListener("drop", e => {
          if (IS_LOCKED) return;
          e.preventDefault(); zone.classList.remove("over");
          const teamName = e.dataTransfer.getData("text/plain");
          const sourceId = e.dataTransfer.getData("source");
          const draggedEl = document.querySelector(`.team[data-name="${teamName}"]`);

          const currentInZone = zone.firstChild;
          if (currentInZone && currentInZone !== draggedEl) {
            const sourceZone = sourceId !== "team-list" ? document.getElementById(sourceId) : null;
            zone.innerHTML = "";
            if (sourceZone) {
              sourceZone.innerHTML = "";
              sourceZone.appendChild(currentInZone);
            } else {
              teamList.appendChild(currentInZone);
            }
          } else if (sourceId === "team-list") {
            teamList.removeChild(draggedEl);
          } else {
            const prevZone = document.getElementById(sourceId);
            if (prevZone && prevZone !== zone) prevZone.innerHTML = "";
          }

          zone.innerHTML = "";
          zone.appendChild(draggedEl);
          renderTeamList();
        });
      });
    }

    async function saveToFirebase(user) {
      if (IS_LOCKED) return;
      const ranking = [];
      document.querySelectorAll(".dropzone").forEach(zone => {
        ranking.push(zone.children.length ? zone.firstChild.dataset.name : null);
      });
      await setDoc(doc(db, "standingsTips", user.email), {
        user: user.email,
        ranking
      });
      alert("Mentve!");
    }

    async function loadFromFirebase(user) {
      const docSnap = await getDoc(doc(db, "standingsTips", user.email));
      if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.ranking && Array.isArray(data.ranking)) {
          data.ranking.forEach((teamName, index) => {
            if (teamName) {
              const team = teams.find(t => t.name === teamName);
              if (team) {
                const el = createTeamElement(team);
                const zone = document.querySelector(`.dropzone[data-pos="${index + 1}"]`);
                zone.innerHTML = "";
                zone.appendChild(el);
              }
            }
          });
        }
      }
      renderTeamList();
    }

    function resetUI() {
      document.querySelectorAll(".dropzone").forEach(z => z.innerHTML = "");
      renderTeamList();
    }

    onAuthStateChanged(auth, async user => {
      if (!user) {
        alert("Bejelentkezés szükséges");
        window.location.href = "login.html";
        return;
      }

      await fetchLockState();        // lock állapot + határidő betöltése
      renderPositions();
      await loadFromFirebase(user);
      setupDragAndDrop();

      saveBtn.addEventListener("click", () => saveToFirebase(user));
      resetBtn.addEventListener("click", async () => {
        if (IS_LOCKED) return;
        const ok = confirm("Biztosan törlöd a sorrendet? A mentett verzió is törlődni fog.");
        if (!ok) return;
        try{ await deleteDoc(doc(db, "standingsTips", user.email)); }catch(e){ console.warn(e); }
        resetUI();
      });

      if (window.hideLoader) hideLoader();
    });
  </script>
</body>
</html>
