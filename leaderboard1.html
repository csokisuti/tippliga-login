<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Toplista</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --line:#e8ecf2; --text:#0f172a; --muted:#64748b;
    }
    * { box-sizing: border-box; }
    body{ margin:0; padding:20px; background:var(--bg); font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; color:var(--text); }
    h1{ margin:0 0 8px; font-size:22px; }
    .muted{ color:var(--muted); margin-bottom:10px; }
    .btn{ border:0; background:#e5e7eb; color:#111; padding:8px 12px; border-radius:10px; cursor:pointer; font-size:14px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; box-shadow:0 6px 18px rgba(15,23,42,.06); }
    .subhdr{ background:#fafbfd; border-bottom:1px solid var(--line); padding:8px 12px; display:flex; gap:12px; align-items:center; }
    .grid{ display:grid; }
    .hdr, .row{ display:contents; }
    .cell{ padding:10px 12px; border-bottom:1px solid var(--line); background:#fff; }
    .hdr .cell{ font-weight:700; background:#f7f8fc; }
    .rank{ text-align:right; color:var(--muted); white-space:nowrap; }
    .num{ text-align:right; white-space:nowrap; }
    .total{ font-weight:800; }
    .table-wrap{ display:flex; }
    .row-bg:nth-child(even) .cell{ background:#fcfdff; }
    .left{ position: sticky; left:0; z-index:3; background:#fff; border-right:1px solid var(--line); }
    .left .cell{ background:#fff; }
    .round-cell{ min-width:70px; text-align:right; }
    .round-link{ display:block; text-decoration:none; color:inherit; }
    .round-link:hover{ text-decoration:underline; }
    .top { background:#fff8e1 !important; font-weight:700; }
    .legend { font-size:12px; color:var(--muted); margin:8px 12px 12px; }
  </style>
</head>
<body>
  <a href="dashboard.html" class="back-btn">‚Üê Vissza a f≈ëoldalra</a>
  <h1>üèÜ Toplista ‚Äì √ñsszes√≠tett √©s fordul√≥nk√©nti pontok</h1>
  <div class="muted">Szezon v√©gi b√≥nusz: minden pontos helyez√©s +1% (max 12%). A sz√≠n a % szerint sk√°l√°z√≥dik (0‚Üí12 = piros‚Üíz√∂ld). A fordul√≥k jobbr√≥l balra: legut√≥bbi a f≈ë oszlopok mellett.</div>

  <div class="card">
    <div class="subhdr">
      <button id="toggleAll" class="btn">Mutasd az √∂sszes fordul√≥t</button>
      <span id="rangeLabel" class="muted">Alap: az utols√≥ 5 fordul√≥ l√°tszik</span>
    </div>
    <div id="tableMount"></div>
    <div class="legend">‚≠ê = adott fordul√≥ legmagasabb pontja</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2xpMW1xgaWIdI2JoEhK23vkC0FTF2PKc",
      authDomain: "tippliga-4b3af.firebaseapp.com",
      projectId: "tippliga-4b3af",
      storageBucket: "tippliga-4b3af.appspot.com",
      messagingSenderId: "720359845241",
      appId: "1:720359845241:web:d3d6edcac6b43ebff053a8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const mount = document.getElementById('tableMount');
    const rangeLabel = document.getElementById('rangeLabel');
    const toggleBtn = document.getElementById('toggleAll');

    // helper: 0..12% ‚Üí sz√≠n (piros‚Üíz√∂ld)
    function bonusHue(pct){
      const p = Math.max(0, Math.min(12, pct));
      return (p/12)*120; // 0..120
    }
    function pctColorStyle(pct){
      const hue = bonusHue(pct);
      return `color:hsl(${hue}deg,85%,40%)`;
    }
    const fmt = (n)=> (Number(n)||0).toFixed(2);

    let showAll = false;

    onAuthStateChanged(auth, async user => {
      if (!user) {
        mount.innerHTML = "<div style='padding:12px'>Be kell jelentkezned a toplista megtekint√©s√©hez.</div>";
        return;
      }

      // 1) Adatok
      const [matchesSnap, tipsSnap, usersSnap, officialSnap, standingsTipsSnap] = await Promise.all([
        getDocs(collection(db, "matches")),
        getDocs(collection(db, "tips")),
        getDocs(collection(db, "users")),
        getDoc(doc(db, "finalStandings", "official")),
        getDocs(collection(db, "standingsTips"))
      ]);

      const matches = {};
      matchesSnap.forEach(d => matches[d.id] = { id:d.id, ...d.data() });

      const usersMap = {};
      usersSnap.forEach(d => { const u = d.data(); if (u.email) usersMap[u.email] = u.nickname || "Ismeretlen"; });

      const officialTeams = (officialSnap.exists() && Array.isArray(officialSnap.data().teams)) ? officialSnap.data().teams : [];

      // jatekos -> saj√°t szezon v√©gi tipp
      const rankingByEmail = {};
      standingsTipsSnap.forEach(d => {
        const data = d.data();
        const ranking = Array.isArray(data.ranking) ? data.ranking : (Array.isArray(data.teams) ? data.teams : []);
        rankingByEmail[d.id] = ranking;
      });

      // 2) Pontsz√°mok (alap + fordul√≥k)
      const player = {}; // nick -> {base, perRound: Map(round->sum)}
      const allRounds = new Set();

      tipsSnap.forEach(t => {
        const tip = t.data();
        const match = matches[tip.matchId];
        if (!match || !match.outcome || !match.odds) return;

        const roundId = String(match.roundId || "");
        if (!roundId) return;
        allRounds.add(roundId);

        const isCorrect = match.outcome === tip.tip;
        const oddsValue = match.odds[tip.tip];
        const pts = isCorrect ? (oddsValue || 0) * (tip.isDouble ? 2 : 1) : 0;

        const nick = usersMap[tip.user] || "Ismeretlen";
        if (!player[nick]) player[nick] = { base:0, perRound:{} , email: tip.user };
        player[nick].base += pts;
        player[nick].perRound[roundId] = (player[nick].perRound[roundId]||0) + pts;
      });

      // 3) B√≥nusz% sz√°m√≠t√°s (pontos poz√≠ci√≥ egyez√©s)
      function calcBonusPct(officialTeams=[], ranking=[]){
        const TOTAL = 12;
        let correct = 0;
        for(let i=0;i<TOTAL;i++){
          const o = officialTeams[i];
          const r = ranking[i];
          if (o && r && o === r) correct++;
        }
        return correct; // 1 hely = 1%
      }

      const rows = Object.entries(player).map(([nick, obj])=>{
        const ranking = rankingByEmail[obj.email] || [];
        const bonusPct = officialTeams.length ? calcBonusPct(officialTeams, ranking) : 0;
        const bonusPts = Math.round(obj.base * (bonusPct/100)); // eg√©szre kerek√≠tve
        const total = obj.base + bonusPts;
        return { nick, base: obj.base, perRound: obj.perRound, bonusPct, bonusPts, total };
      });

      if (!rows.length){
        mount.innerHTML = "<div style='padding:12px'>M√©g nincs megjelen√≠thet≈ë pontsz√°m.</div>";
        return;
      }

      // Rendez√©s √∂sszesen szerint
      rows.sort((a,b)=> b.total - a.total || a.nick.localeCompare(b.nick));

      // fordul√≥k n√∂vekv≈ë ‚Üí majd megford√≠tjuk (legut√≥bbi legyen k√∂zvetlen√ºl a f≈ë oszlopok mellett)
      const roundsAsc = Array.from(allRounds).sort((a,b)=>parseInt(a)-parseInt(b));
      const roundsDesc = roundsAsc.slice().reverse();

      function build(){
        const toShow = showAll ? roundsDesc : roundsDesc.slice(0,5); // utols√≥ 5
        rangeLabel.textContent = showAll
          ? "Teljes n√©zet: minden fordul√≥ l√°tszik (jobbr√≥l balra: legut√≥bbi‚Üír√©gebbi)"
          : `Csak az utols√≥ ${toShow.length} fordul√≥ l√°tszik (jobbr√≥l balra: ${toShow[0]} ‚Üí ‚Ä¶)`;

        // max per round (csak a l√°that√≥ tartom√°nyon bel√ºl)
        const maxPerRound = toShow.map(r=>{
          let m = -Infinity;
          rows.forEach(row => { m = Math.max(m, row.perRound[r]||0); });
          return m;
        });

        // fejl√©cek (bal fix r√©sz a k√©rt sorrendben)
        const leftHeader = `
          <div class="hdr">
            <div class="cell left rank">Hely</div>
            <div class="cell left">J√°t√©kos</div>
            <div class="cell left num">√ñsszesen</div>
            <div class="cell left num">B√≥nusz (pont + %)</div>
            <div class="cell left num">Alap pont</div>
          </div>`;

        // jobb fejl√©c: kattinthat√≥ fordul√≥k ‚Üí results.html?round=N
        const rightHeader = toShow
          .map(r=>`<div class="cell round-cell"><a class="round-link" href="results.html?round=${encodeURIComponent(r)}">F${r}</a></div>`)
          .join('');

        const container = document.createElement('div');
        container.className = 'table-wrap';

        // bal oldal
        const left = document.createElement('div');
        left.className = 'left';
        left.style.minWidth = '700px';
        left.style.maxWidth = '700px';
        left.innerHTML = `
          <div class="grid" style="grid-template-columns: 70px 1.6fr 140px 180px 140px;">
            ${leftHeader}
            ${rows.map((r,i)=>`
              <div class="row row-bg">
                <div class="cell left rank">${i+1}.</div>
                <div class="cell left">${r.nick}</div>
                <div class="cell left num total">${fmt(r.total)}</div>
                <div class="cell left num">
                  +${r.bonusPts}
                  <span style="${pctColorStyle(r.bonusPct)}"> ( +${r.bonusPct}% )</span>
                </div>
                <div class="cell left num">${fmt(r.base)}</div>
              </div>
            `).join('')}
          </div>
        `;

        // jobb oldal ‚Äì l√°that√≥ fordul√≥k jobbr√≥l balra
        const right = document.createElement('div');
        right.style.overflow = 'auto';
        right.style.flex = '1';
        right.innerHTML = `
          <div class="grid" style="grid-template-columns:${'70px '.repeat(toShow.length)};">
            <div class="hdr">${rightHeader}</div>
            ${rows.map(r=>{
              const cells = toShow.map((rid, idx)=>{
                const val = r.perRound[rid]||0;
                const isTop = val === maxPerRound[idx];
                // cella maga is link a results.html?round=N oldalra
                return `<div class="cell round-cell num ${isTop?'top':''}">
                          <a class="round-link" href="results.html?round=${encodeURIComponent(rid)}">${fmt(val)}${isTop?' ‚≠ê':''}</a>
                        </div>`;
              }).join('');
              return `<div class="row row-bg">${cells}</div>`;
            }).join('')}
          </div>
        `;

        mount.innerHTML = '';
        container.appendChild(left);
        container.appendChild(right);
        mount.appendChild(container);
      }

      toggleBtn.addEventListener('click', ()=>{
        showAll = !showAll;
        toggleBtn.textContent = showAll ? 'Csak az utols√≥ 5 fordul√≥' : 'Mutasd az √∂sszes fordul√≥t';
        build();
      });

      build();
    });
  </script>
</body>
</html>
